<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>pyfock.Integrals API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyfock.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyfock</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#included-modules-and-functionality">Included modules and functionality:</a></li>
  <li><a href="#usage">Usage:</a></li>
</ul>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="Integrals/integral_helpers.html">integral_helpers</a></li>
                    <li><a href="Integrals/mmd_nuc_mat_symm.html">mmd_nuc_mat_symm</a></li>
                    <li><a href="Integrals/nuc_mat_symm.html">nuc_mat_symm</a></li>
                    <li><a href="Integrals/kin_mat_symm.html">kin_mat_symm</a></li>
                    <li><a href="Integrals/overlap_mat_symm.html">overlap_mat_symm</a></li>
                    <li><a href="Integrals/conv_4c2e_symm.html">conv_4c2e_symm</a></li>
                    <li><a href="Integrals/mmd_4c2e_symm.html">mmd_4c2e_symm</a></li>
                    <li><a href="Integrals/rys_helpers.html">rys_helpers</a></li>
                    <li><a href="Integrals/rys_4c2e_symm.html">rys_4c2e_symm</a></li>
                    <li><a href="Integrals/conv_3c2e_symm.html">conv_3c2e_symm</a></li>
                    <li><a href="Integrals/rys_3c2e_symm.html">rys_3c2e_symm</a></li>
                    <li><a href="Integrals/conv_2c2e_symm.html">conv_2c2e_symm</a></li>
                    <li><a href="Integrals/rys_2c2e_symm.html">rys_2c2e_symm</a></li>
                    <li><a href="Integrals/rys_3c2e_tri.html">rys_3c2e_tri</a></li>
                    <li><a href="Integrals/rys_nuc_mat_symm.html">rys_nuc_mat_symm</a></li>
                    <li><a href="Integrals/schwarz_helpers.html">schwarz_helpers</a></li>
                    <li><a href="Integrals/eval_xc_1.html">eval_xc_1</a></li>
                    <li><a href="Integrals/eval_xc_2.html">eval_xc_2</a></li>
                    <li><a href="Integrals/eval_xc_3.html">eval_xc_3</a></li>
                    <li><a href="Integrals/eval_xc_1_cupy.html">eval_xc_1_cupy</a></li>
                    <li><a href="Integrals/eval_xc_2_cupy.html">eval_xc_2_cupy</a></li>
                    <li><a href="Integrals/eval_xc_3_cupy.html">eval_xc_3_cupy</a></li>
                    <li><a href="Integrals/dipole_moment_mat_symm.html">dipole_moment_mat_symm</a></li>
                    <li><a href="Integrals/kin_mat_symm_cupy.html">kin_mat_symm_cupy</a></li>
                    <li><a href="Integrals/overlap_mat_symm_cupy.html">overlap_mat_symm_cupy</a></li>
                    <li><a href="Integrals/dipole_moment_mat_symm_cupy.html">dipole_moment_mat_symm_cupy</a></li>
                    <li><a href="Integrals/nuc_mat_symm_cupy.html">nuc_mat_symm_cupy</a></li>
                    <li><a href="Integrals/kin_mat_symm_shell_cupy.html">kin_mat_symm_shell_cupy</a></li>
                    <li><a href="Integrals/rys_2c2e_symm_cupy.html">rys_2c2e_symm_cupy</a></li>
                    <li><a href="Integrals/rys_3c2e_symm_cupy.html">rys_3c2e_symm_cupy</a></li>
                    <li><a href="Integrals/rys_3c2e_symm_cupy_fp32.html">rys_3c2e_symm_cupy_fp32</a></li>
                    <li><a href="Integrals/schwarz_helpers_cupy.html">schwarz_helpers_cupy</a></li>
                    <li><a href="Integrals/overlap_mat_grad_symm.html">overlap_mat_grad_symm</a></li>
                    <li><a href="Integrals/kin_mat_grad_symm.html">kin_mat_grad_symm</a></li>
                    <li><a href="Integrals/nuc_mat_grad_symm.html">nuc_mat_grad_symm</a></li>
                    <li><a href="Integrals/cross_overlap_mat_symm.html">cross_overlap_mat_symm</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#mmd_nuc_mat_symm">mmd_nuc_mat_symm</a>
            </li>
            <li>
                    <a class="function" href="#nuc_mat_symm">nuc_mat_symm</a>
            </li>
            <li>
                    <a class="function" href="#kin_mat_symm">kin_mat_symm</a>
            </li>
            <li>
                    <a class="function" href="#overlap_mat_symm">overlap_mat_symm</a>
            </li>
            <li>
                    <a class="function" href="#conv_4c2e_symm">conv_4c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#mmd_4c2e_symm">mmd_4c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#rys_4c2e_symm">rys_4c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#rys_4c2e_symm_old">rys_4c2e_symm_old</a>
            </li>
            <li>
                    <a class="function" href="#conv_3c2e_symm">conv_3c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#rys_3c2e_symm">rys_3c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#conv_2c2e_symm">conv_2c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#rys_2c2e_symm">rys_2c2e_symm</a>
            </li>
            <li>
                    <a class="function" href="#rys_3c2e_tri">rys_3c2e_tri</a>
            </li>
            <li>
                    <a class="function" href="#rys_nuc_mat_symm">rys_nuc_mat_symm</a>
            </li>
            <li>
                    <a class="variable" href="#rys_3c2e_tri_schwarzbf_val_helpers">rys_3c2e_tri_schwarzbf_val_helpers</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_1">eval_xc_1</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_2">eval_xc_2</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_3">eval_xc_3</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_1_cupy">eval_xc_1_cupy</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_2_cupy">eval_xc_2_cupy</a>
            </li>
            <li>
                    <a class="function" href="#eval_xc_3_cupy">eval_xc_3_cupy</a>
            </li>
            <li>
                    <a class="function" href="#dipole_moment_mat_symm">dipole_moment_mat_symm</a>
            </li>
            <li>
                    <a class="function" href="#kin_mat_symm_cupy">kin_mat_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#overlap_mat_symm_cupy">overlap_mat_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#dipole_moment_mat_symm_cupy">dipole_moment_mat_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#nuc_mat_symm_cupy">nuc_mat_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#kin_mat_symm_shell_cupy">kin_mat_symm_shell_cupy</a>
            </li>
            <li>
                    <a class="function" href="#rys_2c2e_symm_cupy">rys_2c2e_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#rys_3c2e_symm_cupy">rys_3c2e_symm_cupy</a>
            </li>
            <li>
                    <a class="function" href="#rys_3c2e_symm_cupy_fp32">rys_3c2e_symm_cupy_fp32</a>
            </li>
            <li>
                    <a class="function" href="#overlap_mat_grad_symm">overlap_mat_grad_symm</a>
            </li>
            <li>
                    <a class="function" href="#kin_mat_grad_symm">kin_mat_grad_symm</a>
            </li>
            <li>
                    <a class="function" href="#nuc_mat_grad_symm">nuc_mat_grad_symm</a>
            </li>
            <li>
                    <a class="function" href="#cross_overlap_mat_symm">cross_overlap_mat_symm</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyfock.html">pyfock</a><wbr>.Integrals    </h1>

                        <div class="docstring"><p>This submodule provides highly optimized and symmetry-aware routines for 
evaluating all essential one-electron and two-electron integrals needed in 
electronic structure calculations. The integrals are computed over Gaussian 
type orbitals (GTOs), and both CPU (NumPy) and GPU (CuPy) implementations are 
available for many routines to accelerate quantum chemistry workflows.</p>

<h2 id="included-modules-and-functionality">Included modules and functionality:</h2>

<ul>
<li>One-electron integrals:
<ul>
<li>Overlap integrals</li>
<li>Kinetic energy integrals</li>
<li>Nuclear attraction integrals</li>
<li>Dipole moment integrals</li>
<li>Gradients of one-electron integrals</li>
</ul></li>
<li>Two-electron integrals:
<ul>
<li>Full 4-center two electron repulsion integrals using Rys quadrature</li>
<li>3-center and 2-center two electron integrals for density fitting</li>
<li>Schwarz screening utilities for integral pruning</li>
</ul></li>
<li>Exchange-correlation evaluation routines compatible with numerical grids</li>
<li>GPU-accelerated (CuPy) versions for key performance-critical routines</li>
<li>Modular helper functions for computing factorials, boys functions, contraction coefficients, etc.</li>
</ul>

<h2 id="usage">Usage:</h2>

<p>Example:
    from <a href="">pyfock.Integrals</a> import overlap_mat_symm
    S = overlap_mat_symm(basis)</p>
</div>

                        <input id="mod-Integrals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-Integrals-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">This submodule provides highly optimized and symmetry-aware routines for </span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">evaluating all essential one-electron and two-electron integrals needed in </span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">electronic structure calculations. The integrals are computed over Gaussian </span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">type orbitals (GTOs), and both CPU (NumPy) and GPU (CuPy) implementations are </span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">available for many routines to accelerate quantum chemistry workflows.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">Included modules and functionality:</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">-----------------------------------</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">- One-electron integrals:</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">    * Overlap integrals</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">    * Kinetic energy integrals</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">    * Nuclear attraction integrals</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    * Dipole moment integrals</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    * Gradients of one-electron integrals</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">- Two-electron integrals:</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    * Full 4-center two electron repulsion integrals using Rys quadrature</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    * 3-center and 2-center two electron integrals for density fitting</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    * Schwarz screening utilities for integral pruning</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">- Exchange-correlation evaluation routines compatible with numerical grids</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">- GPU-accelerated (CuPy) versions for key performance-critical routines</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">- Modular helper functions for computing factorials, boys functions, contraction coefficients, etc.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">Usage:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">------</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">Example:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    from pyfock.Integrals import overlap_mat_symm</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    S = overlap_mat_symm(basis)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="c1"># from .integral_helpers import fac</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="c1"># from .integral_helpers import fastFactorial</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="c1"># from .integral_helpers import comb</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="c1"># from .integral_helpers import doublefactorial</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="c1"># from .integral_helpers import c2k</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="c1"># from .integral_helpers import calcS</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="c1"># from .integral_helpers import vlriPartial</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="c1"># from .integral_helpers import calcCgamminc</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="c1"># from .integral_helpers import Fboys</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mmd_nuc_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mmd_nuc_mat_symm</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.nuc_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">nuc_mat_symm</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.nuc_mat_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">nuc_mat_symm_cupy</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.kin_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">kin_mat_symm</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.kin_mat_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">kin_mat_symm_cupy</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.kin_mat_symm_shell_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">kin_mat_symm_shell_cupy</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.overlap_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">overlap_mat_symm</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.overlap_mat_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">overlap_mat_symm_cupy</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cross_overlap_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_overlap_mat_symm</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.dipole_moment_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">dipole_moment_mat_symm</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.dipole_moment_mat_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">dipole_moment_mat_symm_cupy</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.conv_4c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">conv_4c2e_symm</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mmd_4c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mmd_4c2e_symm</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_4c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_4c2e_symm</span><span class="p">,</span> <span class="n">rys_4c2e_symm_old</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.conv_3c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">conv_3c2e_symm</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_3c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_3c2e_symm</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_3c2e_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_3c2e_symm_cupy</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_3c2e_symm_cupy_fp32</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_3c2e_symm_cupy_fp32</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.conv_2c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">conv_2c2e_symm</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_2c2e_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_2c2e_symm</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_2c2e_symm_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_2c2e_symm_cupy</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_3c2e_tri</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_3c2e_tri</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.rys_nuc_mat_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_nuc_mat_symm</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.schwarz_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_3c2e_tri_schwarz</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_1</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_1</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_2</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_2</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_3</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_3</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_1_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_1_cupy</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_2_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_2_cupy</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.eval_xc_3_cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_xc_3_cupy</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">bf_val_helpers</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">rys_helpers</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">schwarz_helpers</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">schwarz_helpers_cupy</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">integral_helpers</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.overlap_mat_grad_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">overlap_mat_grad_symm</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.kin_mat_grad_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">kin_mat_grad_symm</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.nuc_mat_grad_symm</span><span class="w"> </span><span class="kn">import</span> <span class="n">nuc_mat_grad_symm</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="c1"># __all__ = [&#39;fac&#39;, &#39;fastFactorial&#39;, &#39;comb&#39;, &#39;doublefactorial&#39;, &#39;c2k&#39;, &#39;calcS&#39;, &#39;vlriPartial&#39;, &#39;calcCgamminc&#39;, &#39;Fboys&#39;, &#39;comb&#39;\</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="c1">#     , &#39;comb&#39;, &#39;comb&#39;, &#39;comb&#39;, &#39;comb&#39;, &#39;comb&#39;]</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;integral_helpers&#39;</span><span class="p">,</span> <span class="s1">&#39;mmd_nuc_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;nuc_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;kin_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;overlap_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;conv_4c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;mmd_4c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_helpers&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_4c2e_symm&#39;</span><span class="p">,</span>\
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>     <span class="s1">&#39;rys_4c2e_symm_old&#39;</span><span class="p">,</span> <span class="s1">&#39;conv_3c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_3c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;conv_2c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_2c2e_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_3c2e_tri&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_nuc_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;schwarz_helpers&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_3c2e_tri_schwarz&#39;</span>\
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="s1">&#39;bf_val_helpers&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_1&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_2&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_3&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_1_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_2_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_xc_3_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;dipole_moment_mat_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;kin_mat_symm_cupy&#39;</span>\
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="p">,</span> <span class="s1">&#39;overlap_mat_symm_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;dipole_moment_mat_symm_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;nuc_mat_symm_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;kin_mat_symm_shell_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_2c2e_symm_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;rys_3c2e_symm_cupy&#39;</span><span class="p">,</span>\
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="s1">&#39;rys_3c2e_symm_cupy_fp32&#39;</span><span class="p">,</span> <span class="s1">&#39;schwarz_helpers_cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;overlap_mat_grad_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;kin_mat_grad_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;nuc_mat_grad_symm&#39;</span><span class="p">,</span> <span class="s1">&#39;cross_overlap_mat_symm&#39;</span><span class="p">]</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="c1"># # This code will import all of the modules in the library directory and expose all of </span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="c1"># # the functions in those modules to the user. The user can then use the functions just </span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="c1"># # like they would any other function in the library package:</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="c1"># # Keep in mind that this code will expose all functions in the library directory, </span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="c1"># # including any private functions (i.e. functions that start with an underscore). </span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="c1"># # If you only want to expose certain functions, </span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="c1"># # you can modify the __all__ list to include only the functions that you want to expose.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="c1"># import glob</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="c1"># # Get a list of all module filenames in the library directory</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="c1"># # module_filenames = glob.glob(&#39;pyfock/Integrals/*.py&#39;)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="c1"># module_filenames = glob.glob(&#39;*.py&#39;)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="c1"># print(module_filenames)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="c1"># # Remove the `__init__.py` file from the list</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="c1"># # module_filenames.remove(&#39;pyfock/Integrals/__init__.py&#39;)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="c1"># module_filenames.remove(&#39;__init__.py&#39;)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="c1"># # Use a for loop to import all of the modules in the Integrals directory</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="c1"># for module_filename in module_filenames:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="c1">#     # module_filename = module_filename.replace(&quot;pyfock/Integrals/&quot;, &quot;&quot;)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="c1">#     module_name = module_filename[:-3]</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="c1">#     exec(f&#39;from .{module_name} import *&#39;)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="c1"># # Expose all of the functions in the __all__ variable</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="c1"># __all__ = [</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="c1">#     func for func in dir()</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="c1">#     if func[0] != &#39;_&#39; and callable(eval(func))</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="c1"># ]</span>
</span></pre></div>


            </section>
                <section id="mmd_nuc_mat_symm">
                            <input id="mmd_nuc_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mmd_nuc_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">mol</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="mmd_nuc_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#mmd_nuc_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="mmd_nuc_mat_symm-7"><a href="#mmd_nuc_mat_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">mmd_nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="mmd_nuc_mat_symm-8"><a href="#mmd_nuc_mat_symm-8"><span class="linenos"> 8</span></a>    <span class="c1">#Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="mmd_nuc_mat_symm-9"><a href="#mmd_nuc_mat_symm-9"><span class="linenos"> 9</span></a>    <span class="c1">#Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="mmd_nuc_mat_symm-10"><a href="#mmd_nuc_mat_symm-10"><span class="linenos">10</span></a>    <span class="c1">#function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="mmd_nuc_mat_symm-11"><a href="#mmd_nuc_mat_symm-11"><span class="linenos">11</span></a>
</span><span id="mmd_nuc_mat_symm-12"><a href="#mmd_nuc_mat_symm-12"><span class="linenos">12</span></a>    <span class="c1"># This function calculates the nuclear matrix for a given basis object.</span>
</span><span id="mmd_nuc_mat_symm-13"><a href="#mmd_nuc_mat_symm-13"><span class="linenos">13</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="mmd_nuc_mat_symm-14"><a href="#mmd_nuc_mat_symm-14"><span class="linenos">14</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="mmd_nuc_mat_symm-15"><a href="#mmd_nuc_mat_symm-15"><span class="linenos">15</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="mmd_nuc_mat_symm-16"><a href="#mmd_nuc_mat_symm-16"><span class="linenos">16</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="mmd_nuc_mat_symm-17"><a href="#mmd_nuc_mat_symm-17"><span class="linenos">17</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="mmd_nuc_mat_symm-18"><a href="#mmd_nuc_mat_symm-18"><span class="linenos">18</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="mmd_nuc_mat_symm-19"><a href="#mmd_nuc_mat_symm-19"><span class="linenos">19</span></a>
</span><span id="mmd_nuc_mat_symm-20"><a href="#mmd_nuc_mat_symm-20"><span class="linenos">20</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="mmd_nuc_mat_symm-21"><a href="#mmd_nuc_mat_symm-21"><span class="linenos">21</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-22"><a href="#mmd_nuc_mat_symm-22"><span class="linenos">22</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-23"><a href="#mmd_nuc_mat_symm-23"><span class="linenos">23</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-24"><a href="#mmd_nuc_mat_symm-24"><span class="linenos">24</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-25"><a href="#mmd_nuc_mat_symm-25"><span class="linenos">25</span></a>    <span class="n">coordsBohrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-26"><a href="#mmd_nuc_mat_symm-26"><span class="linenos">26</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-27"><a href="#mmd_nuc_mat_symm-27"><span class="linenos">27</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span>
</span><span id="mmd_nuc_mat_symm-28"><a href="#mmd_nuc_mat_symm-28"><span class="linenos">28</span></a>        
</span><span id="mmd_nuc_mat_symm-29"><a href="#mmd_nuc_mat_symm-29"><span class="linenos">29</span></a>
</span><span id="mmd_nuc_mat_symm-30"><a href="#mmd_nuc_mat_symm-30"><span class="linenos">30</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="mmd_nuc_mat_symm-31"><a href="#mmd_nuc_mat_symm-31"><span class="linenos">31</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="mmd_nuc_mat_symm-32"><a href="#mmd_nuc_mat_symm-32"><span class="linenos">32</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="mmd_nuc_mat_symm-33"><a href="#mmd_nuc_mat_symm-33"><span class="linenos">33</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="mmd_nuc_mat_symm-34"><a href="#mmd_nuc_mat_symm-34"><span class="linenos">34</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="mmd_nuc_mat_symm-35"><a href="#mmd_nuc_mat_symm-35"><span class="linenos">35</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="mmd_nuc_mat_symm-36"><a href="#mmd_nuc_mat_symm-36"><span class="linenos">36</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-37"><a href="#mmd_nuc_mat_symm-37"><span class="linenos">37</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-38"><a href="#mmd_nuc_mat_symm-38"><span class="linenos">38</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_nuc_mat_symm-39"><a href="#mmd_nuc_mat_symm-39"><span class="linenos">39</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="mmd_nuc_mat_symm-40"><a href="#mmd_nuc_mat_symm-40"><span class="linenos">40</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="mmd_nuc_mat_symm-41"><a href="#mmd_nuc_mat_symm-41"><span class="linenos">41</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_nuc_mat_symm-42"><a href="#mmd_nuc_mat_symm-42"><span class="linenos">42</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_nuc_mat_symm-43"><a href="#mmd_nuc_mat_symm-43"><span class="linenos">43</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_nuc_mat_symm-44"><a href="#mmd_nuc_mat_symm-44"><span class="linenos">44</span></a>        
</span><span id="mmd_nuc_mat_symm-45"><a href="#mmd_nuc_mat_symm-45"><span class="linenos">45</span></a>
</span><span id="mmd_nuc_mat_symm-46"><a href="#mmd_nuc_mat_symm-46"><span class="linenos">46</span></a>
</span><span id="mmd_nuc_mat_symm-47"><a href="#mmd_nuc_mat_symm-47"><span class="linenos">47</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="mmd_nuc_mat_symm-48"><a href="#mmd_nuc_mat_symm-48"><span class="linenos">48</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="mmd_nuc_mat_symm-49"><a href="#mmd_nuc_mat_symm-49"><span class="linenos">49</span></a>        
</span><span id="mmd_nuc_mat_symm-50"><a href="#mmd_nuc_mat_symm-50"><span class="linenos">50</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="mmd_nuc_mat_symm-51"><a href="#mmd_nuc_mat_symm-51"><span class="linenos">51</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="mmd_nuc_mat_symm-52"><a href="#mmd_nuc_mat_symm-52"><span class="linenos">52</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="mmd_nuc_mat_symm-53"><a href="#mmd_nuc_mat_symm-53"><span class="linenos">53</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="mmd_nuc_mat_symm-54"><a href="#mmd_nuc_mat_symm-54"><span class="linenos">54</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="mmd_nuc_mat_symm-55"><a href="#mmd_nuc_mat_symm-55"><span class="linenos">55</span></a>
</span><span id="mmd_nuc_mat_symm-56"><a href="#mmd_nuc_mat_symm-56"><span class="linenos">56</span></a>    <span class="c1"># print([a,b,c,d])</span>
</span><span id="mmd_nuc_mat_symm-57"><a href="#mmd_nuc_mat_symm-57"><span class="linenos">57</span></a>    
</span><span id="mmd_nuc_mat_symm-58"><a href="#mmd_nuc_mat_symm-58"><span class="linenos">58</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">mmd_nuc_mat_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordsBohrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">)</span>
</span><span id="mmd_nuc_mat_symm-59"><a href="#mmd_nuc_mat_symm-59"><span class="linenos">59</span></a>    
</span><span id="mmd_nuc_mat_symm-60"><a href="#mmd_nuc_mat_symm-60"><span class="linenos">60</span></a>    <span class="k">return</span> <span class="n">V</span> 
</span></pre></div>


    

                </section>
                <section id="nuc_mat_symm">
                            <input id="nuc_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nuc_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">mol</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nuc_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nuc_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nuc_mat_symm-7"><a href="#nuc_mat_symm-7"><span class="linenos">  7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="nuc_mat_symm-8"><a href="#nuc_mat_symm-8"><span class="linenos">  8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="nuc_mat_symm-9"><a href="#nuc_mat_symm-9"><span class="linenos">  9</span></a><span class="sd">    Compute the nuclear attraction matrix for a given basis and molecular geometry.</span>
</span><span id="nuc_mat_symm-10"><a href="#nuc_mat_symm-10"><span class="linenos"> 10</span></a>
</span><span id="nuc_mat_symm-11"><a href="#nuc_mat_symm-11"><span class="linenos"> 11</span></a><span class="sd">    This function evaluates the one-electron nuclear attraction integrals </span>
</span><span id="nuc_mat_symm-12"><a href="#nuc_mat_symm-12"><span class="linenos"> 12</span></a><span class="sd">    ⟨χ_i | V_nuc | χ_j⟩, where V_nuc is the Coulombic potential from the atomic nuclei.</span>
</span><span id="nuc_mat_symm-13"><a href="#nuc_mat_symm-13"><span class="linenos"> 13</span></a><span class="sd">    The integrals are computed between all basis functions defined in `basis` and </span>
</span><span id="nuc_mat_symm-14"><a href="#nuc_mat_symm-14"><span class="linenos"> 14</span></a><span class="sd">    and the nuclei within the `mol` object.</span>
</span><span id="nuc_mat_symm-15"><a href="#nuc_mat_symm-15"><span class="linenos"> 15</span></a><span class="sd">    So in principle, it can be used to compute the nuclear potential matrix due to the</span>
</span><span id="nuc_mat_symm-16"><a href="#nuc_mat_symm-16"><span class="linenos"> 16</span></a><span class="sd">    nuclei in one molecule, in the basis of another molecule.</span>
</span><span id="nuc_mat_symm-17"><a href="#nuc_mat_symm-17"><span class="linenos"> 17</span></a>
</span><span id="nuc_mat_symm-18"><a href="#nuc_mat_symm-18"><span class="linenos"> 18</span></a><span class="sd">    Efficient Numba-accelerated routines are used to improve performance. </span>
</span><span id="nuc_mat_symm-19"><a href="#nuc_mat_symm-19"><span class="linenos"> 19</span></a><span class="sd">    A partial block of the matrix can be computed by specifying a `slice`.</span>
</span><span id="nuc_mat_symm-20"><a href="#nuc_mat_symm-20"><span class="linenos"> 20</span></a>
</span><span id="nuc_mat_symm-21"><a href="#nuc_mat_symm-21"><span class="linenos"> 21</span></a><span class="sd">    Parameters</span>
</span><span id="nuc_mat_symm-22"><a href="#nuc_mat_symm-22"><span class="linenos"> 22</span></a><span class="sd">    ----------</span>
</span><span id="nuc_mat_symm-23"><a href="#nuc_mat_symm-23"><span class="linenos"> 23</span></a><span class="sd">    basis : object</span>
</span><span id="nuc_mat_symm-24"><a href="#nuc_mat_symm-24"><span class="linenos"> 24</span></a><span class="sd">        Basis set object with fields including:</span>
</span><span id="nuc_mat_symm-25"><a href="#nuc_mat_symm-25"><span class="linenos"> 25</span></a><span class="sd">        - bfs_coords: Cartesian coordinates of basis function centers.</span>
</span><span id="nuc_mat_symm-26"><a href="#nuc_mat_symm-26"><span class="linenos"> 26</span></a><span class="sd">        - bfs_coeffs: Contraction coefficients.</span>
</span><span id="nuc_mat_symm-27"><a href="#nuc_mat_symm-27"><span class="linenos"> 27</span></a><span class="sd">        - bfs_expnts: Gaussian exponents.</span>
</span><span id="nuc_mat_symm-28"><a href="#nuc_mat_symm-28"><span class="linenos"> 28</span></a><span class="sd">        - bfs_prim_norms: Normalization constants for primitives.</span>
</span><span id="nuc_mat_symm-29"><a href="#nuc_mat_symm-29"><span class="linenos"> 29</span></a><span class="sd">        - bfs_contr_prim_norms: Normalization constants for contracted functions.</span>
</span><span id="nuc_mat_symm-30"><a href="#nuc_mat_symm-30"><span class="linenos"> 30</span></a><span class="sd">        - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="nuc_mat_symm-31"><a href="#nuc_mat_symm-31"><span class="linenos"> 31</span></a><span class="sd">        - bfs_nprim: Number of primitives per basis function.</span>
</span><span id="nuc_mat_symm-32"><a href="#nuc_mat_symm-32"><span class="linenos"> 32</span></a><span class="sd">        - bfs_nao: Number of atomic orbitals (contracted basis functions).</span>
</span><span id="nuc_mat_symm-33"><a href="#nuc_mat_symm-33"><span class="linenos"> 33</span></a>
</span><span id="nuc_mat_symm-34"><a href="#nuc_mat_symm-34"><span class="linenos"> 34</span></a><span class="sd">    mol : object</span>
</span><span id="nuc_mat_symm-35"><a href="#nuc_mat_symm-35"><span class="linenos"> 35</span></a><span class="sd">        Molecule object containing:</span>
</span><span id="nuc_mat_symm-36"><a href="#nuc_mat_symm-36"><span class="linenos"> 36</span></a><span class="sd">        - coordsBohrs: Cartesian coordinates of nuclei (in Bohr).</span>
</span><span id="nuc_mat_symm-37"><a href="#nuc_mat_symm-37"><span class="linenos"> 37</span></a><span class="sd">        - Zcharges: Nuclear charges.</span>
</span><span id="nuc_mat_symm-38"><a href="#nuc_mat_symm-38"><span class="linenos"> 38</span></a><span class="sd">        - natoms: Number of atoms.</span>
</span><span id="nuc_mat_symm-39"><a href="#nuc_mat_symm-39"><span class="linenos"> 39</span></a>
</span><span id="nuc_mat_symm-40"><a href="#nuc_mat_symm-40"><span class="linenos"> 40</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="nuc_mat_symm-41"><a href="#nuc_mat_symm-41"><span class="linenos"> 41</span></a><span class="sd">        A 4-element list `[start_row, end_row, start_col, end_col]` defining </span>
</span><span id="nuc_mat_symm-42"><a href="#nuc_mat_symm-42"><span class="linenos"> 42</span></a><span class="sd">        the sub-block of the matrix to compute. Rows and columns refer to AOs.</span>
</span><span id="nuc_mat_symm-43"><a href="#nuc_mat_symm-43"><span class="linenos"> 43</span></a><span class="sd">        If `None` (default), the entire nuclear attraction matrix is computed.</span>
</span><span id="nuc_mat_symm-44"><a href="#nuc_mat_symm-44"><span class="linenos"> 44</span></a>
</span><span id="nuc_mat_symm-45"><a href="#nuc_mat_symm-45"><span class="linenos"> 45</span></a><span class="sd">    sqrt_ints4c2e_diag : ndarray, optional</span>
</span><span id="nuc_mat_symm-46"><a href="#nuc_mat_symm-46"><span class="linenos"> 46</span></a><span class="sd">        Optional Schwarz screening preconditioner.</span>
</span><span id="nuc_mat_symm-47"><a href="#nuc_mat_symm-47"><span class="linenos"> 47</span></a><span class="sd">        If provided, Schwarz screening is enabled to skip insignificant integrals.</span>
</span><span id="nuc_mat_symm-48"><a href="#nuc_mat_symm-48"><span class="linenos"> 48</span></a><span class="sd">        If `None` (default), all integrals are computed without screening.</span>
</span><span id="nuc_mat_symm-49"><a href="#nuc_mat_symm-49"><span class="linenos"> 49</span></a>
</span><span id="nuc_mat_symm-50"><a href="#nuc_mat_symm-50"><span class="linenos"> 50</span></a><span class="sd">    Returns</span>
</span><span id="nuc_mat_symm-51"><a href="#nuc_mat_symm-51"><span class="linenos"> 51</span></a><span class="sd">    -------</span>
</span><span id="nuc_mat_symm-52"><a href="#nuc_mat_symm-52"><span class="linenos"> 52</span></a><span class="sd">    V : ndarray of shape (end_row - start_row, end_col - start_col)</span>
</span><span id="nuc_mat_symm-53"><a href="#nuc_mat_symm-53"><span class="linenos"> 53</span></a><span class="sd">        The computed (sub)matrix of nuclear attraction integrals.</span>
</span><span id="nuc_mat_symm-54"><a href="#nuc_mat_symm-54"><span class="linenos"> 54</span></a>
</span><span id="nuc_mat_symm-55"><a href="#nuc_mat_symm-55"><span class="linenos"> 55</span></a><span class="sd">    Notes</span>
</span><span id="nuc_mat_symm-56"><a href="#nuc_mat_symm-56"><span class="linenos"> 56</span></a><span class="sd">    -----</span>
</span><span id="nuc_mat_symm-57"><a href="#nuc_mat_symm-57"><span class="linenos"> 57</span></a><span class="sd">    The integrals are evaluated using standard expressions over contracted Gaussians.</span>
</span><span id="nuc_mat_symm-58"><a href="#nuc_mat_symm-58"><span class="linenos"> 58</span></a><span class="sd">    If Schwarz screening is used (`sqrt_ints4c2e_diag` is not None), a threshold-based </span>
</span><span id="nuc_mat_symm-59"><a href="#nuc_mat_symm-59"><span class="linenos"> 59</span></a><span class="sd">    pruning is applied using precomputed upper bounds.</span>
</span><span id="nuc_mat_symm-60"><a href="#nuc_mat_symm-60"><span class="linenos"> 60</span></a>
</span><span id="nuc_mat_symm-61"><a href="#nuc_mat_symm-61"><span class="linenos"> 61</span></a><span class="sd">    Examples</span>
</span><span id="nuc_mat_symm-62"><a href="#nuc_mat_symm-62"><span class="linenos"> 62</span></a><span class="sd">    --------</span>
</span><span id="nuc_mat_symm-63"><a href="#nuc_mat_symm-63"><span class="linenos"> 63</span></a><span class="sd">    &gt;&gt;&gt; V = nuc_mat_symm(basis, mol)</span>
</span><span id="nuc_mat_symm-64"><a href="#nuc_mat_symm-64"><span class="linenos"> 64</span></a><span class="sd">    &gt;&gt;&gt; V_block = nuc_mat_symm(basis, mol, slice=[0, 10, 0, 10])</span>
</span><span id="nuc_mat_symm-65"><a href="#nuc_mat_symm-65"><span class="linenos"> 65</span></a><span class="sd">    &gt;&gt;&gt; V_schwarz = nuc_mat_symm(basis, mol, sqrt_ints4c2e_diag=sqrt_diag)</span>
</span><span id="nuc_mat_symm-66"><a href="#nuc_mat_symm-66"><span class="linenos"> 66</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="nuc_mat_symm-67"><a href="#nuc_mat_symm-67"><span class="linenos"> 67</span></a>    <span class="c1">#Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="nuc_mat_symm-68"><a href="#nuc_mat_symm-68"><span class="linenos"> 68</span></a>    <span class="c1">#Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="nuc_mat_symm-69"><a href="#nuc_mat_symm-69"><span class="linenos"> 69</span></a>    <span class="c1">#function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="nuc_mat_symm-70"><a href="#nuc_mat_symm-70"><span class="linenos"> 70</span></a>
</span><span id="nuc_mat_symm-71"><a href="#nuc_mat_symm-71"><span class="linenos"> 71</span></a>    <span class="c1"># This function calculates the nuclear matrix for a given basis object.</span>
</span><span id="nuc_mat_symm-72"><a href="#nuc_mat_symm-72"><span class="linenos"> 72</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="nuc_mat_symm-73"><a href="#nuc_mat_symm-73"><span class="linenos"> 73</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="nuc_mat_symm-74"><a href="#nuc_mat_symm-74"><span class="linenos"> 74</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="nuc_mat_symm-75"><a href="#nuc_mat_symm-75"><span class="linenos"> 75</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="nuc_mat_symm-76"><a href="#nuc_mat_symm-76"><span class="linenos"> 76</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="nuc_mat_symm-77"><a href="#nuc_mat_symm-77"><span class="linenos"> 77</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="nuc_mat_symm-78"><a href="#nuc_mat_symm-78"><span class="linenos"> 78</span></a>
</span><span id="nuc_mat_symm-79"><a href="#nuc_mat_symm-79"><span class="linenos"> 79</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="nuc_mat_symm-80"><a href="#nuc_mat_symm-80"><span class="linenos"> 80</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="nuc_mat_symm-81"><a href="#nuc_mat_symm-81"><span class="linenos"> 81</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="nuc_mat_symm-82"><a href="#nuc_mat_symm-82"><span class="linenos"> 82</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="nuc_mat_symm-83"><a href="#nuc_mat_symm-83"><span class="linenos"> 83</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm-84"><a href="#nuc_mat_symm-84"><span class="linenos"> 84</span></a>    <span class="n">coordsBohrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">])</span>
</span><span id="nuc_mat_symm-85"><a href="#nuc_mat_symm-85"><span class="linenos"> 85</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">])</span>
</span><span id="nuc_mat_symm-86"><a href="#nuc_mat_symm-86"><span class="linenos"> 86</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span>
</span><span id="nuc_mat_symm-87"><a href="#nuc_mat_symm-87"><span class="linenos"> 87</span></a>        
</span><span id="nuc_mat_symm-88"><a href="#nuc_mat_symm-88"><span class="linenos"> 88</span></a>
</span><span id="nuc_mat_symm-89"><a href="#nuc_mat_symm-89"><span class="linenos"> 89</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="nuc_mat_symm-90"><a href="#nuc_mat_symm-90"><span class="linenos"> 90</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="nuc_mat_symm-91"><a href="#nuc_mat_symm-91"><span class="linenos"> 91</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="nuc_mat_symm-92"><a href="#nuc_mat_symm-92"><span class="linenos"> 92</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="nuc_mat_symm-93"><a href="#nuc_mat_symm-93"><span class="linenos"> 93</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="nuc_mat_symm-94"><a href="#nuc_mat_symm-94"><span class="linenos"> 94</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="nuc_mat_symm-95"><a href="#nuc_mat_symm-95"><span class="linenos"> 95</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm-96"><a href="#nuc_mat_symm-96"><span class="linenos"> 96</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm-97"><a href="#nuc_mat_symm-97"><span class="linenos"> 97</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm-98"><a href="#nuc_mat_symm-98"><span class="linenos"> 98</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="nuc_mat_symm-99"><a href="#nuc_mat_symm-99"><span class="linenos"> 99</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="nuc_mat_symm-100"><a href="#nuc_mat_symm-100"><span class="linenos">100</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm-101"><a href="#nuc_mat_symm-101"><span class="linenos">101</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm-102"><a href="#nuc_mat_symm-102"><span class="linenos">102</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm-103"><a href="#nuc_mat_symm-103"><span class="linenos">103</span></a>        
</span><span id="nuc_mat_symm-104"><a href="#nuc_mat_symm-104"><span class="linenos">104</span></a>
</span><span id="nuc_mat_symm-105"><a href="#nuc_mat_symm-105"><span class="linenos">105</span></a>
</span><span id="nuc_mat_symm-106"><a href="#nuc_mat_symm-106"><span class="linenos">106</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm-107"><a href="#nuc_mat_symm-107"><span class="linenos">107</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="nuc_mat_symm-108"><a href="#nuc_mat_symm-108"><span class="linenos">108</span></a>        
</span><span id="nuc_mat_symm-109"><a href="#nuc_mat_symm-109"><span class="linenos">109</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="nuc_mat_symm-110"><a href="#nuc_mat_symm-110"><span class="linenos">110</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="nuc_mat_symm-111"><a href="#nuc_mat_symm-111"><span class="linenos">111</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="nuc_mat_symm-112"><a href="#nuc_mat_symm-112"><span class="linenos">112</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="nuc_mat_symm-113"><a href="#nuc_mat_symm-113"><span class="linenos">113</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="nuc_mat_symm-114"><a href="#nuc_mat_symm-114"><span class="linenos">114</span></a>
</span><span id="nuc_mat_symm-115"><a href="#nuc_mat_symm-115"><span class="linenos">115</span></a>    <span class="c1"># print([a,b,c,d])</span>
</span><span id="nuc_mat_symm-116"><a href="#nuc_mat_symm-116"><span class="linenos">116</span></a>
</span><span id="nuc_mat_symm-117"><a href="#nuc_mat_symm-117"><span class="linenos">117</span></a>    <span class="k">if</span> <span class="n">sqrt_ints4c2e_diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm-118"><a href="#nuc_mat_symm-118"><span class="linenos">118</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="nuc_mat_symm-119"><a href="#nuc_mat_symm-119"><span class="linenos">119</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="nuc_mat_symm-120"><a href="#nuc_mat_symm-120"><span class="linenos">120</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm-121"><a href="#nuc_mat_symm-121"><span class="linenos">121</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_symm-122"><a href="#nuc_mat_symm-122"><span class="linenos">122</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm-123"><a href="#nuc_mat_symm-123"><span class="linenos">123</span></a>    
</span><span id="nuc_mat_symm-124"><a href="#nuc_mat_symm-124"><span class="linenos">124</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">nuc_mat_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordsBohrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">isSchwarz</span><span class="p">)</span>
</span><span id="nuc_mat_symm-125"><a href="#nuc_mat_symm-125"><span class="linenos">125</span></a>    
</span><span id="nuc_mat_symm-126"><a href="#nuc_mat_symm-126"><span class="linenos">126</span></a>    <span class="k">return</span> <span class="n">V</span> 
</span></pre></div>


            <div class="docstring"><p>Compute the nuclear attraction matrix for a given basis and molecular geometry.</p>

<p>This function evaluates the one-electron nuclear attraction integrals 
⟨χ_i | V_nuc | χ_j⟩, where V_nuc is the Coulombic potential from the atomic nuclei.
The integrals are computed between all basis functions defined in <code>basis</code> and 
and the nuclei within the <code>mol</code> object.
So in principle, it can be used to compute the nuclear potential matrix due to the
nuclei in one molecule, in the basis of another molecule.</p>

<p>Efficient Numba-accelerated routines are used to improve performance. 
A partial block of the matrix can be computed by specifying a <code>slice</code>.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Basis set object with fields including:
    - bfs_coords: Cartesian coordinates of basis function centers.
    - bfs_coeffs: Contraction coefficients.
    - bfs_expnts: Gaussian exponents.
    - bfs_prim_norms: Normalization constants for primitives.
    - bfs_contr_prim_norms: Normalization constants for contracted functions.
    - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim: Number of primitives per basis function.
    - bfs_nao: Number of atomic orbitals (contracted basis functions).</p>

<p>mol : object
    Molecule object containing:
    - coordsBohrs: Cartesian coordinates of nuclei (in Bohr).
    - Zcharges: Nuclear charges.
    - natoms: Number of atoms.</p>

<p>slice : list of int, optional
    A 4-element list <code>[start_row, end_row, start_col, end_col]</code> defining 
    the sub-block of the matrix to compute. Rows and columns refer to AOs.
    If <code>None</code> (default), the entire nuclear attraction matrix is computed.</p>

<p>sqrt_ints4c2e_diag : ndarray, optional
    Optional Schwarz screening preconditioner.
    If provided, Schwarz screening is enabled to skip insignificant integrals.
    If <code>None</code> (default), all integrals are computed without screening.</p>

<h2 id="returns">Returns</h2>

<p>V : ndarray of shape (end_row - start_row, end_col - start_col)
    The computed (sub)matrix of nuclear attraction integrals.</p>

<h2 id="notes">Notes</h2>

<p>The integrals are evaluated using standard expressions over contracted Gaussians.
If Schwarz screening is used (<code>sqrt_ints4c2e_diag</code> is not None), a threshold-based 
pruning is applied using precomputed upper bounds.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">V</span> <span class="o">=</span> <span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">V_block</span> <span class="o">=</span> <span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">V_schwarz</span> <span class="o">=</span> <span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="n">sqrt_diag</span><span class="p">)</span>
</code></pre>
</div>
</div>


                </section>
                <section id="kin_mat_symm">
                            <input id="kin_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kin_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="kin_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#kin_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="kin_mat_symm-6"><a href="#kin_mat_symm-6"><span class="linenos"> 6</span></a><span class="k">def</span><span class="w"> </span><span class="nf">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="kin_mat_symm-7"><a href="#kin_mat_symm-7"><span class="linenos"> 7</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="kin_mat_symm-8"><a href="#kin_mat_symm-8"><span class="linenos"> 8</span></a><span class="sd">    Compute the kinetic energy matrix for a given basis set.</span>
</span><span id="kin_mat_symm-9"><a href="#kin_mat_symm-9"><span class="linenos"> 9</span></a>
</span><span id="kin_mat_symm-10"><a href="#kin_mat_symm-10"><span class="linenos">10</span></a><span class="sd">    This function evaluates the one-electron kinetic energy integrals </span>
</span><span id="kin_mat_symm-11"><a href="#kin_mat_symm-11"><span class="linenos">11</span></a><span class="sd">    ⟨χ_i | -½∇² | χ_j⟩ for a set of contracted Gaussian basis functions defined in `basis`. </span>
</span><span id="kin_mat_symm-12"><a href="#kin_mat_symm-12"><span class="linenos">12</span></a><span class="sd">    It uses an optimized backend with improved memory layout, early termination, </span>
</span><span id="kin_mat_symm-13"><a href="#kin_mat_symm-13"><span class="linenos">13</span></a><span class="sd">    and partial vectorization for enhanced performance.</span>
</span><span id="kin_mat_symm-14"><a href="#kin_mat_symm-14"><span class="linenos">14</span></a>
</span><span id="kin_mat_symm-15"><a href="#kin_mat_symm-15"><span class="linenos">15</span></a><span class="sd">    Block-wise computation is supported through the optional `slice` parameter.</span>
</span><span id="kin_mat_symm-16"><a href="#kin_mat_symm-16"><span class="linenos">16</span></a>
</span><span id="kin_mat_symm-17"><a href="#kin_mat_symm-17"><span class="linenos">17</span></a><span class="sd">    Parameters</span>
</span><span id="kin_mat_symm-18"><a href="#kin_mat_symm-18"><span class="linenos">18</span></a><span class="sd">    ----------</span>
</span><span id="kin_mat_symm-19"><a href="#kin_mat_symm-19"><span class="linenos">19</span></a><span class="sd">    basis : object</span>
</span><span id="kin_mat_symm-20"><a href="#kin_mat_symm-20"><span class="linenos">20</span></a><span class="sd">        Basis set object containing properties such as:</span>
</span><span id="kin_mat_symm-21"><a href="#kin_mat_symm-21"><span class="linenos">21</span></a><span class="sd">        - bfs_coords: Cartesian coordinates of basis function centers.</span>
</span><span id="kin_mat_symm-22"><a href="#kin_mat_symm-22"><span class="linenos">22</span></a><span class="sd">        - bfs_coeffs: Contraction coefficients.</span>
</span><span id="kin_mat_symm-23"><a href="#kin_mat_symm-23"><span class="linenos">23</span></a><span class="sd">        - bfs_expnts: Gaussian exponents.</span>
</span><span id="kin_mat_symm-24"><a href="#kin_mat_symm-24"><span class="linenos">24</span></a><span class="sd">        - bfs_prim_norms: Normalization constants for primitives.</span>
</span><span id="kin_mat_symm-25"><a href="#kin_mat_symm-25"><span class="linenos">25</span></a><span class="sd">        - bfs_contr_prim_norms: Normalization constants for contracted functions.</span>
</span><span id="kin_mat_symm-26"><a href="#kin_mat_symm-26"><span class="linenos">26</span></a><span class="sd">        - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="kin_mat_symm-27"><a href="#kin_mat_symm-27"><span class="linenos">27</span></a><span class="sd">        - bfs_nprim: Number of primitives per basis function.</span>
</span><span id="kin_mat_symm-28"><a href="#kin_mat_symm-28"><span class="linenos">28</span></a><span class="sd">        - bfs_nao: Number of atomic orbitals (contracted basis functions).</span>
</span><span id="kin_mat_symm-29"><a href="#kin_mat_symm-29"><span class="linenos">29</span></a>
</span><span id="kin_mat_symm-30"><a href="#kin_mat_symm-30"><span class="linenos">30</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="kin_mat_symm-31"><a href="#kin_mat_symm-31"><span class="linenos">31</span></a><span class="sd">        A 4-element list `[start_row, end_row, start_col, end_col]` specifying the </span>
</span><span id="kin_mat_symm-32"><a href="#kin_mat_symm-32"><span class="linenos">32</span></a><span class="sd">        matrix block to compute. Rows and columns refer to AOs. If `None` (default), </span>
</span><span id="kin_mat_symm-33"><a href="#kin_mat_symm-33"><span class="linenos">33</span></a><span class="sd">        the entire kinetic energy matrix is calculated.</span>
</span><span id="kin_mat_symm-34"><a href="#kin_mat_symm-34"><span class="linenos">34</span></a>
</span><span id="kin_mat_symm-35"><a href="#kin_mat_symm-35"><span class="linenos">35</span></a><span class="sd">    Returns</span>
</span><span id="kin_mat_symm-36"><a href="#kin_mat_symm-36"><span class="linenos">36</span></a><span class="sd">    -------</span>
</span><span id="kin_mat_symm-37"><a href="#kin_mat_symm-37"><span class="linenos">37</span></a><span class="sd">    T : ndarray of shape (end_row - start_row, end_col - start_col)</span>
</span><span id="kin_mat_symm-38"><a href="#kin_mat_symm-38"><span class="linenos">38</span></a><span class="sd">        The computed (sub)matrix of kinetic energy integrals.</span>
</span><span id="kin_mat_symm-39"><a href="#kin_mat_symm-39"><span class="linenos">39</span></a>
</span><span id="kin_mat_symm-40"><a href="#kin_mat_symm-40"><span class="linenos">40</span></a><span class="sd">    Notes</span>
</span><span id="kin_mat_symm-41"><a href="#kin_mat_symm-41"><span class="linenos">41</span></a><span class="sd">    -----</span>
</span><span id="kin_mat_symm-42"><a href="#kin_mat_symm-42"><span class="linenos">42</span></a><span class="sd">    Internally, this function:</span>
</span><span id="kin_mat_symm-43"><a href="#kin_mat_symm-43"><span class="linenos">43</span></a><span class="sd">    - Pads coefficient/exponent arrays for uniform shape and Numba compatibility.</span>
</span><span id="kin_mat_symm-44"><a href="#kin_mat_symm-44"><span class="linenos">44</span></a><span class="sd">    - Reduces redundant operations and loops.</span>
</span><span id="kin_mat_symm-45"><a href="#kin_mat_symm-45"><span class="linenos">45</span></a><span class="sd">    - Utilizes an optimized `kin_mat_symm_internal_optimized` backend.</span>
</span><span id="kin_mat_symm-46"><a href="#kin_mat_symm-46"><span class="linenos">46</span></a>
</span><span id="kin_mat_symm-47"><a href="#kin_mat_symm-47"><span class="linenos">47</span></a><span class="sd">    Examples</span>
</span><span id="kin_mat_symm-48"><a href="#kin_mat_symm-48"><span class="linenos">48</span></a><span class="sd">    --------</span>
</span><span id="kin_mat_symm-49"><a href="#kin_mat_symm-49"><span class="linenos">49</span></a><span class="sd">    &gt;&gt;&gt; T = kin_mat_symm(basis)</span>
</span><span id="kin_mat_symm-50"><a href="#kin_mat_symm-50"><span class="linenos">50</span></a><span class="sd">    &gt;&gt;&gt; T_block = kin_mat_symm(basis, slice=[0, 10, 0, 10])</span>
</span><span id="kin_mat_symm-51"><a href="#kin_mat_symm-51"><span class="linenos">51</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="kin_mat_symm-52"><a href="#kin_mat_symm-52"><span class="linenos">52</span></a>    
</span><span id="kin_mat_symm-53"><a href="#kin_mat_symm-53"><span class="linenos">53</span></a>    <span class="c1"># Convert to numpy arrays (same as before)</span>
</span><span id="kin_mat_symm-54"><a href="#kin_mat_symm-54"><span class="linenos">54</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">)</span>  <span class="c1"># Remove unnecessary list wrapping</span>
</span><span id="kin_mat_symm-55"><a href="#kin_mat_symm-55"><span class="linenos">55</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">)</span>
</span><span id="kin_mat_symm-56"><a href="#kin_mat_symm-56"><span class="linenos">56</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">)</span>
</span><span id="kin_mat_symm-57"><a href="#kin_mat_symm-57"><span class="linenos">57</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="kin_mat_symm-58"><a href="#kin_mat_symm-58"><span class="linenos">58</span></a>    
</span><span id="kin_mat_symm-59"><a href="#kin_mat_symm-59"><span class="linenos">59</span></a>    <span class="c1"># Optimize the coefficient/exponent arrays</span>
</span><span id="kin_mat_symm-60"><a href="#kin_mat_symm-60"><span class="linenos">60</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="kin_mat_symm-61"><a href="#kin_mat_symm-61"><span class="linenos">61</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">))</span>
</span><span id="kin_mat_symm-62"><a href="#kin_mat_symm-62"><span class="linenos">62</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">))</span>
</span><span id="kin_mat_symm-63"><a href="#kin_mat_symm-63"><span class="linenos">63</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">))</span>
</span><span id="kin_mat_symm-64"><a href="#kin_mat_symm-64"><span class="linenos">64</span></a>    
</span><span id="kin_mat_symm-65"><a href="#kin_mat_symm-65"><span class="linenos">65</span></a>    <span class="c1"># Vectorized assignment (faster than nested loops)</span>
</span><span id="kin_mat_symm-66"><a href="#kin_mat_symm-66"><span class="linenos">66</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="kin_mat_symm-67"><a href="#kin_mat_symm-67"><span class="linenos">67</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="kin_mat_symm-68"><a href="#kin_mat_symm-68"><span class="linenos">68</span></a>        <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="kin_mat_symm-69"><a href="#kin_mat_symm-69"><span class="linenos">69</span></a>        <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="kin_mat_symm-70"><a href="#kin_mat_symm-70"><span class="linenos">70</span></a>        <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="kin_mat_symm-71"><a href="#kin_mat_symm-71"><span class="linenos">71</span></a>    
</span><span id="kin_mat_symm-72"><a href="#kin_mat_symm-72"><span class="linenos">72</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_symm-73"><a href="#kin_mat_symm-73"><span class="linenos">73</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="kin_mat_symm-74"><a href="#kin_mat_symm-74"><span class="linenos">74</span></a>    
</span><span id="kin_mat_symm-75"><a href="#kin_mat_symm-75"><span class="linenos">75</span></a>    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>
</span><span id="kin_mat_symm-76"><a href="#kin_mat_symm-76"><span class="linenos">76</span></a>    
</span><span id="kin_mat_symm-77"><a href="#kin_mat_symm-77"><span class="linenos">77</span></a>    <span class="n">T</span> <span class="o">=</span> <span class="n">kin_mat_symm_internal_optimized</span><span class="p">(</span>
</span><span id="kin_mat_symm-78"><a href="#kin_mat_symm-78"><span class="linenos">78</span></a>        <span class="n">bfs_coords</span><span class="p">,</span> <span class="n">bfs_contr_prim_norms</span><span class="p">,</span> <span class="n">bfs_lmn</span><span class="p">,</span> <span class="n">bfs_nprim</span><span class="p">,</span> 
</span><span id="kin_mat_symm-79"><a href="#kin_mat_symm-79"><span class="linenos">79</span></a>        <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span>
</span><span id="kin_mat_symm-80"><a href="#kin_mat_symm-80"><span class="linenos">80</span></a>    <span class="p">)</span>
</span><span id="kin_mat_symm-81"><a href="#kin_mat_symm-81"><span class="linenos">81</span></a>    
</span><span id="kin_mat_symm-82"><a href="#kin_mat_symm-82"><span class="linenos">82</span></a>    <span class="k">return</span> <span class="n">T</span>
</span></pre></div>


            <div class="docstring"><p>Compute the kinetic energy matrix for a given basis set.</p>

<p>This function evaluates the one-electron kinetic energy integrals 
⟨χ_i | -½∇² | χ_j⟩ for a set of contracted Gaussian basis functions defined in <code>basis</code>. 
It uses an optimized backend with improved memory layout, early termination, 
and partial vectorization for enhanced performance.</p>

<p>Block-wise computation is supported through the optional <code>slice</code> parameter.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Basis set object containing properties such as:
    - bfs_coords: Cartesian coordinates of basis function centers.
    - bfs_coeffs: Contraction coefficients.
    - bfs_expnts: Gaussian exponents.
    - bfs_prim_norms: Normalization constants for primitives.
    - bfs_contr_prim_norms: Normalization constants for contracted functions.
    - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim: Number of primitives per basis function.
    - bfs_nao: Number of atomic orbitals (contracted basis functions).</p>

<p>slice : list of int, optional
    A 4-element list <code>[start_row, end_row, start_col, end_col]</code> specifying the 
    matrix block to compute. Rows and columns refer to AOs. If <code>None</code> (default), 
    the entire kinetic energy matrix is calculated.</p>

<h2 id="returns">Returns</h2>

<p>T : ndarray of shape (end_row - start_row, end_col - start_col)
    The computed (sub)matrix of kinetic energy integrals.</p>

<h2 id="notes">Notes</h2>

<p>Internally, this function:</p>

<ul>
<li>Pads coefficient/exponent arrays for uniform shape and Numba compatibility.</li>
<li>Reduces redundant operations and loops.</li>
<li>Utilizes an optimized <code>kin_mat_symm_internal_optimized</code> backend.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">T</span> <span class="o">=</span> <span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">T_block</span> <span class="o">=</span> <span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="overlap_mat_symm">
                            <input id="overlap_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">overlap_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="overlap_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#overlap_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="overlap_mat_symm-7"><a href="#overlap_mat_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="overlap_mat_symm-8"><a href="#overlap_mat_symm-8"><span class="linenos"> 8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="overlap_mat_symm-9"><a href="#overlap_mat_symm-9"><span class="linenos"> 9</span></a><span class="sd">    Compute the overlap matrix for a given basis set using symmetry-aware integrals.</span>
</span><span id="overlap_mat_symm-10"><a href="#overlap_mat_symm-10"><span class="linenos">10</span></a>
</span><span id="overlap_mat_symm-11"><a href="#overlap_mat_symm-11"><span class="linenos">11</span></a><span class="sd">    This function evaluates the overlap integrals ⟨χ_i | χ_j⟩ between all pairs </span>
</span><span id="overlap_mat_symm-12"><a href="#overlap_mat_symm-12"><span class="linenos">12</span></a><span class="sd">    of basis functions defined in the `basis` object. It supports partial evaluation </span>
</span><span id="overlap_mat_symm-13"><a href="#overlap_mat_symm-13"><span class="linenos">13</span></a><span class="sd">    of the overlap matrix by specifying a slice.</span>
</span><span id="overlap_mat_symm-14"><a href="#overlap_mat_symm-14"><span class="linenos">14</span></a>
</span><span id="overlap_mat_symm-15"><a href="#overlap_mat_symm-15"><span class="linenos">15</span></a><span class="sd">    The integrals are computed using an efficient Numba-accelerated backend that </span>
</span><span id="overlap_mat_symm-16"><a href="#overlap_mat_symm-16"><span class="linenos">16</span></a><span class="sd">    benefits from parallelization via `prange` and preprocessed NumPy arrays.</span>
</span><span id="overlap_mat_symm-17"><a href="#overlap_mat_symm-17"><span class="linenos">17</span></a>
</span><span id="overlap_mat_symm-18"><a href="#overlap_mat_symm-18"><span class="linenos">18</span></a><span class="sd">    Parameters</span>
</span><span id="overlap_mat_symm-19"><a href="#overlap_mat_symm-19"><span class="linenos">19</span></a><span class="sd">    ----------</span>
</span><span id="overlap_mat_symm-20"><a href="#overlap_mat_symm-20"><span class="linenos">20</span></a><span class="sd">    basis : object</span>
</span><span id="overlap_mat_symm-21"><a href="#overlap_mat_symm-21"><span class="linenos">21</span></a><span class="sd">        A basis set object that contains information about basis functions, such as:</span>
</span><span id="overlap_mat_symm-22"><a href="#overlap_mat_symm-22"><span class="linenos">22</span></a><span class="sd">        - bfs_coords: Cartesian coordinates of the basis function centers.</span>
</span><span id="overlap_mat_symm-23"><a href="#overlap_mat_symm-23"><span class="linenos">23</span></a><span class="sd">        - bfs_coeffs: Contraction coefficients.</span>
</span><span id="overlap_mat_symm-24"><a href="#overlap_mat_symm-24"><span class="linenos">24</span></a><span class="sd">        - bfs_expnts: Gaussian exponents.</span>
</span><span id="overlap_mat_symm-25"><a href="#overlap_mat_symm-25"><span class="linenos">25</span></a><span class="sd">        - bfs_prim_norms: Primitive normalization constants.</span>
</span><span id="overlap_mat_symm-26"><a href="#overlap_mat_symm-26"><span class="linenos">26</span></a><span class="sd">        - bfs_contr_prim_norms: Contraction normalization factors.</span>
</span><span id="overlap_mat_symm-27"><a href="#overlap_mat_symm-27"><span class="linenos">27</span></a><span class="sd">        - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="overlap_mat_symm-28"><a href="#overlap_mat_symm-28"><span class="linenos">28</span></a><span class="sd">        - bfs_nprim: Number of primitives per basis function.</span>
</span><span id="overlap_mat_symm-29"><a href="#overlap_mat_symm-29"><span class="linenos">29</span></a><span class="sd">        - bfs_nao: Total number of atomic orbitals.</span>
</span><span id="overlap_mat_symm-30"><a href="#overlap_mat_symm-30"><span class="linenos">30</span></a><span class="sd">    </span>
</span><span id="overlap_mat_symm-31"><a href="#overlap_mat_symm-31"><span class="linenos">31</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="overlap_mat_symm-32"><a href="#overlap_mat_symm-32"><span class="linenos">32</span></a><span class="sd">        A 4-element list specifying a sub-block of the matrix to compute:</span>
</span><span id="overlap_mat_symm-33"><a href="#overlap_mat_symm-33"><span class="linenos">33</span></a><span class="sd">        [start_row, end_row, start_col, end_col].</span>
</span><span id="overlap_mat_symm-34"><a href="#overlap_mat_symm-34"><span class="linenos">34</span></a><span class="sd">        If None (default), the full overlap matrix is computed.</span>
</span><span id="overlap_mat_symm-35"><a href="#overlap_mat_symm-35"><span class="linenos">35</span></a>
</span><span id="overlap_mat_symm-36"><a href="#overlap_mat_symm-36"><span class="linenos">36</span></a><span class="sd">    Returns</span>
</span><span id="overlap_mat_symm-37"><a href="#overlap_mat_symm-37"><span class="linenos">37</span></a><span class="sd">    -------</span>
</span><span id="overlap_mat_symm-38"><a href="#overlap_mat_symm-38"><span class="linenos">38</span></a><span class="sd">    S : ndarray of shape (end_row - start_row, end_col - start_col)</span>
</span><span id="overlap_mat_symm-39"><a href="#overlap_mat_symm-39"><span class="linenos">39</span></a><span class="sd">        The computed (sub)matrix of overlap integrals.</span>
</span><span id="overlap_mat_symm-40"><a href="#overlap_mat_symm-40"><span class="linenos">40</span></a>
</span><span id="overlap_mat_symm-41"><a href="#overlap_mat_symm-41"><span class="linenos">41</span></a><span class="sd">    Notes</span>
</span><span id="overlap_mat_symm-42"><a href="#overlap_mat_symm-42"><span class="linenos">42</span></a><span class="sd">    -----</span>
</span><span id="overlap_mat_symm-43"><a href="#overlap_mat_symm-43"><span class="linenos">43</span></a><span class="sd">    This function is optimized for performance using preallocated NumPy arrays</span>
</span><span id="overlap_mat_symm-44"><a href="#overlap_mat_symm-44"><span class="linenos">44</span></a><span class="sd">    and avoids nested Python lists which are not supported efficiently by Numba.</span>
</span><span id="overlap_mat_symm-45"><a href="#overlap_mat_symm-45"><span class="linenos">45</span></a>
</span><span id="overlap_mat_symm-46"><a href="#overlap_mat_symm-46"><span class="linenos">46</span></a><span class="sd">    Examples</span>
</span><span id="overlap_mat_symm-47"><a href="#overlap_mat_symm-47"><span class="linenos">47</span></a><span class="sd">    --------</span>
</span><span id="overlap_mat_symm-48"><a href="#overlap_mat_symm-48"><span class="linenos">48</span></a><span class="sd">    &gt;&gt;&gt; S = overlap_mat_symm(basis)</span>
</span><span id="overlap_mat_symm-49"><a href="#overlap_mat_symm-49"><span class="linenos">49</span></a><span class="sd">    &gt;&gt;&gt; S_block = overlap_mat_symm(basis, slice=[0, 10, 0, 10])</span>
</span><span id="overlap_mat_symm-50"><a href="#overlap_mat_symm-50"><span class="linenos">50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="overlap_mat_symm-51"><a href="#overlap_mat_symm-51"><span class="linenos">51</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="overlap_mat_symm-52"><a href="#overlap_mat_symm-52"><span class="linenos">52</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="overlap_mat_symm-53"><a href="#overlap_mat_symm-53"><span class="linenos">53</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="overlap_mat_symm-54"><a href="#overlap_mat_symm-54"><span class="linenos">54</span></a>
</span><span id="overlap_mat_symm-55"><a href="#overlap_mat_symm-55"><span class="linenos">55</span></a>    <span class="c1"># This function calculates the overlap matrix for a given basis object.</span>
</span><span id="overlap_mat_symm-56"><a href="#overlap_mat_symm-56"><span class="linenos">56</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="overlap_mat_symm-57"><a href="#overlap_mat_symm-57"><span class="linenos">57</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="overlap_mat_symm-58"><a href="#overlap_mat_symm-58"><span class="linenos">58</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="overlap_mat_symm-59"><a href="#overlap_mat_symm-59"><span class="linenos">59</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="overlap_mat_symm-60"><a href="#overlap_mat_symm-60"><span class="linenos">60</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="overlap_mat_symm-61"><a href="#overlap_mat_symm-61"><span class="linenos">61</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="overlap_mat_symm-62"><a href="#overlap_mat_symm-62"><span class="linenos">62</span></a>
</span><span id="overlap_mat_symm-63"><a href="#overlap_mat_symm-63"><span class="linenos">63</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="overlap_mat_symm-64"><a href="#overlap_mat_symm-64"><span class="linenos">64</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="overlap_mat_symm-65"><a href="#overlap_mat_symm-65"><span class="linenos">65</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="overlap_mat_symm-66"><a href="#overlap_mat_symm-66"><span class="linenos">66</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="overlap_mat_symm-67"><a href="#overlap_mat_symm-67"><span class="linenos">67</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm-68"><a href="#overlap_mat_symm-68"><span class="linenos">68</span></a>        
</span><span id="overlap_mat_symm-69"><a href="#overlap_mat_symm-69"><span class="linenos">69</span></a>
</span><span id="overlap_mat_symm-70"><a href="#overlap_mat_symm-70"><span class="linenos">70</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="overlap_mat_symm-71"><a href="#overlap_mat_symm-71"><span class="linenos">71</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="overlap_mat_symm-72"><a href="#overlap_mat_symm-72"><span class="linenos">72</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="overlap_mat_symm-73"><a href="#overlap_mat_symm-73"><span class="linenos">73</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="overlap_mat_symm-74"><a href="#overlap_mat_symm-74"><span class="linenos">74</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="overlap_mat_symm-75"><a href="#overlap_mat_symm-75"><span class="linenos">75</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="overlap_mat_symm-76"><a href="#overlap_mat_symm-76"><span class="linenos">76</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm-77"><a href="#overlap_mat_symm-77"><span class="linenos">77</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm-78"><a href="#overlap_mat_symm-78"><span class="linenos">78</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm-79"><a href="#overlap_mat_symm-79"><span class="linenos">79</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="overlap_mat_symm-80"><a href="#overlap_mat_symm-80"><span class="linenos">80</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="overlap_mat_symm-81"><a href="#overlap_mat_symm-81"><span class="linenos">81</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm-82"><a href="#overlap_mat_symm-82"><span class="linenos">82</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm-83"><a href="#overlap_mat_symm-83"><span class="linenos">83</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm-84"><a href="#overlap_mat_symm-84"><span class="linenos">84</span></a>        
</span><span id="overlap_mat_symm-85"><a href="#overlap_mat_symm-85"><span class="linenos">85</span></a>
</span><span id="overlap_mat_symm-86"><a href="#overlap_mat_symm-86"><span class="linenos">86</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="overlap_mat_symm-87"><a href="#overlap_mat_symm-87"><span class="linenos">87</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="overlap_mat_symm-88"><a href="#overlap_mat_symm-88"><span class="linenos">88</span></a>        
</span><span id="overlap_mat_symm-89"><a href="#overlap_mat_symm-89"><span class="linenos">89</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="overlap_mat_symm-90"><a href="#overlap_mat_symm-90"><span class="linenos">90</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="overlap_mat_symm-91"><a href="#overlap_mat_symm-91"><span class="linenos">91</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="overlap_mat_symm-92"><a href="#overlap_mat_symm-92"><span class="linenos">92</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="overlap_mat_symm-93"><a href="#overlap_mat_symm-93"><span class="linenos">93</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="overlap_mat_symm-94"><a href="#overlap_mat_symm-94"><span class="linenos">94</span></a>        
</span><span id="overlap_mat_symm-95"><a href="#overlap_mat_symm-95"><span class="linenos">95</span></a>    <span class="n">S</span> <span class="o">=</span> <span class="n">overlap_mat_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="overlap_mat_symm-96"><a href="#overlap_mat_symm-96"><span class="linenos">96</span></a>    <span class="k">return</span> <span class="n">S</span>
</span></pre></div>


            <div class="docstring"><p>Compute the overlap matrix for a given basis set using symmetry-aware integrals.</p>

<p>This function evaluates the overlap integrals ⟨χ_i | χ_j⟩ between all pairs 
of basis functions defined in the <code>basis</code> object. It supports partial evaluation 
of the overlap matrix by specifying a slice.</p>

<p>The integrals are computed using an efficient Numba-accelerated backend that 
benefits from parallelization via <code>prange</code> and preprocessed NumPy arrays.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    A basis set object that contains information about basis functions, such as:
    - bfs_coords: Cartesian coordinates of the basis function centers.
    - bfs_coeffs: Contraction coefficients.
    - bfs_expnts: Gaussian exponents.
    - bfs_prim_norms: Primitive normalization constants.
    - bfs_contr_prim_norms: Contraction normalization factors.
    - bfs_lmn: Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim: Number of primitives per basis function.
    - bfs_nao: Total number of atomic orbitals.</p>

<p>slice : list of int, optional
    A 4-element list specifying a sub-block of the matrix to compute:
    [start_row, end_row, start_col, end_col].
    If None (default), the full overlap matrix is computed.</p>

<h2 id="returns">Returns</h2>

<p>S : ndarray of shape (end_row - start_row, end_col - start_col)
    The computed (sub)matrix of overlap integrals.</p>

<h2 id="notes">Notes</h2>

<p>This function is optimized for performance using preallocated NumPy arrays
and avoids nested Python lists which are not supported efficiently by Numba.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">S</span> <span class="o">=</span> <span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">S_block</span> <span class="o">=</span> <span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="conv_4c2e_symm">
                            <input id="conv_4c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">conv_4c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="conv_4c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#conv_4c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="conv_4c2e_symm-7"><a href="#conv_4c2e_symm-7"><span class="linenos">  7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="conv_4c2e_symm-8"><a href="#conv_4c2e_symm-8"><span class="linenos">  8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="conv_4c2e_symm-9"><a href="#conv_4c2e_symm-9"><span class="linenos">  9</span></a><span class="sd">    Compute four-center two-electron (4c2e) electron repulsion integrals (ERIs)</span>
</span><span id="conv_4c2e_symm-10"><a href="#conv_4c2e_symm-10"><span class="linenos"> 10</span></a><span class="sd">    using the conventional and slow (analytical) formula-based method with full symmetry exploitation.</span>
</span><span id="conv_4c2e_symm-11"><a href="#conv_4c2e_symm-11"><span class="linenos"> 11</span></a>
</span><span id="conv_4c2e_symm-12"><a href="#conv_4c2e_symm-12"><span class="linenos"> 12</span></a><span class="sd">    This function evaluates integrals of the form (A B | C D), where</span>
</span><span id="conv_4c2e_symm-13"><a href="#conv_4c2e_symm-13"><span class="linenos"> 13</span></a><span class="sd">    A, B, C, D are basis functions from the same primary basis set.</span>
</span><span id="conv_4c2e_symm-14"><a href="#conv_4c2e_symm-14"><span class="linenos"> 14</span></a>
</span><span id="conv_4c2e_symm-15"><a href="#conv_4c2e_symm-15"><span class="linenos"> 15</span></a><span class="sd">    The &quot;conv&quot; variant uses explicit analytical integral formulas and</span>
</span><span id="conv_4c2e_symm-16"><a href="#conv_4c2e_symm-16"><span class="linenos"> 16</span></a><span class="sd">    nested loops over primitive Gaussians, following the derivations in:</span>
</span><span id="conv_4c2e_symm-17"><a href="#conv_4c2e_symm-17"><span class="linenos"> 17</span></a>
</span><span id="conv_4c2e_symm-18"><a href="#conv_4c2e_symm-18"><span class="linenos"> 18</span></a><span class="sd">        J. Chem. Educ. 2018, 95, 9, 1572–1578</span>
</span><span id="conv_4c2e_symm-19"><a href="#conv_4c2e_symm-19"><span class="linenos"> 19</span></a><span class="sd">        https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255</span>
</span><span id="conv_4c2e_symm-20"><a href="#conv_4c2e_symm-20"><span class="linenos"> 20</span></a>
</span><span id="conv_4c2e_symm-21"><a href="#conv_4c2e_symm-21"><span class="linenos"> 21</span></a><span class="sd">    Compared to Rys quadrature, this conventional approach is much more</span>
</span><span id="conv_4c2e_symm-22"><a href="#conv_4c2e_symm-22"><span class="linenos"> 22</span></a><span class="sd">    computationally expensive but exact for the given formula set, making</span>
</span><span id="conv_4c2e_symm-23"><a href="#conv_4c2e_symm-23"><span class="linenos"> 23</span></a><span class="sd">    it useful for validation and special-purpose computations.</span>
</span><span id="conv_4c2e_symm-24"><a href="#conv_4c2e_symm-24"><span class="linenos"> 24</span></a>
</span><span id="conv_4c2e_symm-25"><a href="#conv_4c2e_symm-25"><span class="linenos"> 25</span></a><span class="sd">    Symmetries exploited</span>
</span><span id="conv_4c2e_symm-26"><a href="#conv_4c2e_symm-26"><span class="linenos"> 26</span></a><span class="sd">    --------------------</span>
</span><span id="conv_4c2e_symm-27"><a href="#conv_4c2e_symm-27"><span class="linenos"> 27</span></a><span class="sd">    For 4c2e integrals, the full 8-fold permutational symmetry is used:</span>
</span><span id="conv_4c2e_symm-28"><a href="#conv_4c2e_symm-28"><span class="linenos"> 28</span></a>
</span><span id="conv_4c2e_symm-29"><a href="#conv_4c2e_symm-29"><span class="linenos"> 29</span></a><span class="sd">        (A B | C D) = (B A | C D) = (A B | D C) = (B A | D C)</span>
</span><span id="conv_4c2e_symm-30"><a href="#conv_4c2e_symm-30"><span class="linenos"> 30</span></a><span class="sd">                    = (C D | A B) = (D C | A B) = (C D | B A) = (D C | B A)</span>
</span><span id="conv_4c2e_symm-31"><a href="#conv_4c2e_symm-31"><span class="linenos"> 31</span></a>
</span><span id="conv_4c2e_symm-32"><a href="#conv_4c2e_symm-32"><span class="linenos"> 32</span></a><span class="sd">    This reduces the number of independent integrals from:</span>
</span><span id="conv_4c2e_symm-33"><a href="#conv_4c2e_symm-33"><span class="linenos"> 33</span></a><span class="sd">        N_bf^4   →   N_bf*(N_bf+1)/2 * N_bf*(N_bf+1)/2</span>
</span><span id="conv_4c2e_symm-34"><a href="#conv_4c2e_symm-34"><span class="linenos"> 34</span></a><span class="sd">    when computing the full tensor.</span>
</span><span id="conv_4c2e_symm-35"><a href="#conv_4c2e_symm-35"><span class="linenos"> 35</span></a>
</span><span id="conv_4c2e_symm-36"><a href="#conv_4c2e_symm-36"><span class="linenos"> 36</span></a><span class="sd">    Parameters</span>
</span><span id="conv_4c2e_symm-37"><a href="#conv_4c2e_symm-37"><span class="linenos"> 37</span></a><span class="sd">    ----------</span>
</span><span id="conv_4c2e_symm-38"><a href="#conv_4c2e_symm-38"><span class="linenos"> 38</span></a><span class="sd">    basis : object</span>
</span><span id="conv_4c2e_symm-39"><a href="#conv_4c2e_symm-39"><span class="linenos"> 39</span></a><span class="sd">        Basis set object containing:</span>
</span><span id="conv_4c2e_symm-40"><a href="#conv_4c2e_symm-40"><span class="linenos"> 40</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of basis function centers</span>
</span><span id="conv_4c2e_symm-41"><a href="#conv_4c2e_symm-41"><span class="linenos"> 41</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients</span>
</span><span id="conv_4c2e_symm-42"><a href="#conv_4c2e_symm-42"><span class="linenos"> 42</span></a><span class="sd">        - bfs_expnts : Gaussian exponents</span>
</span><span id="conv_4c2e_symm-43"><a href="#conv_4c2e_symm-43"><span class="linenos"> 43</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants</span>
</span><span id="conv_4c2e_symm-44"><a href="#conv_4c2e_symm-44"><span class="linenos"> 44</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors</span>
</span><span id="conv_4c2e_symm-45"><a href="#conv_4c2e_symm-45"><span class="linenos"> 45</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)</span>
</span><span id="conv_4c2e_symm-46"><a href="#conv_4c2e_symm-46"><span class="linenos"> 46</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function</span>
</span><span id="conv_4c2e_symm-47"><a href="#conv_4c2e_symm-47"><span class="linenos"> 47</span></a><span class="sd">        - bfs_nao : Total number of atomic orbitals</span>
</span><span id="conv_4c2e_symm-48"><a href="#conv_4c2e_symm-48"><span class="linenos"> 48</span></a>
</span><span id="conv_4c2e_symm-49"><a href="#conv_4c2e_symm-49"><span class="linenos"> 49</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="conv_4c2e_symm-50"><a href="#conv_4c2e_symm-50"><span class="linenos"> 50</span></a><span class="sd">        An 8-element list specifying a sub-block of integrals to compute:</span>
</span><span id="conv_4c2e_symm-51"><a href="#conv_4c2e_symm-51"><span class="linenos"> 51</span></a><span class="sd">        [start_A, end_A, start_B, end_B, start_C, end_C, start_D, end_D]</span>
</span><span id="conv_4c2e_symm-52"><a href="#conv_4c2e_symm-52"><span class="linenos"> 52</span></a><span class="sd">        If None (default), computes the full (Nbf, Nbf, Nbf, Nbf) tensor.</span>
</span><span id="conv_4c2e_symm-53"><a href="#conv_4c2e_symm-53"><span class="linenos"> 53</span></a>
</span><span id="conv_4c2e_symm-54"><a href="#conv_4c2e_symm-54"><span class="linenos"> 54</span></a><span class="sd">        **Note:** When slices are used, symmetry exploitation is restricted</span>
</span><span id="conv_4c2e_symm-55"><a href="#conv_4c2e_symm-55"><span class="linenos"> 55</span></a><span class="sd">        to permutations that lie entirely within the specified slice.</span>
</span><span id="conv_4c2e_symm-56"><a href="#conv_4c2e_symm-56"><span class="linenos"> 56</span></a>
</span><span id="conv_4c2e_symm-57"><a href="#conv_4c2e_symm-57"><span class="linenos"> 57</span></a><span class="sd">    Returns</span>
</span><span id="conv_4c2e_symm-58"><a href="#conv_4c2e_symm-58"><span class="linenos"> 58</span></a><span class="sd">    -------</span>
</span><span id="conv_4c2e_symm-59"><a href="#conv_4c2e_symm-59"><span class="linenos"> 59</span></a><span class="sd">    ints4c2e : ndarray</span>
</span><span id="conv_4c2e_symm-60"><a href="#conv_4c2e_symm-60"><span class="linenos"> 60</span></a><span class="sd">        The computed 4-center 2-electron integrals for the requested range.</span>
</span><span id="conv_4c2e_symm-61"><a href="#conv_4c2e_symm-61"><span class="linenos"> 61</span></a>
</span><span id="conv_4c2e_symm-62"><a href="#conv_4c2e_symm-62"><span class="linenos"> 62</span></a><span class="sd">    Notes</span>
</span><span id="conv_4c2e_symm-63"><a href="#conv_4c2e_symm-63"><span class="linenos"> 63</span></a><span class="sd">    -----</span>
</span><span id="conv_4c2e_symm-64"><a href="#conv_4c2e_symm-64"><span class="linenos"> 64</span></a><span class="sd">    - All basis set data are pre-packed into NumPy arrays for Numba acceleration.</span>
</span><span id="conv_4c2e_symm-65"><a href="#conv_4c2e_symm-65"><span class="linenos"> 65</span></a><span class="sd">    - Uses explicit primitive Gaussian formula evaluation without numerical quadrature.</span>
</span><span id="conv_4c2e_symm-66"><a href="#conv_4c2e_symm-66"><span class="linenos"> 66</span></a><span class="sd">    - Symmetry exploitation is maximal only for full-range computations.</span>
</span><span id="conv_4c2e_symm-67"><a href="#conv_4c2e_symm-67"><span class="linenos"> 67</span></a><span class="sd">    - Conventional evaluation scales as O(N_bf^4) without symmetry, but</span>
</span><span id="conv_4c2e_symm-68"><a href="#conv_4c2e_symm-68"><span class="linenos"> 68</span></a><span class="sd">      symmetry reduces the number of computations drastically.</span>
</span><span id="conv_4c2e_symm-69"><a href="#conv_4c2e_symm-69"><span class="linenos"> 69</span></a>
</span><span id="conv_4c2e_symm-70"><a href="#conv_4c2e_symm-70"><span class="linenos"> 70</span></a><span class="sd">    Examples</span>
</span><span id="conv_4c2e_symm-71"><a href="#conv_4c2e_symm-71"><span class="linenos"> 71</span></a><span class="sd">    --------</span>
</span><span id="conv_4c2e_symm-72"><a href="#conv_4c2e_symm-72"><span class="linenos"> 72</span></a><span class="sd">    &gt;&gt;&gt; eri_full = conv_4c2e_symm(basis)</span>
</span><span id="conv_4c2e_symm-73"><a href="#conv_4c2e_symm-73"><span class="linenos"> 73</span></a><span class="sd">    &gt;&gt;&gt; eri_block = conv_4c2e_symm(basis, slice=[0,5, 0,5, 0,5, 0,5])</span>
</span><span id="conv_4c2e_symm-74"><a href="#conv_4c2e_symm-74"><span class="linenos"> 74</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="conv_4c2e_symm-75"><a href="#conv_4c2e_symm-75"><span class="linenos"> 75</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="conv_4c2e_symm-76"><a href="#conv_4c2e_symm-76"><span class="linenos"> 76</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="conv_4c2e_symm-77"><a href="#conv_4c2e_symm-77"><span class="linenos"> 77</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 4c2e integrals efficiently.</span>
</span><span id="conv_4c2e_symm-78"><a href="#conv_4c2e_symm-78"><span class="linenos"> 78</span></a>    <span class="c1"># This function calculates the 4c2e electron-electron ERIs for a given basis object.</span>
</span><span id="conv_4c2e_symm-79"><a href="#conv_4c2e_symm-79"><span class="linenos"> 79</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="conv_4c2e_symm-80"><a href="#conv_4c2e_symm-80"><span class="linenos"> 80</span></a>    
</span><span id="conv_4c2e_symm-81"><a href="#conv_4c2e_symm-81"><span class="linenos"> 81</span></a>    <span class="c1"># The integrals are performed using the formulas https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255</span>
</span><span id="conv_4c2e_symm-82"><a href="#conv_4c2e_symm-82"><span class="linenos"> 82</span></a>
</span><span id="conv_4c2e_symm-83"><a href="#conv_4c2e_symm-83"><span class="linenos"> 83</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="conv_4c2e_symm-84"><a href="#conv_4c2e_symm-84"><span class="linenos"> 84</span></a>    <span class="c1"># slice is an 8 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="conv_4c2e_symm-85"><a href="#conv_4c2e_symm-85"><span class="linenos"> 85</span></a>    <span class="c1"># and so on.</span>
</span><span id="conv_4c2e_symm-86"><a href="#conv_4c2e_symm-86"><span class="linenos"> 86</span></a>
</span><span id="conv_4c2e_symm-87"><a href="#conv_4c2e_symm-87"><span class="linenos"> 87</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="conv_4c2e_symm-88"><a href="#conv_4c2e_symm-88"><span class="linenos"> 88</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-89"><a href="#conv_4c2e_symm-89"><span class="linenos"> 89</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-90"><a href="#conv_4c2e_symm-90"><span class="linenos"> 90</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-91"><a href="#conv_4c2e_symm-91"><span class="linenos"> 91</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-92"><a href="#conv_4c2e_symm-92"><span class="linenos"> 92</span></a>        
</span><span id="conv_4c2e_symm-93"><a href="#conv_4c2e_symm-93"><span class="linenos"> 93</span></a>
</span><span id="conv_4c2e_symm-94"><a href="#conv_4c2e_symm-94"><span class="linenos"> 94</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="conv_4c2e_symm-95"><a href="#conv_4c2e_symm-95"><span class="linenos"> 95</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="conv_4c2e_symm-96"><a href="#conv_4c2e_symm-96"><span class="linenos"> 96</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="conv_4c2e_symm-97"><a href="#conv_4c2e_symm-97"><span class="linenos"> 97</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="conv_4c2e_symm-98"><a href="#conv_4c2e_symm-98"><span class="linenos"> 98</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="conv_4c2e_symm-99"><a href="#conv_4c2e_symm-99"><span class="linenos"> 99</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="conv_4c2e_symm-100"><a href="#conv_4c2e_symm-100"><span class="linenos">100</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-101"><a href="#conv_4c2e_symm-101"><span class="linenos">101</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-102"><a href="#conv_4c2e_symm-102"><span class="linenos">102</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-103"><a href="#conv_4c2e_symm-103"><span class="linenos">103</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="conv_4c2e_symm-104"><a href="#conv_4c2e_symm-104"><span class="linenos">104</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="conv_4c2e_symm-105"><a href="#conv_4c2e_symm-105"><span class="linenos">105</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_4c2e_symm-106"><a href="#conv_4c2e_symm-106"><span class="linenos">106</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_4c2e_symm-107"><a href="#conv_4c2e_symm-107"><span class="linenos">107</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_4c2e_symm-108"><a href="#conv_4c2e_symm-108"><span class="linenos">108</span></a>        
</span><span id="conv_4c2e_symm-109"><a href="#conv_4c2e_symm-109"><span class="linenos">109</span></a>
</span><span id="conv_4c2e_symm-110"><a href="#conv_4c2e_symm-110"><span class="linenos">110</span></a>
</span><span id="conv_4c2e_symm-111"><a href="#conv_4c2e_symm-111"><span class="linenos">111</span></a>    
</span><span id="conv_4c2e_symm-112"><a href="#conv_4c2e_symm-112"><span class="linenos">112</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="conv_4c2e_symm-113"><a href="#conv_4c2e_symm-113"><span class="linenos">113</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="conv_4c2e_symm-114"><a href="#conv_4c2e_symm-114"><span class="linenos">114</span></a>        
</span><span id="conv_4c2e_symm-115"><a href="#conv_4c2e_symm-115"><span class="linenos">115</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="conv_4c2e_symm-116"><a href="#conv_4c2e_symm-116"><span class="linenos">116</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-117"><a href="#conv_4c2e_symm-117"><span class="linenos">117</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-118"><a href="#conv_4c2e_symm-118"><span class="linenos">118</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-119"><a href="#conv_4c2e_symm-119"><span class="linenos">119</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-120"><a href="#conv_4c2e_symm-120"><span class="linenos">120</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-121"><a href="#conv_4c2e_symm-121"><span class="linenos">121</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-122"><a href="#conv_4c2e_symm-122"><span class="linenos">122</span></a>    <span class="n">indx_startD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-123"><a href="#conv_4c2e_symm-123"><span class="linenos">123</span></a>    <span class="n">indx_endD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
</span><span id="conv_4c2e_symm-124"><a href="#conv_4c2e_symm-124"><span class="linenos">124</span></a>
</span><span id="conv_4c2e_symm-125"><a href="#conv_4c2e_symm-125"><span class="linenos">125</span></a>    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">conv_4c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span>\
</span><span id="conv_4c2e_symm-126"><a href="#conv_4c2e_symm-126"><span class="linenos">126</span></a>        <span class="n">indx_startA</span><span class="p">,</span><span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">indx_startD</span><span class="p">,</span><span class="n">indx_endD</span><span class="p">)</span>
</span><span id="conv_4c2e_symm-127"><a href="#conv_4c2e_symm-127"><span class="linenos">127</span></a>
</span><span id="conv_4c2e_symm-128"><a href="#conv_4c2e_symm-128"><span class="linenos">128</span></a>    <span class="k">return</span> <span class="n">ints4c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute four-center two-electron (4c2e) electron repulsion integrals (ERIs)
using the conventional and slow (analytical) formula-based method with full symmetry exploitation.</p>

<p>This function evaluates integrals of the form (A B | C D), where
A, B, C, D are basis functions from the same primary basis set.</p>

<p>The "conv" variant uses explicit analytical integral formulas and
nested loops over primitive Gaussians, following the derivations in:</p>

<pre><code>J. Chem. Educ. 2018, 95, 9, 1572–1578
https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255
</code></pre>

<p>Compared to Rys quadrature, this conventional approach is much more
computationally expensive but exact for the given formula set, making
it useful for validation and special-purpose computations.</p>

<h2 id="symmetries-exploited">Symmetries exploited</h2>

<p>For 4c2e integrals, the full 8-fold permutational symmetry is used:</p>

<pre><code>(A B | C D) = (B A | C D) = (A B | D C) = (B A | D C)
            = (C D | A B) = (D C | A B) = (C D | B A) = (D C | B A)
</code></pre>

<p>This reduces the number of independent integrals from:
    N_bf^4   →   N_bf<em>(N_bf+1)/2 * N_bf</em>(N_bf+1)/2
when computing the full tensor.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Basis set object containing:
    - bfs_coords : Cartesian coordinates of basis function centers
    - bfs_coeffs : Contraction coefficients
    - bfs_expnts : Gaussian exponents
    - bfs_prim_norms : Primitive normalization constants
    - bfs_contr_prim_norms : Contraction normalization factors
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)
    - bfs_nprim : Number of primitives per basis function
    - bfs_nao : Total number of atomic orbitals</p>

<p>slice : list of int, optional
    An 8-element list specifying a sub-block of integrals to compute:
    [start_A, end_A, start_B, end_B, start_C, end_C, start_D, end_D]
    If None (default), computes the full (Nbf, Nbf, Nbf, Nbf) tensor.</p>

<pre><code>**Note:** When slices are used, symmetry exploitation is restricted
to permutations that lie entirely within the specified slice.
</code></pre>

<h2 id="returns">Returns</h2>

<p>ints4c2e : ndarray
    The computed 4-center 2-electron integrals for the requested range.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>All basis set data are pre-packed into NumPy arrays for Numba acceleration.</li>
<li>Uses explicit primitive Gaussian formula evaluation without numerical quadrature.</li>
<li>Symmetry exploitation is maximal only for full-range computations.</li>
<li>Conventional evaluation scales as O(N_bf^4) without symmetry, but
symmetry reduces the number of computations drastically.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">eri_full</span> <span class="o">=</span> <span class="n">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eri_block</span> <span class="o">=</span> <span class="n">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="mmd_4c2e_symm">
                            <input id="mmd_4c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mmd_4c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="mmd_4c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#mmd_4c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="mmd_4c2e_symm-7"><a href="#mmd_4c2e_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">mmd_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="mmd_4c2e_symm-8"><a href="#mmd_4c2e_symm-8"><span class="linenos"> 8</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="mmd_4c2e_symm-9"><a href="#mmd_4c2e_symm-9"><span class="linenos"> 9</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="mmd_4c2e_symm-10"><a href="#mmd_4c2e_symm-10"><span class="linenos">10</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 4c2e integrals efficiently.</span>
</span><span id="mmd_4c2e_symm-11"><a href="#mmd_4c2e_symm-11"><span class="linenos">11</span></a>    <span class="c1"># This function calculates the 4c2e electron-electron ERIs for a given basis object.</span>
</span><span id="mmd_4c2e_symm-12"><a href="#mmd_4c2e_symm-12"><span class="linenos">12</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="mmd_4c2e_symm-13"><a href="#mmd_4c2e_symm-13"><span class="linenos">13</span></a>    
</span><span id="mmd_4c2e_symm-14"><a href="#mmd_4c2e_symm-14"><span class="linenos">14</span></a>    <span class="c1"># The integrals are performed using the formulas https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255</span>
</span><span id="mmd_4c2e_symm-15"><a href="#mmd_4c2e_symm-15"><span class="linenos">15</span></a>
</span><span id="mmd_4c2e_symm-16"><a href="#mmd_4c2e_symm-16"><span class="linenos">16</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="mmd_4c2e_symm-17"><a href="#mmd_4c2e_symm-17"><span class="linenos">17</span></a>    <span class="c1"># slice is an 8 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="mmd_4c2e_symm-18"><a href="#mmd_4c2e_symm-18"><span class="linenos">18</span></a>    <span class="c1"># and so on.</span>
</span><span id="mmd_4c2e_symm-19"><a href="#mmd_4c2e_symm-19"><span class="linenos">19</span></a>
</span><span id="mmd_4c2e_symm-20"><a href="#mmd_4c2e_symm-20"><span class="linenos">20</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="mmd_4c2e_symm-21"><a href="#mmd_4c2e_symm-21"><span class="linenos">21</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-22"><a href="#mmd_4c2e_symm-22"><span class="linenos">22</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-23"><a href="#mmd_4c2e_symm-23"><span class="linenos">23</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-24"><a href="#mmd_4c2e_symm-24"><span class="linenos">24</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-25"><a href="#mmd_4c2e_symm-25"><span class="linenos">25</span></a>        
</span><span id="mmd_4c2e_symm-26"><a href="#mmd_4c2e_symm-26"><span class="linenos">26</span></a>
</span><span id="mmd_4c2e_symm-27"><a href="#mmd_4c2e_symm-27"><span class="linenos">27</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="mmd_4c2e_symm-28"><a href="#mmd_4c2e_symm-28"><span class="linenos">28</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="mmd_4c2e_symm-29"><a href="#mmd_4c2e_symm-29"><span class="linenos">29</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="mmd_4c2e_symm-30"><a href="#mmd_4c2e_symm-30"><span class="linenos">30</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="mmd_4c2e_symm-31"><a href="#mmd_4c2e_symm-31"><span class="linenos">31</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="mmd_4c2e_symm-32"><a href="#mmd_4c2e_symm-32"><span class="linenos">32</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="mmd_4c2e_symm-33"><a href="#mmd_4c2e_symm-33"><span class="linenos">33</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-34"><a href="#mmd_4c2e_symm-34"><span class="linenos">34</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-35"><a href="#mmd_4c2e_symm-35"><span class="linenos">35</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-36"><a href="#mmd_4c2e_symm-36"><span class="linenos">36</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="mmd_4c2e_symm-37"><a href="#mmd_4c2e_symm-37"><span class="linenos">37</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="mmd_4c2e_symm-38"><a href="#mmd_4c2e_symm-38"><span class="linenos">38</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_4c2e_symm-39"><a href="#mmd_4c2e_symm-39"><span class="linenos">39</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_4c2e_symm-40"><a href="#mmd_4c2e_symm-40"><span class="linenos">40</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="mmd_4c2e_symm-41"><a href="#mmd_4c2e_symm-41"><span class="linenos">41</span></a>        
</span><span id="mmd_4c2e_symm-42"><a href="#mmd_4c2e_symm-42"><span class="linenos">42</span></a>
</span><span id="mmd_4c2e_symm-43"><a href="#mmd_4c2e_symm-43"><span class="linenos">43</span></a>
</span><span id="mmd_4c2e_symm-44"><a href="#mmd_4c2e_symm-44"><span class="linenos">44</span></a>    
</span><span id="mmd_4c2e_symm-45"><a href="#mmd_4c2e_symm-45"><span class="linenos">45</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="mmd_4c2e_symm-46"><a href="#mmd_4c2e_symm-46"><span class="linenos">46</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="mmd_4c2e_symm-47"><a href="#mmd_4c2e_symm-47"><span class="linenos">47</span></a>        
</span><span id="mmd_4c2e_symm-48"><a href="#mmd_4c2e_symm-48"><span class="linenos">48</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="mmd_4c2e_symm-49"><a href="#mmd_4c2e_symm-49"><span class="linenos">49</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-50"><a href="#mmd_4c2e_symm-50"><span class="linenos">50</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-51"><a href="#mmd_4c2e_symm-51"><span class="linenos">51</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-52"><a href="#mmd_4c2e_symm-52"><span class="linenos">52</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-53"><a href="#mmd_4c2e_symm-53"><span class="linenos">53</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-54"><a href="#mmd_4c2e_symm-54"><span class="linenos">54</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-55"><a href="#mmd_4c2e_symm-55"><span class="linenos">55</span></a>    <span class="n">indx_startD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-56"><a href="#mmd_4c2e_symm-56"><span class="linenos">56</span></a>    <span class="n">indx_endD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
</span><span id="mmd_4c2e_symm-57"><a href="#mmd_4c2e_symm-57"><span class="linenos">57</span></a>
</span><span id="mmd_4c2e_symm-58"><a href="#mmd_4c2e_symm-58"><span class="linenos">58</span></a>    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">mmd_4c2e_symm_internal2</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span>\
</span><span id="mmd_4c2e_symm-59"><a href="#mmd_4c2e_symm-59"><span class="linenos">59</span></a>        <span class="n">indx_startA</span><span class="p">,</span><span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">indx_startD</span><span class="p">,</span><span class="n">indx_endD</span><span class="p">)</span>
</span><span id="mmd_4c2e_symm-60"><a href="#mmd_4c2e_symm-60"><span class="linenos">60</span></a>
</span><span id="mmd_4c2e_symm-61"><a href="#mmd_4c2e_symm-61"><span class="linenos">61</span></a>    <span class="k">return</span> <span class="n">ints4c2e</span>
</span></pre></div>


    

                </section>
                <section id="rys_4c2e_symm">
                            <input id="rys_4c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_4c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_4c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_4c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_4c2e_symm-8"><a href="#rys_4c2e_symm-8"><span class="linenos">  8</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_4c2e_symm-9"><a href="#rys_4c2e_symm-9"><span class="linenos">  9</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="rys_4c2e_symm-10"><a href="#rys_4c2e_symm-10"><span class="linenos"> 10</span></a><span class="sd">    Compute four-center two-electron (4c2e) electron repulsion integrals (ERIs) </span>
</span><span id="rys_4c2e_symm-11"><a href="#rys_4c2e_symm-11"><span class="linenos"> 11</span></a><span class="sd">    using the Rys quadrature method with exploitation of 8-fold permutational </span>
</span><span id="rys_4c2e_symm-12"><a href="#rys_4c2e_symm-12"><span class="linenos"> 12</span></a><span class="sd">    symmetry.</span>
</span><span id="rys_4c2e_symm-13"><a href="#rys_4c2e_symm-13"><span class="linenos"> 13</span></a>
</span><span id="rys_4c2e_symm-14"><a href="#rys_4c2e_symm-14"><span class="linenos"> 14</span></a><span class="sd">    This function evaluates integrals of the form (A B | C D), where A, B, C, D </span>
</span><span id="rys_4c2e_symm-15"><a href="#rys_4c2e_symm-15"><span class="linenos"> 15</span></a><span class="sd">    are basis functions from the same primary basis set. It uses Numba-accelerated </span>
</span><span id="rys_4c2e_symm-16"><a href="#rys_4c2e_symm-16"><span class="linenos"> 16</span></a><span class="sd">    backends and symmetry-aware optimizations to reduce computational cost.</span>
</span><span id="rys_4c2e_symm-17"><a href="#rys_4c2e_symm-17"><span class="linenos"> 17</span></a>
</span><span id="rys_4c2e_symm-18"><a href="#rys_4c2e_symm-18"><span class="linenos"> 18</span></a><span class="sd">    Symmetries exploited</span>
</span><span id="rys_4c2e_symm-19"><a href="#rys_4c2e_symm-19"><span class="linenos"> 19</span></a><span class="sd">    --------------------</span>
</span><span id="rys_4c2e_symm-20"><a href="#rys_4c2e_symm-20"><span class="linenos"> 20</span></a><span class="sd">    The 4c2e integrals obey the following permutational symmetry relations:</span>
</span><span id="rys_4c2e_symm-21"><a href="#rys_4c2e_symm-21"><span class="linenos"> 21</span></a>
</span><span id="rys_4c2e_symm-22"><a href="#rys_4c2e_symm-22"><span class="linenos"> 22</span></a><span class="sd">        (A B | C D) = (B A | C D)   # exchange within bra</span>
</span><span id="rys_4c2e_symm-23"><a href="#rys_4c2e_symm-23"><span class="linenos"> 23</span></a><span class="sd">                    = (A B | D C)  # exchange within ket</span>
</span><span id="rys_4c2e_symm-24"><a href="#rys_4c2e_symm-24"><span class="linenos"> 24</span></a><span class="sd">                    = (B A | D C)  </span>
</span><span id="rys_4c2e_symm-25"><a href="#rys_4c2e_symm-25"><span class="linenos"> 25</span></a><span class="sd">                    = (C D | A B)  # bra ↔ ket exchange</span>
</span><span id="rys_4c2e_symm-26"><a href="#rys_4c2e_symm-26"><span class="linenos"> 26</span></a><span class="sd">                    = (D C | A B)</span>
</span><span id="rys_4c2e_symm-27"><a href="#rys_4c2e_symm-27"><span class="linenos"> 27</span></a><span class="sd">                    = (C D | B A)</span>
</span><span id="rys_4c2e_symm-28"><a href="#rys_4c2e_symm-28"><span class="linenos"> 28</span></a><span class="sd">                    = (D C | B A)</span>
</span><span id="rys_4c2e_symm-29"><a href="#rys_4c2e_symm-29"><span class="linenos"> 29</span></a>
</span><span id="rys_4c2e_symm-30"><a href="#rys_4c2e_symm-30"><span class="linenos"> 30</span></a><span class="sd">    These 8 equivalent permutations mean that only a subset of integrals </span>
</span><span id="rys_4c2e_symm-31"><a href="#rys_4c2e_symm-31"><span class="linenos"> 31</span></a><span class="sd">    needs to be explicitly computed; the rest can be obtained by symmetry.</span>
</span><span id="rys_4c2e_symm-32"><a href="#rys_4c2e_symm-32"><span class="linenos"> 32</span></a><span class="sd">    </span>
</span><span id="rys_4c2e_symm-33"><a href="#rys_4c2e_symm-33"><span class="linenos"> 33</span></a><span class="sd">    This reduces the number of independent integrals from:</span>
</span><span id="rys_4c2e_symm-34"><a href="#rys_4c2e_symm-34"><span class="linenos"> 34</span></a><span class="sd">        N_bf^4   →   N_bf*(N_bf+1)/2 * N_bf*(N_bf+1)/2</span>
</span><span id="rys_4c2e_symm-35"><a href="#rys_4c2e_symm-35"><span class="linenos"> 35</span></a><span class="sd">    when computing the full tensor.</span>
</span><span id="rys_4c2e_symm-36"><a href="#rys_4c2e_symm-36"><span class="linenos"> 36</span></a>
</span><span id="rys_4c2e_symm-37"><a href="#rys_4c2e_symm-37"><span class="linenos"> 37</span></a><span class="sd">    Parameters</span>
</span><span id="rys_4c2e_symm-38"><a href="#rys_4c2e_symm-38"><span class="linenos"> 38</span></a><span class="sd">    ----------</span>
</span><span id="rys_4c2e_symm-39"><a href="#rys_4c2e_symm-39"><span class="linenos"> 39</span></a><span class="sd">    basis : object</span>
</span><span id="rys_4c2e_symm-40"><a href="#rys_4c2e_symm-40"><span class="linenos"> 40</span></a><span class="sd">        Primary basis set object containing:</span>
</span><span id="rys_4c2e_symm-41"><a href="#rys_4c2e_symm-41"><span class="linenos"> 41</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of basis function centers.</span>
</span><span id="rys_4c2e_symm-42"><a href="#rys_4c2e_symm-42"><span class="linenos"> 42</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients.</span>
</span><span id="rys_4c2e_symm-43"><a href="#rys_4c2e_symm-43"><span class="linenos"> 43</span></a><span class="sd">        - bfs_expnts : Gaussian exponents.</span>
</span><span id="rys_4c2e_symm-44"><a href="#rys_4c2e_symm-44"><span class="linenos"> 44</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants.</span>
</span><span id="rys_4c2e_symm-45"><a href="#rys_4c2e_symm-45"><span class="linenos"> 45</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors.</span>
</span><span id="rys_4c2e_symm-46"><a href="#rys_4c2e_symm-46"><span class="linenos"> 46</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="rys_4c2e_symm-47"><a href="#rys_4c2e_symm-47"><span class="linenos"> 47</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function.</span>
</span><span id="rys_4c2e_symm-48"><a href="#rys_4c2e_symm-48"><span class="linenos"> 48</span></a><span class="sd">        - bfs_shell_index : Index of the shell each basis function belongs to.</span>
</span><span id="rys_4c2e_symm-49"><a href="#rys_4c2e_symm-49"><span class="linenos"> 49</span></a><span class="sd">        - bfs_nao : Total number of atomic orbitals.</span>
</span><span id="rys_4c2e_symm-50"><a href="#rys_4c2e_symm-50"><span class="linenos"> 50</span></a>
</span><span id="rys_4c2e_symm-51"><a href="#rys_4c2e_symm-51"><span class="linenos"> 51</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="rys_4c2e_symm-52"><a href="#rys_4c2e_symm-52"><span class="linenos"> 52</span></a><span class="sd">        An 8-element list specifying a sub-block of integrals to compute:</span>
</span><span id="rys_4c2e_symm-53"><a href="#rys_4c2e_symm-53"><span class="linenos"> 53</span></a><span class="sd">        [start_A, end_A, start_B, end_B, start_C, end_C, start_D, end_D]</span>
</span><span id="rys_4c2e_symm-54"><a href="#rys_4c2e_symm-54"><span class="linenos"> 54</span></a><span class="sd">        If None (default), computes the full (Nbf, Nbf, Nbf, Nbf) block.</span>
</span><span id="rys_4c2e_symm-55"><a href="#rys_4c2e_symm-55"><span class="linenos"> 55</span></a>
</span><span id="rys_4c2e_symm-56"><a href="#rys_4c2e_symm-56"><span class="linenos"> 56</span></a><span class="sd">        **Note:** When slices are used, not all 8-fold symmetries may be </span>
</span><span id="rys_4c2e_symm-57"><a href="#rys_4c2e_symm-57"><span class="linenos"> 57</span></a><span class="sd">        available because the requested block may not contain all </span>
</span><span id="rys_4c2e_symm-58"><a href="#rys_4c2e_symm-58"><span class="linenos"> 58</span></a><span class="sd">        symmetric permutations. In such cases, only the applicable </span>
</span><span id="rys_4c2e_symm-59"><a href="#rys_4c2e_symm-59"><span class="linenos"> 59</span></a><span class="sd">        symmetries are used.</span>
</span><span id="rys_4c2e_symm-60"><a href="#rys_4c2e_symm-60"><span class="linenos"> 60</span></a>
</span><span id="rys_4c2e_symm-61"><a href="#rys_4c2e_symm-61"><span class="linenos"> 61</span></a><span class="sd">    Returns</span>
</span><span id="rys_4c2e_symm-62"><a href="#rys_4c2e_symm-62"><span class="linenos"> 62</span></a><span class="sd">    -------</span>
</span><span id="rys_4c2e_symm-63"><a href="#rys_4c2e_symm-63"><span class="linenos"> 63</span></a><span class="sd">    ints4c2e : ndarray</span>
</span><span id="rys_4c2e_symm-64"><a href="#rys_4c2e_symm-64"><span class="linenos"> 64</span></a><span class="sd">        The computed 4-center 2-electron integrals for the requested range.</span>
</span><span id="rys_4c2e_symm-65"><a href="#rys_4c2e_symm-65"><span class="linenos"> 65</span></a>
</span><span id="rys_4c2e_symm-66"><a href="#rys_4c2e_symm-66"><span class="linenos"> 66</span></a><span class="sd">    Notes</span>
</span><span id="rys_4c2e_symm-67"><a href="#rys_4c2e_symm-67"><span class="linenos"> 67</span></a><span class="sd">    -----</span>
</span><span id="rys_4c2e_symm-68"><a href="#rys_4c2e_symm-68"><span class="linenos"> 68</span></a><span class="sd">    - Precomputes and stores basis set data in NumPy arrays for Numba efficiency.</span>
</span><span id="rys_4c2e_symm-69"><a href="#rys_4c2e_symm-69"><span class="linenos"> 69</span></a><span class="sd">    - Exploits all possible symmetry permutations when the full tensor is </span>
</span><span id="rys_4c2e_symm-70"><a href="#rys_4c2e_symm-70"><span class="linenos"> 70</span></a><span class="sd">      computed (no slice) to reduce redundant work.</span>
</span><span id="rys_4c2e_symm-71"><a href="#rys_4c2e_symm-71"><span class="linenos"> 71</span></a><span class="sd">    - If a slice is specified, symmetry exploitation is limited to the </span>
</span><span id="rys_4c2e_symm-72"><a href="#rys_4c2e_symm-72"><span class="linenos"> 72</span></a><span class="sd">      permutations that fall within the slice&#39;s index ranges.</span>
</span><span id="rys_4c2e_symm-73"><a href="#rys_4c2e_symm-73"><span class="linenos"> 73</span></a>
</span><span id="rys_4c2e_symm-74"><a href="#rys_4c2e_symm-74"><span class="linenos"> 74</span></a><span class="sd">    Examples</span>
</span><span id="rys_4c2e_symm-75"><a href="#rys_4c2e_symm-75"><span class="linenos"> 75</span></a><span class="sd">    --------</span>
</span><span id="rys_4c2e_symm-76"><a href="#rys_4c2e_symm-76"><span class="linenos"> 76</span></a><span class="sd">    &gt;&gt;&gt; eri_full = rys_4c2e_symm(basis)</span>
</span><span id="rys_4c2e_symm-77"><a href="#rys_4c2e_symm-77"><span class="linenos"> 77</span></a><span class="sd">    &gt;&gt;&gt; eri_block = rys_4c2e_symm(basis, slice=[0,5, 0,5, 0,5, 0,5])</span>
</span><span id="rys_4c2e_symm-78"><a href="#rys_4c2e_symm-78"><span class="linenos"> 78</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="rys_4c2e_symm-79"><a href="#rys_4c2e_symm-79"><span class="linenos"> 79</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_4c2e_symm-80"><a href="#rys_4c2e_symm-80"><span class="linenos"> 80</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_4c2e_symm-81"><a href="#rys_4c2e_symm-81"><span class="linenos"> 81</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 4c2e integrals efficiently.</span>
</span><span id="rys_4c2e_symm-82"><a href="#rys_4c2e_symm-82"><span class="linenos"> 82</span></a>    <span class="c1"># This function calculates the 4c2e electron-electron ERIs for a given basis object.</span>
</span><span id="rys_4c2e_symm-83"><a href="#rys_4c2e_symm-83"><span class="linenos"> 83</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_4c2e_symm-84"><a href="#rys_4c2e_symm-84"><span class="linenos"> 84</span></a>
</span><span id="rys_4c2e_symm-85"><a href="#rys_4c2e_symm-85"><span class="linenos"> 85</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="rys_4c2e_symm-86"><a href="#rys_4c2e_symm-86"><span class="linenos"> 86</span></a>    <span class="c1"># slice is an 8 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="rys_4c2e_symm-87"><a href="#rys_4c2e_symm-87"><span class="linenos"> 87</span></a>    <span class="c1"># and so on.</span>
</span><span id="rys_4c2e_symm-88"><a href="#rys_4c2e_symm-88"><span class="linenos"> 88</span></a>
</span><span id="rys_4c2e_symm-89"><a href="#rys_4c2e_symm-89"><span class="linenos"> 89</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_4c2e_symm-90"><a href="#rys_4c2e_symm-90"><span class="linenos"> 90</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-91"><a href="#rys_4c2e_symm-91"><span class="linenos"> 91</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-92"><a href="#rys_4c2e_symm-92"><span class="linenos"> 92</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-93"><a href="#rys_4c2e_symm-93"><span class="linenos"> 93</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-94"><a href="#rys_4c2e_symm-94"><span class="linenos"> 94</span></a>        
</span><span id="rys_4c2e_symm-95"><a href="#rys_4c2e_symm-95"><span class="linenos"> 95</span></a>
</span><span id="rys_4c2e_symm-96"><a href="#rys_4c2e_symm-96"><span class="linenos"> 96</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_4c2e_symm-97"><a href="#rys_4c2e_symm-97"><span class="linenos"> 97</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_4c2e_symm-98"><a href="#rys_4c2e_symm-98"><span class="linenos"> 98</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_4c2e_symm-99"><a href="#rys_4c2e_symm-99"><span class="linenos"> 99</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_4c2e_symm-100"><a href="#rys_4c2e_symm-100"><span class="linenos">100</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_4c2e_symm-101"><a href="#rys_4c2e_symm-101"><span class="linenos">101</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_4c2e_symm-102"><a href="#rys_4c2e_symm-102"><span class="linenos">102</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-103"><a href="#rys_4c2e_symm-103"><span class="linenos">103</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-104"><a href="#rys_4c2e_symm-104"><span class="linenos">104</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-105"><a href="#rys_4c2e_symm-105"><span class="linenos">105</span></a>    <span class="n">shell_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_shell_index</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="rys_4c2e_symm-106"><a href="#rys_4c2e_symm-106"><span class="linenos">106</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_4c2e_symm-107"><a href="#rys_4c2e_symm-107"><span class="linenos">107</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_4c2e_symm-108"><a href="#rys_4c2e_symm-108"><span class="linenos">108</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm-109"><a href="#rys_4c2e_symm-109"><span class="linenos">109</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm-110"><a href="#rys_4c2e_symm-110"><span class="linenos">110</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm-111"><a href="#rys_4c2e_symm-111"><span class="linenos">111</span></a>        
</span><span id="rys_4c2e_symm-112"><a href="#rys_4c2e_symm-112"><span class="linenos">112</span></a>
</span><span id="rys_4c2e_symm-113"><a href="#rys_4c2e_symm-113"><span class="linenos">113</span></a>
</span><span id="rys_4c2e_symm-114"><a href="#rys_4c2e_symm-114"><span class="linenos">114</span></a>    
</span><span id="rys_4c2e_symm-115"><a href="#rys_4c2e_symm-115"><span class="linenos">115</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_4c2e_symm-116"><a href="#rys_4c2e_symm-116"><span class="linenos">116</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_4c2e_symm-117"><a href="#rys_4c2e_symm-117"><span class="linenos">117</span></a>        
</span><span id="rys_4c2e_symm-118"><a href="#rys_4c2e_symm-118"><span class="linenos">118</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_4c2e_symm-119"><a href="#rys_4c2e_symm-119"><span class="linenos">119</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-120"><a href="#rys_4c2e_symm-120"><span class="linenos">120</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-121"><a href="#rys_4c2e_symm-121"><span class="linenos">121</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-122"><a href="#rys_4c2e_symm-122"><span class="linenos">122</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-123"><a href="#rys_4c2e_symm-123"><span class="linenos">123</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-124"><a href="#rys_4c2e_symm-124"><span class="linenos">124</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-125"><a href="#rys_4c2e_symm-125"><span class="linenos">125</span></a>    <span class="n">indx_startD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-126"><a href="#rys_4c2e_symm-126"><span class="linenos">126</span></a>    <span class="n">indx_endD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
</span><span id="rys_4c2e_symm-127"><a href="#rys_4c2e_symm-127"><span class="linenos">127</span></a>
</span><span id="rys_4c2e_symm-128"><a href="#rys_4c2e_symm-128"><span class="linenos">128</span></a>
</span><span id="rys_4c2e_symm-129"><a href="#rys_4c2e_symm-129"><span class="linenos">129</span></a>    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">rys_4c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">shell_indices</span><span class="p">,</span>\
</span><span id="rys_4c2e_symm-130"><a href="#rys_4c2e_symm-130"><span class="linenos">130</span></a>        <span class="n">indx_startA</span><span class="p">,</span><span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">indx_startD</span><span class="p">,</span><span class="n">indx_endD</span><span class="p">)</span>
</span><span id="rys_4c2e_symm-131"><a href="#rys_4c2e_symm-131"><span class="linenos">131</span></a>
</span><span id="rys_4c2e_symm-132"><a href="#rys_4c2e_symm-132"><span class="linenos">132</span></a>    <span class="k">return</span> <span class="n">ints4c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute four-center two-electron (4c2e) electron repulsion integrals (ERIs) 
using the Rys quadrature method with exploitation of 8-fold permutational 
symmetry.</p>

<p>This function evaluates integrals of the form (A B | C D), where A, B, C, D 
are basis functions from the same primary basis set. It uses Numba-accelerated 
backends and symmetry-aware optimizations to reduce computational cost.</p>

<h2 id="symmetries-exploited">Symmetries exploited</h2>

<p>The 4c2e integrals obey the following permutational symmetry relations:</p>

<pre><code>(A B | C D) = (B A | C D)   # exchange within bra
            = (A B | D C)  # exchange within ket
            = (B A | D C)  
            = (C D | A B)  # bra ↔ ket exchange
            = (D C | A B)
            = (C D | B A)
            = (D C | B A)
</code></pre>

<p>These 8 equivalent permutations mean that only a subset of integrals 
needs to be explicitly computed; the rest can be obtained by symmetry.</p>

<p>This reduces the number of independent integrals from:
    N_bf^4   →   N_bf<em>(N_bf+1)/2 * N_bf</em>(N_bf+1)/2
when computing the full tensor.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Primary basis set object containing:
    - bfs_coords : Cartesian coordinates of basis function centers.
    - bfs_coeffs : Contraction coefficients.
    - bfs_expnts : Gaussian exponents.
    - bfs_prim_norms : Primitive normalization constants.
    - bfs_contr_prim_norms : Contraction normalization factors.
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim : Number of primitives per basis function.
    - bfs_shell_index : Index of the shell each basis function belongs to.
    - bfs_nao : Total number of atomic orbitals.</p>

<p>slice : list of int, optional
    An 8-element list specifying a sub-block of integrals to compute:
    [start_A, end_A, start_B, end_B, start_C, end_C, start_D, end_D]
    If None (default), computes the full (Nbf, Nbf, Nbf, Nbf) block.</p>

<pre><code>**Note:** When slices are used, not all 8-fold symmetries may be 
available because the requested block may not contain all 
symmetric permutations. In such cases, only the applicable 
symmetries are used.
</code></pre>

<h2 id="returns">Returns</h2>

<p>ints4c2e : ndarray
    The computed 4-center 2-electron integrals for the requested range.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Precomputes and stores basis set data in NumPy arrays for Numba efficiency.</li>
<li>Exploits all possible symmetry permutations when the full tensor is 
computed (no slice) to reduce redundant work.</li>
<li>If a slice is specified, symmetry exploitation is limited to the 
permutations that fall within the slice's index ranges.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">eri_full</span> <span class="o">=</span> <span class="n">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eri_block</span> <span class="o">=</span> <span class="n">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="rys_4c2e_symm_old">
                            <input id="rys_4c2e_symm_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_4c2e_symm_old</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_4c2e_symm_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_4c2e_symm_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_4c2e_symm_old-416"><a href="#rys_4c2e_symm_old-416"><span class="linenos">416</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_4c2e_symm_old</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_4c2e_symm_old-417"><a href="#rys_4c2e_symm_old-417"><span class="linenos">417</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_4c2e_symm_old-418"><a href="#rys_4c2e_symm_old-418"><span class="linenos">418</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_4c2e_symm_old-419"><a href="#rys_4c2e_symm_old-419"><span class="linenos">419</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 4c2e integrals efficiently.</span>
</span><span id="rys_4c2e_symm_old-420"><a href="#rys_4c2e_symm_old-420"><span class="linenos">420</span></a>    <span class="c1"># This function calculates the 4c2e electron-electron ERIs for a given basis object.</span>
</span><span id="rys_4c2e_symm_old-421"><a href="#rys_4c2e_symm_old-421"><span class="linenos">421</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_4c2e_symm_old-422"><a href="#rys_4c2e_symm_old-422"><span class="linenos">422</span></a>
</span><span id="rys_4c2e_symm_old-423"><a href="#rys_4c2e_symm_old-423"><span class="linenos">423</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="rys_4c2e_symm_old-424"><a href="#rys_4c2e_symm_old-424"><span class="linenos">424</span></a>    <span class="c1"># slice is an 8 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="rys_4c2e_symm_old-425"><a href="#rys_4c2e_symm_old-425"><span class="linenos">425</span></a>    <span class="c1"># and so on.</span>
</span><span id="rys_4c2e_symm_old-426"><a href="#rys_4c2e_symm_old-426"><span class="linenos">426</span></a>
</span><span id="rys_4c2e_symm_old-427"><a href="#rys_4c2e_symm_old-427"><span class="linenos">427</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_4c2e_symm_old-428"><a href="#rys_4c2e_symm_old-428"><span class="linenos">428</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-429"><a href="#rys_4c2e_symm_old-429"><span class="linenos">429</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-430"><a href="#rys_4c2e_symm_old-430"><span class="linenos">430</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-431"><a href="#rys_4c2e_symm_old-431"><span class="linenos">431</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-432"><a href="#rys_4c2e_symm_old-432"><span class="linenos">432</span></a>        
</span><span id="rys_4c2e_symm_old-433"><a href="#rys_4c2e_symm_old-433"><span class="linenos">433</span></a>
</span><span id="rys_4c2e_symm_old-434"><a href="#rys_4c2e_symm_old-434"><span class="linenos">434</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_4c2e_symm_old-435"><a href="#rys_4c2e_symm_old-435"><span class="linenos">435</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_4c2e_symm_old-436"><a href="#rys_4c2e_symm_old-436"><span class="linenos">436</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_4c2e_symm_old-437"><a href="#rys_4c2e_symm_old-437"><span class="linenos">437</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_4c2e_symm_old-438"><a href="#rys_4c2e_symm_old-438"><span class="linenos">438</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_4c2e_symm_old-439"><a href="#rys_4c2e_symm_old-439"><span class="linenos">439</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_4c2e_symm_old-440"><a href="#rys_4c2e_symm_old-440"><span class="linenos">440</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-441"><a href="#rys_4c2e_symm_old-441"><span class="linenos">441</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-442"><a href="#rys_4c2e_symm_old-442"><span class="linenos">442</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-443"><a href="#rys_4c2e_symm_old-443"><span class="linenos">443</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_4c2e_symm_old-444"><a href="#rys_4c2e_symm_old-444"><span class="linenos">444</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_4c2e_symm_old-445"><a href="#rys_4c2e_symm_old-445"><span class="linenos">445</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm_old-446"><a href="#rys_4c2e_symm_old-446"><span class="linenos">446</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm_old-447"><a href="#rys_4c2e_symm_old-447"><span class="linenos">447</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_4c2e_symm_old-448"><a href="#rys_4c2e_symm_old-448"><span class="linenos">448</span></a>        
</span><span id="rys_4c2e_symm_old-449"><a href="#rys_4c2e_symm_old-449"><span class="linenos">449</span></a>
</span><span id="rys_4c2e_symm_old-450"><a href="#rys_4c2e_symm_old-450"><span class="linenos">450</span></a>
</span><span id="rys_4c2e_symm_old-451"><a href="#rys_4c2e_symm_old-451"><span class="linenos">451</span></a>    
</span><span id="rys_4c2e_symm_old-452"><a href="#rys_4c2e_symm_old-452"><span class="linenos">452</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_4c2e_symm_old-453"><a href="#rys_4c2e_symm_old-453"><span class="linenos">453</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_4c2e_symm_old-454"><a href="#rys_4c2e_symm_old-454"><span class="linenos">454</span></a>        
</span><span id="rys_4c2e_symm_old-455"><a href="#rys_4c2e_symm_old-455"><span class="linenos">455</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_4c2e_symm_old-456"><a href="#rys_4c2e_symm_old-456"><span class="linenos">456</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-457"><a href="#rys_4c2e_symm_old-457"><span class="linenos">457</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-458"><a href="#rys_4c2e_symm_old-458"><span class="linenos">458</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-459"><a href="#rys_4c2e_symm_old-459"><span class="linenos">459</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-460"><a href="#rys_4c2e_symm_old-460"><span class="linenos">460</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-461"><a href="#rys_4c2e_symm_old-461"><span class="linenos">461</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-462"><a href="#rys_4c2e_symm_old-462"><span class="linenos">462</span></a>    <span class="n">indx_startD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-463"><a href="#rys_4c2e_symm_old-463"><span class="linenos">463</span></a>    <span class="n">indx_endD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
</span><span id="rys_4c2e_symm_old-464"><a href="#rys_4c2e_symm_old-464"><span class="linenos">464</span></a>
</span><span id="rys_4c2e_symm_old-465"><a href="#rys_4c2e_symm_old-465"><span class="linenos">465</span></a>    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">rys_4c2e_symm_internal_old</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span>\
</span><span id="rys_4c2e_symm_old-466"><a href="#rys_4c2e_symm_old-466"><span class="linenos">466</span></a>        <span class="n">indx_startA</span><span class="p">,</span><span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">indx_startD</span><span class="p">,</span><span class="n">indx_endD</span><span class="p">)</span>
</span><span id="rys_4c2e_symm_old-467"><a href="#rys_4c2e_symm_old-467"><span class="linenos">467</span></a>
</span><span id="rys_4c2e_symm_old-468"><a href="#rys_4c2e_symm_old-468"><span class="linenos">468</span></a>    <span class="k">return</span> <span class="n">ints4c2e</span>
</span></pre></div>


    

                </section>
                <section id="conv_3c2e_symm">
                            <input id="conv_3c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">conv_3c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">auxbasis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="conv_3c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#conv_3c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="conv_3c2e_symm-7"><a href="#conv_3c2e_symm-7"><span class="linenos">  7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">conv_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="conv_3c2e_symm-8"><a href="#conv_3c2e_symm-8"><span class="linenos">  8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="conv_3c2e_symm-9"><a href="#conv_3c2e_symm-9"><span class="linenos">  9</span></a><span class="sd">    Compute three-center two-electron (3c2e) electron repulsion integrals (ERIs)</span>
</span><span id="conv_3c2e_symm-10"><a href="#conv_3c2e_symm-10"><span class="linenos"> 10</span></a><span class="sd">    using the conventional and slow (analytical) formula-based method with symmetry exploitation.</span>
</span><span id="conv_3c2e_symm-11"><a href="#conv_3c2e_symm-11"><span class="linenos"> 11</span></a>
</span><span id="conv_3c2e_symm-12"><a href="#conv_3c2e_symm-12"><span class="linenos"> 12</span></a><span class="sd">    This function evaluates integrals of the form (A B | C), where:</span>
</span><span id="conv_3c2e_symm-13"><a href="#conv_3c2e_symm-13"><span class="linenos"> 13</span></a><span class="sd">        - A and B are primary basis functions from `basis`</span>
</span><span id="conv_3c2e_symm-14"><a href="#conv_3c2e_symm-14"><span class="linenos"> 14</span></a><span class="sd">        - C is an auxiliary basis function from `auxbasis`</span>
</span><span id="conv_3c2e_symm-15"><a href="#conv_3c2e_symm-15"><span class="linenos"> 15</span></a>
</span><span id="conv_3c2e_symm-16"><a href="#conv_3c2e_symm-16"><span class="linenos"> 16</span></a><span class="sd">    The &quot;conv&quot; variant uses explicit analytical integral formulas and nested</span>
</span><span id="conv_3c2e_symm-17"><a href="#conv_3c2e_symm-17"><span class="linenos"> 17</span></a><span class="sd">    loops over primitive Gaussians, following the derivations in:</span>
</span><span id="conv_3c2e_symm-18"><a href="#conv_3c2e_symm-18"><span class="linenos"> 18</span></a>
</span><span id="conv_3c2e_symm-19"><a href="#conv_3c2e_symm-19"><span class="linenos"> 19</span></a><span class="sd">        J. Chem. Educ. 2018, 95, 9, 1572–1578</span>
</span><span id="conv_3c2e_symm-20"><a href="#conv_3c2e_symm-20"><span class="linenos"> 20</span></a><span class="sd">        https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255</span>
</span><span id="conv_3c2e_symm-21"><a href="#conv_3c2e_symm-21"><span class="linenos"> 21</span></a>
</span><span id="conv_3c2e_symm-22"><a href="#conv_3c2e_symm-22"><span class="linenos"> 22</span></a><span class="sd">    Compared to the Rys quadrature method, this conventional approach is</span>
</span><span id="conv_3c2e_symm-23"><a href="#conv_3c2e_symm-23"><span class="linenos"> 23</span></a><span class="sd">    significantly more computationally expensive, but can be useful for</span>
</span><span id="conv_3c2e_symm-24"><a href="#conv_3c2e_symm-24"><span class="linenos"> 24</span></a><span class="sd">    validation or when Rys is not applicable.</span>
</span><span id="conv_3c2e_symm-25"><a href="#conv_3c2e_symm-25"><span class="linenos"> 25</span></a>
</span><span id="conv_3c2e_symm-26"><a href="#conv_3c2e_symm-26"><span class="linenos"> 26</span></a><span class="sd">    Symmetries exploited</span>
</span><span id="conv_3c2e_symm-27"><a href="#conv_3c2e_symm-27"><span class="linenos"> 27</span></a><span class="sd">    --------------------</span>
</span><span id="conv_3c2e_symm-28"><a href="#conv_3c2e_symm-28"><span class="linenos"> 28</span></a><span class="sd">    For 3c2e integrals, the following bra symmetry is used:</span>
</span><span id="conv_3c2e_symm-29"><a href="#conv_3c2e_symm-29"><span class="linenos"> 29</span></a>
</span><span id="conv_3c2e_symm-30"><a href="#conv_3c2e_symm-30"><span class="linenos"> 30</span></a><span class="sd">        (A B | C) = (B A | C)</span>
</span><span id="conv_3c2e_symm-31"><a href="#conv_3c2e_symm-31"><span class="linenos"> 31</span></a>
</span><span id="conv_3c2e_symm-32"><a href="#conv_3c2e_symm-32"><span class="linenos"> 32</span></a><span class="sd">    This reduces the number of computed integrals from N_bf² * N_aux</span>
</span><span id="conv_3c2e_symm-33"><a href="#conv_3c2e_symm-33"><span class="linenos"> 33</span></a><span class="sd">    to N_bf*(N_bf+1)/2 * N_aux when the full tensor is computed.</span>
</span><span id="conv_3c2e_symm-34"><a href="#conv_3c2e_symm-34"><span class="linenos"> 34</span></a>
</span><span id="conv_3c2e_symm-35"><a href="#conv_3c2e_symm-35"><span class="linenos"> 35</span></a><span class="sd">    Parameters</span>
</span><span id="conv_3c2e_symm-36"><a href="#conv_3c2e_symm-36"><span class="linenos"> 36</span></a><span class="sd">    ----------</span>
</span><span id="conv_3c2e_symm-37"><a href="#conv_3c2e_symm-37"><span class="linenos"> 37</span></a><span class="sd">    basis : object</span>
</span><span id="conv_3c2e_symm-38"><a href="#conv_3c2e_symm-38"><span class="linenos"> 38</span></a><span class="sd">        Primary basis set object containing:</span>
</span><span id="conv_3c2e_symm-39"><a href="#conv_3c2e_symm-39"><span class="linenos"> 39</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of basis function centers</span>
</span><span id="conv_3c2e_symm-40"><a href="#conv_3c2e_symm-40"><span class="linenos"> 40</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients</span>
</span><span id="conv_3c2e_symm-41"><a href="#conv_3c2e_symm-41"><span class="linenos"> 41</span></a><span class="sd">        - bfs_expnts : Gaussian exponents</span>
</span><span id="conv_3c2e_symm-42"><a href="#conv_3c2e_symm-42"><span class="linenos"> 42</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants</span>
</span><span id="conv_3c2e_symm-43"><a href="#conv_3c2e_symm-43"><span class="linenos"> 43</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors</span>
</span><span id="conv_3c2e_symm-44"><a href="#conv_3c2e_symm-44"><span class="linenos"> 44</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)</span>
</span><span id="conv_3c2e_symm-45"><a href="#conv_3c2e_symm-45"><span class="linenos"> 45</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function</span>
</span><span id="conv_3c2e_symm-46"><a href="#conv_3c2e_symm-46"><span class="linenos"> 46</span></a><span class="sd">        - bfs_nao : Total number of atomic orbitals</span>
</span><span id="conv_3c2e_symm-47"><a href="#conv_3c2e_symm-47"><span class="linenos"> 47</span></a>
</span><span id="conv_3c2e_symm-48"><a href="#conv_3c2e_symm-48"><span class="linenos"> 48</span></a><span class="sd">    auxbasis : object</span>
</span><span id="conv_3c2e_symm-49"><a href="#conv_3c2e_symm-49"><span class="linenos"> 49</span></a><span class="sd">        Auxiliary basis set object with the same attributes as `basis`.</span>
</span><span id="conv_3c2e_symm-50"><a href="#conv_3c2e_symm-50"><span class="linenos"> 50</span></a>
</span><span id="conv_3c2e_symm-51"><a href="#conv_3c2e_symm-51"><span class="linenos"> 51</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="conv_3c2e_symm-52"><a href="#conv_3c2e_symm-52"><span class="linenos"> 52</span></a><span class="sd">        A 6-element list specifying a sub-block of integrals to compute:</span>
</span><span id="conv_3c2e_symm-53"><a href="#conv_3c2e_symm-53"><span class="linenos"> 53</span></a><span class="sd">        [start_A, end_A, start_B, end_B, start_C, end_C]</span>
</span><span id="conv_3c2e_symm-54"><a href="#conv_3c2e_symm-54"><span class="linenos"> 54</span></a><span class="sd">        If None (default), computes the full (Nbf, Nbf, Naux) tensor.</span>
</span><span id="conv_3c2e_symm-55"><a href="#conv_3c2e_symm-55"><span class="linenos"> 55</span></a>
</span><span id="conv_3c2e_symm-56"><a href="#conv_3c2e_symm-56"><span class="linenos"> 56</span></a><span class="sd">        **Note:** When slices are used, AB symmetry exploitation is limited</span>
</span><span id="conv_3c2e_symm-57"><a href="#conv_3c2e_symm-57"><span class="linenos"> 57</span></a><span class="sd">        to permutations that lie entirely within the specified slice.</span>
</span><span id="conv_3c2e_symm-58"><a href="#conv_3c2e_symm-58"><span class="linenos"> 58</span></a>
</span><span id="conv_3c2e_symm-59"><a href="#conv_3c2e_symm-59"><span class="linenos"> 59</span></a><span class="sd">    Returns</span>
</span><span id="conv_3c2e_symm-60"><a href="#conv_3c2e_symm-60"><span class="linenos"> 60</span></a><span class="sd">    -------</span>
</span><span id="conv_3c2e_symm-61"><a href="#conv_3c2e_symm-61"><span class="linenos"> 61</span></a><span class="sd">    ints3c2e : ndarray</span>
</span><span id="conv_3c2e_symm-62"><a href="#conv_3c2e_symm-62"><span class="linenos"> 62</span></a><span class="sd">        The computed 3-center 2-electron integrals for the requested range.</span>
</span><span id="conv_3c2e_symm-63"><a href="#conv_3c2e_symm-63"><span class="linenos"> 63</span></a><span class="sd">        Shape: (Nbf, Nbf, Nauxbf) or </span>
</span><span id="conv_3c2e_symm-64"><a href="#conv_3c2e_symm-64"><span class="linenos"> 64</span></a><span class="sd">        (end_A - start_A, end_B - start_B, end_C - start_C) </span>
</span><span id="conv_3c2e_symm-65"><a href="#conv_3c2e_symm-65"><span class="linenos"> 65</span></a><span class="sd">        if slice is given.</span>
</span><span id="conv_3c2e_symm-66"><a href="#conv_3c2e_symm-66"><span class="linenos"> 66</span></a>
</span><span id="conv_3c2e_symm-67"><a href="#conv_3c2e_symm-67"><span class="linenos"> 67</span></a><span class="sd">    Notes</span>
</span><span id="conv_3c2e_symm-68"><a href="#conv_3c2e_symm-68"><span class="linenos"> 68</span></a><span class="sd">    -----</span>
</span><span id="conv_3c2e_symm-69"><a href="#conv_3c2e_symm-69"><span class="linenos"> 69</span></a><span class="sd">    - All basis set data are pre-packed into NumPy arrays for Numba acceleration.</span>
</span><span id="conv_3c2e_symm-70"><a href="#conv_3c2e_symm-70"><span class="linenos"> 70</span></a><span class="sd">    - Uses explicit primitive Gaussian formula evaluation without numerical quadrature.</span>
</span><span id="conv_3c2e_symm-71"><a href="#conv_3c2e_symm-71"><span class="linenos"> 71</span></a><span class="sd">    - Symmetry exploitation is maximal only for full-range computations.</span>
</span><span id="conv_3c2e_symm-72"><a href="#conv_3c2e_symm-72"><span class="linenos"> 72</span></a><span class="sd">    - Conventional evaluation scales poorly compared to Rys quadrature, but is</span>
</span><span id="conv_3c2e_symm-73"><a href="#conv_3c2e_symm-73"><span class="linenos"> 73</span></a><span class="sd">      exact for the given formula set.</span>
</span><span id="conv_3c2e_symm-74"><a href="#conv_3c2e_symm-74"><span class="linenos"> 74</span></a>
</span><span id="conv_3c2e_symm-75"><a href="#conv_3c2e_symm-75"><span class="linenos"> 75</span></a><span class="sd">    Examples</span>
</span><span id="conv_3c2e_symm-76"><a href="#conv_3c2e_symm-76"><span class="linenos"> 76</span></a><span class="sd">    --------</span>
</span><span id="conv_3c2e_symm-77"><a href="#conv_3c2e_symm-77"><span class="linenos"> 77</span></a><span class="sd">    &gt;&gt;&gt; eri_full = conv_3c2e_symm(basis, auxbasis)</span>
</span><span id="conv_3c2e_symm-78"><a href="#conv_3c2e_symm-78"><span class="linenos"> 78</span></a><span class="sd">    &gt;&gt;&gt; eri_block = conv_3c2e_symm(basis, auxbasis, slice=[0,5, 0,5, 0,10])</span>
</span><span id="conv_3c2e_symm-79"><a href="#conv_3c2e_symm-79"><span class="linenos"> 79</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="conv_3c2e_symm-80"><a href="#conv_3c2e_symm-80"><span class="linenos"> 80</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="conv_3c2e_symm-81"><a href="#conv_3c2e_symm-81"><span class="linenos"> 81</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="conv_3c2e_symm-82"><a href="#conv_3c2e_symm-82"><span class="linenos"> 82</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="conv_3c2e_symm-83"><a href="#conv_3c2e_symm-83"><span class="linenos"> 83</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="conv_3c2e_symm-84"><a href="#conv_3c2e_symm-84"><span class="linenos"> 84</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="conv_3c2e_symm-85"><a href="#conv_3c2e_symm-85"><span class="linenos"> 85</span></a>    
</span><span id="conv_3c2e_symm-86"><a href="#conv_3c2e_symm-86"><span class="linenos"> 86</span></a>    <span class="c1"># The integrals are performed using the formulas https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255</span>
</span><span id="conv_3c2e_symm-87"><a href="#conv_3c2e_symm-87"><span class="linenos"> 87</span></a>
</span><span id="conv_3c2e_symm-88"><a href="#conv_3c2e_symm-88"><span class="linenos"> 88</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="conv_3c2e_symm-89"><a href="#conv_3c2e_symm-89"><span class="linenos"> 89</span></a>    <span class="c1"># slice is an 6 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="conv_3c2e_symm-90"><a href="#conv_3c2e_symm-90"><span class="linenos"> 90</span></a>    <span class="c1"># and so on.</span>
</span><span id="conv_3c2e_symm-91"><a href="#conv_3c2e_symm-91"><span class="linenos"> 91</span></a>    <span class="c1"># slice = [indx_startA, indx_endA, indx_startB, indx_endB, indx_startC, indx_endC]</span>
</span><span id="conv_3c2e_symm-92"><a href="#conv_3c2e_symm-92"><span class="linenos"> 92</span></a>
</span><span id="conv_3c2e_symm-93"><a href="#conv_3c2e_symm-93"><span class="linenos"> 93</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="conv_3c2e_symm-94"><a href="#conv_3c2e_symm-94"><span class="linenos"> 94</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-95"><a href="#conv_3c2e_symm-95"><span class="linenos"> 95</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-96"><a href="#conv_3c2e_symm-96"><span class="linenos"> 96</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-97"><a href="#conv_3c2e_symm-97"><span class="linenos"> 97</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-98"><a href="#conv_3c2e_symm-98"><span class="linenos"> 98</span></a>
</span><span id="conv_3c2e_symm-99"><a href="#conv_3c2e_symm-99"><span class="linenos"> 99</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="conv_3c2e_symm-100"><a href="#conv_3c2e_symm-100"><span class="linenos">100</span></a>    <span class="n">aux_bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-101"><a href="#conv_3c2e_symm-101"><span class="linenos">101</span></a>    <span class="n">aux_bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-102"><a href="#conv_3c2e_symm-102"><span class="linenos">102</span></a>    <span class="n">aux_bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-103"><a href="#conv_3c2e_symm-103"><span class="linenos">103</span></a>    <span class="n">aux_bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-104"><a href="#conv_3c2e_symm-104"><span class="linenos">104</span></a>        
</span><span id="conv_3c2e_symm-105"><a href="#conv_3c2e_symm-105"><span class="linenos">105</span></a>
</span><span id="conv_3c2e_symm-106"><a href="#conv_3c2e_symm-106"><span class="linenos">106</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="conv_3c2e_symm-107"><a href="#conv_3c2e_symm-107"><span class="linenos">107</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="conv_3c2e_symm-108"><a href="#conv_3c2e_symm-108"><span class="linenos">108</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="conv_3c2e_symm-109"><a href="#conv_3c2e_symm-109"><span class="linenos">109</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="conv_3c2e_symm-110"><a href="#conv_3c2e_symm-110"><span class="linenos">110</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="conv_3c2e_symm-111"><a href="#conv_3c2e_symm-111"><span class="linenos">111</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="conv_3c2e_symm-112"><a href="#conv_3c2e_symm-112"><span class="linenos">112</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-113"><a href="#conv_3c2e_symm-113"><span class="linenos">113</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-114"><a href="#conv_3c2e_symm-114"><span class="linenos">114</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-115"><a href="#conv_3c2e_symm-115"><span class="linenos">115</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="conv_3c2e_symm-116"><a href="#conv_3c2e_symm-116"><span class="linenos">116</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="conv_3c2e_symm-117"><a href="#conv_3c2e_symm-117"><span class="linenos">117</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-118"><a href="#conv_3c2e_symm-118"><span class="linenos">118</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-119"><a href="#conv_3c2e_symm-119"><span class="linenos">119</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-120"><a href="#conv_3c2e_symm-120"><span class="linenos">120</span></a>
</span><span id="conv_3c2e_symm-121"><a href="#conv_3c2e_symm-121"><span class="linenos">121</span></a>    <span class="n">maxnprimaux</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="conv_3c2e_symm-122"><a href="#conv_3c2e_symm-122"><span class="linenos">122</span></a>    <span class="n">aux_bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-123"><a href="#conv_3c2e_symm-123"><span class="linenos">123</span></a>    <span class="n">aux_bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-124"><a href="#conv_3c2e_symm-124"><span class="linenos">124</span></a>    <span class="n">aux_bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-125"><a href="#conv_3c2e_symm-125"><span class="linenos">125</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="conv_3c2e_symm-126"><a href="#conv_3c2e_symm-126"><span class="linenos">126</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="conv_3c2e_symm-127"><a href="#conv_3c2e_symm-127"><span class="linenos">127</span></a>            <span class="n">aux_bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-128"><a href="#conv_3c2e_symm-128"><span class="linenos">128</span></a>            <span class="n">aux_bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-129"><a href="#conv_3c2e_symm-129"><span class="linenos">129</span></a>            <span class="n">aux_bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-130"><a href="#conv_3c2e_symm-130"><span class="linenos">130</span></a>            
</span><span id="conv_3c2e_symm-131"><a href="#conv_3c2e_symm-131"><span class="linenos">131</span></a>
</span><span id="conv_3c2e_symm-132"><a href="#conv_3c2e_symm-132"><span class="linenos">132</span></a>
</span><span id="conv_3c2e_symm-133"><a href="#conv_3c2e_symm-133"><span class="linenos">133</span></a>        
</span><span id="conv_3c2e_symm-134"><a href="#conv_3c2e_symm-134"><span class="linenos">134</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="conv_3c2e_symm-135"><a href="#conv_3c2e_symm-135"><span class="linenos">135</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="conv_3c2e_symm-136"><a href="#conv_3c2e_symm-136"><span class="linenos">136</span></a>        
</span><span id="conv_3c2e_symm-137"><a href="#conv_3c2e_symm-137"><span class="linenos">137</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="conv_3c2e_symm-138"><a href="#conv_3c2e_symm-138"><span class="linenos">138</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-139"><a href="#conv_3c2e_symm-139"><span class="linenos">139</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-140"><a href="#conv_3c2e_symm-140"><span class="linenos">140</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-141"><a href="#conv_3c2e_symm-141"><span class="linenos">141</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-142"><a href="#conv_3c2e_symm-142"><span class="linenos">142</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-143"><a href="#conv_3c2e_symm-143"><span class="linenos">143</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="conv_3c2e_symm-144"><a href="#conv_3c2e_symm-144"><span class="linenos">144</span></a>
</span><span id="conv_3c2e_symm-145"><a href="#conv_3c2e_symm-145"><span class="linenos">145</span></a>    <span class="n">ints3c2e</span> <span class="o">=</span> <span class="n">conv_3c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span><span class="n">aux_bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_coeffs</span><span class="p">,</span> <span class="n">aux_bfs_prim_norms</span><span class="p">,</span> <span class="n">aux_bfs_expnts</span><span class="p">,</span><span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">)</span>
</span><span id="conv_3c2e_symm-146"><a href="#conv_3c2e_symm-146"><span class="linenos">146</span></a>    <span class="k">return</span> <span class="n">ints3c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute three-center two-electron (3c2e) electron repulsion integrals (ERIs)
using the conventional and slow (analytical) formula-based method with symmetry exploitation.</p>

<p>This function evaluates integrals of the form (A B | C), where:
    - A and B are primary basis functions from <code>basis</code>
    - C is an auxiliary basis function from <code>auxbasis</code></p>

<p>The "conv" variant uses explicit analytical integral formulas and nested
loops over primitive Gaussians, following the derivations in:</p>

<pre><code>J. Chem. Educ. 2018, 95, 9, 1572–1578
https://pubs.acs.org/doi/full/10.1021/acs.jchemed.8b00255
</code></pre>

<p>Compared to the Rys quadrature method, this conventional approach is
significantly more computationally expensive, but can be useful for
validation or when Rys is not applicable.</p>

<h2 id="symmetries-exploited">Symmetries exploited</h2>

<p>For 3c2e integrals, the following bra symmetry is used:</p>

<pre><code>(A B | C) = (B A | C)
</code></pre>

<p>This reduces the number of computed integrals from N_bf² * N_aux
to N_bf*(N_bf+1)/2 * N_aux when the full tensor is computed.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Primary basis set object containing:
    - bfs_coords : Cartesian coordinates of basis function centers
    - bfs_coeffs : Contraction coefficients
    - bfs_expnts : Gaussian exponents
    - bfs_prim_norms : Primitive normalization constants
    - bfs_contr_prim_norms : Contraction normalization factors
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)
    - bfs_nprim : Number of primitives per basis function
    - bfs_nao : Total number of atomic orbitals</p>

<p>auxbasis : object
    Auxiliary basis set object with the same attributes as <code>basis</code>.</p>

<p>slice : list of int, optional
    A 6-element list specifying a sub-block of integrals to compute:
    [start_A, end_A, start_B, end_B, start_C, end_C]
    If None (default), computes the full (Nbf, Nbf, Naux) tensor.</p>

<pre><code>**Note:** When slices are used, AB symmetry exploitation is limited
to permutations that lie entirely within the specified slice.
</code></pre>

<h2 id="returns">Returns</h2>

<p>ints3c2e : ndarray
    The computed 3-center 2-electron integrals for the requested range.
    Shape: (Nbf, Nbf, Nauxbf) or 
    (end_A - start_A, end_B - start_B, end_C - start_C) 
    if slice is given.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>All basis set data are pre-packed into NumPy arrays for Numba acceleration.</li>
<li>Uses explicit primitive Gaussian formula evaluation without numerical quadrature.</li>
<li>Symmetry exploitation is maximal only for full-range computations.</li>
<li>Conventional evaluation scales poorly compared to Rys quadrature, but is
exact for the given formula set.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">eri_full</span> <span class="o">=</span> <span class="n">conv_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eri_block</span> <span class="o">=</span> <span class="n">conv_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="rys_3c2e_symm">
                            <input id="rys_3c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_3c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">auxbasis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">schwarz</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-09</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_3c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_3c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_3c2e_symm-11"><a href="#rys_3c2e_symm-11"><span class="linenos"> 11</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schwarz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">):</span>
</span><span id="rys_3c2e_symm-12"><a href="#rys_3c2e_symm-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="rys_3c2e_symm-13"><a href="#rys_3c2e_symm-13"><span class="linenos"> 13</span></a><span class="sd">    Compute three-center two-electron (3c2e) electron repulsion integrals using</span>
</span><span id="rys_3c2e_symm-14"><a href="#rys_3c2e_symm-14"><span class="linenos"> 14</span></a><span class="sd">    the Rys quadrature method with symmetry considerations.</span>
</span><span id="rys_3c2e_symm-15"><a href="#rys_3c2e_symm-15"><span class="linenos"> 15</span></a>
</span><span id="rys_3c2e_symm-16"><a href="#rys_3c2e_symm-16"><span class="linenos"> 16</span></a><span class="sd">    This function evaluates integrals of the form (A B | C), where A and B are</span>
</span><span id="rys_3c2e_symm-17"><a href="#rys_3c2e_symm-17"><span class="linenos"> 17</span></a><span class="sd">    basis functions from a primary basis set and C is from an auxiliary basis set.</span>
</span><span id="rys_3c2e_symm-18"><a href="#rys_3c2e_symm-18"><span class="linenos"> 18</span></a><span class="sd">    Symmetry in the first two indices is exploited ((A B | C) = (B A | C)),</span>
</span><span id="rys_3c2e_symm-19"><a href="#rys_3c2e_symm-19"><span class="linenos"> 19</span></a><span class="sd">    so only the upper-triangular part of the (A,B) block is computed and the (B A | C)</span>
</span><span id="rys_3c2e_symm-20"><a href="#rys_3c2e_symm-20"><span class="linenos"> 20</span></a><span class="sd">    integrals are formed by symmetry.</span>
</span><span id="rys_3c2e_symm-21"><a href="#rys_3c2e_symm-21"><span class="linenos"> 21</span></a><span class="sd">    The implementation uses Numba-accelerated backends with symmetry-aware</span>
</span><span id="rys_3c2e_symm-22"><a href="#rys_3c2e_symm-22"><span class="linenos"> 22</span></a><span class="sd">    optimizations and optional Schwarz screening to skip negligible contributions.</span>
</span><span id="rys_3c2e_symm-23"><a href="#rys_3c2e_symm-23"><span class="linenos"> 23</span></a><span class="sd">    Symmetry is utilized to only compute N_{bf}*(N_{bf}+1)/2*N_{auxbf}</span>
</span><span id="rys_3c2e_symm-24"><a href="#rys_3c2e_symm-24"><span class="linenos"> 24</span></a>
</span><span id="rys_3c2e_symm-25"><a href="#rys_3c2e_symm-25"><span class="linenos"> 25</span></a><span class="sd">    Parameters</span>
</span><span id="rys_3c2e_symm-26"><a href="#rys_3c2e_symm-26"><span class="linenos"> 26</span></a><span class="sd">    ----------</span>
</span><span id="rys_3c2e_symm-27"><a href="#rys_3c2e_symm-27"><span class="linenos"> 27</span></a><span class="sd">    basis : object</span>
</span><span id="rys_3c2e_symm-28"><a href="#rys_3c2e_symm-28"><span class="linenos"> 28</span></a><span class="sd">        Primary basis set object containing information about atomic orbitals, such as:</span>
</span><span id="rys_3c2e_symm-29"><a href="#rys_3c2e_symm-29"><span class="linenos"> 29</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of basis function centers.</span>
</span><span id="rys_3c2e_symm-30"><a href="#rys_3c2e_symm-30"><span class="linenos"> 30</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients.</span>
</span><span id="rys_3c2e_symm-31"><a href="#rys_3c2e_symm-31"><span class="linenos"> 31</span></a><span class="sd">        - bfs_expnts : Gaussian exponents.</span>
</span><span id="rys_3c2e_symm-32"><a href="#rys_3c2e_symm-32"><span class="linenos"> 32</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants.</span>
</span><span id="rys_3c2e_symm-33"><a href="#rys_3c2e_symm-33"><span class="linenos"> 33</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors.</span>
</span><span id="rys_3c2e_symm-34"><a href="#rys_3c2e_symm-34"><span class="linenos"> 34</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="rys_3c2e_symm-35"><a href="#rys_3c2e_symm-35"><span class="linenos"> 35</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function.</span>
</span><span id="rys_3c2e_symm-36"><a href="#rys_3c2e_symm-36"><span class="linenos"> 36</span></a><span class="sd">        - bfs_nao : Total number of atomic orbitals.</span>
</span><span id="rys_3c2e_symm-37"><a href="#rys_3c2e_symm-37"><span class="linenos"> 37</span></a>
</span><span id="rys_3c2e_symm-38"><a href="#rys_3c2e_symm-38"><span class="linenos"> 38</span></a><span class="sd">    auxbasis : object</span>
</span><span id="rys_3c2e_symm-39"><a href="#rys_3c2e_symm-39"><span class="linenos"> 39</span></a><span class="sd">        Auxiliary basis set object with the same attributes as `basis`, </span>
</span><span id="rys_3c2e_symm-40"><a href="#rys_3c2e_symm-40"><span class="linenos"> 40</span></a><span class="sd">        but typically used for resolution-of-the-identity (RI) expansions.</span>
</span><span id="rys_3c2e_symm-41"><a href="#rys_3c2e_symm-41"><span class="linenos"> 41</span></a>
</span><span id="rys_3c2e_symm-42"><a href="#rys_3c2e_symm-42"><span class="linenos"> 42</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="rys_3c2e_symm-43"><a href="#rys_3c2e_symm-43"><span class="linenos"> 43</span></a><span class="sd">        A 6-element list specifying a subset of integrals to compute:</span>
</span><span id="rys_3c2e_symm-44"><a href="#rys_3c2e_symm-44"><span class="linenos"> 44</span></a><span class="sd">        [start_A, end_A, start_B, end_B, start_C, end_C]</span>
</span><span id="rys_3c2e_symm-45"><a href="#rys_3c2e_symm-45"><span class="linenos"> 45</span></a><span class="sd">        If None (default), computes all N_{bf}*N_{bf}*N_{auxbf} integrals.</span>
</span><span id="rys_3c2e_symm-46"><a href="#rys_3c2e_symm-46"><span class="linenos"> 46</span></a>
</span><span id="rys_3c2e_symm-47"><a href="#rys_3c2e_symm-47"><span class="linenos"> 47</span></a><span class="sd">    schwarz : bool, optional</span>
</span><span id="rys_3c2e_symm-48"><a href="#rys_3c2e_symm-48"><span class="linenos"> 48</span></a><span class="sd">        If True, applies Schwarz screening to skip calculations where the </span>
</span><span id="rys_3c2e_symm-49"><a href="#rys_3c2e_symm-49"><span class="linenos"> 49</span></a><span class="sd">        product of integral bounds is below `schwarz_threshold`.</span>
</span><span id="rys_3c2e_symm-50"><a href="#rys_3c2e_symm-50"><span class="linenos"> 50</span></a>
</span><span id="rys_3c2e_symm-51"><a href="#rys_3c2e_symm-51"><span class="linenos"> 51</span></a><span class="sd">    schwarz_threshold : float, optional</span>
</span><span id="rys_3c2e_symm-52"><a href="#rys_3c2e_symm-52"><span class="linenos"> 52</span></a><span class="sd">        The threshold for Schwarz screening (default is 1e-9).</span>
</span><span id="rys_3c2e_symm-53"><a href="#rys_3c2e_symm-53"><span class="linenos"> 53</span></a>
</span><span id="rys_3c2e_symm-54"><a href="#rys_3c2e_symm-54"><span class="linenos"> 54</span></a><span class="sd">    Returns</span>
</span><span id="rys_3c2e_symm-55"><a href="#rys_3c2e_symm-55"><span class="linenos"> 55</span></a><span class="sd">    -------</span>
</span><span id="rys_3c2e_symm-56"><a href="#rys_3c2e_symm-56"><span class="linenos"> 56</span></a><span class="sd">    ints3c2e : ndarray of shape </span>
</span><span id="rys_3c2e_symm-57"><a href="#rys_3c2e_symm-57"><span class="linenos"> 57</span></a><span class="sd">        (Nbf, Nbf, Nauxbf) or </span>
</span><span id="rys_3c2e_symm-58"><a href="#rys_3c2e_symm-58"><span class="linenos"> 58</span></a><span class="sd">        (end_A - start_A, end_B - start_B, end_C - start_C) </span>
</span><span id="rys_3c2e_symm-59"><a href="#rys_3c2e_symm-59"><span class="linenos"> 59</span></a><span class="sd">        if slice is given.</span>
</span><span id="rys_3c2e_symm-60"><a href="#rys_3c2e_symm-60"><span class="linenos"> 60</span></a><span class="sd">        The computed 3-center 2-electron integrals.</span>
</span><span id="rys_3c2e_symm-61"><a href="#rys_3c2e_symm-61"><span class="linenos"> 61</span></a>
</span><span id="rys_3c2e_symm-62"><a href="#rys_3c2e_symm-62"><span class="linenos"> 62</span></a><span class="sd">    Notes</span>
</span><span id="rys_3c2e_symm-63"><a href="#rys_3c2e_symm-63"><span class="linenos"> 63</span></a><span class="sd">    -----</span>
</span><span id="rys_3c2e_symm-64"><a href="#rys_3c2e_symm-64"><span class="linenos"> 64</span></a><span class="sd">    - Uses preallocated NumPy arrays to store primitive data for efficient Numba processing.</span>
</span><span id="rys_3c2e_symm-65"><a href="#rys_3c2e_symm-65"><span class="linenos"> 65</span></a><span class="sd">    - Handles irregular contraction patterns by padding primitive arrays to the </span>
</span><span id="rys_3c2e_symm-66"><a href="#rys_3c2e_symm-66"><span class="linenos"> 66</span></a><span class="sd">      size of the largest contraction.</span>
</span><span id="rys_3c2e_symm-67"><a href="#rys_3c2e_symm-67"><span class="linenos"> 67</span></a><span class="sd">    - If Schwarz screening is enabled, precomputes diagonal two-electron integrals </span>
</span><span id="rys_3c2e_symm-68"><a href="#rys_3c2e_symm-68"><span class="linenos"> 68</span></a><span class="sd">      and uses their square roots for screening.</span>
</span><span id="rys_3c2e_symm-69"><a href="#rys_3c2e_symm-69"><span class="linenos"> 69</span></a><span class="sd">    - Symmetry relations are exploited to avoid redundant calculations.</span>
</span><span id="rys_3c2e_symm-70"><a href="#rys_3c2e_symm-70"><span class="linenos"> 70</span></a>
</span><span id="rys_3c2e_symm-71"><a href="#rys_3c2e_symm-71"><span class="linenos"> 71</span></a><span class="sd">    Examples</span>
</span><span id="rys_3c2e_symm-72"><a href="#rys_3c2e_symm-72"><span class="linenos"> 72</span></a><span class="sd">    --------</span>
</span><span id="rys_3c2e_symm-73"><a href="#rys_3c2e_symm-73"><span class="linenos"> 73</span></a><span class="sd">    &gt;&gt;&gt; ints = rys_3c2e_symm(basis, auxbasis)</span>
</span><span id="rys_3c2e_symm-74"><a href="#rys_3c2e_symm-74"><span class="linenos"> 74</span></a><span class="sd">    &gt;&gt;&gt; ints_block = rys_3c2e_symm(basis, auxbasis, slice=[0, 5, 0, 5, 0, 10])</span>
</span><span id="rys_3c2e_symm-75"><a href="#rys_3c2e_symm-75"><span class="linenos"> 75</span></a><span class="sd">    &gt;&gt;&gt; ints_screened = rys_3c2e_symm(basis, auxbasis, schwarz=True, schwarz_threshold=1e-10)</span>
</span><span id="rys_3c2e_symm-76"><a href="#rys_3c2e_symm-76"><span class="linenos"> 76</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="rys_3c2e_symm-77"><a href="#rys_3c2e_symm-77"><span class="linenos"> 77</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_3c2e_symm-78"><a href="#rys_3c2e_symm-78"><span class="linenos"> 78</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_3c2e_symm-79"><a href="#rys_3c2e_symm-79"><span class="linenos"> 79</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="rys_3c2e_symm-80"><a href="#rys_3c2e_symm-80"><span class="linenos"> 80</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="rys_3c2e_symm-81"><a href="#rys_3c2e_symm-81"><span class="linenos"> 81</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_3c2e_symm-82"><a href="#rys_3c2e_symm-82"><span class="linenos"> 82</span></a>    
</span><span id="rys_3c2e_symm-83"><a href="#rys_3c2e_symm-83"><span class="linenos"> 83</span></a>
</span><span id="rys_3c2e_symm-84"><a href="#rys_3c2e_symm-84"><span class="linenos"> 84</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="rys_3c2e_symm-85"><a href="#rys_3c2e_symm-85"><span class="linenos"> 85</span></a>    <span class="c1"># slice is a 6 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="rys_3c2e_symm-86"><a href="#rys_3c2e_symm-86"><span class="linenos"> 86</span></a>    <span class="c1"># and so on.</span>
</span><span id="rys_3c2e_symm-87"><a href="#rys_3c2e_symm-87"><span class="linenos"> 87</span></a>    <span class="c1"># slice = [indx_startA, indx_endA, indx_startB, indx_endB, indx_startC, indx_endC]</span>
</span><span id="rys_3c2e_symm-88"><a href="#rys_3c2e_symm-88"><span class="linenos"> 88</span></a>
</span><span id="rys_3c2e_symm-89"><a href="#rys_3c2e_symm-89"><span class="linenos"> 89</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_symm-90"><a href="#rys_3c2e_symm-90"><span class="linenos"> 90</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-91"><a href="#rys_3c2e_symm-91"><span class="linenos"> 91</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-92"><a href="#rys_3c2e_symm-92"><span class="linenos"> 92</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-93"><a href="#rys_3c2e_symm-93"><span class="linenos"> 93</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-94"><a href="#rys_3c2e_symm-94"><span class="linenos"> 94</span></a>
</span><span id="rys_3c2e_symm-95"><a href="#rys_3c2e_symm-95"><span class="linenos"> 95</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_symm-96"><a href="#rys_3c2e_symm-96"><span class="linenos"> 96</span></a>    <span class="n">aux_bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-97"><a href="#rys_3c2e_symm-97"><span class="linenos"> 97</span></a>    <span class="n">aux_bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-98"><a href="#rys_3c2e_symm-98"><span class="linenos"> 98</span></a>    <span class="n">aux_bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-99"><a href="#rys_3c2e_symm-99"><span class="linenos"> 99</span></a>    <span class="n">aux_bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-100"><a href="#rys_3c2e_symm-100"><span class="linenos">100</span></a>        
</span><span id="rys_3c2e_symm-101"><a href="#rys_3c2e_symm-101"><span class="linenos">101</span></a>
</span><span id="rys_3c2e_symm-102"><a href="#rys_3c2e_symm-102"><span class="linenos">102</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_3c2e_symm-103"><a href="#rys_3c2e_symm-103"><span class="linenos">103</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_3c2e_symm-104"><a href="#rys_3c2e_symm-104"><span class="linenos">104</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_3c2e_symm-105"><a href="#rys_3c2e_symm-105"><span class="linenos">105</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_3c2e_symm-106"><a href="#rys_3c2e_symm-106"><span class="linenos">106</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_3c2e_symm-107"><a href="#rys_3c2e_symm-107"><span class="linenos">107</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-108"><a href="#rys_3c2e_symm-108"><span class="linenos">108</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-109"><a href="#rys_3c2e_symm-109"><span class="linenos">109</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-110"><a href="#rys_3c2e_symm-110"><span class="linenos">110</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-111"><a href="#rys_3c2e_symm-111"><span class="linenos">111</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm-112"><a href="#rys_3c2e_symm-112"><span class="linenos">112</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm-113"><a href="#rys_3c2e_symm-113"><span class="linenos">113</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-114"><a href="#rys_3c2e_symm-114"><span class="linenos">114</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-115"><a href="#rys_3c2e_symm-115"><span class="linenos">115</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-116"><a href="#rys_3c2e_symm-116"><span class="linenos">116</span></a>
</span><span id="rys_3c2e_symm-117"><a href="#rys_3c2e_symm-117"><span class="linenos">117</span></a>    <span class="n">maxnprimaux</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-118"><a href="#rys_3c2e_symm-118"><span class="linenos">118</span></a>    <span class="n">aux_bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-119"><a href="#rys_3c2e_symm-119"><span class="linenos">119</span></a>    <span class="n">aux_bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-120"><a href="#rys_3c2e_symm-120"><span class="linenos">120</span></a>    <span class="n">aux_bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-121"><a href="#rys_3c2e_symm-121"><span class="linenos">121</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm-122"><a href="#rys_3c2e_symm-122"><span class="linenos">122</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm-123"><a href="#rys_3c2e_symm-123"><span class="linenos">123</span></a>            <span class="n">aux_bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-124"><a href="#rys_3c2e_symm-124"><span class="linenos">124</span></a>            <span class="n">aux_bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-125"><a href="#rys_3c2e_symm-125"><span class="linenos">125</span></a>            <span class="n">aux_bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-126"><a href="#rys_3c2e_symm-126"><span class="linenos">126</span></a>            
</span><span id="rys_3c2e_symm-127"><a href="#rys_3c2e_symm-127"><span class="linenos">127</span></a>
</span><span id="rys_3c2e_symm-128"><a href="#rys_3c2e_symm-128"><span class="linenos">128</span></a>
</span><span id="rys_3c2e_symm-129"><a href="#rys_3c2e_symm-129"><span class="linenos">129</span></a>        
</span><span id="rys_3c2e_symm-130"><a href="#rys_3c2e_symm-130"><span class="linenos">130</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm-131"><a href="#rys_3c2e_symm-131"><span class="linenos">131</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_3c2e_symm-132"><a href="#rys_3c2e_symm-132"><span class="linenos">132</span></a>        
</span><span id="rys_3c2e_symm-133"><a href="#rys_3c2e_symm-133"><span class="linenos">133</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_3c2e_symm-134"><a href="#rys_3c2e_symm-134"><span class="linenos">134</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-135"><a href="#rys_3c2e_symm-135"><span class="linenos">135</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-136"><a href="#rys_3c2e_symm-136"><span class="linenos">136</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-137"><a href="#rys_3c2e_symm-137"><span class="linenos">137</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-138"><a href="#rys_3c2e_symm-138"><span class="linenos">138</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-139"><a href="#rys_3c2e_symm-139"><span class="linenos">139</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="rys_3c2e_symm-140"><a href="#rys_3c2e_symm-140"><span class="linenos">140</span></a>
</span><span id="rys_3c2e_symm-141"><a href="#rys_3c2e_symm-141"><span class="linenos">141</span></a>    <span class="k">if</span> <span class="n">schwarz</span><span class="p">:</span>
</span><span id="rys_3c2e_symm-142"><a href="#rys_3c2e_symm-142"><span class="linenos">142</span></a>        <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-143"><a href="#rys_3c2e_symm-143"><span class="linenos">143</span></a>        <span class="n">ints2c2e</span> <span class="o">=</span> <span class="n">rys_2c2e_symm</span><span class="p">(</span><span class="n">auxbasis</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-144"><a href="#rys_3c2e_symm-144"><span class="linenos">144</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="rys_3c2e_symm-145"><a href="#rys_3c2e_symm-145"><span class="linenos">145</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ints2c2e</span><span class="p">)))</span>
</span><span id="rys_3c2e_symm-146"><a href="#rys_3c2e_symm-146"><span class="linenos">146</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prelims calc done for Schwarz screening!&#39;</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-147"><a href="#rys_3c2e_symm-147"><span class="linenos">147</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm-148"><a href="#rys_3c2e_symm-148"><span class="linenos">148</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="rys_3c2e_symm-149"><a href="#rys_3c2e_symm-149"><span class="linenos">149</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-150"><a href="#rys_3c2e_symm-150"><span class="linenos">150</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-151"><a href="#rys_3c2e_symm-151"><span class="linenos">151</span></a>
</span><span id="rys_3c2e_symm-152"><a href="#rys_3c2e_symm-152"><span class="linenos">152</span></a>    <span class="n">ints3c2e</span> <span class="o">=</span> <span class="n">rys_3c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span><span class="n">aux_bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_coeffs</span><span class="p">,</span> <span class="n">aux_bfs_prim_norms</span><span class="p">,</span> <span class="n">aux_bfs_expnts</span><span class="p">,</span><span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">schwarz</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="p">)</span>
</span><span id="rys_3c2e_symm-153"><a href="#rys_3c2e_symm-153"><span class="linenos">153</span></a>    <span class="k">return</span> <span class="n">ints3c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute three-center two-electron (3c2e) electron repulsion integrals using
the Rys quadrature method with symmetry considerations.</p>

<p>This function evaluates integrals of the form (A B | C), where A and B are
basis functions from a primary basis set and C is from an auxiliary basis set.
Symmetry in the first two indices is exploited ((A B | C) = (B A | C)),
so only the upper-triangular part of the (A,B) block is computed and the (B A | C)
integrals are formed by symmetry.
The implementation uses Numba-accelerated backends with symmetry-aware
optimizations and optional Schwarz screening to skip negligible contributions.
Symmetry is utilized to only compute N_{bf}*(N_{bf}+1)/2*N_{auxbf}</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Primary basis set object containing information about atomic orbitals, such as:
    - bfs_coords : Cartesian coordinates of basis function centers.
    - bfs_coeffs : Contraction coefficients.
    - bfs_expnts : Gaussian exponents.
    - bfs_prim_norms : Primitive normalization constants.
    - bfs_contr_prim_norms : Contraction normalization factors.
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim : Number of primitives per basis function.
    - bfs_nao : Total number of atomic orbitals.</p>

<p>auxbasis : object
    Auxiliary basis set object with the same attributes as <code>basis</code>, 
    but typically used for resolution-of-the-identity (RI) expansions.</p>

<p>slice : list of int, optional
    A 6-element list specifying a subset of integrals to compute:
    [start_A, end_A, start_B, end_B, start_C, end_C]
    If None (default), computes all N_{bf}*N_{bf}*N_{auxbf} integrals.</p>

<p>schwarz : bool, optional
    If True, applies Schwarz screening to skip calculations where the 
    product of integral bounds is below <code>schwarz_threshold</code>.</p>

<p>schwarz_threshold : float, optional
    The threshold for Schwarz screening (default is 1e-9).</p>

<h2 id="returns">Returns</h2>

<p>ints3c2e : ndarray of shape 
    (Nbf, Nbf, Nauxbf) or 
    (end_A - start_A, end_B - start_B, end_C - start_C) 
    if slice is given.
    The computed 3-center 2-electron integrals.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Uses preallocated NumPy arrays to store primitive data for efficient Numba processing.</li>
<li>Handles irregular contraction patterns by padding primitive arrays to the 
size of the largest contraction.</li>
<li>If Schwarz screening is enabled, precomputes diagonal two-electron integrals 
and uses their square roots for screening.</li>
<li>Symmetry relations are exploited to avoid redundant calculations.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">ints</span> <span class="o">=</span> <span class="n">rys_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ints_block</span> <span class="o">=</span> <span class="n">rys_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ints_screened</span> <span class="o">=</span> <span class="n">rys_3c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">schwarz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
</code></pre>
</div>
</div>


                </section>
                <section id="conv_2c2e_symm">
                            <input id="conv_2c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">conv_2c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="conv_2c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#conv_2c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="conv_2c2e_symm-8"><a href="#conv_2c2e_symm-8"><span class="linenos"> 8</span></a><span class="k">def</span><span class="w"> </span><span class="nf">conv_2c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="conv_2c2e_symm-9"><a href="#conv_2c2e_symm-9"><span class="linenos"> 9</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="conv_2c2e_symm-10"><a href="#conv_2c2e_symm-10"><span class="linenos">10</span></a><span class="sd">    Compute two-center two-electron integrals (2c2e) using the conventional (slow) method,</span>
</span><span id="conv_2c2e_symm-11"><a href="#conv_2c2e_symm-11"><span class="linenos">11</span></a><span class="sd">    exploiting permutation symmetry.</span>
</span><span id="conv_2c2e_symm-12"><a href="#conv_2c2e_symm-12"><span class="linenos">12</span></a>
</span><span id="conv_2c2e_symm-13"><a href="#conv_2c2e_symm-13"><span class="linenos">13</span></a><span class="sd">    This function computes 2c2e electron repulsion integrals (ERIs) over a given</span>
</span><span id="conv_2c2e_symm-14"><a href="#conv_2c2e_symm-14"><span class="linenos">14</span></a><span class="sd">    basis set using the conventional algorithm which is very slow compared to Rys quadrature. </span>
</span><span id="conv_2c2e_symm-15"><a href="#conv_2c2e_symm-15"><span class="linenos">15</span></a><span class="sd">    It supports symmetric integral evaluation and allows slicing the full ERI matrix into </span>
</span><span id="conv_2c2e_symm-16"><a href="#conv_2c2e_symm-16"><span class="linenos">16</span></a><span class="sd">    blocks for efficient parallelization or chunked computation.</span>
</span><span id="conv_2c2e_symm-17"><a href="#conv_2c2e_symm-17"><span class="linenos">17</span></a>
</span><span id="conv_2c2e_symm-18"><a href="#conv_2c2e_symm-18"><span class="linenos">18</span></a><span class="sd">    Parameters</span>
</span><span id="conv_2c2e_symm-19"><a href="#conv_2c2e_symm-19"><span class="linenos">19</span></a><span class="sd">    ----------</span>
</span><span id="conv_2c2e_symm-20"><a href="#conv_2c2e_symm-20"><span class="linenos">20</span></a><span class="sd">    basis : Basis</span>
</span><span id="conv_2c2e_symm-21"><a href="#conv_2c2e_symm-21"><span class="linenos">21</span></a><span class="sd">        A basis object containing basis function information such as:</span>
</span><span id="conv_2c2e_symm-22"><a href="#conv_2c2e_symm-22"><span class="linenos">22</span></a><span class="sd">        coordinates, exponents, coefficients, angular momentum, normalization factors,</span>
</span><span id="conv_2c2e_symm-23"><a href="#conv_2c2e_symm-23"><span class="linenos">23</span></a><span class="sd">        and number of primitives.</span>
</span><span id="conv_2c2e_symm-24"><a href="#conv_2c2e_symm-24"><span class="linenos">24</span></a>
</span><span id="conv_2c2e_symm-25"><a href="#conv_2c2e_symm-25"><span class="linenos">25</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="conv_2c2e_symm-26"><a href="#conv_2c2e_symm-26"><span class="linenos">26</span></a><span class="sd">        A list of four integers [start_row, end_row, start_col, end_col] specifying</span>
</span><span id="conv_2c2e_symm-27"><a href="#conv_2c2e_symm-27"><span class="linenos">27</span></a><span class="sd">        a block (subset) of the full integral matrix to compute.</span>
</span><span id="conv_2c2e_symm-28"><a href="#conv_2c2e_symm-28"><span class="linenos">28</span></a><span class="sd">        If not provided, the full matrix is computed.</span>
</span><span id="conv_2c2e_symm-29"><a href="#conv_2c2e_symm-29"><span class="linenos">29</span></a>
</span><span id="conv_2c2e_symm-30"><a href="#conv_2c2e_symm-30"><span class="linenos">30</span></a><span class="sd">    Returns</span>
</span><span id="conv_2c2e_symm-31"><a href="#conv_2c2e_symm-31"><span class="linenos">31</span></a><span class="sd">    -------</span>
</span><span id="conv_2c2e_symm-32"><a href="#conv_2c2e_symm-32"><span class="linenos">32</span></a><span class="sd">    ints2c2e : np.ndarray</span>
</span><span id="conv_2c2e_symm-33"><a href="#conv_2c2e_symm-33"><span class="linenos">33</span></a><span class="sd">        A 2D numpy array containing the computed 2c2e integrals for the specified slice.</span>
</span><span id="conv_2c2e_symm-34"><a href="#conv_2c2e_symm-34"><span class="linenos">34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="conv_2c2e_symm-35"><a href="#conv_2c2e_symm-35"><span class="linenos">35</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="conv_2c2e_symm-36"><a href="#conv_2c2e_symm-36"><span class="linenos">36</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="conv_2c2e_symm-37"><a href="#conv_2c2e_symm-37"><span class="linenos">37</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="conv_2c2e_symm-38"><a href="#conv_2c2e_symm-38"><span class="linenos">38</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="conv_2c2e_symm-39"><a href="#conv_2c2e_symm-39"><span class="linenos">39</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="conv_2c2e_symm-40"><a href="#conv_2c2e_symm-40"><span class="linenos">40</span></a>    
</span><span id="conv_2c2e_symm-41"><a href="#conv_2c2e_symm-41"><span class="linenos">41</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="conv_2c2e_symm-42"><a href="#conv_2c2e_symm-42"><span class="linenos">42</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="conv_2c2e_symm-43"><a href="#conv_2c2e_symm-43"><span class="linenos">43</span></a>    <span class="c1"># and so on.</span>
</span><span id="conv_2c2e_symm-44"><a href="#conv_2c2e_symm-44"><span class="linenos">44</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="conv_2c2e_symm-45"><a href="#conv_2c2e_symm-45"><span class="linenos">45</span></a>
</span><span id="conv_2c2e_symm-46"><a href="#conv_2c2e_symm-46"><span class="linenos">46</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="conv_2c2e_symm-47"><a href="#conv_2c2e_symm-47"><span class="linenos">47</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-48"><a href="#conv_2c2e_symm-48"><span class="linenos">48</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-49"><a href="#conv_2c2e_symm-49"><span class="linenos">49</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-50"><a href="#conv_2c2e_symm-50"><span class="linenos">50</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-51"><a href="#conv_2c2e_symm-51"><span class="linenos">51</span></a>
</span><span id="conv_2c2e_symm-52"><a href="#conv_2c2e_symm-52"><span class="linenos">52</span></a>        
</span><span id="conv_2c2e_symm-53"><a href="#conv_2c2e_symm-53"><span class="linenos">53</span></a>
</span><span id="conv_2c2e_symm-54"><a href="#conv_2c2e_symm-54"><span class="linenos">54</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="conv_2c2e_symm-55"><a href="#conv_2c2e_symm-55"><span class="linenos">55</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="conv_2c2e_symm-56"><a href="#conv_2c2e_symm-56"><span class="linenos">56</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="conv_2c2e_symm-57"><a href="#conv_2c2e_symm-57"><span class="linenos">57</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="conv_2c2e_symm-58"><a href="#conv_2c2e_symm-58"><span class="linenos">58</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="conv_2c2e_symm-59"><a href="#conv_2c2e_symm-59"><span class="linenos">59</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="conv_2c2e_symm-60"><a href="#conv_2c2e_symm-60"><span class="linenos">60</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-61"><a href="#conv_2c2e_symm-61"><span class="linenos">61</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-62"><a href="#conv_2c2e_symm-62"><span class="linenos">62</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="conv_2c2e_symm-63"><a href="#conv_2c2e_symm-63"><span class="linenos">63</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="conv_2c2e_symm-64"><a href="#conv_2c2e_symm-64"><span class="linenos">64</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="conv_2c2e_symm-65"><a href="#conv_2c2e_symm-65"><span class="linenos">65</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_2c2e_symm-66"><a href="#conv_2c2e_symm-66"><span class="linenos">66</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_2c2e_symm-67"><a href="#conv_2c2e_symm-67"><span class="linenos">67</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="conv_2c2e_symm-68"><a href="#conv_2c2e_symm-68"><span class="linenos">68</span></a>
</span><span id="conv_2c2e_symm-69"><a href="#conv_2c2e_symm-69"><span class="linenos">69</span></a>            
</span><span id="conv_2c2e_symm-70"><a href="#conv_2c2e_symm-70"><span class="linenos">70</span></a>
</span><span id="conv_2c2e_symm-71"><a href="#conv_2c2e_symm-71"><span class="linenos">71</span></a>        
</span><span id="conv_2c2e_symm-72"><a href="#conv_2c2e_symm-72"><span class="linenos">72</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="conv_2c2e_symm-73"><a href="#conv_2c2e_symm-73"><span class="linenos">73</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="conv_2c2e_symm-74"><a href="#conv_2c2e_symm-74"><span class="linenos">74</span></a>        
</span><span id="conv_2c2e_symm-75"><a href="#conv_2c2e_symm-75"><span class="linenos">75</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="conv_2c2e_symm-76"><a href="#conv_2c2e_symm-76"><span class="linenos">76</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="conv_2c2e_symm-77"><a href="#conv_2c2e_symm-77"><span class="linenos">77</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="conv_2c2e_symm-78"><a href="#conv_2c2e_symm-78"><span class="linenos">78</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="conv_2c2e_symm-79"><a href="#conv_2c2e_symm-79"><span class="linenos">79</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="conv_2c2e_symm-80"><a href="#conv_2c2e_symm-80"><span class="linenos">80</span></a>
</span><span id="conv_2c2e_symm-81"><a href="#conv_2c2e_symm-81"><span class="linenos">81</span></a>    <span class="n">ints2c2e</span> <span class="o">=</span> <span class="n">conv_2c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">)</span>
</span><span id="conv_2c2e_symm-82"><a href="#conv_2c2e_symm-82"><span class="linenos">82</span></a>    <span class="k">return</span> <span class="n">ints2c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute two-center two-electron integrals (2c2e) using the conventional (slow) method,
exploiting permutation symmetry.</p>

<p>This function computes 2c2e electron repulsion integrals (ERIs) over a given
basis set using the conventional algorithm which is very slow compared to Rys quadrature. 
It supports symmetric integral evaluation and allows slicing the full ERI matrix into 
blocks for efficient parallelization or chunked computation.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : Basis
    A basis object containing basis function information such as:
    coordinates, exponents, coefficients, angular momentum, normalization factors,
    and number of primitives.</p>

<p>slice : list of int, optional
    A list of four integers [start_row, end_row, start_col, end_col] specifying
    a block (subset) of the full integral matrix to compute.
    If not provided, the full matrix is computed.</p>

<h2 id="returns">Returns</h2>

<p>ints2c2e : np.ndarray
    A 2D numpy array containing the computed 2c2e integrals for the specified slice.</p>
</div>


                </section>
                <section id="rys_2c2e_symm">
                            <input id="rys_2c2e_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_2c2e_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_2c2e_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_2c2e_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_2c2e_symm-8"><a href="#rys_2c2e_symm-8"><span class="linenos"> 8</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_2c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_2c2e_symm-9"><a href="#rys_2c2e_symm-9"><span class="linenos"> 9</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="rys_2c2e_symm-10"><a href="#rys_2c2e_symm-10"><span class="linenos">10</span></a><span class="sd">    Compute symmetric two-center two-electron integrals using Rys quadrature.</span>
</span><span id="rys_2c2e_symm-11"><a href="#rys_2c2e_symm-11"><span class="linenos">11</span></a>
</span><span id="rys_2c2e_symm-12"><a href="#rys_2c2e_symm-12"><span class="linenos">12</span></a><span class="sd">    This function evaluates the electron repulsion integrals (ERIs)</span>
</span><span id="rys_2c2e_symm-13"><a href="#rys_2c2e_symm-13"><span class="linenos">13</span></a><span class="sd">    involving only two centers (2c2e), using the Rys quadrature method. </span>
</span><span id="rys_2c2e_symm-14"><a href="#rys_2c2e_symm-14"><span class="linenos">14</span></a><span class="sd">    The integrals are computed efficiently using Numba, and the data is prepared </span>
</span><span id="rys_2c2e_symm-15"><a href="#rys_2c2e_symm-15"><span class="linenos">15</span></a><span class="sd">    accordingly for compatibility with JIT compilation. It assumes symmetry, </span>
</span><span id="rys_2c2e_symm-16"><a href="#rys_2c2e_symm-16"><span class="linenos">16</span></a><span class="sd">    and computes only a specified block if requested.</span>
</span><span id="rys_2c2e_symm-17"><a href="#rys_2c2e_symm-17"><span class="linenos">17</span></a>
</span><span id="rys_2c2e_symm-18"><a href="#rys_2c2e_symm-18"><span class="linenos">18</span></a><span class="sd">    Parameters</span>
</span><span id="rys_2c2e_symm-19"><a href="#rys_2c2e_symm-19"><span class="linenos">19</span></a><span class="sd">    ----------</span>
</span><span id="rys_2c2e_symm-20"><a href="#rys_2c2e_symm-20"><span class="linenos">20</span></a><span class="sd">    basis : object</span>
</span><span id="rys_2c2e_symm-21"><a href="#rys_2c2e_symm-21"><span class="linenos">21</span></a><span class="sd">        A basis set object containing the basis function data. It must have attributes:</span>
</span><span id="rys_2c2e_symm-22"><a href="#rys_2c2e_symm-22"><span class="linenos">22</span></a><span class="sd">        - bfs_coords : list of (x, y, z) coordinates of basis function centers</span>
</span><span id="rys_2c2e_symm-23"><a href="#rys_2c2e_symm-23"><span class="linenos">23</span></a><span class="sd">        - bfs_contr_prim_norms : contraction-normalization factors</span>
</span><span id="rys_2c2e_symm-24"><a href="#rys_2c2e_symm-24"><span class="linenos">24</span></a><span class="sd">        - bfs_lmn : angular momentum tuples (l, m, n)</span>
</span><span id="rys_2c2e_symm-25"><a href="#rys_2c2e_symm-25"><span class="linenos">25</span></a><span class="sd">        - bfs_nprim : number of primitives for each basis function</span>
</span><span id="rys_2c2e_symm-26"><a href="#rys_2c2e_symm-26"><span class="linenos">26</span></a><span class="sd">        - bfs_coeffs : contraction coefficients</span>
</span><span id="rys_2c2e_symm-27"><a href="#rys_2c2e_symm-27"><span class="linenos">27</span></a><span class="sd">        - bfs_expnts : primitive exponents</span>
</span><span id="rys_2c2e_symm-28"><a href="#rys_2c2e_symm-28"><span class="linenos">28</span></a><span class="sd">        - bfs_prim_norms : primitive normalization constants</span>
</span><span id="rys_2c2e_symm-29"><a href="#rys_2c2e_symm-29"><span class="linenos">29</span></a><span class="sd">        - bfs_nao : total number of atomic orbitals (basis functions)</span>
</span><span id="rys_2c2e_symm-30"><a href="#rys_2c2e_symm-30"><span class="linenos">30</span></a>
</span><span id="rys_2c2e_symm-31"><a href="#rys_2c2e_symm-31"><span class="linenos">31</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="rys_2c2e_symm-32"><a href="#rys_2c2e_symm-32"><span class="linenos">32</span></a><span class="sd">        A four-element list `[start_row, end_row, start_col, end_col]` specifying the </span>
</span><span id="rys_2c2e_symm-33"><a href="#rys_2c2e_symm-33"><span class="linenos">33</span></a><span class="sd">        row and column ranges of the matrix to be computed. If None, the full matrix </span>
</span><span id="rys_2c2e_symm-34"><a href="#rys_2c2e_symm-34"><span class="linenos">34</span></a><span class="sd">        is computed.</span>
</span><span id="rys_2c2e_symm-35"><a href="#rys_2c2e_symm-35"><span class="linenos">35</span></a>
</span><span id="rys_2c2e_symm-36"><a href="#rys_2c2e_symm-36"><span class="linenos">36</span></a><span class="sd">    Returns</span>
</span><span id="rys_2c2e_symm-37"><a href="#rys_2c2e_symm-37"><span class="linenos">37</span></a><span class="sd">    -------</span>
</span><span id="rys_2c2e_symm-38"><a href="#rys_2c2e_symm-38"><span class="linenos">38</span></a><span class="sd">    ints2c2e : ndarray</span>
</span><span id="rys_2c2e_symm-39"><a href="#rys_2c2e_symm-39"><span class="linenos">39</span></a><span class="sd">        A 2D numpy array of shape `(end_row - start_row, end_col - start_col)` </span>
</span><span id="rys_2c2e_symm-40"><a href="#rys_2c2e_symm-40"><span class="linenos">40</span></a><span class="sd">        containing the computed symmetric two-center two-electron integrals.</span>
</span><span id="rys_2c2e_symm-41"><a href="#rys_2c2e_symm-41"><span class="linenos">41</span></a>
</span><span id="rys_2c2e_symm-42"><a href="#rys_2c2e_symm-42"><span class="linenos">42</span></a><span class="sd">    Notes</span>
</span><span id="rys_2c2e_symm-43"><a href="#rys_2c2e_symm-43"><span class="linenos">43</span></a><span class="sd">    -----</span>
</span><span id="rys_2c2e_symm-44"><a href="#rys_2c2e_symm-44"><span class="linenos">44</span></a><span class="sd">    This function prepares the basis set data in a Numba-friendly format by </span>
</span><span id="rys_2c2e_symm-45"><a href="#rys_2c2e_symm-45"><span class="linenos">45</span></a><span class="sd">    converting ragged lists into padded 2D arrays, where the second dimension </span>
</span><span id="rys_2c2e_symm-46"><a href="#rys_2c2e_symm-46"><span class="linenos">46</span></a><span class="sd">    corresponds to the maximum number of primitives. The core integral computation </span>
</span><span id="rys_2c2e_symm-47"><a href="#rys_2c2e_symm-47"><span class="linenos">47</span></a><span class="sd">    is offloaded to a Numba-accelerated function `rys_2c2e_symm_internal`.</span>
</span><span id="rys_2c2e_symm-48"><a href="#rys_2c2e_symm-48"><span class="linenos">48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="rys_2c2e_symm-49"><a href="#rys_2c2e_symm-49"><span class="linenos">49</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_2c2e_symm-50"><a href="#rys_2c2e_symm-50"><span class="linenos">50</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_2c2e_symm-51"><a href="#rys_2c2e_symm-51"><span class="linenos">51</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="rys_2c2e_symm-52"><a href="#rys_2c2e_symm-52"><span class="linenos">52</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="rys_2c2e_symm-53"><a href="#rys_2c2e_symm-53"><span class="linenos">53</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_2c2e_symm-54"><a href="#rys_2c2e_symm-54"><span class="linenos">54</span></a>    
</span><span id="rys_2c2e_symm-55"><a href="#rys_2c2e_symm-55"><span class="linenos">55</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="rys_2c2e_symm-56"><a href="#rys_2c2e_symm-56"><span class="linenos">56</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="rys_2c2e_symm-57"><a href="#rys_2c2e_symm-57"><span class="linenos">57</span></a>    <span class="c1"># and so on.</span>
</span><span id="rys_2c2e_symm-58"><a href="#rys_2c2e_symm-58"><span class="linenos">58</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="rys_2c2e_symm-59"><a href="#rys_2c2e_symm-59"><span class="linenos">59</span></a>
</span><span id="rys_2c2e_symm-60"><a href="#rys_2c2e_symm-60"><span class="linenos">60</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_2c2e_symm-61"><a href="#rys_2c2e_symm-61"><span class="linenos">61</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-62"><a href="#rys_2c2e_symm-62"><span class="linenos">62</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-63"><a href="#rys_2c2e_symm-63"><span class="linenos">63</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-64"><a href="#rys_2c2e_symm-64"><span class="linenos">64</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-65"><a href="#rys_2c2e_symm-65"><span class="linenos">65</span></a>
</span><span id="rys_2c2e_symm-66"><a href="#rys_2c2e_symm-66"><span class="linenos">66</span></a>        
</span><span id="rys_2c2e_symm-67"><a href="#rys_2c2e_symm-67"><span class="linenos">67</span></a>
</span><span id="rys_2c2e_symm-68"><a href="#rys_2c2e_symm-68"><span class="linenos">68</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_2c2e_symm-69"><a href="#rys_2c2e_symm-69"><span class="linenos">69</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_2c2e_symm-70"><a href="#rys_2c2e_symm-70"><span class="linenos">70</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_2c2e_symm-71"><a href="#rys_2c2e_symm-71"><span class="linenos">71</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_2c2e_symm-72"><a href="#rys_2c2e_symm-72"><span class="linenos">72</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_2c2e_symm-73"><a href="#rys_2c2e_symm-73"><span class="linenos">73</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_2c2e_symm-74"><a href="#rys_2c2e_symm-74"><span class="linenos">74</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-75"><a href="#rys_2c2e_symm-75"><span class="linenos">75</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-76"><a href="#rys_2c2e_symm-76"><span class="linenos">76</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm-77"><a href="#rys_2c2e_symm-77"><span class="linenos">77</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_2c2e_symm-78"><a href="#rys_2c2e_symm-78"><span class="linenos">78</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_2c2e_symm-79"><a href="#rys_2c2e_symm-79"><span class="linenos">79</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm-80"><a href="#rys_2c2e_symm-80"><span class="linenos">80</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm-81"><a href="#rys_2c2e_symm-81"><span class="linenos">81</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm-82"><a href="#rys_2c2e_symm-82"><span class="linenos">82</span></a>
</span><span id="rys_2c2e_symm-83"><a href="#rys_2c2e_symm-83"><span class="linenos">83</span></a>            
</span><span id="rys_2c2e_symm-84"><a href="#rys_2c2e_symm-84"><span class="linenos">84</span></a>
</span><span id="rys_2c2e_symm-85"><a href="#rys_2c2e_symm-85"><span class="linenos">85</span></a>        
</span><span id="rys_2c2e_symm-86"><a href="#rys_2c2e_symm-86"><span class="linenos">86</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_2c2e_symm-87"><a href="#rys_2c2e_symm-87"><span class="linenos">87</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_2c2e_symm-88"><a href="#rys_2c2e_symm-88"><span class="linenos">88</span></a>        
</span><span id="rys_2c2e_symm-89"><a href="#rys_2c2e_symm-89"><span class="linenos">89</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="rys_2c2e_symm-90"><a href="#rys_2c2e_symm-90"><span class="linenos">90</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="rys_2c2e_symm-91"><a href="#rys_2c2e_symm-91"><span class="linenos">91</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="rys_2c2e_symm-92"><a href="#rys_2c2e_symm-92"><span class="linenos">92</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="rys_2c2e_symm-93"><a href="#rys_2c2e_symm-93"><span class="linenos">93</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="rys_2c2e_symm-94"><a href="#rys_2c2e_symm-94"><span class="linenos">94</span></a>
</span><span id="rys_2c2e_symm-95"><a href="#rys_2c2e_symm-95"><span class="linenos">95</span></a>    <span class="n">ints2c2e</span> <span class="o">=</span> <span class="n">rys_2c2e_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">)</span>
</span><span id="rys_2c2e_symm-96"><a href="#rys_2c2e_symm-96"><span class="linenos">96</span></a>    <span class="k">return</span> <span class="n">ints2c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute symmetric two-center two-electron integrals using Rys quadrature.</p>

<p>This function evaluates the electron repulsion integrals (ERIs)
involving only two centers (2c2e), using the Rys quadrature method. 
The integrals are computed efficiently using Numba, and the data is prepared 
accordingly for compatibility with JIT compilation. It assumes symmetry, 
and computes only a specified block if requested.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    A basis set object containing the basis function data. It must have attributes:
    - bfs_coords : list of (x, y, z) coordinates of basis function centers
    - bfs_contr_prim_norms : contraction-normalization factors
    - bfs_lmn : angular momentum tuples (l, m, n)
    - bfs_nprim : number of primitives for each basis function
    - bfs_coeffs : contraction coefficients
    - bfs_expnts : primitive exponents
    - bfs_prim_norms : primitive normalization constants
    - bfs_nao : total number of atomic orbitals (basis functions)</p>

<p>slice : list of int, optional
    A four-element list <code>[start_row, end_row, start_col, end_col]</code> specifying the 
    row and column ranges of the matrix to be computed. If None, the full matrix 
    is computed.</p>

<h2 id="returns">Returns</h2>

<p>ints2c2e : ndarray
    A 2D numpy array of shape <code>(end_row - start_row, end_col - start_col)</code> 
    containing the computed symmetric two-center two-electron integrals.</p>

<h2 id="notes">Notes</h2>

<p>This function prepares the basis set data in a Numba-friendly format by 
converting ragged lists into padded 2D arrays, where the second dimension 
corresponds to the maximum number of primitives. The core integral computation 
is offloaded to a Numba-accelerated function <code>rys_2c2e_symm_internal</code>.</p>
</div>


                </section>
                <section id="rys_3c2e_tri">
                            <input id="rys_3c2e_tri-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_3c2e_tri</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">auxbasis</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_3c2e_tri-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_3c2e_tri"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_3c2e_tri-9"><a href="#rys_3c2e_tri-9"><span class="linenos">  9</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_3c2e_tri</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">):</span>
</span><span id="rys_3c2e_tri-10"><a href="#rys_3c2e_tri-10"><span class="linenos"> 10</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="rys_3c2e_tri-11"><a href="#rys_3c2e_tri-11"><span class="linenos"> 11</span></a><span class="sd">    Compute three-center two-electron (3c2e) electron repulsion integrals using</span>
</span><span id="rys_3c2e_tri-12"><a href="#rys_3c2e_tri-12"><span class="linenos"> 12</span></a><span class="sd">    the Rys quadrature method with symmetry considerations, stored in packed</span>
</span><span id="rys_3c2e_tri-13"><a href="#rys_3c2e_tri-13"><span class="linenos"> 13</span></a><span class="sd">    triangular form for memory efficiency.</span>
</span><span id="rys_3c2e_tri-14"><a href="#rys_3c2e_tri-14"><span class="linenos"> 14</span></a>
</span><span id="rys_3c2e_tri-15"><a href="#rys_3c2e_tri-15"><span class="linenos"> 15</span></a><span class="sd">    This function evaluates integrals of the form (A B | C), where A and B are</span>
</span><span id="rys_3c2e_tri-16"><a href="#rys_3c2e_tri-16"><span class="linenos"> 16</span></a><span class="sd">    basis functions from a primary basis set and C is from an auxiliary basis set.</span>
</span><span id="rys_3c2e_tri-17"><a href="#rys_3c2e_tri-17"><span class="linenos"> 17</span></a><span class="sd">    Symmetry in the first two indices is exploited ((A B | C) = (B A | C)),</span>
</span><span id="rys_3c2e_tri-18"><a href="#rys_3c2e_tri-18"><span class="linenos"> 18</span></a><span class="sd">    so only the upper-triangular part of the (A,B) block is computed and stored.</span>
</span><span id="rys_3c2e_tri-19"><a href="#rys_3c2e_tri-19"><span class="linenos"> 19</span></a><span class="sd">    The resulting array has shape (N_{bf}*(N_{bf}+1)/2, N_{auxbf}), where the first</span>
</span><span id="rys_3c2e_tri-20"><a href="#rys_3c2e_tri-20"><span class="linenos"> 20</span></a><span class="sd">    index corresponds to a flattened 1D triangular index over basis function pairs.</span>
</span><span id="rys_3c2e_tri-21"><a href="#rys_3c2e_tri-21"><span class="linenos"> 21</span></a>
</span><span id="rys_3c2e_tri-22"><a href="#rys_3c2e_tri-22"><span class="linenos"> 22</span></a><span class="sd">    Unlike `rys_3c2e_symm`, this routine does not support computing arbitrary slices</span>
</span><span id="rys_3c2e_tri-23"><a href="#rys_3c2e_tri-23"><span class="linenos"> 23</span></a><span class="sd">    — the full triangular set is always evaluated.</span>
</span><span id="rys_3c2e_tri-24"><a href="#rys_3c2e_tri-24"><span class="linenos"> 24</span></a>
</span><span id="rys_3c2e_tri-25"><a href="#rys_3c2e_tri-25"><span class="linenos"> 25</span></a><span class="sd">    Parameters</span>
</span><span id="rys_3c2e_tri-26"><a href="#rys_3c2e_tri-26"><span class="linenos"> 26</span></a><span class="sd">    ----------</span>
</span><span id="rys_3c2e_tri-27"><a href="#rys_3c2e_tri-27"><span class="linenos"> 27</span></a><span class="sd">    basis : object</span>
</span><span id="rys_3c2e_tri-28"><a href="#rys_3c2e_tri-28"><span class="linenos"> 28</span></a><span class="sd">        Primary basis set object containing information about atomic orbitals, such as:</span>
</span><span id="rys_3c2e_tri-29"><a href="#rys_3c2e_tri-29"><span class="linenos"> 29</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of basis function centers.</span>
</span><span id="rys_3c2e_tri-30"><a href="#rys_3c2e_tri-30"><span class="linenos"> 30</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients.</span>
</span><span id="rys_3c2e_tri-31"><a href="#rys_3c2e_tri-31"><span class="linenos"> 31</span></a><span class="sd">        - bfs_expnts : Gaussian exponents.</span>
</span><span id="rys_3c2e_tri-32"><a href="#rys_3c2e_tri-32"><span class="linenos"> 32</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants.</span>
</span><span id="rys_3c2e_tri-33"><a href="#rys_3c2e_tri-33"><span class="linenos"> 33</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors.</span>
</span><span id="rys_3c2e_tri-34"><a href="#rys_3c2e_tri-34"><span class="linenos"> 34</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).</span>
</span><span id="rys_3c2e_tri-35"><a href="#rys_3c2e_tri-35"><span class="linenos"> 35</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function.</span>
</span><span id="rys_3c2e_tri-36"><a href="#rys_3c2e_tri-36"><span class="linenos"> 36</span></a><span class="sd">        - bfs_nao : Total number of atomic orbitals.</span>
</span><span id="rys_3c2e_tri-37"><a href="#rys_3c2e_tri-37"><span class="linenos"> 37</span></a>
</span><span id="rys_3c2e_tri-38"><a href="#rys_3c2e_tri-38"><span class="linenos"> 38</span></a><span class="sd">    auxbasis : object</span>
</span><span id="rys_3c2e_tri-39"><a href="#rys_3c2e_tri-39"><span class="linenos"> 39</span></a><span class="sd">        Auxiliary basis set object with the same attributes as `basis`,</span>
</span><span id="rys_3c2e_tri-40"><a href="#rys_3c2e_tri-40"><span class="linenos"> 40</span></a><span class="sd">        typically used for resolution-of-the-identity (RI) expansions.</span>
</span><span id="rys_3c2e_tri-41"><a href="#rys_3c2e_tri-41"><span class="linenos"> 41</span></a>
</span><span id="rys_3c2e_tri-42"><a href="#rys_3c2e_tri-42"><span class="linenos"> 42</span></a><span class="sd">    Returns</span>
</span><span id="rys_3c2e_tri-43"><a href="#rys_3c2e_tri-43"><span class="linenos"> 43</span></a><span class="sd">    -------</span>
</span><span id="rys_3c2e_tri-44"><a href="#rys_3c2e_tri-44"><span class="linenos"> 44</span></a><span class="sd">    ints3c2e : ndarray of shape (Nbf*(Nbf+1)//2, Nauxbf)</span>
</span><span id="rys_3c2e_tri-45"><a href="#rys_3c2e_tri-45"><span class="linenos"> 45</span></a><span class="sd">        The computed 3-center 2-electron integrals in packed triangular form.</span>
</span><span id="rys_3c2e_tri-46"><a href="#rys_3c2e_tri-46"><span class="linenos"> 46</span></a><span class="sd">        The mapping from a pair (i, j) with i ≤ j to the first dimension index</span>
</span><span id="rys_3c2e_tri-47"><a href="#rys_3c2e_tri-47"><span class="linenos"> 47</span></a><span class="sd">        follows standard upper-triangular packing order.</span>
</span><span id="rys_3c2e_tri-48"><a href="#rys_3c2e_tri-48"><span class="linenos"> 48</span></a>
</span><span id="rys_3c2e_tri-49"><a href="#rys_3c2e_tri-49"><span class="linenos"> 49</span></a><span class="sd">    Notes</span>
</span><span id="rys_3c2e_tri-50"><a href="#rys_3c2e_tri-50"><span class="linenos"> 50</span></a><span class="sd">    -----</span>
</span><span id="rys_3c2e_tri-51"><a href="#rys_3c2e_tri-51"><span class="linenos"> 51</span></a><span class="sd">    - This is a memory-efficient variant of `rys_3c2e_symm` that avoids storing</span>
</span><span id="rys_3c2e_tri-52"><a href="#rys_3c2e_tri-52"><span class="linenos"> 52</span></a><span class="sd">      the full (Nbf, Nbf, Nauxbf) array.</span>
</span><span id="rys_3c2e_tri-53"><a href="#rys_3c2e_tri-53"><span class="linenos"> 53</span></a><span class="sd">    - Uses preallocated NumPy arrays for primitive data to ensure efficient Numba processing.</span>
</span><span id="rys_3c2e_tri-54"><a href="#rys_3c2e_tri-54"><span class="linenos"> 54</span></a><span class="sd">    - Handles irregular contraction patterns by padding primitive arrays to the size</span>
</span><span id="rys_3c2e_tri-55"><a href="#rys_3c2e_tri-55"><span class="linenos"> 55</span></a><span class="sd">      of the largest contraction in the set.</span>
</span><span id="rys_3c2e_tri-56"><a href="#rys_3c2e_tri-56"><span class="linenos"> 56</span></a><span class="sd">    - No Schwarz screening or partial computation is available in this function.</span>
</span><span id="rys_3c2e_tri-57"><a href="#rys_3c2e_tri-57"><span class="linenos"> 57</span></a>
</span><span id="rys_3c2e_tri-58"><a href="#rys_3c2e_tri-58"><span class="linenos"> 58</span></a><span class="sd">    Examples</span>
</span><span id="rys_3c2e_tri-59"><a href="#rys_3c2e_tri-59"><span class="linenos"> 59</span></a><span class="sd">    --------</span>
</span><span id="rys_3c2e_tri-60"><a href="#rys_3c2e_tri-60"><span class="linenos"> 60</span></a><span class="sd">    &gt;&gt;&gt; ints_tri = rys_3c2e_tri(basis, auxbasis)</span>
</span><span id="rys_3c2e_tri-61"><a href="#rys_3c2e_tri-61"><span class="linenos"> 61</span></a><span class="sd">    &gt;&gt;&gt; # Retrieve value for pair (i, j) and auxiliary k:</span>
</span><span id="rys_3c2e_tri-62"><a href="#rys_3c2e_tri-62"><span class="linenos"> 62</span></a><span class="sd">    &gt;&gt;&gt; def packed_index(i, j, Nbf):</span>
</span><span id="rys_3c2e_tri-63"><a href="#rys_3c2e_tri-63"><span class="linenos"> 63</span></a><span class="sd">    ...     if i &gt; j:</span>
</span><span id="rys_3c2e_tri-64"><a href="#rys_3c2e_tri-64"><span class="linenos"> 64</span></a><span class="sd">    ...         i, j = j, i</span>
</span><span id="rys_3c2e_tri-65"><a href="#rys_3c2e_tri-65"><span class="linenos"> 65</span></a><span class="sd">    ...     return i * Nbf - i*(i-1)//2 + (j - i)</span>
</span><span id="rys_3c2e_tri-66"><a href="#rys_3c2e_tri-66"><span class="linenos"> 66</span></a><span class="sd">    &gt;&gt;&gt; val = ints_tri[packed_index(i, j, basis.bfs_nao), k]</span>
</span><span id="rys_3c2e_tri-67"><a href="#rys_3c2e_tri-67"><span class="linenos"> 67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="rys_3c2e_tri-68"><a href="#rys_3c2e_tri-68"><span class="linenos"> 68</span></a>    <span class="c1"># This is a memory efficient version of the rys_3c2e_symm().</span>
</span><span id="rys_3c2e_tri-69"><a href="#rys_3c2e_tri-69"><span class="linenos"> 69</span></a>    <span class="c1"># Instead of returning an array of shape (Nbf, Nbf, Nauxbf) it returns</span>
</span><span id="rys_3c2e_tri-70"><a href="#rys_3c2e_tri-70"><span class="linenos"> 70</span></a>    <span class="c1"># an array of shape (Nbf*(Nbf+1)/2, Nauxbf), where the first index corresponds to the</span>
</span><span id="rys_3c2e_tri-71"><a href="#rys_3c2e_tri-71"><span class="linenos"> 71</span></a>    <span class="c1"># 1D triangular matrix.</span>
</span><span id="rys_3c2e_tri-72"><a href="#rys_3c2e_tri-72"><span class="linenos"> 72</span></a>
</span><span id="rys_3c2e_tri-73"><a href="#rys_3c2e_tri-73"><span class="linenos"> 73</span></a>    <span class="c1"># You cannot provide a slice here to calculate only a subset.</span>
</span><span id="rys_3c2e_tri-74"><a href="#rys_3c2e_tri-74"><span class="linenos"> 74</span></a>
</span><span id="rys_3c2e_tri-75"><a href="#rys_3c2e_tri-75"><span class="linenos"> 75</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_3c2e_tri-76"><a href="#rys_3c2e_tri-76"><span class="linenos"> 76</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_3c2e_tri-77"><a href="#rys_3c2e_tri-77"><span class="linenos"> 77</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="rys_3c2e_tri-78"><a href="#rys_3c2e_tri-78"><span class="linenos"> 78</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="rys_3c2e_tri-79"><a href="#rys_3c2e_tri-79"><span class="linenos"> 79</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_3c2e_tri-80"><a href="#rys_3c2e_tri-80"><span class="linenos"> 80</span></a>
</span><span id="rys_3c2e_tri-81"><a href="#rys_3c2e_tri-81"><span class="linenos"> 81</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_tri-82"><a href="#rys_3c2e_tri-82"><span class="linenos"> 82</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-83"><a href="#rys_3c2e_tri-83"><span class="linenos"> 83</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-84"><a href="#rys_3c2e_tri-84"><span class="linenos"> 84</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-85"><a href="#rys_3c2e_tri-85"><span class="linenos"> 85</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-86"><a href="#rys_3c2e_tri-86"><span class="linenos"> 86</span></a>
</span><span id="rys_3c2e_tri-87"><a href="#rys_3c2e_tri-87"><span class="linenos"> 87</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_tri-88"><a href="#rys_3c2e_tri-88"><span class="linenos"> 88</span></a>    <span class="n">aux_bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-89"><a href="#rys_3c2e_tri-89"><span class="linenos"> 89</span></a>    <span class="n">aux_bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-90"><a href="#rys_3c2e_tri-90"><span class="linenos"> 90</span></a>    <span class="n">aux_bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-91"><a href="#rys_3c2e_tri-91"><span class="linenos"> 91</span></a>    <span class="n">aux_bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-92"><a href="#rys_3c2e_tri-92"><span class="linenos"> 92</span></a>        
</span><span id="rys_3c2e_tri-93"><a href="#rys_3c2e_tri-93"><span class="linenos"> 93</span></a>
</span><span id="rys_3c2e_tri-94"><a href="#rys_3c2e_tri-94"><span class="linenos"> 94</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_3c2e_tri-95"><a href="#rys_3c2e_tri-95"><span class="linenos"> 95</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_3c2e_tri-96"><a href="#rys_3c2e_tri-96"><span class="linenos"> 96</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_3c2e_tri-97"><a href="#rys_3c2e_tri-97"><span class="linenos"> 97</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_3c2e_tri-98"><a href="#rys_3c2e_tri-98"><span class="linenos"> 98</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_3c2e_tri-99"><a href="#rys_3c2e_tri-99"><span class="linenos"> 99</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_tri-100"><a href="#rys_3c2e_tri-100"><span class="linenos">100</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-101"><a href="#rys_3c2e_tri-101"><span class="linenos">101</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-102"><a href="#rys_3c2e_tri-102"><span class="linenos">102</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-103"><a href="#rys_3c2e_tri-103"><span class="linenos">103</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_tri-104"><a href="#rys_3c2e_tri-104"><span class="linenos">104</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_tri-105"><a href="#rys_3c2e_tri-105"><span class="linenos">105</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-106"><a href="#rys_3c2e_tri-106"><span class="linenos">106</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-107"><a href="#rys_3c2e_tri-107"><span class="linenos">107</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-108"><a href="#rys_3c2e_tri-108"><span class="linenos">108</span></a>
</span><span id="rys_3c2e_tri-109"><a href="#rys_3c2e_tri-109"><span class="linenos">109</span></a>    <span class="n">maxnprimaux</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_tri-110"><a href="#rys_3c2e_tri-110"><span class="linenos">110</span></a>    <span class="n">aux_bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-111"><a href="#rys_3c2e_tri-111"><span class="linenos">111</span></a>    <span class="n">aux_bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-112"><a href="#rys_3c2e_tri-112"><span class="linenos">112</span></a>    <span class="n">aux_bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_tri-113"><a href="#rys_3c2e_tri-113"><span class="linenos">113</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_tri-114"><a href="#rys_3c2e_tri-114"><span class="linenos">114</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_tri-115"><a href="#rys_3c2e_tri-115"><span class="linenos">115</span></a>            <span class="n">aux_bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-116"><a href="#rys_3c2e_tri-116"><span class="linenos">116</span></a>            <span class="n">aux_bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-117"><a href="#rys_3c2e_tri-117"><span class="linenos">117</span></a>            <span class="n">aux_bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_tri-118"><a href="#rys_3c2e_tri-118"><span class="linenos">118</span></a>            
</span><span id="rys_3c2e_tri-119"><a href="#rys_3c2e_tri-119"><span class="linenos">119</span></a>
</span><span id="rys_3c2e_tri-120"><a href="#rys_3c2e_tri-120"><span class="linenos">120</span></a>    <span class="n">ints3c2e</span> <span class="o">=</span> <span class="n">rys_3c2e_tri_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span><span class="n">aux_bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_coeffs</span><span class="p">,</span> <span class="n">aux_bfs_prim_norms</span><span class="p">,</span> <span class="n">aux_bfs_expnts</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="rys_3c2e_tri-121"><a href="#rys_3c2e_tri-121"><span class="linenos">121</span></a>    <span class="k">return</span> <span class="n">ints3c2e</span>
</span></pre></div>


            <div class="docstring"><p>Compute three-center two-electron (3c2e) electron repulsion integrals using
the Rys quadrature method with symmetry considerations, stored in packed
triangular form for memory efficiency.</p>

<p>This function evaluates integrals of the form (A B | C), where A and B are
basis functions from a primary basis set and C is from an auxiliary basis set.
Symmetry in the first two indices is exploited ((A B | C) = (B A | C)),
so only the upper-triangular part of the (A,B) block is computed and stored.
The resulting array has shape (N_{bf}*(N_{bf}+1)/2, N_{auxbf}), where the first
index corresponds to a flattened 1D triangular index over basis function pairs.</p>

<p>Unlike <code><a href="#rys_3c2e_symm">rys_3c2e_symm</a></code>, this routine does not support computing arbitrary slices
— the full triangular set is always evaluated.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Primary basis set object containing information about atomic orbitals, such as:
    - bfs_coords : Cartesian coordinates of basis function centers.
    - bfs_coeffs : Contraction coefficients.
    - bfs_expnts : Gaussian exponents.
    - bfs_prim_norms : Primitive normalization constants.
    - bfs_contr_prim_norms : Contraction normalization factors.
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n).
    - bfs_nprim : Number of primitives per basis function.
    - bfs_nao : Total number of atomic orbitals.</p>

<p>auxbasis : object
    Auxiliary basis set object with the same attributes as <code>basis</code>,
    typically used for resolution-of-the-identity (RI) expansions.</p>

<h2 id="returns">Returns</h2>

<p>ints3c2e : ndarray of shape (Nbf*(Nbf+1)//2, Nauxbf)
    The computed 3-center 2-electron integrals in packed triangular form.
    The mapping from a pair (i, j) with i ≤ j to the first dimension index
    follows standard upper-triangular packing order.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>This is a memory-efficient variant of <code><a href="#rys_3c2e_symm">rys_3c2e_symm</a></code> that avoids storing
the full (Nbf, Nbf, Nauxbf) array.</li>
<li>Uses preallocated NumPy arrays for primitive data to ensure efficient Numba processing.</li>
<li>Handles irregular contraction patterns by padding primitive arrays to the size
of the largest contraction in the set.</li>
<li>No Schwarz screening or partial computation is available in this function.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">ints_tri</span> <span class="o">=</span> <span class="n">rys_3c2e_tri</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Retrieve value for pair (i, j) and auxiliary k:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">packed_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Nbf</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">Nbf</span> <span class="o">-</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">val</span> <span class="o">=</span> <span class="n">ints_tri</span><span class="p">[</span><span class="n">packed_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">),</span> <span class="n">k</span><span class="p">]</span>
</code></pre>
</div>
</div>


                </section>
                <section id="rys_nuc_mat_symm">
                            <input id="rys_nuc_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_nuc_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">mol</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_nuc_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_nuc_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_nuc_mat_symm-9"><a href="#rys_nuc_mat_symm-9"><span class="linenos"> 9</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_nuc_mat_symm-10"><a href="#rys_nuc_mat_symm-10"><span class="linenos">10</span></a>    <span class="c1"># Uses the rys 3c2e algorithm to calculate the nuclear attraction integrals by making one of the basis function as a steep/sharp s-primitive gaussian</span>
</span><span id="rys_nuc_mat_symm-11"><a href="#rys_nuc_mat_symm-11"><span class="linenos">11</span></a>    <span class="c1"># Ref: https://arxiv.org/pdf/2302.11307.pdf</span>
</span><span id="rys_nuc_mat_symm-12"><a href="#rys_nuc_mat_symm-12"><span class="linenos">12</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_nuc_mat_symm-13"><a href="#rys_nuc_mat_symm-13"><span class="linenos">13</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_nuc_mat_symm-14"><a href="#rys_nuc_mat_symm-14"><span class="linenos">14</span></a>    <span class="c1"># function that uses prange, etc. to calculate the 3c2e integrals efficiently.</span>
</span><span id="rys_nuc_mat_symm-15"><a href="#rys_nuc_mat_symm-15"><span class="linenos">15</span></a>    <span class="c1"># This function calculates the 3c2e electron-electron ERIs for a given basis object and auxbasis object.</span>
</span><span id="rys_nuc_mat_symm-16"><a href="#rys_nuc_mat_symm-16"><span class="linenos">16</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_nuc_mat_symm-17"><a href="#rys_nuc_mat_symm-17"><span class="linenos">17</span></a>    
</span><span id="rys_nuc_mat_symm-18"><a href="#rys_nuc_mat_symm-18"><span class="linenos">18</span></a>
</span><span id="rys_nuc_mat_symm-19"><a href="#rys_nuc_mat_symm-19"><span class="linenos">19</span></a>    <span class="c1"># It is possible to only calculate a slice (block/subset) of the complete set of integrals.</span>
</span><span id="rys_nuc_mat_symm-20"><a href="#rys_nuc_mat_symm-20"><span class="linenos">20</span></a>    <span class="c1"># slice is a 6 element list whose first and second elements give the range of the A functions to be calculated.</span>
</span><span id="rys_nuc_mat_symm-21"><a href="#rys_nuc_mat_symm-21"><span class="linenos">21</span></a>    <span class="c1"># and so on.</span>
</span><span id="rys_nuc_mat_symm-22"><a href="#rys_nuc_mat_symm-22"><span class="linenos">22</span></a>    <span class="c1"># slice = [indx_startA, indx_endA, indx_startB, indx_endB, indx_startC, indx_endC]</span>
</span><span id="rys_nuc_mat_symm-23"><a href="#rys_nuc_mat_symm-23"><span class="linenos">23</span></a>
</span><span id="rys_nuc_mat_symm-24"><a href="#rys_nuc_mat_symm-24"><span class="linenos">24</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_nuc_mat_symm-25"><a href="#rys_nuc_mat_symm-25"><span class="linenos">25</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-26"><a href="#rys_nuc_mat_symm-26"><span class="linenos">26</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-27"><a href="#rys_nuc_mat_symm-27"><span class="linenos">27</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-28"><a href="#rys_nuc_mat_symm-28"><span class="linenos">28</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-29"><a href="#rys_nuc_mat_symm-29"><span class="linenos">29</span></a>
</span><span id="rys_nuc_mat_symm-30"><a href="#rys_nuc_mat_symm-30"><span class="linenos">30</span></a>    <span class="n">coordsBohrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-31"><a href="#rys_nuc_mat_symm-31"><span class="linenos">31</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-32"><a href="#rys_nuc_mat_symm-32"><span class="linenos">32</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span>
</span><span id="rys_nuc_mat_symm-33"><a href="#rys_nuc_mat_symm-33"><span class="linenos">33</span></a>        
</span><span id="rys_nuc_mat_symm-34"><a href="#rys_nuc_mat_symm-34"><span class="linenos">34</span></a>
</span><span id="rys_nuc_mat_symm-35"><a href="#rys_nuc_mat_symm-35"><span class="linenos">35</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_nuc_mat_symm-36"><a href="#rys_nuc_mat_symm-36"><span class="linenos">36</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_nuc_mat_symm-37"><a href="#rys_nuc_mat_symm-37"><span class="linenos">37</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_nuc_mat_symm-38"><a href="#rys_nuc_mat_symm-38"><span class="linenos">38</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_nuc_mat_symm-39"><a href="#rys_nuc_mat_symm-39"><span class="linenos">39</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_nuc_mat_symm-40"><a href="#rys_nuc_mat_symm-40"><span class="linenos">40</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_nuc_mat_symm-41"><a href="#rys_nuc_mat_symm-41"><span class="linenos">41</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-42"><a href="#rys_nuc_mat_symm-42"><span class="linenos">42</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-43"><a href="#rys_nuc_mat_symm-43"><span class="linenos">43</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-44"><a href="#rys_nuc_mat_symm-44"><span class="linenos">44</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_nuc_mat_symm-45"><a href="#rys_nuc_mat_symm-45"><span class="linenos">45</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_nuc_mat_symm-46"><a href="#rys_nuc_mat_symm-46"><span class="linenos">46</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_nuc_mat_symm-47"><a href="#rys_nuc_mat_symm-47"><span class="linenos">47</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_nuc_mat_symm-48"><a href="#rys_nuc_mat_symm-48"><span class="linenos">48</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_nuc_mat_symm-49"><a href="#rys_nuc_mat_symm-49"><span class="linenos">49</span></a>
</span><span id="rys_nuc_mat_symm-50"><a href="#rys_nuc_mat_symm-50"><span class="linenos">50</span></a>            
</span><span id="rys_nuc_mat_symm-51"><a href="#rys_nuc_mat_symm-51"><span class="linenos">51</span></a>
</span><span id="rys_nuc_mat_symm-52"><a href="#rys_nuc_mat_symm-52"><span class="linenos">52</span></a>
</span><span id="rys_nuc_mat_symm-53"><a href="#rys_nuc_mat_symm-53"><span class="linenos">53</span></a>        
</span><span id="rys_nuc_mat_symm-54"><a href="#rys_nuc_mat_symm-54"><span class="linenos">54</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_nuc_mat_symm-55"><a href="#rys_nuc_mat_symm-55"><span class="linenos">55</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_nuc_mat_symm-56"><a href="#rys_nuc_mat_symm-56"><span class="linenos">56</span></a>        
</span><span id="rys_nuc_mat_symm-57"><a href="#rys_nuc_mat_symm-57"><span class="linenos">57</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_nuc_mat_symm-58"><a href="#rys_nuc_mat_symm-58"><span class="linenos">58</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-59"><a href="#rys_nuc_mat_symm-59"><span class="linenos">59</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-60"><a href="#rys_nuc_mat_symm-60"><span class="linenos">60</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-61"><a href="#rys_nuc_mat_symm-61"><span class="linenos">61</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_nuc_mat_symm-62"><a href="#rys_nuc_mat_symm-62"><span class="linenos">62</span></a>
</span><span id="rys_nuc_mat_symm-63"><a href="#rys_nuc_mat_symm-63"><span class="linenos">63</span></a>    <span class="n">ints3c2e</span> <span class="o">=</span> <span class="n">rys_nuc_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordsBohrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">)</span>
</span><span id="rys_nuc_mat_symm-64"><a href="#rys_nuc_mat_symm-64"><span class="linenos">64</span></a>    <span class="k">return</span> <span class="n">ints3c2e</span>
</span></pre></div>


    

                </section>
                <section id="rys_3c2e_tri_schwarzbf_val_helpers">
                    <div class="attr variable">
            <span class="name">rys_3c2e_tri_schwarzbf_val_helpers</span>

        
    </div>
    <a class="headerlink" href="#rys_3c2e_tri_schwarzbf_val_helpers"></a>
    
    

                </section>
                <section id="eval_xc_1">
                            <input id="eval_xc_1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_1</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">50000</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_1-9"><a href="#eval_xc_1-9"><span class="linenos">  9</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_1</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="eval_xc_1-10"><a href="#eval_xc_1-10"><span class="linenos"> 10</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="eval_xc_1-11"><a href="#eval_xc_1-11"><span class="linenos"> 11</span></a><span class="sd">    Evaluate exchange-correlation (XC) energy and potential matrix for DFT</span>
</span><span id="eval_xc_1-12"><a href="#eval_xc_1-12"><span class="linenos"> 12</span></a><span class="sd">    using algorithm 1, which is a baseline method for grid-based DFT.</span>
</span><span id="eval_xc_1-13"><a href="#eval_xc_1-13"><span class="linenos"> 13</span></a>
</span><span id="eval_xc_1-14"><a href="#eval_xc_1-14"><span class="linenos"> 14</span></a><span class="sd">    In algorithm 1, the XC term is evaluated by looping over blocks of grid </span>
</span><span id="eval_xc_1-15"><a href="#eval_xc_1-15"><span class="linenos"> 15</span></a><span class="sd">    points, and within each block, the operations are parallelized. This </span>
</span><span id="eval_xc_1-16"><a href="#eval_xc_1-16"><span class="linenos"> 16</span></a><span class="sd">    approach is functional but generally slower than algorithm 2 for CPU-based </span>
</span><span id="eval_xc_1-17"><a href="#eval_xc_1-17"><span class="linenos"> 17</span></a><span class="sd">    execution.</span>
</span><span id="eval_xc_1-18"><a href="#eval_xc_1-18"><span class="linenos"> 18</span></a>
</span><span id="eval_xc_1-19"><a href="#eval_xc_1-19"><span class="linenos"> 19</span></a><span class="sd">    This function evaluates the XC energy and potential matrix elements for a given</span>
</span><span id="eval_xc_1-20"><a href="#eval_xc_1-20"><span class="linenos"> 20</span></a><span class="sd">    density matrix using numerical integration over a 3D real-space grid. It supports </span>
</span><span id="eval_xc_1-21"><a href="#eval_xc_1-21"><span class="linenos"> 21</span></a><span class="sd">    LDA and GGA functionals via LibXC and optional use of precomputed AO values and </span>
</span><span id="eval_xc_1-22"><a href="#eval_xc_1-22"><span class="linenos"> 22</span></a><span class="sd">    gradients for performance gains. Sparse AO matrix techniques are also supported.</span>
</span><span id="eval_xc_1-23"><a href="#eval_xc_1-23"><span class="linenos"> 23</span></a>
</span><span id="eval_xc_1-24"><a href="#eval_xc_1-24"><span class="linenos"> 24</span></a><span class="sd">    Parameters</span>
</span><span id="eval_xc_1-25"><a href="#eval_xc_1-25"><span class="linenos"> 25</span></a><span class="sd">    ----------</span>
</span><span id="eval_xc_1-26"><a href="#eval_xc_1-26"><span class="linenos"> 26</span></a><span class="sd">    basis : Basis</span>
</span><span id="eval_xc_1-27"><a href="#eval_xc_1-27"><span class="linenos"> 27</span></a><span class="sd">        A basis object containing basis function data: exponents, coefficients, </span>
</span><span id="eval_xc_1-28"><a href="#eval_xc_1-28"><span class="linenos"> 28</span></a><span class="sd">        angular momentum, normalization, and other AO metadata.</span>
</span><span id="eval_xc_1-29"><a href="#eval_xc_1-29"><span class="linenos"> 29</span></a>
</span><span id="eval_xc_1-30"><a href="#eval_xc_1-30"><span class="linenos"> 30</span></a><span class="sd">    dmat : np.ndarray</span>
</span><span id="eval_xc_1-31"><a href="#eval_xc_1-31"><span class="linenos"> 31</span></a><span class="sd">        The one-electron density matrix in the AO basis.</span>
</span><span id="eval_xc_1-32"><a href="#eval_xc_1-32"><span class="linenos"> 32</span></a>
</span><span id="eval_xc_1-33"><a href="#eval_xc_1-33"><span class="linenos"> 33</span></a><span class="sd">    weights : np.ndarray</span>
</span><span id="eval_xc_1-34"><a href="#eval_xc_1-34"><span class="linenos"> 34</span></a><span class="sd">        Integration weights associated with each grid point.</span>
</span><span id="eval_xc_1-35"><a href="#eval_xc_1-35"><span class="linenos"> 35</span></a>
</span><span id="eval_xc_1-36"><a href="#eval_xc_1-36"><span class="linenos"> 36</span></a><span class="sd">    coords : np.ndarray</span>
</span><span id="eval_xc_1-37"><a href="#eval_xc_1-37"><span class="linenos"> 37</span></a><span class="sd">        Grid point coordinates as an (N, 3) array.</span>
</span><span id="eval_xc_1-38"><a href="#eval_xc_1-38"><span class="linenos"> 38</span></a>
</span><span id="eval_xc_1-39"><a href="#eval_xc_1-39"><span class="linenos"> 39</span></a><span class="sd">    funcid : list of int, optional</span>
</span><span id="eval_xc_1-40"><a href="#eval_xc_1-40"><span class="linenos"> 40</span></a><span class="sd">        LibXC functional IDs. Default is [1, 7] for Slater (X) and VWN (C) (LDA).</span>
</span><span id="eval_xc_1-41"><a href="#eval_xc_1-41"><span class="linenos"> 41</span></a>
</span><span id="eval_xc_1-42"><a href="#eval_xc_1-42"><span class="linenos"> 42</span></a><span class="sd">    spin : int, optional</span>
</span><span id="eval_xc_1-43"><a href="#eval_xc_1-43"><span class="linenos"> 43</span></a><span class="sd">        Spin multiplicity: 0 for unpolarized. Spin-polarized (1) not currently supported.</span>
</span><span id="eval_xc_1-44"><a href="#eval_xc_1-44"><span class="linenos"> 44</span></a>
</span><span id="eval_xc_1-45"><a href="#eval_xc_1-45"><span class="linenos"> 45</span></a><span class="sd">    blocksize : int, optional</span>
</span><span id="eval_xc_1-46"><a href="#eval_xc_1-46"><span class="linenos"> 46</span></a><span class="sd">        Number of grid points to process per block. Default is 50000.</span>
</span><span id="eval_xc_1-47"><a href="#eval_xc_1-47"><span class="linenos"> 47</span></a>
</span><span id="eval_xc_1-48"><a href="#eval_xc_1-48"><span class="linenos"> 48</span></a><span class="sd">    debug : bool, optional</span>
</span><span id="eval_xc_1-49"><a href="#eval_xc_1-49"><span class="linenos"> 49</span></a><span class="sd">        If True, enables verbose timing and diagnostic output.</span>
</span><span id="eval_xc_1-50"><a href="#eval_xc_1-50"><span class="linenos"> 50</span></a>
</span><span id="eval_xc_1-51"><a href="#eval_xc_1-51"><span class="linenos"> 51</span></a><span class="sd">    list_nonzero_indices : list of np.ndarray, optional</span>
</span><span id="eval_xc_1-52"><a href="#eval_xc_1-52"><span class="linenos"> 52</span></a><span class="sd">        List of AO indices with non-negligible contributions in each grid block</span>
</span><span id="eval_xc_1-53"><a href="#eval_xc_1-53"><span class="linenos"> 53</span></a><span class="sd">        for sparse matrix optimizations.</span>
</span><span id="eval_xc_1-54"><a href="#eval_xc_1-54"><span class="linenos"> 54</span></a>
</span><span id="eval_xc_1-55"><a href="#eval_xc_1-55"><span class="linenos"> 55</span></a><span class="sd">    count_nonzero_indices : list of int, optional</span>
</span><span id="eval_xc_1-56"><a href="#eval_xc_1-56"><span class="linenos"> 56</span></a><span class="sd">        Number of significant AO indices per block; matches entries in `list_nonzero_indices`.</span>
</span><span id="eval_xc_1-57"><a href="#eval_xc_1-57"><span class="linenos"> 57</span></a>
</span><span id="eval_xc_1-58"><a href="#eval_xc_1-58"><span class="linenos"> 58</span></a><span class="sd">    list_ao_values : list of np.ndarray, optional</span>
</span><span id="eval_xc_1-59"><a href="#eval_xc_1-59"><span class="linenos"> 59</span></a><span class="sd">        Precomputed AO values at grid points for each block.</span>
</span><span id="eval_xc_1-60"><a href="#eval_xc_1-60"><span class="linenos"> 60</span></a>
</span><span id="eval_xc_1-61"><a href="#eval_xc_1-61"><span class="linenos"> 61</span></a><span class="sd">    list_ao_grad_values : list of tuple of np.ndarray, optional</span>
</span><span id="eval_xc_1-62"><a href="#eval_xc_1-62"><span class="linenos"> 62</span></a><span class="sd">        Precomputed AO gradient values (x, y, z) at grid points for each block.</span>
</span><span id="eval_xc_1-63"><a href="#eval_xc_1-63"><span class="linenos"> 63</span></a>
</span><span id="eval_xc_1-64"><a href="#eval_xc_1-64"><span class="linenos"> 64</span></a><span class="sd">    Returns</span>
</span><span id="eval_xc_1-65"><a href="#eval_xc_1-65"><span class="linenos"> 65</span></a><span class="sd">    -------</span>
</span><span id="eval_xc_1-66"><a href="#eval_xc_1-66"><span class="linenos"> 66</span></a><span class="sd">    efunc : float</span>
</span><span id="eval_xc_1-67"><a href="#eval_xc_1-67"><span class="linenos"> 67</span></a><span class="sd">        Total exchange-correlation energy.</span>
</span><span id="eval_xc_1-68"><a href="#eval_xc_1-68"><span class="linenos"> 68</span></a>
</span><span id="eval_xc_1-69"><a href="#eval_xc_1-69"><span class="linenos"> 69</span></a><span class="sd">    v : np.ndarray</span>
</span><span id="eval_xc_1-70"><a href="#eval_xc_1-70"><span class="linenos"> 70</span></a><span class="sd">        Exchange-correlation potential matrix in the AO basis.</span>
</span><span id="eval_xc_1-71"><a href="#eval_xc_1-71"><span class="linenos"> 71</span></a>
</span><span id="eval_xc_1-72"><a href="#eval_xc_1-72"><span class="linenos"> 72</span></a><span class="sd">    Notes</span>
</span><span id="eval_xc_1-73"><a href="#eval_xc_1-73"><span class="linenos"> 73</span></a><span class="sd">    -----</span>
</span><span id="eval_xc_1-74"><a href="#eval_xc_1-74"><span class="linenos"> 74</span></a><span class="sd">    - This algorithm prioritizes code clarity and correctness, not maximum speed.</span>
</span><span id="eval_xc_1-75"><a href="#eval_xc_1-75"><span class="linenos"> 75</span></a><span class="sd">    - Only LDA and GGA functionals are currently supported. meta-GGA and hybrid functionals</span>
</span><span id="eval_xc_1-76"><a href="#eval_xc_1-76"><span class="linenos"> 76</span></a><span class="sd">      are planned for future implementation.</span>
</span><span id="eval_xc_1-77"><a href="#eval_xc_1-77"><span class="linenos"> 77</span></a><span class="sd">    - Uses LibXC for exchange-correlation energy and potential evaluation.</span>
</span><span id="eval_xc_1-78"><a href="#eval_xc_1-78"><span class="linenos"> 78</span></a><span class="sd">    - AO values and gradients can be reused via precomputation to improve speed.</span>
</span><span id="eval_xc_1-79"><a href="#eval_xc_1-79"><span class="linenos"> 79</span></a><span class="sd">    - The number of electrons (via integrated density) is printed for validation.</span>
</span><span id="eval_xc_1-80"><a href="#eval_xc_1-80"><span class="linenos"> 80</span></a>
</span><span id="eval_xc_1-81"><a href="#eval_xc_1-81"><span class="linenos"> 81</span></a><span class="sd">    References</span>
</span><span id="eval_xc_1-82"><a href="#eval_xc_1-82"><span class="linenos"> 82</span></a><span class="sd">    ----------</span>
</span><span id="eval_xc_1-83"><a href="#eval_xc_1-83"><span class="linenos"> 83</span></a><span class="sd">    - LibXC Functional Codes: https://libxc.gitlab.io/functionals/</span>
</span><span id="eval_xc_1-84"><a href="#eval_xc_1-84"><span class="linenos"> 84</span></a><span class="sd">    - Functional energy and potential formulation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_1-85"><a href="#eval_xc_1-85"><span class="linenos"> 85</span></a><span class="sd">    - LibXC Python interface: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_1-86"><a href="#eval_xc_1-86"><span class="linenos"> 86</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="eval_xc_1-87"><a href="#eval_xc_1-87"><span class="linenos"> 87</span></a>    <span class="c1"># Evaluate the XC term</span>
</span><span id="eval_xc_1-88"><a href="#eval_xc_1-88"><span class="linenos"> 88</span></a>    <span class="c1"># This is a slightly slower algorithm.</span>
</span><span id="eval_xc_1-89"><a href="#eval_xc_1-89"><span class="linenos"> 89</span></a>    <span class="c1"># Here the parallelization is done when evaluating bfs or the density</span>
</span><span id="eval_xc_1-90"><a href="#eval_xc_1-90"><span class="linenos"> 90</span></a>
</span><span id="eval_xc_1-91"><a href="#eval_xc_1-91"><span class="linenos"> 91</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_1-92"><a href="#eval_xc_1-92"><span class="linenos"> 92</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_1-93"><a href="#eval_xc_1-93"><span class="linenos"> 93</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_1-94"><a href="#eval_xc_1-94"><span class="linenos"> 94</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_1-95"><a href="#eval_xc_1-95"><span class="linenos"> 95</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_1-96"><a href="#eval_xc_1-96"><span class="linenos"> 96</span></a>
</span><span id="eval_xc_1-97"><a href="#eval_xc_1-97"><span class="linenos"> 97</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_1-98"><a href="#eval_xc_1-98"><span class="linenos"> 98</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_1-99"><a href="#eval_xc_1-99"><span class="linenos"> 99</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_1-100"><a href="#eval_xc_1-100"><span class="linenos">100</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_1-101"><a href="#eval_xc_1-101"><span class="linenos">101</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_1-102"><a href="#eval_xc_1-102"><span class="linenos">102</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_1-103"><a href="#eval_xc_1-103"><span class="linenos">103</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_1-104"><a href="#eval_xc_1-104"><span class="linenos">104</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_1-105"><a href="#eval_xc_1-105"><span class="linenos">105</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_1-106"><a href="#eval_xc_1-106"><span class="linenos">106</span></a>
</span><span id="eval_xc_1-107"><a href="#eval_xc_1-107"><span class="linenos">107</span></a>
</span><span id="eval_xc_1-108"><a href="#eval_xc_1-108"><span class="linenos">108</span></a>
</span><span id="eval_xc_1-109"><a href="#eval_xc_1-109"><span class="linenos">109</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_1-110"><a href="#eval_xc_1-110"><span class="linenos">110</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_1-111"><a href="#eval_xc_1-111"><span class="linenos">111</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-112"><a href="#eval_xc_1-112"><span class="linenos">112</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_1-113"><a href="#eval_xc_1-113"><span class="linenos">113</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">))</span>
</span><span id="eval_xc_1-114"><a href="#eval_xc_1-114"><span class="linenos">114</span></a>    <span class="c1">#TODO mGGA, Hybrid</span>
</span><span id="eval_xc_1-115"><a href="#eval_xc_1-115"><span class="linenos">115</span></a>    
</span><span id="eval_xc_1-116"><a href="#eval_xc_1-116"><span class="linenos">116</span></a>    <span class="c1">#Calculate number of blocks/batches</span>
</span><span id="eval_xc_1-117"><a href="#eval_xc_1-117"><span class="linenos">117</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1-118"><a href="#eval_xc_1-118"><span class="linenos">118</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_1-119"><a href="#eval_xc_1-119"><span class="linenos">119</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-120"><a href="#eval_xc_1-120"><span class="linenos">120</span></a>
</span><span id="eval_xc_1-121"><a href="#eval_xc_1-121"><span class="linenos">121</span></a>    <span class="c1"># If a list of significant basis functions for each block of grid points is provided</span>
</span><span id="eval_xc_1-122"><a href="#eval_xc_1-122"><span class="linenos">122</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-123"><a href="#eval_xc_1-123"><span class="linenos">123</span></a>        <span class="n">dmat_orig</span> <span class="o">=</span> <span class="n">dmat</span>
</span><span id="eval_xc_1-124"><a href="#eval_xc_1-124"><span class="linenos">124</span></a>
</span><span id="eval_xc_1-125"><a href="#eval_xc_1-125"><span class="linenos">125</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_1-126"><a href="#eval_xc_1-126"><span class="linenos">126</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_1-127"><a href="#eval_xc_1-127"><span class="linenos">127</span></a>    <span class="c1"># This will help to make the call to eval_bfs faster by skipping the mediator eval_bfs function </span>
</span><span id="eval_xc_1-128"><a href="#eval_xc_1-128"><span class="linenos">128</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_1-129"><a href="#eval_xc_1-129"><span class="linenos">129</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_1-130"><a href="#eval_xc_1-130"><span class="linenos">130</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="eval_xc_1-131"><a href="#eval_xc_1-131"><span class="linenos">131</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="eval_xc_1-132"><a href="#eval_xc_1-132"><span class="linenos">132</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_1-133"><a href="#eval_xc_1-133"><span class="linenos">133</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_1-134"><a href="#eval_xc_1-134"><span class="linenos">134</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_1-135"><a href="#eval_xc_1-135"><span class="linenos">135</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_1-136"><a href="#eval_xc_1-136"><span class="linenos">136</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_1-137"><a href="#eval_xc_1-137"><span class="linenos">137</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_1-138"><a href="#eval_xc_1-138"><span class="linenos">138</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_1-139"><a href="#eval_xc_1-139"><span class="linenos">139</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_1-140"><a href="#eval_xc_1-140"><span class="linenos">140</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_1-141"><a href="#eval_xc_1-141"><span class="linenos">141</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_1-142"><a href="#eval_xc_1-142"><span class="linenos">142</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_1-143"><a href="#eval_xc_1-143"><span class="linenos">143</span></a>    <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">])</span>
</span><span id="eval_xc_1-144"><a href="#eval_xc_1-144"><span class="linenos">144</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_1-145"><a href="#eval_xc_1-145"><span class="linenos">145</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_1-146"><a href="#eval_xc_1-146"><span class="linenos">146</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1-147"><a href="#eval_xc_1-147"><span class="linenos">147</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1-148"><a href="#eval_xc_1-148"><span class="linenos">148</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1-149"><a href="#eval_xc_1-149"><span class="linenos">149</span></a>            <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_1-150"><a href="#eval_xc_1-150"><span class="linenos">150</span></a>    <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_1-151"><a href="#eval_xc_1-151"><span class="linenos">151</span></a>    <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_1-152"><a href="#eval_xc_1-152"><span class="linenos">152</span></a>
</span><span id="eval_xc_1-153"><a href="#eval_xc_1-153"><span class="linenos">153</span></a>    <span class="c1"># For debugging and benchmarking purposes</span>
</span><span id="eval_xc_1-154"><a href="#eval_xc_1-154"><span class="linenos">154</span></a>    <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-155"><a href="#eval_xc_1-155"><span class="linenos">155</span></a>    <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-156"><a href="#eval_xc_1-156"><span class="linenos">156</span></a>    <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-157"><a href="#eval_xc_1-157"><span class="linenos">157</span></a>    <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-158"><a href="#eval_xc_1-158"><span class="linenos">158</span></a>    <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-159"><a href="#eval_xc_1-159"><span class="linenos">159</span></a>    <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-160"><a href="#eval_xc_1-160"><span class="linenos">160</span></a>    <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1-161"><a href="#eval_xc_1-161"><span class="linenos">161</span></a>
</span><span id="eval_xc_1-162"><a href="#eval_xc_1-162"><span class="linenos">162</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_1-163"><a href="#eval_xc_1-163"><span class="linenos">163</span></a>
</span><span id="eval_xc_1-164"><a href="#eval_xc_1-164"><span class="linenos">164</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_1-165"><a href="#eval_xc_1-165"><span class="linenos">165</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_1-166"><a href="#eval_xc_1-166"><span class="linenos">166</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_1-167"><a href="#eval_xc_1-167"><span class="linenos">167</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_1-168"><a href="#eval_xc_1-168"><span class="linenos">168</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_1-169"><a href="#eval_xc_1-169"><span class="linenos">169</span></a>
</span><span id="eval_xc_1-170"><a href="#eval_xc_1-170"><span class="linenos">170</span></a>    <span class="c1"># Loop over blocks/batches of grid points</span>
</span><span id="eval_xc_1-171"><a href="#eval_xc_1-171"><span class="linenos">171</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="eval_xc_1-172"><a href="#eval_xc_1-172"><span class="linenos">172</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="eval_xc_1-173"><a href="#eval_xc_1-173"><span class="linenos">173</span></a>
</span><span id="eval_xc_1-174"><a href="#eval_xc_1-174"><span class="linenos">174</span></a>        <span class="c1"># Get weights and coordinates of grid points for this block/batch</span>
</span><span id="eval_xc_1-175"><a href="#eval_xc_1-175"><span class="linenos">175</span></a>        <span class="n">weights_block</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>
</span><span id="eval_xc_1-176"><a href="#eval_xc_1-176"><span class="linenos">176</span></a>        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span> 
</span><span id="eval_xc_1-177"><a href="#eval_xc_1-177"><span class="linenos">177</span></a>
</span><span id="eval_xc_1-178"><a href="#eval_xc_1-178"><span class="linenos">178</span></a>        <span class="c1"># Get the list of basis functions with significant contributions to this block</span>
</span><span id="eval_xc_1-179"><a href="#eval_xc_1-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-180"><a href="#eval_xc_1-180"><span class="linenos">180</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]]</span>
</span><span id="eval_xc_1-181"><a href="#eval_xc_1-181"><span class="linenos">181</span></a>            <span class="c1"># Get the subset of density matrix corresponding to the siginificant basis functions</span>
</span><span id="eval_xc_1-182"><a href="#eval_xc_1-182"><span class="linenos">182</span></a>            <span class="n">dmat</span> <span class="o">=</span> <span class="n">dmat_orig</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span>
</span><span id="eval_xc_1-183"><a href="#eval_xc_1-183"><span class="linenos">183</span></a>
</span><span id="eval_xc_1-184"><a href="#eval_xc_1-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-185"><a href="#eval_xc_1-185"><span class="linenos">185</span></a>            <span class="n">startAO</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-186"><a href="#eval_xc_1-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-187"><a href="#eval_xc_1-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If ao_values are calculated once and saved, then they can be provided to avoid recalculation</span>
</span><span id="eval_xc_1-188"><a href="#eval_xc_1-188"><span class="linenos">188</span></a>                <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">]</span>
</span><span id="eval_xc_1-189"><a href="#eval_xc_1-189"><span class="linenos">189</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1-190"><a href="#eval_xc_1-190"><span class="linenos">190</span></a>                <span class="c1"># ao_value_block = Integrals.eval_bfs(basis, coords_block)       </span>
</span><span id="eval_xc_1-191"><a href="#eval_xc_1-191"><span class="linenos">191</span></a>                <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-192"><a href="#eval_xc_1-192"><span class="linenos">192</span></a>                    <span class="c1"># ao_value_block = Integrals.bf_val_helpers.eval_bfs_sparse_internal(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, coords_block, non_zero_indices)</span>
</span><span id="eval_xc_1-193"><a href="#eval_xc_1-193"><span class="linenos">193</span></a>                    <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_sparse_vectorized_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)</span>
</span><span id="eval_xc_1-194"><a href="#eval_xc_1-194"><span class="linenos">194</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1-195"><a href="#eval_xc_1-195"><span class="linenos">195</span></a>                    <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>
</span><span id="eval_xc_1-196"><a href="#eval_xc_1-196"><span class="linenos">196</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need ao_grad_values</span>
</span><span id="eval_xc_1-197"><a href="#eval_xc_1-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-198"><a href="#eval_xc_1-198"><span class="linenos">198</span></a>            <span class="c1"># ao_value_block, ao_values_grad_block = Integrals.bf_val_helpers.eval_bfs_and_grad(basis, coords_block, deriv=1, parallel=True, non_zero_indices=non_zero_indices)</span>
</span><span id="eval_xc_1-199"><a href="#eval_xc_1-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-200"><a href="#eval_xc_1-200"><span class="linenos">200</span></a>                <span class="c1"># Calculating ao values and gradients together, didn&#39;t really do much improvement in computational speed</span>
</span><span id="eval_xc_1-201"><a href="#eval_xc_1-201"><span class="linenos">201</span></a>                <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad_sparse_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)</span>
</span><span id="eval_xc_1-202"><a href="#eval_xc_1-202"><span class="linenos">202</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1-203"><a href="#eval_xc_1-203"><span class="linenos">203</span></a>                <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>
</span><span id="eval_xc_1-204"><a href="#eval_xc_1-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-205"><a href="#eval_xc_1-205"><span class="linenos">205</span></a>            <span class="n">durationAO</span> <span class="o">=</span> <span class="n">durationAO</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startAO</span>
</span><span id="eval_xc_1-206"><a href="#eval_xc_1-206"><span class="linenos">206</span></a>            
</span><span id="eval_xc_1-207"><a href="#eval_xc_1-207"><span class="linenos">207</span></a>
</span><span id="eval_xc_1-208"><a href="#eval_xc_1-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-209"><a href="#eval_xc_1-209"><span class="linenos">209</span></a>            <span class="n">startRho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-210"><a href="#eval_xc_1-210"><span class="linenos">210</span></a>        
</span><span id="eval_xc_1-211"><a href="#eval_xc_1-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-212"><a href="#eval_xc_1-212"><span class="linenos">212</span></a>            <span class="n">rho_block</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span> <span class="c1"># Original (pretty fast)</span>
</span><span id="eval_xc_1-213"><a href="#eval_xc_1-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1-214"><a href="#eval_xc_1-214"><span class="linenos">214</span></a>            <span class="n">rho_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_rho</span><span class="p">(</span><span class="n">ao_value_block</span><span class="p">,</span> <span class="n">dmat</span><span class="p">)</span> <span class="c1"># This is by-far the fastest now &lt;-----</span>
</span><span id="eval_xc_1-215"><a href="#eval_xc_1-215"><span class="linenos">215</span></a>        
</span><span id="eval_xc_1-216"><a href="#eval_xc_1-216"><span class="linenos">216</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values too</span>
</span><span id="eval_xc_1-217"><a href="#eval_xc_1-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-218"><a href="#eval_xc_1-218"><span class="linenos">218</span></a>            <span class="n">rho_grad_block_x</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ao_value_block</span><span class="p">)</span><span class="o">+</span>\
</span><span id="eval_xc_1-219"><a href="#eval_xc_1-219"><span class="linenos">219</span></a>                                    <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_value_block</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="eval_xc_1-220"><a href="#eval_xc_1-220"><span class="linenos">220</span></a>            <span class="n">rho_grad_block_y</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ao_value_block</span><span class="p">)</span><span class="o">+</span>\
</span><span id="eval_xc_1-221"><a href="#eval_xc_1-221"><span class="linenos">221</span></a>                                    <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_value_block</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="eval_xc_1-222"><a href="#eval_xc_1-222"><span class="linenos">222</span></a>            <span class="n">rho_grad_block_z</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ao_value_block</span><span class="p">)</span><span class="o">+</span>\
</span><span id="eval_xc_1-223"><a href="#eval_xc_1-223"><span class="linenos">223</span></a>                                    <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_value_block</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="eval_xc_1-224"><a href="#eval_xc_1-224"><span class="linenos">224</span></a>            <span class="n">sigma_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">weights_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="eval_xc_1-225"><a href="#eval_xc_1-225"><span class="linenos">225</span></a>            <span class="n">sigma_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_grad_block_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rho_grad_block_y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rho_grad_block_z</span><span class="o">**</span><span class="mi">2</span>
</span><span id="eval_xc_1-226"><a href="#eval_xc_1-226"><span class="linenos">226</span></a>
</span><span id="eval_xc_1-227"><a href="#eval_xc_1-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-228"><a href="#eval_xc_1-228"><span class="linenos">228</span></a>            <span class="n">durationRho</span> <span class="o">=</span> <span class="n">durationRho</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startRho</span>
</span><span id="eval_xc_1-229"><a href="#eval_xc_1-229"><span class="linenos">229</span></a>    
</span><span id="eval_xc_1-230"><a href="#eval_xc_1-230"><span class="linenos">230</span></a>        <span class="c1">#LibXC stuff</span>
</span><span id="eval_xc_1-231"><a href="#eval_xc_1-231"><span class="linenos">231</span></a>        <span class="c1"># Exchange</span>
</span><span id="eval_xc_1-232"><a href="#eval_xc_1-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-233"><a href="#eval_xc_1-233"><span class="linenos">233</span></a>            <span class="n">startLibxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-234"><a href="#eval_xc_1-234"><span class="linenos">234</span></a>        <span class="c1"># Input dictionary for libxc</span>
</span><span id="eval_xc_1-235"><a href="#eval_xc_1-235"><span class="linenos">235</span></a>        <span class="n">inp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="eval_xc_1-236"><a href="#eval_xc_1-236"><span class="linenos">236</span></a>        <span class="c1"># Input dictionary needs density values at grid points</span>
</span><span id="eval_xc_1-237"><a href="#eval_xc_1-237"><span class="linenos">237</span></a>        <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_block</span>
</span><span id="eval_xc_1-238"><a href="#eval_xc_1-238"><span class="linenos">238</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-239"><a href="#eval_xc_1-239"><span class="linenos">239</span></a>            <span class="c1"># Input dictionary needs sigma (\nabla \rho \cdot \nabla \rho) values at grid points</span>
</span><span id="eval_xc_1-240"><a href="#eval_xc_1-240"><span class="linenos">240</span></a>            <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_1-241"><a href="#eval_xc_1-241"><span class="linenos">241</span></a>        <span class="c1"># Calculate the necessary quantities using LibXC</span>
</span><span id="eval_xc_1-242"><a href="#eval_xc_1-242"><span class="linenos">242</span></a>        <span class="n">retx</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</span><span id="eval_xc_1-243"><a href="#eval_xc_1-243"><span class="linenos">243</span></a>        <span class="c1"># print(&#39;Duration for LibXC computations at grid points: &#39;,durationLibxc)</span>
</span><span id="eval_xc_1-244"><a href="#eval_xc_1-244"><span class="linenos">244</span></a>
</span><span id="eval_xc_1-245"><a href="#eval_xc_1-245"><span class="linenos">245</span></a>        <span class="c1"># Correlation</span>
</span><span id="eval_xc_1-246"><a href="#eval_xc_1-246"><span class="linenos">246</span></a>        <span class="c1"># Input dictionary for libxc</span>
</span><span id="eval_xc_1-247"><a href="#eval_xc_1-247"><span class="linenos">247</span></a>        <span class="n">inp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="eval_xc_1-248"><a href="#eval_xc_1-248"><span class="linenos">248</span></a>        <span class="c1"># Input dictionary needs density values at grid points</span>
</span><span id="eval_xc_1-249"><a href="#eval_xc_1-249"><span class="linenos">249</span></a>        <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_block</span>
</span><span id="eval_xc_1-250"><a href="#eval_xc_1-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-251"><a href="#eval_xc_1-251"><span class="linenos">251</span></a>            <span class="c1"># Input dictionary needs sigma (\nabla \rho \cdot \nabla \rho) values at grid points</span>
</span><span id="eval_xc_1-252"><a href="#eval_xc_1-252"><span class="linenos">252</span></a>            <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_1-253"><a href="#eval_xc_1-253"><span class="linenos">253</span></a>        <span class="c1"># Calculate the necessary quantities using LibXC</span>
</span><span id="eval_xc_1-254"><a href="#eval_xc_1-254"><span class="linenos">254</span></a>        <span class="n">retc</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</span><span id="eval_xc_1-255"><a href="#eval_xc_1-255"><span class="linenos">255</span></a>
</span><span id="eval_xc_1-256"><a href="#eval_xc_1-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-257"><a href="#eval_xc_1-257"><span class="linenos">257</span></a>            <span class="n">durationLibxc</span> <span class="o">=</span> <span class="n">durationLibxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startLibxc</span>
</span><span id="eval_xc_1-258"><a href="#eval_xc_1-258"><span class="linenos">258</span></a>        <span class="c1"># print(&#39;Duration for LibXC computations at grid points: &#39;,durationLibxc)</span>
</span><span id="eval_xc_1-259"><a href="#eval_xc_1-259"><span class="linenos">259</span></a>
</span><span id="eval_xc_1-260"><a href="#eval_xc_1-260"><span class="linenos">260</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-261"><a href="#eval_xc_1-261"><span class="linenos">261</span></a>            <span class="n">startE</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-262"><a href="#eval_xc_1-262"><span class="linenos">262</span></a>        <span class="c1">#ENERGY-----------</span>
</span><span id="eval_xc_1-263"><a href="#eval_xc_1-263"><span class="linenos">263</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;zk&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;zk&#39;</span><span class="p">]</span> <span class="c1"># Functional values at grid points</span>
</span><span id="eval_xc_1-264"><a href="#eval_xc_1-264"><span class="linenos">264</span></a>        <span class="c1"># Testing CrysX&#39;s own implmentation</span>
</span><span id="eval_xc_1-265"><a href="#eval_xc_1-265"><span class="linenos">265</span></a>        <span class="c1">#e = densfuncs.lda_x(rho)</span>
</span><span id="eval_xc_1-266"><a href="#eval_xc_1-266"><span class="linenos">266</span></a>
</span><span id="eval_xc_1-267"><a href="#eval_xc_1-267"><span class="linenos">267</span></a>        <span class="c1"># Calculate the total energy </span>
</span><span id="eval_xc_1-268"><a href="#eval_xc_1-268"><span class="linenos">268</span></a>        <span class="c1"># Multiply the density at grid points by weights</span>
</span><span id="eval_xc_1-269"><a href="#eval_xc_1-269"><span class="linenos">269</span></a>        <span class="n">den</span> <span class="o">=</span> <span class="n">rho_block</span><span class="o">*</span><span class="n">weights_block</span> <span class="c1">#elementwise multiply</span>
</span><span id="eval_xc_1-270"><a href="#eval_xc_1-270"><span class="linenos">270</span></a>        <span class="n">efunc</span> <span class="o">=</span> <span class="n">efunc</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="c1">#Multiply with functional values at grid points and sum</span>
</span><span id="eval_xc_1-271"><a href="#eval_xc_1-271"><span class="linenos">271</span></a>        <span class="n">nelec</span> <span class="o">=</span> <span class="n">nelec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">den</span><span class="p">)</span>
</span><span id="eval_xc_1-272"><a href="#eval_xc_1-272"><span class="linenos">272</span></a>
</span><span id="eval_xc_1-273"><a href="#eval_xc_1-273"><span class="linenos">273</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-274"><a href="#eval_xc_1-274"><span class="linenos">274</span></a>            <span class="n">durationE</span> <span class="o">=</span> <span class="n">durationE</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startE</span>
</span><span id="eval_xc_1-275"><a href="#eval_xc_1-275"><span class="linenos">275</span></a>        <span class="c1"># print(&#39;Duration for calculation of total density functional energy: &#39;,durationE)</span>
</span><span id="eval_xc_1-276"><a href="#eval_xc_1-276"><span class="linenos">276</span></a>
</span><span id="eval_xc_1-277"><a href="#eval_xc_1-277"><span class="linenos">277</span></a>        <span class="c1">#POTENTIAL----------</span>
</span><span id="eval_xc_1-278"><a href="#eval_xc_1-278"><span class="linenos">278</span></a>        <span class="c1"># The derivative of functional wrt density is vrho</span>
</span><span id="eval_xc_1-279"><a href="#eval_xc_1-279"><span class="linenos">279</span></a>        <span class="n">vrho</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;vrho&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;vrho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1-280"><a href="#eval_xc_1-280"><span class="linenos">280</span></a>        <span class="n">vsigma</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1-281"><a href="#eval_xc_1-281"><span class="linenos">281</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1-282"><a href="#eval_xc_1-282"><span class="linenos">282</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-283"><a href="#eval_xc_1-283"><span class="linenos">283</span></a>            <span class="c1"># The derivative of functional wrt grad \rho square.</span>
</span><span id="eval_xc_1-284"><a href="#eval_xc_1-284"><span class="linenos">284</span></a>            <span class="n">vsigma</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;vsigma&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1-285"><a href="#eval_xc_1-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-286"><a href="#eval_xc_1-286"><span class="linenos">286</span></a>            <span class="c1"># The derivative of functional wrt grad \rho square.</span>
</span><span id="eval_xc_1-287"><a href="#eval_xc_1-287"><span class="linenos">287</span></a>            <span class="n">vsigma</span> <span class="o">+=</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;vsigma&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1-288"><a href="#eval_xc_1-288"><span class="linenos">288</span></a>        
</span><span id="eval_xc_1-289"><a href="#eval_xc_1-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-290"><a href="#eval_xc_1-290"><span class="linenos">290</span></a>            <span class="n">startF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-291"><a href="#eval_xc_1-291"><span class="linenos">291</span></a>        <span class="c1"># F = np.multiply(weights_block,vrho[:,0]) #This is fast enough.</span>
</span><span id="eval_xc_1-292"><a href="#eval_xc_1-292"><span class="linenos">292</span></a>        <span class="n">v_rho_temp</span> <span class="o">=</span> <span class="n">vrho</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1-293"><a href="#eval_xc_1-293"><span class="linenos">293</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(weights_block*v_rho_temp)&#39;</span><span class="p">)</span>
</span><span id="eval_xc_1-294"><a href="#eval_xc_1-294"><span class="linenos">294</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1-295"><a href="#eval_xc_1-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-296"><a href="#eval_xc_1-296"><span class="linenos">296</span></a>            <span class="n">Ftemp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">weights_block</span><span class="o">*</span><span class="n">vsigma</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1-297"><a href="#eval_xc_1-297"><span class="linenos">297</span></a>            <span class="n">Fx</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_x</span>
</span><span id="eval_xc_1-298"><a href="#eval_xc_1-298"><span class="linenos">298</span></a>            <span class="n">Fy</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_y</span>
</span><span id="eval_xc_1-299"><a href="#eval_xc_1-299"><span class="linenos">299</span></a>            <span class="n">Fz</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_z</span>
</span><span id="eval_xc_1-300"><a href="#eval_xc_1-300"><span class="linenos">300</span></a>            <span class="c1"># Ftemp = 2*np.multiply(weights_block,vsigma.T)</span>
</span><span id="eval_xc_1-301"><a href="#eval_xc_1-301"><span class="linenos">301</span></a>            <span class="c1"># Fx = Ftemp*rho_grad_block_x</span>
</span><span id="eval_xc_1-302"><a href="#eval_xc_1-302"><span class="linenos">302</span></a>            <span class="c1"># Fy = Ftemp*rho_grad_block_y</span>
</span><span id="eval_xc_1-303"><a href="#eval_xc_1-303"><span class="linenos">303</span></a>            <span class="c1"># Fz = Ftemp*rho_grad_block_z</span>
</span><span id="eval_xc_1-304"><a href="#eval_xc_1-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-305"><a href="#eval_xc_1-305"><span class="linenos">305</span></a>            <span class="n">durationF</span> <span class="o">=</span> <span class="n">durationF</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startF</span>
</span><span id="eval_xc_1-306"><a href="#eval_xc_1-306"><span class="linenos">306</span></a>        <span class="c1"># print(&#39;Duration for calculation of F: &#39;,durationF)</span>
</span><span id="eval_xc_1-307"><a href="#eval_xc_1-307"><span class="linenos">307</span></a>
</span><span id="eval_xc_1-308"><a href="#eval_xc_1-308"><span class="linenos">308</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-309"><a href="#eval_xc_1-309"><span class="linenos">309</span></a>            <span class="n">startZ</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-310"><a href="#eval_xc_1-310"><span class="linenos">310</span></a>        <span class="n">ao_value_block_T</span> <span class="o">=</span> <span class="n">ao_value_block</span><span class="o">.</span><span class="n">T</span>
</span><span id="eval_xc_1-311"><a href="#eval_xc_1-311"><span class="linenos">311</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(0.5*F*ao_value_block_T)&#39;</span><span class="p">)</span>
</span><span id="eval_xc_1-312"><a href="#eval_xc_1-312"><span class="linenos">312</span></a>        <span class="c1"># z = 0.5*np.einsum(&#39;m,mi-&gt;mi&#39;,F,ao_value_block)</span>
</span><span id="eval_xc_1-313"><a href="#eval_xc_1-313"><span class="linenos">313</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1-314"><a href="#eval_xc_1-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1-315"><a href="#eval_xc_1-315"><span class="linenos">315</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">Fx</span><span class="o">*</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Fy</span><span class="o">*</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Fz</span><span class="o">*</span><span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="eval_xc_1-316"><a href="#eval_xc_1-316"><span class="linenos">316</span></a>            
</span><span id="eval_xc_1-317"><a href="#eval_xc_1-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-318"><a href="#eval_xc_1-318"><span class="linenos">318</span></a>            <span class="n">durationZ</span> <span class="o">=</span> <span class="n">durationZ</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startZ</span>
</span><span id="eval_xc_1-319"><a href="#eval_xc_1-319"><span class="linenos">319</span></a>        <span class="c1"># print(&#39;Duration for calculation of z : &#39;,durationZ)</span>
</span><span id="eval_xc_1-320"><a href="#eval_xc_1-320"><span class="linenos">320</span></a>        <span class="c1"># Free memory</span>
</span><span id="eval_xc_1-321"><a href="#eval_xc_1-321"><span class="linenos">321</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1-322"><a href="#eval_xc_1-322"><span class="linenos">322</span></a>        <span class="n">ao_value_block_T</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1-323"><a href="#eval_xc_1-323"><span class="linenos">323</span></a>        <span class="n">vrho</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1-324"><a href="#eval_xc_1-324"><span class="linenos">324</span></a>
</span><span id="eval_xc_1-325"><a href="#eval_xc_1-325"><span class="linenos">325</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-326"><a href="#eval_xc_1-326"><span class="linenos">326</span></a>            <span class="n">startV</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1-327"><a href="#eval_xc_1-327"><span class="linenos">327</span></a>        <span class="c1"># Numexpr</span>
</span><span id="eval_xc_1-328"><a href="#eval_xc_1-328"><span class="linenos">328</span></a>        <span class="n">v_temp</span> <span class="o">=</span> <span class="n">z</span> <span class="o">@</span> <span class="n">ao_value_block</span>  
</span><span id="eval_xc_1-329"><a href="#eval_xc_1-329"><span class="linenos">329</span></a>        <span class="n">v_temp_T</span> <span class="o">=</span> <span class="n">v_temp</span><span class="o">.</span><span class="n">T</span>
</span><span id="eval_xc_1-330"><a href="#eval_xc_1-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1-331"><a href="#eval_xc_1-331"><span class="linenos">331</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(v_temp + v_temp_T)&#39;</span><span class="p">)</span>
</span><span id="eval_xc_1-332"><a href="#eval_xc_1-332"><span class="linenos">332</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1-333"><a href="#eval_xc_1-333"><span class="linenos">333</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(v + v_temp + v_temp_T)&#39;</span><span class="p">)</span>
</span><span id="eval_xc_1-334"><a href="#eval_xc_1-334"><span class="linenos">334</span></a>
</span><span id="eval_xc_1-335"><a href="#eval_xc_1-335"><span class="linenos">335</span></a>        
</span><span id="eval_xc_1-336"><a href="#eval_xc_1-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-337"><a href="#eval_xc_1-337"><span class="linenos">337</span></a>            <span class="n">durationV</span> <span class="o">=</span> <span class="n">durationV</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startV</span>
</span><span id="eval_xc_1-338"><a href="#eval_xc_1-338"><span class="linenos">338</span></a>
</span><span id="eval_xc_1-339"><a href="#eval_xc_1-339"><span class="linenos">339</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_1-340"><a href="#eval_xc_1-340"><span class="linenos">340</span></a>
</span><span id="eval_xc_1-341"><a href="#eval_xc_1-341"><span class="linenos">341</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1-342"><a href="#eval_xc_1-342"><span class="linenos">342</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for AO values: &#39;</span><span class="p">,</span> <span class="n">durationAO</span><span class="p">)</span>
</span><span id="eval_xc_1-343"><a href="#eval_xc_1-343"><span class="linenos">343</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for V: &#39;</span><span class="p">,</span><span class="n">durationV</span><span class="p">)</span>
</span><span id="eval_xc_1-344"><a href="#eval_xc_1-344"><span class="linenos">344</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for Rho at grid points: &#39;</span><span class="p">,</span><span class="n">durationRho</span><span class="p">)</span>
</span><span id="eval_xc_1-345"><a href="#eval_xc_1-345"><span class="linenos">345</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for F: &#39;</span><span class="p">,</span><span class="n">durationF</span><span class="p">)</span>
</span><span id="eval_xc_1-346"><a href="#eval_xc_1-346"><span class="linenos">346</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for Z: &#39;</span><span class="p">,</span><span class="n">durationZ</span><span class="p">)</span>
</span><span id="eval_xc_1-347"><a href="#eval_xc_1-347"><span class="linenos">347</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for E: &#39;</span><span class="p">,</span><span class="n">durationE</span><span class="p">)</span>
</span><span id="eval_xc_1-348"><a href="#eval_xc_1-348"><span class="linenos">348</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for LibXC: &#39;</span><span class="p">,</span><span class="n">durationLibxc</span><span class="p">)</span>
</span><span id="eval_xc_1-349"><a href="#eval_xc_1-349"><span class="linenos">349</span></a>
</span><span id="eval_xc_1-350"><a href="#eval_xc_1-350"><span class="linenos">350</span></a>    
</span><span id="eval_xc_1-351"><a href="#eval_xc_1-351"><span class="linenos">351</span></a>
</span><span id="eval_xc_1-352"><a href="#eval_xc_1-352"><span class="linenos">352</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate exchange-correlation (XC) energy and potential matrix for DFT
using algorithm 1, which is a baseline method for grid-based DFT.</p>

<p>In algorithm 1, the XC term is evaluated by looping over blocks of grid 
points, and within each block, the operations are parallelized. This 
approach is functional but generally slower than algorithm 2 for CPU-based 
execution.</p>

<p>This function evaluates the XC energy and potential matrix elements for a given
density matrix using numerical integration over a 3D real-space grid. It supports 
LDA and GGA functionals via LibXC and optional use of precomputed AO values and 
gradients for performance gains. Sparse AO matrix techniques are also supported.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : Basis
    A basis object containing basis function data: exponents, coefficients, 
    angular momentum, normalization, and other AO metadata.</p>

<p>dmat : np.ndarray
    The one-electron density matrix in the AO basis.</p>

<p>weights : np.ndarray
    Integration weights associated with each grid point.</p>

<p>coords : np.ndarray
    Grid point coordinates as an (N, 3) array.</p>

<p>funcid : list of int, optional
    LibXC functional IDs. Default is [1, 7] for Slater (X) and VWN (C) (LDA).</p>

<p>spin : int, optional
    Spin multiplicity: 0 for unpolarized. Spin-polarized (1) not currently supported.</p>

<p>blocksize : int, optional
    Number of grid points to process per block. Default is 50000.</p>

<p>debug : bool, optional
    If True, enables verbose timing and diagnostic output.</p>

<p>list_nonzero_indices : list of np.ndarray, optional
    List of AO indices with non-negligible contributions in each grid block
    for sparse matrix optimizations.</p>

<p>count_nonzero_indices : list of int, optional
    Number of significant AO indices per block; matches entries in <code>list_nonzero_indices</code>.</p>

<p>list_ao_values : list of np.ndarray, optional
    Precomputed AO values at grid points for each block.</p>

<p>list_ao_grad_values : list of tuple of np.ndarray, optional
    Precomputed AO gradient values (x, y, z) at grid points for each block.</p>

<h2 id="returns">Returns</h2>

<p>efunc : float
    Total exchange-correlation energy.</p>

<p>v : np.ndarray
    Exchange-correlation potential matrix in the AO basis.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>This algorithm prioritizes code clarity and correctness, not maximum speed.</li>
<li>Only LDA and GGA functionals are currently supported. meta-GGA and hybrid functionals
are planned for future implementation.</li>
<li>Uses LibXC for exchange-correlation energy and potential evaluation.</li>
<li>AO values and gradients can be reused via precomputation to improve speed.</li>
<li>The number of electrons (via integrated density) is printed for validation.</li>
</ul>

<h2 id="references">References</h2>

<ul>
<li>LibXC Functional Codes: <a href="https://libxc.gitlab.io/functionals/">https://libxc.gitlab.io/functionals/</a></li>
<li>Functional energy and potential formulation: <a href="https://pubs.acs.org/doi/full/10.1021/ct200412r">https://pubs.acs.org/doi/full/10.1021/ct200412r</a></li>
<li>LibXC Python interface: <a href="https://www.tddft.org/programs/libxc/manual/">https://www.tddft.org/programs/libxc/manual/</a></li>
</ul>
</div>


                </section>
                <section id="eval_xc_2">
                            <input id="eval_xc_2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_2</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">ncores</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_2-18"><a href="#eval_xc_2-18"><span class="linenos"> 18</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_2</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="eval_xc_2-19"><a href="#eval_xc_2-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="eval_xc_2-20"><a href="#eval_xc_2-20"><span class="linenos"> 20</span></a><span class="sd">    Evaluate exchange-correlation (XC) energy and potential matrix for DFT</span>
</span><span id="eval_xc_2-21"><a href="#eval_xc_2-21"><span class="linenos"> 21</span></a><span class="sd">    using algorithm 2, which is the preferred algorithm for running DFT on CPU.</span>
</span><span id="eval_xc_2-22"><a href="#eval_xc_2-22"><span class="linenos"> 22</span></a>
</span><span id="eval_xc_2-23"><a href="#eval_xc_2-23"><span class="linenos"> 23</span></a><span class="sd">    In algorithm 2, the XC term is evaluated by parallelizing over batches.</span>
</span><span id="eval_xc_2-24"><a href="#eval_xc_2-24"><span class="linenos"> 24</span></a><span class="sd">    In contrast, the algorithm 1 evaluates the XC term by looping over batches and </span>
</span><span id="eval_xc_2-25"><a href="#eval_xc_2-25"><span class="linenos"> 25</span></a><span class="sd">    parallelizing the operations within the batch, which is suboptimal.</span>
</span><span id="eval_xc_2-26"><a href="#eval_xc_2-26"><span class="linenos"> 26</span></a>
</span><span id="eval_xc_2-27"><a href="#eval_xc_2-27"><span class="linenos"> 27</span></a><span class="sd">    This function evaluates the XC energy and potential matrix elements for a given</span>
</span><span id="eval_xc_2-28"><a href="#eval_xc_2-28"><span class="linenos"> 28</span></a><span class="sd">    density matrix using grid-based numerical integration. It supports LDA and GGA </span>
</span><span id="eval_xc_2-29"><a href="#eval_xc_2-29"><span class="linenos"> 29</span></a><span class="sd">    functionals (via LibXC), parallel execution with `joblib`, and sparse AO matrix blocks.</span>
</span><span id="eval_xc_2-30"><a href="#eval_xc_2-30"><span class="linenos"> 30</span></a>
</span><span id="eval_xc_2-31"><a href="#eval_xc_2-31"><span class="linenos"> 31</span></a><span class="sd">    Parameters</span>
</span><span id="eval_xc_2-32"><a href="#eval_xc_2-32"><span class="linenos"> 32</span></a><span class="sd">    ----------</span>
</span><span id="eval_xc_2-33"><a href="#eval_xc_2-33"><span class="linenos"> 33</span></a><span class="sd">    basis : Basis</span>
</span><span id="eval_xc_2-34"><a href="#eval_xc_2-34"><span class="linenos"> 34</span></a><span class="sd">        A basis object containing basis function data: exponents, coefficients, </span>
</span><span id="eval_xc_2-35"><a href="#eval_xc_2-35"><span class="linenos"> 35</span></a><span class="sd">        angular momentum, normalization, etc.</span>
</span><span id="eval_xc_2-36"><a href="#eval_xc_2-36"><span class="linenos"> 36</span></a>
</span><span id="eval_xc_2-37"><a href="#eval_xc_2-37"><span class="linenos"> 37</span></a><span class="sd">    dmat : np.ndarray</span>
</span><span id="eval_xc_2-38"><a href="#eval_xc_2-38"><span class="linenos"> 38</span></a><span class="sd">        The one-electron density matrix in the AO basis.</span>
</span><span id="eval_xc_2-39"><a href="#eval_xc_2-39"><span class="linenos"> 39</span></a>
</span><span id="eval_xc_2-40"><a href="#eval_xc_2-40"><span class="linenos"> 40</span></a><span class="sd">    weights : np.ndarray</span>
</span><span id="eval_xc_2-41"><a href="#eval_xc_2-41"><span class="linenos"> 41</span></a><span class="sd">        Integration weights associated with each grid point.</span>
</span><span id="eval_xc_2-42"><a href="#eval_xc_2-42"><span class="linenos"> 42</span></a>
</span><span id="eval_xc_2-43"><a href="#eval_xc_2-43"><span class="linenos"> 43</span></a><span class="sd">    coords : np.ndarray</span>
</span><span id="eval_xc_2-44"><a href="#eval_xc_2-44"><span class="linenos"> 44</span></a><span class="sd">        Grid point coordinates as an (N, 3) array.</span>
</span><span id="eval_xc_2-45"><a href="#eval_xc_2-45"><span class="linenos"> 45</span></a>
</span><span id="eval_xc_2-46"><a href="#eval_xc_2-46"><span class="linenos"> 46</span></a><span class="sd">    funcid : list of int, optional</span>
</span><span id="eval_xc_2-47"><a href="#eval_xc_2-47"><span class="linenos"> 47</span></a><span class="sd">        LibXC functional IDs. Default is [1, 7] for Slater (X) and VWN (C) (LDA).</span>
</span><span id="eval_xc_2-48"><a href="#eval_xc_2-48"><span class="linenos"> 48</span></a>
</span><span id="eval_xc_2-49"><a href="#eval_xc_2-49"><span class="linenos"> 49</span></a><span class="sd">    spin : int, optional</span>
</span><span id="eval_xc_2-50"><a href="#eval_xc_2-50"><span class="linenos"> 50</span></a><span class="sd">        Spin multiplicity: 0 for unpolarized, 1 for spin-polarized (not allowed currently).</span>
</span><span id="eval_xc_2-51"><a href="#eval_xc_2-51"><span class="linenos"> 51</span></a>
</span><span id="eval_xc_2-52"><a href="#eval_xc_2-52"><span class="linenos"> 52</span></a><span class="sd">    ncores : int, optional</span>
</span><span id="eval_xc_2-53"><a href="#eval_xc_2-53"><span class="linenos"> 53</span></a><span class="sd">        Number of threads/cores for parallel execution. Default is 2.</span>
</span><span id="eval_xc_2-54"><a href="#eval_xc_2-54"><span class="linenos"> 54</span></a>
</span><span id="eval_xc_2-55"><a href="#eval_xc_2-55"><span class="linenos"> 55</span></a><span class="sd">    blocksize : int, optional</span>
</span><span id="eval_xc_2-56"><a href="#eval_xc_2-56"><span class="linenos"> 56</span></a><span class="sd">        Number of grid points to process per block. Default is 5000.</span>
</span><span id="eval_xc_2-57"><a href="#eval_xc_2-57"><span class="linenos"> 57</span></a>
</span><span id="eval_xc_2-58"><a href="#eval_xc_2-58"><span class="linenos"> 58</span></a><span class="sd">    list_nonzero_indices : list of np.ndarray, optional</span>
</span><span id="eval_xc_2-59"><a href="#eval_xc_2-59"><span class="linenos"> 59</span></a><span class="sd">        Precomputed list of nonzero AO indices per block for sparse evaluation.</span>
</span><span id="eval_xc_2-60"><a href="#eval_xc_2-60"><span class="linenos"> 60</span></a>
</span><span id="eval_xc_2-61"><a href="#eval_xc_2-61"><span class="linenos"> 61</span></a><span class="sd">    count_nonzero_indices : list of int, optional</span>
</span><span id="eval_xc_2-62"><a href="#eval_xc_2-62"><span class="linenos"> 62</span></a><span class="sd">        Number of nonzero indices in each block (matches `list_nonzero_indices`).</span>
</span><span id="eval_xc_2-63"><a href="#eval_xc_2-63"><span class="linenos"> 63</span></a>
</span><span id="eval_xc_2-64"><a href="#eval_xc_2-64"><span class="linenos"> 64</span></a><span class="sd">    list_ao_values : list of np.ndarray, optional</span>
</span><span id="eval_xc_2-65"><a href="#eval_xc_2-65"><span class="linenos"> 65</span></a><span class="sd">        Precomputed AO values at grid points for each block.</span>
</span><span id="eval_xc_2-66"><a href="#eval_xc_2-66"><span class="linenos"> 66</span></a>
</span><span id="eval_xc_2-67"><a href="#eval_xc_2-67"><span class="linenos"> 67</span></a><span class="sd">    list_ao_grad_values : list of tuple of np.ndarray, optional</span>
</span><span id="eval_xc_2-68"><a href="#eval_xc_2-68"><span class="linenos"> 68</span></a><span class="sd">        Precomputed AO gradient values (x, y, z) at grid points for each block.</span>
</span><span id="eval_xc_2-69"><a href="#eval_xc_2-69"><span class="linenos"> 69</span></a>
</span><span id="eval_xc_2-70"><a href="#eval_xc_2-70"><span class="linenos"> 70</span></a><span class="sd">    debug : bool, optional</span>
</span><span id="eval_xc_2-71"><a href="#eval_xc_2-71"><span class="linenos"> 71</span></a><span class="sd">        If True, print detailed timing and diagnostic info.</span>
</span><span id="eval_xc_2-72"><a href="#eval_xc_2-72"><span class="linenos"> 72</span></a>
</span><span id="eval_xc_2-73"><a href="#eval_xc_2-73"><span class="linenos"> 73</span></a><span class="sd">    Returns</span>
</span><span id="eval_xc_2-74"><a href="#eval_xc_2-74"><span class="linenos"> 74</span></a><span class="sd">    -------</span>
</span><span id="eval_xc_2-75"><a href="#eval_xc_2-75"><span class="linenos"> 75</span></a><span class="sd">    efunc : float</span>
</span><span id="eval_xc_2-76"><a href="#eval_xc_2-76"><span class="linenos"> 76</span></a><span class="sd">        Total exchange-correlation energy.</span>
</span><span id="eval_xc_2-77"><a href="#eval_xc_2-77"><span class="linenos"> 77</span></a>
</span><span id="eval_xc_2-78"><a href="#eval_xc_2-78"><span class="linenos"> 78</span></a><span class="sd">    v : np.ndarray</span>
</span><span id="eval_xc_2-79"><a href="#eval_xc_2-79"><span class="linenos"> 79</span></a><span class="sd">        Exchange-correlation potential matrix in the AO basis.</span>
</span><span id="eval_xc_2-80"><a href="#eval_xc_2-80"><span class="linenos"> 80</span></a>
</span><span id="eval_xc_2-81"><a href="#eval_xc_2-81"><span class="linenos"> 81</span></a><span class="sd">    Notes</span>
</span><span id="eval_xc_2-82"><a href="#eval_xc_2-82"><span class="linenos"> 82</span></a><span class="sd">    -----</span>
</span><span id="eval_xc_2-83"><a href="#eval_xc_2-83"><span class="linenos"> 83</span></a><span class="sd">    - Only supports LDA and GGA functionals currently. meta-GGA and hybrid support is in development.</span>
</span><span id="eval_xc_2-84"><a href="#eval_xc_2-84"><span class="linenos"> 84</span></a><span class="sd">    - Uses LibXC for energy and derivative functional evaluation.</span>
</span><span id="eval_xc_2-85"><a href="#eval_xc_2-85"><span class="linenos"> 85</span></a><span class="sd">    - Blocks are randomly shuffled before processing to balance parallel load.</span>
</span><span id="eval_xc_2-86"><a href="#eval_xc_2-86"><span class="linenos"> 86</span></a><span class="sd">    - Grid-based DFT evaluation using precomputed AO and gradient matrices is supported.</span>
</span><span id="eval_xc_2-87"><a href="#eval_xc_2-87"><span class="linenos"> 87</span></a>
</span><span id="eval_xc_2-88"><a href="#eval_xc_2-88"><span class="linenos"> 88</span></a><span class="sd">    References</span>
</span><span id="eval_xc_2-89"><a href="#eval_xc_2-89"><span class="linenos"> 89</span></a><span class="sd">    ----------</span>
</span><span id="eval_xc_2-90"><a href="#eval_xc_2-90"><span class="linenos"> 90</span></a><span class="sd">    - LibXC Functional Codes: https://libxc.gitlab.io/functionals/</span>
</span><span id="eval_xc_2-91"><a href="#eval_xc_2-91"><span class="linenos"> 91</span></a><span class="sd">    - XC term evaluation inspired from: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_2-92"><a href="#eval_xc_2-92"><span class="linenos"> 92</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="eval_xc_2-93"><a href="#eval_xc_2-93"><span class="linenos"> 93</span></a>    <span class="c1"># This performs parallelization at the blocks/batches level.</span>
</span><span id="eval_xc_2-94"><a href="#eval_xc_2-94"><span class="linenos"> 94</span></a>    <span class="c1"># Therefore, joblib is perfect for such embarrasingly parallel task</span>
</span><span id="eval_xc_2-95"><a href="#eval_xc_2-95"><span class="linenos"> 95</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_2-96"><a href="#eval_xc_2-96"><span class="linenos"> 96</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_2-97"><a href="#eval_xc_2-97"><span class="linenos"> 97</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_2-98"><a href="#eval_xc_2-98"><span class="linenos"> 98</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_2-99"><a href="#eval_xc_2-99"><span class="linenos"> 99</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_2-100"><a href="#eval_xc_2-100"><span class="linenos">100</span></a>
</span><span id="eval_xc_2-101"><a href="#eval_xc_2-101"><span class="linenos">101</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_2-102"><a href="#eval_xc_2-102"><span class="linenos">102</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_2-103"><a href="#eval_xc_2-103"><span class="linenos">103</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_2-104"><a href="#eval_xc_2-104"><span class="linenos">104</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_2-105"><a href="#eval_xc_2-105"><span class="linenos">105</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_2-106"><a href="#eval_xc_2-106"><span class="linenos">106</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_2-107"><a href="#eval_xc_2-107"><span class="linenos">107</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_2-108"><a href="#eval_xc_2-108"><span class="linenos">108</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_2-109"><a href="#eval_xc_2-109"><span class="linenos">109</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_2-110"><a href="#eval_xc_2-110"><span class="linenos">110</span></a>
</span><span id="eval_xc_2-111"><a href="#eval_xc_2-111"><span class="linenos">111</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_2-112"><a href="#eval_xc_2-112"><span class="linenos">112</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_2-113"><a href="#eval_xc_2-113"><span class="linenos">113</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-114"><a href="#eval_xc_2-114"><span class="linenos">114</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_2-115"><a href="#eval_xc_2-115"><span class="linenos">115</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">))</span>
</span><span id="eval_xc_2-116"><a href="#eval_xc_2-116"><span class="linenos">116</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2-117"><a href="#eval_xc_2-117"><span class="linenos">117</span></a>
</span><span id="eval_xc_2-118"><a href="#eval_xc_2-118"><span class="linenos">118</span></a>    <span class="c1"># TODO it only works for LDA functionals for now.</span>
</span><span id="eval_xc_2-119"><a href="#eval_xc_2-119"><span class="linenos">119</span></a>    <span class="c1"># Need to make it work for GGA, Hybrid, range-separated Hybrid and MetaGGA functionals as well.</span>
</span><span id="eval_xc_2-120"><a href="#eval_xc_2-120"><span class="linenos">120</span></a>    
</span><span id="eval_xc_2-121"><a href="#eval_xc_2-121"><span class="linenos">121</span></a>
</span><span id="eval_xc_2-122"><a href="#eval_xc_2-122"><span class="linenos">122</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_2-123"><a href="#eval_xc_2-123"><span class="linenos">123</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_2-124"><a href="#eval_xc_2-124"><span class="linenos">124</span></a>
</span><span id="eval_xc_2-125"><a href="#eval_xc_2-125"><span class="linenos">125</span></a>    <span class="c1"># print(&#39;Number of blocks: &#39;, nblocks)</span>
</span><span id="eval_xc_2-126"><a href="#eval_xc_2-126"><span class="linenos">126</span></a>
</span><span id="eval_xc_2-127"><a href="#eval_xc_2-127"><span class="linenos">127</span></a>    <span class="c1"># Some stuff to note timings</span>
</span><span id="eval_xc_2-128"><a href="#eval_xc_2-128"><span class="linenos">128</span></a>    <span class="n">timings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_2-129"><a href="#eval_xc_2-129"><span class="linenos">129</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2-130"><a href="#eval_xc_2-130"><span class="linenos">130</span></a>        <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-131"><a href="#eval_xc_2-131"><span class="linenos">131</span></a>        <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-132"><a href="#eval_xc_2-132"><span class="linenos">132</span></a>        <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-133"><a href="#eval_xc_2-133"><span class="linenos">133</span></a>        <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-134"><a href="#eval_xc_2-134"><span class="linenos">134</span></a>        <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-135"><a href="#eval_xc_2-135"><span class="linenos">135</span></a>        <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-136"><a href="#eval_xc_2-136"><span class="linenos">136</span></a>        <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2-137"><a href="#eval_xc_2-137"><span class="linenos">137</span></a>        <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">:</span><span class="n">durationLibxc</span><span class="p">,</span> <span class="s1">&#39;durationE&#39;</span><span class="p">:</span><span class="n">durationE</span><span class="p">,</span> <span class="s1">&#39;durationF&#39;</span><span class="p">:</span><span class="n">durationF</span><span class="p">,</span> <span class="s1">&#39;durationZ&#39;</span><span class="p">:</span><span class="n">durationZ</span><span class="p">,</span> <span class="s1">&#39;durationV&#39;</span><span class="p">:</span><span class="n">durationV</span><span class="p">,</span> <span class="s1">&#39;durationRho&#39;</span><span class="p">:</span><span class="n">durationRho</span><span class="p">,</span> <span class="s1">&#39;durationAO&#39;</span><span class="p">:</span><span class="n">durationAO</span><span class="p">}</span>
</span><span id="eval_xc_2-138"><a href="#eval_xc_2-138"><span class="linenos">138</span></a>
</span><span id="eval_xc_2-139"><a href="#eval_xc_2-139"><span class="linenos">139</span></a>    
</span><span id="eval_xc_2-140"><a href="#eval_xc_2-140"><span class="linenos">140</span></a>
</span><span id="eval_xc_2-141"><a href="#eval_xc_2-141"><span class="linenos">141</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_2-142"><a href="#eval_xc_2-142"><span class="linenos">142</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_2-143"><a href="#eval_xc_2-143"><span class="linenos">143</span></a>    <span class="c1"># This will help to make the call to evalbfnumba1 faster by skipping the mediator evalbfnumbawrap function </span>
</span><span id="eval_xc_2-144"><a href="#eval_xc_2-144"><span class="linenos">144</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_2-145"><a href="#eval_xc_2-145"><span class="linenos">145</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_2-146"><a href="#eval_xc_2-146"><span class="linenos">146</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="eval_xc_2-147"><a href="#eval_xc_2-147"><span class="linenos">147</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="eval_xc_2-148"><a href="#eval_xc_2-148"><span class="linenos">148</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_2-149"><a href="#eval_xc_2-149"><span class="linenos">149</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_2-150"><a href="#eval_xc_2-150"><span class="linenos">150</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_2-151"><a href="#eval_xc_2-151"><span class="linenos">151</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_2-152"><a href="#eval_xc_2-152"><span class="linenos">152</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_2-153"><a href="#eval_xc_2-153"><span class="linenos">153</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_2-154"><a href="#eval_xc_2-154"><span class="linenos">154</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_2-155"><a href="#eval_xc_2-155"><span class="linenos">155</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_2-156"><a href="#eval_xc_2-156"><span class="linenos">156</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2-157"><a href="#eval_xc_2-157"><span class="linenos">157</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2-158"><a href="#eval_xc_2-158"><span class="linenos">158</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2-159"><a href="#eval_xc_2-159"><span class="linenos">159</span></a>    <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">])</span>
</span><span id="eval_xc_2-160"><a href="#eval_xc_2-160"><span class="linenos">160</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_2-161"><a href="#eval_xc_2-161"><span class="linenos">161</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_2-162"><a href="#eval_xc_2-162"><span class="linenos">162</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2-163"><a href="#eval_xc_2-163"><span class="linenos">163</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2-164"><a href="#eval_xc_2-164"><span class="linenos">164</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2-165"><a href="#eval_xc_2-165"><span class="linenos">165</span></a>            <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_2-166"><a href="#eval_xc_2-166"><span class="linenos">166</span></a>    <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_2-167"><a href="#eval_xc_2-167"><span class="linenos">167</span></a>    <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_2-168"><a href="#eval_xc_2-168"><span class="linenos">168</span></a>    <span class="n">bfs_data_as_np_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">bfs_radius_cutoff</span><span class="p">]</span>
</span><span id="eval_xc_2-169"><a href="#eval_xc_2-169"><span class="linenos">169</span></a>
</span><span id="eval_xc_2-170"><a href="#eval_xc_2-170"><span class="linenos">170</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_2-171"><a href="#eval_xc_2-171"><span class="linenos">171</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_2-172"><a href="#eval_xc_2-172"><span class="linenos">172</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_2-173"><a href="#eval_xc_2-173"><span class="linenos">173</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_2-174"><a href="#eval_xc_2-174"><span class="linenos">174</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_2-175"><a href="#eval_xc_2-175"><span class="linenos">175</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_2-176"><a href="#eval_xc_2-176"><span class="linenos">176</span></a>
</span><span id="eval_xc_2-177"><a href="#eval_xc_2-177"><span class="linenos">177</span></a>    <span class="c1">#### Set number of cores for numba related evaluations within &#39;block_dens_func()&#39; for example bf_value evaluations </span>
</span><span id="eval_xc_2-178"><a href="#eval_xc_2-178"><span class="linenos">178</span></a>    <span class="c1">#### Apparently, it was still using as many cores as possible and creating a serial version of thise functions as I have </span>
</span><span id="eval_xc_2-179"><a href="#eval_xc_2-179"><span class="linenos">179</span></a>    <span class="c1">#### currently done doesn&#39;t work  </span>
</span><span id="eval_xc_2-180"><a href="#eval_xc_2-180"><span class="linenos">180</span></a>    <span class="c1"># numba.set_num_threads(1)</span>
</span><span id="eval_xc_2-181"><a href="#eval_xc_2-181"><span class="linenos">181</span></a>    <span class="c1"># Shuffle the blocks (for load balancing)</span>
</span><span id="eval_xc_2-182"><a href="#eval_xc_2-182"><span class="linenos">182</span></a>    <span class="n">block_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_2-183"><a href="#eval_xc_2-183"><span class="linenos">183</span></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">block_indices</span><span class="p">)</span>
</span><span id="eval_xc_2-184"><a href="#eval_xc_2-184"><span class="linenos">184</span></a>
</span><span id="eval_xc_2-185"><a href="#eval_xc_2-185"><span class="linenos">185</span></a>    <span class="c1"># rho_blocks = [np.zeros((blocksize,1)) for _ in range(nblocks+1)]</span>
</span><span id="eval_xc_2-186"><a href="#eval_xc_2-186"><span class="linenos">186</span></a>    
</span><span id="eval_xc_2-187"><a href="#eval_xc_2-187"><span class="linenos">187</span></a>    <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">ncores</span><span class="o">&gt;</span><span class="n">nblocks</span><span class="p">:</span>
</span><span id="eval_xc_2-188"><a href="#eval_xc_2-188"><span class="linenos">188</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span>
</span><span id="eval_xc_2-189"><a href="#eval_xc_2-189"><span class="linenos">189</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2-190"><a href="#eval_xc_2-190"><span class="linenos">190</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">nblocks</span><span class="o">//</span><span class="p">(</span><span class="n">ncores</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span><span id="eval_xc_2-191"><a href="#eval_xc_2-191"><span class="linenos">191</span></a>
</span><span id="eval_xc_2-192"><a href="#eval_xc_2-192"><span class="linenos">192</span></a>    <span class="c1"># NumExpr expressions compile</span>
</span><span id="eval_xc_2-193"><a href="#eval_xc_2-193"><span class="linenos">193</span></a>    <span class="n">expr_den</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;rho_block*weights_block&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-194"><a href="#eval_xc_2-194"><span class="linenos">194</span></a>    <span class="n">expr_F</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;weights_block*v_rho_temp&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-195"><a href="#eval_xc_2-195"><span class="linenos">195</span></a>    <span class="n">expr_z</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;0.5*F*ao_value_block_T&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-196"><a href="#eval_xc_2-196"><span class="linenos">196</span></a>    <span class="n">expr_v</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;v_temp + v_temp_T&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-197"><a href="#eval_xc_2-197"><span class="linenos">197</span></a>    <span class="n">expr_sigma_block</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;rho_grad_block_x**2 + rho_grad_block_y**2 + rho_grad_block_z**2&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-198"><a href="#eval_xc_2-198"><span class="linenos">198</span></a>    <span class="n">expr_Ftemp</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;2*weights_block*vsigma_temp&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-199"><a href="#eval_xc_2-199"><span class="linenos">199</span></a>    <span class="n">expr_Fx</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;Ftemp*rho_grad_block_x&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-200"><a href="#eval_xc_2-200"><span class="linenos">200</span></a>    <span class="n">expr_Fy</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;Ftemp*rho_grad_block_y&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-201"><a href="#eval_xc_2-201"><span class="linenos">201</span></a>    <span class="n">expr_Fz</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;Ftemp*rho_grad_block_z&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-202"><a href="#eval_xc_2-202"><span class="linenos">202</span></a>    <span class="n">expr_z_grad</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">NumExpr</span><span class="p">(</span><span class="s1">&#39;Fx*ao_value_gradx_block_T + Fy*ao_value_grady_block_T + Fz*ao_value_gradz_block_T&#39;</span><span class="p">)</span>
</span><span id="eval_xc_2-203"><a href="#eval_xc_2-203"><span class="linenos">203</span></a>    <span class="n">numexpr_expr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expr_den&#39;</span><span class="p">:</span><span class="n">expr_den</span><span class="p">,</span> <span class="s1">&#39;expr_F&#39;</span><span class="p">:</span><span class="n">expr_F</span><span class="p">,</span> <span class="s1">&#39;expr_z&#39;</span><span class="p">:</span><span class="n">expr_z</span><span class="p">,</span> <span class="s1">&#39;expr_v&#39;</span><span class="p">:</span><span class="n">expr_v</span><span class="p">,</span> <span class="s1">&#39;expr_sigma_block&#39;</span><span class="p">:</span><span class="n">expr_sigma_block</span><span class="p">,</span> \
</span><span id="eval_xc_2-204"><a href="#eval_xc_2-204"><span class="linenos">204</span></a>                    <span class="s1">&#39;expr_Fx&#39;</span><span class="p">:</span><span class="n">expr_Fx</span><span class="p">,</span> <span class="s1">&#39;expr_Fy&#39;</span><span class="p">:</span><span class="n">expr_Fy</span><span class="p">,</span> <span class="s1">&#39;expr_Fz&#39;</span><span class="p">:</span><span class="n">expr_Fz</span><span class="p">,</span> <span class="s1">&#39;expr_z_grad&#39;</span><span class="p">:</span><span class="n">expr_z_grad</span><span class="p">,</span> <span class="s1">&#39;expr_Ftemp&#39;</span><span class="p">:</span><span class="n">expr_Ftemp</span><span class="p">}</span>
</span><span id="eval_xc_2-205"><a href="#eval_xc_2-205"><span class="linenos">205</span></a>
</span><span id="eval_xc_2-206"><a href="#eval_xc_2-206"><span class="linenos">206</span></a>
</span><span id="eval_xc_2-207"><a href="#eval_xc_2-207"><span class="linenos">207</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2-208"><a href="#eval_xc_2-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2-209"><a href="#eval_xc_2-209"><span class="linenos">209</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_2-210"><a href="#eval_xc_2-210"><span class="linenos">210</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">ncores</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">numexpr_expr</span><span class="o">=</span><span class="n">numexpr_expr</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">)</span>
</span><span id="eval_xc_2-211"><a href="#eval_xc_2-211"><span class="linenos">211</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#GGA</span>
</span><span id="eval_xc_2-212"><a href="#eval_xc_2-212"><span class="linenos">212</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">list_ao_grad_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">numexpr_expr</span><span class="o">=</span><span class="n">numexpr_expr</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">)</span>
</span><span id="eval_xc_2-213"><a href="#eval_xc_2-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2-214"><a href="#eval_xc_2-214"><span class="linenos">214</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">numexpr_expr</span><span class="o">=</span><span class="n">numexpr_expr</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">)</span>
</span><span id="eval_xc_2-215"><a href="#eval_xc_2-215"><span class="linenos">215</span></a>            <span class="c1"># output = Parallel(n_jobs=ncores, backend=&#39;loky&#39;)(delayed(block_dens_func)(weights[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], coords[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], dmat[np.ix_(list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])], funcid, bfs_data_as_np_arrays, list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], funcx=None, funcc=None, x_family_code=x_family_code, c_family_code=c_family_code, xc_family_dict=xc_family_dict, debug=debug) for iblock in block_indices)</span>
</span><span id="eval_xc_2-216"><a href="#eval_xc_2-216"><span class="linenos">216</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2-217"><a href="#eval_xc_2-217"><span class="linenos">217</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">numexpr_expr</span><span class="o">=</span><span class="n">numexpr_expr</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">)</span>
</span><span id="eval_xc_2-218"><a href="#eval_xc_2-218"><span class="linenos">218</span></a>        
</span><span id="eval_xc_2-219"><a href="#eval_xc_2-219"><span class="linenos">219</span></a>    <span class="n">indx_block_output</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2-220"><a href="#eval_xc_2-220"><span class="linenos">220</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">:</span>
</span><span id="eval_xc_2-221"><a href="#eval_xc_2-221"><span class="linenos">221</span></a>        <span class="n">efunc</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_2-222"><a href="#eval_xc_2-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2-223"><a href="#eval_xc_2-223"><span class="linenos">223</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]]</span>
</span><span id="eval_xc_2-224"><a href="#eval_xc_2-224"><span class="linenos">224</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_2-225"><a href="#eval_xc_2-225"><span class="linenos">225</span></a>            <span class="c1"># slice = np.ix_(non_zero_indices, non_zero_indices)</span>
</span><span id="eval_xc_2-226"><a href="#eval_xc_2-226"><span class="linenos">226</span></a>            <span class="c1"># v[slice] = numexpr.evaluate(&quot;(v_ + output_)&quot;, {&#39;v_&#39;:v[slice], &#39;output_&#39;:output[indx_block_output][1]})</span>
</span><span id="eval_xc_2-227"><a href="#eval_xc_2-227"><span class="linenos">227</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2-228"><a href="#eval_xc_2-228"><span class="linenos">228</span></a>            <span class="n">v</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_2-229"><a href="#eval_xc_2-229"><span class="linenos">229</span></a>        <span class="n">nelec</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="eval_xc_2-230"><a href="#eval_xc_2-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2-231"><a href="#eval_xc_2-231"><span class="linenos">231</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-232"><a href="#eval_xc_2-232"><span class="linenos">232</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-233"><a href="#eval_xc_2-233"><span class="linenos">233</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-234"><a href="#eval_xc_2-234"><span class="linenos">234</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-235"><a href="#eval_xc_2-235"><span class="linenos">235</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-236"><a href="#eval_xc_2-236"><span class="linenos">236</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-237"><a href="#eval_xc_2-237"><span class="linenos">237</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">indx_block_output</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2-238"><a href="#eval_xc_2-238"><span class="linenos">238</span></a>        <span class="n">indx_block_output</span> <span class="o">+=</span> <span class="mi">1</span> 
</span><span id="eval_xc_2-239"><a href="#eval_xc_2-239"><span class="linenos">239</span></a>        <span class="c1"># v = numexpr.evaluate(&#39;(v + output[iblock][1])&#39;)</span>
</span><span id="eval_xc_2-240"><a href="#eval_xc_2-240"><span class="linenos">240</span></a>
</span><span id="eval_xc_2-241"><a href="#eval_xc_2-241"><span class="linenos">241</span></a>    <span class="c1"># print(&#39;here1&#39;)</span>
</span><span id="eval_xc_2-242"><a href="#eval_xc_2-242"><span class="linenos">242</span></a>    <span class="c1"># for i in range(1000):</span>
</span><span id="eval_xc_2-243"><a href="#eval_xc_2-243"><span class="linenos">243</span></a>    <span class="c1">#     a = dmat[np.ix_(list_nonzero_indices[60][0:count_nonzero_indices[60]], list_nonzero_indices[60][0:count_nonzero_indices[60]])]</span>
</span><span id="eval_xc_2-244"><a href="#eval_xc_2-244"><span class="linenos">244</span></a>    <span class="c1"># print(&#39;here2&#39;)</span>
</span><span id="eval_xc_2-245"><a href="#eval_xc_2-245"><span class="linenos">245</span></a>    
</span><span id="eval_xc_2-246"><a href="#eval_xc_2-246"><span class="linenos">246</span></a>
</span><span id="eval_xc_2-247"><a href="#eval_xc_2-247"><span class="linenos">247</span></a>    <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>    
</span><span id="eval_xc_2-248"><a href="#eval_xc_2-248"><span class="linenos">248</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_2-249"><a href="#eval_xc_2-249"><span class="linenos">249</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2-250"><a href="#eval_xc_2-250"><span class="linenos">250</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timings:&#39;</span><span class="p">,</span> <span class="n">timings</span><span class="p">)</span>
</span><span id="eval_xc_2-251"><a href="#eval_xc_2-251"><span class="linenos">251</span></a>
</span><span id="eval_xc_2-252"><a href="#eval_xc_2-252"><span class="linenos">252</span></a>    <span class="c1">####### Free memory</span>
</span><span id="eval_xc_2-253"><a href="#eval_xc_2-253"><span class="linenos">253</span></a>    <span class="c1">## The following is very important to prevent memory leaks and also to make sure that the number of </span>
</span><span id="eval_xc_2-254"><a href="#eval_xc_2-254"><span class="linenos">254</span></a>    <span class="c1"># threads used by the program is same as that specified by the user </span>
</span><span id="eval_xc_2-255"><a href="#eval_xc_2-255"><span class="linenos">255</span></a>    <span class="c1"># gc.collect()  # Avoiding using it for now, as it is usually quite slow, although in this case it might not make much difference</span>
</span><span id="eval_xc_2-256"><a href="#eval_xc_2-256"><span class="linenos">256</span></a>    <span class="c1"># Anyway, the following also works</span>
</span><span id="eval_xc_2-257"><a href="#eval_xc_2-257"><span class="linenos">257</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2-258"><a href="#eval_xc_2-258"><span class="linenos">258</span></a>    <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2-259"><a href="#eval_xc_2-259"><span class="linenos">259</span></a>    <span class="n">coords</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2-260"><a href="#eval_xc_2-260"><span class="linenos">260</span></a>
</span><span id="eval_xc_2-261"><a href="#eval_xc_2-261"><span class="linenos">261</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate exchange-correlation (XC) energy and potential matrix for DFT
using algorithm 2, which is the preferred algorithm for running DFT on CPU.</p>

<p>In algorithm 2, the XC term is evaluated by parallelizing over batches.
In contrast, the algorithm 1 evaluates the XC term by looping over batches and 
parallelizing the operations within the batch, which is suboptimal.</p>

<p>This function evaluates the XC energy and potential matrix elements for a given
density matrix using grid-based numerical integration. It supports LDA and GGA 
functionals (via LibXC), parallel execution with <code>joblib</code>, and sparse AO matrix blocks.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : Basis
    A basis object containing basis function data: exponents, coefficients, 
    angular momentum, normalization, etc.</p>

<p>dmat : np.ndarray
    The one-electron density matrix in the AO basis.</p>

<p>weights : np.ndarray
    Integration weights associated with each grid point.</p>

<p>coords : np.ndarray
    Grid point coordinates as an (N, 3) array.</p>

<p>funcid : list of int, optional
    LibXC functional IDs. Default is [1, 7] for Slater (X) and VWN (C) (LDA).</p>

<p>spin : int, optional
    Spin multiplicity: 0 for unpolarized, 1 for spin-polarized (not allowed currently).</p>

<p>ncores : int, optional
    Number of threads/cores for parallel execution. Default is 2.</p>

<p>blocksize : int, optional
    Number of grid points to process per block. Default is 5000.</p>

<p>list_nonzero_indices : list of np.ndarray, optional
    Precomputed list of nonzero AO indices per block for sparse evaluation.</p>

<p>count_nonzero_indices : list of int, optional
    Number of nonzero indices in each block (matches <code>list_nonzero_indices</code>).</p>

<p>list_ao_values : list of np.ndarray, optional
    Precomputed AO values at grid points for each block.</p>

<p>list_ao_grad_values : list of tuple of np.ndarray, optional
    Precomputed AO gradient values (x, y, z) at grid points for each block.</p>

<p>debug : bool, optional
    If True, print detailed timing and diagnostic info.</p>

<h2 id="returns">Returns</h2>

<p>efunc : float
    Total exchange-correlation energy.</p>

<p>v : np.ndarray
    Exchange-correlation potential matrix in the AO basis.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Only supports LDA and GGA functionals currently. meta-GGA and hybrid support is in development.</li>
<li>Uses LibXC for energy and derivative functional evaluation.</li>
<li>Blocks are randomly shuffled before processing to balance parallel load.</li>
<li>Grid-based DFT evaluation using precomputed AO and gradient matrices is supported.</li>
</ul>

<h2 id="references">References</h2>

<ul>
<li>LibXC Functional Codes: <a href="https://libxc.gitlab.io/functionals/">https://libxc.gitlab.io/functionals/</a></li>
<li>XC term evaluation inspired from: <a href="https://pubs.acs.org/doi/full/10.1021/ct200412r">https://pubs.acs.org/doi/full/10.1021/ct200412r</a></li>
</ul>
</div>


                </section>
                <section id="eval_xc_3">
                            <input id="eval_xc_3-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_3</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">ncores</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_3-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_3"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_3-16"><a href="#eval_xc_3-16"><span class="linenos"> 16</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="eval_xc_3-17"><a href="#eval_xc_3-17"><span class="linenos"> 17</span></a>    <span class="c1"># This performs parallelization at the blocks/batches level.</span>
</span><span id="eval_xc_3-18"><a href="#eval_xc_3-18"><span class="linenos"> 18</span></a>    <span class="c1"># Therefore, joblib is perfect for such embarrasingly parallel task</span>
</span><span id="eval_xc_3-19"><a href="#eval_xc_3-19"><span class="linenos"> 19</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_3-20"><a href="#eval_xc_3-20"><span class="linenos"> 20</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_3-21"><a href="#eval_xc_3-21"><span class="linenos"> 21</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_3-22"><a href="#eval_xc_3-22"><span class="linenos"> 22</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_3-23"><a href="#eval_xc_3-23"><span class="linenos"> 23</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_3-24"><a href="#eval_xc_3-24"><span class="linenos"> 24</span></a>
</span><span id="eval_xc_3-25"><a href="#eval_xc_3-25"><span class="linenos"> 25</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_3-26"><a href="#eval_xc_3-26"><span class="linenos"> 26</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_3-27"><a href="#eval_xc_3-27"><span class="linenos"> 27</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_3-28"><a href="#eval_xc_3-28"><span class="linenos"> 28</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_3-29"><a href="#eval_xc_3-29"><span class="linenos"> 29</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_3-30"><a href="#eval_xc_3-30"><span class="linenos"> 30</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_3-31"><a href="#eval_xc_3-31"><span class="linenos"> 31</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_3-32"><a href="#eval_xc_3-32"><span class="linenos"> 32</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_3-33"><a href="#eval_xc_3-33"><span class="linenos"> 33</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_3-34"><a href="#eval_xc_3-34"><span class="linenos"> 34</span></a>
</span><span id="eval_xc_3-35"><a href="#eval_xc_3-35"><span class="linenos"> 35</span></a>    <span class="c1"># Start Ray.</span>
</span><span id="eval_xc_3-36"><a href="#eval_xc_3-36"><span class="linenos"> 36</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
</span><span id="eval_xc_3-37"><a href="#eval_xc_3-37"><span class="linenos"> 37</span></a>        <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="n">ncores</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="eval_xc_3-38"><a href="#eval_xc_3-38"><span class="linenos"> 38</span></a>
</span><span id="eval_xc_3-39"><a href="#eval_xc_3-39"><span class="linenos"> 39</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_3-40"><a href="#eval_xc_3-40"><span class="linenos"> 40</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_3-41"><a href="#eval_xc_3-41"><span class="linenos"> 41</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-42"><a href="#eval_xc_3-42"><span class="linenos"> 42</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_3-43"><a href="#eval_xc_3-43"><span class="linenos"> 43</span></a>    <span class="c1"># with threadpool_limits(limits=1, user_api=&#39;blas&#39;):</span>
</span><span id="eval_xc_3-44"><a href="#eval_xc_3-44"><span class="linenos"> 44</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">))</span>
</span><span id="eval_xc_3-45"><a href="#eval_xc_3-45"><span class="linenos"> 45</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3-46"><a href="#eval_xc_3-46"><span class="linenos"> 46</span></a>
</span><span id="eval_xc_3-47"><a href="#eval_xc_3-47"><span class="linenos"> 47</span></a>    <span class="c1"># TODO it only works for LDA functionals for now.</span>
</span><span id="eval_xc_3-48"><a href="#eval_xc_3-48"><span class="linenos"> 48</span></a>    <span class="c1"># Need to make it work for GGA, Hybrid, range-separated Hybrid and MetaGGA functionals as well.</span>
</span><span id="eval_xc_3-49"><a href="#eval_xc_3-49"><span class="linenos"> 49</span></a>    
</span><span id="eval_xc_3-50"><a href="#eval_xc_3-50"><span class="linenos"> 50</span></a>
</span><span id="eval_xc_3-51"><a href="#eval_xc_3-51"><span class="linenos"> 51</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_3-52"><a href="#eval_xc_3-52"><span class="linenos"> 52</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_3-53"><a href="#eval_xc_3-53"><span class="linenos"> 53</span></a>
</span><span id="eval_xc_3-54"><a href="#eval_xc_3-54"><span class="linenos"> 54</span></a>    <span class="c1"># print(&#39;Number of blocks: &#39;, nblocks)</span>
</span><span id="eval_xc_3-55"><a href="#eval_xc_3-55"><span class="linenos"> 55</span></a>
</span><span id="eval_xc_3-56"><a href="#eval_xc_3-56"><span class="linenos"> 56</span></a>    <span class="c1"># Some stuff to note timings</span>
</span><span id="eval_xc_3-57"><a href="#eval_xc_3-57"><span class="linenos"> 57</span></a>    <span class="n">timings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_3-58"><a href="#eval_xc_3-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3-59"><a href="#eval_xc_3-59"><span class="linenos"> 59</span></a>        <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-60"><a href="#eval_xc_3-60"><span class="linenos"> 60</span></a>        <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-61"><a href="#eval_xc_3-61"><span class="linenos"> 61</span></a>        <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-62"><a href="#eval_xc_3-62"><span class="linenos"> 62</span></a>        <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-63"><a href="#eval_xc_3-63"><span class="linenos"> 63</span></a>        <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-64"><a href="#eval_xc_3-64"><span class="linenos"> 64</span></a>        <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-65"><a href="#eval_xc_3-65"><span class="linenos"> 65</span></a>        <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3-66"><a href="#eval_xc_3-66"><span class="linenos"> 66</span></a>        <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">:</span><span class="n">durationLibxc</span><span class="p">,</span> <span class="s1">&#39;durationE&#39;</span><span class="p">:</span><span class="n">durationE</span><span class="p">,</span> <span class="s1">&#39;durationF&#39;</span><span class="p">:</span><span class="n">durationF</span><span class="p">,</span> <span class="s1">&#39;durationZ&#39;</span><span class="p">:</span><span class="n">durationZ</span><span class="p">,</span> <span class="s1">&#39;durationV&#39;</span><span class="p">:</span><span class="n">durationV</span><span class="p">,</span> <span class="s1">&#39;durationRho&#39;</span><span class="p">:</span><span class="n">durationRho</span><span class="p">,</span> <span class="s1">&#39;durationAO&#39;</span><span class="p">:</span><span class="n">durationAO</span><span class="p">}</span>
</span><span id="eval_xc_3-67"><a href="#eval_xc_3-67"><span class="linenos"> 67</span></a>
</span><span id="eval_xc_3-68"><a href="#eval_xc_3-68"><span class="linenos"> 68</span></a>    
</span><span id="eval_xc_3-69"><a href="#eval_xc_3-69"><span class="linenos"> 69</span></a>
</span><span id="eval_xc_3-70"><a href="#eval_xc_3-70"><span class="linenos"> 70</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_3-71"><a href="#eval_xc_3-71"><span class="linenos"> 71</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_3-72"><a href="#eval_xc_3-72"><span class="linenos"> 72</span></a>    <span class="c1"># This will help to make the call to evalbfnumba1 faster by skipping the mediator evalbfnumbawrap function </span>
</span><span id="eval_xc_3-73"><a href="#eval_xc_3-73"><span class="linenos"> 73</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_3-74"><a href="#eval_xc_3-74"><span class="linenos"> 74</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_3-75"><a href="#eval_xc_3-75"><span class="linenos"> 75</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="eval_xc_3-76"><a href="#eval_xc_3-76"><span class="linenos"> 76</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="eval_xc_3-77"><a href="#eval_xc_3-77"><span class="linenos"> 77</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_3-78"><a href="#eval_xc_3-78"><span class="linenos"> 78</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_3-79"><a href="#eval_xc_3-79"><span class="linenos"> 79</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_3-80"><a href="#eval_xc_3-80"><span class="linenos"> 80</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_3-81"><a href="#eval_xc_3-81"><span class="linenos"> 81</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_3-82"><a href="#eval_xc_3-82"><span class="linenos"> 82</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_3-83"><a href="#eval_xc_3-83"><span class="linenos"> 83</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_3-84"><a href="#eval_xc_3-84"><span class="linenos"> 84</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_3-85"><a href="#eval_xc_3-85"><span class="linenos"> 85</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_3-86"><a href="#eval_xc_3-86"><span class="linenos"> 86</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_3-87"><a href="#eval_xc_3-87"><span class="linenos"> 87</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_3-88"><a href="#eval_xc_3-88"><span class="linenos"> 88</span></a>    <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">])</span>
</span><span id="eval_xc_3-89"><a href="#eval_xc_3-89"><span class="linenos"> 89</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_3-90"><a href="#eval_xc_3-90"><span class="linenos"> 90</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_3-91"><a href="#eval_xc_3-91"><span class="linenos"> 91</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3-92"><a href="#eval_xc_3-92"><span class="linenos"> 92</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3-93"><a href="#eval_xc_3-93"><span class="linenos"> 93</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3-94"><a href="#eval_xc_3-94"><span class="linenos"> 94</span></a>            <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_3-95"><a href="#eval_xc_3-95"><span class="linenos"> 95</span></a>    <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_3-96"><a href="#eval_xc_3-96"><span class="linenos"> 96</span></a>    <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_3-97"><a href="#eval_xc_3-97"><span class="linenos"> 97</span></a>    <span class="n">bfs_data_as_np_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">bfs_radius_cutoff</span><span class="p">]</span>
</span><span id="eval_xc_3-98"><a href="#eval_xc_3-98"><span class="linenos"> 98</span></a>
</span><span id="eval_xc_3-99"><a href="#eval_xc_3-99"><span class="linenos"> 99</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_3-100"><a href="#eval_xc_3-100"><span class="linenos">100</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_3-101"><a href="#eval_xc_3-101"><span class="linenos">101</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_3-102"><a href="#eval_xc_3-102"><span class="linenos">102</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_3-103"><a href="#eval_xc_3-103"><span class="linenos">103</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_3-104"><a href="#eval_xc_3-104"><span class="linenos">104</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_3-105"><a href="#eval_xc_3-105"><span class="linenos">105</span></a>
</span><span id="eval_xc_3-106"><a href="#eval_xc_3-106"><span class="linenos">106</span></a>    <span class="c1"># weights_put = ray.put(weights)</span>
</span><span id="eval_xc_3-107"><a href="#eval_xc_3-107"><span class="linenos">107</span></a>    <span class="c1"># coords_put = ray.put(coords)</span>
</span><span id="eval_xc_3-108"><a href="#eval_xc_3-108"><span class="linenos">108</span></a>    <span class="n">bfs_data_as_np_arrays</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">bfs_data_as_np_arrays</span><span class="p">)</span>
</span><span id="eval_xc_3-109"><a href="#eval_xc_3-109"><span class="linenos">109</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3-110"><a href="#eval_xc_3-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3-111"><a href="#eval_xc_3-111"><span class="linenos">111</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_3-112"><a href="#eval_xc_3-112"><span class="linenos">112</span></a>                <span class="c1"># Launch four parallel square tasks</span>
</span><span id="eval_xc_3-113"><a href="#eval_xc_3-113"><span class="linenos">113</span></a>                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_dens_func</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="eval_xc_3-114"><a href="#eval_xc_3-114"><span class="linenos">114</span></a>    <span class="c1">#         else: #GGA</span>
</span><span id="eval_xc_3-115"><a href="#eval_xc_3-115"><span class="linenos">115</span></a>    <span class="c1">#             output = Parallel(n_jobs=ncores, backend=&#39;threading&#39;, require=&#39;sharedmem&#39;, batch_size=batch_size)(delayed(block_dens_func)(weights[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], coords[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], dmat[np.ix_(list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])], funcid, bfs_data_as_np_arrays, list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], list_ao_values[iblock], list_ao_grad_values[iblock], funcx=funcx, funcc=funcc, x_family_code=x_family_code, c_family_code=c_family_code, xc_family_dict=xc_family_dict, debug=debug) for iblock in block_indices)</span>
</span><span id="eval_xc_3-116"><a href="#eval_xc_3-116"><span class="linenos">116</span></a>    <span class="c1">#     else:</span>
</span><span id="eval_xc_3-117"><a href="#eval_xc_3-117"><span class="linenos">117</span></a>    <span class="c1">#         output = Parallel(n_jobs=ncores, backend=&#39;threading&#39;, require=&#39;sharedmem&#39;, batch_size=batch_size)(delayed(block_dens_func)(weights[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], coords[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], dmat[np.ix_(list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])], funcid, bfs_data_as_np_arrays, list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]], funcx=funcx, funcc=funcc, x_family_code=x_family_code, c_family_code=c_family_code, xc_family_dict=xc_family_dict, debug=debug) for iblock in block_indices)</span>
</span><span id="eval_xc_3-118"><a href="#eval_xc_3-118"><span class="linenos">118</span></a>    <span class="c1"># else:</span>
</span><span id="eval_xc_3-119"><a href="#eval_xc_3-119"><span class="linenos">119</span></a>    <span class="c1">#     output = Parallel(n_jobs=ncores, backend=&#39;threading&#39;, require=&#39;sharedmem&#39;, batch_size=batch_size)(delayed(block_dens_func)(weights[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], coords[iblock*blocksize : min(iblock*blocksize+blocksize,ngrids)], dmat, funcid, bfs_data_as_np_arrays, non_zero_indices=None, ao_values=None, funcx=funcx, funcc=funcc, x_family_code=x_family_code, c_family_code=c_family_code, xc_family_dict=xc_family_dict, debug=debug) for iblock in block_indices)</span>
</span><span id="eval_xc_3-120"><a href="#eval_xc_3-120"><span class="linenos">120</span></a>        
</span><span id="eval_xc_3-121"><a href="#eval_xc_3-121"><span class="linenos">121</span></a>    <span class="c1"># Retrieve results</span>
</span><span id="eval_xc_3-122"><a href="#eval_xc_3-122"><span class="linenos">122</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</span><span id="eval_xc_3-123"><a href="#eval_xc_3-123"><span class="linenos">123</span></a>
</span><span id="eval_xc_3-124"><a href="#eval_xc_3-124"><span class="linenos">124</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="eval_xc_3-125"><a href="#eval_xc_3-125"><span class="linenos">125</span></a>        <span class="n">efunc</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_3-126"><a href="#eval_xc_3-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3-127"><a href="#eval_xc_3-127"><span class="linenos">127</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]]</span>
</span><span id="eval_xc_3-128"><a href="#eval_xc_3-128"><span class="linenos">128</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_3-129"><a href="#eval_xc_3-129"><span class="linenos">129</span></a>            <span class="c1"># v[np.ix_(non_zero_indices, non_zero_indices)] = numexpr.evaluate(&quot;(v_ + output_)&quot;, {&#39;v_&#39;:v[np.ix_(non_zero_indices, non_zero_indices)], &#39;output_&#39;:output[indx_block_output][1]})</span>
</span><span id="eval_xc_3-130"><a href="#eval_xc_3-130"><span class="linenos">130</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_3-131"><a href="#eval_xc_3-131"><span class="linenos">131</span></a>            <span class="n">v</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_3-132"><a href="#eval_xc_3-132"><span class="linenos">132</span></a>        <span class="n">nelec</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="eval_xc_3-133"><a href="#eval_xc_3-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3-134"><a href="#eval_xc_3-134"><span class="linenos">134</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-135"><a href="#eval_xc_3-135"><span class="linenos">135</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-136"><a href="#eval_xc_3-136"><span class="linenos">136</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-137"><a href="#eval_xc_3-137"><span class="linenos">137</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-138"><a href="#eval_xc_3-138"><span class="linenos">138</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-139"><a href="#eval_xc_3-139"><span class="linenos">139</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-140"><a href="#eval_xc_3-140"><span class="linenos">140</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3-141"><a href="#eval_xc_3-141"><span class="linenos">141</span></a>        <span class="c1"># v = numexpr.evaluate(&#39;(v + output[iblock][1])&#39;)</span>
</span><span id="eval_xc_3-142"><a href="#eval_xc_3-142"><span class="linenos">142</span></a>
</span><span id="eval_xc_3-143"><a href="#eval_xc_3-143"><span class="linenos">143</span></a>
</span><span id="eval_xc_3-144"><a href="#eval_xc_3-144"><span class="linenos">144</span></a>
</span><span id="eval_xc_3-145"><a href="#eval_xc_3-145"><span class="linenos">145</span></a>    <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>    
</span><span id="eval_xc_3-146"><a href="#eval_xc_3-146"><span class="linenos">146</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_3-147"><a href="#eval_xc_3-147"><span class="linenos">147</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3-148"><a href="#eval_xc_3-148"><span class="linenos">148</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timings:&#39;</span><span class="p">,</span> <span class="n">timings</span><span class="p">)</span>
</span><span id="eval_xc_3-149"><a href="#eval_xc_3-149"><span class="linenos">149</span></a>
</span><span id="eval_xc_3-150"><a href="#eval_xc_3-150"><span class="linenos">150</span></a>    <span class="c1">####### Free memory</span>
</span><span id="eval_xc_3-151"><a href="#eval_xc_3-151"><span class="linenos">151</span></a>    <span class="c1">## The following is very important to prevent memory leaks and also to make sure that the number of </span>
</span><span id="eval_xc_3-152"><a href="#eval_xc_3-152"><span class="linenos">152</span></a>    <span class="c1"># threads used by the program is same as that specified by the user </span>
</span><span id="eval_xc_3-153"><a href="#eval_xc_3-153"><span class="linenos">153</span></a>    <span class="c1"># gc.collect()  # Avoiding using it for now, as it is usually quite slow, although in this case it might not make much difference</span>
</span><span id="eval_xc_3-154"><a href="#eval_xc_3-154"><span class="linenos">154</span></a>    <span class="c1"># Anyway, the following also works</span>
</span><span id="eval_xc_3-155"><a href="#eval_xc_3-155"><span class="linenos">155</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3-156"><a href="#eval_xc_3-156"><span class="linenos">156</span></a>    <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3-157"><a href="#eval_xc_3-157"><span class="linenos">157</span></a>    <span class="n">coords</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3-158"><a href="#eval_xc_3-158"><span class="linenos">158</span></a>
</span><span id="eval_xc_3-159"><a href="#eval_xc_3-159"><span class="linenos">159</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">,</span> <span class="n">v</span>
</span></pre></div>


    

                </section>
                <section id="eval_xc_1_cupy">
                            <input id="eval_xc_1_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_1_cupy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">50000</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">use_libxc</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">nstreams</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">ngpus</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">freemem</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">threads_per_block</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	type=&lt;class &#x27;numpy.float64&#x27;&gt;</span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_1_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_1_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_1_cupy-22"><a href="#eval_xc_1_cupy-22"><span class="linenos"> 22</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_1_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
</span><span id="eval_xc_1_cupy-23"><a href="#eval_xc_1_cupy-23"><span class="linenos"> 23</span></a>                   <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nstreams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
</span><span id="eval_xc_1_cupy-24"><a href="#eval_xc_1_cupy-24"><span class="linenos"> 24</span></a>                    <span class="n">freemem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
</span><span id="eval_xc_1_cupy-25"><a href="#eval_xc_1_cupy-25"><span class="linenos"> 25</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating XC term using GPU and algo 1&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-26"><a href="#eval_xc_1_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># Evaluate the XC term using GPU</span>
</span><span id="eval_xc_1_cupy-27"><a href="#eval_xc_1_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># Here instead of parallelizing over batches, the operations within</span>
</span><span id="eval_xc_1_cupy-28"><a href="#eval_xc_1_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># a batch are parallelized. Therefore, this requires a larger batchsize~20480.</span>
</span><span id="eval_xc_1_cupy-29"><a href="#eval_xc_1_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># While the CPU version of this algorithm is quite slow, </span>
</span><span id="eval_xc_1_cupy-30"><a href="#eval_xc_1_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># the GPU version performs great!</span>
</span><span id="eval_xc_1_cupy-31"><a href="#eval_xc_1_cupy-31"><span class="linenos"> 31</span></a>
</span><span id="eval_xc_1_cupy-32"><a href="#eval_xc_1_cupy-32"><span class="linenos"> 32</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_1_cupy-33"><a href="#eval_xc_1_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_1_cupy-34"><a href="#eval_xc_1_cupy-34"><span class="linenos"> 34</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_1_cupy-35"><a href="#eval_xc_1_cupy-35"><span class="linenos"> 35</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_1_cupy-36"><a href="#eval_xc_1_cupy-36"><span class="linenos"> 36</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_1_cupy-37"><a href="#eval_xc_1_cupy-37"><span class="linenos"> 37</span></a>
</span><span id="eval_xc_1_cupy-38"><a href="#eval_xc_1_cupy-38"><span class="linenos"> 38</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_1_cupy-39"><a href="#eval_xc_1_cupy-39"><span class="linenos"> 39</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_1_cupy-40"><a href="#eval_xc_1_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_1_cupy-41"><a href="#eval_xc_1_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_1_cupy-42"><a href="#eval_xc_1_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_1_cupy-43"><a href="#eval_xc_1_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_1_cupy-44"><a href="#eval_xc_1_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_1_cupy-45"><a href="#eval_xc_1_cupy-45"><span class="linenos"> 45</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_1_cupy-46"><a href="#eval_xc_1_cupy-46"><span class="linenos"> 46</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_1_cupy-47"><a href="#eval_xc_1_cupy-47"><span class="linenos"> 47</span></a>
</span><span id="eval_xc_1_cupy-48"><a href="#eval_xc_1_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">startTotal</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-49"><a href="#eval_xc_1_cupy-49"><span class="linenos"> 49</span></a>
</span><span id="eval_xc_1_cupy-50"><a href="#eval_xc_1_cupy-50"><span class="linenos"> 50</span></a>    <span class="c1"># For debugging and benchmarking purposes</span>
</span><span id="eval_xc_1_cupy-51"><a href="#eval_xc_1_cupy-51"><span class="linenos"> 51</span></a>    <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-52"><a href="#eval_xc_1_cupy-52"><span class="linenos"> 52</span></a>    <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-53"><a href="#eval_xc_1_cupy-53"><span class="linenos"> 53</span></a>    <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-54"><a href="#eval_xc_1_cupy-54"><span class="linenos"> 54</span></a>    <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-55"><a href="#eval_xc_1_cupy-55"><span class="linenos"> 55</span></a>    <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-56"><a href="#eval_xc_1_cupy-56"><span class="linenos"> 56</span></a>    <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-57"><a href="#eval_xc_1_cupy-57"><span class="linenos"> 57</span></a>    <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-58"><a href="#eval_xc_1_cupy-58"><span class="linenos"> 58</span></a>    <span class="n">durationPrelims</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-59"><a href="#eval_xc_1_cupy-59"><span class="linenos"> 59</span></a>    <span class="n">durationTotal</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-60"><a href="#eval_xc_1_cupy-60"><span class="linenos"> 60</span></a>    <span class="n">n_gpu</span><span class="o">=</span> <span class="mi">1</span>
</span><span id="eval_xc_1_cupy-61"><a href="#eval_xc_1_cupy-61"><span class="linenos"> 61</span></a>    <span class="c1"># nstreams = 1</span>
</span><span id="eval_xc_1_cupy-62"><a href="#eval_xc_1_cupy-62"><span class="linenos"> 62</span></a>    <span class="c1"># Create streams for asynchronous execution</span>
</span><span id="eval_xc_1_cupy-63"><a href="#eval_xc_1_cupy-63"><span class="linenos"> 63</span></a>    <span class="c1"># streams = [cp.cuda.Stream(non_blocking=False) for i in range(nstreams)]</span>
</span><span id="eval_xc_1_cupy-64"><a href="#eval_xc_1_cupy-64"><span class="linenos"> 64</span></a>    <span class="c1"># nb_streams = [cuda.external_stream(streams[i].ptr) for i in range(nstreams)]</span>
</span><span id="eval_xc_1_cupy-65"><a href="#eval_xc_1_cupy-65"><span class="linenos"> 65</span></a>    <span class="c1"># nb_streams = [cuda.stream() for i in range(nstreams)]</span>
</span><span id="eval_xc_1_cupy-66"><a href="#eval_xc_1_cupy-66"><span class="linenos"> 66</span></a>    <span class="c1"># cp_streams = [cp.cuda.ExternalStream(nb_streams[i].ptr) for i in range(nstreams)]</span>
</span><span id="eval_xc_1_cupy-67"><a href="#eval_xc_1_cupy-67"><span class="linenos"> 67</span></a>    <span class="c1"># TODO: Try using this for multiGPU support: https://github.com/cupy/cupy/issues/5692</span>
</span><span id="eval_xc_1_cupy-68"><a href="#eval_xc_1_cupy-68"><span class="linenos"> 68</span></a>    <span class="c1"># streams = []</span>
</span><span id="eval_xc_1_cupy-69"><a href="#eval_xc_1_cupy-69"><span class="linenos"> 69</span></a>    <span class="c1"># for i in range(n_gpu):</span>
</span><span id="eval_xc_1_cupy-70"><a href="#eval_xc_1_cupy-70"><span class="linenos"> 70</span></a>    <span class="c1">#     cp.cuda.Device(i).use()</span>
</span><span id="eval_xc_1_cupy-71"><a href="#eval_xc_1_cupy-71"><span class="linenos"> 71</span></a>    <span class="c1">#     streams.append(cp.cuda.Stream(non_blocking = True))</span>
</span><span id="eval_xc_1_cupy-72"><a href="#eval_xc_1_cupy-72"><span class="linenos"> 72</span></a>
</span><span id="eval_xc_1_cupy-73"><a href="#eval_xc_1_cupy-73"><span class="linenos"> 73</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-74"><a href="#eval_xc_1_cupy-74"><span class="linenos"> 74</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not using LibXC for XC evaluations&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-75"><a href="#eval_xc_1_cupy-75"><span class="linenos"> 75</span></a>
</span><span id="eval_xc_1_cupy-76"><a href="#eval_xc_1_cupy-76"><span class="linenos"> 76</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-77"><a href="#eval_xc_1_cupy-77"><span class="linenos"> 77</span></a>        <span class="n">startPrelims</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-78"><a href="#eval_xc_1_cupy-78"><span class="linenos"> 78</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_1_cupy-79"><a href="#eval_xc_1_cupy-79"><span class="linenos"> 79</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_1_cupy-80"><a href="#eval_xc_1_cupy-80"><span class="linenos"> 80</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-81"><a href="#eval_xc_1_cupy-81"><span class="linenos"> 81</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_1_cupy-82"><a href="#eval_xc_1_cupy-82"><span class="linenos"> 82</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-83"><a href="#eval_xc_1_cupy-83"><span class="linenos"> 83</span></a>    <span class="c1">#print(v.dtype)</span>
</span><span id="eval_xc_1_cupy-84"><a href="#eval_xc_1_cupy-84"><span class="linenos"> 84</span></a>    <span class="c1">#TODO mGGA, Hybrid</span>
</span><span id="eval_xc_1_cupy-85"><a href="#eval_xc_1_cupy-85"><span class="linenos"> 85</span></a>    
</span><span id="eval_xc_1_cupy-86"><a href="#eval_xc_1_cupy-86"><span class="linenos"> 86</span></a>    <span class="c1">#Calculate number of blocks/batches</span>
</span><span id="eval_xc_1_cupy-87"><a href="#eval_xc_1_cupy-87"><span class="linenos"> 87</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-88"><a href="#eval_xc_1_cupy-88"><span class="linenos"> 88</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_1_cupy-89"><a href="#eval_xc_1_cupy-89"><span class="linenos"> 89</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_1_cupy-90"><a href="#eval_xc_1_cupy-90"><span class="linenos"> 90</span></a>
</span><span id="eval_xc_1_cupy-91"><a href="#eval_xc_1_cupy-91"><span class="linenos"> 91</span></a>    <span class="c1"># Convert the arrays needed for CUDA computations to cupy arrays</span>
</span><span id="eval_xc_1_cupy-92"><a href="#eval_xc_1_cupy-92"><span class="linenos"> 92</span></a>
</span><span id="eval_xc_1_cupy-93"><a href="#eval_xc_1_cupy-93"><span class="linenos"> 93</span></a>    <span class="c1"># If a list of significant basis functions for each block of grid points is provided</span>
</span><span id="eval_xc_1_cupy-94"><a href="#eval_xc_1_cupy-94"><span class="linenos"> 94</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-95"><a href="#eval_xc_1_cupy-95"><span class="linenos"> 95</span></a>        <span class="n">dmat_orig</span> <span class="o">=</span> <span class="n">dmat</span>
</span><span id="eval_xc_1_cupy-96"><a href="#eval_xc_1_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">dmat_orig_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat_orig</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-97"><a href="#eval_xc_1_cupy-97"><span class="linenos"> 97</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-98"><a href="#eval_xc_1_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-99"><a href="#eval_xc_1_cupy-99"><span class="linenos"> 99</span></a>
</span><span id="eval_xc_1_cupy-100"><a href="#eval_xc_1_cupy-100"><span class="linenos">100</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_1_cupy-101"><a href="#eval_xc_1_cupy-101"><span class="linenos">101</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_1_cupy-102"><a href="#eval_xc_1_cupy-102"><span class="linenos">102</span></a>    <span class="c1"># This will help to make the call to eval_bfs faster by skipping the mediator eval_bfs function </span>
</span><span id="eval_xc_1_cupy-103"><a href="#eval_xc_1_cupy-103"><span class="linenos">103</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_1_cupy-104"><a href="#eval_xc_1_cupy-104"><span class="linenos">104</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_1_cupy-105"><a href="#eval_xc_1_cupy-105"><span class="linenos">105</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-106"><a href="#eval_xc_1_cupy-106"><span class="linenos">106</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-107"><a href="#eval_xc_1_cupy-107"><span class="linenos">107</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_1_cupy-108"><a href="#eval_xc_1_cupy-108"><span class="linenos">108</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_1_cupy-109"><a href="#eval_xc_1_cupy-109"><span class="linenos">109</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_1_cupy-110"><a href="#eval_xc_1_cupy-110"><span class="linenos">110</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_1_cupy-111"><a href="#eval_xc_1_cupy-111"><span class="linenos">111</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_1_cupy-112"><a href="#eval_xc_1_cupy-112"><span class="linenos">112</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_1_cupy-113"><a href="#eval_xc_1_cupy-113"><span class="linenos">113</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_1_cupy-114"><a href="#eval_xc_1_cupy-114"><span class="linenos">114</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-115"><a href="#eval_xc_1_cupy-115"><span class="linenos">115</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-116"><a href="#eval_xc_1_cupy-116"><span class="linenos">116</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-117"><a href="#eval_xc_1_cupy-117"><span class="linenos">117</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-118"><a href="#eval_xc_1_cupy-118"><span class="linenos">118</span></a>    <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-119"><a href="#eval_xc_1_cupy-119"><span class="linenos">119</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_1_cupy-120"><a href="#eval_xc_1_cupy-120"><span class="linenos">120</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_1_cupy-121"><a href="#eval_xc_1_cupy-121"><span class="linenos">121</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-122"><a href="#eval_xc_1_cupy-122"><span class="linenos">122</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-123"><a href="#eval_xc_1_cupy-123"><span class="linenos">123</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-124"><a href="#eval_xc_1_cupy-124"><span class="linenos">124</span></a>            <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-125"><a href="#eval_xc_1_cupy-125"><span class="linenos">125</span></a>    <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_1_cupy-126"><a href="#eval_xc_1_cupy-126"><span class="linenos">126</span></a>    <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_1_cupy-127"><a href="#eval_xc_1_cupy-127"><span class="linenos">127</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">)):</span>
</span><span id="eval_xc_1_cupy-128"><a href="#eval_xc_1_cupy-128"><span class="linenos">128</span></a>        <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">])</span>
</span><span id="eval_xc_1_cupy-129"><a href="#eval_xc_1_cupy-129"><span class="linenos">129</span></a>
</span><span id="eval_xc_1_cupy-130"><a href="#eval_xc_1_cupy-130"><span class="linenos">130</span></a>    
</span><span id="eval_xc_1_cupy-131"><a href="#eval_xc_1_cupy-131"><span class="linenos">131</span></a>    <span class="n">weights_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-132"><a href="#eval_xc_1_cupy-132"><span class="linenos">132</span></a>    <span class="n">coords_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-133"><a href="#eval_xc_1_cupy-133"><span class="linenos">133</span></a>    
</span><span id="eval_xc_1_cupy-134"><a href="#eval_xc_1_cupy-134"><span class="linenos">134</span></a>
</span><span id="eval_xc_1_cupy-135"><a href="#eval_xc_1_cupy-135"><span class="linenos">135</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_1_cupy-136"><a href="#eval_xc_1_cupy-136"><span class="linenos">136</span></a>
</span><span id="eval_xc_1_cupy-137"><a href="#eval_xc_1_cupy-137"><span class="linenos">137</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_1_cupy-138"><a href="#eval_xc_1_cupy-138"><span class="linenos">138</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-139"><a href="#eval_xc_1_cupy-139"><span class="linenos">139</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-140"><a href="#eval_xc_1_cupy-140"><span class="linenos">140</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-141"><a href="#eval_xc_1_cupy-141"><span class="linenos">141</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-142"><a href="#eval_xc_1_cupy-142"><span class="linenos">142</span></a>
</span><span id="eval_xc_1_cupy-143"><a href="#eval_xc_1_cupy-143"><span class="linenos">143</span></a>
</span><span id="eval_xc_1_cupy-144"><a href="#eval_xc_1_cupy-144"><span class="linenos">144</span></a>    <span class="n">my_expr</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_1_cupy-145"><a href="#eval_xc_1_cupy-145"><span class="linenos">145</span></a>    <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-146"><a href="#eval_xc_1_cupy-146"><span class="linenos">146</span></a>        <span class="n">my_expr_grad1</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,kmi,mj-&gt;km&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_1_cupy-147"><a href="#eval_xc_1_cupy-147"><span class="linenos">147</span></a>        <span class="n">my_expr_grad2</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,mi,kmj-&gt;km&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_1_cupy-148"><a href="#eval_xc_1_cupy-148"><span class="linenos">148</span></a>
</span><span id="eval_xc_1_cupy-149"><a href="#eval_xc_1_cupy-149"><span class="linenos">149</span></a>    <span class="k">if</span> <span class="n">threads_per_block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-150"><a href="#eval_xc_1_cupy-150"><span class="linenos">150</span></a>        <span class="c1"># Determine the optimal number of blocks per grid</span>
</span><span id="eval_xc_1_cupy-151"><a href="#eval_xc_1_cupy-151"><span class="linenos">151</span></a>        <span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span>
</span><span id="eval_xc_1_cupy-152"><a href="#eval_xc_1_cupy-152"><span class="linenos">152</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">16</span>
</span><span id="eval_xc_1_cupy-153"><a href="#eval_xc_1_cupy-153"><span class="linenos">153</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">64</span>
</span><span id="eval_xc_1_cupy-154"><a href="#eval_xc_1_cupy-154"><span class="linenos">154</span></a>        <span class="n">threads_per_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-155"><a href="#eval_xc_1_cupy-155"><span class="linenos">155</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-156"><a href="#eval_xc_1_cupy-156"><span class="linenos">156</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="n">threads_per_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-157"><a href="#eval_xc_1_cupy-157"><span class="linenos">157</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="n">threads_per_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-158"><a href="#eval_xc_1_cupy-158"><span class="linenos">158</span></a>
</span><span id="eval_xc_1_cupy-159"><a href="#eval_xc_1_cupy-159"><span class="linenos">159</span></a>
</span><span id="eval_xc_1_cupy-160"><a href="#eval_xc_1_cupy-160"><span class="linenos">160</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-161"><a href="#eval_xc_1_cupy-161"><span class="linenos">161</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-162"><a href="#eval_xc_1_cupy-162"><span class="linenos">162</span></a>        <span class="n">durationPrelims</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startPrelims</span>
</span><span id="eval_xc_1_cupy-163"><a href="#eval_xc_1_cupy-163"><span class="linenos">163</span></a>
</span><span id="eval_xc_1_cupy-164"><a href="#eval_xc_1_cupy-164"><span class="linenos">164</span></a>    <span class="c1"># A large scratch for evaluating batch local ao values</span>
</span><span id="eval_xc_1_cupy-165"><a href="#eval_xc_1_cupy-165"><span class="linenos">165</span></a>    <span class="n">ao_value_block_</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">blocksize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-166"><a href="#eval_xc_1_cupy-166"><span class="linenos">166</span></a>    <span class="c1"># If either x or c functional is of GGA/MGGA type we need ao_grad_values</span>
</span><span id="eval_xc_1_cupy-167"><a href="#eval_xc_1_cupy-167"><span class="linenos">167</span></a>    <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-168"><a href="#eval_xc_1_cupy-168"><span class="linenos">168</span></a>        <span class="n">ao_value_grad_block_</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-169"><a href="#eval_xc_1_cupy-169"><span class="linenos">169</span></a>
</span><span id="eval_xc_1_cupy-170"><a href="#eval_xc_1_cupy-170"><span class="linenos">170</span></a>    <span class="c1"># Just a precautionary synchronize here so that all the cupy arrays created above should finish getting initialized.</span>
</span><span id="eval_xc_1_cupy-171"><a href="#eval_xc_1_cupy-171"><span class="linenos">171</span></a>    <span class="c1"># cp.cuda.Stream.null.synchronize()</span>
</span><span id="eval_xc_1_cupy-172"><a href="#eval_xc_1_cupy-172"><span class="linenos">172</span></a>    <span class="c1"># cuda.synchronize()</span>
</span><span id="eval_xc_1_cupy-173"><a href="#eval_xc_1_cupy-173"><span class="linenos">173</span></a>    <span class="c1"># with cupyx.profiler.profile():</span>
</span><span id="eval_xc_1_cupy-174"><a href="#eval_xc_1_cupy-174"><span class="linenos">174</span></a>    <span class="c1"># with streams[0]:</span>
</span><span id="eval_xc_1_cupy-175"><a href="#eval_xc_1_cupy-175"><span class="linenos">175</span></a>    <span class="c1"># Loop over blocks/batches of grid points</span>
</span><span id="eval_xc_1_cupy-176"><a href="#eval_xc_1_cupy-176"><span class="linenos">176</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="eval_xc_1_cupy-177"><a href="#eval_xc_1_cupy-177"><span class="linenos">177</span></a>        <span class="c1"># stream_id = iblock % nstreams</span>
</span><span id="eval_xc_1_cupy-178"><a href="#eval_xc_1_cupy-178"><span class="linenos">178</span></a>        <span class="c1"># with streams[stream_id]:</span>
</span><span id="eval_xc_1_cupy-179"><a href="#eval_xc_1_cupy-179"><span class="linenos">179</span></a>        <span class="c1"># with nb_streams[stream_id]:</span>
</span><span id="eval_xc_1_cupy-180"><a href="#eval_xc_1_cupy-180"><span class="linenos">180</span></a>            <span class="c1"># cp.cuda.Device(stream_id).use()</span>
</span><span id="eval_xc_1_cupy-181"><a href="#eval_xc_1_cupy-181"><span class="linenos">181</span></a>            <span class="c1"># cp.cuda.Stream(cp_streams[stream_id]).use()</span>
</span><span id="eval_xc_1_cupy-182"><a href="#eval_xc_1_cupy-182"><span class="linenos">182</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="eval_xc_1_cupy-183"><a href="#eval_xc_1_cupy-183"><span class="linenos">183</span></a>
</span><span id="eval_xc_1_cupy-184"><a href="#eval_xc_1_cupy-184"><span class="linenos">184</span></a>        <span class="c1"># Get weights and coordinates of grid points for this block/batch</span>
</span><span id="eval_xc_1_cupy-185"><a href="#eval_xc_1_cupy-185"><span class="linenos">185</span></a>        <span class="n">weights_block</span> <span class="o">=</span> <span class="n">weights_cp</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>
</span><span id="eval_xc_1_cupy-186"><a href="#eval_xc_1_cupy-186"><span class="linenos">186</span></a>        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">coords_cp</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span> 
</span><span id="eval_xc_1_cupy-187"><a href="#eval_xc_1_cupy-187"><span class="linenos">187</span></a>        <span class="c1">#coords_block_cp = cp.asarray(coords[offset : min(offset+blocksize,ngrids)])</span>
</span><span id="eval_xc_1_cupy-188"><a href="#eval_xc_1_cupy-188"><span class="linenos">188</span></a>
</span><span id="eval_xc_1_cupy-189"><a href="#eval_xc_1_cupy-189"><span class="linenos">189</span></a>        <span class="c1"># Get the list of basis functions with significant contributions to this block</span>
</span><span id="eval_xc_1_cupy-190"><a href="#eval_xc_1_cupy-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-191"><a href="#eval_xc_1_cupy-191"><span class="linenos">191</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]]</span>
</span><span id="eval_xc_1_cupy-192"><a href="#eval_xc_1_cupy-192"><span class="linenos">192</span></a>            <span class="c1"># Get the subset of density matrix corresponding to the siginificant basis functions</span>
</span><span id="eval_xc_1_cupy-193"><a href="#eval_xc_1_cupy-193"><span class="linenos">193</span></a>            <span class="n">dmat</span> <span class="o">=</span> <span class="n">dmat_orig_cp</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span>
</span><span id="eval_xc_1_cupy-194"><a href="#eval_xc_1_cupy-194"><span class="linenos">194</span></a>
</span><span id="eval_xc_1_cupy-195"><a href="#eval_xc_1_cupy-195"><span class="linenos">195</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-196"><a href="#eval_xc_1_cupy-196"><span class="linenos">196</span></a>            <span class="n">startAO</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-197"><a href="#eval_xc_1_cupy-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-198"><a href="#eval_xc_1_cupy-198"><span class="linenos">198</span></a>            <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If ao_values are calculated once and saved, then they can be provided to avoid recalculation</span>
</span><span id="eval_xc_1_cupy-199"><a href="#eval_xc_1_cupy-199"><span class="linenos">199</span></a>                <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-200"><a href="#eval_xc_1_cupy-200"><span class="linenos">200</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-201"><a href="#eval_xc_1_cupy-201"><span class="linenos">201</span></a>                <span class="c1"># ao_value_block = Integrals.eval_bfs(basis, coords_block)       </span>
</span><span id="eval_xc_1_cupy-202"><a href="#eval_xc_1_cupy-202"><span class="linenos">202</span></a>                <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-203"><a href="#eval_xc_1_cupy-203"><span class="linenos">203</span></a>                    <span class="c1"># ao_value_block = Integrals.bf_val_helpers.eval_bfs_sparse_vectorized_internal_cupy(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, coords_block, non_zero_indices, scratches)</span>
</span><span id="eval_xc_1_cupy-204"><a href="#eval_xc_1_cupy-204"><span class="linenos">204</span></a>                    <span class="c1"># Get a subset of the scratch for evaluating batch local ao values</span>
</span><span id="eval_xc_1_cupy-205"><a href="#eval_xc_1_cupy-205"><span class="linenos">205</span></a>                    <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_value_block_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">coords_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">:</span><span class="n">non_zero_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> 
</span><span id="eval_xc_1_cupy-206"><a href="#eval_xc_1_cupy-206"><span class="linenos">206</span></a>                    <span class="c1"># cp.cuda.Stream.null.synchronize() # Precautionary synchronize here</span>
</span><span id="eval_xc_1_cupy-207"><a href="#eval_xc_1_cupy-207"><span class="linenos">207</span></a>                    <span class="c1"># blocks_per_grid = ((non_zero_indices.shape[0]//thread_x) + 1, (coords_block.shape[0]//thread_y) + 1) # &quot;lazy&quot; round-up</span>
</span><span id="eval_xc_1_cupy-208"><a href="#eval_xc_1_cupy-208"><span class="linenos">208</span></a>                    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">non_zero_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">coords_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="eval_xc_1_cupy-209"><a href="#eval_xc_1_cupy-209"><span class="linenos">209</span></a>                    <span class="c1"># nb_stream = stream_cupy_to_numba(streams[stream_id])</span>
</span><span id="eval_xc_1_cupy-210"><a href="#eval_xc_1_cupy-210"><span class="linenos">210</span></a>                    <span class="c1"># get the pointer to actual CUDA stream</span>
</span><span id="eval_xc_1_cupy-211"><a href="#eval_xc_1_cupy-211"><span class="linenos">211</span></a>                    <span class="c1"># raw_str = streams[stream_id].ptr</span>
</span><span id="eval_xc_1_cupy-212"><a href="#eval_xc_1_cupy-212"><span class="linenos">212</span></a>                    <span class="c1"># nb_stream = numba.cuda.external_stream(raw_str)</span>
</span><span id="eval_xc_1_cupy-213"><a href="#eval_xc_1_cupy-213"><span class="linenos">213</span></a>                    <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_sparse_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-214"><a href="#eval_xc_1_cupy-214"><span class="linenos">214</span></a>                    
</span><span id="eval_xc_1_cupy-215"><a href="#eval_xc_1_cupy-215"><span class="linenos">215</span></a>                    <span class="c1"># cuda.synchronize() # This is needed when using this in a cupy stream</span>
</span><span id="eval_xc_1_cupy-216"><a href="#eval_xc_1_cupy-216"><span class="linenos">216</span></a>                    <span class="c1"># cp.cuda.Stream.null.synchronize() </span>
</span><span id="eval_xc_1_cupy-217"><a href="#eval_xc_1_cupy-217"><span class="linenos">217</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-218"><a href="#eval_xc_1_cupy-218"><span class="linenos">218</span></a>                    <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-219"><a href="#eval_xc_1_cupy-219"><span class="linenos">219</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need ao_grad_values</span>
</span><span id="eval_xc_1_cupy-220"><a href="#eval_xc_1_cupy-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-221"><a href="#eval_xc_1_cupy-221"><span class="linenos">221</span></a>            <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If ao_values are calculated once and saved, then they can be provided to avoid recalculation</span>
</span><span id="eval_xc_1_cupy-222"><a href="#eval_xc_1_cupy-222"><span class="linenos">222</span></a>                <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">list_ao_grad_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-223"><a href="#eval_xc_1_cupy-223"><span class="linenos">223</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-224"><a href="#eval_xc_1_cupy-224"><span class="linenos">224</span></a>                <span class="c1"># ao_value_block, ao_values_grad_block = Integrals.bf_val_helpers.eval_bfs_and_grad(basis, coords_block, deriv=1, parallel=True, non_zero_indices=non_zero_indices)</span>
</span><span id="eval_xc_1_cupy-225"><a href="#eval_xc_1_cupy-225"><span class="linenos">225</span></a>                <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-226"><a href="#eval_xc_1_cupy-226"><span class="linenos">226</span></a>                    <span class="c1"># Calculating ao values and gradients together, didn&#39;t really do much improvement in computational speed</span>
</span><span id="eval_xc_1_cupy-227"><a href="#eval_xc_1_cupy-227"><span class="linenos">227</span></a>                    <span class="c1"># ao_value_block, ao_values_grad_block = Integrals.bf_val_helpers.eval_bfs_and_grad_sparse_internal(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, coords_block, non_zero_indices)</span>
</span><span id="eval_xc_1_cupy-228"><a href="#eval_xc_1_cupy-228"><span class="linenos">228</span></a>                    <span class="c1"># Get a subset of the scratch for evaluating batch local ao values</span>
</span><span id="eval_xc_1_cupy-229"><a href="#eval_xc_1_cupy-229"><span class="linenos">229</span></a>                    <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_value_block_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">coords_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">:</span><span class="n">non_zero_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> 
</span><span id="eval_xc_1_cupy-230"><a href="#eval_xc_1_cupy-230"><span class="linenos">230</span></a>                    <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_value_grad_block_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">coords_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">:</span><span class="n">non_zero_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> 
</span><span id="eval_xc_1_cupy-231"><a href="#eval_xc_1_cupy-231"><span class="linenos">231</span></a>                    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">non_zero_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">coords_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="eval_xc_1_cupy-232"><a href="#eval_xc_1_cupy-232"><span class="linenos">232</span></a>                    <span class="c1"># nb_stream = stream_cupy_to_numba(streams[stream_id])</span>
</span><span id="eval_xc_1_cupy-233"><a href="#eval_xc_1_cupy-233"><span class="linenos">233</span></a>                    <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad_sparse_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="eval_xc_1_cupy-234"><a href="#eval_xc_1_cupy-234"><span class="linenos">234</span></a>                                                                                                            <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> 
</span><span id="eval_xc_1_cupy-235"><a href="#eval_xc_1_cupy-235"><span class="linenos">235</span></a>                                                                                                            <span class="n">coords_block</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> 
</span><span id="eval_xc_1_cupy-236"><a href="#eval_xc_1_cupy-236"><span class="linenos">236</span></a>                                                                                                            <span class="n">ao_values_grad_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-237"><a href="#eval_xc_1_cupy-237"><span class="linenos">237</span></a>                    
</span><span id="eval_xc_1_cupy-238"><a href="#eval_xc_1_cupy-238"><span class="linenos">238</span></a>                    <span class="c1"># streams[stream_id].synchronize()</span>
</span><span id="eval_xc_1_cupy-239"><a href="#eval_xc_1_cupy-239"><span class="linenos">239</span></a>                    <span class="c1"># nb_streams[stream_id].synchronize()</span>
</span><span id="eval_xc_1_cupy-240"><a href="#eval_xc_1_cupy-240"><span class="linenos">240</span></a>                    <span class="c1"># cp.cuda.Stream.null.synchronize() </span>
</span><span id="eval_xc_1_cupy-241"><a href="#eval_xc_1_cupy-241"><span class="linenos">241</span></a>                    <span class="c1"># streams[stream_id].synchronize()</span>
</span><span id="eval_xc_1_cupy-242"><a href="#eval_xc_1_cupy-242"><span class="linenos">242</span></a>                    
</span><span id="eval_xc_1_cupy-243"><a href="#eval_xc_1_cupy-243"><span class="linenos">243</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-244"><a href="#eval_xc_1_cupy-244"><span class="linenos">244</span></a>                    <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-245"><a href="#eval_xc_1_cupy-245"><span class="linenos">245</span></a>        
</span><span id="eval_xc_1_cupy-246"><a href="#eval_xc_1_cupy-246"><span class="linenos">246</span></a>
</span><span id="eval_xc_1_cupy-247"><a href="#eval_xc_1_cupy-247"><span class="linenos">247</span></a>        <span class="c1"># Convert to cupy array</span>
</span><span id="eval_xc_1_cupy-248"><a href="#eval_xc_1_cupy-248"><span class="linenos">248</span></a>        <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_value_block</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-249"><a href="#eval_xc_1_cupy-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-250"><a href="#eval_xc_1_cupy-250"><span class="linenos">250</span></a>            <span class="n">ao_values_grad_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_grad_block</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-251"><a href="#eval_xc_1_cupy-251"><span class="linenos">251</span></a>
</span><span id="eval_xc_1_cupy-252"><a href="#eval_xc_1_cupy-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-253"><a href="#eval_xc_1_cupy-253"><span class="linenos">253</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-254"><a href="#eval_xc_1_cupy-254"><span class="linenos">254</span></a>            <span class="n">durationAO</span> <span class="o">=</span> <span class="n">durationAO</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startAO</span>
</span><span id="eval_xc_1_cupy-255"><a href="#eval_xc_1_cupy-255"><span class="linenos">255</span></a>
</span><span id="eval_xc_1_cupy-256"><a href="#eval_xc_1_cupy-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-257"><a href="#eval_xc_1_cupy-257"><span class="linenos">257</span></a>            <span class="n">startRho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-258"><a href="#eval_xc_1_cupy-258"><span class="linenos">258</span></a>            <span class="c1"># print(&#39;calculating rho...&#39;)</span>
</span><span id="eval_xc_1_cupy-259"><a href="#eval_xc_1_cupy-259"><span class="linenos">259</span></a>        <span class="c1"># rho_block = contract(&#39;ij,mi,mj-&gt;m&#39;, dmat, ao_value_block, ao_value_block, backend=&#39;cupy&#39;) # Original (pretty fast)</span>
</span><span id="eval_xc_1_cupy-260"><a href="#eval_xc_1_cupy-260"><span class="linenos">260</span></a>        <span class="n">rho_block</span> <span class="o">=</span> <span class="n">my_expr</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;cupy&#39;</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-261"><a href="#eval_xc_1_cupy-261"><span class="linenos">261</span></a>        <span class="c1"># X = ao_value_block @ dmat.T </span>
</span><span id="eval_xc_1_cupy-262"><a href="#eval_xc_1_cupy-262"><span class="linenos">262</span></a>        <span class="c1"># rho_block = cp.sum(ao_value_block*X,axis=1)</span>
</span><span id="eval_xc_1_cupy-263"><a href="#eval_xc_1_cupy-263"><span class="linenos">263</span></a>        <span class="c1"># rho_block = contract(&#39;mi,im-&gt;m&#39;, ao_value_block, X)</span>
</span><span id="eval_xc_1_cupy-264"><a href="#eval_xc_1_cupy-264"><span class="linenos">264</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values too</span>
</span><span id="eval_xc_1_cupy-265"><a href="#eval_xc_1_cupy-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-266"><a href="#eval_xc_1_cupy-266"><span class="linenos">266</span></a>            <span class="c1"># rho_grad_block_x, rho_grad_block_y, rho_grad_block_z  = ( contract(&#39;ij,kmi,mj-&gt;km&#39;,dmat,ao_values_grad_block,ao_value_block, backend=&#39;cupy&#39;, optimize=&#39;optimal&#39;)+\</span>
</span><span id="eval_xc_1_cupy-267"><a href="#eval_xc_1_cupy-267"><span class="linenos">267</span></a>            <span class="c1">#                 contract(&#39;ij,mi,kmj-&gt;km&#39;,dmat,ao_value_block,ao_values_grad_block, backend=&#39;cupy&#39;, optimize=&#39;optimal&#39;) )[:]</span>
</span><span id="eval_xc_1_cupy-268"><a href="#eval_xc_1_cupy-268"><span class="linenos">268</span></a>            <span class="n">rho_grad_block_x</span><span class="p">,</span> <span class="n">rho_grad_block_y</span><span class="p">,</span> <span class="n">rho_grad_block_z</span>  <span class="o">=</span> <span class="n">my_expr_grad1</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span><span class="n">ao_values_grad_block</span><span class="p">,</span><span class="n">ao_value_block</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;cupy&#39;</span><span class="p">)</span> \
</span><span id="eval_xc_1_cupy-269"><a href="#eval_xc_1_cupy-269"><span class="linenos">269</span></a>                                                                    <span class="o">+</span> <span class="n">my_expr_grad2</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_values_grad_block</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;cupy&#39;</span><span class="p">)</span> 
</span><span id="eval_xc_1_cupy-270"><a href="#eval_xc_1_cupy-270"><span class="linenos">270</span></a>            <span class="n">sigma_block</span> <span class="o">=</span> <span class="n">calc_sigma</span><span class="p">(</span><span class="n">rho_grad_block_x</span><span class="p">,</span> <span class="n">rho_grad_block_y</span><span class="p">,</span> <span class="n">rho_grad_block_z</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-271"><a href="#eval_xc_1_cupy-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-272"><a href="#eval_xc_1_cupy-272"><span class="linenos">272</span></a>                <span class="n">sigma_block</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sigma_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-273"><a href="#eval_xc_1_cupy-273"><span class="linenos">273</span></a>
</span><span id="eval_xc_1_cupy-274"><a href="#eval_xc_1_cupy-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-275"><a href="#eval_xc_1_cupy-275"><span class="linenos">275</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-276"><a href="#eval_xc_1_cupy-276"><span class="linenos">276</span></a>            <span class="n">durationRho</span> <span class="o">=</span> <span class="n">durationRho</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startRho</span>
</span><span id="eval_xc_1_cupy-277"><a href="#eval_xc_1_cupy-277"><span class="linenos">277</span></a>            <span class="c1">#print(&#39;Duration for Rho at grid points: &#39;,durationRho)</span>
</span><span id="eval_xc_1_cupy-278"><a href="#eval_xc_1_cupy-278"><span class="linenos">278</span></a>            <span class="c1"># print(&#39;done calculating rho&#39;)</span>
</span><span id="eval_xc_1_cupy-279"><a href="#eval_xc_1_cupy-279"><span class="linenos">279</span></a>    
</span><span id="eval_xc_1_cupy-280"><a href="#eval_xc_1_cupy-280"><span class="linenos">280</span></a>        <span class="c1">#LibXC stuff</span>
</span><span id="eval_xc_1_cupy-281"><a href="#eval_xc_1_cupy-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-282"><a href="#eval_xc_1_cupy-282"><span class="linenos">282</span></a>            <span class="c1"># Exchange</span>
</span><span id="eval_xc_1_cupy-283"><a href="#eval_xc_1_cupy-283"><span class="linenos">283</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-284"><a href="#eval_xc_1_cupy-284"><span class="linenos">284</span></a>                <span class="n">startLibxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-285"><a href="#eval_xc_1_cupy-285"><span class="linenos">285</span></a>            <span class="c1"># Input dictionary for libxc</span>
</span><span id="eval_xc_1_cupy-286"><a href="#eval_xc_1_cupy-286"><span class="linenos">286</span></a>            <span class="n">inp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="eval_xc_1_cupy-287"><a href="#eval_xc_1_cupy-287"><span class="linenos">287</span></a>            <span class="c1"># Input dictionary needs density values at grid points</span>
</span><span id="eval_xc_1_cupy-288"><a href="#eval_xc_1_cupy-288"><span class="linenos">288</span></a>            <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">rho_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-289"><a href="#eval_xc_1_cupy-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-290"><a href="#eval_xc_1_cupy-290"><span class="linenos">290</span></a>                <span class="c1"># Input dictionary needs sigma (\nabla \rho \cdot \nabla \rho) values at grid points</span>
</span><span id="eval_xc_1_cupy-291"><a href="#eval_xc_1_cupy-291"><span class="linenos">291</span></a>                <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_block</span>
</span><span id="eval_xc_1_cupy-292"><a href="#eval_xc_1_cupy-292"><span class="linenos">292</span></a>            <span class="c1"># Calculate the necessary quantities using LibXC</span>
</span><span id="eval_xc_1_cupy-293"><a href="#eval_xc_1_cupy-293"><span class="linenos">293</span></a>            <span class="n">retx</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-294"><a href="#eval_xc_1_cupy-294"><span class="linenos">294</span></a>            <span class="c1"># durationLibxc = durationLibxc + timer() - startLibxc</span>
</span><span id="eval_xc_1_cupy-295"><a href="#eval_xc_1_cupy-295"><span class="linenos">295</span></a>            <span class="c1"># print(&#39;Duration for LibXC computations at grid points: &#39;,durationLibxc)</span>
</span><span id="eval_xc_1_cupy-296"><a href="#eval_xc_1_cupy-296"><span class="linenos">296</span></a>
</span><span id="eval_xc_1_cupy-297"><a href="#eval_xc_1_cupy-297"><span class="linenos">297</span></a>            <span class="c1"># Correlation</span>
</span><span id="eval_xc_1_cupy-298"><a href="#eval_xc_1_cupy-298"><span class="linenos">298</span></a>            <span class="c1"># startLibxc = timer()</span>
</span><span id="eval_xc_1_cupy-299"><a href="#eval_xc_1_cupy-299"><span class="linenos">299</span></a>            <span class="c1"># Input dictionary for libxc</span>
</span><span id="eval_xc_1_cupy-300"><a href="#eval_xc_1_cupy-300"><span class="linenos">300</span></a>            <span class="c1">#inp = {}</span>
</span><span id="eval_xc_1_cupy-301"><a href="#eval_xc_1_cupy-301"><span class="linenos">301</span></a>            <span class="c1"># Input dictionary needs density values at grid points</span>
</span><span id="eval_xc_1_cupy-302"><a href="#eval_xc_1_cupy-302"><span class="linenos">302</span></a>            <span class="c1">#inp[&#39;rho&#39;] = rho_block</span>
</span><span id="eval_xc_1_cupy-303"><a href="#eval_xc_1_cupy-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-304"><a href="#eval_xc_1_cupy-304"><span class="linenos">304</span></a>                <span class="c1"># Input dictionary needs sigma (\nabla \rho \cdot \nabla \rho) values at grid points</span>
</span><span id="eval_xc_1_cupy-305"><a href="#eval_xc_1_cupy-305"><span class="linenos">305</span></a>                <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_block</span>
</span><span id="eval_xc_1_cupy-306"><a href="#eval_xc_1_cupy-306"><span class="linenos">306</span></a>            <span class="c1"># Calculate the necessary quantities using LibXC</span>
</span><span id="eval_xc_1_cupy-307"><a href="#eval_xc_1_cupy-307"><span class="linenos">307</span></a>            <span class="n">retc</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-308"><a href="#eval_xc_1_cupy-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-309"><a href="#eval_xc_1_cupy-309"><span class="linenos">309</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-310"><a href="#eval_xc_1_cupy-310"><span class="linenos">310</span></a>                <span class="n">durationLibxc</span> <span class="o">=</span> <span class="n">durationLibxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startLibxc</span>
</span><span id="eval_xc_1_cupy-311"><a href="#eval_xc_1_cupy-311"><span class="linenos">311</span></a>            <span class="c1"># print(&#39;Duration for LibXC computations at grid points: &#39;,durationLibxc)</span>
</span><span id="eval_xc_1_cupy-312"><a href="#eval_xc_1_cupy-312"><span class="linenos">312</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-313"><a href="#eval_xc_1_cupy-313"><span class="linenos">313</span></a>            <span class="c1"># Exchange</span>
</span><span id="eval_xc_1_cupy-314"><a href="#eval_xc_1_cupy-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-315"><a href="#eval_xc_1_cupy-315"><span class="linenos">315</span></a>                <span class="n">startLibxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-316"><a href="#eval_xc_1_cupy-316"><span class="linenos">316</span></a>            <span class="c1"># Calculate the necessary quantities using own implementation</span>
</span><span id="eval_xc_1_cupy-317"><a href="#eval_xc_1_cupy-317"><span class="linenos">317</span></a>            <span class="c1"># retx = lda_x(rho_block)</span>
</span><span id="eval_xc_1_cupy-318"><a href="#eval_xc_1_cupy-318"><span class="linenos">318</span></a>            <span class="c1"># retx = gga_x_b88(rho_block, sigma_block)</span>
</span><span id="eval_xc_1_cupy-319"><a href="#eval_xc_1_cupy-319"><span class="linenos">319</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-320"><a href="#eval_xc_1_cupy-320"><span class="linenos">320</span></a>                <span class="n">retx</span> <span class="o">=</span> <span class="n">XC</span><span class="o">.</span><span class="n">func_compute</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rho_block</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-321"><a href="#eval_xc_1_cupy-321"><span class="linenos">321</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-322"><a href="#eval_xc_1_cupy-322"><span class="linenos">322</span></a>                <span class="n">retx</span> <span class="o">=</span> <span class="n">XC</span><span class="o">.</span><span class="n">func_compute</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rho_block</span><span class="p">,</span> <span class="n">sigma_block</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-323"><a href="#eval_xc_1_cupy-323"><span class="linenos">323</span></a>
</span><span id="eval_xc_1_cupy-324"><a href="#eval_xc_1_cupy-324"><span class="linenos">324</span></a>            <span class="c1"># Correlation</span>
</span><span id="eval_xc_1_cupy-325"><a href="#eval_xc_1_cupy-325"><span class="linenos">325</span></a>            <span class="c1"># Calculate the necessary quantities using own implementation</span>
</span><span id="eval_xc_1_cupy-326"><a href="#eval_xc_1_cupy-326"><span class="linenos">326</span></a>            <span class="c1"># retc = lda_c_vwn(rho_block)</span>
</span><span id="eval_xc_1_cupy-327"><a href="#eval_xc_1_cupy-327"><span class="linenos">327</span></a>            <span class="c1"># retc = gga_c_lyp(rho_block, sigma_block)</span>
</span><span id="eval_xc_1_cupy-328"><a href="#eval_xc_1_cupy-328"><span class="linenos">328</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-329"><a href="#eval_xc_1_cupy-329"><span class="linenos">329</span></a>                <span class="n">retc</span> <span class="o">=</span> <span class="n">XC</span><span class="o">.</span><span class="n">func_compute</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rho_block</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-330"><a href="#eval_xc_1_cupy-330"><span class="linenos">330</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-331"><a href="#eval_xc_1_cupy-331"><span class="linenos">331</span></a>                <span class="n">retc</span> <span class="o">=</span> <span class="n">XC</span><span class="o">.</span><span class="n">func_compute</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rho_block</span><span class="p">,</span> <span class="n">sigma_block</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-332"><a href="#eval_xc_1_cupy-332"><span class="linenos">332</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-333"><a href="#eval_xc_1_cupy-333"><span class="linenos">333</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-334"><a href="#eval_xc_1_cupy-334"><span class="linenos">334</span></a>                <span class="n">durationLibxc</span> <span class="o">=</span> <span class="n">durationLibxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startLibxc</span>
</span><span id="eval_xc_1_cupy-335"><a href="#eval_xc_1_cupy-335"><span class="linenos">335</span></a>            <span class="c1"># print(&#39;Duration for LibXC computations at grid points: &#39;,durationLibxc)</span>
</span><span id="eval_xc_1_cupy-336"><a href="#eval_xc_1_cupy-336"><span class="linenos">336</span></a>
</span><span id="eval_xc_1_cupy-337"><a href="#eval_xc_1_cupy-337"><span class="linenos">337</span></a>
</span><span id="eval_xc_1_cupy-338"><a href="#eval_xc_1_cupy-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-339"><a href="#eval_xc_1_cupy-339"><span class="linenos">339</span></a>            <span class="n">startE</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-340"><a href="#eval_xc_1_cupy-340"><span class="linenos">340</span></a>        <span class="c1">#ENERGY-----------</span>
</span><span id="eval_xc_1_cupy-341"><a href="#eval_xc_1_cupy-341"><span class="linenos">341</span></a>        <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-342"><a href="#eval_xc_1_cupy-342"><span class="linenos">342</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;zk&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;zk&#39;</span><span class="p">]</span> <span class="c1"># Functional values at grid points</span>
</span><span id="eval_xc_1_cupy-343"><a href="#eval_xc_1_cupy-343"><span class="linenos">343</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-344"><a href="#eval_xc_1_cupy-344"><span class="linenos">344</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-345"><a href="#eval_xc_1_cupy-345"><span class="linenos">345</span></a>        <span class="c1"># Testing CrysX&#39;s own implmentation</span>
</span><span id="eval_xc_1_cupy-346"><a href="#eval_xc_1_cupy-346"><span class="linenos">346</span></a>        <span class="c1">#e = densfuncs.lda_x(rho)</span>
</span><span id="eval_xc_1_cupy-347"><a href="#eval_xc_1_cupy-347"><span class="linenos">347</span></a>
</span><span id="eval_xc_1_cupy-348"><a href="#eval_xc_1_cupy-348"><span class="linenos">348</span></a>        <span class="c1"># Calculate the total energy </span>
</span><span id="eval_xc_1_cupy-349"><a href="#eval_xc_1_cupy-349"><span class="linenos">349</span></a>        <span class="c1"># Multiply the density at grid points by weights</span>
</span><span id="eval_xc_1_cupy-350"><a href="#eval_xc_1_cupy-350"><span class="linenos">350</span></a>        <span class="n">den</span> <span class="o">=</span> <span class="n">rho_block</span><span class="o">*</span><span class="n">weights_block</span>
</span><span id="eval_xc_1_cupy-351"><a href="#eval_xc_1_cupy-351"><span class="linenos">351</span></a>        <span class="c1"># den = cp.multiply(rho_block, weights_block)</span>
</span><span id="eval_xc_1_cupy-352"><a href="#eval_xc_1_cupy-352"><span class="linenos">352</span></a>        <span class="c1"># den = elementwise_multiply(rho_block, weights_block)</span>
</span><span id="eval_xc_1_cupy-353"><a href="#eval_xc_1_cupy-353"><span class="linenos">353</span></a>        <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-354"><a href="#eval_xc_1_cupy-354"><span class="linenos">354</span></a>            <span class="n">efunc</span> <span class="o">=</span> <span class="n">efunc</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="c1">#Multiply with functional values at grid points and sum</span>
</span><span id="eval_xc_1_cupy-355"><a href="#eval_xc_1_cupy-355"><span class="linenos">355</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-356"><a href="#eval_xc_1_cupy-356"><span class="linenos">356</span></a>            <span class="n">efunc</span> <span class="o">=</span> <span class="n">efunc</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="c1">#Multiply with functional values at grid points and sum</span>
</span><span id="eval_xc_1_cupy-357"><a href="#eval_xc_1_cupy-357"><span class="linenos">357</span></a>            <span class="c1"># efunc = efunc + cp.sum(elementwise_multiply(den, e)) #Multiply with functional values at grid points and sum</span>
</span><span id="eval_xc_1_cupy-358"><a href="#eval_xc_1_cupy-358"><span class="linenos">358</span></a>        <span class="n">nelec</span> <span class="o">+=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">den</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-359"><a href="#eval_xc_1_cupy-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-360"><a href="#eval_xc_1_cupy-360"><span class="linenos">360</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-361"><a href="#eval_xc_1_cupy-361"><span class="linenos">361</span></a>            <span class="n">durationE</span> <span class="o">=</span> <span class="n">durationE</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startE</span>
</span><span id="eval_xc_1_cupy-362"><a href="#eval_xc_1_cupy-362"><span class="linenos">362</span></a>        <span class="c1"># print(&#39;Duration for calculation of total density functional energy: &#39;,durationE)</span>
</span><span id="eval_xc_1_cupy-363"><a href="#eval_xc_1_cupy-363"><span class="linenos">363</span></a>
</span><span id="eval_xc_1_cupy-364"><a href="#eval_xc_1_cupy-364"><span class="linenos">364</span></a>        <span class="c1">#POTENTIAL----------</span>
</span><span id="eval_xc_1_cupy-365"><a href="#eval_xc_1_cupy-365"><span class="linenos">365</span></a>        <span class="c1"># The derivative of functional wrt density is vrho</span>
</span><span id="eval_xc_1_cupy-366"><a href="#eval_xc_1_cupy-366"><span class="linenos">366</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-367"><a href="#eval_xc_1_cupy-367"><span class="linenos">367</span></a>            <span class="n">startF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-368"><a href="#eval_xc_1_cupy-368"><span class="linenos">368</span></a>        <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-369"><a href="#eval_xc_1_cupy-369"><span class="linenos">369</span></a>            <span class="n">vrho</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;vrho&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;vrho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-370"><a href="#eval_xc_1_cupy-370"><span class="linenos">370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-371"><a href="#eval_xc_1_cupy-371"><span class="linenos">371</span></a>            <span class="n">vrho</span> <span class="o">=</span> <span class="n">retx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">retc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-372"><a href="#eval_xc_1_cupy-372"><span class="linenos">372</span></a>        
</span><span id="eval_xc_1_cupy-373"><a href="#eval_xc_1_cupy-373"><span class="linenos">373</span></a>        <span class="n">vsigma</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1_cupy-374"><a href="#eval_xc_1_cupy-374"><span class="linenos">374</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1_cupy-375"><a href="#eval_xc_1_cupy-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-376"><a href="#eval_xc_1_cupy-376"><span class="linenos">376</span></a>            <span class="c1"># The derivative of functional wrt grad \rho square.</span>
</span><span id="eval_xc_1_cupy-377"><a href="#eval_xc_1_cupy-377"><span class="linenos">377</span></a>            <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-378"><a href="#eval_xc_1_cupy-378"><span class="linenos">378</span></a>                <span class="n">vsigma</span> <span class="o">+=</span> <span class="n">retx</span><span class="p">[</span><span class="s1">&#39;vsigma&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-379"><a href="#eval_xc_1_cupy-379"><span class="linenos">379</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-380"><a href="#eval_xc_1_cupy-380"><span class="linenos">380</span></a>                <span class="n">vsigma</span> <span class="o">+=</span> <span class="n">retx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-381"><a href="#eval_xc_1_cupy-381"><span class="linenos">381</span></a>            
</span><span id="eval_xc_1_cupy-382"><a href="#eval_xc_1_cupy-382"><span class="linenos">382</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-383"><a href="#eval_xc_1_cupy-383"><span class="linenos">383</span></a>            <span class="c1"># The derivative of functional wrt grad \rho square.</span>
</span><span id="eval_xc_1_cupy-384"><a href="#eval_xc_1_cupy-384"><span class="linenos">384</span></a>            <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-385"><a href="#eval_xc_1_cupy-385"><span class="linenos">385</span></a>                <span class="n">vsigma</span> <span class="o">+=</span> <span class="n">retc</span><span class="p">[</span><span class="s1">&#39;vsigma&#39;</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-386"><a href="#eval_xc_1_cupy-386"><span class="linenos">386</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-387"><a href="#eval_xc_1_cupy-387"><span class="linenos">387</span></a>                <span class="n">vsigma</span> <span class="o">+=</span> <span class="n">retc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-388"><a href="#eval_xc_1_cupy-388"><span class="linenos">388</span></a>        
</span><span id="eval_xc_1_cupy-389"><a href="#eval_xc_1_cupy-389"><span class="linenos">389</span></a>        <span class="c1"># F = np.multiply(weights_block,vrho[:,0]) #This is fast enough.</span>
</span><span id="eval_xc_1_cupy-390"><a href="#eval_xc_1_cupy-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-391"><a href="#eval_xc_1_cupy-391"><span class="linenos">391</span></a>            <span class="n">v_rho_temp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vrho</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="eval_xc_1_cupy-392"><a href="#eval_xc_1_cupy-392"><span class="linenos">392</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-393"><a href="#eval_xc_1_cupy-393"><span class="linenos">393</span></a>            <span class="n">v_rho_temp</span> <span class="o">=</span> <span class="n">vrho</span>
</span><span id="eval_xc_1_cupy-394"><a href="#eval_xc_1_cupy-394"><span class="linenos">394</span></a>        <span class="c1"># F = weights_block*v_rho_temp</span>
</span><span id="eval_xc_1_cupy-395"><a href="#eval_xc_1_cupy-395"><span class="linenos">395</span></a>        <span class="c1"># F = calc_F(weights_block, v_rho_temp)</span>
</span><span id="eval_xc_1_cupy-396"><a href="#eval_xc_1_cupy-396"><span class="linenos">396</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1_cupy-397"><a href="#eval_xc_1_cupy-397"><span class="linenos">397</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-398"><a href="#eval_xc_1_cupy-398"><span class="linenos">398</span></a>            <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-399"><a href="#eval_xc_1_cupy-399"><span class="linenos">399</span></a>                <span class="n">Ftemp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">weights_block</span><span class="o">*</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vsigma</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="eval_xc_1_cupy-400"><a href="#eval_xc_1_cupy-400"><span class="linenos">400</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-401"><a href="#eval_xc_1_cupy-401"><span class="linenos">401</span></a>                <span class="n">Ftemp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">weights_block</span><span class="o">*</span><span class="n">vsigma</span>
</span><span id="eval_xc_1_cupy-402"><a href="#eval_xc_1_cupy-402"><span class="linenos">402</span></a>                <span class="c1"># Ftemp = 2*cp.multiply(weights_block, vsigma)</span>
</span><span id="eval_xc_1_cupy-403"><a href="#eval_xc_1_cupy-403"><span class="linenos">403</span></a>                <span class="c1"># Ftemp = 2*elementwise_multiply(weights_block, vsigma)</span>
</span><span id="eval_xc_1_cupy-404"><a href="#eval_xc_1_cupy-404"><span class="linenos">404</span></a>            <span class="n">Fx</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_x</span>
</span><span id="eval_xc_1_cupy-405"><a href="#eval_xc_1_cupy-405"><span class="linenos">405</span></a>            <span class="n">Fy</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_y</span>
</span><span id="eval_xc_1_cupy-406"><a href="#eval_xc_1_cupy-406"><span class="linenos">406</span></a>            <span class="n">Fz</span> <span class="o">=</span> <span class="n">Ftemp</span><span class="o">*</span><span class="n">rho_grad_block_z</span>
</span><span id="eval_xc_1_cupy-407"><a href="#eval_xc_1_cupy-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-408"><a href="#eval_xc_1_cupy-408"><span class="linenos">408</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-409"><a href="#eval_xc_1_cupy-409"><span class="linenos">409</span></a>            <span class="n">durationF</span> <span class="o">=</span> <span class="n">durationF</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startF</span>
</span><span id="eval_xc_1_cupy-410"><a href="#eval_xc_1_cupy-410"><span class="linenos">410</span></a>        <span class="c1"># print(&#39;Duration for calculation of F: &#39;,durationF)</span>
</span><span id="eval_xc_1_cupy-411"><a href="#eval_xc_1_cupy-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-412"><a href="#eval_xc_1_cupy-412"><span class="linenos">412</span></a>            <span class="n">startZ</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-413"><a href="#eval_xc_1_cupy-413"><span class="linenos">413</span></a>        <span class="c1"># z = 0.5*F*ao_value_block.T</span>
</span><span id="eval_xc_1_cupy-414"><a href="#eval_xc_1_cupy-414"><span class="linenos">414</span></a>        <span class="c1"># z = calc_z(F, ao_value_block.T)</span>
</span><span id="eval_xc_1_cupy-415"><a href="#eval_xc_1_cupy-415"><span class="linenos">415</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">calc_z</span><span class="p">(</span><span class="n">weights_block</span><span class="p">,</span> <span class="n">v_rho_temp</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-416"><a href="#eval_xc_1_cupy-416"><span class="linenos">416</span></a>        <span class="c1"># z = 0.5*np.einsum(&#39;m,mi-&gt;mi&#39;,F,ao_value_block)</span>
</span><span id="eval_xc_1_cupy-417"><a href="#eval_xc_1_cupy-417"><span class="linenos">417</span></a>        <span class="c1"># If either x or c functional is of GGA/MGGA type we need rho_grad_values</span>
</span><span id="eval_xc_1_cupy-418"><a href="#eval_xc_1_cupy-418"><span class="linenos">418</span></a>        <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-419"><a href="#eval_xc_1_cupy-419"><span class="linenos">419</span></a>            <span class="n">z</span> <span class="o">+=</span> <span class="n">calc_z_gga</span><span class="p">(</span><span class="n">Fx</span><span class="p">,</span> <span class="n">Fy</span><span class="p">,</span> <span class="n">Fz</span><span class="p">,</span> <span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ao_values_grad_block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-420"><a href="#eval_xc_1_cupy-420"><span class="linenos">420</span></a>            <span class="c1"># z += Fx*ao_values_grad_block[0].T + Fy*ao_values_grad_block[1].T + Fz*ao_values_grad_block[2].T</span>
</span><span id="eval_xc_1_cupy-421"><a href="#eval_xc_1_cupy-421"><span class="linenos">421</span></a>        
</span><span id="eval_xc_1_cupy-422"><a href="#eval_xc_1_cupy-422"><span class="linenos">422</span></a>            
</span><span id="eval_xc_1_cupy-423"><a href="#eval_xc_1_cupy-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-424"><a href="#eval_xc_1_cupy-424"><span class="linenos">424</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-425"><a href="#eval_xc_1_cupy-425"><span class="linenos">425</span></a>            <span class="n">durationZ</span> <span class="o">=</span> <span class="n">durationZ</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startZ</span>
</span><span id="eval_xc_1_cupy-426"><a href="#eval_xc_1_cupy-426"><span class="linenos">426</span></a>        <span class="c1"># print(&#39;Duration for calculation of z : &#39;,durationZ)</span>
</span><span id="eval_xc_1_cupy-427"><a href="#eval_xc_1_cupy-427"><span class="linenos">427</span></a>        <span class="c1"># Free memory</span>
</span><span id="eval_xc_1_cupy-428"><a href="#eval_xc_1_cupy-428"><span class="linenos">428</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1_cupy-429"><a href="#eval_xc_1_cupy-429"><span class="linenos">429</span></a>        <span class="n">ao_value_block_T</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1_cupy-430"><a href="#eval_xc_1_cupy-430"><span class="linenos">430</span></a>        <span class="n">vrho</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_1_cupy-431"><a href="#eval_xc_1_cupy-431"><span class="linenos">431</span></a>
</span><span id="eval_xc_1_cupy-432"><a href="#eval_xc_1_cupy-432"><span class="linenos">432</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-433"><a href="#eval_xc_1_cupy-433"><span class="linenos">433</span></a>            <span class="n">startV</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-434"><a href="#eval_xc_1_cupy-434"><span class="linenos">434</span></a>        
</span><span id="eval_xc_1_cupy-435"><a href="#eval_xc_1_cupy-435"><span class="linenos">435</span></a>        <span class="c1">#v_temp = z @ ao_value_block</span>
</span><span id="eval_xc_1_cupy-436"><a href="#eval_xc_1_cupy-436"><span class="linenos">436</span></a>        <span class="c1">#v_temp = cp.dot(z, ao_value_block)</span>
</span><span id="eval_xc_1_cupy-437"><a href="#eval_xc_1_cupy-437"><span class="linenos">437</span></a>        <span class="n">v_temp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-438"><a href="#eval_xc_1_cupy-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-439"><a href="#eval_xc_1_cupy-439"><span class="linenos">439</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">v_temp</span> <span class="o">+</span> <span class="n">v_temp</span><span class="o">.</span><span class="n">T</span>
</span><span id="eval_xc_1_cupy-440"><a href="#eval_xc_1_cupy-440"><span class="linenos">440</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-441"><a href="#eval_xc_1_cupy-441"><span class="linenos">441</span></a>            <span class="n">v</span> <span class="o">+=</span> <span class="n">v_temp</span> <span class="o">+</span> <span class="n">v_temp</span><span class="o">.</span><span class="n">T</span>
</span><span id="eval_xc_1_cupy-442"><a href="#eval_xc_1_cupy-442"><span class="linenos">442</span></a>
</span><span id="eval_xc_1_cupy-443"><a href="#eval_xc_1_cupy-443"><span class="linenos">443</span></a>            
</span><span id="eval_xc_1_cupy-444"><a href="#eval_xc_1_cupy-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-445"><a href="#eval_xc_1_cupy-445"><span class="linenos">445</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-446"><a href="#eval_xc_1_cupy-446"><span class="linenos">446</span></a>            <span class="n">durationV</span> <span class="o">=</span> <span class="n">durationV</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startV</span>
</span><span id="eval_xc_1_cupy-447"><a href="#eval_xc_1_cupy-447"><span class="linenos">447</span></a>
</span><span id="eval_xc_1_cupy-448"><a href="#eval_xc_1_cupy-448"><span class="linenos">448</span></a>    <span class="c1"># for stream in streams:</span>
</span><span id="eval_xc_1_cupy-449"><a href="#eval_xc_1_cupy-449"><span class="linenos">449</span></a>    <span class="c1">#     stream.synchronize()</span>
</span><span id="eval_xc_1_cupy-450"><a href="#eval_xc_1_cupy-450"><span class="linenos">450</span></a>
</span><span id="eval_xc_1_cupy-451"><a href="#eval_xc_1_cupy-451"><span class="linenos">451</span></a>
</span><span id="eval_xc_1_cupy-452"><a href="#eval_xc_1_cupy-452"><span class="linenos">452</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-453"><a href="#eval_xc_1_cupy-453"><span class="linenos">453</span></a>    <span class="c1">#print(v_temp.dtype)</span>
</span><span id="eval_xc_1_cupy-454"><a href="#eval_xc_1_cupy-454"><span class="linenos">454</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-455"><a href="#eval_xc_1_cupy-455"><span class="linenos">455</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for Prelims: &#39;</span><span class="p">,</span> <span class="n">durationPrelims</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-456"><a href="#eval_xc_1_cupy-456"><span class="linenos">456</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for AO values: &#39;</span><span class="p">,</span> <span class="n">durationAO</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-457"><a href="#eval_xc_1_cupy-457"><span class="linenos">457</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for V: &#39;</span><span class="p">,</span><span class="n">durationV</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-458"><a href="#eval_xc_1_cupy-458"><span class="linenos">458</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for Rho at grid points: &#39;</span><span class="p">,</span><span class="n">durationRho</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-459"><a href="#eval_xc_1_cupy-459"><span class="linenos">459</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for F: &#39;</span><span class="p">,</span><span class="n">durationF</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-460"><a href="#eval_xc_1_cupy-460"><span class="linenos">460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for Z: &#39;</span><span class="p">,</span><span class="n">durationZ</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-461"><a href="#eval_xc_1_cupy-461"><span class="linenos">461</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for E: &#39;</span><span class="p">,</span><span class="n">durationE</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-462"><a href="#eval_xc_1_cupy-462"><span class="linenos">462</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for LibXC: &#39;</span><span class="p">,</span><span class="n">durationLibxc</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-463"><a href="#eval_xc_1_cupy-463"><span class="linenos">463</span></a>        
</span><span id="eval_xc_1_cupy-464"><a href="#eval_xc_1_cupy-464"><span class="linenos">464</span></a>
</span><span id="eval_xc_1_cupy-465"><a href="#eval_xc_1_cupy-465"><span class="linenos">465</span></a>        
</span><span id="eval_xc_1_cupy-466"><a href="#eval_xc_1_cupy-466"><span class="linenos">466</span></a>
</span><span id="eval_xc_1_cupy-467"><a href="#eval_xc_1_cupy-467"><span class="linenos">467</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-468"><a href="#eval_xc_1_cupy-468"><span class="linenos">468</span></a>        <span class="n">startV_tonumpy</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-469"><a href="#eval_xc_1_cupy-469"><span class="linenos">469</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-470"><a href="#eval_xc_1_cupy-470"><span class="linenos">470</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-471"><a href="#eval_xc_1_cupy-471"><span class="linenos">471</span></a>        <span class="n">durationV_tonumpy</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startV_tonumpy</span>
</span><span id="eval_xc_1_cupy-472"><a href="#eval_xc_1_cupy-472"><span class="linenos">472</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Duration for V to numpy&#39;</span><span class="p">,</span> <span class="n">durationV_tonumpy</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-473"><a href="#eval_xc_1_cupy-473"><span class="linenos">473</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time: &#39;</span><span class="p">,</span> <span class="n">durationPrelims</span><span class="o">+</span><span class="n">durationAO</span><span class="o">+</span><span class="n">durationRho</span><span class="o">+</span><span class="n">durationLibxc</span><span class="o">+</span><span class="n">durationE</span><span class="o">+</span><span class="n">durationF</span><span class="o">+</span><span class="n">durationV</span><span class="o">+</span><span class="n">durationZ</span><span class="o">+</span><span class="n">durationV_tonumpy</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-474"><a href="#eval_xc_1_cupy-474"><span class="linenos">474</span></a>
</span><span id="eval_xc_1_cupy-475"><a href="#eval_xc_1_cupy-475"><span class="linenos">475</span></a>
</span><span id="eval_xc_1_cupy-476"><a href="#eval_xc_1_cupy-476"><span class="linenos">476</span></a>    <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-477"><a href="#eval_xc_1_cupy-477"><span class="linenos">477</span></a>        <span class="n">efunc</span> <span class="o">=</span> <span class="n">efunc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_1_cupy-478"><a href="#eval_xc_1_cupy-478"><span class="linenos">478</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-479"><a href="#eval_xc_1_cupy-479"><span class="linenos">479</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-480"><a href="#eval_xc_1_cupy-480"><span class="linenos">480</span></a>        <span class="n">durationTotal</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTotal</span>
</span><span id="eval_xc_1_cupy-481"><a href="#eval_xc_1_cupy-481"><span class="linenos">481</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time2: &#39;</span><span class="p">,</span> <span class="n">durationTotal</span><span class="p">)</span>
</span><span id="eval_xc_1_cupy-482"><a href="#eval_xc_1_cupy-482"><span class="linenos">482</span></a>
</span><span id="eval_xc_1_cupy-483"><a href="#eval_xc_1_cupy-483"><span class="linenos">483</span></a>    <span class="k">if</span> <span class="n">freemem</span> <span class="ow">or</span> <span class="n">nstreams</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
</span><span id="eval_xc_1_cupy-484"><a href="#eval_xc_1_cupy-484"><span class="linenos">484</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">_default_memory_pool</span><span class="o">.</span><span class="n">free_all_blocks</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-485"><a href="#eval_xc_1_cupy-485"><span class="linenos">485</span></a>
</span><span id="eval_xc_1_cupy-486"><a href="#eval_xc_1_cupy-486"><span class="linenos">486</span></a>
</span><span id="eval_xc_1_cupy-487"><a href="#eval_xc_1_cupy-487"><span class="linenos">487</span></a>    <span class="c1"># Final synchronize before return</span>
</span><span id="eval_xc_1_cupy-488"><a href="#eval_xc_1_cupy-488"><span class="linenos">488</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_1_cupy-489"><a href="#eval_xc_1_cupy-489"><span class="linenos">489</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">,</span> <span class="n">v</span>
</span></pre></div>


    

                </section>
                <section id="eval_xc_2_cupy">
                            <input id="eval_xc_2_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_2_cupy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">ncores</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_2_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_2_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_2_cupy-18"><a href="#eval_xc_2_cupy-18"><span class="linenos"> 18</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_2_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="eval_xc_2_cupy-19"><a href="#eval_xc_2_cupy-19"><span class="linenos"> 19</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating XC term using GPU and algo 2&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-20"><a href="#eval_xc_2_cupy-20"><span class="linenos"> 20</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Algo 2 uses a hybrid CPU+GPU approach for XC evaluation.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-21"><a href="#eval_xc_2_cupy-21"><span class="linenos"> 21</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CPU threads specified by ncores are used to evaluate functional values (via LibXC) and AO/AO grad values.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-22"><a href="#eval_xc_2_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># This performs parallelization at the blocks/batches level.</span>
</span><span id="eval_xc_2_cupy-23"><a href="#eval_xc_2_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># Therefore, joblib is perfect for such embarrasingly parallel task</span>
</span><span id="eval_xc_2_cupy-24"><a href="#eval_xc_2_cupy-24"><span class="linenos"> 24</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_2_cupy-25"><a href="#eval_xc_2_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_2_cupy-26"><a href="#eval_xc_2_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_2_cupy-27"><a href="#eval_xc_2_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_2_cupy-28"><a href="#eval_xc_2_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_2_cupy-29"><a href="#eval_xc_2_cupy-29"><span class="linenos"> 29</span></a>
</span><span id="eval_xc_2_cupy-30"><a href="#eval_xc_2_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_2_cupy-31"><a href="#eval_xc_2_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_2_cupy-32"><a href="#eval_xc_2_cupy-32"><span class="linenos"> 32</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_2_cupy-33"><a href="#eval_xc_2_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_2_cupy-34"><a href="#eval_xc_2_cupy-34"><span class="linenos"> 34</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_2_cupy-35"><a href="#eval_xc_2_cupy-35"><span class="linenos"> 35</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_2_cupy-36"><a href="#eval_xc_2_cupy-36"><span class="linenos"> 36</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_2_cupy-37"><a href="#eval_xc_2_cupy-37"><span class="linenos"> 37</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_2_cupy-38"><a href="#eval_xc_2_cupy-38"><span class="linenos"> 38</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_2_cupy-39"><a href="#eval_xc_2_cupy-39"><span class="linenos"> 39</span></a>
</span><span id="eval_xc_2_cupy-40"><a href="#eval_xc_2_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_2_cupy-41"><a href="#eval_xc_2_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_2_cupy-42"><a href="#eval_xc_2_cupy-42"><span class="linenos"> 42</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-43"><a href="#eval_xc_2_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_2_cupy-44"><a href="#eval_xc_2_cupy-44"><span class="linenos"> 44</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">))</span>
</span><span id="eval_xc_2_cupy-45"><a href="#eval_xc_2_cupy-45"><span class="linenos"> 45</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2_cupy-46"><a href="#eval_xc_2_cupy-46"><span class="linenos"> 46</span></a>
</span><span id="eval_xc_2_cupy-47"><a href="#eval_xc_2_cupy-47"><span class="linenos"> 47</span></a>    <span class="c1"># TODO it only works for LDA functionals for now.</span>
</span><span id="eval_xc_2_cupy-48"><a href="#eval_xc_2_cupy-48"><span class="linenos"> 48</span></a>    <span class="c1"># Need to make it work for GGA, Hybrid, range-separated Hybrid and MetaGGA functionals as well.</span>
</span><span id="eval_xc_2_cupy-49"><a href="#eval_xc_2_cupy-49"><span class="linenos"> 49</span></a>    
</span><span id="eval_xc_2_cupy-50"><a href="#eval_xc_2_cupy-50"><span class="linenos"> 50</span></a>
</span><span id="eval_xc_2_cupy-51"><a href="#eval_xc_2_cupy-51"><span class="linenos"> 51</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-52"><a href="#eval_xc_2_cupy-52"><span class="linenos"> 52</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_2_cupy-53"><a href="#eval_xc_2_cupy-53"><span class="linenos"> 53</span></a>
</span><span id="eval_xc_2_cupy-54"><a href="#eval_xc_2_cupy-54"><span class="linenos"> 54</span></a>    <span class="c1"># print(&#39;Number of blocks: &#39;, nblocks)</span>
</span><span id="eval_xc_2_cupy-55"><a href="#eval_xc_2_cupy-55"><span class="linenos"> 55</span></a>
</span><span id="eval_xc_2_cupy-56"><a href="#eval_xc_2_cupy-56"><span class="linenos"> 56</span></a>    <span class="c1"># Some stuff to note timings</span>
</span><span id="eval_xc_2_cupy-57"><a href="#eval_xc_2_cupy-57"><span class="linenos"> 57</span></a>    <span class="n">timings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_2_cupy-58"><a href="#eval_xc_2_cupy-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-59"><a href="#eval_xc_2_cupy-59"><span class="linenos"> 59</span></a>        <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-60"><a href="#eval_xc_2_cupy-60"><span class="linenos"> 60</span></a>        <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-61"><a href="#eval_xc_2_cupy-61"><span class="linenos"> 61</span></a>        <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-62"><a href="#eval_xc_2_cupy-62"><span class="linenos"> 62</span></a>        <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-63"><a href="#eval_xc_2_cupy-63"><span class="linenos"> 63</span></a>        <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-64"><a href="#eval_xc_2_cupy-64"><span class="linenos"> 64</span></a>        <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-65"><a href="#eval_xc_2_cupy-65"><span class="linenos"> 65</span></a>        <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_2_cupy-66"><a href="#eval_xc_2_cupy-66"><span class="linenos"> 66</span></a>        <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">:</span><span class="n">durationLibxc</span><span class="p">,</span> <span class="s1">&#39;durationE&#39;</span><span class="p">:</span><span class="n">durationE</span><span class="p">,</span> <span class="s1">&#39;durationF&#39;</span><span class="p">:</span><span class="n">durationF</span><span class="p">,</span> <span class="s1">&#39;durationZ&#39;</span><span class="p">:</span><span class="n">durationZ</span><span class="p">,</span> <span class="s1">&#39;durationV&#39;</span><span class="p">:</span><span class="n">durationV</span><span class="p">,</span> <span class="s1">&#39;durationRho&#39;</span><span class="p">:</span><span class="n">durationRho</span><span class="p">,</span> <span class="s1">&#39;durationAO&#39;</span><span class="p">:</span><span class="n">durationAO</span><span class="p">}</span>
</span><span id="eval_xc_2_cupy-67"><a href="#eval_xc_2_cupy-67"><span class="linenos"> 67</span></a>
</span><span id="eval_xc_2_cupy-68"><a href="#eval_xc_2_cupy-68"><span class="linenos"> 68</span></a>    
</span><span id="eval_xc_2_cupy-69"><a href="#eval_xc_2_cupy-69"><span class="linenos"> 69</span></a>
</span><span id="eval_xc_2_cupy-70"><a href="#eval_xc_2_cupy-70"><span class="linenos"> 70</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_2_cupy-71"><a href="#eval_xc_2_cupy-71"><span class="linenos"> 71</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_2_cupy-72"><a href="#eval_xc_2_cupy-72"><span class="linenos"> 72</span></a>    <span class="c1"># This will help to make the call to evalbfnumba1 faster by skipping the mediator evalbfnumbawrap function </span>
</span><span id="eval_xc_2_cupy-73"><a href="#eval_xc_2_cupy-73"><span class="linenos"> 73</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_2_cupy-74"><a href="#eval_xc_2_cupy-74"><span class="linenos"> 74</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_2_cupy-75"><a href="#eval_xc_2_cupy-75"><span class="linenos"> 75</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-76"><a href="#eval_xc_2_cupy-76"><span class="linenos"> 76</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-77"><a href="#eval_xc_2_cupy-77"><span class="linenos"> 77</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-78"><a href="#eval_xc_2_cupy-78"><span class="linenos"> 78</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-79"><a href="#eval_xc_2_cupy-79"><span class="linenos"> 79</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_2_cupy-80"><a href="#eval_xc_2_cupy-80"><span class="linenos"> 80</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_2_cupy-81"><a href="#eval_xc_2_cupy-81"><span class="linenos"> 81</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_2_cupy-82"><a href="#eval_xc_2_cupy-82"><span class="linenos"> 82</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_2_cupy-83"><a href="#eval_xc_2_cupy-83"><span class="linenos"> 83</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_2_cupy-84"><a href="#eval_xc_2_cupy-84"><span class="linenos"> 84</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-85"><a href="#eval_xc_2_cupy-85"><span class="linenos"> 85</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-86"><a href="#eval_xc_2_cupy-86"><span class="linenos"> 86</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-87"><a href="#eval_xc_2_cupy-87"><span class="linenos"> 87</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-88"><a href="#eval_xc_2_cupy-88"><span class="linenos"> 88</span></a>    <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">])</span>
</span><span id="eval_xc_2_cupy-89"><a href="#eval_xc_2_cupy-89"><span class="linenos"> 89</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_2_cupy-90"><a href="#eval_xc_2_cupy-90"><span class="linenos"> 90</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_2_cupy-91"><a href="#eval_xc_2_cupy-91"><span class="linenos"> 91</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-92"><a href="#eval_xc_2_cupy-92"><span class="linenos"> 92</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-93"><a href="#eval_xc_2_cupy-93"><span class="linenos"> 93</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-94"><a href="#eval_xc_2_cupy-94"><span class="linenos"> 94</span></a>            <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-95"><a href="#eval_xc_2_cupy-95"><span class="linenos"> 95</span></a>    <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_2_cupy-96"><a href="#eval_xc_2_cupy-96"><span class="linenos"> 96</span></a>    <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_2_cupy-97"><a href="#eval_xc_2_cupy-97"><span class="linenos"> 97</span></a>    <span class="n">bfs_data_as_np_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">bfs_radius_cutoff</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-98"><a href="#eval_xc_2_cupy-98"><span class="linenos"> 98</span></a>
</span><span id="eval_xc_2_cupy-99"><a href="#eval_xc_2_cupy-99"><span class="linenos"> 99</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_2_cupy-100"><a href="#eval_xc_2_cupy-100"><span class="linenos">100</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_2_cupy-101"><a href="#eval_xc_2_cupy-101"><span class="linenos">101</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-102"><a href="#eval_xc_2_cupy-102"><span class="linenos">102</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-103"><a href="#eval_xc_2_cupy-103"><span class="linenos">103</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_2_cupy-104"><a href="#eval_xc_2_cupy-104"><span class="linenos">104</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_2_cupy-105"><a href="#eval_xc_2_cupy-105"><span class="linenos">105</span></a>
</span><span id="eval_xc_2_cupy-106"><a href="#eval_xc_2_cupy-106"><span class="linenos">106</span></a>    <span class="n">weights_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-107"><a href="#eval_xc_2_cupy-107"><span class="linenos">107</span></a>    <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-108"><a href="#eval_xc_2_cupy-108"><span class="linenos">108</span></a>    <span class="c1"># Create streams for asynchronous execution</span>
</span><span id="eval_xc_2_cupy-109"><a href="#eval_xc_2_cupy-109"><span class="linenos">109</span></a>    <span class="n">streams</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncores</span><span class="p">)]</span>
</span><span id="eval_xc_2_cupy-110"><a href="#eval_xc_2_cupy-110"><span class="linenos">110</span></a>
</span><span id="eval_xc_2_cupy-111"><a href="#eval_xc_2_cupy-111"><span class="linenos">111</span></a>    <span class="c1">#### Set number of cores for numba related evaluations within &#39;block_dens_func()&#39; for example bf_value evaluations </span>
</span><span id="eval_xc_2_cupy-112"><a href="#eval_xc_2_cupy-112"><span class="linenos">112</span></a>    <span class="c1">#### Apparently, it was still using as many cores as possible and creating a serial version of thise functions as I have </span>
</span><span id="eval_xc_2_cupy-113"><a href="#eval_xc_2_cupy-113"><span class="linenos">113</span></a>    <span class="c1">#### currently done doesn&#39;t work  </span>
</span><span id="eval_xc_2_cupy-114"><a href="#eval_xc_2_cupy-114"><span class="linenos">114</span></a>    <span class="c1"># numba.set_num_threads(1)</span>
</span><span id="eval_xc_2_cupy-115"><a href="#eval_xc_2_cupy-115"><span class="linenos">115</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-116"><a href="#eval_xc_2_cupy-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-117"><a href="#eval_xc_2_cupy-117"><span class="linenos">117</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-118"><a href="#eval_xc_2_cupy-118"><span class="linenos">118</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">nblocks</span><span class="o">//</span><span class="n">ncores</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat_cp</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">streams</span><span class="p">)])</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_2_cupy-119"><a href="#eval_xc_2_cupy-119"><span class="linenos">119</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#GGA</span>
</span><span id="eval_xc_2_cupy-120"><a href="#eval_xc_2_cupy-120"><span class="linenos">120</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat_cp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">list_ao_grad_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_2_cupy-121"><a href="#eval_xc_2_cupy-121"><span class="linenos">121</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-122"><a href="#eval_xc_2_cupy-122"><span class="linenos">122</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat_cp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_2_cupy-123"><a href="#eval_xc_2_cupy-123"><span class="linenos">123</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-124"><a href="#eval_xc_2_cupy-124"><span class="linenos">124</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_2_cupy-125"><a href="#eval_xc_2_cupy-125"><span class="linenos">125</span></a>        
</span><span id="eval_xc_2_cupy-126"><a href="#eval_xc_2_cupy-126"><span class="linenos">126</span></a>    <span class="c1"># print(len(output))</span>
</span><span id="eval_xc_2_cupy-127"><a href="#eval_xc_2_cupy-127"><span class="linenos">127</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)):</span>
</span><span id="eval_xc_2_cupy-128"><a href="#eval_xc_2_cupy-128"><span class="linenos">128</span></a>        <span class="n">efunc</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-129"><a href="#eval_xc_2_cupy-129"><span class="linenos">129</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-130"><a href="#eval_xc_2_cupy-130"><span class="linenos">130</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]]</span>
</span><span id="eval_xc_2_cupy-131"><a href="#eval_xc_2_cupy-131"><span class="linenos">131</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-132"><a href="#eval_xc_2_cupy-132"><span class="linenos">132</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-133"><a href="#eval_xc_2_cupy-133"><span class="linenos">133</span></a>            <span class="n">v</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-134"><a href="#eval_xc_2_cupy-134"><span class="linenos">134</span></a>        <span class="n">nelec</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-135"><a href="#eval_xc_2_cupy-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-136"><a href="#eval_xc_2_cupy-136"><span class="linenos">136</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-137"><a href="#eval_xc_2_cupy-137"><span class="linenos">137</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-138"><a href="#eval_xc_2_cupy-138"><span class="linenos">138</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-139"><a href="#eval_xc_2_cupy-139"><span class="linenos">139</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-140"><a href="#eval_xc_2_cupy-140"><span class="linenos">140</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-141"><a href="#eval_xc_2_cupy-141"><span class="linenos">141</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-142"><a href="#eval_xc_2_cupy-142"><span class="linenos">142</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span>
</span><span id="eval_xc_2_cupy-143"><a href="#eval_xc_2_cupy-143"><span class="linenos">143</span></a>        <span class="c1"># v = numexpr.evaluate(&#39;(v + output[iblock][1])&#39;)</span>
</span><span id="eval_xc_2_cupy-144"><a href="#eval_xc_2_cupy-144"><span class="linenos">144</span></a>
</span><span id="eval_xc_2_cupy-145"><a href="#eval_xc_2_cupy-145"><span class="linenos">145</span></a>
</span><span id="eval_xc_2_cupy-146"><a href="#eval_xc_2_cupy-146"><span class="linenos">146</span></a>    
</span><span id="eval_xc_2_cupy-147"><a href="#eval_xc_2_cupy-147"><span class="linenos">147</span></a>
</span><span id="eval_xc_2_cupy-148"><a href="#eval_xc_2_cupy-148"><span class="linenos">148</span></a>    <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>    
</span><span id="eval_xc_2_cupy-149"><a href="#eval_xc_2_cupy-149"><span class="linenos">149</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-150"><a href="#eval_xc_2_cupy-150"><span class="linenos">150</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_2_cupy-151"><a href="#eval_xc_2_cupy-151"><span class="linenos">151</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timings:&#39;</span><span class="p">,</span> <span class="n">timings</span><span class="p">)</span>
</span><span id="eval_xc_2_cupy-152"><a href="#eval_xc_2_cupy-152"><span class="linenos">152</span></a>
</span><span id="eval_xc_2_cupy-153"><a href="#eval_xc_2_cupy-153"><span class="linenos">153</span></a>    <span class="c1">####### Free memory</span>
</span><span id="eval_xc_2_cupy-154"><a href="#eval_xc_2_cupy-154"><span class="linenos">154</span></a>    <span class="c1">## The following is very important to prevent memory leaks and also to make sure that the number of </span>
</span><span id="eval_xc_2_cupy-155"><a href="#eval_xc_2_cupy-155"><span class="linenos">155</span></a>    <span class="c1"># threads used by the program is same as that specified by the user </span>
</span><span id="eval_xc_2_cupy-156"><a href="#eval_xc_2_cupy-156"><span class="linenos">156</span></a>    <span class="c1"># gc.collect()  # Avoiding using it for now, as it is usually quite slow, although in this case it might not make much difference</span>
</span><span id="eval_xc_2_cupy-157"><a href="#eval_xc_2_cupy-157"><span class="linenos">157</span></a>    <span class="c1"># Anyway, the following also works</span>
</span><span id="eval_xc_2_cupy-158"><a href="#eval_xc_2_cupy-158"><span class="linenos">158</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2_cupy-159"><a href="#eval_xc_2_cupy-159"><span class="linenos">159</span></a>    <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2_cupy-160"><a href="#eval_xc_2_cupy-160"><span class="linenos">160</span></a>    <span class="n">coords</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_2_cupy-161"><a href="#eval_xc_2_cupy-161"><span class="linenos">161</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_2_cupy-162"><a href="#eval_xc_2_cupy-162"><span class="linenos">162</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">,</span> <span class="n">v</span>
</span></pre></div>


    

                </section>
                <section id="eval_xc_3_cupy">
                            <input id="eval_xc_3_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_xc_3_cupy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">dmat</span>,</span><span class="param">	<span class="n">weights</span>,</span><span class="param">	<span class="n">coords</span>,</span><span class="param">	<span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>,</span><span class="param">	<span class="n">spin</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="mi">10240</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">use_libxc</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">nstreams</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">ngpus</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">freemem</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">threads_per_block</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	type=&lt;class &#x27;numpy.float64&#x27;&gt;,</span><span class="param">	<span class="n">streams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">nb_streams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">bfs_data_as_np_arrays</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="eval_xc_3_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_xc_3_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_xc_3_cupy-25"><a href="#eval_xc_3_cupy-25"><span class="linenos"> 25</span></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_xc_3_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">10240</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
</span><span id="eval_xc_3_cupy-26"><a href="#eval_xc_3_cupy-26"><span class="linenos"> 26</span></a>                   <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nstreams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
</span><span id="eval_xc_3_cupy-27"><a href="#eval_xc_3_cupy-27"><span class="linenos"> 27</span></a>                    <span class="n">freemem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_streams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-28"><a href="#eval_xc_3_cupy-28"><span class="linenos"> 28</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating XC term using GPU and algo 3&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-29"><a href="#eval_xc_3_cupy-29"><span class="linenos"> 29</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-30"><a href="#eval_xc_3_cupy-30"><span class="linenos"> 30</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not using LibXC for XC evaluations&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-31"><a href="#eval_xc_3_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># This performs parallelization at the blocks/batches level.</span>
</span><span id="eval_xc_3_cupy-32"><a href="#eval_xc_3_cupy-32"><span class="linenos"> 32</span></a>    <span class="c1"># Therefore, joblib is perfect for such embarrasingly parallel task</span>
</span><span id="eval_xc_3_cupy-33"><a href="#eval_xc_3_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1"># In order to evaluate a density functional we will use the </span>
</span><span id="eval_xc_3_cupy-34"><a href="#eval_xc_3_cupy-34"><span class="linenos"> 34</span></a>    <span class="c1"># libxc library with Python bindings.</span>
</span><span id="eval_xc_3_cupy-35"><a href="#eval_xc_3_cupy-35"><span class="linenos"> 35</span></a>    <span class="c1"># However, some sort of simple functionals like LDA, GGA, etc would</span>
</span><span id="eval_xc_3_cupy-36"><a href="#eval_xc_3_cupy-36"><span class="linenos"> 36</span></a>    <span class="c1"># need to be implemented in CrysX also, so that the it doesn&#39;t depend</span>
</span><span id="eval_xc_3_cupy-37"><a href="#eval_xc_3_cupy-37"><span class="linenos"> 37</span></a>    <span class="c1"># on external libraries so heavily that it becomes unusable without those.</span>
</span><span id="eval_xc_3_cupy-38"><a href="#eval_xc_3_cupy-38"><span class="linenos"> 38</span></a>
</span><span id="eval_xc_3_cupy-39"><a href="#eval_xc_3_cupy-39"><span class="linenos"> 39</span></a>    <span class="c1">#Useful links:</span>
</span><span id="eval_xc_3_cupy-40"><a href="#eval_xc_3_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1"># LibXC manual: https://www.tddft.org/programs/libxc/manual/</span>
</span><span id="eval_xc_3_cupy-41"><a href="#eval_xc_3_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1"># LibXC gitlab: https://gitlab.com/libxc/libxc/-/tree/master</span>
</span><span id="eval_xc_3_cupy-42"><a href="#eval_xc_3_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1"># LibXC python interface code: https://gitlab.com/libxc/libxc/-/blob/master/pylibxc/functional.py</span>
</span><span id="eval_xc_3_cupy-43"><a href="#eval_xc_3_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1"># LibXC python version installation and example: https://www.tddft.org/programs/libxc/installation/</span>
</span><span id="eval_xc_3_cupy-44"><a href="#eval_xc_3_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1"># Formulae for XC energy and potential calculation: https://pubs.acs.org/doi/full/10.1021/ct200412r</span>
</span><span id="eval_xc_3_cupy-45"><a href="#eval_xc_3_cupy-45"><span class="linenos"> 45</span></a>    <span class="c1"># LibXC code list: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/libxc.py</span>
</span><span id="eval_xc_3_cupy-46"><a href="#eval_xc_3_cupy-46"><span class="linenos"> 46</span></a>    <span class="c1"># PySCF nr_rks code: https://github.com/pyscf/pyscf/blob/master/pyscf/dft/numint.py</span>
</span><span id="eval_xc_3_cupy-47"><a href="#eval_xc_3_cupy-47"><span class="linenos"> 47</span></a>    <span class="c1"># https://www.osti.gov/pages/servlets/purl/1650078</span>
</span><span id="eval_xc_3_cupy-48"><a href="#eval_xc_3_cupy-48"><span class="linenos"> 48</span></a>
</span><span id="eval_xc_3_cupy-49"><a href="#eval_xc_3_cupy-49"><span class="linenos"> 49</span></a>    <span class="c1">#OUTPUT</span>
</span><span id="eval_xc_3_cupy-50"><a href="#eval_xc_3_cupy-50"><span class="linenos"> 50</span></a>    <span class="c1">#Functional energy</span>
</span><span id="eval_xc_3_cupy-51"><a href="#eval_xc_3_cupy-51"><span class="linenos"> 51</span></a>    <span class="n">efunc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-52"><a href="#eval_xc_3_cupy-52"><span class="linenos"> 52</span></a>    <span class="c1"># Start from the main GPU</span>
</span><span id="eval_xc_3_cupy-53"><a href="#eval_xc_3_cupy-53"><span class="linenos"> 53</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-54"><a href="#eval_xc_3_cupy-54"><span class="linenos"> 54</span></a>    <span class="c1">#Functional potential V_{\mu \nu} = \mu|\partial{f}/\partial{\rho}|\nu</span>
</span><span id="eval_xc_3_cupy-55"><a href="#eval_xc_3_cupy-55"><span class="linenos"> 55</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-56"><a href="#eval_xc_3_cupy-56"><span class="linenos"> 56</span></a>    <span class="n">nelec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3_cupy-57"><a href="#eval_xc_3_cupy-57"><span class="linenos"> 57</span></a>
</span><span id="eval_xc_3_cupy-58"><a href="#eval_xc_3_cupy-58"><span class="linenos"> 58</span></a>    <span class="c1"># TODO it only works for LDA functionals for now.</span>
</span><span id="eval_xc_3_cupy-59"><a href="#eval_xc_3_cupy-59"><span class="linenos"> 59</span></a>    <span class="c1"># Need to make it work for GGA, Hybrid, range-separated Hybrid and MetaGGA functionals as well.</span>
</span><span id="eval_xc_3_cupy-60"><a href="#eval_xc_3_cupy-60"><span class="linenos"> 60</span></a>    
</span><span id="eval_xc_3_cupy-61"><a href="#eval_xc_3_cupy-61"><span class="linenos"> 61</span></a>
</span><span id="eval_xc_3_cupy-62"><a href="#eval_xc_3_cupy-62"><span class="linenos"> 62</span></a>    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-63"><a href="#eval_xc_3_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="eval_xc_3_cupy-64"><a href="#eval_xc_3_cupy-64"><span class="linenos"> 64</span></a>
</span><span id="eval_xc_3_cupy-65"><a href="#eval_xc_3_cupy-65"><span class="linenos"> 65</span></a>    <span class="c1"># print(&#39;Number of blocks: &#39;, nblocks)</span>
</span><span id="eval_xc_3_cupy-66"><a href="#eval_xc_3_cupy-66"><span class="linenos"> 66</span></a>
</span><span id="eval_xc_3_cupy-67"><a href="#eval_xc_3_cupy-67"><span class="linenos"> 67</span></a>    <span class="c1"># Some stuff to note timings</span>
</span><span id="eval_xc_3_cupy-68"><a href="#eval_xc_3_cupy-68"><span class="linenos"> 68</span></a>    <span class="n">timings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_3_cupy-69"><a href="#eval_xc_3_cupy-69"><span class="linenos"> 69</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-70"><a href="#eval_xc_3_cupy-70"><span class="linenos"> 70</span></a>        <span class="n">durationLibxc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-71"><a href="#eval_xc_3_cupy-71"><span class="linenos"> 71</span></a>        <span class="n">durationE</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-72"><a href="#eval_xc_3_cupy-72"><span class="linenos"> 72</span></a>        <span class="n">durationF</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-73"><a href="#eval_xc_3_cupy-73"><span class="linenos"> 73</span></a>        <span class="n">durationZ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-74"><a href="#eval_xc_3_cupy-74"><span class="linenos"> 74</span></a>        <span class="n">durationV</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-75"><a href="#eval_xc_3_cupy-75"><span class="linenos"> 75</span></a>        <span class="n">durationRho</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-76"><a href="#eval_xc_3_cupy-76"><span class="linenos"> 76</span></a>        <span class="n">durationAO</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="eval_xc_3_cupy-77"><a href="#eval_xc_3_cupy-77"><span class="linenos"> 77</span></a>        <span class="n">timings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">:</span><span class="n">durationLibxc</span><span class="p">,</span> <span class="s1">&#39;durationE&#39;</span><span class="p">:</span><span class="n">durationE</span><span class="p">,</span> <span class="s1">&#39;durationF&#39;</span><span class="p">:</span><span class="n">durationF</span><span class="p">,</span> <span class="s1">&#39;durationZ&#39;</span><span class="p">:</span><span class="n">durationZ</span><span class="p">,</span> <span class="s1">&#39;durationV&#39;</span><span class="p">:</span><span class="n">durationV</span><span class="p">,</span> <span class="s1">&#39;durationRho&#39;</span><span class="p">:</span><span class="n">durationRho</span><span class="p">,</span> <span class="s1">&#39;durationAO&#39;</span><span class="p">:</span><span class="n">durationAO</span><span class="p">}</span>
</span><span id="eval_xc_3_cupy-78"><a href="#eval_xc_3_cupy-78"><span class="linenos"> 78</span></a>
</span><span id="eval_xc_3_cupy-79"><a href="#eval_xc_3_cupy-79"><span class="linenos"> 79</span></a>    
</span><span id="eval_xc_3_cupy-80"><a href="#eval_xc_3_cupy-80"><span class="linenos"> 80</span></a>
</span><span id="eval_xc_3_cupy-81"><a href="#eval_xc_3_cupy-81"><span class="linenos"> 81</span></a>    <span class="c1">### Calculate stuff necessary for bf/ao evaluation on grid points</span>
</span><span id="eval_xc_3_cupy-82"><a href="#eval_xc_3_cupy-82"><span class="linenos"> 82</span></a>    <span class="c1">### Doesn&#39;t make any difference for 510 bfs but might be significant for &gt;1000 bfs</span>
</span><span id="eval_xc_3_cupy-83"><a href="#eval_xc_3_cupy-83"><span class="linenos"> 83</span></a>    <span class="c1"># This will help to make the call to evalbfnumba1 faster by skipping the mediator evalbfnumbawrap function </span>
</span><span id="eval_xc_3_cupy-84"><a href="#eval_xc_3_cupy-84"><span class="linenos"> 84</span></a>    <span class="c1"># that prepares the following stuff at every iteration</span>
</span><span id="eval_xc_3_cupy-85"><a href="#eval_xc_3_cupy-85"><span class="linenos"> 85</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="eval_xc_3_cupy-86"><a href="#eval_xc_3_cupy-86"><span class="linenos"> 86</span></a>    <span class="k">if</span> <span class="n">bfs_data_as_np_arrays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-87"><a href="#eval_xc_3_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-88"><a href="#eval_xc_3_cupy-88"><span class="linenos"> 88</span></a>        <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-89"><a href="#eval_xc_3_cupy-89"><span class="linenos"> 89</span></a>        <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="eval_xc_3_cupy-90"><a href="#eval_xc_3_cupy-90"><span class="linenos"> 90</span></a>        <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="eval_xc_3_cupy-91"><a href="#eval_xc_3_cupy-91"><span class="linenos"> 91</span></a>        <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="eval_xc_3_cupy-92"><a href="#eval_xc_3_cupy-92"><span class="linenos"> 92</span></a>        <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="eval_xc_3_cupy-93"><a href="#eval_xc_3_cupy-93"><span class="linenos"> 93</span></a>        <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="eval_xc_3_cupy-94"><a href="#eval_xc_3_cupy-94"><span class="linenos"> 94</span></a>        <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="eval_xc_3_cupy-95"><a href="#eval_xc_3_cupy-95"><span class="linenos"> 95</span></a>        <span class="c1">#it can accomadate all the lists.</span>
</span><span id="eval_xc_3_cupy-96"><a href="#eval_xc_3_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-97"><a href="#eval_xc_3_cupy-97"><span class="linenos"> 97</span></a>        <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-98"><a href="#eval_xc_3_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-99"><a href="#eval_xc_3_cupy-99"><span class="linenos"> 99</span></a>        <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-100"><a href="#eval_xc_3_cupy-100"><span class="linenos">100</span></a>        <span class="n">bfs_radius_cutoff</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-101"><a href="#eval_xc_3_cupy-101"><span class="linenos">101</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-102"><a href="#eval_xc_3_cupy-102"><span class="linenos">102</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="eval_xc_3_cupy-103"><a href="#eval_xc_3_cupy-103"><span class="linenos">103</span></a>                <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-104"><a href="#eval_xc_3_cupy-104"><span class="linenos">104</span></a>                <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-105"><a href="#eval_xc_3_cupy-105"><span class="linenos">105</span></a>                <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-106"><a href="#eval_xc_3_cupy-106"><span class="linenos">106</span></a>                <span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_radius_cutoff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-107"><a href="#eval_xc_3_cupy-107"><span class="linenos">107</span></a>        <span class="c1"># Now bf/ao values can be evaluated by calling the following</span>
</span><span id="eval_xc_3_cupy-108"><a href="#eval_xc_3_cupy-108"><span class="linenos">108</span></a>        <span class="c1"># bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="eval_xc_3_cupy-109"><a href="#eval_xc_3_cupy-109"><span class="linenos">109</span></a>        <span class="n">bfs_data_as_np_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">bfs_radius_cutoff</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-110"><a href="#eval_xc_3_cupy-110"><span class="linenos">110</span></a>
</span><span id="eval_xc_3_cupy-111"><a href="#eval_xc_3_cupy-111"><span class="linenos">111</span></a>    <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="eval_xc_3_cupy-112"><a href="#eval_xc_3_cupy-112"><span class="linenos">112</span></a>    <span class="c1"># Create a LibXC object  </span>
</span><span id="eval_xc_3_cupy-113"><a href="#eval_xc_3_cupy-113"><span class="linenos">113</span></a>    <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-114"><a href="#eval_xc_3_cupy-114"><span class="linenos">114</span></a>    <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-115"><a href="#eval_xc_3_cupy-115"><span class="linenos">115</span></a>    <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-116"><a href="#eval_xc_3_cupy-116"><span class="linenos">116</span></a>    <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-117"><a href="#eval_xc_3_cupy-117"><span class="linenos">117</span></a>
</span><span id="eval_xc_3_cupy-118"><a href="#eval_xc_3_cupy-118"><span class="linenos">118</span></a>    <span class="n">my_expr</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-119"><a href="#eval_xc_3_cupy-119"><span class="linenos">119</span></a>    <span class="n">my_expr_grad1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_3_cupy-120"><a href="#eval_xc_3_cupy-120"><span class="linenos">120</span></a>    <span class="n">my_expr_grad2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="eval_xc_3_cupy-121"><a href="#eval_xc_3_cupy-121"><span class="linenos">121</span></a>    <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-122"><a href="#eval_xc_3_cupy-122"><span class="linenos">122</span></a>        <span class="n">my_expr_grad1</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,kmi,mj-&gt;km&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-123"><a href="#eval_xc_3_cupy-123"><span class="linenos">123</span></a>        <span class="n">my_expr_grad2</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span><span class="s1">&#39;ij,mi,kmj-&gt;km&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-124"><a href="#eval_xc_3_cupy-124"><span class="linenos">124</span></a>    <span class="n">contr_expr</span> <span class="o">=</span> <span class="p">[</span><span class="n">my_expr</span><span class="p">,</span> <span class="n">my_expr_grad1</span><span class="p">,</span> <span class="n">my_expr_grad2</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-125"><a href="#eval_xc_3_cupy-125"><span class="linenos">125</span></a>
</span><span id="eval_xc_3_cupy-126"><a href="#eval_xc_3_cupy-126"><span class="linenos">126</span></a>    <span class="k">if</span> <span class="n">threads_per_block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-127"><a href="#eval_xc_3_cupy-127"><span class="linenos">127</span></a>        <span class="c1"># Determine the optimal number of blocks per grid</span>
</span><span id="eval_xc_3_cupy-128"><a href="#eval_xc_3_cupy-128"><span class="linenos">128</span></a>        <span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span>
</span><span id="eval_xc_3_cupy-129"><a href="#eval_xc_3_cupy-129"><span class="linenos">129</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">16</span>
</span><span id="eval_xc_3_cupy-130"><a href="#eval_xc_3_cupy-130"><span class="linenos">130</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">64</span>
</span><span id="eval_xc_3_cupy-131"><a href="#eval_xc_3_cupy-131"><span class="linenos">131</span></a>        <span class="n">threads_per_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-132"><a href="#eval_xc_3_cupy-132"><span class="linenos">132</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-133"><a href="#eval_xc_3_cupy-133"><span class="linenos">133</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="n">threads_per_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-134"><a href="#eval_xc_3_cupy-134"><span class="linenos">134</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="n">threads_per_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-135"><a href="#eval_xc_3_cupy-135"><span class="linenos">135</span></a>    
</span><span id="eval_xc_3_cupy-136"><a href="#eval_xc_3_cupy-136"><span class="linenos">136</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">)):</span>
</span><span id="eval_xc_3_cupy-137"><a href="#eval_xc_3_cupy-137"><span class="linenos">137</span></a>        <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">])</span>
</span><span id="eval_xc_3_cupy-138"><a href="#eval_xc_3_cupy-138"><span class="linenos">138</span></a>
</span><span id="eval_xc_3_cupy-139"><a href="#eval_xc_3_cupy-139"><span class="linenos">139</span></a>    
</span><span id="eval_xc_3_cupy-140"><a href="#eval_xc_3_cupy-140"><span class="linenos">140</span></a>    <span class="n">weights_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-141"><a href="#eval_xc_3_cupy-141"><span class="linenos">141</span></a>    <span class="n">coords_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-142"><a href="#eval_xc_3_cupy-142"><span class="linenos">142</span></a>
</span><span id="eval_xc_3_cupy-143"><a href="#eval_xc_3_cupy-143"><span class="linenos">143</span></a>    <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-144"><a href="#eval_xc_3_cupy-144"><span class="linenos">144</span></a>    <span class="c1"># Create dmat lists</span>
</span><span id="eval_xc_3_cupy-145"><a href="#eval_xc_3_cupy-145"><span class="linenos">145</span></a>    <span class="n">dmats_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="eval_xc_3_cupy-146"><a href="#eval_xc_3_cupy-146"><span class="linenos">146</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-147"><a href="#eval_xc_3_cupy-147"><span class="linenos">147</span></a>        <span class="n">dmats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dmat_cp</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])]))</span>
</span><span id="eval_xc_3_cupy-148"><a href="#eval_xc_3_cupy-148"><span class="linenos">148</span></a>        
</span><span id="eval_xc_3_cupy-149"><a href="#eval_xc_3_cupy-149"><span class="linenos">149</span></a>    <span class="c1"># Create streams for asynchronous execution</span>
</span><span id="eval_xc_3_cupy-150"><a href="#eval_xc_3_cupy-150"><span class="linenos">150</span></a>    <span class="c1"># on different GPUs </span>
</span><span id="eval_xc_3_cupy-151"><a href="#eval_xc_3_cupy-151"><span class="linenos">151</span></a>    <span class="k">if</span> <span class="n">streams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nb_streams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-152"><a href="#eval_xc_3_cupy-152"><span class="linenos">152</span></a>        <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="eval_xc_3_cupy-153"><a href="#eval_xc_3_cupy-153"><span class="linenos">153</span></a>        <span class="n">nb_streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="eval_xc_3_cupy-154"><a href="#eval_xc_3_cupy-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngpus</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-155"><a href="#eval_xc_3_cupy-155"><span class="linenos">155</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-156"><a href="#eval_xc_3_cupy-156"><span class="linenos">156</span></a>            <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-157"><a href="#eval_xc_3_cupy-157"><span class="linenos">157</span></a>            <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-158"><a href="#eval_xc_3_cupy-158"><span class="linenos">158</span></a>            <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp_stream</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-159"><a href="#eval_xc_3_cupy-159"><span class="linenos">159</span></a>            <span class="n">nb_streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb_stream</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-160"><a href="#eval_xc_3_cupy-160"><span class="linenos">160</span></a>
</span><span id="eval_xc_3_cupy-161"><a href="#eval_xc_3_cupy-161"><span class="linenos">161</span></a>    <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-162"><a href="#eval_xc_3_cupy-162"><span class="linenos">162</span></a>        <span class="k">if</span> <span class="n">list_ao_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-163"><a href="#eval_xc_3_cupy-163"><span class="linenos">163</span></a>            <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-164"><a href="#eval_xc_3_cupy-164"><span class="linenos">164</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ngpus</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmats_list</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">nb_stream</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">thread_x</span><span class="o">=</span><span class="n">thread_x</span><span class="p">,</span> 
</span><span id="eval_xc_3_cupy-165"><a href="#eval_xc_3_cupy-165"><span class="linenos">165</span></a>                    <span class="n">thread_y</span><span class="o">=</span><span class="n">thread_y</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="n">use_libxc</span><span class="p">,</span> <span class="n">expressions</span><span class="o">=</span><span class="n">contr_expr</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-166"><a href="#eval_xc_3_cupy-166"><span class="linenos">166</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#GGA</span>
</span><span id="eval_xc_3_cupy-167"><a href="#eval_xc_3_cupy-167"><span class="linenos">167</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ngpus</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmats_list</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">list_ao_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">list_ao_grad_values</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">nb_stream</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">thread_x</span><span class="o">=</span><span class="n">thread_x</span><span class="p">,</span> 
</span><span id="eval_xc_3_cupy-168"><a href="#eval_xc_3_cupy-168"><span class="linenos">168</span></a>                    <span class="n">thread_y</span><span class="o">=</span><span class="n">thread_y</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="n">use_libxc</span><span class="p">,</span> <span class="n">expressions</span><span class="o">=</span><span class="n">contr_expr</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-169"><a href="#eval_xc_3_cupy-169"><span class="linenos">169</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-170"><a href="#eval_xc_3_cupy-170"><span class="linenos">170</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ngpus</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmats_list</span><span class="p">[</span><span class="n">iblock</span><span class="p">],</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]],</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">nb_stream</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">thread_x</span><span class="o">=</span><span class="n">thread_x</span><span class="p">,</span> 
</span><span id="eval_xc_3_cupy-171"><a href="#eval_xc_3_cupy-171"><span class="linenos">171</span></a>                    <span class="n">thread_y</span><span class="o">=</span><span class="n">thread_y</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="n">use_libxc</span><span class="p">,</span> <span class="n">expressions</span><span class="o">=</span><span class="n">contr_expr</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-172"><a href="#eval_xc_3_cupy-172"><span class="linenos">172</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-173"><a href="#eval_xc_3_cupy-173"><span class="linenos">173</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ngpus</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">block_dens_func</span><span class="p">)(</span><span class="n">weights_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">coords_cp</span><span class="p">[</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)],</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">bfs_data_as_np_arrays</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ao_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">funcx</span><span class="o">=</span><span class="n">funcx</span><span class="p">,</span> <span class="n">funcc</span><span class="o">=</span><span class="n">funcc</span><span class="p">,</span> <span class="n">x_family_code</span><span class="o">=</span><span class="n">x_family_code</span><span class="p">,</span> <span class="n">c_family_code</span><span class="o">=</span><span class="n">c_family_code</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="o">=</span><span class="n">xc_family_dict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">nb_stream</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">[</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">],</span> <span class="n">thread_x</span><span class="o">=</span><span class="n">thread_x</span><span class="p">,</span> 
</span><span id="eval_xc_3_cupy-174"><a href="#eval_xc_3_cupy-174"><span class="linenos">174</span></a>                    <span class="n">thread_y</span><span class="o">=</span><span class="n">thread_y</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="n">use_libxc</span><span class="p">,</span> <span class="n">expressions</span><span class="o">=</span><span class="n">contr_expr</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">iblock</span><span class="o">%</span><span class="n">ngpus</span><span class="p">)</span> <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="eval_xc_3_cupy-175"><a href="#eval_xc_3_cupy-175"><span class="linenos">175</span></a>        
</span><span id="eval_xc_3_cupy-176"><a href="#eval_xc_3_cupy-176"><span class="linenos">176</span></a>    <span class="k">for</span> <span class="n">istream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngpus</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-177"><a href="#eval_xc_3_cupy-177"><span class="linenos">177</span></a>        <span class="n">streams</span><span class="p">[</span><span class="n">istream</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-178"><a href="#eval_xc_3_cupy-178"><span class="linenos">178</span></a>    <span class="c1"># Switch back to main GPU</span>
</span><span id="eval_xc_3_cupy-179"><a href="#eval_xc_3_cupy-179"><span class="linenos">179</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-180"><a href="#eval_xc_3_cupy-180"><span class="linenos">180</span></a>    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)):</span>
</span><span id="eval_xc_3_cupy-181"><a href="#eval_xc_3_cupy-181"><span class="linenos">181</span></a>        <span class="n">efunc</span> <span class="o">+=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="eval_xc_3_cupy-182"><a href="#eval_xc_3_cupy-182"><span class="linenos">182</span></a>        <span class="k">if</span> <span class="n">list_nonzero_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-183"><a href="#eval_xc_3_cupy-183"><span class="linenos">183</span></a>            <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="eval_xc_3_cupy-184"><a href="#eval_xc_3_cupy-184"><span class="linenos">184</span></a>            <span class="c1"># v[cp.ix_(non_zero_indices, non_zero_indices)] += cp.asarray(output[iblock][1])</span>
</span><span id="eval_xc_3_cupy-185"><a href="#eval_xc_3_cupy-185"><span class="linenos">185</span></a>            <span class="n">v</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="n">cp</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">)]</span>
</span><span id="eval_xc_3_cupy-186"><a href="#eval_xc_3_cupy-186"><span class="linenos">186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-187"><a href="#eval_xc_3_cupy-187"><span class="linenos">187</span></a>            <span class="c1"># v += cp.asarray(output[iblock][1])</span>
</span><span id="eval_xc_3_cupy-188"><a href="#eval_xc_3_cupy-188"><span class="linenos">188</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-189"><a href="#eval_xc_3_cupy-189"><span class="linenos">189</span></a>        <span class="n">nelec</span> <span class="o">+=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> 
</span><span id="eval_xc_3_cupy-190"><a href="#eval_xc_3_cupy-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-191"><a href="#eval_xc_3_cupy-191"><span class="linenos">191</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationLibxc&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-192"><a href="#eval_xc_3_cupy-192"><span class="linenos">192</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationE&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-193"><a href="#eval_xc_3_cupy-193"><span class="linenos">193</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationF&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-194"><a href="#eval_xc_3_cupy-194"><span class="linenos">194</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationZ&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-195"><a href="#eval_xc_3_cupy-195"><span class="linenos">195</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationV&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-196"><a href="#eval_xc_3_cupy-196"><span class="linenos">196</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationRho&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-197"><a href="#eval_xc_3_cupy-197"><span class="linenos">197</span></a>            <span class="n">timings</span><span class="p">[</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;durationAO&#39;</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-198"><a href="#eval_xc_3_cupy-198"><span class="linenos">198</span></a>        <span class="c1"># v = numexpr.evaluate(&#39;(v + output[iblock][1])&#39;)</span>
</span><span id="eval_xc_3_cupy-199"><a href="#eval_xc_3_cupy-199"><span class="linenos">199</span></a>
</span><span id="eval_xc_3_cupy-200"><a href="#eval_xc_3_cupy-200"><span class="linenos">200</span></a>
</span><span id="eval_xc_3_cupy-201"><a href="#eval_xc_3_cupy-201"><span class="linenos">201</span></a>    
</span><span id="eval_xc_3_cupy-202"><a href="#eval_xc_3_cupy-202"><span class="linenos">202</span></a>   
</span><span id="eval_xc_3_cupy-203"><a href="#eval_xc_3_cupy-203"><span class="linenos">203</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of electrons: &#39;</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-204"><a href="#eval_xc_3_cupy-204"><span class="linenos">204</span></a>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-205"><a href="#eval_xc_3_cupy-205"><span class="linenos">205</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timings:&#39;</span><span class="p">,</span> <span class="n">timings</span><span class="p">)</span>
</span><span id="eval_xc_3_cupy-206"><a href="#eval_xc_3_cupy-206"><span class="linenos">206</span></a>
</span><span id="eval_xc_3_cupy-207"><a href="#eval_xc_3_cupy-207"><span class="linenos">207</span></a>    <span class="c1">####### Free memory</span>
</span><span id="eval_xc_3_cupy-208"><a href="#eval_xc_3_cupy-208"><span class="linenos">208</span></a>    <span class="c1">## The following is very important to prevent memory leaks and also to make sure that the number of </span>
</span><span id="eval_xc_3_cupy-209"><a href="#eval_xc_3_cupy-209"><span class="linenos">209</span></a>    <span class="c1"># threads used by the program is same as that specified by the user </span>
</span><span id="eval_xc_3_cupy-210"><a href="#eval_xc_3_cupy-210"><span class="linenos">210</span></a>    <span class="c1"># gc.collect()  # Avoiding using it for now, as it is usually quite slow, although in this case it might not make much difference</span>
</span><span id="eval_xc_3_cupy-211"><a href="#eval_xc_3_cupy-211"><span class="linenos">211</span></a>    <span class="c1"># Anyway, the following also works</span>
</span><span id="eval_xc_3_cupy-212"><a href="#eval_xc_3_cupy-212"><span class="linenos">212</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3_cupy-213"><a href="#eval_xc_3_cupy-213"><span class="linenos">213</span></a>    <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3_cupy-214"><a href="#eval_xc_3_cupy-214"><span class="linenos">214</span></a>    <span class="n">coords</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="eval_xc_3_cupy-215"><a href="#eval_xc_3_cupy-215"><span class="linenos">215</span></a>
</span><span id="eval_xc_3_cupy-216"><a href="#eval_xc_3_cupy-216"><span class="linenos">216</span></a>
</span><span id="eval_xc_3_cupy-217"><a href="#eval_xc_3_cupy-217"><span class="linenos">217</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-218"><a href="#eval_xc_3_cupy-218"><span class="linenos">218</span></a>
</span><span id="eval_xc_3_cupy-219"><a href="#eval_xc_3_cupy-219"><span class="linenos">219</span></a>    <span class="k">if</span> <span class="n">use_libxc</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-220"><a href="#eval_xc_3_cupy-220"><span class="linenos">220</span></a>        <span class="n">efunc</span> <span class="o">=</span> <span class="n">efunc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="eval_xc_3_cupy-221"><a href="#eval_xc_3_cupy-221"><span class="linenos">221</span></a>
</span><span id="eval_xc_3_cupy-222"><a href="#eval_xc_3_cupy-222"><span class="linenos">222</span></a>    <span class="k">if</span> <span class="n">freemem</span><span class="p">:</span>
</span><span id="eval_xc_3_cupy-223"><a href="#eval_xc_3_cupy-223"><span class="linenos">223</span></a>        <span class="k">for</span> <span class="n">istream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngpus</span><span class="p">):</span>
</span><span id="eval_xc_3_cupy-224"><a href="#eval_xc_3_cupy-224"><span class="linenos">224</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">istream</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-225"><a href="#eval_xc_3_cupy-225"><span class="linenos">225</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">_default_memory_pool</span><span class="o">.</span><span class="n">free_all_blocks</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-226"><a href="#eval_xc_3_cupy-226"><span class="linenos">226</span></a>            <span class="c1"># cuda.current_context().memory_manager.deallocations.clear()</span>
</span><span id="eval_xc_3_cupy-227"><a href="#eval_xc_3_cupy-227"><span class="linenos">227</span></a>        <span class="c1"># Switch back to main GPU</span>
</span><span id="eval_xc_3_cupy-228"><a href="#eval_xc_3_cupy-228"><span class="linenos">228</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="eval_xc_3_cupy-229"><a href="#eval_xc_3_cupy-229"><span class="linenos">229</span></a>
</span><span id="eval_xc_3_cupy-230"><a href="#eval_xc_3_cupy-230"><span class="linenos">230</span></a>    <span class="k">return</span> <span class="n">efunc</span><span class="p">,</span> <span class="n">v</span>
</span></pre></div>


    

                </section>
                <section id="dipole_moment_mat_symm">
                            <input id="dipole_moment_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dipole_moment_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">origin</span><span class="o">=</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="dipole_moment_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#dipole_moment_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="dipole_moment_mat_symm-7"><a href="#dipole_moment_mat_symm-7"><span class="linenos">  7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">dipole_moment_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))):</span>
</span><span id="dipole_moment_mat_symm-8"><a href="#dipole_moment_mat_symm-8"><span class="linenos">  8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="dipole_moment_mat_symm-9"><a href="#dipole_moment_mat_symm-9"><span class="linenos">  9</span></a><span class="sd">    Compute the dipole moment integral matrix in the atomic orbital (AO) basis</span>
</span><span id="dipole_moment_mat_symm-10"><a href="#dipole_moment_mat_symm-10"><span class="linenos"> 10</span></a><span class="sd">    using symmetry and the McMurchie–Davidson algorithm.</span>
</span><span id="dipole_moment_mat_symm-11"><a href="#dipole_moment_mat_symm-11"><span class="linenos"> 11</span></a>
</span><span id="dipole_moment_mat_symm-12"><a href="#dipole_moment_mat_symm-12"><span class="linenos"> 12</span></a><span class="sd">    This routine evaluates the matrix elements:</span>
</span><span id="dipole_moment_mat_symm-13"><a href="#dipole_moment_mat_symm-13"><span class="linenos"> 13</span></a>
</span><span id="dipole_moment_mat_symm-14"><a href="#dipole_moment_mat_symm-14"><span class="linenos"> 14</span></a><span class="sd">        μ_ij^(k) = ⟨ χ_i | r_k | χ_j ⟩</span>
</span><span id="dipole_moment_mat_symm-15"><a href="#dipole_moment_mat_symm-15"><span class="linenos"> 15</span></a>
</span><span id="dipole_moment_mat_symm-16"><a href="#dipole_moment_mat_symm-16"><span class="linenos"> 16</span></a><span class="sd">    where:</span>
</span><span id="dipole_moment_mat_symm-17"><a href="#dipole_moment_mat_symm-17"><span class="linenos"> 17</span></a><span class="sd">        - χ_i, χ_j are Gaussian-type atomic orbitals (AOs)</span>
</span><span id="dipole_moment_mat_symm-18"><a href="#dipole_moment_mat_symm-18"><span class="linenos"> 18</span></a><span class="sd">        - r_k is the k-th Cartesian coordinate (x, y, or z)</span>
</span><span id="dipole_moment_mat_symm-19"><a href="#dipole_moment_mat_symm-19"><span class="linenos"> 19</span></a><span class="sd">        - origin is the coordinate origin for the dipole operator</span>
</span><span id="dipole_moment_mat_symm-20"><a href="#dipole_moment_mat_symm-20"><span class="linenos"> 20</span></a>
</span><span id="dipole_moment_mat_symm-21"><a href="#dipole_moment_mat_symm-21"><span class="linenos"> 21</span></a><span class="sd">    The implementation follows the McMurchie–Davidson scheme for Gaussian</span>
</span><span id="dipole_moment_mat_symm-22"><a href="#dipole_moment_mat_symm-22"><span class="linenos"> 22</span></a><span class="sd">    integrals, adapted from:</span>
</span><span id="dipole_moment_mat_symm-23"><a href="#dipole_moment_mat_symm-23"><span class="linenos"> 23</span></a>
</span><span id="dipole_moment_mat_symm-24"><a href="#dipole_moment_mat_symm-24"><span class="linenos"> 24</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="dipole_moment_mat_symm-25"><a href="#dipole_moment_mat_symm-25"><span class="linenos"> 25</span></a>
</span><span id="dipole_moment_mat_symm-26"><a href="#dipole_moment_mat_symm-26"><span class="linenos"> 26</span></a><span class="sd">    Symmetries exploited</span>
</span><span id="dipole_moment_mat_symm-27"><a href="#dipole_moment_mat_symm-27"><span class="linenos"> 27</span></a><span class="sd">    --------------------</span>
</span><span id="dipole_moment_mat_symm-28"><a href="#dipole_moment_mat_symm-28"><span class="linenos"> 28</span></a><span class="sd">    The dipole moment matrix is symmetric for real-valued AOs:</span>
</span><span id="dipole_moment_mat_symm-29"><a href="#dipole_moment_mat_symm-29"><span class="linenos"> 29</span></a>
</span><span id="dipole_moment_mat_symm-30"><a href="#dipole_moment_mat_symm-30"><span class="linenos"> 30</span></a><span class="sd">        μ_ij^(k) = μ_ji^(k)</span>
</span><span id="dipole_moment_mat_symm-31"><a href="#dipole_moment_mat_symm-31"><span class="linenos"> 31</span></a>
</span><span id="dipole_moment_mat_symm-32"><a href="#dipole_moment_mat_symm-32"><span class="linenos"> 32</span></a><span class="sd">    This halves the number of unique integrals from N_bf^2 to</span>
</span><span id="dipole_moment_mat_symm-33"><a href="#dipole_moment_mat_symm-33"><span class="linenos"> 33</span></a><span class="sd">    N_bf*(N_bf+1)/2 for each Cartesian component.</span>
</span><span id="dipole_moment_mat_symm-34"><a href="#dipole_moment_mat_symm-34"><span class="linenos"> 34</span></a>
</span><span id="dipole_moment_mat_symm-35"><a href="#dipole_moment_mat_symm-35"><span class="linenos"> 35</span></a><span class="sd">    Parameters</span>
</span><span id="dipole_moment_mat_symm-36"><a href="#dipole_moment_mat_symm-36"><span class="linenos"> 36</span></a><span class="sd">    ----------</span>
</span><span id="dipole_moment_mat_symm-37"><a href="#dipole_moment_mat_symm-37"><span class="linenos"> 37</span></a><span class="sd">    basis : object</span>
</span><span id="dipole_moment_mat_symm-38"><a href="#dipole_moment_mat_symm-38"><span class="linenos"> 38</span></a><span class="sd">        Basis set object containing:</span>
</span><span id="dipole_moment_mat_symm-39"><a href="#dipole_moment_mat_symm-39"><span class="linenos"> 39</span></a><span class="sd">        - bfs_coords : Cartesian coordinates of AO centers</span>
</span><span id="dipole_moment_mat_symm-40"><a href="#dipole_moment_mat_symm-40"><span class="linenos"> 40</span></a><span class="sd">        - bfs_coeffs : Contraction coefficients</span>
</span><span id="dipole_moment_mat_symm-41"><a href="#dipole_moment_mat_symm-41"><span class="linenos"> 41</span></a><span class="sd">        - bfs_expnts : Gaussian exponents</span>
</span><span id="dipole_moment_mat_symm-42"><a href="#dipole_moment_mat_symm-42"><span class="linenos"> 42</span></a><span class="sd">        - bfs_prim_norms : Primitive normalization constants</span>
</span><span id="dipole_moment_mat_symm-43"><a href="#dipole_moment_mat_symm-43"><span class="linenos"> 43</span></a><span class="sd">        - bfs_contr_prim_norms : Contraction normalization factors</span>
</span><span id="dipole_moment_mat_symm-44"><a href="#dipole_moment_mat_symm-44"><span class="linenos"> 44</span></a><span class="sd">        - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)</span>
</span><span id="dipole_moment_mat_symm-45"><a href="#dipole_moment_mat_symm-45"><span class="linenos"> 45</span></a><span class="sd">        - bfs_nprim : Number of primitives per basis function</span>
</span><span id="dipole_moment_mat_symm-46"><a href="#dipole_moment_mat_symm-46"><span class="linenos"> 46</span></a><span class="sd">        - bfs_nao : Number of atomic orbitals</span>
</span><span id="dipole_moment_mat_symm-47"><a href="#dipole_moment_mat_symm-47"><span class="linenos"> 47</span></a>
</span><span id="dipole_moment_mat_symm-48"><a href="#dipole_moment_mat_symm-48"><span class="linenos"> 48</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="dipole_moment_mat_symm-49"><a href="#dipole_moment_mat_symm-49"><span class="linenos"> 49</span></a><span class="sd">        A 4-element list [row_start, row_end, col_start, col_end]</span>
</span><span id="dipole_moment_mat_symm-50"><a href="#dipole_moment_mat_symm-50"><span class="linenos"> 50</span></a><span class="sd">        specifying the sub-block of the matrix to compute.</span>
</span><span id="dipole_moment_mat_symm-51"><a href="#dipole_moment_mat_symm-51"><span class="linenos"> 51</span></a><span class="sd">        If None (default), computes the full symmetric matrix.</span>
</span><span id="dipole_moment_mat_symm-52"><a href="#dipole_moment_mat_symm-52"><span class="linenos"> 52</span></a>
</span><span id="dipole_moment_mat_symm-53"><a href="#dipole_moment_mat_symm-53"><span class="linenos"> 53</span></a><span class="sd">    origin : ndarray of shape (3,), optional</span>
</span><span id="dipole_moment_mat_symm-54"><a href="#dipole_moment_mat_symm-54"><span class="linenos"> 54</span></a><span class="sd">        Origin of the dipole operator in Cartesian coordinates.</span>
</span><span id="dipole_moment_mat_symm-55"><a href="#dipole_moment_mat_symm-55"><span class="linenos"> 55</span></a><span class="sd">        Default is (0.0, 0.0, 0.0).</span>
</span><span id="dipole_moment_mat_symm-56"><a href="#dipole_moment_mat_symm-56"><span class="linenos"> 56</span></a>
</span><span id="dipole_moment_mat_symm-57"><a href="#dipole_moment_mat_symm-57"><span class="linenos"> 57</span></a><span class="sd">    Returns</span>
</span><span id="dipole_moment_mat_symm-58"><a href="#dipole_moment_mat_symm-58"><span class="linenos"> 58</span></a><span class="sd">    -------</span>
</span><span id="dipole_moment_mat_symm-59"><a href="#dipole_moment_mat_symm-59"><span class="linenos"> 59</span></a><span class="sd">    M : ndarray of shape (3, n_rows, n_cols)</span>
</span><span id="dipole_moment_mat_symm-60"><a href="#dipole_moment_mat_symm-60"><span class="linenos"> 60</span></a><span class="sd">        The computed dipole moment integrals for the requested block,</span>
</span><span id="dipole_moment_mat_symm-61"><a href="#dipole_moment_mat_symm-61"><span class="linenos"> 61</span></a><span class="sd">        with the first dimension indexing the x, y, z components.</span>
</span><span id="dipole_moment_mat_symm-62"><a href="#dipole_moment_mat_symm-62"><span class="linenos"> 62</span></a>
</span><span id="dipole_moment_mat_symm-63"><a href="#dipole_moment_mat_symm-63"><span class="linenos"> 63</span></a><span class="sd">    Notes</span>
</span><span id="dipole_moment_mat_symm-64"><a href="#dipole_moment_mat_symm-64"><span class="linenos"> 64</span></a><span class="sd">    -----</span>
</span><span id="dipole_moment_mat_symm-65"><a href="#dipole_moment_mat_symm-65"><span class="linenos"> 65</span></a><span class="sd">    - Basis set data are pre-packed into NumPy arrays for compatibility</span>
</span><span id="dipole_moment_mat_symm-66"><a href="#dipole_moment_mat_symm-66"><span class="linenos"> 66</span></a><span class="sd">      with Numba JIT compilation.</span>
</span><span id="dipole_moment_mat_symm-67"><a href="#dipole_moment_mat_symm-67"><span class="linenos"> 67</span></a><span class="sd">    - The algorithm avoids redundant evaluations by exploiting matrix</span>
</span><span id="dipole_moment_mat_symm-68"><a href="#dipole_moment_mat_symm-68"><span class="linenos"> 68</span></a><span class="sd">      symmetry when `slice` covers the full range.</span>
</span><span id="dipole_moment_mat_symm-69"><a href="#dipole_moment_mat_symm-69"><span class="linenos"> 69</span></a><span class="sd">    - The dipole moment integrals are typically used in computing</span>
</span><span id="dipole_moment_mat_symm-70"><a href="#dipole_moment_mat_symm-70"><span class="linenos"> 70</span></a><span class="sd">      molecular dipole moments from density matrices.</span>
</span><span id="dipole_moment_mat_symm-71"><a href="#dipole_moment_mat_symm-71"><span class="linenos"> 71</span></a>
</span><span id="dipole_moment_mat_symm-72"><a href="#dipole_moment_mat_symm-72"><span class="linenos"> 72</span></a><span class="sd">    Examples</span>
</span><span id="dipole_moment_mat_symm-73"><a href="#dipole_moment_mat_symm-73"><span class="linenos"> 73</span></a><span class="sd">    --------</span>
</span><span id="dipole_moment_mat_symm-74"><a href="#dipole_moment_mat_symm-74"><span class="linenos"> 74</span></a><span class="sd">    &gt;&gt;&gt; mu_full = dipole_moment_mat_symm(basis)</span>
</span><span id="dipole_moment_mat_symm-75"><a href="#dipole_moment_mat_symm-75"><span class="linenos"> 75</span></a><span class="sd">    &gt;&gt;&gt; mu_block = dipole_moment_mat_symm(basis, slice=[0, 5, 0, 5])</span>
</span><span id="dipole_moment_mat_symm-76"><a href="#dipole_moment_mat_symm-76"><span class="linenos"> 76</span></a><span class="sd">    &gt;&gt;&gt; mu_shifted = dipole_moment_mat_symm(basis, origin=np.array([1.0, 0.0, 0.0]))</span>
</span><span id="dipole_moment_mat_symm-77"><a href="#dipole_moment_mat_symm-77"><span class="linenos"> 77</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="dipole_moment_mat_symm-78"><a href="#dipole_moment_mat_symm-78"><span class="linenos"> 78</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="dipole_moment_mat_symm-79"><a href="#dipole_moment_mat_symm-79"><span class="linenos"> 79</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="dipole_moment_mat_symm-80"><a href="#dipole_moment_mat_symm-80"><span class="linenos"> 80</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="dipole_moment_mat_symm-81"><a href="#dipole_moment_mat_symm-81"><span class="linenos"> 81</span></a>
</span><span id="dipole_moment_mat_symm-82"><a href="#dipole_moment_mat_symm-82"><span class="linenos"> 82</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="dipole_moment_mat_symm-83"><a href="#dipole_moment_mat_symm-83"><span class="linenos"> 83</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="dipole_moment_mat_symm-84"><a href="#dipole_moment_mat_symm-84"><span class="linenos"> 84</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="dipole_moment_mat_symm-85"><a href="#dipole_moment_mat_symm-85"><span class="linenos"> 85</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="dipole_moment_mat_symm-86"><a href="#dipole_moment_mat_symm-86"><span class="linenos"> 86</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="dipole_moment_mat_symm-87"><a href="#dipole_moment_mat_symm-87"><span class="linenos"> 87</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="dipole_moment_mat_symm-88"><a href="#dipole_moment_mat_symm-88"><span class="linenos"> 88</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="dipole_moment_mat_symm-89"><a href="#dipole_moment_mat_symm-89"><span class="linenos"> 89</span></a>
</span><span id="dipole_moment_mat_symm-90"><a href="#dipole_moment_mat_symm-90"><span class="linenos"> 90</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="dipole_moment_mat_symm-91"><a href="#dipole_moment_mat_symm-91"><span class="linenos"> 91</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-92"><a href="#dipole_moment_mat_symm-92"><span class="linenos"> 92</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-93"><a href="#dipole_moment_mat_symm-93"><span class="linenos"> 93</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-94"><a href="#dipole_moment_mat_symm-94"><span class="linenos"> 94</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-95"><a href="#dipole_moment_mat_symm-95"><span class="linenos"> 95</span></a>        
</span><span id="dipole_moment_mat_symm-96"><a href="#dipole_moment_mat_symm-96"><span class="linenos"> 96</span></a>
</span><span id="dipole_moment_mat_symm-97"><a href="#dipole_moment_mat_symm-97"><span class="linenos"> 97</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="dipole_moment_mat_symm-98"><a href="#dipole_moment_mat_symm-98"><span class="linenos"> 98</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="dipole_moment_mat_symm-99"><a href="#dipole_moment_mat_symm-99"><span class="linenos"> 99</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="dipole_moment_mat_symm-100"><a href="#dipole_moment_mat_symm-100"><span class="linenos">100</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="dipole_moment_mat_symm-101"><a href="#dipole_moment_mat_symm-101"><span class="linenos">101</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="dipole_moment_mat_symm-102"><a href="#dipole_moment_mat_symm-102"><span class="linenos">102</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm-103"><a href="#dipole_moment_mat_symm-103"><span class="linenos">103</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-104"><a href="#dipole_moment_mat_symm-104"><span class="linenos">104</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-105"><a href="#dipole_moment_mat_symm-105"><span class="linenos">105</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm-106"><a href="#dipole_moment_mat_symm-106"><span class="linenos">106</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="dipole_moment_mat_symm-107"><a href="#dipole_moment_mat_symm-107"><span class="linenos">107</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="dipole_moment_mat_symm-108"><a href="#dipole_moment_mat_symm-108"><span class="linenos">108</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm-109"><a href="#dipole_moment_mat_symm-109"><span class="linenos">109</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm-110"><a href="#dipole_moment_mat_symm-110"><span class="linenos">110</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm-111"><a href="#dipole_moment_mat_symm-111"><span class="linenos">111</span></a>        
</span><span id="dipole_moment_mat_symm-112"><a href="#dipole_moment_mat_symm-112"><span class="linenos">112</span></a>
</span><span id="dipole_moment_mat_symm-113"><a href="#dipole_moment_mat_symm-113"><span class="linenos">113</span></a>
</span><span id="dipole_moment_mat_symm-114"><a href="#dipole_moment_mat_symm-114"><span class="linenos">114</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm-115"><a href="#dipole_moment_mat_symm-115"><span class="linenos">115</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm-116"><a href="#dipole_moment_mat_symm-116"><span class="linenos">116</span></a>        
</span><span id="dipole_moment_mat_symm-117"><a href="#dipole_moment_mat_symm-117"><span class="linenos">117</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="dipole_moment_mat_symm-118"><a href="#dipole_moment_mat_symm-118"><span class="linenos">118</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="dipole_moment_mat_symm-119"><a href="#dipole_moment_mat_symm-119"><span class="linenos">119</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="dipole_moment_mat_symm-120"><a href="#dipole_moment_mat_symm-120"><span class="linenos">120</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="dipole_moment_mat_symm-121"><a href="#dipole_moment_mat_symm-121"><span class="linenos">121</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="dipole_moment_mat_symm-122"><a href="#dipole_moment_mat_symm-122"><span class="linenos">122</span></a>
</span><span id="dipole_moment_mat_symm-123"><a href="#dipole_moment_mat_symm-123"><span class="linenos">123</span></a>        
</span><span id="dipole_moment_mat_symm-124"><a href="#dipole_moment_mat_symm-124"><span class="linenos">124</span></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">dipole_moment_mat_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm-125"><a href="#dipole_moment_mat_symm-125"><span class="linenos">125</span></a>    
</span><span id="dipole_moment_mat_symm-126"><a href="#dipole_moment_mat_symm-126"><span class="linenos">126</span></a>    <span class="k">return</span> <span class="n">M</span>
</span></pre></div>


            <div class="docstring"><p>Compute the dipole moment integral matrix in the atomic orbital (AO) basis
using symmetry and the McMurchie–Davidson algorithm.</p>

<p>This routine evaluates the matrix elements:</p>

<pre><code>μ_ij^(k) = ⟨ χ_i | r_k | χ_j ⟩
</code></pre>

<p>where:
    - χ_i, χ_j are Gaussian-type atomic orbitals (AOs)
    - r_k is the k-th Cartesian coordinate (x, y, or z)
    - origin is the coordinate origin for the dipole operator</p>

<p>The implementation follows the McMurchie–Davidson scheme for Gaussian
integrals, adapted from:</p>

<pre><code>https://github.com/jjgoings/McMurchie-Davidson
</code></pre>

<h2 id="symmetries-exploited">Symmetries exploited</h2>

<p>The dipole moment matrix is symmetric for real-valued AOs:</p>

<pre><code>μ_ij^(k) = μ_ji^(k)
</code></pre>

<p>This halves the number of unique integrals from N_bf^2 to
N_bf*(N_bf+1)/2 for each Cartesian component.</p>

<h2 id="parameters">Parameters</h2>

<p>basis : object
    Basis set object containing:
    - bfs_coords : Cartesian coordinates of AO centers
    - bfs_coeffs : Contraction coefficients
    - bfs_expnts : Gaussian exponents
    - bfs_prim_norms : Primitive normalization constants
    - bfs_contr_prim_norms : Contraction normalization factors
    - bfs_lmn : Angular momentum quantum numbers (ℓ, m, n)
    - bfs_nprim : Number of primitives per basis function
    - bfs_nao : Number of atomic orbitals</p>

<p>slice : list of int, optional
    A 4-element list [row_start, row_end, col_start, col_end]
    specifying the sub-block of the matrix to compute.
    If None (default), computes the full symmetric matrix.</p>

<p>origin : ndarray of shape (3,), optional
    Origin of the dipole operator in Cartesian coordinates.
    Default is (0.0, 0.0, 0.0).</p>

<h2 id="returns">Returns</h2>

<p>M : ndarray of shape (3, n_rows, n_cols)
    The computed dipole moment integrals for the requested block,
    with the first dimension indexing the x, y, z components.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Basis set data are pre-packed into NumPy arrays for compatibility
with Numba JIT compilation.</li>
<li>The algorithm avoids redundant evaluations by exploiting matrix
symmetry when <code>slice</code> covers the full range.</li>
<li>The dipole moment integrals are typically used in computing
molecular dipole moments from density matrices.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">mu_full</span> <span class="o">=</span> <span class="n">dipole_moment_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mu_block</span> <span class="o">=</span> <span class="n">dipole_moment_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mu_shifted</span> <span class="o">=</span> <span class="n">dipole_moment_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
</code></pre>
</div>
</div>


                </section>
                <section id="kin_mat_symm_cupy">
                            <input id="kin_mat_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kin_mat_symm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="kin_mat_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#kin_mat_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="kin_mat_symm_cupy-20"><a href="#kin_mat_symm_cupy-20"><span class="linenos"> 20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="kin_mat_symm_cupy-21"><a href="#kin_mat_symm_cupy-21"><span class="linenos"> 21</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="kin_mat_symm_cupy-22"><a href="#kin_mat_symm_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="kin_mat_symm_cupy-23"><a href="#kin_mat_symm_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="kin_mat_symm_cupy-24"><a href="#kin_mat_symm_cupy-24"><span class="linenos"> 24</span></a>
</span><span id="kin_mat_symm_cupy-25"><a href="#kin_mat_symm_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="kin_mat_symm_cupy-26"><a href="#kin_mat_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="kin_mat_symm_cupy-27"><a href="#kin_mat_symm_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="kin_mat_symm_cupy-28"><a href="#kin_mat_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="kin_mat_symm_cupy-29"><a href="#kin_mat_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="kin_mat_symm_cupy-30"><a href="#kin_mat_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="kin_mat_symm_cupy-31"><a href="#kin_mat_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="kin_mat_symm_cupy-32"><a href="#kin_mat_symm_cupy-32"><span class="linenos"> 32</span></a>
</span><span id="kin_mat_symm_cupy-33"><a href="#kin_mat_symm_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="kin_mat_symm_cupy-34"><a href="#kin_mat_symm_cupy-34"><span class="linenos"> 34</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-35"><a href="#kin_mat_symm_cupy-35"><span class="linenos"> 35</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-36"><a href="#kin_mat_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-37"><a href="#kin_mat_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-38"><a href="#kin_mat_symm_cupy-38"><span class="linenos"> 38</span></a>        
</span><span id="kin_mat_symm_cupy-39"><a href="#kin_mat_symm_cupy-39"><span class="linenos"> 39</span></a>
</span><span id="kin_mat_symm_cupy-40"><a href="#kin_mat_symm_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="kin_mat_symm_cupy-41"><a href="#kin_mat_symm_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="kin_mat_symm_cupy-42"><a href="#kin_mat_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="kin_mat_symm_cupy-43"><a href="#kin_mat_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="kin_mat_symm_cupy-44"><a href="#kin_mat_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="kin_mat_symm_cupy-45"><a href="#kin_mat_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-46"><a href="#kin_mat_symm_cupy-46"><span class="linenos"> 46</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-47"><a href="#kin_mat_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-48"><a href="#kin_mat_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_cupy-49"><a href="#kin_mat_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="kin_mat_symm_cupy-50"><a href="#kin_mat_symm_cupy-50"><span class="linenos"> 50</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="kin_mat_symm_cupy-51"><a href="#kin_mat_symm_cupy-51"><span class="linenos"> 51</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_cupy-52"><a href="#kin_mat_symm_cupy-52"><span class="linenos"> 52</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_cupy-53"><a href="#kin_mat_symm_cupy-53"><span class="linenos"> 53</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_cupy-54"><a href="#kin_mat_symm_cupy-54"><span class="linenos"> 54</span></a>        
</span><span id="kin_mat_symm_cupy-55"><a href="#kin_mat_symm_cupy-55"><span class="linenos"> 55</span></a>
</span><span id="kin_mat_symm_cupy-56"><a href="#kin_mat_symm_cupy-56"><span class="linenos"> 56</span></a>
</span><span id="kin_mat_symm_cupy-57"><a href="#kin_mat_symm_cupy-57"><span class="linenos"> 57</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-58"><a href="#kin_mat_symm_cupy-58"><span class="linenos"> 58</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="kin_mat_symm_cupy-59"><a href="#kin_mat_symm_cupy-59"><span class="linenos"> 59</span></a>        
</span><span id="kin_mat_symm_cupy-60"><a href="#kin_mat_symm_cupy-60"><span class="linenos"> 60</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="kin_mat_symm_cupy-61"><a href="#kin_mat_symm_cupy-61"><span class="linenos"> 61</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="kin_mat_symm_cupy-62"><a href="#kin_mat_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="kin_mat_symm_cupy-63"><a href="#kin_mat_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="kin_mat_symm_cupy-64"><a href="#kin_mat_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="kin_mat_symm_cupy-65"><a href="#kin_mat_symm_cupy-65"><span class="linenos"> 65</span></a>
</span><span id="kin_mat_symm_cupy-66"><a href="#kin_mat_symm_cupy-66"><span class="linenos"> 66</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="kin_mat_symm_cupy-67"><a href="#kin_mat_symm_cupy-67"><span class="linenos"> 67</span></a>    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> 
</span><span id="kin_mat_symm_cupy-68"><a href="#kin_mat_symm_cupy-68"><span class="linenos"> 68</span></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span> 
</span><span id="kin_mat_symm_cupy-69"><a href="#kin_mat_symm_cupy-69"><span class="linenos"> 69</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="kin_mat_symm_cupy-70"><a href="#kin_mat_symm_cupy-70"><span class="linenos"> 70</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="kin_mat_symm_cupy-71"><a href="#kin_mat_symm_cupy-71"><span class="linenos"> 71</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="kin_mat_symm_cupy-72"><a href="#kin_mat_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="kin_mat_symm_cupy-73"><a href="#kin_mat_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-74"><a href="#kin_mat_symm_cupy-74"><span class="linenos"> 74</span></a>
</span><span id="kin_mat_symm_cupy-75"><a href="#kin_mat_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="kin_mat_symm_cupy-76"><a href="#kin_mat_symm_cupy-76"><span class="linenos"> 76</span></a>    <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="kin_mat_symm_cupy-77"><a href="#kin_mat_symm_cupy-77"><span class="linenos"> 77</span></a>    <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="kin_mat_symm_cupy-78"><a href="#kin_mat_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="kin_mat_symm_cupy-79"><a href="#kin_mat_symm_cupy-79"><span class="linenos"> 79</span></a>    <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="kin_mat_symm_cupy-80"><a href="#kin_mat_symm_cupy-80"><span class="linenos"> 80</span></a>    <span class="k">if</span> <span class="n">end_row</span> <span class="o">&lt;=</span> <span class="n">start_col</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-81"><a href="#kin_mat_symm_cupy-81"><span class="linenos"> 81</span></a>        <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="kin_mat_symm_cupy-82"><a href="#kin_mat_symm_cupy-82"><span class="linenos"> 82</span></a>    <span class="k">elif</span> <span class="n">start_row</span> <span class="o">&gt;=</span> <span class="n">end_col</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-83"><a href="#kin_mat_symm_cupy-83"><span class="linenos"> 83</span></a>        <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="kin_mat_symm_cupy-84"><a href="#kin_mat_symm_cupy-84"><span class="linenos"> 84</span></a>    <span class="k">elif</span> <span class="n">start_row</span><span class="o">==</span><span class="n">start_col</span> <span class="ow">and</span> <span class="n">end_row</span><span class="o">==</span><span class="n">end_col</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-85"><a href="#kin_mat_symm_cupy-85"><span class="linenos"> 85</span></a>        <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="kin_mat_symm_cupy-86"><a href="#kin_mat_symm_cupy-86"><span class="linenos"> 86</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-87"><a href="#kin_mat_symm_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="kin_mat_symm_cupy-88"><a href="#kin_mat_symm_cupy-88"><span class="linenos"> 88</span></a>
</span><span id="kin_mat_symm_cupy-89"><a href="#kin_mat_symm_cupy-89"><span class="linenos"> 89</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="kin_mat_symm_cupy-90"><a href="#kin_mat_symm_cupy-90"><span class="linenos"> 90</span></a>    <span class="n">T</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="kin_mat_symm_cupy-91"><a href="#kin_mat_symm_cupy-91"><span class="linenos"> 91</span></a>
</span><span id="kin_mat_symm_cupy-92"><a href="#kin_mat_symm_cupy-92"><span class="linenos"> 92</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_cupy-93"><a href="#kin_mat_symm_cupy-93"><span class="linenos"> 93</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_cupy-94"><a href="#kin_mat_symm_cupy-94"><span class="linenos"> 94</span></a>
</span><span id="kin_mat_symm_cupy-95"><a href="#kin_mat_symm_cupy-95"><span class="linenos"> 95</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-96"><a href="#kin_mat_symm_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="kin_mat_symm_cupy-97"><a href="#kin_mat_symm_cupy-97"><span class="linenos"> 97</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_cupy-98"><a href="#kin_mat_symm_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-99"><a href="#kin_mat_symm_cupy-99"><span class="linenos"> 99</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-100"><a href="#kin_mat_symm_cupy-100"><span class="linenos">100</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_cupy-101"><a href="#kin_mat_symm_cupy-101"><span class="linenos">101</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-102"><a href="#kin_mat_symm_cupy-102"><span class="linenos">102</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-103"><a href="#kin_mat_symm_cupy-103"><span class="linenos">103</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_cupy-104"><a href="#kin_mat_symm_cupy-104"><span class="linenos">104</span></a>
</span><span id="kin_mat_symm_cupy-105"><a href="#kin_mat_symm_cupy-105"><span class="linenos">105</span></a>
</span><span id="kin_mat_symm_cupy-106"><a href="#kin_mat_symm_cupy-106"><span class="linenos">106</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="kin_mat_symm_cupy-107"><a href="#kin_mat_symm_cupy-107"><span class="linenos">107</span></a>    <span class="n">kin_mat_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">lower_tri</span><span class="p">,</span> <span class="n">upper_tri</span><span class="p">,</span> <span class="n">both_tri_symm</span><span class="p">,</span> <span class="n">both_tri_nonsymm</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-108"><a href="#kin_mat_symm_cupy-108"><span class="linenos">108</span></a>    <span class="k">if</span> <span class="n">both_tri_symm</span><span class="p">:</span>
</span><span id="kin_mat_symm_cupy-109"><a href="#kin_mat_symm_cupy-109"><span class="linenos">109</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
</span><span id="kin_mat_symm_cupy-110"><a href="#kin_mat_symm_cupy-110"><span class="linenos">110</span></a>    
</span><span id="kin_mat_symm_cupy-111"><a href="#kin_mat_symm_cupy-111"><span class="linenos">111</span></a>    <span class="c1"># cuda.synchronize()</span>
</span><span id="kin_mat_symm_cupy-112"><a href="#kin_mat_symm_cupy-112"><span class="linenos">112</span></a>    <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="kin_mat_symm_cupy-113"><a href="#kin_mat_symm_cupy-113"><span class="linenos">113</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="kin_mat_symm_cupy-114"><a href="#kin_mat_symm_cupy-114"><span class="linenos">114</span></a>    <span class="k">return</span> <span class="n">T</span> <span class="c1">#+ T.T - cp.diag(cp.diag(T))</span>
</span></pre></div>


    

                </section>
                <section id="overlap_mat_symm_cupy">
                            <input id="overlap_mat_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">overlap_mat_symm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="overlap_mat_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#overlap_mat_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="overlap_mat_symm_cupy-20"><a href="#overlap_mat_symm_cupy-20"><span class="linenos"> 20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="overlap_mat_symm_cupy-21"><a href="#overlap_mat_symm_cupy-21"><span class="linenos"> 21</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="overlap_mat_symm_cupy-22"><a href="#overlap_mat_symm_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="overlap_mat_symm_cupy-23"><a href="#overlap_mat_symm_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="overlap_mat_symm_cupy-24"><a href="#overlap_mat_symm_cupy-24"><span class="linenos"> 24</span></a>
</span><span id="overlap_mat_symm_cupy-25"><a href="#overlap_mat_symm_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="overlap_mat_symm_cupy-26"><a href="#overlap_mat_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="overlap_mat_symm_cupy-27"><a href="#overlap_mat_symm_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="overlap_mat_symm_cupy-28"><a href="#overlap_mat_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="overlap_mat_symm_cupy-29"><a href="#overlap_mat_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="overlap_mat_symm_cupy-30"><a href="#overlap_mat_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="overlap_mat_symm_cupy-31"><a href="#overlap_mat_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="overlap_mat_symm_cupy-32"><a href="#overlap_mat_symm_cupy-32"><span class="linenos"> 32</span></a>
</span><span id="overlap_mat_symm_cupy-33"><a href="#overlap_mat_symm_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="overlap_mat_symm_cupy-34"><a href="#overlap_mat_symm_cupy-34"><span class="linenos"> 34</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-35"><a href="#overlap_mat_symm_cupy-35"><span class="linenos"> 35</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-36"><a href="#overlap_mat_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-37"><a href="#overlap_mat_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-38"><a href="#overlap_mat_symm_cupy-38"><span class="linenos"> 38</span></a>        
</span><span id="overlap_mat_symm_cupy-39"><a href="#overlap_mat_symm_cupy-39"><span class="linenos"> 39</span></a>
</span><span id="overlap_mat_symm_cupy-40"><a href="#overlap_mat_symm_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="overlap_mat_symm_cupy-41"><a href="#overlap_mat_symm_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="overlap_mat_symm_cupy-42"><a href="#overlap_mat_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="overlap_mat_symm_cupy-43"><a href="#overlap_mat_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="overlap_mat_symm_cupy-44"><a href="#overlap_mat_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="overlap_mat_symm_cupy-45"><a href="#overlap_mat_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-46"><a href="#overlap_mat_symm_cupy-46"><span class="linenos"> 46</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-47"><a href="#overlap_mat_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-48"><a href="#overlap_mat_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_symm_cupy-49"><a href="#overlap_mat_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="overlap_mat_symm_cupy-50"><a href="#overlap_mat_symm_cupy-50"><span class="linenos"> 50</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="overlap_mat_symm_cupy-51"><a href="#overlap_mat_symm_cupy-51"><span class="linenos"> 51</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm_cupy-52"><a href="#overlap_mat_symm_cupy-52"><span class="linenos"> 52</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm_cupy-53"><a href="#overlap_mat_symm_cupy-53"><span class="linenos"> 53</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_symm_cupy-54"><a href="#overlap_mat_symm_cupy-54"><span class="linenos"> 54</span></a>        
</span><span id="overlap_mat_symm_cupy-55"><a href="#overlap_mat_symm_cupy-55"><span class="linenos"> 55</span></a>
</span><span id="overlap_mat_symm_cupy-56"><a href="#overlap_mat_symm_cupy-56"><span class="linenos"> 56</span></a>
</span><span id="overlap_mat_symm_cupy-57"><a href="#overlap_mat_symm_cupy-57"><span class="linenos"> 57</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-58"><a href="#overlap_mat_symm_cupy-58"><span class="linenos"> 58</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="overlap_mat_symm_cupy-59"><a href="#overlap_mat_symm_cupy-59"><span class="linenos"> 59</span></a>        
</span><span id="overlap_mat_symm_cupy-60"><a href="#overlap_mat_symm_cupy-60"><span class="linenos"> 60</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="overlap_mat_symm_cupy-61"><a href="#overlap_mat_symm_cupy-61"><span class="linenos"> 61</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="overlap_mat_symm_cupy-62"><a href="#overlap_mat_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="overlap_mat_symm_cupy-63"><a href="#overlap_mat_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="overlap_mat_symm_cupy-64"><a href="#overlap_mat_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="overlap_mat_symm_cupy-65"><a href="#overlap_mat_symm_cupy-65"><span class="linenos"> 65</span></a>
</span><span id="overlap_mat_symm_cupy-66"><a href="#overlap_mat_symm_cupy-66"><span class="linenos"> 66</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="overlap_mat_symm_cupy-67"><a href="#overlap_mat_symm_cupy-67"><span class="linenos"> 67</span></a>    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> 
</span><span id="overlap_mat_symm_cupy-68"><a href="#overlap_mat_symm_cupy-68"><span class="linenos"> 68</span></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span> 
</span><span id="overlap_mat_symm_cupy-69"><a href="#overlap_mat_symm_cupy-69"><span class="linenos"> 69</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="overlap_mat_symm_cupy-70"><a href="#overlap_mat_symm_cupy-70"><span class="linenos"> 70</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="overlap_mat_symm_cupy-71"><a href="#overlap_mat_symm_cupy-71"><span class="linenos"> 71</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="overlap_mat_symm_cupy-72"><a href="#overlap_mat_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="overlap_mat_symm_cupy-73"><a href="#overlap_mat_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-74"><a href="#overlap_mat_symm_cupy-74"><span class="linenos"> 74</span></a>
</span><span id="overlap_mat_symm_cupy-75"><a href="#overlap_mat_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="overlap_mat_symm_cupy-76"><a href="#overlap_mat_symm_cupy-76"><span class="linenos"> 76</span></a>    <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="overlap_mat_symm_cupy-77"><a href="#overlap_mat_symm_cupy-77"><span class="linenos"> 77</span></a>    <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="overlap_mat_symm_cupy-78"><a href="#overlap_mat_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="overlap_mat_symm_cupy-79"><a href="#overlap_mat_symm_cupy-79"><span class="linenos"> 79</span></a>    <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="overlap_mat_symm_cupy-80"><a href="#overlap_mat_symm_cupy-80"><span class="linenos"> 80</span></a>    <span class="k">if</span> <span class="n">end_row</span> <span class="o">&lt;=</span> <span class="n">start_col</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-81"><a href="#overlap_mat_symm_cupy-81"><span class="linenos"> 81</span></a>        <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="overlap_mat_symm_cupy-82"><a href="#overlap_mat_symm_cupy-82"><span class="linenos"> 82</span></a>    <span class="k">elif</span> <span class="n">start_row</span> <span class="o">&gt;=</span> <span class="n">end_col</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-83"><a href="#overlap_mat_symm_cupy-83"><span class="linenos"> 83</span></a>        <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="overlap_mat_symm_cupy-84"><a href="#overlap_mat_symm_cupy-84"><span class="linenos"> 84</span></a>    <span class="k">elif</span> <span class="n">start_row</span><span class="o">==</span><span class="n">start_col</span> <span class="ow">and</span> <span class="n">end_row</span><span class="o">==</span><span class="n">end_col</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-85"><a href="#overlap_mat_symm_cupy-85"><span class="linenos"> 85</span></a>        <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="overlap_mat_symm_cupy-86"><a href="#overlap_mat_symm_cupy-86"><span class="linenos"> 86</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-87"><a href="#overlap_mat_symm_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="overlap_mat_symm_cupy-88"><a href="#overlap_mat_symm_cupy-88"><span class="linenos"> 88</span></a>
</span><span id="overlap_mat_symm_cupy-89"><a href="#overlap_mat_symm_cupy-89"><span class="linenos"> 89</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="overlap_mat_symm_cupy-90"><a href="#overlap_mat_symm_cupy-90"><span class="linenos"> 90</span></a>    <span class="n">S</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="overlap_mat_symm_cupy-91"><a href="#overlap_mat_symm_cupy-91"><span class="linenos"> 91</span></a>
</span><span id="overlap_mat_symm_cupy-92"><a href="#overlap_mat_symm_cupy-92"><span class="linenos"> 92</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="overlap_mat_symm_cupy-93"><a href="#overlap_mat_symm_cupy-93"><span class="linenos"> 93</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="overlap_mat_symm_cupy-94"><a href="#overlap_mat_symm_cupy-94"><span class="linenos"> 94</span></a>
</span><span id="overlap_mat_symm_cupy-95"><a href="#overlap_mat_symm_cupy-95"><span class="linenos"> 95</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-96"><a href="#overlap_mat_symm_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="overlap_mat_symm_cupy-97"><a href="#overlap_mat_symm_cupy-97"><span class="linenos"> 97</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="overlap_mat_symm_cupy-98"><a href="#overlap_mat_symm_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-99"><a href="#overlap_mat_symm_cupy-99"><span class="linenos"> 99</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-100"><a href="#overlap_mat_symm_cupy-100"><span class="linenos">100</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="overlap_mat_symm_cupy-101"><a href="#overlap_mat_symm_cupy-101"><span class="linenos">101</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-102"><a href="#overlap_mat_symm_cupy-102"><span class="linenos">102</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-103"><a href="#overlap_mat_symm_cupy-103"><span class="linenos">103</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="overlap_mat_symm_cupy-104"><a href="#overlap_mat_symm_cupy-104"><span class="linenos">104</span></a>
</span><span id="overlap_mat_symm_cupy-105"><a href="#overlap_mat_symm_cupy-105"><span class="linenos">105</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="overlap_mat_symm_cupy-106"><a href="#overlap_mat_symm_cupy-106"><span class="linenos">106</span></a>    <span class="n">overlap_mat_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">lower_tri</span><span class="p">,</span> <span class="n">upper_tri</span><span class="p">,</span> <span class="n">both_tri_symm</span><span class="p">,</span> <span class="n">both_tri_nonsymm</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-107"><a href="#overlap_mat_symm_cupy-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="n">both_tri_symm</span><span class="p">:</span>
</span><span id="overlap_mat_symm_cupy-108"><a href="#overlap_mat_symm_cupy-108"><span class="linenos">108</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">S</span><span class="p">)</span>
</span><span id="overlap_mat_symm_cupy-109"><a href="#overlap_mat_symm_cupy-109"><span class="linenos">109</span></a>
</span><span id="overlap_mat_symm_cupy-110"><a href="#overlap_mat_symm_cupy-110"><span class="linenos">110</span></a>    <span class="c1"># cuda.synchronize()</span>
</span><span id="overlap_mat_symm_cupy-111"><a href="#overlap_mat_symm_cupy-111"><span class="linenos">111</span></a>    <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="overlap_mat_symm_cupy-112"><a href="#overlap_mat_symm_cupy-112"><span class="linenos">112</span></a>    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="overlap_mat_symm_cupy-113"><a href="#overlap_mat_symm_cupy-113"><span class="linenos">113</span></a>        <span class="c1"># cp._default_memory_pool.free_all_blocks()</span>
</span><span id="overlap_mat_symm_cupy-114"><a href="#overlap_mat_symm_cupy-114"><span class="linenos">114</span></a>    <span class="k">return</span> <span class="n">S</span> 
</span></pre></div>


    

                </section>
                <section id="dipole_moment_mat_symm_cupy">
                            <input id="dipole_moment_mat_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dipole_moment_mat_symm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">origin</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="dipole_moment_mat_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#dipole_moment_mat_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="dipole_moment_mat_symm_cupy-20"><a href="#dipole_moment_mat_symm_cupy-20"><span class="linenos"> 20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">dipole_moment_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="dipole_moment_mat_symm_cupy-21"><a href="#dipole_moment_mat_symm_cupy-21"><span class="linenos"> 21</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="dipole_moment_mat_symm_cupy-22"><a href="#dipole_moment_mat_symm_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="dipole_moment_mat_symm_cupy-23"><a href="#dipole_moment_mat_symm_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="dipole_moment_mat_symm_cupy-24"><a href="#dipole_moment_mat_symm_cupy-24"><span class="linenos"> 24</span></a>
</span><span id="dipole_moment_mat_symm_cupy-25"><a href="#dipole_moment_mat_symm_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="dipole_moment_mat_symm_cupy-26"><a href="#dipole_moment_mat_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="dipole_moment_mat_symm_cupy-27"><a href="#dipole_moment_mat_symm_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="dipole_moment_mat_symm_cupy-28"><a href="#dipole_moment_mat_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="dipole_moment_mat_symm_cupy-29"><a href="#dipole_moment_mat_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="dipole_moment_mat_symm_cupy-30"><a href="#dipole_moment_mat_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="dipole_moment_mat_symm_cupy-31"><a href="#dipole_moment_mat_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="dipole_moment_mat_symm_cupy-32"><a href="#dipole_moment_mat_symm_cupy-32"><span class="linenos"> 32</span></a>
</span><span id="dipole_moment_mat_symm_cupy-33"><a href="#dipole_moment_mat_symm_cupy-33"><span class="linenos"> 33</span></a>    <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-34"><a href="#dipole_moment_mat_symm_cupy-34"><span class="linenos"> 34</span></a>        <span class="n">origin</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
</span><span id="dipole_moment_mat_symm_cupy-35"><a href="#dipole_moment_mat_symm_cupy-35"><span class="linenos"> 35</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="dipole_moment_mat_symm_cupy-36"><a href="#dipole_moment_mat_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-37"><a href="#dipole_moment_mat_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-38"><a href="#dipole_moment_mat_symm_cupy-38"><span class="linenos"> 38</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-39"><a href="#dipole_moment_mat_symm_cupy-39"><span class="linenos"> 39</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-40"><a href="#dipole_moment_mat_symm_cupy-40"><span class="linenos"> 40</span></a>        
</span><span id="dipole_moment_mat_symm_cupy-41"><a href="#dipole_moment_mat_symm_cupy-41"><span class="linenos"> 41</span></a>
</span><span id="dipole_moment_mat_symm_cupy-42"><a href="#dipole_moment_mat_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="dipole_moment_mat_symm_cupy-43"><a href="#dipole_moment_mat_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="dipole_moment_mat_symm_cupy-44"><a href="#dipole_moment_mat_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="dipole_moment_mat_symm_cupy-45"><a href="#dipole_moment_mat_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="dipole_moment_mat_symm_cupy-46"><a href="#dipole_moment_mat_symm_cupy-46"><span class="linenos"> 46</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="dipole_moment_mat_symm_cupy-47"><a href="#dipole_moment_mat_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-48"><a href="#dipole_moment_mat_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-49"><a href="#dipole_moment_mat_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-50"><a href="#dipole_moment_mat_symm_cupy-50"><span class="linenos"> 50</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="dipole_moment_mat_symm_cupy-51"><a href="#dipole_moment_mat_symm_cupy-51"><span class="linenos"> 51</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="dipole_moment_mat_symm_cupy-52"><a href="#dipole_moment_mat_symm_cupy-52"><span class="linenos"> 52</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="dipole_moment_mat_symm_cupy-53"><a href="#dipole_moment_mat_symm_cupy-53"><span class="linenos"> 53</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm_cupy-54"><a href="#dipole_moment_mat_symm_cupy-54"><span class="linenos"> 54</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm_cupy-55"><a href="#dipole_moment_mat_symm_cupy-55"><span class="linenos"> 55</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm_cupy-56"><a href="#dipole_moment_mat_symm_cupy-56"><span class="linenos"> 56</span></a>        
</span><span id="dipole_moment_mat_symm_cupy-57"><a href="#dipole_moment_mat_symm_cupy-57"><span class="linenos"> 57</span></a>
</span><span id="dipole_moment_mat_symm_cupy-58"><a href="#dipole_moment_mat_symm_cupy-58"><span class="linenos"> 58</span></a>
</span><span id="dipole_moment_mat_symm_cupy-59"><a href="#dipole_moment_mat_symm_cupy-59"><span class="linenos"> 59</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-60"><a href="#dipole_moment_mat_symm_cupy-60"><span class="linenos"> 60</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="dipole_moment_mat_symm_cupy-61"><a href="#dipole_moment_mat_symm_cupy-61"><span class="linenos"> 61</span></a>        
</span><span id="dipole_moment_mat_symm_cupy-62"><a href="#dipole_moment_mat_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="dipole_moment_mat_symm_cupy-63"><a href="#dipole_moment_mat_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="dipole_moment_mat_symm_cupy-64"><a href="#dipole_moment_mat_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="dipole_moment_mat_symm_cupy-65"><a href="#dipole_moment_mat_symm_cupy-65"><span class="linenos"> 65</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="dipole_moment_mat_symm_cupy-66"><a href="#dipole_moment_mat_symm_cupy-66"><span class="linenos"> 66</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="dipole_moment_mat_symm_cupy-67"><a href="#dipole_moment_mat_symm_cupy-67"><span class="linenos"> 67</span></a>
</span><span id="dipole_moment_mat_symm_cupy-68"><a href="#dipole_moment_mat_symm_cupy-68"><span class="linenos"> 68</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="dipole_moment_mat_symm_cupy-69"><a href="#dipole_moment_mat_symm_cupy-69"><span class="linenos"> 69</span></a>    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> 
</span><span id="dipole_moment_mat_symm_cupy-70"><a href="#dipole_moment_mat_symm_cupy-70"><span class="linenos"> 70</span></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span> 
</span><span id="dipole_moment_mat_symm_cupy-71"><a href="#dipole_moment_mat_symm_cupy-71"><span class="linenos"> 71</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="dipole_moment_mat_symm_cupy-72"><a href="#dipole_moment_mat_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="dipole_moment_mat_symm_cupy-73"><a href="#dipole_moment_mat_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="dipole_moment_mat_symm_cupy-74"><a href="#dipole_moment_mat_symm_cupy-74"><span class="linenos"> 74</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="dipole_moment_mat_symm_cupy-75"><a href="#dipole_moment_mat_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-76"><a href="#dipole_moment_mat_symm_cupy-76"><span class="linenos"> 76</span></a>
</span><span id="dipole_moment_mat_symm_cupy-77"><a href="#dipole_moment_mat_symm_cupy-77"><span class="linenos"> 77</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="dipole_moment_mat_symm_cupy-78"><a href="#dipole_moment_mat_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="dipole_moment_mat_symm_cupy-79"><a href="#dipole_moment_mat_symm_cupy-79"><span class="linenos"> 79</span></a>    <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="dipole_moment_mat_symm_cupy-80"><a href="#dipole_moment_mat_symm_cupy-80"><span class="linenos"> 80</span></a>    <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="dipole_moment_mat_symm_cupy-81"><a href="#dipole_moment_mat_symm_cupy-81"><span class="linenos"> 81</span></a>    <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="dipole_moment_mat_symm_cupy-82"><a href="#dipole_moment_mat_symm_cupy-82"><span class="linenos"> 82</span></a>    <span class="k">if</span> <span class="n">end_row</span> <span class="o">&lt;=</span> <span class="n">start_col</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-83"><a href="#dipole_moment_mat_symm_cupy-83"><span class="linenos"> 83</span></a>        <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="dipole_moment_mat_symm_cupy-84"><a href="#dipole_moment_mat_symm_cupy-84"><span class="linenos"> 84</span></a>    <span class="k">elif</span> <span class="n">start_row</span> <span class="o">&gt;=</span> <span class="n">end_col</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-85"><a href="#dipole_moment_mat_symm_cupy-85"><span class="linenos"> 85</span></a>        <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="dipole_moment_mat_symm_cupy-86"><a href="#dipole_moment_mat_symm_cupy-86"><span class="linenos"> 86</span></a>    <span class="k">elif</span> <span class="n">start_row</span><span class="o">==</span><span class="n">start_col</span> <span class="ow">and</span> <span class="n">end_row</span><span class="o">==</span><span class="n">end_col</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-87"><a href="#dipole_moment_mat_symm_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="dipole_moment_mat_symm_cupy-88"><a href="#dipole_moment_mat_symm_cupy-88"><span class="linenos"> 88</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-89"><a href="#dipole_moment_mat_symm_cupy-89"><span class="linenos"> 89</span></a>        <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="dipole_moment_mat_symm_cupy-90"><a href="#dipole_moment_mat_symm_cupy-90"><span class="linenos"> 90</span></a>
</span><span id="dipole_moment_mat_symm_cupy-91"><a href="#dipole_moment_mat_symm_cupy-91"><span class="linenos"> 91</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="dipole_moment_mat_symm_cupy-92"><a href="#dipole_moment_mat_symm_cupy-92"><span class="linenos"> 92</span></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="dipole_moment_mat_symm_cupy-93"><a href="#dipole_moment_mat_symm_cupy-93"><span class="linenos"> 93</span></a>
</span><span id="dipole_moment_mat_symm_cupy-94"><a href="#dipole_moment_mat_symm_cupy-94"><span class="linenos"> 94</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="dipole_moment_mat_symm_cupy-95"><a href="#dipole_moment_mat_symm_cupy-95"><span class="linenos"> 95</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="dipole_moment_mat_symm_cupy-96"><a href="#dipole_moment_mat_symm_cupy-96"><span class="linenos"> 96</span></a>
</span><span id="dipole_moment_mat_symm_cupy-97"><a href="#dipole_moment_mat_symm_cupy-97"><span class="linenos"> 97</span></a>    <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-98"><a href="#dipole_moment_mat_symm_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="dipole_moment_mat_symm_cupy-99"><a href="#dipole_moment_mat_symm_cupy-99"><span class="linenos"> 99</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="dipole_moment_mat_symm_cupy-100"><a href="#dipole_moment_mat_symm_cupy-100"><span class="linenos">100</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-101"><a href="#dipole_moment_mat_symm_cupy-101"><span class="linenos">101</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-102"><a href="#dipole_moment_mat_symm_cupy-102"><span class="linenos">102</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-103"><a href="#dipole_moment_mat_symm_cupy-103"><span class="linenos">103</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">stream</span>
</span><span id="dipole_moment_mat_symm_cupy-104"><a href="#dipole_moment_mat_symm_cupy-104"><span class="linenos">104</span></a>
</span><span id="dipole_moment_mat_symm_cupy-105"><a href="#dipole_moment_mat_symm_cupy-105"><span class="linenos">105</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="dipole_moment_mat_symm_cupy-106"><a href="#dipole_moment_mat_symm_cupy-106"><span class="linenos">106</span></a>    <span class="n">dipole_moment_mat_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">lower_tri</span><span class="p">,</span> <span class="n">upper_tri</span><span class="p">,</span> <span class="n">both_tri_symm</span><span class="p">,</span> <span class="n">both_tri_nonsymm</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-107"><a href="#dipole_moment_mat_symm_cupy-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="n">both_tri_symm</span><span class="p">:</span>
</span><span id="dipole_moment_mat_symm_cupy-108"><a href="#dipole_moment_mat_symm_cupy-108"><span class="linenos">108</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
</span><span id="dipole_moment_mat_symm_cupy-109"><a href="#dipole_moment_mat_symm_cupy-109"><span class="linenos">109</span></a>    <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="dipole_moment_mat_symm_cupy-110"><a href="#dipole_moment_mat_symm_cupy-110"><span class="linenos">110</span></a>    <span class="k">return</span> <span class="n">M</span> 
</span></pre></div>


    

                </section>
                <section id="nuc_mat_symm_cupy">
                            <input id="nuc_mat_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nuc_mat_symm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">mol</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nuc_mat_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nuc_mat_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nuc_mat_symm_cupy-20"><a href="#nuc_mat_symm_cupy-20"><span class="linenos"> 20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nuc_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="nuc_mat_symm_cupy-21"><a href="#nuc_mat_symm_cupy-21"><span class="linenos"> 21</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="nuc_mat_symm_cupy-22"><a href="#nuc_mat_symm_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="nuc_mat_symm_cupy-23"><a href="#nuc_mat_symm_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="nuc_mat_symm_cupy-24"><a href="#nuc_mat_symm_cupy-24"><span class="linenos"> 24</span></a>
</span><span id="nuc_mat_symm_cupy-25"><a href="#nuc_mat_symm_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="nuc_mat_symm_cupy-26"><a href="#nuc_mat_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="nuc_mat_symm_cupy-27"><a href="#nuc_mat_symm_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="nuc_mat_symm_cupy-28"><a href="#nuc_mat_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="nuc_mat_symm_cupy-29"><a href="#nuc_mat_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="nuc_mat_symm_cupy-30"><a href="#nuc_mat_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="nuc_mat_symm_cupy-31"><a href="#nuc_mat_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="nuc_mat_symm_cupy-32"><a href="#nuc_mat_symm_cupy-32"><span class="linenos"> 32</span></a>
</span><span id="nuc_mat_symm_cupy-33"><a href="#nuc_mat_symm_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="nuc_mat_symm_cupy-34"><a href="#nuc_mat_symm_cupy-34"><span class="linenos"> 34</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-35"><a href="#nuc_mat_symm_cupy-35"><span class="linenos"> 35</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-36"><a href="#nuc_mat_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-37"><a href="#nuc_mat_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-38"><a href="#nuc_mat_symm_cupy-38"><span class="linenos"> 38</span></a>    <span class="n">coordsBohrs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-39"><a href="#nuc_mat_symm_cupy-39"><span class="linenos"> 39</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-40"><a href="#nuc_mat_symm_cupy-40"><span class="linenos"> 40</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span>
</span><span id="nuc_mat_symm_cupy-41"><a href="#nuc_mat_symm_cupy-41"><span class="linenos"> 41</span></a>
</span><span id="nuc_mat_symm_cupy-42"><a href="#nuc_mat_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="nuc_mat_symm_cupy-43"><a href="#nuc_mat_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="nuc_mat_symm_cupy-44"><a href="#nuc_mat_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="nuc_mat_symm_cupy-45"><a href="#nuc_mat_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="nuc_mat_symm_cupy-46"><a href="#nuc_mat_symm_cupy-46"><span class="linenos"> 46</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="nuc_mat_symm_cupy-47"><a href="#nuc_mat_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-48"><a href="#nuc_mat_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-49"><a href="#nuc_mat_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-50"><a href="#nuc_mat_symm_cupy-50"><span class="linenos"> 50</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_symm_cupy-51"><a href="#nuc_mat_symm_cupy-51"><span class="linenos"> 51</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="nuc_mat_symm_cupy-52"><a href="#nuc_mat_symm_cupy-52"><span class="linenos"> 52</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="nuc_mat_symm_cupy-53"><a href="#nuc_mat_symm_cupy-53"><span class="linenos"> 53</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm_cupy-54"><a href="#nuc_mat_symm_cupy-54"><span class="linenos"> 54</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm_cupy-55"><a href="#nuc_mat_symm_cupy-55"><span class="linenos"> 55</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_symm_cupy-56"><a href="#nuc_mat_symm_cupy-56"><span class="linenos"> 56</span></a>        
</span><span id="nuc_mat_symm_cupy-57"><a href="#nuc_mat_symm_cupy-57"><span class="linenos"> 57</span></a>
</span><span id="nuc_mat_symm_cupy-58"><a href="#nuc_mat_symm_cupy-58"><span class="linenos"> 58</span></a>
</span><span id="nuc_mat_symm_cupy-59"><a href="#nuc_mat_symm_cupy-59"><span class="linenos"> 59</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-60"><a href="#nuc_mat_symm_cupy-60"><span class="linenos"> 60</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="nuc_mat_symm_cupy-61"><a href="#nuc_mat_symm_cupy-61"><span class="linenos"> 61</span></a>        
</span><span id="nuc_mat_symm_cupy-62"><a href="#nuc_mat_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="nuc_mat_symm_cupy-63"><a href="#nuc_mat_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="nuc_mat_symm_cupy-64"><a href="#nuc_mat_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="nuc_mat_symm_cupy-65"><a href="#nuc_mat_symm_cupy-65"><span class="linenos"> 65</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="nuc_mat_symm_cupy-66"><a href="#nuc_mat_symm_cupy-66"><span class="linenos"> 66</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="nuc_mat_symm_cupy-67"><a href="#nuc_mat_symm_cupy-67"><span class="linenos"> 67</span></a>
</span><span id="nuc_mat_symm_cupy-68"><a href="#nuc_mat_symm_cupy-68"><span class="linenos"> 68</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="nuc_mat_symm_cupy-69"><a href="#nuc_mat_symm_cupy-69"><span class="linenos"> 69</span></a>    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> 
</span><span id="nuc_mat_symm_cupy-70"><a href="#nuc_mat_symm_cupy-70"><span class="linenos"> 70</span></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span> 
</span><span id="nuc_mat_symm_cupy-71"><a href="#nuc_mat_symm_cupy-71"><span class="linenos"> 71</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="nuc_mat_symm_cupy-72"><a href="#nuc_mat_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="nuc_mat_symm_cupy-73"><a href="#nuc_mat_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="nuc_mat_symm_cupy-74"><a href="#nuc_mat_symm_cupy-74"><span class="linenos"> 74</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="nuc_mat_symm_cupy-75"><a href="#nuc_mat_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-76"><a href="#nuc_mat_symm_cupy-76"><span class="linenos"> 76</span></a>
</span><span id="nuc_mat_symm_cupy-77"><a href="#nuc_mat_symm_cupy-77"><span class="linenos"> 77</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="nuc_mat_symm_cupy-78"><a href="#nuc_mat_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm_cupy-79"><a href="#nuc_mat_symm_cupy-79"><span class="linenos"> 79</span></a>    <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm_cupy-80"><a href="#nuc_mat_symm_cupy-80"><span class="linenos"> 80</span></a>    <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm_cupy-81"><a href="#nuc_mat_symm_cupy-81"><span class="linenos"> 81</span></a>    <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm_cupy-82"><a href="#nuc_mat_symm_cupy-82"><span class="linenos"> 82</span></a>    <span class="k">if</span> <span class="n">end_row</span> <span class="o">&lt;=</span> <span class="n">start_col</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-83"><a href="#nuc_mat_symm_cupy-83"><span class="linenos"> 83</span></a>        <span class="n">upper_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm_cupy-84"><a href="#nuc_mat_symm_cupy-84"><span class="linenos"> 84</span></a>    <span class="k">elif</span> <span class="n">start_row</span> <span class="o">&gt;=</span> <span class="n">end_col</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-85"><a href="#nuc_mat_symm_cupy-85"><span class="linenos"> 85</span></a>        <span class="n">lower_tri</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm_cupy-86"><a href="#nuc_mat_symm_cupy-86"><span class="linenos"> 86</span></a>    <span class="k">elif</span> <span class="n">start_row</span><span class="o">==</span><span class="n">start_col</span> <span class="ow">and</span> <span class="n">end_row</span><span class="o">==</span><span class="n">end_col</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-87"><a href="#nuc_mat_symm_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">both_tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm_cupy-88"><a href="#nuc_mat_symm_cupy-88"><span class="linenos"> 88</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-89"><a href="#nuc_mat_symm_cupy-89"><span class="linenos"> 89</span></a>        <span class="n">both_tri_nonsymm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm_cupy-90"><a href="#nuc_mat_symm_cupy-90"><span class="linenos"> 90</span></a>
</span><span id="nuc_mat_symm_cupy-91"><a href="#nuc_mat_symm_cupy-91"><span class="linenos"> 91</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="nuc_mat_symm_cupy-92"><a href="#nuc_mat_symm_cupy-92"><span class="linenos"> 92</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="nuc_mat_symm_cupy-93"><a href="#nuc_mat_symm_cupy-93"><span class="linenos"> 93</span></a>
</span><span id="nuc_mat_symm_cupy-94"><a href="#nuc_mat_symm_cupy-94"><span class="linenos"> 94</span></a>    <span class="k">if</span> <span class="n">sqrt_ints4c2e_diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-95"><a href="#nuc_mat_symm_cupy-95"><span class="linenos"> 95</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="nuc_mat_symm_cupy-96"><a href="#nuc_mat_symm_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-97"><a href="#nuc_mat_symm_cupy-97"><span class="linenos"> 97</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_symm_cupy-98"><a href="#nuc_mat_symm_cupy-98"><span class="linenos"> 98</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-99"><a href="#nuc_mat_symm_cupy-99"><span class="linenos"> 99</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_symm_cupy-100"><a href="#nuc_mat_symm_cupy-100"><span class="linenos">100</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sqrt_ints4c2e_diag</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-101"><a href="#nuc_mat_symm_cupy-101"><span class="linenos">101</span></a>
</span><span id="nuc_mat_symm_cupy-102"><a href="#nuc_mat_symm_cupy-102"><span class="linenos">102</span></a>    
</span><span id="nuc_mat_symm_cupy-103"><a href="#nuc_mat_symm_cupy-103"><span class="linenos">103</span></a>
</span><span id="nuc_mat_symm_cupy-104"><a href="#nuc_mat_symm_cupy-104"><span class="linenos">104</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-105"><a href="#nuc_mat_symm_cupy-105"><span class="linenos">105</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="nuc_mat_symm_cupy-106"><a href="#nuc_mat_symm_cupy-106"><span class="linenos">106</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-107"><a href="#nuc_mat_symm_cupy-107"><span class="linenos">107</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-108"><a href="#nuc_mat_symm_cupy-108"><span class="linenos">108</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-109"><a href="#nuc_mat_symm_cupy-109"><span class="linenos">109</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-110"><a href="#nuc_mat_symm_cupy-110"><span class="linenos">110</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-111"><a href="#nuc_mat_symm_cupy-111"><span class="linenos">111</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-112"><a href="#nuc_mat_symm_cupy-112"><span class="linenos">112</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-113"><a href="#nuc_mat_symm_cupy-113"><span class="linenos">113</span></a>
</span><span id="nuc_mat_symm_cupy-114"><a href="#nuc_mat_symm_cupy-114"><span class="linenos">114</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="nuc_mat_symm_cupy-115"><a href="#nuc_mat_symm_cupy-115"><span class="linenos">115</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="nuc_mat_symm_cupy-116"><a href="#nuc_mat_symm_cupy-116"><span class="linenos">116</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="nuc_mat_symm_cupy-117"><a href="#nuc_mat_symm_cupy-117"><span class="linenos">117</span></a>    <span class="n">nuc_mat_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordsBohrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">lower_tri</span><span class="p">,</span> <span class="n">upper_tri</span><span class="p">,</span> <span class="n">both_tri_symm</span><span class="p">,</span> <span class="n">both_tri_nonsymm</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">isSchwarz</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-118"><a href="#nuc_mat_symm_cupy-118"><span class="linenos">118</span></a>    <span class="k">if</span> <span class="n">both_tri_symm</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-119"><a href="#nuc_mat_symm_cupy-119"><span class="linenos">119</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="nuc_mat_symm_cupy-120"><a href="#nuc_mat_symm_cupy-120"><span class="linenos">120</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="nuc_mat_symm_cupy-121"><a href="#nuc_mat_symm_cupy-121"><span class="linenos">121</span></a>        <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="nuc_mat_symm_cupy-122"><a href="#nuc_mat_symm_cupy-122"><span class="linenos">122</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
</span><span id="nuc_mat_symm_cupy-123"><a href="#nuc_mat_symm_cupy-123"><span class="linenos">123</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-124"><a href="#nuc_mat_symm_cupy-124"><span class="linenos">124</span></a>        <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-125"><a href="#nuc_mat_symm_cupy-125"><span class="linenos">125</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_symm_cupy-126"><a href="#nuc_mat_symm_cupy-126"><span class="linenos">126</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-127"><a href="#nuc_mat_symm_cupy-127"><span class="linenos">127</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="nuc_mat_symm_cupy-128"><a href="#nuc_mat_symm_cupy-128"><span class="linenos">128</span></a>        <span class="c1"># cp._default_memory_pool.free_all_blocks()</span>
</span><span id="nuc_mat_symm_cupy-129"><a href="#nuc_mat_symm_cupy-129"><span class="linenos">129</span></a>    <span class="k">return</span> <span class="n">V</span>
</span></pre></div>


    

                </section>
                <section id="kin_mat_symm_shell_cupy">
                            <input id="kin_mat_symm_shell_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kin_mat_symm_shell_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="kin_mat_symm_shell_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#kin_mat_symm_shell_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="kin_mat_symm_shell_cupy-20"><a href="#kin_mat_symm_shell_cupy-20"><span class="linenos">20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">kin_mat_symm_shell_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="kin_mat_symm_shell_cupy-21"><a href="#kin_mat_symm_shell_cupy-21"><span class="linenos">21</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="kin_mat_symm_shell_cupy-22"><a href="#kin_mat_symm_shell_cupy-22"><span class="linenos">22</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="kin_mat_symm_shell_cupy-23"><a href="#kin_mat_symm_shell_cupy-23"><span class="linenos">23</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="kin_mat_symm_shell_cupy-24"><a href="#kin_mat_symm_shell_cupy-24"><span class="linenos">24</span></a>
</span><span id="kin_mat_symm_shell_cupy-25"><a href="#kin_mat_symm_shell_cupy-25"><span class="linenos">25</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="kin_mat_symm_shell_cupy-26"><a href="#kin_mat_symm_shell_cupy-26"><span class="linenos">26</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="kin_mat_symm_shell_cupy-27"><a href="#kin_mat_symm_shell_cupy-27"><span class="linenos">27</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="kin_mat_symm_shell_cupy-28"><a href="#kin_mat_symm_shell_cupy-28"><span class="linenos">28</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="kin_mat_symm_shell_cupy-29"><a href="#kin_mat_symm_shell_cupy-29"><span class="linenos">29</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="kin_mat_symm_shell_cupy-30"><a href="#kin_mat_symm_shell_cupy-30"><span class="linenos">30</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="kin_mat_symm_shell_cupy-31"><a href="#kin_mat_symm_shell_cupy-31"><span class="linenos">31</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="kin_mat_symm_shell_cupy-32"><a href="#kin_mat_symm_shell_cupy-32"><span class="linenos">32</span></a>
</span><span id="kin_mat_symm_shell_cupy-33"><a href="#kin_mat_symm_shell_cupy-33"><span class="linenos">33</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="kin_mat_symm_shell_cupy-34"><a href="#kin_mat_symm_shell_cupy-34"><span class="linenos">34</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-35"><a href="#kin_mat_symm_shell_cupy-35"><span class="linenos">35</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-36"><a href="#kin_mat_symm_shell_cupy-36"><span class="linenos">36</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-37"><a href="#kin_mat_symm_shell_cupy-37"><span class="linenos">37</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-38"><a href="#kin_mat_symm_shell_cupy-38"><span class="linenos">38</span></a>    <span class="n">bfs_offset</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">shell_bfs_offset</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-39"><a href="#kin_mat_symm_shell_cupy-39"><span class="linenos">39</span></a>    <span class="n">bfs_nbfshell</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nbfshell</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-40"><a href="#kin_mat_symm_shell_cupy-40"><span class="linenos">40</span></a>        
</span><span id="kin_mat_symm_shell_cupy-41"><a href="#kin_mat_symm_shell_cupy-41"><span class="linenos">41</span></a>
</span><span id="kin_mat_symm_shell_cupy-42"><a href="#kin_mat_symm_shell_cupy-42"><span class="linenos">42</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="kin_mat_symm_shell_cupy-43"><a href="#kin_mat_symm_shell_cupy-43"><span class="linenos">43</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="kin_mat_symm_shell_cupy-44"><a href="#kin_mat_symm_shell_cupy-44"><span class="linenos">44</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="kin_mat_symm_shell_cupy-45"><a href="#kin_mat_symm_shell_cupy-45"><span class="linenos">45</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="kin_mat_symm_shell_cupy-46"><a href="#kin_mat_symm_shell_cupy-46"><span class="linenos">46</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="kin_mat_symm_shell_cupy-47"><a href="#kin_mat_symm_shell_cupy-47"><span class="linenos">47</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-48"><a href="#kin_mat_symm_shell_cupy-48"><span class="linenos">48</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-49"><a href="#kin_mat_symm_shell_cupy-49"><span class="linenos">49</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-50"><a href="#kin_mat_symm_shell_cupy-50"><span class="linenos">50</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_symm_shell_cupy-51"><a href="#kin_mat_symm_shell_cupy-51"><span class="linenos">51</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="kin_mat_symm_shell_cupy-52"><a href="#kin_mat_symm_shell_cupy-52"><span class="linenos">52</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="kin_mat_symm_shell_cupy-53"><a href="#kin_mat_symm_shell_cupy-53"><span class="linenos">53</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_shell_cupy-54"><a href="#kin_mat_symm_shell_cupy-54"><span class="linenos">54</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_shell_cupy-55"><a href="#kin_mat_symm_shell_cupy-55"><span class="linenos">55</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_symm_shell_cupy-56"><a href="#kin_mat_symm_shell_cupy-56"><span class="linenos">56</span></a>        
</span><span id="kin_mat_symm_shell_cupy-57"><a href="#kin_mat_symm_shell_cupy-57"><span class="linenos">57</span></a>
</span><span id="kin_mat_symm_shell_cupy-58"><a href="#kin_mat_symm_shell_cupy-58"><span class="linenos">58</span></a>
</span><span id="kin_mat_symm_shell_cupy-59"><a href="#kin_mat_symm_shell_cupy-59"><span class="linenos">59</span></a>    
</span><span id="kin_mat_symm_shell_cupy-60"><a href="#kin_mat_symm_shell_cupy-60"><span class="linenos">60</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-61"><a href="#kin_mat_symm_shell_cupy-61"><span class="linenos">61</span></a>
</span><span id="kin_mat_symm_shell_cupy-62"><a href="#kin_mat_symm_shell_cupy-62"><span class="linenos">62</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="kin_mat_symm_shell_cupy-63"><a href="#kin_mat_symm_shell_cupy-63"><span class="linenos">63</span></a>    <span class="n">T</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="kin_mat_symm_shell_cupy-64"><a href="#kin_mat_symm_shell_cupy-64"><span class="linenos">64</span></a>
</span><span id="kin_mat_symm_shell_cupy-65"><a href="#kin_mat_symm_shell_cupy-65"><span class="linenos">65</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_shell_cupy-66"><a href="#kin_mat_symm_shell_cupy-66"><span class="linenos">66</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_shell_cupy-67"><a href="#kin_mat_symm_shell_cupy-67"><span class="linenos">67</span></a>
</span><span id="kin_mat_symm_shell_cupy-68"><a href="#kin_mat_symm_shell_cupy-68"><span class="linenos">68</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_symm_shell_cupy-69"><a href="#kin_mat_symm_shell_cupy-69"><span class="linenos">69</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="kin_mat_symm_shell_cupy-70"><a href="#kin_mat_symm_shell_cupy-70"><span class="linenos">70</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-71"><a href="#kin_mat_symm_shell_cupy-71"><span class="linenos">71</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-72"><a href="#kin_mat_symm_shell_cupy-72"><span class="linenos">72</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-73"><a href="#kin_mat_symm_shell_cupy-73"><span class="linenos">73</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-74"><a href="#kin_mat_symm_shell_cupy-74"><span class="linenos">74</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="kin_mat_symm_shell_cupy-75"><a href="#kin_mat_symm_shell_cupy-75"><span class="linenos">75</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-76"><a href="#kin_mat_symm_shell_cupy-76"><span class="linenos">76</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-77"><a href="#kin_mat_symm_shell_cupy-77"><span class="linenos">77</span></a>
</span><span id="kin_mat_symm_shell_cupy-78"><a href="#kin_mat_symm_shell_cupy-78"><span class="linenos">78</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_shell_cupy-79"><a href="#kin_mat_symm_shell_cupy-79"><span class="linenos">79</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="kin_mat_symm_shell_cupy-80"><a href="#kin_mat_symm_shell_cupy-80"><span class="linenos">80</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">nshells</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">nshells</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="kin_mat_symm_shell_cupy-81"><a href="#kin_mat_symm_shell_cupy-81"><span class="linenos">81</span></a>    <span class="n">kin_mat_symm_shell_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nbfshell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">nshells</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-82"><a href="#kin_mat_symm_shell_cupy-82"><span class="linenos">82</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="kin_mat_symm_shell_cupy-83"><a href="#kin_mat_symm_shell_cupy-83"><span class="linenos">83</span></a>    <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
</span><span id="kin_mat_symm_shell_cupy-84"><a href="#kin_mat_symm_shell_cupy-84"><span class="linenos">84</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_symm_shell_cupy-85"><a href="#kin_mat_symm_shell_cupy-85"><span class="linenos">85</span></a>        <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-86"><a href="#kin_mat_symm_shell_cupy-86"><span class="linenos">86</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="kin_mat_symm_shell_cupy-87"><a href="#kin_mat_symm_shell_cupy-87"><span class="linenos">87</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-88"><a href="#kin_mat_symm_shell_cupy-88"><span class="linenos">88</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="kin_mat_symm_shell_cupy-89"><a href="#kin_mat_symm_shell_cupy-89"><span class="linenos">89</span></a>    <span class="k">return</span> <span class="n">T</span> <span class="c1">#+ T.T - cp.diag(cp.diag(T))</span>
</span></pre></div>


    

                </section>
                <section id="rys_2c2e_symm_cupy">
                            <input id="rys_2c2e_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_2c2e_symm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_2c2e_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_2c2e_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_2c2e_symm_cupy-21"><a href="#rys_2c2e_symm_cupy-21"><span class="linenos"> 21</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_2c2e_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_2c2e_symm_cupy-22"><a href="#rys_2c2e_symm_cupy-22"><span class="linenos"> 22</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_2c2e_symm_cupy-23"><a href="#rys_2c2e_symm_cupy-23"><span class="linenos"> 23</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_2c2e_symm_cupy-24"><a href="#rys_2c2e_symm_cupy-24"><span class="linenos"> 24</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="rys_2c2e_symm_cupy-25"><a href="#rys_2c2e_symm_cupy-25"><span class="linenos"> 25</span></a>
</span><span id="rys_2c2e_symm_cupy-26"><a href="#rys_2c2e_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="rys_2c2e_symm_cupy-27"><a href="#rys_2c2e_symm_cupy-27"><span class="linenos"> 27</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_2c2e_symm_cupy-28"><a href="#rys_2c2e_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="rys_2c2e_symm_cupy-29"><a href="#rys_2c2e_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="rys_2c2e_symm_cupy-30"><a href="#rys_2c2e_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="rys_2c2e_symm_cupy-31"><a href="#rys_2c2e_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="rys_2c2e_symm_cupy-32"><a href="#rys_2c2e_symm_cupy-32"><span class="linenos"> 32</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="rys_2c2e_symm_cupy-33"><a href="#rys_2c2e_symm_cupy-33"><span class="linenos"> 33</span></a>
</span><span id="rys_2c2e_symm_cupy-34"><a href="#rys_2c2e_symm_cupy-34"><span class="linenos"> 34</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_2c2e_symm_cupy-35"><a href="#rys_2c2e_symm_cupy-35"><span class="linenos"> 35</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-36"><a href="#rys_2c2e_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-37"><a href="#rys_2c2e_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-38"><a href="#rys_2c2e_symm_cupy-38"><span class="linenos"> 38</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-39"><a href="#rys_2c2e_symm_cupy-39"><span class="linenos"> 39</span></a>
</span><span id="rys_2c2e_symm_cupy-40"><a href="#rys_2c2e_symm_cupy-40"><span class="linenos"> 40</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_2c2e_symm_cupy-41"><a href="#rys_2c2e_symm_cupy-41"><span class="linenos"> 41</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_2c2e_symm_cupy-42"><a href="#rys_2c2e_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_2c2e_symm_cupy-43"><a href="#rys_2c2e_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_2c2e_symm_cupy-44"><a href="#rys_2c2e_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_2c2e_symm_cupy-45"><a href="#rys_2c2e_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-46"><a href="#rys_2c2e_symm_cupy-46"><span class="linenos"> 46</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-47"><a href="#rys_2c2e_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-48"><a href="#rys_2c2e_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_2c2e_symm_cupy-49"><a href="#rys_2c2e_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_2c2e_symm_cupy-50"><a href="#rys_2c2e_symm_cupy-50"><span class="linenos"> 50</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_2c2e_symm_cupy-51"><a href="#rys_2c2e_symm_cupy-51"><span class="linenos"> 51</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm_cupy-52"><a href="#rys_2c2e_symm_cupy-52"><span class="linenos"> 52</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm_cupy-53"><a href="#rys_2c2e_symm_cupy-53"><span class="linenos"> 53</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_2c2e_symm_cupy-54"><a href="#rys_2c2e_symm_cupy-54"><span class="linenos"> 54</span></a>        
</span><span id="rys_2c2e_symm_cupy-55"><a href="#rys_2c2e_symm_cupy-55"><span class="linenos"> 55</span></a>
</span><span id="rys_2c2e_symm_cupy-56"><a href="#rys_2c2e_symm_cupy-56"><span class="linenos"> 56</span></a>    <span class="n">DATA_X_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_X</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-57"><a href="#rys_2c2e_symm_cupy-57"><span class="linenos"> 57</span></a>    <span class="n">DATA_W_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_W</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-58"><a href="#rys_2c2e_symm_cupy-58"><span class="linenos"> 58</span></a>
</span><span id="rys_2c2e_symm_cupy-59"><a href="#rys_2c2e_symm_cupy-59"><span class="linenos"> 59</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-60"><a href="#rys_2c2e_symm_cupy-60"><span class="linenos"> 60</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_2c2e_symm_cupy-61"><a href="#rys_2c2e_symm_cupy-61"><span class="linenos"> 61</span></a>        
</span><span id="rys_2c2e_symm_cupy-62"><a href="#rys_2c2e_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="rys_2c2e_symm_cupy-63"><a href="#rys_2c2e_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="rys_2c2e_symm_cupy-64"><a href="#rys_2c2e_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="rys_2c2e_symm_cupy-65"><a href="#rys_2c2e_symm_cupy-65"><span class="linenos"> 65</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="rys_2c2e_symm_cupy-66"><a href="#rys_2c2e_symm_cupy-66"><span class="linenos"> 66</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="rys_2c2e_symm_cupy-67"><a href="#rys_2c2e_symm_cupy-67"><span class="linenos"> 67</span></a>
</span><span id="rys_2c2e_symm_cupy-68"><a href="#rys_2c2e_symm_cupy-68"><span class="linenos"> 68</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="rys_2c2e_symm_cupy-69"><a href="#rys_2c2e_symm_cupy-69"><span class="linenos"> 69</span></a>    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> 
</span><span id="rys_2c2e_symm_cupy-70"><a href="#rys_2c2e_symm_cupy-70"><span class="linenos"> 70</span></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span> 
</span><span id="rys_2c2e_symm_cupy-71"><a href="#rys_2c2e_symm_cupy-71"><span class="linenos"> 71</span></a>    <span class="n">start_row</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="rys_2c2e_symm_cupy-72"><a href="#rys_2c2e_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">end_row</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="rys_2c2e_symm_cupy-73"><a href="#rys_2c2e_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">start_col</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="rys_2c2e_symm_cupy-74"><a href="#rys_2c2e_symm_cupy-74"><span class="linenos"> 74</span></a>    <span class="n">end_col</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="rys_2c2e_symm_cupy-75"><a href="#rys_2c2e_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-76"><a href="#rys_2c2e_symm_cupy-76"><span class="linenos"> 76</span></a>
</span><span id="rys_2c2e_symm_cupy-77"><a href="#rys_2c2e_symm_cupy-77"><span class="linenos"> 77</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="rys_2c2e_symm_cupy-78"><a href="#rys_2c2e_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="rys_2c2e_symm_cupy-79"><a href="#rys_2c2e_symm_cupy-79"><span class="linenos"> 79</span></a>    <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_2c2e_symm_cupy-80"><a href="#rys_2c2e_symm_cupy-80"><span class="linenos"> 80</span></a>    <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_2c2e_symm_cupy-81"><a href="#rys_2c2e_symm_cupy-81"><span class="linenos"> 81</span></a>    <span class="k">if</span> <span class="n">start_row</span><span class="o">==</span><span class="n">start_col</span> <span class="ow">and</span> <span class="n">end_row</span><span class="o">==</span><span class="n">end_col</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-82"><a href="#rys_2c2e_symm_cupy-82"><span class="linenos"> 82</span></a>        <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_2c2e_symm_cupy-83"><a href="#rys_2c2e_symm_cupy-83"><span class="linenos"> 83</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-84"><a href="#rys_2c2e_symm_cupy-84"><span class="linenos"> 84</span></a>        <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_2c2e_symm_cupy-85"><a href="#rys_2c2e_symm_cupy-85"><span class="linenos"> 85</span></a>
</span><span id="rys_2c2e_symm_cupy-86"><a href="#rys_2c2e_symm_cupy-86"><span class="linenos"> 86</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="rys_2c2e_symm_cupy-87"><a href="#rys_2c2e_symm_cupy-87"><span class="linenos"> 87</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">)</span> 
</span><span id="rys_2c2e_symm_cupy-88"><a href="#rys_2c2e_symm_cupy-88"><span class="linenos"> 88</span></a>
</span><span id="rys_2c2e_symm_cupy-89"><a href="#rys_2c2e_symm_cupy-89"><span class="linenos"> 89</span></a>    
</span><span id="rys_2c2e_symm_cupy-90"><a href="#rys_2c2e_symm_cupy-90"><span class="linenos"> 90</span></a>
</span><span id="rys_2c2e_symm_cupy-91"><a href="#rys_2c2e_symm_cupy-91"><span class="linenos"> 91</span></a>    
</span><span id="rys_2c2e_symm_cupy-92"><a href="#rys_2c2e_symm_cupy-92"><span class="linenos"> 92</span></a>
</span><span id="rys_2c2e_symm_cupy-93"><a href="#rys_2c2e_symm_cupy-93"><span class="linenos"> 93</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-94"><a href="#rys_2c2e_symm_cupy-94"><span class="linenos"> 94</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="rys_2c2e_symm_cupy-95"><a href="#rys_2c2e_symm_cupy-95"><span class="linenos"> 95</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-96"><a href="#rys_2c2e_symm_cupy-96"><span class="linenos"> 96</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-97"><a href="#rys_2c2e_symm_cupy-97"><span class="linenos"> 97</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-98"><a href="#rys_2c2e_symm_cupy-98"><span class="linenos"> 98</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-99"><a href="#rys_2c2e_symm_cupy-99"><span class="linenos"> 99</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-100"><a href="#rys_2c2e_symm_cupy-100"><span class="linenos">100</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-101"><a href="#rys_2c2e_symm_cupy-101"><span class="linenos">101</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-102"><a href="#rys_2c2e_symm_cupy-102"><span class="linenos">102</span></a>
</span><span id="rys_2c2e_symm_cupy-103"><a href="#rys_2c2e_symm_cupy-103"><span class="linenos">103</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_2c2e_symm_cupy-104"><a href="#rys_2c2e_symm_cupy-104"><span class="linenos">104</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_2c2e_symm_cupy-105"><a href="#rys_2c2e_symm_cupy-105"><span class="linenos">105</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="rys_2c2e_symm_cupy-106"><a href="#rys_2c2e_symm_cupy-106"><span class="linenos">106</span></a>    <span class="n">rys_2c2e_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tri_symm</span><span class="p">,</span> <span class="n">no_symm</span><span class="p">,</span> <span class="n">DATA_X_cuda</span><span class="p">,</span> <span class="n">DATA_W_cuda</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-107"><a href="#rys_2c2e_symm_cupy-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="n">tri_symm</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-108"><a href="#rys_2c2e_symm_cupy-108"><span class="linenos">108</span></a>        <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_2c2e_symm_cupy-109"><a href="#rys_2c2e_symm_cupy-109"><span class="linenos">109</span></a>        <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_2c2e_symm_cupy-110"><a href="#rys_2c2e_symm_cupy-110"><span class="linenos">110</span></a>        <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="rys_2c2e_symm_cupy-111"><a href="#rys_2c2e_symm_cupy-111"><span class="linenos">111</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
</span><span id="rys_2c2e_symm_cupy-112"><a href="#rys_2c2e_symm_cupy-112"><span class="linenos">112</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-113"><a href="#rys_2c2e_symm_cupy-113"><span class="linenos">113</span></a>        <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-114"><a href="#rys_2c2e_symm_cupy-114"><span class="linenos">114</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_2c2e_symm_cupy-115"><a href="#rys_2c2e_symm_cupy-115"><span class="linenos">115</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-116"><a href="#rys_2c2e_symm_cupy-116"><span class="linenos">116</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_2c2e_symm_cupy-117"><a href="#rys_2c2e_symm_cupy-117"><span class="linenos">117</span></a>        <span class="c1"># cp._default_memory_pool.free_all_blocks()</span>
</span><span id="rys_2c2e_symm_cupy-118"><a href="#rys_2c2e_symm_cupy-118"><span class="linenos">118</span></a>    <span class="k">return</span> <span class="n">V</span>
</span></pre></div>


    

                </section>
                <section id="rys_3c2e_symm_cupy">
                            <input id="rys_3c2e_symm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_3c2e_symm_cupy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">auxbasis</span>,</span><span class="param">	<span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">schwarz</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-09</span>,</span><span class="param">	<span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_3c2e_symm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_3c2e_symm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_3c2e_symm_cupy-23"><a href="#rys_3c2e_symm_cupy-23"><span class="linenos"> 23</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_3c2e_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schwarz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy-24"><a href="#rys_3c2e_symm_cupy-24"><span class="linenos"> 24</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_3c2e_symm_cupy-25"><a href="#rys_3c2e_symm_cupy-25"><span class="linenos"> 25</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_3c2e_symm_cupy-26"><a href="#rys_3c2e_symm_cupy-26"><span class="linenos"> 26</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="rys_3c2e_symm_cupy-27"><a href="#rys_3c2e_symm_cupy-27"><span class="linenos"> 27</span></a>
</span><span id="rys_3c2e_symm_cupy-28"><a href="#rys_3c2e_symm_cupy-28"><span class="linenos"> 28</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="rys_3c2e_symm_cupy-29"><a href="#rys_3c2e_symm_cupy-29"><span class="linenos"> 29</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_3c2e_symm_cupy-30"><a href="#rys_3c2e_symm_cupy-30"><span class="linenos"> 30</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="rys_3c2e_symm_cupy-31"><a href="#rys_3c2e_symm_cupy-31"><span class="linenos"> 31</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="rys_3c2e_symm_cupy-32"><a href="#rys_3c2e_symm_cupy-32"><span class="linenos"> 32</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="rys_3c2e_symm_cupy-33"><a href="#rys_3c2e_symm_cupy-33"><span class="linenos"> 33</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="rys_3c2e_symm_cupy-34"><a href="#rys_3c2e_symm_cupy-34"><span class="linenos"> 34</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="rys_3c2e_symm_cupy-35"><a href="#rys_3c2e_symm_cupy-35"><span class="linenos"> 35</span></a>
</span><span id="rys_3c2e_symm_cupy-36"><a href="#rys_3c2e_symm_cupy-36"><span class="linenos"> 36</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_symm_cupy-37"><a href="#rys_3c2e_symm_cupy-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-38"><a href="#rys_3c2e_symm_cupy-38"><span class="linenos"> 38</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-39"><a href="#rys_3c2e_symm_cupy-39"><span class="linenos"> 39</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-40"><a href="#rys_3c2e_symm_cupy-40"><span class="linenos"> 40</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-41"><a href="#rys_3c2e_symm_cupy-41"><span class="linenos"> 41</span></a>
</span><span id="rys_3c2e_symm_cupy-42"><a href="#rys_3c2e_symm_cupy-42"><span class="linenos"> 42</span></a>    <span class="n">aux_bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-43"><a href="#rys_3c2e_symm_cupy-43"><span class="linenos"> 43</span></a>    <span class="n">aux_bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-44"><a href="#rys_3c2e_symm_cupy-44"><span class="linenos"> 44</span></a>    <span class="n">aux_bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-45"><a href="#rys_3c2e_symm_cupy-45"><span class="linenos"> 45</span></a>    <span class="n">aux_bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-46"><a href="#rys_3c2e_symm_cupy-46"><span class="linenos"> 46</span></a>
</span><span id="rys_3c2e_symm_cupy-47"><a href="#rys_3c2e_symm_cupy-47"><span class="linenos"> 47</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_3c2e_symm_cupy-48"><a href="#rys_3c2e_symm_cupy-48"><span class="linenos"> 48</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_3c2e_symm_cupy-49"><a href="#rys_3c2e_symm_cupy-49"><span class="linenos"> 49</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_3c2e_symm_cupy-50"><a href="#rys_3c2e_symm_cupy-50"><span class="linenos"> 50</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_3c2e_symm_cupy-51"><a href="#rys_3c2e_symm_cupy-51"><span class="linenos"> 51</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_3c2e_symm_cupy-52"><a href="#rys_3c2e_symm_cupy-52"><span class="linenos"> 52</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-53"><a href="#rys_3c2e_symm_cupy-53"><span class="linenos"> 53</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-54"><a href="#rys_3c2e_symm_cupy-54"><span class="linenos"> 54</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-55"><a href="#rys_3c2e_symm_cupy-55"><span class="linenos"> 55</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-56"><a href="#rys_3c2e_symm_cupy-56"><span class="linenos"> 56</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy-57"><a href="#rys_3c2e_symm_cupy-57"><span class="linenos"> 57</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm_cupy-58"><a href="#rys_3c2e_symm_cupy-58"><span class="linenos"> 58</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-59"><a href="#rys_3c2e_symm_cupy-59"><span class="linenos"> 59</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-60"><a href="#rys_3c2e_symm_cupy-60"><span class="linenos"> 60</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-61"><a href="#rys_3c2e_symm_cupy-61"><span class="linenos"> 61</span></a>    <span class="n">maxnprimaux</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-62"><a href="#rys_3c2e_symm_cupy-62"><span class="linenos"> 62</span></a>    <span class="n">aux_bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-63"><a href="#rys_3c2e_symm_cupy-63"><span class="linenos"> 63</span></a>    <span class="n">aux_bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-64"><a href="#rys_3c2e_symm_cupy-64"><span class="linenos"> 64</span></a>    <span class="n">aux_bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-65"><a href="#rys_3c2e_symm_cupy-65"><span class="linenos"> 65</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy-66"><a href="#rys_3c2e_symm_cupy-66"><span class="linenos"> 66</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm_cupy-67"><a href="#rys_3c2e_symm_cupy-67"><span class="linenos"> 67</span></a>            <span class="n">aux_bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-68"><a href="#rys_3c2e_symm_cupy-68"><span class="linenos"> 68</span></a>            <span class="n">aux_bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-69"><a href="#rys_3c2e_symm_cupy-69"><span class="linenos"> 69</span></a>            <span class="n">aux_bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-70"><a href="#rys_3c2e_symm_cupy-70"><span class="linenos"> 70</span></a>        
</span><span id="rys_3c2e_symm_cupy-71"><a href="#rys_3c2e_symm_cupy-71"><span class="linenos"> 71</span></a>
</span><span id="rys_3c2e_symm_cupy-72"><a href="#rys_3c2e_symm_cupy-72"><span class="linenos"> 72</span></a>    <span class="n">DATA_X_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_X</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-73"><a href="#rys_3c2e_symm_cupy-73"><span class="linenos"> 73</span></a>    <span class="n">DATA_W_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_W</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-74"><a href="#rys_3c2e_symm_cupy-74"><span class="linenos"> 74</span></a>
</span><span id="rys_3c2e_symm_cupy-75"><a href="#rys_3c2e_symm_cupy-75"><span class="linenos"> 75</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-76"><a href="#rys_3c2e_symm_cupy-76"><span class="linenos"> 76</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy-77"><a href="#rys_3c2e_symm_cupy-77"><span class="linenos"> 77</span></a>
</span><span id="rys_3c2e_symm_cupy-78"><a href="#rys_3c2e_symm_cupy-78"><span class="linenos"> 78</span></a>    <span class="k">if</span> <span class="n">schwarz</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-79"><a href="#rys_3c2e_symm_cupy-79"><span class="linenos"> 79</span></a>        <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
</span><span id="rys_3c2e_symm_cupy-80"><a href="#rys_3c2e_symm_cupy-80"><span class="linenos"> 80</span></a>        <span class="n">ints2c2e</span> <span class="o">=</span> <span class="n">rys_2c2e_symm_cupy</span><span class="p">(</span><span class="n">auxbasis</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-81"><a href="#rys_3c2e_symm_cupy-81"><span class="linenos"> 81</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="rys_3c2e_symm_cupy-82"><a href="#rys_3c2e_symm_cupy-82"><span class="linenos"> 82</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ints2c2e</span><span class="p">)))</span>
</span><span id="rys_3c2e_symm_cupy-83"><a href="#rys_3c2e_symm_cupy-83"><span class="linenos"> 83</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prelims calc done for Schwarz screening!&#39;</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-84"><a href="#rys_3c2e_symm_cupy-84"><span class="linenos"> 84</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-85"><a href="#rys_3c2e_symm_cupy-85"><span class="linenos"> 85</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="rys_3c2e_symm_cupy-86"><a href="#rys_3c2e_symm_cupy-86"><span class="linenos"> 86</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-87"><a href="#rys_3c2e_symm_cupy-87"><span class="linenos"> 87</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-88"><a href="#rys_3c2e_symm_cupy-88"><span class="linenos"> 88</span></a>        
</span><span id="rys_3c2e_symm_cupy-89"><a href="#rys_3c2e_symm_cupy-89"><span class="linenos"> 89</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_3c2e_symm_cupy-90"><a href="#rys_3c2e_symm_cupy-90"><span class="linenos"> 90</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-91"><a href="#rys_3c2e_symm_cupy-91"><span class="linenos"> 91</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-92"><a href="#rys_3c2e_symm_cupy-92"><span class="linenos"> 92</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-93"><a href="#rys_3c2e_symm_cupy-93"><span class="linenos"> 93</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-94"><a href="#rys_3c2e_symm_cupy-94"><span class="linenos"> 94</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-95"><a href="#rys_3c2e_symm_cupy-95"><span class="linenos"> 95</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy-96"><a href="#rys_3c2e_symm_cupy-96"><span class="linenos"> 96</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="rys_3c2e_symm_cupy-97"><a href="#rys_3c2e_symm_cupy-97"><span class="linenos"> 97</span></a>    <span class="n">num_A</span> <span class="o">=</span> <span class="n">indx_endA</span> <span class="o">-</span> <span class="n">indx_startA</span> 
</span><span id="rys_3c2e_symm_cupy-98"><a href="#rys_3c2e_symm_cupy-98"><span class="linenos"> 98</span></a>    <span class="n">num_B</span> <span class="o">=</span> <span class="n">indx_endB</span> <span class="o">-</span> <span class="n">indx_startB</span> 
</span><span id="rys_3c2e_symm_cupy-99"><a href="#rys_3c2e_symm_cupy-99"><span class="linenos"> 99</span></a>    <span class="n">num_C</span> <span class="o">=</span> <span class="n">indx_endC</span> <span class="o">-</span> <span class="n">indx_startC</span>
</span><span id="rys_3c2e_symm_cupy-100"><a href="#rys_3c2e_symm_cupy-100"><span class="linenos">100</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_A</span><span class="p">,</span> <span class="n">num_B</span><span class="p">,</span> <span class="n">num_C</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-101"><a href="#rys_3c2e_symm_cupy-101"><span class="linenos">101</span></a>
</span><span id="rys_3c2e_symm_cupy-102"><a href="#rys_3c2e_symm_cupy-102"><span class="linenos">102</span></a>    
</span><span id="rys_3c2e_symm_cupy-103"><a href="#rys_3c2e_symm_cupy-103"><span class="linenos">103</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="rys_3c2e_symm_cupy-104"><a href="#rys_3c2e_symm_cupy-104"><span class="linenos">104</span></a>    <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_3c2e_symm_cupy-105"><a href="#rys_3c2e_symm_cupy-105"><span class="linenos">105</span></a>    <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_3c2e_symm_cupy-106"><a href="#rys_3c2e_symm_cupy-106"><span class="linenos">106</span></a>    <span class="k">if</span> <span class="n">indx_startA</span><span class="o">==</span><span class="n">indx_startB</span> <span class="ow">and</span> <span class="n">indx_endA</span><span class="o">==</span><span class="n">indx_endB</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-107"><a href="#rys_3c2e_symm_cupy-107"><span class="linenos">107</span></a>        <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_3c2e_symm_cupy-108"><a href="#rys_3c2e_symm_cupy-108"><span class="linenos">108</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-109"><a href="#rys_3c2e_symm_cupy-109"><span class="linenos">109</span></a>        <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_3c2e_symm_cupy-110"><a href="#rys_3c2e_symm_cupy-110"><span class="linenos">110</span></a>    
</span><span id="rys_3c2e_symm_cupy-111"><a href="#rys_3c2e_symm_cupy-111"><span class="linenos">111</span></a>
</span><span id="rys_3c2e_symm_cupy-112"><a href="#rys_3c2e_symm_cupy-112"><span class="linenos">112</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="rys_3c2e_symm_cupy-113"><a href="#rys_3c2e_symm_cupy-113"><span class="linenos">113</span></a>    <span class="n">threeC2E</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-114"><a href="#rys_3c2e_symm_cupy-114"><span class="linenos">114</span></a>
</span><span id="rys_3c2e_symm_cupy-115"><a href="#rys_3c2e_symm_cupy-115"><span class="linenos">115</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-116"><a href="#rys_3c2e_symm_cupy-116"><span class="linenos">116</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="rys_3c2e_symm_cupy-117"><a href="#rys_3c2e_symm_cupy-117"><span class="linenos">117</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-118"><a href="#rys_3c2e_symm_cupy-118"><span class="linenos">118</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-119"><a href="#rys_3c2e_symm_cupy-119"><span class="linenos">119</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-120"><a href="#rys_3c2e_symm_cupy-120"><span class="linenos">120</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-121"><a href="#rys_3c2e_symm_cupy-121"><span class="linenos">121</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-122"><a href="#rys_3c2e_symm_cupy-122"><span class="linenos">122</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-123"><a href="#rys_3c2e_symm_cupy-123"><span class="linenos">123</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-124"><a href="#rys_3c2e_symm_cupy-124"><span class="linenos">124</span></a>
</span><span id="rys_3c2e_symm_cupy-125"><a href="#rys_3c2e_symm_cupy-125"><span class="linenos">125</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_3c2e_symm_cupy-126"><a href="#rys_3c2e_symm_cupy-126"><span class="linenos">126</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_3c2e_symm_cupy-127"><a href="#rys_3c2e_symm_cupy-127"><span class="linenos">127</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_A</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_B</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="rys_3c2e_symm_cupy-128"><a href="#rys_3c2e_symm_cupy-128"><span class="linenos">128</span></a>    <span class="n">rys_3c2e_symm_internal_cuda_new</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">aux_bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_coeffs</span><span class="p">,</span> <span class="n">aux_bfs_prim_norms</span><span class="p">,</span> <span class="n">aux_bfs_expnts</span><span class="p">,</span> <span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">tri_symm</span><span class="p">,</span> <span class="n">no_symm</span><span class="p">,</span> <span class="n">DATA_X_cuda</span><span class="p">,</span> <span class="n">DATA_W_cuda</span><span class="p">,</span> <span class="n">schwarz</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="p">,</span> <span class="n">threeC2E</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-129"><a href="#rys_3c2e_symm_cupy-129"><span class="linenos">129</span></a>    <span class="k">if</span> <span class="n">tri_symm</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-130"><a href="#rys_3c2e_symm_cupy-130"><span class="linenos">130</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span><span class="n">threeC2E</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy-131"><a href="#rys_3c2e_symm_cupy-131"><span class="linenos">131</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-132"><a href="#rys_3c2e_symm_cupy-132"><span class="linenos">132</span></a>        <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-133"><a href="#rys_3c2e_symm_cupy-133"><span class="linenos">133</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy-134"><a href="#rys_3c2e_symm_cupy-134"><span class="linenos">134</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-135"><a href="#rys_3c2e_symm_cupy-135"><span class="linenos">135</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy-136"><a href="#rys_3c2e_symm_cupy-136"><span class="linenos">136</span></a>        <span class="c1"># cp._default_memory_pool.free_all_blocks()</span>
</span><span id="rys_3c2e_symm_cupy-137"><a href="#rys_3c2e_symm_cupy-137"><span class="linenos">137</span></a>    <span class="k">return</span> <span class="n">threeC2E</span>
</span></pre></div>


    

                </section>
                <section id="rys_3c2e_symm_cupy_fp32">
                            <input id="rys_3c2e_symm_cupy_fp32-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rys_3c2e_symm_cupy_fp32</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">auxbasis</span>,</span><span class="param">	<span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">schwarz</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-09</span>,</span><span class="param">	<span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rys_3c2e_symm_cupy_fp32-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rys_3c2e_symm_cupy_fp32"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rys_3c2e_symm_cupy_fp32-23"><a href="#rys_3c2e_symm_cupy_fp32-23"><span class="linenos"> 23</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rys_3c2e_symm_cupy_fp32</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schwarz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy_fp32-24"><a href="#rys_3c2e_symm_cupy_fp32-24"><span class="linenos"> 24</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-25"><a href="#rys_3c2e_symm_cupy_fp32-25"><span class="linenos"> 25</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="rys_3c2e_symm_cupy_fp32-26"><a href="#rys_3c2e_symm_cupy_fp32-26"><span class="linenos"> 26</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-27"><a href="#rys_3c2e_symm_cupy_fp32-27"><span class="linenos"> 27</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-28"><a href="#rys_3c2e_symm_cupy_fp32-28"><span class="linenos"> 28</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-29"><a href="#rys_3c2e_symm_cupy_fp32-29"><span class="linenos"> 29</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-30"><a href="#rys_3c2e_symm_cupy_fp32-30"><span class="linenos"> 30</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-31"><a href="#rys_3c2e_symm_cupy_fp32-31"><span class="linenos"> 31</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-32"><a href="#rys_3c2e_symm_cupy_fp32-32"><span class="linenos"> 32</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-33"><a href="#rys_3c2e_symm_cupy_fp32-33"><span class="linenos"> 33</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-34"><a href="#rys_3c2e_symm_cupy_fp32-34"><span class="linenos"> 34</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="rys_3c2e_symm_cupy_fp32-35"><a href="#rys_3c2e_symm_cupy_fp32-35"><span class="linenos"> 35</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-36"><a href="#rys_3c2e_symm_cupy_fp32-36"><span class="linenos"> 36</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-37"><a href="#rys_3c2e_symm_cupy_fp32-37"><span class="linenos"> 37</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-38"><a href="#rys_3c2e_symm_cupy_fp32-38"><span class="linenos"> 38</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-39"><a href="#rys_3c2e_symm_cupy_fp32-39"><span class="linenos"> 39</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-40"><a href="#rys_3c2e_symm_cupy_fp32-40"><span class="linenos"> 40</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-41"><a href="#rys_3c2e_symm_cupy_fp32-41"><span class="linenos"> 41</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-42"><a href="#rys_3c2e_symm_cupy_fp32-42"><span class="linenos"> 42</span></a>    <span class="n">aux_bfs_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-43"><a href="#rys_3c2e_symm_cupy_fp32-43"><span class="linenos"> 43</span></a>    <span class="n">aux_bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-44"><a href="#rys_3c2e_symm_cupy_fp32-44"><span class="linenos"> 44</span></a>    <span class="n">aux_bfs_lmn</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-45"><a href="#rys_3c2e_symm_cupy_fp32-45"><span class="linenos"> 45</span></a>    <span class="n">aux_bfs_nprim</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-46"><a href="#rys_3c2e_symm_cupy_fp32-46"><span class="linenos"> 46</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-47"><a href="#rys_3c2e_symm_cupy_fp32-47"><span class="linenos"> 47</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-48"><a href="#rys_3c2e_symm_cupy_fp32-48"><span class="linenos"> 48</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-49"><a href="#rys_3c2e_symm_cupy_fp32-49"><span class="linenos"> 49</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="rys_3c2e_symm_cupy_fp32-50"><a href="#rys_3c2e_symm_cupy_fp32-50"><span class="linenos"> 50</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="rys_3c2e_symm_cupy_fp32-51"><a href="#rys_3c2e_symm_cupy_fp32-51"><span class="linenos"> 51</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="rys_3c2e_symm_cupy_fp32-52"><a href="#rys_3c2e_symm_cupy_fp32-52"><span class="linenos"> 52</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-53"><a href="#rys_3c2e_symm_cupy_fp32-53"><span class="linenos"> 53</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-54"><a href="#rys_3c2e_symm_cupy_fp32-54"><span class="linenos"> 54</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-55"><a href="#rys_3c2e_symm_cupy_fp32-55"><span class="linenos"> 55</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-56"><a href="#rys_3c2e_symm_cupy_fp32-56"><span class="linenos"> 56</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy_fp32-57"><a href="#rys_3c2e_symm_cupy_fp32-57"><span class="linenos"> 57</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm_cupy_fp32-58"><a href="#rys_3c2e_symm_cupy_fp32-58"><span class="linenos"> 58</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-59"><a href="#rys_3c2e_symm_cupy_fp32-59"><span class="linenos"> 59</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-60"><a href="#rys_3c2e_symm_cupy_fp32-60"><span class="linenos"> 60</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-61"><a href="#rys_3c2e_symm_cupy_fp32-61"><span class="linenos"> 61</span></a>    <span class="n">maxnprimaux</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-62"><a href="#rys_3c2e_symm_cupy_fp32-62"><span class="linenos"> 62</span></a>    <span class="n">aux_bfs_coeffs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-63"><a href="#rys_3c2e_symm_cupy_fp32-63"><span class="linenos"> 63</span></a>    <span class="n">aux_bfs_expnts</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-64"><a href="#rys_3c2e_symm_cupy_fp32-64"><span class="linenos"> 64</span></a>    <span class="n">aux_bfs_prim_norms</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimaux</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-65"><a href="#rys_3c2e_symm_cupy_fp32-65"><span class="linenos"> 65</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="rys_3c2e_symm_cupy_fp32-66"><a href="#rys_3c2e_symm_cupy_fp32-66"><span class="linenos"> 66</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="rys_3c2e_symm_cupy_fp32-67"><a href="#rys_3c2e_symm_cupy_fp32-67"><span class="linenos"> 67</span></a>            <span class="n">aux_bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-68"><a href="#rys_3c2e_symm_cupy_fp32-68"><span class="linenos"> 68</span></a>            <span class="n">aux_bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-69"><a href="#rys_3c2e_symm_cupy_fp32-69"><span class="linenos"> 69</span></a>            <span class="n">aux_bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-70"><a href="#rys_3c2e_symm_cupy_fp32-70"><span class="linenos"> 70</span></a>        
</span><span id="rys_3c2e_symm_cupy_fp32-71"><a href="#rys_3c2e_symm_cupy_fp32-71"><span class="linenos"> 71</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-72"><a href="#rys_3c2e_symm_cupy_fp32-72"><span class="linenos"> 72</span></a>    <span class="n">DATA_X_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-73"><a href="#rys_3c2e_symm_cupy_fp32-73"><span class="linenos"> 73</span></a>    <span class="n">DATA_W_cuda</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DATA_W</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-74"><a href="#rys_3c2e_symm_cupy_fp32-74"><span class="linenos"> 74</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-75"><a href="#rys_3c2e_symm_cupy_fp32-75"><span class="linenos"> 75</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-76"><a href="#rys_3c2e_symm_cupy_fp32-76"><span class="linenos"> 76</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="rys_3c2e_symm_cupy_fp32-77"><a href="#rys_3c2e_symm_cupy_fp32-77"><span class="linenos"> 77</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-78"><a href="#rys_3c2e_symm_cupy_fp32-78"><span class="linenos"> 78</span></a>    <span class="k">if</span> <span class="n">schwarz</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-79"><a href="#rys_3c2e_symm_cupy_fp32-79"><span class="linenos"> 79</span></a>        <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
</span><span id="rys_3c2e_symm_cupy_fp32-80"><a href="#rys_3c2e_symm_cupy_fp32-80"><span class="linenos"> 80</span></a>        <span class="n">ints2c2e</span> <span class="o">=</span> <span class="n">rys_2c2e_symm_cupy</span><span class="p">(</span><span class="n">auxbasis</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-81"><a href="#rys_3c2e_symm_cupy_fp32-81"><span class="linenos"> 81</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="rys_3c2e_symm_cupy_fp32-82"><a href="#rys_3c2e_symm_cupy_fp32-82"><span class="linenos"> 82</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ints2c2e</span><span class="p">)))</span>
</span><span id="rys_3c2e_symm_cupy_fp32-83"><a href="#rys_3c2e_symm_cupy_fp32-83"><span class="linenos"> 83</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prelims calc done for Schwarz screening!&#39;</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-84"><a href="#rys_3c2e_symm_cupy_fp32-84"><span class="linenos"> 84</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-85"><a href="#rys_3c2e_symm_cupy_fp32-85"><span class="linenos"> 85</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="rys_3c2e_symm_cupy_fp32-86"><a href="#rys_3c2e_symm_cupy_fp32-86"><span class="linenos"> 86</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-87"><a href="#rys_3c2e_symm_cupy_fp32-87"><span class="linenos"> 87</span></a>        <span class="n">sqrt_diag_ints2c2e</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-88"><a href="#rys_3c2e_symm_cupy_fp32-88"><span class="linenos"> 88</span></a>        
</span><span id="rys_3c2e_symm_cupy_fp32-89"><a href="#rys_3c2e_symm_cupy_fp32-89"><span class="linenos"> 89</span></a>    <span class="c1">#Limits for the calculation of 4c2e integrals</span>
</span><span id="rys_3c2e_symm_cupy_fp32-90"><a href="#rys_3c2e_symm_cupy_fp32-90"><span class="linenos"> 90</span></a>    <span class="n">indx_startA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-91"><a href="#rys_3c2e_symm_cupy_fp32-91"><span class="linenos"> 91</span></a>    <span class="n">indx_endA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-92"><a href="#rys_3c2e_symm_cupy_fp32-92"><span class="linenos"> 92</span></a>    <span class="n">indx_startB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-93"><a href="#rys_3c2e_symm_cupy_fp32-93"><span class="linenos"> 93</span></a>    <span class="n">indx_endB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-94"><a href="#rys_3c2e_symm_cupy_fp32-94"><span class="linenos"> 94</span></a>    <span class="n">indx_startC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-95"><a href="#rys_3c2e_symm_cupy_fp32-95"><span class="linenos"> 95</span></a>    <span class="n">indx_endC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="rys_3c2e_symm_cupy_fp32-96"><a href="#rys_3c2e_symm_cupy_fp32-96"><span class="linenos"> 96</span></a>    <span class="c1"># Infer the matrix shape from the start and end indices</span>
</span><span id="rys_3c2e_symm_cupy_fp32-97"><a href="#rys_3c2e_symm_cupy_fp32-97"><span class="linenos"> 97</span></a>    <span class="n">num_A</span> <span class="o">=</span> <span class="n">indx_endA</span> <span class="o">-</span> <span class="n">indx_startA</span> 
</span><span id="rys_3c2e_symm_cupy_fp32-98"><a href="#rys_3c2e_symm_cupy_fp32-98"><span class="linenos"> 98</span></a>    <span class="n">num_B</span> <span class="o">=</span> <span class="n">indx_endB</span> <span class="o">-</span> <span class="n">indx_startB</span> 
</span><span id="rys_3c2e_symm_cupy_fp32-99"><a href="#rys_3c2e_symm_cupy_fp32-99"><span class="linenos"> 99</span></a>    <span class="n">num_C</span> <span class="o">=</span> <span class="n">indx_endC</span> <span class="o">-</span> <span class="n">indx_startC</span>
</span><span id="rys_3c2e_symm_cupy_fp32-100"><a href="#rys_3c2e_symm_cupy_fp32-100"><span class="linenos">100</span></a>    <span class="n">matrix_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_A</span><span class="p">,</span> <span class="n">num_B</span><span class="p">,</span> <span class="n">num_C</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-101"><a href="#rys_3c2e_symm_cupy_fp32-101"><span class="linenos">101</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-102"><a href="#rys_3c2e_symm_cupy_fp32-102"><span class="linenos">102</span></a>    
</span><span id="rys_3c2e_symm_cupy_fp32-103"><a href="#rys_3c2e_symm_cupy_fp32-103"><span class="linenos">103</span></a>    <span class="c1"># Check if the slice of the matrix requested falls in the lower/upper triangle or in both the triangles</span>
</span><span id="rys_3c2e_symm_cupy_fp32-104"><a href="#rys_3c2e_symm_cupy_fp32-104"><span class="linenos">104</span></a>    <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_3c2e_symm_cupy_fp32-105"><a href="#rys_3c2e_symm_cupy_fp32-105"><span class="linenos">105</span></a>    <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="rys_3c2e_symm_cupy_fp32-106"><a href="#rys_3c2e_symm_cupy_fp32-106"><span class="linenos">106</span></a>    <span class="k">if</span> <span class="n">indx_startA</span><span class="o">==</span><span class="n">indx_startB</span> <span class="ow">and</span> <span class="n">indx_endA</span><span class="o">==</span><span class="n">indx_endB</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-107"><a href="#rys_3c2e_symm_cupy_fp32-107"><span class="linenos">107</span></a>        <span class="n">tri_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_3c2e_symm_cupy_fp32-108"><a href="#rys_3c2e_symm_cupy_fp32-108"><span class="linenos">108</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-109"><a href="#rys_3c2e_symm_cupy_fp32-109"><span class="linenos">109</span></a>        <span class="n">no_symm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="rys_3c2e_symm_cupy_fp32-110"><a href="#rys_3c2e_symm_cupy_fp32-110"><span class="linenos">110</span></a>    
</span><span id="rys_3c2e_symm_cupy_fp32-111"><a href="#rys_3c2e_symm_cupy_fp32-111"><span class="linenos">111</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-112"><a href="#rys_3c2e_symm_cupy_fp32-112"><span class="linenos">112</span></a>    <span class="c1"># Initialize the matrix with zeros</span>
</span><span id="rys_3c2e_symm_cupy_fp32-113"><a href="#rys_3c2e_symm_cupy_fp32-113"><span class="linenos">113</span></a>    <span class="n">threeC2E</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-114"><a href="#rys_3c2e_symm_cupy_fp32-114"><span class="linenos">114</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-115"><a href="#rys_3c2e_symm_cupy_fp32-115"><span class="linenos">115</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-116"><a href="#rys_3c2e_symm_cupy_fp32-116"><span class="linenos">116</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="rys_3c2e_symm_cupy_fp32-117"><a href="#rys_3c2e_symm_cupy_fp32-117"><span class="linenos">117</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-118"><a href="#rys_3c2e_symm_cupy_fp32-118"><span class="linenos">118</span></a>        <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-119"><a href="#rys_3c2e_symm_cupy_fp32-119"><span class="linenos">119</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-120"><a href="#rys_3c2e_symm_cupy_fp32-120"><span class="linenos">120</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-121"><a href="#rys_3c2e_symm_cupy_fp32-121"><span class="linenos">121</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-122"><a href="#rys_3c2e_symm_cupy_fp32-122"><span class="linenos">122</span></a>        <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-123"><a href="#rys_3c2e_symm_cupy_fp32-123"><span class="linenos">123</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-124"><a href="#rys_3c2e_symm_cupy_fp32-124"><span class="linenos">124</span></a>
</span><span id="rys_3c2e_symm_cupy_fp32-125"><a href="#rys_3c2e_symm_cupy_fp32-125"><span class="linenos">125</span></a>    <span class="n">thread_x</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_3c2e_symm_cupy_fp32-126"><a href="#rys_3c2e_symm_cupy_fp32-126"><span class="linenos">126</span></a>    <span class="n">thread_y</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="rys_3c2e_symm_cupy_fp32-127"><a href="#rys_3c2e_symm_cupy_fp32-127"><span class="linenos">127</span></a>    <span class="n">blocks_per_grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">num_A</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_x</span><span class="p">,</span> <span class="p">(</span><span class="n">num_B</span> <span class="o">+</span> <span class="p">(</span><span class="n">thread_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="n">thread_y</span><span class="p">)</span> 
</span><span id="rys_3c2e_symm_cupy_fp32-128"><a href="#rys_3c2e_symm_cupy_fp32-128"><span class="linenos">128</span></a>    <span class="n">rys_3c2e_symm_internal_cuda</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">aux_bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux_bfs_coeffs</span><span class="p">,</span> <span class="n">aux_bfs_prim_norms</span><span class="p">,</span> <span class="n">aux_bfs_expnts</span><span class="p">,</span> <span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span> <span class="n">tri_symm</span><span class="p">,</span> <span class="n">no_symm</span><span class="p">,</span> <span class="n">DATA_X_cuda</span><span class="p">,</span> <span class="n">DATA_W_cuda</span><span class="p">,</span> <span class="n">schwarz</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">schwarz_threshold</span><span class="p">,</span> <span class="n">threeC2E</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-129"><a href="#rys_3c2e_symm_cupy_fp32-129"><span class="linenos">129</span></a>    <span class="k">if</span> <span class="n">tri_symm</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-130"><a href="#rys_3c2e_symm_cupy_fp32-130"><span class="linenos">130</span></a>        <span class="n">symmetrize</span><span class="p">[</span><span class="n">blocks_per_grid</span><span class="p">,</span> <span class="p">(</span><span class="n">thread_x</span><span class="p">,</span> <span class="n">thread_y</span><span class="p">),</span> <span class="n">nb_stream</span><span class="p">](</span><span class="n">indx_startA</span><span class="p">,</span> <span class="n">indx_endA</span><span class="p">,</span> <span class="n">indx_startB</span><span class="p">,</span> <span class="n">indx_endB</span><span class="p">,</span> <span class="n">indx_startC</span><span class="p">,</span> <span class="n">indx_endC</span><span class="p">,</span><span class="n">threeC2E</span><span class="p">)</span>
</span><span id="rys_3c2e_symm_cupy_fp32-131"><a href="#rys_3c2e_symm_cupy_fp32-131"><span class="linenos">131</span></a>    <span class="k">if</span> <span class="n">cp_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-132"><a href="#rys_3c2e_symm_cupy_fp32-132"><span class="linenos">132</span></a>        <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-133"><a href="#rys_3c2e_symm_cupy_fp32-133"><span class="linenos">133</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="rys_3c2e_symm_cupy_fp32-134"><a href="#rys_3c2e_symm_cupy_fp32-134"><span class="linenos">134</span></a>        <span class="n">cp_stream</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-135"><a href="#rys_3c2e_symm_cupy_fp32-135"><span class="linenos">135</span></a>        <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-136"><a href="#rys_3c2e_symm_cupy_fp32-136"><span class="linenos">136</span></a>        <span class="c1"># cp._default_memory_pool.free_all_blocks()</span>
</span><span id="rys_3c2e_symm_cupy_fp32-137"><a href="#rys_3c2e_symm_cupy_fp32-137"><span class="linenos">137</span></a>    <span class="k">return</span> <span class="n">threeC2E</span>
</span></pre></div>


    

                </section>
                <section id="overlap_mat_grad_symm">
                            <input id="overlap_mat_grad_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">overlap_mat_grad_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="overlap_mat_grad_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#overlap_mat_grad_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="overlap_mat_grad_symm-7"><a href="#overlap_mat_grad_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_mat_grad_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="overlap_mat_grad_symm-8"><a href="#overlap_mat_grad_symm-8"><span class="linenos"> 8</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="overlap_mat_grad_symm-9"><a href="#overlap_mat_grad_symm-9"><span class="linenos"> 9</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="overlap_mat_grad_symm-10"><a href="#overlap_mat_grad_symm-10"><span class="linenos">10</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="overlap_mat_grad_symm-11"><a href="#overlap_mat_grad_symm-11"><span class="linenos">11</span></a>
</span><span id="overlap_mat_grad_symm-12"><a href="#overlap_mat_grad_symm-12"><span class="linenos">12</span></a>    <span class="c1"># This function calculates the overlap matrix for a given basis object.</span>
</span><span id="overlap_mat_grad_symm-13"><a href="#overlap_mat_grad_symm-13"><span class="linenos">13</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="overlap_mat_grad_symm-14"><a href="#overlap_mat_grad_symm-14"><span class="linenos">14</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="overlap_mat_grad_symm-15"><a href="#overlap_mat_grad_symm-15"><span class="linenos">15</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="overlap_mat_grad_symm-16"><a href="#overlap_mat_grad_symm-16"><span class="linenos">16</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="overlap_mat_grad_symm-17"><a href="#overlap_mat_grad_symm-17"><span class="linenos">17</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="overlap_mat_grad_symm-18"><a href="#overlap_mat_grad_symm-18"><span class="linenos">18</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="overlap_mat_grad_symm-19"><a href="#overlap_mat_grad_symm-19"><span class="linenos">19</span></a>
</span><span id="overlap_mat_grad_symm-20"><a href="#overlap_mat_grad_symm-20"><span class="linenos">20</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="overlap_mat_grad_symm-21"><a href="#overlap_mat_grad_symm-21"><span class="linenos">21</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-22"><a href="#overlap_mat_grad_symm-22"><span class="linenos">22</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-23"><a href="#overlap_mat_grad_symm-23"><span class="linenos">23</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-24"><a href="#overlap_mat_grad_symm-24"><span class="linenos">24</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-25"><a href="#overlap_mat_grad_symm-25"><span class="linenos">25</span></a>    <span class="n">bfs_atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_atoms</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-26"><a href="#overlap_mat_grad_symm-26"><span class="linenos">26</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_atoms</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="overlap_mat_grad_symm-27"><a href="#overlap_mat_grad_symm-27"><span class="linenos">27</span></a>        
</span><span id="overlap_mat_grad_symm-28"><a href="#overlap_mat_grad_symm-28"><span class="linenos">28</span></a>
</span><span id="overlap_mat_grad_symm-29"><a href="#overlap_mat_grad_symm-29"><span class="linenos">29</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="overlap_mat_grad_symm-30"><a href="#overlap_mat_grad_symm-30"><span class="linenos">30</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="overlap_mat_grad_symm-31"><a href="#overlap_mat_grad_symm-31"><span class="linenos">31</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="overlap_mat_grad_symm-32"><a href="#overlap_mat_grad_symm-32"><span class="linenos">32</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="overlap_mat_grad_symm-33"><a href="#overlap_mat_grad_symm-33"><span class="linenos">33</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="overlap_mat_grad_symm-34"><a href="#overlap_mat_grad_symm-34"><span class="linenos">34</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="overlap_mat_grad_symm-35"><a href="#overlap_mat_grad_symm-35"><span class="linenos">35</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-36"><a href="#overlap_mat_grad_symm-36"><span class="linenos">36</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-37"><a href="#overlap_mat_grad_symm-37"><span class="linenos">37</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="overlap_mat_grad_symm-38"><a href="#overlap_mat_grad_symm-38"><span class="linenos">38</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="overlap_mat_grad_symm-39"><a href="#overlap_mat_grad_symm-39"><span class="linenos">39</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="overlap_mat_grad_symm-40"><a href="#overlap_mat_grad_symm-40"><span class="linenos">40</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_grad_symm-41"><a href="#overlap_mat_grad_symm-41"><span class="linenos">41</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_grad_symm-42"><a href="#overlap_mat_grad_symm-42"><span class="linenos">42</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="overlap_mat_grad_symm-43"><a href="#overlap_mat_grad_symm-43"><span class="linenos">43</span></a>        
</span><span id="overlap_mat_grad_symm-44"><a href="#overlap_mat_grad_symm-44"><span class="linenos">44</span></a>
</span><span id="overlap_mat_grad_symm-45"><a href="#overlap_mat_grad_symm-45"><span class="linenos">45</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="overlap_mat_grad_symm-46"><a href="#overlap_mat_grad_symm-46"><span class="linenos">46</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="overlap_mat_grad_symm-47"><a href="#overlap_mat_grad_symm-47"><span class="linenos">47</span></a>        
</span><span id="overlap_mat_grad_symm-48"><a href="#overlap_mat_grad_symm-48"><span class="linenos">48</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="overlap_mat_grad_symm-49"><a href="#overlap_mat_grad_symm-49"><span class="linenos">49</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="overlap_mat_grad_symm-50"><a href="#overlap_mat_grad_symm-50"><span class="linenos">50</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="overlap_mat_grad_symm-51"><a href="#overlap_mat_grad_symm-51"><span class="linenos">51</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="overlap_mat_grad_symm-52"><a href="#overlap_mat_grad_symm-52"><span class="linenos">52</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="overlap_mat_grad_symm-53"><a href="#overlap_mat_grad_symm-53"><span class="linenos">53</span></a>        
</span><span id="overlap_mat_grad_symm-54"><a href="#overlap_mat_grad_symm-54"><span class="linenos">54</span></a>    <span class="n">dS</span> <span class="o">=</span> <span class="n">overlap_mat_grad_symm_internal_new</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="n">bfs_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="overlap_mat_grad_symm-55"><a href="#overlap_mat_grad_symm-55"><span class="linenos">55</span></a>    <span class="k">return</span> <span class="n">dS</span>
</span></pre></div>


    

                </section>
                <section id="kin_mat_grad_symm">
                            <input id="kin_mat_grad_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kin_mat_grad_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="kin_mat_grad_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#kin_mat_grad_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="kin_mat_grad_symm-7"><a href="#kin_mat_grad_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">kin_mat_grad_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="kin_mat_grad_symm-8"><a href="#kin_mat_grad_symm-8"><span class="linenos"> 8</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="kin_mat_grad_symm-9"><a href="#kin_mat_grad_symm-9"><span class="linenos"> 9</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="kin_mat_grad_symm-10"><a href="#kin_mat_grad_symm-10"><span class="linenos">10</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="kin_mat_grad_symm-11"><a href="#kin_mat_grad_symm-11"><span class="linenos">11</span></a>
</span><span id="kin_mat_grad_symm-12"><a href="#kin_mat_grad_symm-12"><span class="linenos">12</span></a>    <span class="c1"># This function calculates the kinetic energy matrix for a given basis object.</span>
</span><span id="kin_mat_grad_symm-13"><a href="#kin_mat_grad_symm-13"><span class="linenos">13</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="kin_mat_grad_symm-14"><a href="#kin_mat_grad_symm-14"><span class="linenos">14</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="kin_mat_grad_symm-15"><a href="#kin_mat_grad_symm-15"><span class="linenos">15</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="kin_mat_grad_symm-16"><a href="#kin_mat_grad_symm-16"><span class="linenos">16</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="kin_mat_grad_symm-17"><a href="#kin_mat_grad_symm-17"><span class="linenos">17</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="kin_mat_grad_symm-18"><a href="#kin_mat_grad_symm-18"><span class="linenos">18</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="kin_mat_grad_symm-19"><a href="#kin_mat_grad_symm-19"><span class="linenos">19</span></a>
</span><span id="kin_mat_grad_symm-20"><a href="#kin_mat_grad_symm-20"><span class="linenos">20</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="kin_mat_grad_symm-21"><a href="#kin_mat_grad_symm-21"><span class="linenos">21</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-22"><a href="#kin_mat_grad_symm-22"><span class="linenos">22</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-23"><a href="#kin_mat_grad_symm-23"><span class="linenos">23</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-24"><a href="#kin_mat_grad_symm-24"><span class="linenos">24</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-25"><a href="#kin_mat_grad_symm-25"><span class="linenos">25</span></a>    <span class="n">bfs_atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_atoms</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-26"><a href="#kin_mat_grad_symm-26"><span class="linenos">26</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_atoms</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="kin_mat_grad_symm-27"><a href="#kin_mat_grad_symm-27"><span class="linenos">27</span></a>        
</span><span id="kin_mat_grad_symm-28"><a href="#kin_mat_grad_symm-28"><span class="linenos">28</span></a>
</span><span id="kin_mat_grad_symm-29"><a href="#kin_mat_grad_symm-29"><span class="linenos">29</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="kin_mat_grad_symm-30"><a href="#kin_mat_grad_symm-30"><span class="linenos">30</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="kin_mat_grad_symm-31"><a href="#kin_mat_grad_symm-31"><span class="linenos">31</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="kin_mat_grad_symm-32"><a href="#kin_mat_grad_symm-32"><span class="linenos">32</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="kin_mat_grad_symm-33"><a href="#kin_mat_grad_symm-33"><span class="linenos">33</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="kin_mat_grad_symm-34"><a href="#kin_mat_grad_symm-34"><span class="linenos">34</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="kin_mat_grad_symm-35"><a href="#kin_mat_grad_symm-35"><span class="linenos">35</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-36"><a href="#kin_mat_grad_symm-36"><span class="linenos">36</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-37"><a href="#kin_mat_grad_symm-37"><span class="linenos">37</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="kin_mat_grad_symm-38"><a href="#kin_mat_grad_symm-38"><span class="linenos">38</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="kin_mat_grad_symm-39"><a href="#kin_mat_grad_symm-39"><span class="linenos">39</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="kin_mat_grad_symm-40"><a href="#kin_mat_grad_symm-40"><span class="linenos">40</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_grad_symm-41"><a href="#kin_mat_grad_symm-41"><span class="linenos">41</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_grad_symm-42"><a href="#kin_mat_grad_symm-42"><span class="linenos">42</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="kin_mat_grad_symm-43"><a href="#kin_mat_grad_symm-43"><span class="linenos">43</span></a>        
</span><span id="kin_mat_grad_symm-44"><a href="#kin_mat_grad_symm-44"><span class="linenos">44</span></a>
</span><span id="kin_mat_grad_symm-45"><a href="#kin_mat_grad_symm-45"><span class="linenos">45</span></a>
</span><span id="kin_mat_grad_symm-46"><a href="#kin_mat_grad_symm-46"><span class="linenos">46</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="kin_mat_grad_symm-47"><a href="#kin_mat_grad_symm-47"><span class="linenos">47</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="kin_mat_grad_symm-48"><a href="#kin_mat_grad_symm-48"><span class="linenos">48</span></a>        
</span><span id="kin_mat_grad_symm-49"><a href="#kin_mat_grad_symm-49"><span class="linenos">49</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="kin_mat_grad_symm-50"><a href="#kin_mat_grad_symm-50"><span class="linenos">50</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="kin_mat_grad_symm-51"><a href="#kin_mat_grad_symm-51"><span class="linenos">51</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="kin_mat_grad_symm-52"><a href="#kin_mat_grad_symm-52"><span class="linenos">52</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="kin_mat_grad_symm-53"><a href="#kin_mat_grad_symm-53"><span class="linenos">53</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="kin_mat_grad_symm-54"><a href="#kin_mat_grad_symm-54"><span class="linenos">54</span></a>
</span><span id="kin_mat_grad_symm-55"><a href="#kin_mat_grad_symm-55"><span class="linenos">55</span></a>        
</span><span id="kin_mat_grad_symm-56"><a href="#kin_mat_grad_symm-56"><span class="linenos">56</span></a>    <span class="n">dT</span> <span class="o">=</span> <span class="n">kin_mat_symm_grad_internal_new</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="n">bfs_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="kin_mat_grad_symm-57"><a href="#kin_mat_grad_symm-57"><span class="linenos">57</span></a>    
</span><span id="kin_mat_grad_symm-58"><a href="#kin_mat_grad_symm-58"><span class="linenos">58</span></a>    <span class="k">return</span> <span class="n">dT</span> 
</span></pre></div>


    

                </section>
                <section id="nuc_mat_grad_symm">
                            <input id="nuc_mat_grad_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nuc_mat_grad_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basis</span>, </span><span class="param"><span class="n">mol</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nuc_mat_grad_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nuc_mat_grad_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nuc_mat_grad_symm-7"><a href="#nuc_mat_grad_symm-7"><span class="linenos"> 7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nuc_mat_grad_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="nuc_mat_grad_symm-8"><a href="#nuc_mat_grad_symm-8"><span class="linenos"> 8</span></a>    <span class="c1">#Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="nuc_mat_grad_symm-9"><a href="#nuc_mat_grad_symm-9"><span class="linenos"> 9</span></a>    <span class="c1">#Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="nuc_mat_grad_symm-10"><a href="#nuc_mat_grad_symm-10"><span class="linenos">10</span></a>    <span class="c1">#function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="nuc_mat_grad_symm-11"><a href="#nuc_mat_grad_symm-11"><span class="linenos">11</span></a>
</span><span id="nuc_mat_grad_symm-12"><a href="#nuc_mat_grad_symm-12"><span class="linenos">12</span></a>    <span class="c1"># This function calculates the nuclear matrix for a given basis object.</span>
</span><span id="nuc_mat_grad_symm-13"><a href="#nuc_mat_grad_symm-13"><span class="linenos">13</span></a>    <span class="c1"># The basis object holds the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="nuc_mat_grad_symm-14"><a href="#nuc_mat_grad_symm-14"><span class="linenos">14</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="nuc_mat_grad_symm-15"><a href="#nuc_mat_grad_symm-15"><span class="linenos">15</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows to be calculated.</span>
</span><span id="nuc_mat_grad_symm-16"><a href="#nuc_mat_grad_symm-16"><span class="linenos">16</span></a>    <span class="c1"># the third and fourth element give the range of columns to be calculated.</span>
</span><span id="nuc_mat_grad_symm-17"><a href="#nuc_mat_grad_symm-17"><span class="linenos">17</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="nuc_mat_grad_symm-18"><a href="#nuc_mat_grad_symm-18"><span class="linenos">18</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="nuc_mat_grad_symm-19"><a href="#nuc_mat_grad_symm-19"><span class="linenos">19</span></a>
</span><span id="nuc_mat_grad_symm-20"><a href="#nuc_mat_grad_symm-20"><span class="linenos">20</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="nuc_mat_grad_symm-21"><a href="#nuc_mat_grad_symm-21"><span class="linenos">21</span></a>    <span class="n">bfs_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-22"><a href="#nuc_mat_grad_symm-22"><span class="linenos">22</span></a>    <span class="n">bfs_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-23"><a href="#nuc_mat_grad_symm-23"><span class="linenos">23</span></a>    <span class="n">bfs_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-24"><a href="#nuc_mat_grad_symm-24"><span class="linenos">24</span></a>    <span class="n">bfs_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-25"><a href="#nuc_mat_grad_symm-25"><span class="linenos">25</span></a>    <span class="n">coordsBohrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-26"><a href="#nuc_mat_grad_symm-26"><span class="linenos">26</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-27"><a href="#nuc_mat_grad_symm-27"><span class="linenos">27</span></a>    <span class="n">natoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span>
</span><span id="nuc_mat_grad_symm-28"><a href="#nuc_mat_grad_symm-28"><span class="linenos">28</span></a>        
</span><span id="nuc_mat_grad_symm-29"><a href="#nuc_mat_grad_symm-29"><span class="linenos">29</span></a>
</span><span id="nuc_mat_grad_symm-30"><a href="#nuc_mat_grad_symm-30"><span class="linenos">30</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="nuc_mat_grad_symm-31"><a href="#nuc_mat_grad_symm-31"><span class="linenos">31</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="nuc_mat_grad_symm-32"><a href="#nuc_mat_grad_symm-32"><span class="linenos">32</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="nuc_mat_grad_symm-33"><a href="#nuc_mat_grad_symm-33"><span class="linenos">33</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="nuc_mat_grad_symm-34"><a href="#nuc_mat_grad_symm-34"><span class="linenos">34</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="nuc_mat_grad_symm-35"><a href="#nuc_mat_grad_symm-35"><span class="linenos">35</span></a>    <span class="n">maxnprim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="nuc_mat_grad_symm-36"><a href="#nuc_mat_grad_symm-36"><span class="linenos">36</span></a>    <span class="n">bfs_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-37"><a href="#nuc_mat_grad_symm-37"><span class="linenos">37</span></a>    <span class="n">bfs_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-38"><a href="#nuc_mat_grad_symm-38"><span class="linenos">38</span></a>    <span class="n">bfs_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprim</span><span class="p">])</span>
</span><span id="nuc_mat_grad_symm-39"><a href="#nuc_mat_grad_symm-39"><span class="linenos">39</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="nuc_mat_grad_symm-40"><a href="#nuc_mat_grad_symm-40"><span class="linenos">40</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="nuc_mat_grad_symm-41"><a href="#nuc_mat_grad_symm-41"><span class="linenos">41</span></a>            <span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_grad_symm-42"><a href="#nuc_mat_grad_symm-42"><span class="linenos">42</span></a>            <span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_grad_symm-43"><a href="#nuc_mat_grad_symm-43"><span class="linenos">43</span></a>            <span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="nuc_mat_grad_symm-44"><a href="#nuc_mat_grad_symm-44"><span class="linenos">44</span></a>        
</span><span id="nuc_mat_grad_symm-45"><a href="#nuc_mat_grad_symm-45"><span class="linenos">45</span></a>
</span><span id="nuc_mat_grad_symm-46"><a href="#nuc_mat_grad_symm-46"><span class="linenos">46</span></a>
</span><span id="nuc_mat_grad_symm-47"><a href="#nuc_mat_grad_symm-47"><span class="linenos">47</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_grad_symm-48"><a href="#nuc_mat_grad_symm-48"><span class="linenos">48</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="nuc_mat_grad_symm-49"><a href="#nuc_mat_grad_symm-49"><span class="linenos">49</span></a>        
</span><span id="nuc_mat_grad_symm-50"><a href="#nuc_mat_grad_symm-50"><span class="linenos">50</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="nuc_mat_grad_symm-51"><a href="#nuc_mat_grad_symm-51"><span class="linenos">51</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index</span>
</span><span id="nuc_mat_grad_symm-52"><a href="#nuc_mat_grad_symm-52"><span class="linenos">52</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index</span>
</span><span id="nuc_mat_grad_symm-53"><a href="#nuc_mat_grad_symm-53"><span class="linenos">53</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index</span>
</span><span id="nuc_mat_grad_symm-54"><a href="#nuc_mat_grad_symm-54"><span class="linenos">54</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index</span>
</span><span id="nuc_mat_grad_symm-55"><a href="#nuc_mat_grad_symm-55"><span class="linenos">55</span></a>
</span><span id="nuc_mat_grad_symm-56"><a href="#nuc_mat_grad_symm-56"><span class="linenos">56</span></a>    <span class="c1"># print([a,b,c,d])</span>
</span><span id="nuc_mat_grad_symm-57"><a href="#nuc_mat_grad_symm-57"><span class="linenos">57</span></a>
</span><span id="nuc_mat_grad_symm-58"><a href="#nuc_mat_grad_symm-58"><span class="linenos">58</span></a>    <span class="k">if</span> <span class="n">sqrt_ints4c2e_diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nuc_mat_grad_symm-59"><a href="#nuc_mat_grad_symm-59"><span class="linenos">59</span></a>        <span class="c1">#Create dummy array</span>
</span><span id="nuc_mat_grad_symm-60"><a href="#nuc_mat_grad_symm-60"><span class="linenos">60</span></a>        <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="nuc_mat_grad_symm-61"><a href="#nuc_mat_grad_symm-61"><span class="linenos">61</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="nuc_mat_grad_symm-62"><a href="#nuc_mat_grad_symm-62"><span class="linenos">62</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nuc_mat_grad_symm-63"><a href="#nuc_mat_grad_symm-63"><span class="linenos">63</span></a>        <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="nuc_mat_grad_symm-64"><a href="#nuc_mat_grad_symm-64"><span class="linenos">64</span></a>    
</span><span id="nuc_mat_grad_symm-65"><a href="#nuc_mat_grad_symm-65"><span class="linenos">65</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">nuc_mat_grad_symm_internal</span><span class="p">(</span><span class="n">bfs_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfs_coeffs</span><span class="p">,</span> <span class="n">bfs_prim_norms</span><span class="p">,</span> <span class="n">bfs_expnts</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordsBohrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">isSchwarz</span><span class="p">)</span>
</span><span id="nuc_mat_grad_symm-66"><a href="#nuc_mat_grad_symm-66"><span class="linenos">66</span></a>    
</span><span id="nuc_mat_grad_symm-67"><a href="#nuc_mat_grad_symm-67"><span class="linenos">67</span></a>    <span class="k">return</span> <span class="n">V</span> 
</span></pre></div>


    

                </section>
                <section id="cross_overlap_mat_symm">
                            <input id="cross_overlap_mat_symm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cross_overlap_mat_symm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">basisA</span>, </span><span class="param"><span class="n">basisB</span>, </span><span class="param"><span class="nb">slice</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="cross_overlap_mat_symm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#cross_overlap_mat_symm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="cross_overlap_mat_symm-7"><a href="#cross_overlap_mat_symm-7"><span class="linenos">  7</span></a><span class="k">def</span><span class="w"> </span><span class="nf">cross_overlap_mat_symm</span><span class="p">(</span><span class="n">basisA</span><span class="p">,</span> <span class="n">basisB</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="cross_overlap_mat_symm-8"><a href="#cross_overlap_mat_symm-8"><span class="linenos">  8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="cross_overlap_mat_symm-9"><a href="#cross_overlap_mat_symm-9"><span class="linenos">  9</span></a><span class="sd">    Compute the overlap matrix between two distinct basis sets.</span>
</span><span id="cross_overlap_mat_symm-10"><a href="#cross_overlap_mat_symm-10"><span class="linenos"> 10</span></a>
</span><span id="cross_overlap_mat_symm-11"><a href="#cross_overlap_mat_symm-11"><span class="linenos"> 11</span></a><span class="sd">    This function calculates the overlap integrals ⟨χ_i^A | χ_j^B⟩ between basis functions </span>
</span><span id="cross_overlap_mat_symm-12"><a href="#cross_overlap_mat_symm-12"><span class="linenos"> 12</span></a><span class="sd">    from two different basis sets, `basisA` and `basisB`. It supports block-wise computation </span>
</span><span id="cross_overlap_mat_symm-13"><a href="#cross_overlap_mat_symm-13"><span class="linenos"> 13</span></a><span class="sd">    of the matrix to save time and memory during large-scale calculations.</span>
</span><span id="cross_overlap_mat_symm-14"><a href="#cross_overlap_mat_symm-14"><span class="linenos"> 14</span></a>
</span><span id="cross_overlap_mat_symm-15"><a href="#cross_overlap_mat_symm-15"><span class="linenos"> 15</span></a><span class="sd">    S_{μν}^{AB} = ⟨ χ_μ^A | χ_ν^B ⟩</span>
</span><span id="cross_overlap_mat_symm-16"><a href="#cross_overlap_mat_symm-16"><span class="linenos"> 16</span></a>
</span><span id="cross_overlap_mat_symm-17"><a href="#cross_overlap_mat_symm-17"><span class="linenos"> 17</span></a><span class="sd">    All integrals are evaluated using a Numba-accelerated backend that converts </span>
</span><span id="cross_overlap_mat_symm-18"><a href="#cross_overlap_mat_symm-18"><span class="linenos"> 18</span></a><span class="sd">    required basis set properties into NumPy arrays for efficient performance.</span>
</span><span id="cross_overlap_mat_symm-19"><a href="#cross_overlap_mat_symm-19"><span class="linenos"> 19</span></a>
</span><span id="cross_overlap_mat_symm-20"><a href="#cross_overlap_mat_symm-20"><span class="linenos"> 20</span></a><span class="sd">    Parameters</span>
</span><span id="cross_overlap_mat_symm-21"><a href="#cross_overlap_mat_symm-21"><span class="linenos"> 21</span></a><span class="sd">    ----------</span>
</span><span id="cross_overlap_mat_symm-22"><a href="#cross_overlap_mat_symm-22"><span class="linenos"> 22</span></a><span class="sd">    basisA : object</span>
</span><span id="cross_overlap_mat_symm-23"><a href="#cross_overlap_mat_symm-23"><span class="linenos"> 23</span></a><span class="sd">        The first basis set object containing properties such as:</span>
</span><span id="cross_overlap_mat_symm-24"><a href="#cross_overlap_mat_symm-24"><span class="linenos"> 24</span></a><span class="sd">        - bfs_coords: Cartesian coordinates of centers</span>
</span><span id="cross_overlap_mat_symm-25"><a href="#cross_overlap_mat_symm-25"><span class="linenos"> 25</span></a><span class="sd">        - bfs_coeffs: Contraction coefficients</span>
</span><span id="cross_overlap_mat_symm-26"><a href="#cross_overlap_mat_symm-26"><span class="linenos"> 26</span></a><span class="sd">        - bfs_expnts: Gaussian exponents</span>
</span><span id="cross_overlap_mat_symm-27"><a href="#cross_overlap_mat_symm-27"><span class="linenos"> 27</span></a><span class="sd">        - bfs_prim_norms: Primitive normalization constants</span>
</span><span id="cross_overlap_mat_symm-28"><a href="#cross_overlap_mat_symm-28"><span class="linenos"> 28</span></a><span class="sd">        - bfs_contr_prim_norms: Contraction normalization constants</span>
</span><span id="cross_overlap_mat_symm-29"><a href="#cross_overlap_mat_symm-29"><span class="linenos"> 29</span></a><span class="sd">        - bfs_lmn: Angular momentum quantum numbers</span>
</span><span id="cross_overlap_mat_symm-30"><a href="#cross_overlap_mat_symm-30"><span class="linenos"> 30</span></a><span class="sd">        - bfs_nprim: Number of primitives per AO</span>
</span><span id="cross_overlap_mat_symm-31"><a href="#cross_overlap_mat_symm-31"><span class="linenos"> 31</span></a><span class="sd">        - bfs_nao: Total number of atomic orbitals</span>
</span><span id="cross_overlap_mat_symm-32"><a href="#cross_overlap_mat_symm-32"><span class="linenos"> 32</span></a>
</span><span id="cross_overlap_mat_symm-33"><a href="#cross_overlap_mat_symm-33"><span class="linenos"> 33</span></a><span class="sd">    basisB : object</span>
</span><span id="cross_overlap_mat_symm-34"><a href="#cross_overlap_mat_symm-34"><span class="linenos"> 34</span></a><span class="sd">        The second basis set object, structured identically to `basisA`.</span>
</span><span id="cross_overlap_mat_symm-35"><a href="#cross_overlap_mat_symm-35"><span class="linenos"> 35</span></a>
</span><span id="cross_overlap_mat_symm-36"><a href="#cross_overlap_mat_symm-36"><span class="linenos"> 36</span></a><span class="sd">    slice : list of int, optional</span>
</span><span id="cross_overlap_mat_symm-37"><a href="#cross_overlap_mat_symm-37"><span class="linenos"> 37</span></a><span class="sd">        A 4-element list `[start_row, end_row, start_col, end_col]` that defines</span>
</span><span id="cross_overlap_mat_symm-38"><a href="#cross_overlap_mat_symm-38"><span class="linenos"> 38</span></a><span class="sd">        a block of the full matrix to compute. Rows correspond to functions in `basisA`,</span>
</span><span id="cross_overlap_mat_symm-39"><a href="#cross_overlap_mat_symm-39"><span class="linenos"> 39</span></a><span class="sd">        and columns to those in `basisB`. If `None` (default), the full matrix is computed.</span>
</span><span id="cross_overlap_mat_symm-40"><a href="#cross_overlap_mat_symm-40"><span class="linenos"> 40</span></a>
</span><span id="cross_overlap_mat_symm-41"><a href="#cross_overlap_mat_symm-41"><span class="linenos"> 41</span></a><span class="sd">    Returns</span>
</span><span id="cross_overlap_mat_symm-42"><a href="#cross_overlap_mat_symm-42"><span class="linenos"> 42</span></a><span class="sd">    -------</span>
</span><span id="cross_overlap_mat_symm-43"><a href="#cross_overlap_mat_symm-43"><span class="linenos"> 43</span></a><span class="sd">    S : ndarray of shape (end_row - start_row, end_col - start_col)</span>
</span><span id="cross_overlap_mat_symm-44"><a href="#cross_overlap_mat_symm-44"><span class="linenos"> 44</span></a><span class="sd">        The computed cross overlap (sub)matrix.</span>
</span><span id="cross_overlap_mat_symm-45"><a href="#cross_overlap_mat_symm-45"><span class="linenos"> 45</span></a>
</span><span id="cross_overlap_mat_symm-46"><a href="#cross_overlap_mat_symm-46"><span class="linenos"> 46</span></a><span class="sd">    Notes</span>
</span><span id="cross_overlap_mat_symm-47"><a href="#cross_overlap_mat_symm-47"><span class="linenos"> 47</span></a><span class="sd">    -----</span>
</span><span id="cross_overlap_mat_symm-48"><a href="#cross_overlap_mat_symm-48"><span class="linenos"> 48</span></a><span class="sd">    The function handles contraction and normalization internally. Since Numba does not</span>
</span><span id="cross_overlap_mat_symm-49"><a href="#cross_overlap_mat_symm-49"><span class="linenos"> 49</span></a><span class="sd">    support jagged lists, the function reshapes data into padded 2D arrays based on</span>
</span><span id="cross_overlap_mat_symm-50"><a href="#cross_overlap_mat_symm-50"><span class="linenos"> 50</span></a><span class="sd">    the maximum number of primitives in either basis set.</span>
</span><span id="cross_overlap_mat_symm-51"><a href="#cross_overlap_mat_symm-51"><span class="linenos"> 51</span></a>
</span><span id="cross_overlap_mat_symm-52"><a href="#cross_overlap_mat_symm-52"><span class="linenos"> 52</span></a><span class="sd">    Examples</span>
</span><span id="cross_overlap_mat_symm-53"><a href="#cross_overlap_mat_symm-53"><span class="linenos"> 53</span></a><span class="sd">    --------</span>
</span><span id="cross_overlap_mat_symm-54"><a href="#cross_overlap_mat_symm-54"><span class="linenos"> 54</span></a><span class="sd">    &gt;&gt;&gt; S = cross_overlap_mat_symm(basisA, basisB)</span>
</span><span id="cross_overlap_mat_symm-55"><a href="#cross_overlap_mat_symm-55"><span class="linenos"> 55</span></a><span class="sd">    &gt;&gt;&gt; S_block = cross_overlap_mat_symm(basisA, basisB, slice=[0, 5, 0, 10])</span>
</span><span id="cross_overlap_mat_symm-56"><a href="#cross_overlap_mat_symm-56"><span class="linenos"> 56</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="cross_overlap_mat_symm-57"><a href="#cross_overlap_mat_symm-57"><span class="linenos"> 57</span></a>    <span class="c1"># Here the lists are converted to numpy arrays for better use with Numba.</span>
</span><span id="cross_overlap_mat_symm-58"><a href="#cross_overlap_mat_symm-58"><span class="linenos"> 58</span></a>    <span class="c1"># Once these conversions are done we pass these to a Numba decorated</span>
</span><span id="cross_overlap_mat_symm-59"><a href="#cross_overlap_mat_symm-59"><span class="linenos"> 59</span></a>    <span class="c1"># function that uses prange, etc. to calculate the matrix efficiently.</span>
</span><span id="cross_overlap_mat_symm-60"><a href="#cross_overlap_mat_symm-60"><span class="linenos"> 60</span></a>
</span><span id="cross_overlap_mat_symm-61"><a href="#cross_overlap_mat_symm-61"><span class="linenos"> 61</span></a>    <span class="c1"># This function calculates the overlap matrix between two basis objects: basisA and basisB.</span>
</span><span id="cross_overlap_mat_symm-62"><a href="#cross_overlap_mat_symm-62"><span class="linenos"> 62</span></a>    <span class="c1"># The basis objects hold the information of basis functions like: exponents, coeffs, etc.</span>
</span><span id="cross_overlap_mat_symm-63"><a href="#cross_overlap_mat_symm-63"><span class="linenos"> 63</span></a>    <span class="c1"># It is possible to only calculate a slice (block) of the complete matrix.</span>
</span><span id="cross_overlap_mat_symm-64"><a href="#cross_overlap_mat_symm-64"><span class="linenos"> 64</span></a>    <span class="c1"># slice is a 4 element list whose first and second elements give the range of the rows (basisA) to be calculated.</span>
</span><span id="cross_overlap_mat_symm-65"><a href="#cross_overlap_mat_symm-65"><span class="linenos"> 65</span></a>    <span class="c1"># the third and fourth element give the range of columns (basisB) to be calculated.</span>
</span><span id="cross_overlap_mat_symm-66"><a href="#cross_overlap_mat_symm-66"><span class="linenos"> 66</span></a>    <span class="c1"># slice = [start_row, end_row, start_col, end_col]</span>
</span><span id="cross_overlap_mat_symm-67"><a href="#cross_overlap_mat_symm-67"><span class="linenos"> 67</span></a>    <span class="c1"># The integrals are performed using the formulas</span>
</span><span id="cross_overlap_mat_symm-68"><a href="#cross_overlap_mat_symm-68"><span class="linenos"> 68</span></a>
</span><span id="cross_overlap_mat_symm-69"><a href="#cross_overlap_mat_symm-69"><span class="linenos"> 69</span></a>    <span class="c1">#We convert the required properties to numpy arrays as this is what Numba likes.</span>
</span><span id="cross_overlap_mat_symm-70"><a href="#cross_overlap_mat_symm-70"><span class="linenos"> 70</span></a>    <span class="n">bfsA_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-71"><a href="#cross_overlap_mat_symm-71"><span class="linenos"> 71</span></a>    <span class="n">bfsA_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-72"><a href="#cross_overlap_mat_symm-72"><span class="linenos"> 72</span></a>    <span class="n">bfsA_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-73"><a href="#cross_overlap_mat_symm-73"><span class="linenos"> 73</span></a>    <span class="n">bfsA_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-74"><a href="#cross_overlap_mat_symm-74"><span class="linenos"> 74</span></a>    
</span><span id="cross_overlap_mat_symm-75"><a href="#cross_overlap_mat_symm-75"><span class="linenos"> 75</span></a>    <span class="n">bfsB_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_coords</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-76"><a href="#cross_overlap_mat_symm-76"><span class="linenos"> 76</span></a>    <span class="n">bfsB_contr_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_contr_prim_norms</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-77"><a href="#cross_overlap_mat_symm-77"><span class="linenos"> 77</span></a>    <span class="n">bfsB_lmn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_lmn</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-78"><a href="#cross_overlap_mat_symm-78"><span class="linenos"> 78</span></a>    <span class="n">bfsB_nprim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-79"><a href="#cross_overlap_mat_symm-79"><span class="linenos"> 79</span></a>        
</span><span id="cross_overlap_mat_symm-80"><a href="#cross_overlap_mat_symm-80"><span class="linenos"> 80</span></a>
</span><span id="cross_overlap_mat_symm-81"><a href="#cross_overlap_mat_symm-81"><span class="linenos"> 81</span></a>    <span class="c1">#The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="cross_overlap_mat_symm-82"><a href="#cross_overlap_mat_symm-82"><span class="linenos"> 82</span></a>    <span class="c1">#Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="cross_overlap_mat_symm-83"><a href="#cross_overlap_mat_symm-83"><span class="linenos"> 83</span></a>    <span class="c1">#So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="cross_overlap_mat_symm-84"><a href="#cross_overlap_mat_symm-84"><span class="linenos"> 84</span></a>    <span class="c1">#that the second dimension is that of the largest list. So that</span>
</span><span id="cross_overlap_mat_symm-85"><a href="#cross_overlap_mat_symm-85"><span class="linenos"> 85</span></a>    <span class="c1">#it can accomadate all the lists.</span>
</span><span id="cross_overlap_mat_symm-86"><a href="#cross_overlap_mat_symm-86"><span class="linenos"> 86</span></a>    <span class="n">maxnprimA</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="cross_overlap_mat_symm-87"><a href="#cross_overlap_mat_symm-87"><span class="linenos"> 87</span></a>    <span class="n">bfsA_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimA</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-88"><a href="#cross_overlap_mat_symm-88"><span class="linenos"> 88</span></a>    <span class="n">bfsA_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimA</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-89"><a href="#cross_overlap_mat_symm-89"><span class="linenos"> 89</span></a>    <span class="n">bfsA_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimA</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-90"><a href="#cross_overlap_mat_symm-90"><span class="linenos"> 90</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="cross_overlap_mat_symm-91"><a href="#cross_overlap_mat_symm-91"><span class="linenos"> 91</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="cross_overlap_mat_symm-92"><a href="#cross_overlap_mat_symm-92"><span class="linenos"> 92</span></a>            <span class="n">bfsA_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisA</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-93"><a href="#cross_overlap_mat_symm-93"><span class="linenos"> 93</span></a>            <span class="n">bfsA_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisA</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-94"><a href="#cross_overlap_mat_symm-94"><span class="linenos"> 94</span></a>            <span class="n">bfsA_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisA</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-95"><a href="#cross_overlap_mat_symm-95"><span class="linenos"> 95</span></a>    
</span><span id="cross_overlap_mat_symm-96"><a href="#cross_overlap_mat_symm-96"><span class="linenos"> 96</span></a>    <span class="n">maxnprimB</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">)</span>
</span><span id="cross_overlap_mat_symm-97"><a href="#cross_overlap_mat_symm-97"><span class="linenos"> 97</span></a>    <span class="n">bfsB_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimB</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-98"><a href="#cross_overlap_mat_symm-98"><span class="linenos"> 98</span></a>    <span class="n">bfsB_expnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimB</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-99"><a href="#cross_overlap_mat_symm-99"><span class="linenos"> 99</span></a>    <span class="n">bfsB_prim_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">maxnprimB</span><span class="p">])</span>
</span><span id="cross_overlap_mat_symm-100"><a href="#cross_overlap_mat_symm-100"><span class="linenos">100</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">):</span>
</span><span id="cross_overlap_mat_symm-101"><a href="#cross_overlap_mat_symm-101"><span class="linenos">101</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nprim</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
</span><span id="cross_overlap_mat_symm-102"><a href="#cross_overlap_mat_symm-102"><span class="linenos">102</span></a>            <span class="n">bfsB_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisB</span><span class="o">.</span><span class="n">bfs_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-103"><a href="#cross_overlap_mat_symm-103"><span class="linenos">103</span></a>            <span class="n">bfsB_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisB</span><span class="o">.</span><span class="n">bfs_expnts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-104"><a href="#cross_overlap_mat_symm-104"><span class="linenos">104</span></a>            <span class="n">bfsB_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basisB</span><span class="o">.</span><span class="n">bfs_prim_norms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-105"><a href="#cross_overlap_mat_symm-105"><span class="linenos">105</span></a>        
</span><span id="cross_overlap_mat_symm-106"><a href="#cross_overlap_mat_symm-106"><span class="linenos">106</span></a>
</span><span id="cross_overlap_mat_symm-107"><a href="#cross_overlap_mat_symm-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="cross_overlap_mat_symm-108"><a href="#cross_overlap_mat_symm-108"><span class="linenos">108</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">basisA</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basisB</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">]</span>
</span><span id="cross_overlap_mat_symm-109"><a href="#cross_overlap_mat_symm-109"><span class="linenos">109</span></a>        
</span><span id="cross_overlap_mat_symm-110"><a href="#cross_overlap_mat_symm-110"><span class="linenos">110</span></a>    <span class="c1">#Limits for the calculation of overlap integrals</span>
</span><span id="cross_overlap_mat_symm-111"><a href="#cross_overlap_mat_symm-111"><span class="linenos">111</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#row start index (basisA)</span>
</span><span id="cross_overlap_mat_symm-112"><a href="#cross_overlap_mat_symm-112"><span class="linenos">112</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#row end index (basisA)</span>
</span><span id="cross_overlap_mat_symm-113"><a href="#cross_overlap_mat_symm-113"><span class="linenos">113</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#column start index (basisB)</span>
</span><span id="cross_overlap_mat_symm-114"><a href="#cross_overlap_mat_symm-114"><span class="linenos">114</span></a>    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">slice</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#column end index (basisB)</span>
</span><span id="cross_overlap_mat_symm-115"><a href="#cross_overlap_mat_symm-115"><span class="linenos">115</span></a>        
</span><span id="cross_overlap_mat_symm-116"><a href="#cross_overlap_mat_symm-116"><span class="linenos">116</span></a>    <span class="n">S</span> <span class="o">=</span> <span class="n">cross_overlap_mat_internal</span><span class="p">(</span><span class="n">bfsA_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsA_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsA_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsA_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsA_coeffs</span><span class="p">,</span> <span class="n">bfsA_prim_norms</span><span class="p">,</span> <span class="n">bfsA_expnts</span><span class="p">,</span>
</span><span id="cross_overlap_mat_symm-117"><a href="#cross_overlap_mat_symm-117"><span class="linenos">117</span></a>                                       <span class="n">bfsB_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsB_contr_prim_norms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsB_lmn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsB_nprim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bfsB_coeffs</span><span class="p">,</span> <span class="n">bfsB_prim_norms</span><span class="p">,</span> <span class="n">bfsB_expnts</span><span class="p">,</span>
</span><span id="cross_overlap_mat_symm-118"><a href="#cross_overlap_mat_symm-118"><span class="linenos">118</span></a>                                       <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="cross_overlap_mat_symm-119"><a href="#cross_overlap_mat_symm-119"><span class="linenos">119</span></a>    <span class="k">return</span> <span class="n">S</span>
</span></pre></div>


            <div class="docstring"><p>Compute the overlap matrix between two distinct basis sets.</p>

<p>This function calculates the overlap integrals ⟨χ_i^A | χ_j^B⟩ between basis functions 
from two different basis sets, <code>basisA</code> and <code>basisB</code>. It supports block-wise computation 
of the matrix to save time and memory during large-scale calculations.</p>

<p>S_{μν}^{AB} = ⟨ χ_μ^A | χ_ν^B ⟩</p>

<p>All integrals are evaluated using a Numba-accelerated backend that converts 
required basis set properties into NumPy arrays for efficient performance.</p>

<h2 id="parameters">Parameters</h2>

<p>basisA : object
    The first basis set object containing properties such as:
    - bfs_coords: Cartesian coordinates of centers
    - bfs_coeffs: Contraction coefficients
    - bfs_expnts: Gaussian exponents
    - bfs_prim_norms: Primitive normalization constants
    - bfs_contr_prim_norms: Contraction normalization constants
    - bfs_lmn: Angular momentum quantum numbers
    - bfs_nprim: Number of primitives per AO
    - bfs_nao: Total number of atomic orbitals</p>

<p>basisB : object
    The second basis set object, structured identically to <code>basisA</code>.</p>

<p>slice : list of int, optional
    A 4-element list <code>[start_row, end_row, start_col, end_col]</code> that defines
    a block of the full matrix to compute. Rows correspond to functions in <code>basisA</code>,
    and columns to those in <code>basisB</code>. If <code>None</code> (default), the full matrix is computed.</p>

<h2 id="returns">Returns</h2>

<p>S : ndarray of shape (end_row - start_row, end_col - start_col)
    The computed cross overlap (sub)matrix.</p>

<h2 id="notes">Notes</h2>

<p>The function handles contraction and normalization internally. Since Numba does not
support jagged lists, the function reshapes data into padded 2D arrays based on
the maximum number of primitives in either basis set.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">S</span> <span class="o">=</span> <span class="n">cross_overlap_mat_symm</span><span class="p">(</span><span class="n">basisA</span><span class="p">,</span> <span class="n">basisB</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">S_block</span> <span class="o">=</span> <span class="n">cross_overlap_mat_symm</span><span class="p">(</span><span class="n">basisA</span><span class="p">,</span> <span class="n">basisB</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</code></pre>
</div>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>