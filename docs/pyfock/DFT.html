<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>pyfock.DFT API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyfock.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyfock</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#DFT">DFT</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DFT.__init__">DFT</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.mol">mol</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.basis">basis</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.dmat_guess_method">dmat_guess_method</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.dmat">dmat</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.xc">xc</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.KSmats">KSmats</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.errVecs">errVecs</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.diisSpace">diisSpace</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.conv_crit">conv_crit</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.max_itr">max_itr</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.ncores">ncores</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.grids">grids</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.gridsLevel">gridsLevel</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.isDF">isDF</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.auxbasis">auxbasis</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.rys">rys</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.DF_algo">DF_algo</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.blocksize">blocksize</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.XC_algo">XC_algo</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.debug">debug</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.sortGrids">sortGrids</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.save_ao_values">save_ao_values</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.xc_bf_screen">xc_bf_screen</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.threshold_schwarz">threshold_schwarz</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.strict_schwarz">strict_schwarz</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.cholesky">cholesky</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.orthogonalize">orthogonalize</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.sao">sao</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.use_gpu">use_gpu</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.keep_ao_in_gpu">keep_ao_in_gpu</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.use_libxc">use_libxc</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.n_streams">n_streams</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.n_gpus">n_gpus</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.free_gpu_mem">free_gpu_mem</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.threads_x">threads_x</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.threads_y">threads_y</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.dynamic_precision">dynamic_precision</a>
                        </li>
                        <li>
                                <a class="variable" href="#DFT.keep_ints3c2e_in_gpu">keep_ints3c2e_in_gpu</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.nuclear_rep_energy">nuclear_rep_energy</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.gen_dm">gen_dm</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.getOcc">getOcc</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.gen_dm_cupy">gen_dm_cupy</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.getOcc_cupy">getOcc_cupy</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.solve">solve</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.solve_cupy">solve_cupy</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.getCoreH">getCoreH</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.guessCoreH">guessCoreH</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.DIIS">DIIS</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.DIIS_cupy">DIIS_cupy</a>
                        </li>
                        <li>
                                <a class="function" href="#DFT.scf">scf</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyfock.html">pyfock</a><wbr>.DFT    </h1>

                
                        <input id="mod-DFT-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-DFT-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># DFT.py</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># Author: Manas Sharma (manassharma07@live.com)</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># This is a part of CrysX (https://bragitoff.com/crysx)</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1">#</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="c1">#</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="c1">#  .d8888b.                            Y88b   d88P       8888888b.           8888888888                888      </span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1"># d88P  Y88b                            Y88b d88P        888   Y88b          888                       888      </span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># 888    888                             Y88o88P         888    888          888                       888      </span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1"># 888        888d888 888  888 .d8888b     Y888P          888   d88P 888  888 8888888  .d88b.   .d8888b 888  888 </span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="c1"># 888        888P&quot;   888  888 88K         d888b          8888888P&quot;  888  888 888     d88&quot;&quot;88b d88P&quot;    888 .88P </span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="c1"># 888    888 888     888  888 &quot;Y8888b.   d88888b  888888 888        888  888 888     888  888 888      888888K  </span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="c1"># Y88b  d88P 888     Y88b 888      X88  d88P Y88b        888        Y88b 888 888     Y88..88P Y88b.    888 &quot;88b </span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="c1">#  &quot;Y8888P&quot;  888      &quot;Y88888  88888P&#39; d88P   Y88b       888         &quot;Y88888 888      &quot;Y88P&quot;   &quot;Y8888P 888  888 </span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="c1">#                         888                                            888                                    </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="c1">#                    Y8b d88P                                       Y8b d88P                                    </span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="c1">#                     &quot;Y88P&quot;                                         &quot;Y88P&quot;                                       </span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="kn">import</span> <span class="n">T</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyfock.Utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_pyfock_logo</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="c1"># Print system information </span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyfock.Utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_sys_info</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyfock.Mol</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">Mol</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyfock.Basis</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">Basis</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="c1"># import pyfock.Integrals as Integrals</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyfock.Integrals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">Integrals</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyfock.Grids</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">Grids</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">threadpoolctl</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadpoolController</span><span class="p">,</span> <span class="n">threadpool_info</span><span class="p">,</span> <span class="n">threadpool_limits</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="c1"># controller = ThreadpoolController()</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">eig</span><span class="p">,</span> <span class="n">multi_dot</span> <span class="k">as</span> <span class="n">dot</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span> 
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">timeit</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numba</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">opt_einsum</span><span class="w"> </span><span class="kn">import</span> <span class="n">contract</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pylibxc</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="c1"># import sparse</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="c1"># import dask.array as da</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">csc_matrix</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="c1"># from memory_profiler import profile</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">cuda</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numexpr</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">cupy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">cupy</span><span class="w"> </span><span class="kn">import</span> <span class="n">fuse</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">cupyx</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">CUPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cupy is not installed. GPU acceleration is not availble.&#39;</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">CUPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="k">pass</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyfock.DFT_Helper_Coulomb</span><span class="w"> </span><span class="kn">import</span> <span class="n">density_fitting_prelims_for_DFT_development</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyfock.DFT_Helper_Coulomb</span><span class="w"> </span><span class="kn">import</span> <span class="n">Jmat_from_density_fitting</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="c1"># @njit(parallel=True, cache=True, fastmath=True, error_model=&quot;numpy&quot;)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="c1"># def compute_B(errVecs):</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="c1">#     nKS = errVecs.shape[0]</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="c1">#     B = np.zeros((nKS + 1, nKS + 1))</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="c1">#     B[-1, :] = B[:, -1] = -1.0</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="c1">#     B[-1, -1] = 0.0</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="c1">#     for i in prange(nKS):</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="c1">#         # errVec_i_conj_T = errVecs[i].conj().T</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="c1">#         errVec_i_conj_T = errVecs[i].T</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="c1">#         for j in range(i + 1):</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="c1">#             # B[i, j] = B[j, i] = np.real(np.trace(np.dot(errVec_i_conj_T, errVecs[j])))</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="c1">#             B[i, j] = B[j, i] = np.trace(np.dot(errVec_i_conj_T, errVecs[j]))</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="c1">#     return B</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DFT</span><span class="p">:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    A class for performing Density Functional Theory (DFT) calculations </span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    with optional support for density fitting (DF), GPU acceleration, and LibXC.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    Parameters</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    ----------</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">    mol : Molecule</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        Molecular object on which the DFT calculation is to be performed.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    </span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">    basis : Basis</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        Orbital basis set used for the SCF calculation.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">    auxbasis : Basis, optional</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">        Auxiliary basis set for density fitting (DF). If None, a default will be assigned.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">    conv_crit : float, optional</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        Convergence criterion for the SCF cycle in Hartrees (default is 1e-7).</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    dmat_guess_method : str, optional</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        Method for the initial density matrix guess (e.g., &#39;core&#39;, &#39;huckel&#39;).</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">    xc : list or str, optional</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        Exchange-correlation functional specification. If None, defaults to LDA (`[1, 7]`).</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">    grids : object, optional</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        Precomputed numerical integration grids. If None, they will be generated automatically.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">    gridsLevel : int, optional</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        Level of numerical integration grid refinement (default is 3).</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">    blocksize : int, optional</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        Block size for XC grid evaluations. Defaults depend on whether GPU is used.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    save_ao_values : bool, optional</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        If True, saves AO values to reuse during XC evaluation. Increases speed but uses more memory.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">    use_gpu : bool, optional</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        Whether to use GPU acceleration.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">    ncores : int, optional</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        Number of CPU cores to use (default is 2).</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">    Attributes</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">    ----------</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">    dmat : ndarray</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        Initial guess for the density matrix, will be computed during setup.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    KSmats : list</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        List of KohnSham matrices used in DIIS extrapolation.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">    errVecs : list</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">        List of error vectors for DIIS.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">    max_itr : int</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">        Maximum number of SCF iterations (default is 50).</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">    isDF : bool</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">        Whether to use density fitting for Coulomb integrals.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">    rys : bool</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">        Whether to use Rys quadrature for evaluating electron repulsion integrals.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    DF_algo : int</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        Algorithm selector for DF (reserved for developer use).</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    XC_algo : int</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">        Algorithm selector for XC evaluation (2 for CPU, 3 for GPU).</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    sortGrids : bool</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        Whether to sort DFT integration grids (not recommended).</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    xc_bf_screen : bool</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        Enable basis function screening for XC term evaluation.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    threshold_schwarz : float</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        Threshold for Schwarz screening (default is 1e-9).</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">    strict_schwarz : bool</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        If True, applies stricter Schwarz screening.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">    cholesky : bool</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        If True, uses Cholesky decomposition for DF.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    orthogonalize : bool</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        If True, orthogonalizes AO basis functions.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">    sao : bool</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">        If True, uses SAO basis instead of CAO basis.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">    keep_ao_in_gpu : bool</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        Whether to retain AO values in GPU memory during SCF (if `save_ao_values` is True).</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">    use_libxc : bool</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">        Whether to use LibXC for XC functional evaluation (recommended off for GPU).</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">    n_streams : int</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        Number of CUDA streams to use (if applicable).</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">    n_gpus : int</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        Number of GPUs to use.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">    free_gpu_mem : bool</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        Whether to forcibly free GPU memory after use.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">    max_threads_per_block : int</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        Maximum threads per CUDA block supported by the device.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">    threads_x : int</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">        CUDA thread configuration (X dimension).</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    threads_y : int</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        CUDA thread configuration (Y dimension).</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    dynamic_precision : bool</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">        Whether to use precision switching during XC evaluation for performance gains.</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">    keep_ints3c2e_in_gpu : bool</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">        Whether to keep 3-center 2-electron integrals in GPU memory to avoid transfers.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">    debug : bool</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        If True, prints debugging output during DFT calculations.</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">    Notes</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">    -----</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">    - This class supports SCF DFT calculations with density fitting (DF).</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">    - GPU support is optional and provides significant speed-up for large systems.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">    - The class is tightly integrated with PyFock and LibXC libraries.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">    Examples</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">    --------</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">    &gt;&gt;&gt; mol = Molecule(...)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">    &gt;&gt;&gt; basis = Basis(mol, ...)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">    &gt;&gt;&gt; dft = DFT(mol, basis, xc=&#39;PBE&#39;, use_gpu=True)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">    &gt;&gt;&gt; dft.run_scf()</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv_crit</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">dmat_guess_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                <span class="n">xc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                <span class="n">save_ao_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> 
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>         
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Molecular object for which the DFT calculation will be performed &quot;&quot;&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Mol object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object for corresponding to the molecule for the DFT calculation &quot;&quot;&quot;</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Basis object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="n">dmat_guess_method</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial guess for the density matrix &quot;&quot;&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="s1">&#39;core&#39;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial density matrix guess for SCF &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Exchange-Correlation Functional &quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="c1">#LDA</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XC not specified, defaulting to LDA functional (LibXC codes: 1, 7)&quot;</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="c1"># DIIS</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span> <span class="o">=</span> <span class="n">conv_crit</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Convergence criterion for SCF (in Hartrees) &quot;&quot;&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="c1"># if self.conv_crit is None:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="c1">#     self.conv_crit = 1.0E-7</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span> <span class="o">=</span> <span class="mi">50</span> 
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Maximum number of iterations for SCF &quot;&quot;&quot;</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="c1"># if self.max_itr is None:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="c1">#     self.max_itr = 50</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="n">ncores</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of cores to be used for DFT calculation &quot;&quot;&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grids</span> <span class="o">=</span> <span class="n">grids</span> 
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation (If None or not supplied, will be generated using NumGrid) &quot;&quot;&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span> <span class="o">=</span> <span class="n">gridsLevel</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation &quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use density fitting (DF) for two-electron Coulomb integrals. This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="o">=</span> <span class="n">auxbasis</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object to be used as the auxiliary basis for DF &quot;&quot;&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="n">auxbasis</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-universal-jfit&#39;</span><span class="p">)})</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rys</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use rys quadrature for the evaluation of two electron integrals (with and without DF)&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">blocksize</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Block size for the evaulation of XC term on grids. For CPUs a value of ~5000 is recommended. For GPUs, a value &gt;20480 is recommended. &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. The algorithm for XC evaluation should be 2 for CPU and 3 for GPU.&quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span> 
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn on printing debug statements &quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable/Disable sorting of DFT grids. Doesn&#39;t seem to offer any signficant advantage.&quot;&quot;&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span> <span class="o">=</span> <span class="n">save_ao_values</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to save atomic orbital (AO) values for reuse during XC evaluation. Improves performance but requires more memory. &quot;&quot;&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable screening of basis functions for XC term evaluation to reduce computation time drastically. &quot;&quot;&quot;</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="mf">1e-09</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Threshold for Schwarz screening of two-electron integrals. Smaller values increase accuracy but reduce sparsity. &quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; If True, enforce stricter Schwarz screening to aggressively eliminate small two-electron integrals. &quot;&quot;&quot;</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use Cholesky decomposition for DF. Slightly speeds up calculations. &quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply orthogonalization to the AO basis. Should be True for most standard calculations. &quot;&quot;&quot;</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="c1"># CAO or SAO</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sao</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use SAO basis or CAO basis. Default is CAO basis. &quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="c1"># GPU acceleration</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="n">use_gpu</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use GPU acceleration or not &quot;&quot;&quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the atomic orbitals for XC evaluation in GPU memory or CPU memory. Only relevant if save_ao_values = True. &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use LibXC&#39;s version of XC functionals or PyFock implementations. </span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">        Only relevant when GPU is used. For GPU calculations it is recommended to use PyFock </span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">        implementation as it avoids CPU-GPU transfers.&quot;&quot;&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of GPUs to be used &quot;&quot;&quot;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether the GPU memory should be freed by force or not&quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">64</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Only for the XC term</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use dynamic precision switching for XC term or not &quot;&quot;&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the 3c2e integrals in GPU memory or not. </span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        Recommended to keep in GPU memory to avoid CPU-GPU transfers at each iteration.&quot;&quot;&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="c1"># self.max_threads_per_block = 1024</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="c1"># self.threads_x = 64</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="c1"># self.threads_y = 16</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="c1"># if self.use_gpu:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="c1">#     try:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="c1">#         global cp</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="c1">#         global cupy_scipy</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="c1">#         import cupy as cp</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="c1">#         import cupyx.scipy as cupy_scipy</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="c1">#         # from cupy.linalg import eig, multi_dot as dot</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="c1">#     except ModuleNotFoundError:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="c1">#         print(&#39;Cupy was not found!&#39;)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>    <span class="c1"># def removeLinearDep(self, H, S):</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="c1">#     return 1 </span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nuclear_rep_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">        Compute the nuclear-nuclear repulsion energy.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        Parameters</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        ----------</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">            Molecule object containing nuclear coordinates and charges. </span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">            If None, uses `self.mol`.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        Returns</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">        -------</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">        float</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">            The nuclear repulsion energy in Hartrees.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="c1"># Nuclear-nuclear energy</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>    
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">):</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                    <span class="n">dist</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="k">return</span> <span class="n">e</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>    <span class="c1"># full density matrix for RKS/RHF</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        Generate the density matrix from molecular orbital coefficients and occupations.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">        Parameters</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">        ----------</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        mo_coeff : ndarray</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">            Molecular orbital coefficient matrix.</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        mo_occ : ndarray</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">            Array of MO occupation numbers.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        Returns</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        -------</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        ndarray</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">            Density matrix (RHF/RKS type).</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>   
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>    
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        Assign occupation numbers to molecular orbitals based on their energies.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">        Parameters</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        ----------</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        mol : Molecule</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">            Molecule object to extract the number of electrons.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        energy_mo : ndarray</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">            Array of MO energies.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        coeff_mo : ndarray</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">            Array of MO coefficients (not used but kept for compatibility).</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        Returns</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        -------</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">        ndarray</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">            Array of MO occupations (0 or 2 for RHF).</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>    
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">        Generate the density matrix using CuPy for GPU acceleration.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">        Parameters</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        ----------</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">        mo_coeff : cp.ndarray</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">            Molecular orbital coefficient matrix (on GPU).</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        mo_occ : cp.ndarray</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">            Array of MO occupation numbers (on GPU).</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">        Returns</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">        -------</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">        cp.ndarray</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">            Density matrix (RHF/RKS type) computed on the GPU.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>    
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">        Assign occupation numbers to MOs using CuPy (for GPU-based calculations).</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        Parameters</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">        ----------</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        mol : Molecule</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">            Molecule object to determine number of electrons.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        energy_mo : cp.ndarray</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">            MO energy array on the GPU.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        coeff_mo : cp.ndarray</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">            MO coefficients array on the GPU (not used).</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        Returns</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        -------</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        cp.ndarray</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">            Array of MO occupations (on GPU).</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>    
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        Solve the generalized or canonical eigenvalue equation.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        Parameters</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        ----------</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        H : ndarray</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">            Hamiltonian matrix.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">        S : ndarray</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        x : ndarray, optional</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">            Transformation matrix (if already computed).</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">        Returns</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        -------</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        tuple of (ndarray, ndarray)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">            Eigenvalues and eigenvectors of the system.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="c1">#Solve the generalized eigenvalue equation HC = SCE</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="n">xHx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="c1">#Solve the canonical eigenvalue equation HC = CE</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xHx</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        Solve the generalized eigenvalue problem using CuPy (GPU).</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        Parameters</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        ----------</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        H : cp.ndarray</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">            Hamiltonian matrix (on GPU).</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        Returns</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">        -------</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">        tuple of (cp.ndarray, cp.ndarray)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">            Eigenvalues and eigenvectors (on GPU).</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="n">xhx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="c1">#Solve the canonical eigenvalue equation HC = SCE</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xhx</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">cp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="sd">        Compute the core Hamiltonian matrix (T + V).</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">        Parameters</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">        ----------</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">            Molecule object.</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">            Basis set object.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">        Returns</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        -------</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">        ndarray</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">            Core Hamiltonian matrix.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="c1">#Get the core Hamiltonian</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="n">nao</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span> 
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="n">Vmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="n">Tmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">Vmat</span> <span class="o">+</span> <span class="n">Tmat</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="k">return</span> <span class="n">H</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">guessCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        Generate a guess density matrix using the core Hamiltonian.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        Parameters</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        ----------</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">            Molecule object.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">            Basis set.</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">        Hcore : ndarray, optional</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">            Core Hamiltonian. If None, it will be computed.</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        S : ndarray, optional</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">            Overlap matrix. If None, it will be computed.</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">        Returns</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        -------</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        ndarray</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">            Initial guess density matrix.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="c1">#Get a guess for the density matrix using the core Hamiltonian</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="k">if</span> <span class="n">Hcore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="n">Hcore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="k">if</span> <span class="n">S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hcore</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="c1"># print(eigvalues)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="c1"># print(mo_occ)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="k">return</span> <span class="n">dmat</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>    
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">        Perform Direct Inversion in the Iterative Subspace (DIIS) to improve SCF convergence.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">        Adapted from</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">        ----------</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">        Parameters</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">        ----------</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        S : ndarray</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">        D : ndarray</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">            Density matrix.</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        F : ndarray</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">            Fock matrix.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        Returns</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        -------</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        ndarray</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">            DIIS-extrapolated Fock matrix.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">dot</span><span class="p">([</span><span class="n">F</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">S</span><span class="p">])</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="c1"># SDF =   np.conjugate(FDS).T </span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="c1"># for i in range(nKS):</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="c1">#     for j in range(i+1):</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="c1">#         print(self.errVecs[i].shape)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="c1">#         B[i,j] = np.real(np.dot(np.conjugate(self.errVecs[i]).T, self.errVecs[j]))</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>        <span class="c1">#         B[j,i] = B[i,j]</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                                                    
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(weight * KS)&#39;</span><span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>    
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        Perform DIIS on GPU using CuPy to accelerate SCF convergence.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        Adapted from</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        ----------</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">        Parameters</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        ----------</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        D : cp.ndarray</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">            Density matrix (on GPU).</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">        F : cp.ndarray</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">            Fock matrix (on GPU).</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">        Returns</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        -------</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        cp.ndarray</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">            DIIS-extrapolated Fock matrix (on GPU).</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">F</span> <span class="o">@</span> <span class="n">D</span> <span class="o">@</span> <span class="n">S</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                                                    
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="k">assert</span> <span class="n">cp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">KS</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="c1"># @profile</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">        Perform Self-Consistent Field (SCF) calculation for Density Functional Theory (DFT).</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        </span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        This method implements a complete DFT SCF procedure including:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        - One-electron integral calculation (overlap, kinetic, nuclear attraction)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        - Two-electron integral calculation (4-center ERIs or density fitting)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        - Grid generation and pruning for exchange-correlation evaluation</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        - Iterative SCF cycles with DIIS convergence acceleration</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        - Exchange-correlation energy and potential evaluation using LibXC</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">        - GPU acceleration support for performance-critical operations</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">        </span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        The implementation supports multiple algorithmic variants:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">        - Density fitting (DF)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">        - Schwarz screening for integral sparsity</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a><span class="sd">        - Multiple XC evaluation algorithms (CPU/GPU optimized)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a><span class="sd">        - Dynamic precision switching for GPU calculations</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a><span class="sd">        </span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a><span class="sd">        SCF Procedure:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a><span class="sd">        1. Initialize one-electron integrals (S, T, V_nuc)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="sd">        2. Calculate/prepare two-electron integrals with optional screening</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a><span class="sd">        3. Generate and prune integration grids for XC evaluation</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a><span class="sd">        4. Iterative SCF loop:</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">        - Build Coulomb matrix J from density matrix</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a><span class="sd">        - Evaluate exchange-correlation energy/potential on grids</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">        - Form Kohn-Sham matrix: H_KS = H_core + J + V_xc</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">        - Apply DIIS convergence acceleration</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">        - Diagonalize KS matrix to get new orbitals</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">        - Generate new density matrix from occupied orbitals</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">        - Check energy convergence</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">        5. Return converged total energy and density matrix</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="sd">        </span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">        Computational Features:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        - Multi-threading support via Numba and configurable core count</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        - GPU acceleration using CuPy for grid-based operations</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        - Memory-efficient batched evaluation of XC terms</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        - Multiple density fitting algorithms (DF_algo 1-10)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        - Basis function screening for XC evaluation efficiency</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        - Optional Cholesky decomposition for 2-center integrals</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        </span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">        Returns:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">        --------</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        tuple[float, numpy.ndarray]</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">            Etot : float</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">                Converged total electronic energy in atomic units</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="sd">            dmat : numpy.ndarray, shape (nbf, nbf)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">                Converged density matrix in atomic orbital basis</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">                </span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">        Raises:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">        -------</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        ConvergenceError</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">            If SCF fails to converge within max_itr iterations</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">            </span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">        Notes:</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">        ------</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">        - Uses class attributes for all computational parameters (basis, xc, conv_crit, etc.)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        - Extensive timing and profiling information printed during execution</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        - Memory usage information displayed for large arrays</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        - GPU memory automatically freed after completion</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">        - Supports both Cartesian (CAO) and Spherical (SAO) atomic orbital bases</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        </span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        The function performs comprehensive error checking and provides detailed</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        timing breakdowns for performance analysis. GPU acceleration is automatically</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">        enabled when CuPy is available and use_gpu=True.</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        </span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        Example Energy Components:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        - Electron-nuclear attraction energy</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        - Nuclear repulsion energy  </span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        - Kinetic energy</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        - Coulomb (electron-electron repulsion) energy</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">        - Exchange-correlation energy</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="c1">#### Timings</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="n">duration1e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">durationDIIS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">durationItr</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="n">durationDF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>        <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="n">duration2c2e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="n">durationDF_coeff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">durationDF_gamma</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="n">durationDF_Jtri</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="n">durationDF_cholesky</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="n">startSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>    
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="n">conv_crit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="n">max_itr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="n">ncores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grids</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="n">gridsLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="n">isDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="n">rys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rys</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="n">DF_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">blocksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="n">XC_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="n">sortGrids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="n">save_ao_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">cholesky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">orthogonalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">print_pyfock_logo</span><span class="p">()</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of atoms:&#39;</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of basis functions (atomic orbitals):&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of auxiliary basis functions:&#39;</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">================================================================================</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="n">print_sys_info</span><span class="p">()</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="c1">#### Set number of cores</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RAYON_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running DFT using &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39; threads for Numba.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="c1"># if basis is None:</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="c1">#     basis = self.basis</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="c1"># if mol is None:</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="c1">#     mol = self.mol</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="c1"># if xc is None:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="c1">#     xc = self.xc</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="c1"># if gridsLevel is None:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="c1">#     gridsLevel = self.gridsLevel</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="c1"># if auxbasis is None:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="c1">#     auxbasis = Basis(mol, {&#39;all&#39;:Basis.load(mol=mol, basis_name=&#39;def2-universal-jfit&#39;)})</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning! AO screening is set to False, but AO values are requested to be saved. </span><span class="se">\</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="s1">                      AO values can only be saved when XC_BF_SCREEN=TRUE. AO values will not be saved.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="n">save_ao_values</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="k">if</span> <span class="n">CUPY_AVAILABLE</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration is enabled. Currently this only accelerates AO values and XC term evaluation.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU(s) information:&#39;</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="c1"># print(cp.cuda.Device.mem_info())</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">detect</span><span class="p">())</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Max threads per block supported by the GPU: &#39;</span><span class="p">,</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The user has specified to use &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; GPU(s).&#39;</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="c1"># For CUDA computations</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="n">threads_per_block</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span><span class="p">)</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the XC term: &#39;</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the all other calculations: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span><span class="p">:</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Will use dynamic precision. &#39;</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This means that the XC term will be evaluated in single precision until the &#39;</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;relative energy difference b/w successive iterations is less than 5.0E-7.&#39;</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>                <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>                <span class="n">nb_streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                    <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                    <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                    <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp_stream</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>                    <span class="n">nb_streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb_stream</span><span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>                <span class="c1"># Switch back to main GPU</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>                <span class="c1"># # Set some basis function data as cupy arrays to avoid redoing it during XC term evaluation at every SCF iteration</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>                <span class="c1"># bfs_coords = cp.asarray([basis.bfs_coords], dtype=precision_XC)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                <span class="c1"># bfs_contr_prim_norms = cp.asarray([basis.bfs_contr_prim_norms], dtype=precision_XC)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>                <span class="c1"># bfs_lmn = cp.asarray([basis.bfs_lmn])</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>                <span class="c1"># bfs_nprim = cp.asarray([basis.bfs_nprim])</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>                <span class="c1"># #The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>                <span class="c1"># #Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>                <span class="c1"># #So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>                <span class="c1"># #that the second dimension is that of the largest list. So that</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>                <span class="c1"># #it can accomadate all the lists.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>                <span class="c1"># maxnprim = max(basis.bfs_nprim)</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>                <span class="c1"># bfs_coeffs = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>                <span class="c1"># bfs_expnts = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>                <span class="c1"># bfs_prim_norms = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                <span class="c1"># bfs_radius_cutoff = cp.zeros([basis.bfs_nao], dtype=precision_XC)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                <span class="c1"># for i in range(basis.bfs_nao):</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>                <span class="c1">#     for j in range(basis.bfs_nprim[i]):</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                <span class="c1">#         bfs_coeffs[i,j] = basis.bfs_coeffs[i][j]</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>                <span class="c1">#         bfs_expnts[i,j] = basis.bfs_expnts[i][j]</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                <span class="c1">#         bfs_prim_norms[i,j] = basis.bfs_prim_norms[i][j]</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                <span class="c1">#         bfs_radius_cutoff[i] = basis.bfs_radius_cutoff[i]</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>                <span class="c1"># # Now bf/ao values can be evaluated by calling the following</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>                <span class="c1"># # bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                <span class="c1"># bfs_data_as_np_arrays = [bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff]</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration requested but cannot be enabled as Cupy is not installed.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Schwarz screening is not yet implemented for 4c2e integrals</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="k">if</span> <span class="n">strict_schwarz</span><span class="p">:</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The stricter variation of Schwarz screening is only compatible with DF algo #6 or #10 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The Cholesky decomposition of 2c2e integrls is only compatible with DF algo #6 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                <span class="n">cholesky</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Spherical Atomic Orbitals are being used!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="c1"># Get the CAO to SAO transformation matrix</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="n">c2sph_mat</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">cart2sph_basis</span><span class="p">()</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="c1"># Calculate the pseudoinverse transformation matrix (for back transformation of SAO dmat to CAO dmat)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="n">sph2c_mat_pseudo</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">sph2cart_basis</span><span class="p">()</span> <span class="c1"># SAO --&gt; CAO</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="c1"># DF_algo = 1 # Worst algorithm for more than 500 bfs/auxbfs (requires 2x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="c1"># DF_algo = 2 # Sligthly better (2x memory efficient) algorithm than above (requires 1x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="c1"># DF_algo = 3 # Memory effcient without any prefactor. (Can easily be converted into a sparse version, unlike the others) (https://aip.scitation.org/doi/pdf/10.1063/1.1567253)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="c1"># DF_algo = 4 # Same as 3, except now we use triangular version of ints3c2e to save on memory</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="c1"># DF_algo = 5 # Same as 4 in terms of memory requirements, however faster in performance due to the use of Schwarz screening.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="c1"># DF_algo = 6 # Much cheaper than 4 and 5 in terms of memory requirements because the indices of significant (ij|P) are efficiently calculated without duplicates/temporary arrays. </span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="c1">#               The speed maybe same or just slightly slower. </span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        <span class="c1"># DF_algo = 7 # The significant indices (ij|P) are stored even more efficiently by using shell indices instead of bf indices.</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="c1"># DF_algo = 8 # Similar to 6, except that here the significant indices are not stored resulting in 50% memory savings. The drawback is that it only works in serial which is useful for Google colab or Kaggle perhaps.</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="c1"># DF_algo = 9 # </span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_schwarz</span><span class="p">:</span> <span class="c1"># If a stricter variant of Schwarz screening is not requested</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating one electron integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating overlap and kinetic integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,(</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Factor of 2 because nuclear matrix will also be included here later</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="n">dmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span><span class="o">==</span><span class="s1">&#39;core&#39;</span><span class="p">:</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="c1"># It is possible that the supplied density matrix to the SCF was in SAO format already.</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="c1"># In such a case we need to transform this density matrix to CAO basis so that the J and XC term evaluations can be done properly </span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># Convert to CAO from SAO (SAO --&gt; CAO)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>                <span class="c1"># Later the dmat will be converted back to SAO after J and XC term evaluations</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span> <span class="c1"># 4c2e ERI case</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating four centered two electron integrals (ERIs)...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">isSchwarz</span><span class="p">:</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>                <span class="c1"># Four centered two electron integrals (ERIs)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="k">if</span> <span class="n">rys</span><span class="p">:</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Four Center Two electron ERI size in GB &#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Performing Schwarz screening...&#39;</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                <span class="c1"># threshold_schwarz = 1e-09</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threshold &#39;</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                <span class="n">startSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                <span class="n">nints4c2e_sym8</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                <span class="n">nints4c2e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                <span class="n">start_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>                <span class="c1"># Diagonal elements of ERI 4c2e array</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>                <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_4c2e_diag</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the &quot;diagonal&quot; of 4c2e ERI tensor: &#39;</span><span class="p">,</span> <span class="n">duration_4c2e_diag</span><span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>                <span class="c1"># Calculate the square roots required for </span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>                <span class="n">start_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>                <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_square_roots</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the square roots needed: &#39;</span><span class="p">,</span> <span class="n">duration_square_roots</span><span class="p">)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>                <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="c1"># Results in 2 GB chunks</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>                <span class="n">duration_indices_calc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>                <span class="n">duration_concatenation</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>                <span class="n">start_indices_calc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>                <span class="c1"># indices_temp = []</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>                <span class="n">ijkl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                <span class="k">if</span> <span class="n">chunksize</span><span class="o">&lt;</span><span class="n">nints4c2e_sym8</span><span class="p">:</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                    <span class="n">nchunks</span> <span class="o">=</span> <span class="n">nints4c2e_sym8</span><span class="o">//</span><span class="n">chunksize</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                    <span class="n">nchunks</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                <span class="n">indicesA</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                <span class="k">for</span> <span class="n">ichunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>                    <span class="n">indices_temp</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">calc_indices_4c2e_schwarz</span><span class="p">(</span><span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">),</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                    
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                    <span class="n">ijkl</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                    <span class="n">count</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                    <span class="c1"># start_concatenation = timer()</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                    <span class="k">if</span> <span class="n">indicesA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesA</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesB</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesC</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesD</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                        
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                    <span class="c1"># duration_concatenation += timer() - start_concatenation</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                    <span class="c1"># Break out of the for loop if the nol. of significant triplets found is less than the chunksize </span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                    <span class="c1"># This is because, it means that there are no more significant triplets to be found from all possible configurations. </span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                    <span class="k">if</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">chunksize</span><span class="p">:</span> 
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                        <span class="k">break</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                <span class="n">duration_indices_calc</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_indices_calc</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time for significant indices evaluation: &#39;</span><span class="p">,</span> <span class="n">duration_indices_calc</span><span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                <span class="c1"># print(&#39;Time for array concatenation: &#39;, duration_concatenation)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                <span class="c1"># Get rid of temp variables</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>                <span class="n">indices_temp</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>                <span class="n">ijk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of permanent array storing the significant indices of 4c2e ERI in GB &#39;</span><span class="p">,</span> <span class="n">indicesA</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesB</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesC</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesD</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>                <span class="n">nsignificant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicesA</span><span class="p">)</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements in the standard four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements after factoring in the 8-fold symmetry in the four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of significant quadruplets based on Schwarz inequality and 8-fold symmetry: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsignificant</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; or &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nsignificant</span><span class="o">/</span><span class="n">nints4c2e</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f original&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Schwarz screening done!&#39;</span><span class="p">)</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>                <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSchwarz</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time taken for Schwarz screening &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSchwarz</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">rys_4c2e_tri_schwarz_sparse</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">indicesD</span><span class="p">)</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Density fitting case (3c2e, and 2c2e will be calculated)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">H_temp</span><span class="p">,</span> <span class="n">V_temp</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">nsignificant</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="n">density_fitting_prelims_for_DFT_development</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">rys</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">H_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">H_temp</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">V_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">V_temp</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>                <span class="n">durationDF</span> <span class="o">+=</span> <span class="n">durationDF_cholesky</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="n">startGrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating grids...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="c1"># To get the same energies as PySCF (level=5) upto 1e-7 au, use the following settings</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>            <span class="c1"># radial_precision = 1.0e-13</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="c1"># level=3</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="c1"># pruning by density with threshold = 1e-011</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="c1"># alpha_min and alpha_max corresponding to QZVP</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids level: &#39;</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="p">)</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>            <span class="c1"># Generate grids for XC term</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="n">basisGrids</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-QZVP&#39;</span><span class="p">)})</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>            <span class="n">grids</span> <span class="o">=</span> <span class="n">Grids</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basisGrids</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">gridsLevel</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="n">durationgrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>            <span class="c1"># Begin pruning the grids based on density (rho)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="c1"># Evaluate ao_values to calculate rho</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Pruning generated grids by rho...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="n">startGrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="n">threshold_rho</span> <span class="o">=</span> <span class="mf">1e-011</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>            <span class="n">ngrids_temp</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>            <span class="n">ndeleted</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="n">blocksize_temp</span> <span class="o">=</span> <span class="mi">50000</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="n">nblocks_temp</span> <span class="o">=</span> <span class="n">ngrids_temp</span><span class="o">//</span><span class="n">blocksize_temp</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            <span class="n">weightsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="n">coordsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>            <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks_temp</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize_temp</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>                <span class="n">weights_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span> 
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>  
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                <span class="n">rho_block</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rho_block</span><span class="o">*</span><span class="n">weights_block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_rho</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                <span class="n">ndeleted</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="n">weightsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">weights_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>                <span class="n">coordsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">coords_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="k">if</span> <span class="n">weightsNew_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                    <span class="k">if</span> <span class="n">weightsNew</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">weightsNew_block</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">coordsNew_block</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weightsNew</span><span class="p">,</span> <span class="n">weightsNew_block</span><span class="p">))</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">coordsNew</span><span class="p">,</span> <span class="n">coordsNew_block</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coordsNew</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weightsNew</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>            <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids_prune_rho</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids_prune_rho</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Deleted &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ndeleted</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; grid points.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Using the user supplied grids!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="c1"># Grid information initial</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. of supplied/generated grid points: &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="c1"># Prune grids based on weights</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="c1"># start_pruning_weights = timer()</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="c1"># print(&#39;\nPruning grids based on weights....&#39;, flush=True)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="c1"># zero_indices = np.where(np.logical_and(grids.weights&gt;=-1.0e-12, grids.weights&lt;=1.e-12))</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="c1"># grids.weights = np.delete(grids.weights, zero_indices)</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="c1"># grids.coords = np.delete(grids.coords, zero_indices, 0)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="c1"># print(&#39;done!&#39;, flush=True)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="c1"># duration_pruning_weights = timer() - start_pruning_weights</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="c1"># print(&#39;\nTime taken &#39;+str(duration_pruning_weights)+&#39; seconds.\n&#39;, flush=True)</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="c1"># print(&#39;\nNo. of grid points after screening by weights: &#39;, grids.coords.shape[0], flush=True)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the coordinates of grid:      &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the weights of grid:          &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the density at gridpoints:    &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="c1"># Sort the grids for slightly better performance with batching (doesn&#39;t seem to make much difference)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="k">if</span> <span class="n">sortGrids</span><span class="p">:</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Sorting grids ....&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>            <span class="c1"># Function to sort grids</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">get_ordered_list</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                <span class="n">points</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                <span class="c1"># print(points[0:10])</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                <span class="k">return</span> <span class="n">points</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="c1"># Make a single array of coords and weights</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_ordered_list</span><span class="p">(</span><span class="n">coords_weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])))</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>            <span class="c1"># Now go back to two arrays for coords and weights</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#None</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="c1"># blocksize = 10000</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="n">ngrids</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Will use batching to evaluate the XC term for memory efficiency.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch size: &#39;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of batches: &#39;</span><span class="p">,</span> <span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="c1">#### Some preliminary stuff for XC evaluation</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="n">list_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="n">list_ao_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="p">:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>            <span class="c1"># Create a LibXC object  </span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>            <span class="c1">### Find the list of significanlty contributing bfs for xc evaluations</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>            <span class="n">startXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Preliminary processing for XC term evaluations...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of basis functions (atomic orbitals) and get the indices of siginificantly contributing functions...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            <span class="c1"># Calculate the value of basis functions for all grid points in batches</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>            <span class="c1"># and find the indices of basis functions that have a significant contribution to those batches for each batch</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startXCpreprocessing</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationXCpreprocessing</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">))</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">)))</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>            
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>            <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="p">:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                <span class="n">startAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                        <span class="n">ao_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>                    <span class="c1">#Free memory </span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions and their gradients on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                    <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                        <span class="c1"># ao_values_block = Integrals.bf_val_helpers.eval_bfs(basis, coords_block, parallel=True, non_zero_indices=list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                        <span class="n">ao_values_block</span><span class="p">,</span> <span class="n">ao_grad_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">))</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>                    <span class="c1">#Free memory </span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>                    <span class="n">ao_grad_values_block</span> <span class="o">=</span><span class="mi">0</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>                <span class="n">durationAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startAO_values</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationAO_values</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>        
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="c1">#-------XC Stuff start----------------------</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="n">funcid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>        <span class="c1"># Create a LibXC object  </span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>        <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>        <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">------------------------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Functional&#39;</span><span class="p">)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XC Functional IDs supplied: &#39;</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of exchange functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Exchange function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcx</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of correlation functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; The Correlation function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcc</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="c1">#-------XC Stuff end----------------------</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="n">Etot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>        <span class="n">itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="n">Enn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuclear_rep_energy</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="c1">#diis = scf.CDIIS()</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="n">dmat_old</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="n">J_diff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="n">Ecoul</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>        <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="c1">#########</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="c1"># I use a trick to calculate the DFT energy in SAO basis. </span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="c1"># The trick is to get rid of the extra information in the CAO basis matrices.</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="c1"># The following does just that. </span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="c1"># Going from CAO --&gt; SAO we lose the extra information then we go back to from SAO --&gt; CAO</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="c1"># This way all the integrals (potential matrices and density matrices) can still be calculated</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="c1"># in the CAO basis. In fact even the KS matrix is diagonalized in the CAO basis with the extra information </span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="c1"># removed by forward and backward transformation: CAO --&gt; SAO followed by SAO --&gt; CAO.</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="c1"># This also helps in reducing the number of transformations needed for calculation of various energy contributions.</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="c1">#########</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="c1"># Convert the overlap matrix from CAO to SAO basis</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="c1"># Convert back to SAO so that now we lose the extra information that the CAO basis had</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="k">if</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">scf_converged</span> <span class="ow">or</span> <span class="n">itr</span><span class="o">==</span><span class="n">max_itr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="n">startIter</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="k">if</span> <span class="n">itr</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="c1"># Coulomb (Hartree) matrix</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="p">,</span><span class="n">dmat</span><span class="p">)</span> <span class="c1"># This is in CAO basis</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>                    
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>                
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">-</span><span class="n">dmat_old</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>                    <span class="c1"># J_diff = contract(&#39;ijkl,ij&#39;,ints4c2e,dmat_diff)</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>                    <span class="c1"># J += J_diff</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span> <span class="n">ints4c2e</span><span class="p">,</span> <span class="n">dmat</span><span class="p">)</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>                <span class="c1"># J += J_diff</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                <span class="n">J</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>            
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>                
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="c1"># XC energy and potential</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="n">startxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>                    <span class="c1"># Much slower than JOBLIB version</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>                    <span class="c1"># Still keeping it because, it can be useful when using GPUs</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">)</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>                    <span class="c1"># Much faster than above and stable too, therefore this should be default now.</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>                    <span class="c1"># Used to unstable and had memory leaks,</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>                    <span class="c1"># But now all that is fixed by using threadpoolctl, garbage collection or freeing up memory after XC evaluation at each iteration</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                    
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                    
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                        <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                                                    <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>                                                        <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># GPU</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>                    <span class="c1"># Default for GPUs</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="n">streams</span><span class="p">,</span> <span class="n">nb_streams</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>                <span class="n">Vxc</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Vxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>            <span class="n">durationxc</span> <span class="o">=</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startxc</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>            
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>            <span class="n">dmat_old</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>                <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>                <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>                    <span class="c1"># print(&#39;Energy contractions&#39;, controller.info())</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>                    <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>                    <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                    <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="k">if</span> <span class="n">isDF</span> <span class="ow">and</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">Ecoul</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Ecoul_temp</span> <span class="c1"># This is the correct formula for Coulomb energy with DF</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="n">Etot_new</span> <span class="o">=</span> <span class="n">Exc</span> <span class="o">+</span> <span class="n">Enuc</span> <span class="o">+</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">Enn</span> <span class="o">+</span> <span class="n">Ecoul</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">------Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;--------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energies&#39;</span><span class="p">)</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electron-Nuclear Energy      &#39;</span><span class="p">,</span> <span class="n">Enuc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nuclear repulsion Energy     &#39;</span><span class="p">,</span> <span class="n">Enn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kinetic Energy               &#39;</span><span class="p">,</span> <span class="n">Ekin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Energy               &#39;</span><span class="p">,</span> <span class="n">Ecoul</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Energy  &#39;</span><span class="p">,</span> <span class="n">Exc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------&#39;</span><span class="p">)</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy &#39;</span><span class="p">,</span><span class="n">Etot_new</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energy difference : &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>            
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="n">KS</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">J</span> <span class="o">+</span> <span class="n">Vxc</span> 
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>                <span class="c1"># The following gets rid of the extra information in the CAO basis KS matrix by going to SAO and then back to CAO.</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>                <span class="c1"># This way even though the matrix dimensions would be that of CAO but the information would be the same as SAO</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>                <span class="c1"># leading to the same energy as SAO basis PySCF or TURBOMOLE calculations</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1">#SAO --&gt; CAO</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="c1">#### DIIS</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="n">startDIIS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="n">diis_start_itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            <span class="k">if</span> <span class="n">itr</span> <span class="o">&gt;=</span> <span class="n">diis_start_itr</span><span class="p">:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                        <span class="c1"># print(&#39;DIIS &#39;, controller.info())</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                        <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                    <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS_cupy</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                    <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>            <span class="n">durationDIIS</span> <span class="o">=</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startDIIS</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>            <span class="c1">#### Solve KS equation (Diagonalize KS matrix)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_cupy</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Orthogonalization is necessary with CUDA</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc_cupy</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm_cupy</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">dmat</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">dmat</span><span class="p">)</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                    <span class="c1"># print(&#39;KS eigh&#39;, controller.info())</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>                    <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="n">orthogonalize</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="c1"># Check when to switch to double precision for XC</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                <span class="k">if</span> <span class="n">precision_XC</span> <span class="ow">is</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">5e-7</span><span class="p">:</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                        <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Switching to double precision for XC evaluation after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>                        
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="n">durationItr</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startIter</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Time taken for the previous iteration: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationItr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="c1"># Check convergence criteria</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">conv_crit</span><span class="p">:</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy = &#39;</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>                <span class="k">break</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">itr</span> <span class="o">=</span> <span class="n">itr</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="k">if</span> <span class="n">itr</span><span class="o">&gt;=</span><span class="n">max_itr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scf_converged</span><span class="p">:</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF NOT Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSCF</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="c1"># print(dmat)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time taken : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSCF</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; seconds.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Profiling&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preprocessing                          &#39;</span><span class="p">,</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> <span class="o">+</span> <span class="n">durationSchwarz</span><span class="p">)</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Density Fitting                        &#39;</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="k">if</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (gamma)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (coeff)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Jtri)                          &#39;</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Cholesky)                      &#39;</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DIIS                                   &#39;</span><span class="p">,</span> <span class="n">durationDIIS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KS matrix diagonalization              &#39;</span><span class="p">,</span> <span class="n">durationKS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One electron Integrals (S, T, Vnuc)    &#39;</span><span class="p">,</span> <span class="n">duration1e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (2c2e + 3c2e)        &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="o">-</span><span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (4c2e)               &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids construction                     &#39;</span><span class="p">,</span> <span class="n">durationgrids</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Term              &#39;</span><span class="p">,</span> <span class="n">durationxc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        <span class="n">totalTime</span> <span class="o">=</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">duration1e</span> <span class="o">+</span> <span class="n">durationCoulomb</span> <span class="o">-</span> <span class="n">durationDF_cholesky</span> <span class="o">+</span> \
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="n">durationgrids</span> <span class="o">+</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">durationDF</span> <span class="o">+</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> 
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Misc.                                  &#39;</span><span class="p">,</span> <span class="n">durationSCF</span> <span class="o">-</span> <span class="n">totalTime</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete SCF                           &#39;</span><span class="p">,</span> <span class="n">durationSCF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>            <span class="c1"># Free memory of all GPUs</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="k">for</span> <span class="n">igpu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">igpu</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">_default_memory_pool</span><span class="o">.</span><span class="n">free_all_blocks</span><span class="p">()</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>            <span class="c1"># Switch back to main GPU</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        <span class="k">return</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">dmat</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>    
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>    
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        
</span></pre></div>


            </section>
                <section id="DFT">
                            <input id="DFT-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DFT</span>:

                <label class="view-source-button" for="DFT-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT-70"><a href="#DFT-70"><span class="linenos">  70</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DFT</span><span class="p">:</span>
</span><span id="DFT-71"><a href="#DFT-71"><span class="linenos">  71</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-72"><a href="#DFT-72"><span class="linenos">  72</span></a><span class="sd">    A class for performing Density Functional Theory (DFT) calculations </span>
</span><span id="DFT-73"><a href="#DFT-73"><span class="linenos">  73</span></a><span class="sd">    with optional support for density fitting (DF), GPU acceleration, and LibXC.</span>
</span><span id="DFT-74"><a href="#DFT-74"><span class="linenos">  74</span></a>
</span><span id="DFT-75"><a href="#DFT-75"><span class="linenos">  75</span></a><span class="sd">    Parameters</span>
</span><span id="DFT-76"><a href="#DFT-76"><span class="linenos">  76</span></a><span class="sd">    ----------</span>
</span><span id="DFT-77"><a href="#DFT-77"><span class="linenos">  77</span></a><span class="sd">    mol : Molecule</span>
</span><span id="DFT-78"><a href="#DFT-78"><span class="linenos">  78</span></a><span class="sd">        Molecular object on which the DFT calculation is to be performed.</span>
</span><span id="DFT-79"><a href="#DFT-79"><span class="linenos">  79</span></a><span class="sd">    </span>
</span><span id="DFT-80"><a href="#DFT-80"><span class="linenos">  80</span></a><span class="sd">    basis : Basis</span>
</span><span id="DFT-81"><a href="#DFT-81"><span class="linenos">  81</span></a><span class="sd">        Orbital basis set used for the SCF calculation.</span>
</span><span id="DFT-82"><a href="#DFT-82"><span class="linenos">  82</span></a>
</span><span id="DFT-83"><a href="#DFT-83"><span class="linenos">  83</span></a><span class="sd">    auxbasis : Basis, optional</span>
</span><span id="DFT-84"><a href="#DFT-84"><span class="linenos">  84</span></a><span class="sd">        Auxiliary basis set for density fitting (DF). If None, a default will be assigned.</span>
</span><span id="DFT-85"><a href="#DFT-85"><span class="linenos">  85</span></a>
</span><span id="DFT-86"><a href="#DFT-86"><span class="linenos">  86</span></a><span class="sd">    conv_crit : float, optional</span>
</span><span id="DFT-87"><a href="#DFT-87"><span class="linenos">  87</span></a><span class="sd">        Convergence criterion for the SCF cycle in Hartrees (default is 1e-7).</span>
</span><span id="DFT-88"><a href="#DFT-88"><span class="linenos">  88</span></a>
</span><span id="DFT-89"><a href="#DFT-89"><span class="linenos">  89</span></a><span class="sd">    dmat_guess_method : str, optional</span>
</span><span id="DFT-90"><a href="#DFT-90"><span class="linenos">  90</span></a><span class="sd">        Method for the initial density matrix guess (e.g., &#39;core&#39;, &#39;huckel&#39;).</span>
</span><span id="DFT-91"><a href="#DFT-91"><span class="linenos">  91</span></a>
</span><span id="DFT-92"><a href="#DFT-92"><span class="linenos">  92</span></a><span class="sd">    xc : list or str, optional</span>
</span><span id="DFT-93"><a href="#DFT-93"><span class="linenos">  93</span></a><span class="sd">        Exchange-correlation functional specification. If None, defaults to LDA (`[1, 7]`).</span>
</span><span id="DFT-94"><a href="#DFT-94"><span class="linenos">  94</span></a>
</span><span id="DFT-95"><a href="#DFT-95"><span class="linenos">  95</span></a><span class="sd">    grids : object, optional</span>
</span><span id="DFT-96"><a href="#DFT-96"><span class="linenos">  96</span></a><span class="sd">        Precomputed numerical integration grids. If None, they will be generated automatically.</span>
</span><span id="DFT-97"><a href="#DFT-97"><span class="linenos">  97</span></a>
</span><span id="DFT-98"><a href="#DFT-98"><span class="linenos">  98</span></a><span class="sd">    gridsLevel : int, optional</span>
</span><span id="DFT-99"><a href="#DFT-99"><span class="linenos">  99</span></a><span class="sd">        Level of numerical integration grid refinement (default is 3).</span>
</span><span id="DFT-100"><a href="#DFT-100"><span class="linenos"> 100</span></a>
</span><span id="DFT-101"><a href="#DFT-101"><span class="linenos"> 101</span></a><span class="sd">    blocksize : int, optional</span>
</span><span id="DFT-102"><a href="#DFT-102"><span class="linenos"> 102</span></a><span class="sd">        Block size for XC grid evaluations. Defaults depend on whether GPU is used.</span>
</span><span id="DFT-103"><a href="#DFT-103"><span class="linenos"> 103</span></a>
</span><span id="DFT-104"><a href="#DFT-104"><span class="linenos"> 104</span></a><span class="sd">    save_ao_values : bool, optional</span>
</span><span id="DFT-105"><a href="#DFT-105"><span class="linenos"> 105</span></a><span class="sd">        If True, saves AO values to reuse during XC evaluation. Increases speed but uses more memory.</span>
</span><span id="DFT-106"><a href="#DFT-106"><span class="linenos"> 106</span></a>
</span><span id="DFT-107"><a href="#DFT-107"><span class="linenos"> 107</span></a><span class="sd">    use_gpu : bool, optional</span>
</span><span id="DFT-108"><a href="#DFT-108"><span class="linenos"> 108</span></a><span class="sd">        Whether to use GPU acceleration.</span>
</span><span id="DFT-109"><a href="#DFT-109"><span class="linenos"> 109</span></a>
</span><span id="DFT-110"><a href="#DFT-110"><span class="linenos"> 110</span></a><span class="sd">    ncores : int, optional</span>
</span><span id="DFT-111"><a href="#DFT-111"><span class="linenos"> 111</span></a><span class="sd">        Number of CPU cores to use (default is 2).</span>
</span><span id="DFT-112"><a href="#DFT-112"><span class="linenos"> 112</span></a>
</span><span id="DFT-113"><a href="#DFT-113"><span class="linenos"> 113</span></a><span class="sd">    Attributes</span>
</span><span id="DFT-114"><a href="#DFT-114"><span class="linenos"> 114</span></a><span class="sd">    ----------</span>
</span><span id="DFT-115"><a href="#DFT-115"><span class="linenos"> 115</span></a><span class="sd">    dmat : ndarray</span>
</span><span id="DFT-116"><a href="#DFT-116"><span class="linenos"> 116</span></a><span class="sd">        Initial guess for the density matrix, will be computed during setup.</span>
</span><span id="DFT-117"><a href="#DFT-117"><span class="linenos"> 117</span></a>
</span><span id="DFT-118"><a href="#DFT-118"><span class="linenos"> 118</span></a><span class="sd">    KSmats : list</span>
</span><span id="DFT-119"><a href="#DFT-119"><span class="linenos"> 119</span></a><span class="sd">        List of KohnSham matrices used in DIIS extrapolation.</span>
</span><span id="DFT-120"><a href="#DFT-120"><span class="linenos"> 120</span></a>
</span><span id="DFT-121"><a href="#DFT-121"><span class="linenos"> 121</span></a><span class="sd">    errVecs : list</span>
</span><span id="DFT-122"><a href="#DFT-122"><span class="linenos"> 122</span></a><span class="sd">        List of error vectors for DIIS.</span>
</span><span id="DFT-123"><a href="#DFT-123"><span class="linenos"> 123</span></a>
</span><span id="DFT-124"><a href="#DFT-124"><span class="linenos"> 124</span></a><span class="sd">    max_itr : int</span>
</span><span id="DFT-125"><a href="#DFT-125"><span class="linenos"> 125</span></a><span class="sd">        Maximum number of SCF iterations (default is 50).</span>
</span><span id="DFT-126"><a href="#DFT-126"><span class="linenos"> 126</span></a>
</span><span id="DFT-127"><a href="#DFT-127"><span class="linenos"> 127</span></a><span class="sd">    isDF : bool</span>
</span><span id="DFT-128"><a href="#DFT-128"><span class="linenos"> 128</span></a><span class="sd">        Whether to use density fitting for Coulomb integrals.</span>
</span><span id="DFT-129"><a href="#DFT-129"><span class="linenos"> 129</span></a>
</span><span id="DFT-130"><a href="#DFT-130"><span class="linenos"> 130</span></a><span class="sd">    rys : bool</span>
</span><span id="DFT-131"><a href="#DFT-131"><span class="linenos"> 131</span></a><span class="sd">        Whether to use Rys quadrature for evaluating electron repulsion integrals.</span>
</span><span id="DFT-132"><a href="#DFT-132"><span class="linenos"> 132</span></a>
</span><span id="DFT-133"><a href="#DFT-133"><span class="linenos"> 133</span></a><span class="sd">    DF_algo : int</span>
</span><span id="DFT-134"><a href="#DFT-134"><span class="linenos"> 134</span></a><span class="sd">        Algorithm selector for DF (reserved for developer use).</span>
</span><span id="DFT-135"><a href="#DFT-135"><span class="linenos"> 135</span></a>
</span><span id="DFT-136"><a href="#DFT-136"><span class="linenos"> 136</span></a><span class="sd">    XC_algo : int</span>
</span><span id="DFT-137"><a href="#DFT-137"><span class="linenos"> 137</span></a><span class="sd">        Algorithm selector for XC evaluation (2 for CPU, 3 for GPU).</span>
</span><span id="DFT-138"><a href="#DFT-138"><span class="linenos"> 138</span></a>
</span><span id="DFT-139"><a href="#DFT-139"><span class="linenos"> 139</span></a><span class="sd">    sortGrids : bool</span>
</span><span id="DFT-140"><a href="#DFT-140"><span class="linenos"> 140</span></a><span class="sd">        Whether to sort DFT integration grids (not recommended).</span>
</span><span id="DFT-141"><a href="#DFT-141"><span class="linenos"> 141</span></a>
</span><span id="DFT-142"><a href="#DFT-142"><span class="linenos"> 142</span></a><span class="sd">    xc_bf_screen : bool</span>
</span><span id="DFT-143"><a href="#DFT-143"><span class="linenos"> 143</span></a><span class="sd">        Enable basis function screening for XC term evaluation.</span>
</span><span id="DFT-144"><a href="#DFT-144"><span class="linenos"> 144</span></a>
</span><span id="DFT-145"><a href="#DFT-145"><span class="linenos"> 145</span></a><span class="sd">    threshold_schwarz : float</span>
</span><span id="DFT-146"><a href="#DFT-146"><span class="linenos"> 146</span></a><span class="sd">        Threshold for Schwarz screening (default is 1e-9).</span>
</span><span id="DFT-147"><a href="#DFT-147"><span class="linenos"> 147</span></a>
</span><span id="DFT-148"><a href="#DFT-148"><span class="linenos"> 148</span></a><span class="sd">    strict_schwarz : bool</span>
</span><span id="DFT-149"><a href="#DFT-149"><span class="linenos"> 149</span></a><span class="sd">        If True, applies stricter Schwarz screening.</span>
</span><span id="DFT-150"><a href="#DFT-150"><span class="linenos"> 150</span></a>
</span><span id="DFT-151"><a href="#DFT-151"><span class="linenos"> 151</span></a><span class="sd">    cholesky : bool</span>
</span><span id="DFT-152"><a href="#DFT-152"><span class="linenos"> 152</span></a><span class="sd">        If True, uses Cholesky decomposition for DF.</span>
</span><span id="DFT-153"><a href="#DFT-153"><span class="linenos"> 153</span></a>
</span><span id="DFT-154"><a href="#DFT-154"><span class="linenos"> 154</span></a><span class="sd">    orthogonalize : bool</span>
</span><span id="DFT-155"><a href="#DFT-155"><span class="linenos"> 155</span></a><span class="sd">        If True, orthogonalizes AO basis functions.</span>
</span><span id="DFT-156"><a href="#DFT-156"><span class="linenos"> 156</span></a>
</span><span id="DFT-157"><a href="#DFT-157"><span class="linenos"> 157</span></a><span class="sd">    sao : bool</span>
</span><span id="DFT-158"><a href="#DFT-158"><span class="linenos"> 158</span></a><span class="sd">        If True, uses SAO basis instead of CAO basis.</span>
</span><span id="DFT-159"><a href="#DFT-159"><span class="linenos"> 159</span></a>
</span><span id="DFT-160"><a href="#DFT-160"><span class="linenos"> 160</span></a><span class="sd">    keep_ao_in_gpu : bool</span>
</span><span id="DFT-161"><a href="#DFT-161"><span class="linenos"> 161</span></a><span class="sd">        Whether to retain AO values in GPU memory during SCF (if `save_ao_values` is True).</span>
</span><span id="DFT-162"><a href="#DFT-162"><span class="linenos"> 162</span></a>
</span><span id="DFT-163"><a href="#DFT-163"><span class="linenos"> 163</span></a><span class="sd">    use_libxc : bool</span>
</span><span id="DFT-164"><a href="#DFT-164"><span class="linenos"> 164</span></a><span class="sd">        Whether to use LibXC for XC functional evaluation (recommended off for GPU).</span>
</span><span id="DFT-165"><a href="#DFT-165"><span class="linenos"> 165</span></a>
</span><span id="DFT-166"><a href="#DFT-166"><span class="linenos"> 166</span></a><span class="sd">    n_streams : int</span>
</span><span id="DFT-167"><a href="#DFT-167"><span class="linenos"> 167</span></a><span class="sd">        Number of CUDA streams to use (if applicable).</span>
</span><span id="DFT-168"><a href="#DFT-168"><span class="linenos"> 168</span></a>
</span><span id="DFT-169"><a href="#DFT-169"><span class="linenos"> 169</span></a><span class="sd">    n_gpus : int</span>
</span><span id="DFT-170"><a href="#DFT-170"><span class="linenos"> 170</span></a><span class="sd">        Number of GPUs to use.</span>
</span><span id="DFT-171"><a href="#DFT-171"><span class="linenos"> 171</span></a>
</span><span id="DFT-172"><a href="#DFT-172"><span class="linenos"> 172</span></a><span class="sd">    free_gpu_mem : bool</span>
</span><span id="DFT-173"><a href="#DFT-173"><span class="linenos"> 173</span></a><span class="sd">        Whether to forcibly free GPU memory after use.</span>
</span><span id="DFT-174"><a href="#DFT-174"><span class="linenos"> 174</span></a>
</span><span id="DFT-175"><a href="#DFT-175"><span class="linenos"> 175</span></a><span class="sd">    max_threads_per_block : int</span>
</span><span id="DFT-176"><a href="#DFT-176"><span class="linenos"> 176</span></a><span class="sd">        Maximum threads per CUDA block supported by the device.</span>
</span><span id="DFT-177"><a href="#DFT-177"><span class="linenos"> 177</span></a>
</span><span id="DFT-178"><a href="#DFT-178"><span class="linenos"> 178</span></a><span class="sd">    threads_x : int</span>
</span><span id="DFT-179"><a href="#DFT-179"><span class="linenos"> 179</span></a><span class="sd">        CUDA thread configuration (X dimension).</span>
</span><span id="DFT-180"><a href="#DFT-180"><span class="linenos"> 180</span></a>
</span><span id="DFT-181"><a href="#DFT-181"><span class="linenos"> 181</span></a><span class="sd">    threads_y : int</span>
</span><span id="DFT-182"><a href="#DFT-182"><span class="linenos"> 182</span></a><span class="sd">        CUDA thread configuration (Y dimension).</span>
</span><span id="DFT-183"><a href="#DFT-183"><span class="linenos"> 183</span></a>
</span><span id="DFT-184"><a href="#DFT-184"><span class="linenos"> 184</span></a><span class="sd">    dynamic_precision : bool</span>
</span><span id="DFT-185"><a href="#DFT-185"><span class="linenos"> 185</span></a><span class="sd">        Whether to use precision switching during XC evaluation for performance gains.</span>
</span><span id="DFT-186"><a href="#DFT-186"><span class="linenos"> 186</span></a>
</span><span id="DFT-187"><a href="#DFT-187"><span class="linenos"> 187</span></a><span class="sd">    keep_ints3c2e_in_gpu : bool</span>
</span><span id="DFT-188"><a href="#DFT-188"><span class="linenos"> 188</span></a><span class="sd">        Whether to keep 3-center 2-electron integrals in GPU memory to avoid transfers.</span>
</span><span id="DFT-189"><a href="#DFT-189"><span class="linenos"> 189</span></a>
</span><span id="DFT-190"><a href="#DFT-190"><span class="linenos"> 190</span></a><span class="sd">    debug : bool</span>
</span><span id="DFT-191"><a href="#DFT-191"><span class="linenos"> 191</span></a><span class="sd">        If True, prints debugging output during DFT calculations.</span>
</span><span id="DFT-192"><a href="#DFT-192"><span class="linenos"> 192</span></a>
</span><span id="DFT-193"><a href="#DFT-193"><span class="linenos"> 193</span></a><span class="sd">    Notes</span>
</span><span id="DFT-194"><a href="#DFT-194"><span class="linenos"> 194</span></a><span class="sd">    -----</span>
</span><span id="DFT-195"><a href="#DFT-195"><span class="linenos"> 195</span></a><span class="sd">    - This class supports SCF DFT calculations with density fitting (DF).</span>
</span><span id="DFT-196"><a href="#DFT-196"><span class="linenos"> 196</span></a><span class="sd">    - GPU support is optional and provides significant speed-up for large systems.</span>
</span><span id="DFT-197"><a href="#DFT-197"><span class="linenos"> 197</span></a><span class="sd">    - The class is tightly integrated with PyFock and LibXC libraries.</span>
</span><span id="DFT-198"><a href="#DFT-198"><span class="linenos"> 198</span></a>
</span><span id="DFT-199"><a href="#DFT-199"><span class="linenos"> 199</span></a><span class="sd">    Examples</span>
</span><span id="DFT-200"><a href="#DFT-200"><span class="linenos"> 200</span></a><span class="sd">    --------</span>
</span><span id="DFT-201"><a href="#DFT-201"><span class="linenos"> 201</span></a><span class="sd">    &gt;&gt;&gt; mol = Molecule(...)</span>
</span><span id="DFT-202"><a href="#DFT-202"><span class="linenos"> 202</span></a><span class="sd">    &gt;&gt;&gt; basis = Basis(mol, ...)</span>
</span><span id="DFT-203"><a href="#DFT-203"><span class="linenos"> 203</span></a><span class="sd">    &gt;&gt;&gt; dft = DFT(mol, basis, xc=&#39;PBE&#39;, use_gpu=True)</span>
</span><span id="DFT-204"><a href="#DFT-204"><span class="linenos"> 204</span></a><span class="sd">    &gt;&gt;&gt; dft.run_scf()</span>
</span><span id="DFT-205"><a href="#DFT-205"><span class="linenos"> 205</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DFT-206"><a href="#DFT-206"><span class="linenos"> 206</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv_crit</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">dmat_guess_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="DFT-207"><a href="#DFT-207"><span class="linenos"> 207</span></a>                <span class="n">xc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="DFT-208"><a href="#DFT-208"><span class="linenos"> 208</span></a>                <span class="n">save_ao_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> 
</span><span id="DFT-209"><a href="#DFT-209"><span class="linenos"> 209</span></a>         
</span><span id="DFT-210"><a href="#DFT-210"><span class="linenos"> 210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
</span><span id="DFT-211"><a href="#DFT-211"><span class="linenos"> 211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Molecular object for which the DFT calculation will be performed &quot;&quot;&quot;</span>
</span><span id="DFT-212"><a href="#DFT-212"><span class="linenos"> 212</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-213"><a href="#DFT-213"><span class="linenos"> 213</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Mol object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="DFT-214"><a href="#DFT-214"><span class="linenos"> 214</span></a>        
</span><span id="DFT-215"><a href="#DFT-215"><span class="linenos"> 215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
</span><span id="DFT-216"><a href="#DFT-216"><span class="linenos"> 216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object for corresponding to the molecule for the DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT-217"><a href="#DFT-217"><span class="linenos"> 217</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-218"><a href="#DFT-218"><span class="linenos"> 218</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Basis object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="DFT-219"><a href="#DFT-219"><span class="linenos"> 219</span></a>
</span><span id="DFT-220"><a href="#DFT-220"><span class="linenos"> 220</span></a>        
</span><span id="DFT-221"><a href="#DFT-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="n">dmat_guess_method</span>
</span><span id="DFT-222"><a href="#DFT-222"><span class="linenos"> 222</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial guess for the density matrix &quot;&quot;&quot;</span>
</span><span id="DFT-223"><a href="#DFT-223"><span class="linenos"> 223</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-224"><a href="#DFT-224"><span class="linenos"> 224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="s1">&#39;core&#39;</span>
</span><span id="DFT-225"><a href="#DFT-225"><span class="linenos"> 225</span></a>
</span><span id="DFT-226"><a href="#DFT-226"><span class="linenos"> 226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-227"><a href="#DFT-227"><span class="linenos"> 227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial density matrix guess for SCF &quot;&quot;&quot;</span>
</span><span id="DFT-228"><a href="#DFT-228"><span class="linenos"> 228</span></a>        
</span><span id="DFT-229"><a href="#DFT-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span>
</span><span id="DFT-230"><a href="#DFT-230"><span class="linenos"> 230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Exchange-Correlation Functional &quot;&quot;&quot;</span>
</span><span id="DFT-231"><a href="#DFT-231"><span class="linenos"> 231</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="DFT-232"><a href="#DFT-232"><span class="linenos"> 232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="c1">#LDA</span>
</span><span id="DFT-233"><a href="#DFT-233"><span class="linenos"> 233</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XC not specified, defaulting to LDA functional (LibXC codes: 1, 7)&quot;</span><span class="p">)</span>
</span><span id="DFT-234"><a href="#DFT-234"><span class="linenos"> 234</span></a>
</span><span id="DFT-235"><a href="#DFT-235"><span class="linenos"> 235</span></a>        <span class="c1"># DIIS</span>
</span><span id="DFT-236"><a href="#DFT-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-237"><a href="#DFT-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-238"><a href="#DFT-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="DFT-239"><a href="#DFT-239"><span class="linenos"> 239</span></a>
</span><span id="DFT-240"><a href="#DFT-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span> <span class="o">=</span> <span class="n">conv_crit</span>
</span><span id="DFT-241"><a href="#DFT-241"><span class="linenos"> 241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Convergence criterion for SCF (in Hartrees) &quot;&quot;&quot;</span>
</span><span id="DFT-242"><a href="#DFT-242"><span class="linenos"> 242</span></a>        <span class="c1"># if self.conv_crit is None:</span>
</span><span id="DFT-243"><a href="#DFT-243"><span class="linenos"> 243</span></a>        <span class="c1">#     self.conv_crit = 1.0E-7</span>
</span><span id="DFT-244"><a href="#DFT-244"><span class="linenos"> 244</span></a>
</span><span id="DFT-245"><a href="#DFT-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span> <span class="o">=</span> <span class="mi">50</span> 
</span><span id="DFT-246"><a href="#DFT-246"><span class="linenos"> 246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Maximum number of iterations for SCF &quot;&quot;&quot;</span>
</span><span id="DFT-247"><a href="#DFT-247"><span class="linenos"> 247</span></a>        <span class="c1"># if self.max_itr is None:</span>
</span><span id="DFT-248"><a href="#DFT-248"><span class="linenos"> 248</span></a>        <span class="c1">#     self.max_itr = 50</span>
</span><span id="DFT-249"><a href="#DFT-249"><span class="linenos"> 249</span></a>
</span><span id="DFT-250"><a href="#DFT-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="n">ncores</span>
</span><span id="DFT-251"><a href="#DFT-251"><span class="linenos"> 251</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of cores to be used for DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT-252"><a href="#DFT-252"><span class="linenos"> 252</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-253"><a href="#DFT-253"><span class="linenos"> 253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT-254"><a href="#DFT-254"><span class="linenos"> 254</span></a>
</span><span id="DFT-255"><a href="#DFT-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grids</span> <span class="o">=</span> <span class="n">grids</span> 
</span><span id="DFT-256"><a href="#DFT-256"><span class="linenos"> 256</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation (If None or not supplied, will be generated using NumGrid) &quot;&quot;&quot;</span>
</span><span id="DFT-257"><a href="#DFT-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span> <span class="o">=</span> <span class="n">gridsLevel</span>
</span><span id="DFT-258"><a href="#DFT-258"><span class="linenos"> 258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT-259"><a href="#DFT-259"><span class="linenos"> 259</span></a>
</span><span id="DFT-260"><a href="#DFT-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-261"><a href="#DFT-261"><span class="linenos"> 261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use density fitting (DF) for two-electron Coulomb integrals. This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="DFT-262"><a href="#DFT-262"><span class="linenos"> 262</span></a>
</span><span id="DFT-263"><a href="#DFT-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="o">=</span> <span class="n">auxbasis</span>
</span><span id="DFT-264"><a href="#DFT-264"><span class="linenos"> 264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object to be used as the auxiliary basis for DF &quot;&quot;&quot;</span>
</span><span id="DFT-265"><a href="#DFT-265"><span class="linenos"> 265</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-266"><a href="#DFT-266"><span class="linenos"> 266</span></a>            <span class="n">auxbasis</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-universal-jfit&#39;</span><span class="p">)})</span>
</span><span id="DFT-267"><a href="#DFT-267"><span class="linenos"> 267</span></a>
</span><span id="DFT-268"><a href="#DFT-268"><span class="linenos"> 268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rys</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-269"><a href="#DFT-269"><span class="linenos"> 269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use rys quadrature for the evaluation of two electron integrals (with and without DF)&quot;&quot;&quot;</span>
</span><span id="DFT-270"><a href="#DFT-270"><span class="linenos"> 270</span></a>
</span><span id="DFT-271"><a href="#DFT-271"><span class="linenos"> 271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="DFT-272"><a href="#DFT-272"><span class="linenos"> 272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="DFT-273"><a href="#DFT-273"><span class="linenos"> 273</span></a>
</span><span id="DFT-274"><a href="#DFT-274"><span class="linenos"> 274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">blocksize</span>
</span><span id="DFT-275"><a href="#DFT-275"><span class="linenos"> 275</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Block size for the evaulation of XC term on grids. For CPUs a value of ~5000 is recommended. For GPUs, a value &gt;20480 is recommended. &quot;&quot;&quot;</span>
</span><span id="DFT-276"><a href="#DFT-276"><span class="linenos"> 276</span></a>        <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-277"><a href="#DFT-277"><span class="linenos"> 277</span></a>            <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-278"><a href="#DFT-278"><span class="linenos"> 278</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="DFT-279"><a href="#DFT-279"><span class="linenos"> 279</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-280"><a href="#DFT-280"><span class="linenos"> 280</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="DFT-281"><a href="#DFT-281"><span class="linenos"> 281</span></a>        
</span><span id="DFT-282"><a href="#DFT-282"><span class="linenos"> 282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-283"><a href="#DFT-283"><span class="linenos"> 283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. The algorithm for XC evaluation should be 2 for CPU and 3 for GPU.&quot;&quot;&quot;</span>
</span><span id="DFT-284"><a href="#DFT-284"><span class="linenos"> 284</span></a>        <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-285"><a href="#DFT-285"><span class="linenos"> 285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="DFT-286"><a href="#DFT-286"><span class="linenos"> 286</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-287"><a href="#DFT-287"><span class="linenos"> 287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span> 
</span><span id="DFT-288"><a href="#DFT-288"><span class="linenos"> 288</span></a>
</span><span id="DFT-289"><a href="#DFT-289"><span class="linenos"> 289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-290"><a href="#DFT-290"><span class="linenos"> 290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn on printing debug statements &quot;&quot;&quot;</span>
</span><span id="DFT-291"><a href="#DFT-291"><span class="linenos"> 291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-292"><a href="#DFT-292"><span class="linenos"> 292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable/Disable sorting of DFT grids. Doesn&#39;t seem to offer any signficant advantage.&quot;&quot;&quot;</span>
</span><span id="DFT-293"><a href="#DFT-293"><span class="linenos"> 293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span> <span class="o">=</span> <span class="n">save_ao_values</span>
</span><span id="DFT-294"><a href="#DFT-294"><span class="linenos"> 294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to save atomic orbital (AO) values for reuse during XC evaluation. Improves performance but requires more memory. &quot;&quot;&quot;</span>
</span><span id="DFT-295"><a href="#DFT-295"><span class="linenos"> 295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-296"><a href="#DFT-296"><span class="linenos"> 296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable screening of basis functions for XC term evaluation to reduce computation time drastically. &quot;&quot;&quot;</span>
</span><span id="DFT-297"><a href="#DFT-297"><span class="linenos"> 297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="mf">1e-09</span>
</span><span id="DFT-298"><a href="#DFT-298"><span class="linenos"> 298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Threshold for Schwarz screening of two-electron integrals. Smaller values increase accuracy but reduce sparsity. &quot;&quot;&quot;</span>
</span><span id="DFT-299"><a href="#DFT-299"><span class="linenos"> 299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-300"><a href="#DFT-300"><span class="linenos"> 300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; If True, enforce stricter Schwarz screening to aggressively eliminate small two-electron integrals. &quot;&quot;&quot;</span>
</span><span id="DFT-301"><a href="#DFT-301"><span class="linenos"> 301</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-302"><a href="#DFT-302"><span class="linenos"> 302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use Cholesky decomposition for DF. Slightly speeds up calculations. &quot;&quot;&quot;</span>
</span><span id="DFT-303"><a href="#DFT-303"><span class="linenos"> 303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-304"><a href="#DFT-304"><span class="linenos"> 304</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply orthogonalization to the AO basis. Should be True for most standard calculations. &quot;&quot;&quot;</span>
</span><span id="DFT-305"><a href="#DFT-305"><span class="linenos"> 305</span></a>
</span><span id="DFT-306"><a href="#DFT-306"><span class="linenos"> 306</span></a>
</span><span id="DFT-307"><a href="#DFT-307"><span class="linenos"> 307</span></a>        <span class="c1"># CAO or SAO</span>
</span><span id="DFT-308"><a href="#DFT-308"><span class="linenos"> 308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sao</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-309"><a href="#DFT-309"><span class="linenos"> 309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use SAO basis or CAO basis. Default is CAO basis. &quot;&quot;&quot;</span>
</span><span id="DFT-310"><a href="#DFT-310"><span class="linenos"> 310</span></a>
</span><span id="DFT-311"><a href="#DFT-311"><span class="linenos"> 311</span></a>
</span><span id="DFT-312"><a href="#DFT-312"><span class="linenos"> 312</span></a>        <span class="c1"># GPU acceleration</span>
</span><span id="DFT-313"><a href="#DFT-313"><span class="linenos"> 313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="n">use_gpu</span>
</span><span id="DFT-314"><a href="#DFT-314"><span class="linenos"> 314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use GPU acceleration or not &quot;&quot;&quot;</span>
</span><span id="DFT-315"><a href="#DFT-315"><span class="linenos"> 315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-316"><a href="#DFT-316"><span class="linenos"> 316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the atomic orbitals for XC evaluation in GPU memory or CPU memory. Only relevant if save_ao_values = True. &quot;&quot;&quot;</span>
</span><span id="DFT-317"><a href="#DFT-317"><span class="linenos"> 317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-318"><a href="#DFT-318"><span class="linenos"> 318</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use LibXC&#39;s version of XC functionals or PyFock implementations. </span>
</span><span id="DFT-319"><a href="#DFT-319"><span class="linenos"> 319</span></a><span class="sd">        Only relevant when GPU is used. For GPU calculations it is recommended to use PyFock </span>
</span><span id="DFT-320"><a href="#DFT-320"><span class="linenos"> 320</span></a><span class="sd">        implementation as it avoids CPU-GPU transfers.&quot;&quot;&quot;</span>
</span><span id="DFT-321"><a href="#DFT-321"><span class="linenos"> 321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT-322"><a href="#DFT-322"><span class="linenos"> 322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT-323"><a href="#DFT-323"><span class="linenos"> 323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of GPUs to be used &quot;&quot;&quot;</span>
</span><span id="DFT-324"><a href="#DFT-324"><span class="linenos"> 324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-325"><a href="#DFT-325"><span class="linenos"> 325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether the GPU memory should be freed by force or not&quot;&quot;&quot;</span>
</span><span id="DFT-326"><a href="#DFT-326"><span class="linenos"> 326</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DFT-327"><a href="#DFT-327"><span class="linenos"> 327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span>
</span><span id="DFT-328"><a href="#DFT-328"><span class="linenos"> 328</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="DFT-329"><a href="#DFT-329"><span class="linenos"> 329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="DFT-330"><a href="#DFT-330"><span class="linenos"> 330</span></a>        
</span><span id="DFT-331"><a href="#DFT-331"><span class="linenos"> 331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
</span><span id="DFT-332"><a href="#DFT-332"><span class="linenos"> 332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">64</span><span class="p">)</span>
</span><span id="DFT-333"><a href="#DFT-333"><span class="linenos"> 333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Only for the XC term</span>
</span><span id="DFT-334"><a href="#DFT-334"><span class="linenos"> 334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use dynamic precision switching for XC term or not &quot;&quot;&quot;</span>
</span><span id="DFT-335"><a href="#DFT-335"><span class="linenos"> 335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-336"><a href="#DFT-336"><span class="linenos"> 336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the 3c2e integrals in GPU memory or not. </span>
</span><span id="DFT-337"><a href="#DFT-337"><span class="linenos"> 337</span></a><span class="sd">        Recommended to keep in GPU memory to avoid CPU-GPU transfers at each iteration.&quot;&quot;&quot;</span>
</span><span id="DFT-338"><a href="#DFT-338"><span class="linenos"> 338</span></a>        
</span><span id="DFT-339"><a href="#DFT-339"><span class="linenos"> 339</span></a>        <span class="c1"># self.max_threads_per_block = 1024</span>
</span><span id="DFT-340"><a href="#DFT-340"><span class="linenos"> 340</span></a>        <span class="c1"># self.threads_x = 64</span>
</span><span id="DFT-341"><a href="#DFT-341"><span class="linenos"> 341</span></a>        <span class="c1"># self.threads_y = 16</span>
</span><span id="DFT-342"><a href="#DFT-342"><span class="linenos"> 342</span></a>
</span><span id="DFT-343"><a href="#DFT-343"><span class="linenos"> 343</span></a>        <span class="c1"># if self.use_gpu:</span>
</span><span id="DFT-344"><a href="#DFT-344"><span class="linenos"> 344</span></a>        <span class="c1">#     try:</span>
</span><span id="DFT-345"><a href="#DFT-345"><span class="linenos"> 345</span></a>        <span class="c1">#         global cp</span>
</span><span id="DFT-346"><a href="#DFT-346"><span class="linenos"> 346</span></a>        <span class="c1">#         global cupy_scipy</span>
</span><span id="DFT-347"><a href="#DFT-347"><span class="linenos"> 347</span></a>        <span class="c1">#         import cupy as cp</span>
</span><span id="DFT-348"><a href="#DFT-348"><span class="linenos"> 348</span></a>        <span class="c1">#         import cupyx.scipy as cupy_scipy</span>
</span><span id="DFT-349"><a href="#DFT-349"><span class="linenos"> 349</span></a>        <span class="c1">#         # from cupy.linalg import eig, multi_dot as dot</span>
</span><span id="DFT-350"><a href="#DFT-350"><span class="linenos"> 350</span></a>        <span class="c1">#     except ModuleNotFoundError:</span>
</span><span id="DFT-351"><a href="#DFT-351"><span class="linenos"> 351</span></a>        <span class="c1">#         print(&#39;Cupy was not found!&#39;)</span>
</span><span id="DFT-352"><a href="#DFT-352"><span class="linenos"> 352</span></a>
</span><span id="DFT-353"><a href="#DFT-353"><span class="linenos"> 353</span></a>    <span class="c1"># def removeLinearDep(self, H, S):</span>
</span><span id="DFT-354"><a href="#DFT-354"><span class="linenos"> 354</span></a>    <span class="c1">#     return 1 </span>
</span><span id="DFT-355"><a href="#DFT-355"><span class="linenos"> 355</span></a>    
</span><span id="DFT-356"><a href="#DFT-356"><span class="linenos"> 356</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nuclear_rep_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-357"><a href="#DFT-357"><span class="linenos"> 357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-358"><a href="#DFT-358"><span class="linenos"> 358</span></a><span class="sd">        Compute the nuclear-nuclear repulsion energy.</span>
</span><span id="DFT-359"><a href="#DFT-359"><span class="linenos"> 359</span></a>
</span><span id="DFT-360"><a href="#DFT-360"><span class="linenos"> 360</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-361"><a href="#DFT-361"><span class="linenos"> 361</span></a><span class="sd">        ----------</span>
</span><span id="DFT-362"><a href="#DFT-362"><span class="linenos"> 362</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT-363"><a href="#DFT-363"><span class="linenos"> 363</span></a><span class="sd">            Molecule object containing nuclear coordinates and charges. </span>
</span><span id="DFT-364"><a href="#DFT-364"><span class="linenos"> 364</span></a><span class="sd">            If None, uses `self.mol`.</span>
</span><span id="DFT-365"><a href="#DFT-365"><span class="linenos"> 365</span></a>
</span><span id="DFT-366"><a href="#DFT-366"><span class="linenos"> 366</span></a><span class="sd">        Returns</span>
</span><span id="DFT-367"><a href="#DFT-367"><span class="linenos"> 367</span></a><span class="sd">        -------</span>
</span><span id="DFT-368"><a href="#DFT-368"><span class="linenos"> 368</span></a><span class="sd">        float</span>
</span><span id="DFT-369"><a href="#DFT-369"><span class="linenos"> 369</span></a><span class="sd">            The nuclear repulsion energy in Hartrees.</span>
</span><span id="DFT-370"><a href="#DFT-370"><span class="linenos"> 370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-371"><a href="#DFT-371"><span class="linenos"> 371</span></a>        <span class="c1"># Nuclear-nuclear energy</span>
</span><span id="DFT-372"><a href="#DFT-372"><span class="linenos"> 372</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="DFT-373"><a href="#DFT-373"><span class="linenos"> 373</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT-374"><a href="#DFT-374"><span class="linenos"> 374</span></a>    
</span><span id="DFT-375"><a href="#DFT-375"><span class="linenos"> 375</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-376"><a href="#DFT-376"><span class="linenos"> 376</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="DFT-377"><a href="#DFT-377"><span class="linenos"> 377</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="DFT-378"><a href="#DFT-378"><span class="linenos"> 378</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">):</span>
</span><span id="DFT-379"><a href="#DFT-379"><span class="linenos"> 379</span></a>                    <span class="n">dist</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="DFT-380"><a href="#DFT-380"><span class="linenos"> 380</span></a>                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="DFT-381"><a href="#DFT-381"><span class="linenos"> 381</span></a>
</span><span id="DFT-382"><a href="#DFT-382"><span class="linenos"> 382</span></a>        <span class="k">return</span> <span class="n">e</span>
</span><span id="DFT-383"><a href="#DFT-383"><span class="linenos"> 383</span></a>        
</span><span id="DFT-384"><a href="#DFT-384"><span class="linenos"> 384</span></a>    <span class="c1"># full density matrix for RKS/RHF</span>
</span><span id="DFT-385"><a href="#DFT-385"><span class="linenos"> 385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="DFT-386"><a href="#DFT-386"><span class="linenos"> 386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-387"><a href="#DFT-387"><span class="linenos"> 387</span></a><span class="sd">        Generate the density matrix from molecular orbital coefficients and occupations.</span>
</span><span id="DFT-388"><a href="#DFT-388"><span class="linenos"> 388</span></a>
</span><span id="DFT-389"><a href="#DFT-389"><span class="linenos"> 389</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-390"><a href="#DFT-390"><span class="linenos"> 390</span></a><span class="sd">        ----------</span>
</span><span id="DFT-391"><a href="#DFT-391"><span class="linenos"> 391</span></a><span class="sd">        mo_coeff : ndarray</span>
</span><span id="DFT-392"><a href="#DFT-392"><span class="linenos"> 392</span></a><span class="sd">            Molecular orbital coefficient matrix.</span>
</span><span id="DFT-393"><a href="#DFT-393"><span class="linenos"> 393</span></a>
</span><span id="DFT-394"><a href="#DFT-394"><span class="linenos"> 394</span></a><span class="sd">        mo_occ : ndarray</span>
</span><span id="DFT-395"><a href="#DFT-395"><span class="linenos"> 395</span></a><span class="sd">            Array of MO occupation numbers.</span>
</span><span id="DFT-396"><a href="#DFT-396"><span class="linenos"> 396</span></a>
</span><span id="DFT-397"><a href="#DFT-397"><span class="linenos"> 397</span></a><span class="sd">        Returns</span>
</span><span id="DFT-398"><a href="#DFT-398"><span class="linenos"> 398</span></a><span class="sd">        -------</span>
</span><span id="DFT-399"><a href="#DFT-399"><span class="linenos"> 399</span></a><span class="sd">        ndarray</span>
</span><span id="DFT-400"><a href="#DFT-400"><span class="linenos"> 400</span></a><span class="sd">            Density matrix (RHF/RKS type).</span>
</span><span id="DFT-401"><a href="#DFT-401"><span class="linenos"> 401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-402"><a href="#DFT-402"><span class="linenos"> 402</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-403"><a href="#DFT-403"><span class="linenos"> 403</span></a>   
</span><span id="DFT-404"><a href="#DFT-404"><span class="linenos"> 404</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="DFT-405"><a href="#DFT-405"><span class="linenos"> 405</span></a>    
</span><span id="DFT-406"><a href="#DFT-406"><span class="linenos"> 406</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-407"><a href="#DFT-407"><span class="linenos"> 407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-408"><a href="#DFT-408"><span class="linenos"> 408</span></a><span class="sd">        Assign occupation numbers to molecular orbitals based on their energies.</span>
</span><span id="DFT-409"><a href="#DFT-409"><span class="linenos"> 409</span></a>
</span><span id="DFT-410"><a href="#DFT-410"><span class="linenos"> 410</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-411"><a href="#DFT-411"><span class="linenos"> 411</span></a><span class="sd">        ----------</span>
</span><span id="DFT-412"><a href="#DFT-412"><span class="linenos"> 412</span></a><span class="sd">        mol : Molecule</span>
</span><span id="DFT-413"><a href="#DFT-413"><span class="linenos"> 413</span></a><span class="sd">            Molecule object to extract the number of electrons.</span>
</span><span id="DFT-414"><a href="#DFT-414"><span class="linenos"> 414</span></a>
</span><span id="DFT-415"><a href="#DFT-415"><span class="linenos"> 415</span></a><span class="sd">        energy_mo : ndarray</span>
</span><span id="DFT-416"><a href="#DFT-416"><span class="linenos"> 416</span></a><span class="sd">            Array of MO energies.</span>
</span><span id="DFT-417"><a href="#DFT-417"><span class="linenos"> 417</span></a>
</span><span id="DFT-418"><a href="#DFT-418"><span class="linenos"> 418</span></a><span class="sd">        coeff_mo : ndarray</span>
</span><span id="DFT-419"><a href="#DFT-419"><span class="linenos"> 419</span></a><span class="sd">            Array of MO coefficients (not used but kept for compatibility).</span>
</span><span id="DFT-420"><a href="#DFT-420"><span class="linenos"> 420</span></a>
</span><span id="DFT-421"><a href="#DFT-421"><span class="linenos"> 421</span></a><span class="sd">        Returns</span>
</span><span id="DFT-422"><a href="#DFT-422"><span class="linenos"> 422</span></a><span class="sd">        -------</span>
</span><span id="DFT-423"><a href="#DFT-423"><span class="linenos"> 423</span></a><span class="sd">        ndarray</span>
</span><span id="DFT-424"><a href="#DFT-424"><span class="linenos"> 424</span></a><span class="sd">            Array of MO occupations (0 or 2 for RHF).</span>
</span><span id="DFT-425"><a href="#DFT-425"><span class="linenos"> 425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-426"><a href="#DFT-426"><span class="linenos"> 426</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="DFT-427"><a href="#DFT-427"><span class="linenos"> 427</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="DFT-428"><a href="#DFT-428"><span class="linenos"> 428</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="DFT-429"><a href="#DFT-429"><span class="linenos"> 429</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="DFT-430"><a href="#DFT-430"><span class="linenos"> 430</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="DFT-431"><a href="#DFT-431"><span class="linenos"> 431</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT-432"><a href="#DFT-432"><span class="linenos"> 432</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span><span id="DFT-433"><a href="#DFT-433"><span class="linenos"> 433</span></a>    
</span><span id="DFT-434"><a href="#DFT-434"><span class="linenos"> 434</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="DFT-435"><a href="#DFT-435"><span class="linenos"> 435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-436"><a href="#DFT-436"><span class="linenos"> 436</span></a><span class="sd">        Generate the density matrix using CuPy for GPU acceleration.</span>
</span><span id="DFT-437"><a href="#DFT-437"><span class="linenos"> 437</span></a>
</span><span id="DFT-438"><a href="#DFT-438"><span class="linenos"> 438</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-439"><a href="#DFT-439"><span class="linenos"> 439</span></a><span class="sd">        ----------</span>
</span><span id="DFT-440"><a href="#DFT-440"><span class="linenos"> 440</span></a><span class="sd">        mo_coeff : cp.ndarray</span>
</span><span id="DFT-441"><a href="#DFT-441"><span class="linenos"> 441</span></a><span class="sd">            Molecular orbital coefficient matrix (on GPU).</span>
</span><span id="DFT-442"><a href="#DFT-442"><span class="linenos"> 442</span></a>
</span><span id="DFT-443"><a href="#DFT-443"><span class="linenos"> 443</span></a><span class="sd">        mo_occ : cp.ndarray</span>
</span><span id="DFT-444"><a href="#DFT-444"><span class="linenos"> 444</span></a><span class="sd">            Array of MO occupation numbers (on GPU).</span>
</span><span id="DFT-445"><a href="#DFT-445"><span class="linenos"> 445</span></a>
</span><span id="DFT-446"><a href="#DFT-446"><span class="linenos"> 446</span></a><span class="sd">        Returns</span>
</span><span id="DFT-447"><a href="#DFT-447"><span class="linenos"> 447</span></a><span class="sd">        -------</span>
</span><span id="DFT-448"><a href="#DFT-448"><span class="linenos"> 448</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT-449"><a href="#DFT-449"><span class="linenos"> 449</span></a><span class="sd">            Density matrix (RHF/RKS type) computed on the GPU.</span>
</span><span id="DFT-450"><a href="#DFT-450"><span class="linenos"> 450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-451"><a href="#DFT-451"><span class="linenos"> 451</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-452"><a href="#DFT-452"><span class="linenos"> 452</span></a>        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="DFT-453"><a href="#DFT-453"><span class="linenos"> 453</span></a>    
</span><span id="DFT-454"><a href="#DFT-454"><span class="linenos"> 454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-455"><a href="#DFT-455"><span class="linenos"> 455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-456"><a href="#DFT-456"><span class="linenos"> 456</span></a><span class="sd">        Assign occupation numbers to MOs using CuPy (for GPU-based calculations).</span>
</span><span id="DFT-457"><a href="#DFT-457"><span class="linenos"> 457</span></a>
</span><span id="DFT-458"><a href="#DFT-458"><span class="linenos"> 458</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-459"><a href="#DFT-459"><span class="linenos"> 459</span></a><span class="sd">        ----------</span>
</span><span id="DFT-460"><a href="#DFT-460"><span class="linenos"> 460</span></a><span class="sd">        mol : Molecule</span>
</span><span id="DFT-461"><a href="#DFT-461"><span class="linenos"> 461</span></a><span class="sd">            Molecule object to determine number of electrons.</span>
</span><span id="DFT-462"><a href="#DFT-462"><span class="linenos"> 462</span></a>
</span><span id="DFT-463"><a href="#DFT-463"><span class="linenos"> 463</span></a><span class="sd">        energy_mo : cp.ndarray</span>
</span><span id="DFT-464"><a href="#DFT-464"><span class="linenos"> 464</span></a><span class="sd">            MO energy array on the GPU.</span>
</span><span id="DFT-465"><a href="#DFT-465"><span class="linenos"> 465</span></a>
</span><span id="DFT-466"><a href="#DFT-466"><span class="linenos"> 466</span></a><span class="sd">        coeff_mo : cp.ndarray</span>
</span><span id="DFT-467"><a href="#DFT-467"><span class="linenos"> 467</span></a><span class="sd">            MO coefficients array on the GPU (not used).</span>
</span><span id="DFT-468"><a href="#DFT-468"><span class="linenos"> 468</span></a>
</span><span id="DFT-469"><a href="#DFT-469"><span class="linenos"> 469</span></a><span class="sd">        Returns</span>
</span><span id="DFT-470"><a href="#DFT-470"><span class="linenos"> 470</span></a><span class="sd">        -------</span>
</span><span id="DFT-471"><a href="#DFT-471"><span class="linenos"> 471</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT-472"><a href="#DFT-472"><span class="linenos"> 472</span></a><span class="sd">            Array of MO occupations (on GPU).</span>
</span><span id="DFT-473"><a href="#DFT-473"><span class="linenos"> 473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-474"><a href="#DFT-474"><span class="linenos"> 474</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="DFT-475"><a href="#DFT-475"><span class="linenos"> 475</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="DFT-476"><a href="#DFT-476"><span class="linenos"> 476</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="DFT-477"><a href="#DFT-477"><span class="linenos"> 477</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="DFT-478"><a href="#DFT-478"><span class="linenos"> 478</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="DFT-479"><a href="#DFT-479"><span class="linenos"> 479</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT-480"><a href="#DFT-480"><span class="linenos"> 480</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span><span id="DFT-481"><a href="#DFT-481"><span class="linenos"> 481</span></a>    
</span><span id="DFT-482"><a href="#DFT-482"><span class="linenos"> 482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-483"><a href="#DFT-483"><span class="linenos"> 483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-484"><a href="#DFT-484"><span class="linenos"> 484</span></a><span class="sd">        Solve the generalized or canonical eigenvalue equation.</span>
</span><span id="DFT-485"><a href="#DFT-485"><span class="linenos"> 485</span></a>
</span><span id="DFT-486"><a href="#DFT-486"><span class="linenos"> 486</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-487"><a href="#DFT-487"><span class="linenos"> 487</span></a><span class="sd">        ----------</span>
</span><span id="DFT-488"><a href="#DFT-488"><span class="linenos"> 488</span></a><span class="sd">        H : ndarray</span>
</span><span id="DFT-489"><a href="#DFT-489"><span class="linenos"> 489</span></a><span class="sd">            Hamiltonian matrix.</span>
</span><span id="DFT-490"><a href="#DFT-490"><span class="linenos"> 490</span></a>
</span><span id="DFT-491"><a href="#DFT-491"><span class="linenos"> 491</span></a><span class="sd">        S : ndarray</span>
</span><span id="DFT-492"><a href="#DFT-492"><span class="linenos"> 492</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="DFT-493"><a href="#DFT-493"><span class="linenos"> 493</span></a>
</span><span id="DFT-494"><a href="#DFT-494"><span class="linenos"> 494</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="DFT-495"><a href="#DFT-495"><span class="linenos"> 495</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="DFT-496"><a href="#DFT-496"><span class="linenos"> 496</span></a>
</span><span id="DFT-497"><a href="#DFT-497"><span class="linenos"> 497</span></a><span class="sd">        x : ndarray, optional</span>
</span><span id="DFT-498"><a href="#DFT-498"><span class="linenos"> 498</span></a><span class="sd">            Transformation matrix (if already computed).</span>
</span><span id="DFT-499"><a href="#DFT-499"><span class="linenos"> 499</span></a>
</span><span id="DFT-500"><a href="#DFT-500"><span class="linenos"> 500</span></a><span class="sd">        Returns</span>
</span><span id="DFT-501"><a href="#DFT-501"><span class="linenos"> 501</span></a><span class="sd">        -------</span>
</span><span id="DFT-502"><a href="#DFT-502"><span class="linenos"> 502</span></a><span class="sd">        tuple of (ndarray, ndarray)</span>
</span><span id="DFT-503"><a href="#DFT-503"><span class="linenos"> 503</span></a><span class="sd">            Eigenvalues and eigenvectors of the system.</span>
</span><span id="DFT-504"><a href="#DFT-504"><span class="linenos"> 504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-505"><a href="#DFT-505"><span class="linenos"> 505</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="DFT-506"><a href="#DFT-506"><span class="linenos"> 506</span></a>            <span class="c1">#Solve the generalized eigenvalue equation HC = SCE</span>
</span><span id="DFT-507"><a href="#DFT-507"><span class="linenos"> 507</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="DFT-508"><a href="#DFT-508"><span class="linenos"> 508</span></a>            
</span><span id="DFT-509"><a href="#DFT-509"><span class="linenos"> 509</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-510"><a href="#DFT-510"><span class="linenos"> 510</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-511"><a href="#DFT-511"><span class="linenos"> 511</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT-512"><a href="#DFT-512"><span class="linenos"> 512</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT-513"><a href="#DFT-513"><span class="linenos"> 513</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT-514"><a href="#DFT-514"><span class="linenos"> 514</span></a>            <span class="n">xHx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="DFT-515"><a href="#DFT-515"><span class="linenos"> 515</span></a>            <span class="c1">#Solve the canonical eigenvalue equation HC = CE</span>
</span><span id="DFT-516"><a href="#DFT-516"><span class="linenos"> 516</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xHx</span><span class="p">)</span>
</span><span id="DFT-517"><a href="#DFT-517"><span class="linenos"> 517</span></a>            <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT-518"><a href="#DFT-518"><span class="linenos"> 518</span></a>
</span><span id="DFT-519"><a href="#DFT-519"><span class="linenos"> 519</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-520"><a href="#DFT-520"><span class="linenos"> 520</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT-521"><a href="#DFT-521"><span class="linenos"> 521</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span><span id="DFT-522"><a href="#DFT-522"><span class="linenos"> 522</span></a>    
</span><span id="DFT-523"><a href="#DFT-523"><span class="linenos"> 523</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DFT-524"><a href="#DFT-524"><span class="linenos"> 524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-525"><a href="#DFT-525"><span class="linenos"> 525</span></a><span class="sd">        Solve the generalized eigenvalue problem using CuPy (GPU).</span>
</span><span id="DFT-526"><a href="#DFT-526"><span class="linenos"> 526</span></a>
</span><span id="DFT-527"><a href="#DFT-527"><span class="linenos"> 527</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-528"><a href="#DFT-528"><span class="linenos"> 528</span></a><span class="sd">        ----------</span>
</span><span id="DFT-529"><a href="#DFT-529"><span class="linenos"> 529</span></a><span class="sd">        H : cp.ndarray</span>
</span><span id="DFT-530"><a href="#DFT-530"><span class="linenos"> 530</span></a><span class="sd">            Hamiltonian matrix (on GPU).</span>
</span><span id="DFT-531"><a href="#DFT-531"><span class="linenos"> 531</span></a>
</span><span id="DFT-532"><a href="#DFT-532"><span class="linenos"> 532</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="DFT-533"><a href="#DFT-533"><span class="linenos"> 533</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="DFT-534"><a href="#DFT-534"><span class="linenos"> 534</span></a>
</span><span id="DFT-535"><a href="#DFT-535"><span class="linenos"> 535</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="DFT-536"><a href="#DFT-536"><span class="linenos"> 536</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="DFT-537"><a href="#DFT-537"><span class="linenos"> 537</span></a>
</span><span id="DFT-538"><a href="#DFT-538"><span class="linenos"> 538</span></a><span class="sd">        Returns</span>
</span><span id="DFT-539"><a href="#DFT-539"><span class="linenos"> 539</span></a><span class="sd">        -------</span>
</span><span id="DFT-540"><a href="#DFT-540"><span class="linenos"> 540</span></a><span class="sd">        tuple of (cp.ndarray, cp.ndarray)</span>
</span><span id="DFT-541"><a href="#DFT-541"><span class="linenos"> 541</span></a><span class="sd">            Eigenvalues and eigenvectors (on GPU).</span>
</span><span id="DFT-542"><a href="#DFT-542"><span class="linenos"> 542</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-543"><a href="#DFT-543"><span class="linenos"> 543</span></a>        <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT-544"><a href="#DFT-544"><span class="linenos"> 544</span></a>        <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT-545"><a href="#DFT-545"><span class="linenos"> 545</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT-546"><a href="#DFT-546"><span class="linenos"> 546</span></a>        <span class="n">xhx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="DFT-547"><a href="#DFT-547"><span class="linenos"> 547</span></a>        <span class="c1">#Solve the canonical eigenvalue equation HC = SCE</span>
</span><span id="DFT-548"><a href="#DFT-548"><span class="linenos"> 548</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xhx</span><span class="p">)</span>
</span><span id="DFT-549"><a href="#DFT-549"><span class="linenos"> 549</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT-550"><a href="#DFT-550"><span class="linenos"> 550</span></a>
</span><span id="DFT-551"><a href="#DFT-551"><span class="linenos"> 551</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-552"><a href="#DFT-552"><span class="linenos"> 552</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">cp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT-553"><a href="#DFT-553"><span class="linenos"> 553</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span><span id="DFT-554"><a href="#DFT-554"><span class="linenos"> 554</span></a>    
</span><span id="DFT-555"><a href="#DFT-555"><span class="linenos"> 555</span></a>
</span><span id="DFT-556"><a href="#DFT-556"><span class="linenos"> 556</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-557"><a href="#DFT-557"><span class="linenos"> 557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-558"><a href="#DFT-558"><span class="linenos"> 558</span></a><span class="sd">        Compute the core Hamiltonian matrix (T + V).</span>
</span><span id="DFT-559"><a href="#DFT-559"><span class="linenos"> 559</span></a>
</span><span id="DFT-560"><a href="#DFT-560"><span class="linenos"> 560</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-561"><a href="#DFT-561"><span class="linenos"> 561</span></a><span class="sd">        ----------</span>
</span><span id="DFT-562"><a href="#DFT-562"><span class="linenos"> 562</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT-563"><a href="#DFT-563"><span class="linenos"> 563</span></a><span class="sd">            Molecule object.</span>
</span><span id="DFT-564"><a href="#DFT-564"><span class="linenos"> 564</span></a>
</span><span id="DFT-565"><a href="#DFT-565"><span class="linenos"> 565</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="DFT-566"><a href="#DFT-566"><span class="linenos"> 566</span></a><span class="sd">            Basis set object.</span>
</span><span id="DFT-567"><a href="#DFT-567"><span class="linenos"> 567</span></a>
</span><span id="DFT-568"><a href="#DFT-568"><span class="linenos"> 568</span></a><span class="sd">        Returns</span>
</span><span id="DFT-569"><a href="#DFT-569"><span class="linenos"> 569</span></a><span class="sd">        -------</span>
</span><span id="DFT-570"><a href="#DFT-570"><span class="linenos"> 570</span></a><span class="sd">        ndarray</span>
</span><span id="DFT-571"><a href="#DFT-571"><span class="linenos"> 571</span></a><span class="sd">            Core Hamiltonian matrix.</span>
</span><span id="DFT-572"><a href="#DFT-572"><span class="linenos"> 572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-573"><a href="#DFT-573"><span class="linenos"> 573</span></a>        <span class="c1">#Get the core Hamiltonian</span>
</span><span id="DFT-574"><a href="#DFT-574"><span class="linenos"> 574</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-575"><a href="#DFT-575"><span class="linenos"> 575</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT-576"><a href="#DFT-576"><span class="linenos"> 576</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-577"><a href="#DFT-577"><span class="linenos"> 577</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT-578"><a href="#DFT-578"><span class="linenos"> 578</span></a>        <span class="n">nao</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span> 
</span><span id="DFT-579"><a href="#DFT-579"><span class="linenos"> 579</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
</span><span id="DFT-580"><a href="#DFT-580"><span class="linenos"> 580</span></a>        <span class="n">Vmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="DFT-581"><a href="#DFT-581"><span class="linenos"> 581</span></a>        <span class="n">Tmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-582"><a href="#DFT-582"><span class="linenos"> 582</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">Vmat</span> <span class="o">+</span> <span class="n">Tmat</span>
</span><span id="DFT-583"><a href="#DFT-583"><span class="linenos"> 583</span></a>
</span><span id="DFT-584"><a href="#DFT-584"><span class="linenos"> 584</span></a>        <span class="k">return</span> <span class="n">H</span>
</span><span id="DFT-585"><a href="#DFT-585"><span class="linenos"> 585</span></a>
</span><span id="DFT-586"><a href="#DFT-586"><span class="linenos"> 586</span></a>
</span><span id="DFT-587"><a href="#DFT-587"><span class="linenos"> 587</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">guessCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT-588"><a href="#DFT-588"><span class="linenos"> 588</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-589"><a href="#DFT-589"><span class="linenos"> 589</span></a><span class="sd">        Generate a guess density matrix using the core Hamiltonian.</span>
</span><span id="DFT-590"><a href="#DFT-590"><span class="linenos"> 590</span></a>
</span><span id="DFT-591"><a href="#DFT-591"><span class="linenos"> 591</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-592"><a href="#DFT-592"><span class="linenos"> 592</span></a><span class="sd">        ----------</span>
</span><span id="DFT-593"><a href="#DFT-593"><span class="linenos"> 593</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT-594"><a href="#DFT-594"><span class="linenos"> 594</span></a><span class="sd">            Molecule object.</span>
</span><span id="DFT-595"><a href="#DFT-595"><span class="linenos"> 595</span></a>
</span><span id="DFT-596"><a href="#DFT-596"><span class="linenos"> 596</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="DFT-597"><a href="#DFT-597"><span class="linenos"> 597</span></a><span class="sd">            Basis set.</span>
</span><span id="DFT-598"><a href="#DFT-598"><span class="linenos"> 598</span></a>
</span><span id="DFT-599"><a href="#DFT-599"><span class="linenos"> 599</span></a><span class="sd">        Hcore : ndarray, optional</span>
</span><span id="DFT-600"><a href="#DFT-600"><span class="linenos"> 600</span></a><span class="sd">            Core Hamiltonian. If None, it will be computed.</span>
</span><span id="DFT-601"><a href="#DFT-601"><span class="linenos"> 601</span></a>
</span><span id="DFT-602"><a href="#DFT-602"><span class="linenos"> 602</span></a><span class="sd">        S : ndarray, optional</span>
</span><span id="DFT-603"><a href="#DFT-603"><span class="linenos"> 603</span></a><span class="sd">            Overlap matrix. If None, it will be computed.</span>
</span><span id="DFT-604"><a href="#DFT-604"><span class="linenos"> 604</span></a>
</span><span id="DFT-605"><a href="#DFT-605"><span class="linenos"> 605</span></a><span class="sd">        Returns</span>
</span><span id="DFT-606"><a href="#DFT-606"><span class="linenos"> 606</span></a><span class="sd">        -------</span>
</span><span id="DFT-607"><a href="#DFT-607"><span class="linenos"> 607</span></a><span class="sd">        ndarray</span>
</span><span id="DFT-608"><a href="#DFT-608"><span class="linenos"> 608</span></a><span class="sd">            Initial guess density matrix.</span>
</span><span id="DFT-609"><a href="#DFT-609"><span class="linenos"> 609</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-610"><a href="#DFT-610"><span class="linenos"> 610</span></a>        <span class="c1">#Get a guess for the density matrix using the core Hamiltonian</span>
</span><span id="DFT-611"><a href="#DFT-611"><span class="linenos"> 611</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-612"><a href="#DFT-612"><span class="linenos"> 612</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT-613"><a href="#DFT-613"><span class="linenos"> 613</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-614"><a href="#DFT-614"><span class="linenos"> 614</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT-615"><a href="#DFT-615"><span class="linenos"> 615</span></a>        <span class="k">if</span> <span class="n">Hcore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-616"><a href="#DFT-616"><span class="linenos"> 616</span></a>            <span class="n">Hcore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-617"><a href="#DFT-617"><span class="linenos"> 617</span></a>        <span class="k">if</span> <span class="n">S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-618"><a href="#DFT-618"><span class="linenos"> 618</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-619"><a href="#DFT-619"><span class="linenos"> 619</span></a>
</span><span id="DFT-620"><a href="#DFT-620"><span class="linenos"> 620</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hcore</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="DFT-621"><a href="#DFT-621"><span class="linenos"> 621</span></a>        <span class="c1"># print(eigvalues)</span>
</span><span id="DFT-622"><a href="#DFT-622"><span class="linenos"> 622</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-623"><a href="#DFT-623"><span class="linenos"> 623</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT-624"><a href="#DFT-624"><span class="linenos"> 624</span></a>        <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT-625"><a href="#DFT-625"><span class="linenos"> 625</span></a>        <span class="c1"># print(mo_occ)</span>
</span><span id="DFT-626"><a href="#DFT-626"><span class="linenos"> 626</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT-627"><a href="#DFT-627"><span class="linenos"> 627</span></a>
</span><span id="DFT-628"><a href="#DFT-628"><span class="linenos"> 628</span></a>        <span class="k">return</span> <span class="n">dmat</span>
</span><span id="DFT-629"><a href="#DFT-629"><span class="linenos"> 629</span></a>    
</span><span id="DFT-630"><a href="#DFT-630"><span class="linenos"> 630</span></a>
</span><span id="DFT-631"><a href="#DFT-631"><span class="linenos"> 631</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="DFT-632"><a href="#DFT-632"><span class="linenos"> 632</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-633"><a href="#DFT-633"><span class="linenos"> 633</span></a><span class="sd">        Perform Direct Inversion in the Iterative Subspace (DIIS) to improve SCF convergence.</span>
</span><span id="DFT-634"><a href="#DFT-634"><span class="linenos"> 634</span></a>
</span><span id="DFT-635"><a href="#DFT-635"><span class="linenos"> 635</span></a><span class="sd">        Adapted from</span>
</span><span id="DFT-636"><a href="#DFT-636"><span class="linenos"> 636</span></a><span class="sd">        ----------</span>
</span><span id="DFT-637"><a href="#DFT-637"><span class="linenos"> 637</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="DFT-638"><a href="#DFT-638"><span class="linenos"> 638</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="DFT-639"><a href="#DFT-639"><span class="linenos"> 639</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="DFT-640"><a href="#DFT-640"><span class="linenos"> 640</span></a>
</span><span id="DFT-641"><a href="#DFT-641"><span class="linenos"> 641</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-642"><a href="#DFT-642"><span class="linenos"> 642</span></a><span class="sd">        ----------</span>
</span><span id="DFT-643"><a href="#DFT-643"><span class="linenos"> 643</span></a><span class="sd">        S : ndarray</span>
</span><span id="DFT-644"><a href="#DFT-644"><span class="linenos"> 644</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="DFT-645"><a href="#DFT-645"><span class="linenos"> 645</span></a>
</span><span id="DFT-646"><a href="#DFT-646"><span class="linenos"> 646</span></a><span class="sd">        D : ndarray</span>
</span><span id="DFT-647"><a href="#DFT-647"><span class="linenos"> 647</span></a><span class="sd">            Density matrix.</span>
</span><span id="DFT-648"><a href="#DFT-648"><span class="linenos"> 648</span></a>
</span><span id="DFT-649"><a href="#DFT-649"><span class="linenos"> 649</span></a><span class="sd">        F : ndarray</span>
</span><span id="DFT-650"><a href="#DFT-650"><span class="linenos"> 650</span></a><span class="sd">            Fock matrix.</span>
</span><span id="DFT-651"><a href="#DFT-651"><span class="linenos"> 651</span></a>
</span><span id="DFT-652"><a href="#DFT-652"><span class="linenos"> 652</span></a><span class="sd">        Returns</span>
</span><span id="DFT-653"><a href="#DFT-653"><span class="linenos"> 653</span></a><span class="sd">        -------</span>
</span><span id="DFT-654"><a href="#DFT-654"><span class="linenos"> 654</span></a><span class="sd">        ndarray</span>
</span><span id="DFT-655"><a href="#DFT-655"><span class="linenos"> 655</span></a><span class="sd">            DIIS-extrapolated Fock matrix.</span>
</span><span id="DFT-656"><a href="#DFT-656"><span class="linenos"> 656</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-657"><a href="#DFT-657"><span class="linenos"> 657</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">dot</span><span class="p">([</span><span class="n">F</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">S</span><span class="p">])</span>
</span><span id="DFT-658"><a href="#DFT-658"><span class="linenos"> 658</span></a>        <span class="c1"># SDF =   np.conjugate(FDS).T </span>
</span><span id="DFT-659"><a href="#DFT-659"><span class="linenos"> 659</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="DFT-660"><a href="#DFT-660"><span class="linenos"> 660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="DFT-661"><a href="#DFT-661"><span class="linenos"> 661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="DFT-662"><a href="#DFT-662"><span class="linenos"> 662</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="DFT-663"><a href="#DFT-663"><span class="linenos"> 663</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="DFT-664"><a href="#DFT-664"><span class="linenos"> 664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="DFT-665"><a href="#DFT-665"><span class="linenos"> 665</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-666"><a href="#DFT-666"><span class="linenos"> 666</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="DFT-667"><a href="#DFT-667"><span class="linenos"> 667</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="DFT-668"><a href="#DFT-668"><span class="linenos"> 668</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT-669"><a href="#DFT-669"><span class="linenos"> 669</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-670"><a href="#DFT-670"><span class="linenos"> 670</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="DFT-671"><a href="#DFT-671"><span class="linenos"> 671</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="DFT-672"><a href="#DFT-672"><span class="linenos"> 672</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-673"><a href="#DFT-673"><span class="linenos"> 673</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="DFT-674"><a href="#DFT-674"><span class="linenos"> 674</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="DFT-675"><a href="#DFT-675"><span class="linenos"> 675</span></a>        <span class="c1"># for i in range(nKS):</span>
</span><span id="DFT-676"><a href="#DFT-676"><span class="linenos"> 676</span></a>        <span class="c1">#     for j in range(i+1):</span>
</span><span id="DFT-677"><a href="#DFT-677"><span class="linenos"> 677</span></a>        <span class="c1">#         print(self.errVecs[i].shape)</span>
</span><span id="DFT-678"><a href="#DFT-678"><span class="linenos"> 678</span></a>        <span class="c1">#         B[i,j] = np.real(np.dot(np.conjugate(self.errVecs[i]).T, self.errVecs[j]))</span>
</span><span id="DFT-679"><a href="#DFT-679"><span class="linenos"> 679</span></a>        <span class="c1">#         B[j,i] = B[i,j]</span>
</span><span id="DFT-680"><a href="#DFT-680"><span class="linenos"> 680</span></a>                                                    
</span><span id="DFT-681"><a href="#DFT-681"><span class="linenos"> 681</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="DFT-682"><a href="#DFT-682"><span class="linenos"> 682</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT-683"><a href="#DFT-683"><span class="linenos"> 683</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="DFT-684"><a href="#DFT-684"><span class="linenos"> 684</span></a>
</span><span id="DFT-685"><a href="#DFT-685"><span class="linenos"> 685</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="DFT-686"><a href="#DFT-686"><span class="linenos"> 686</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="DFT-687"><a href="#DFT-687"><span class="linenos"> 687</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="DFT-688"><a href="#DFT-688"><span class="linenos"> 688</span></a>
</span><span id="DFT-689"><a href="#DFT-689"><span class="linenos"> 689</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="DFT-690"><a href="#DFT-690"><span class="linenos"> 690</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="DFT-691"><a href="#DFT-691"><span class="linenos"> 691</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="DFT-692"><a href="#DFT-692"><span class="linenos"> 692</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(weight * KS)&#39;</span><span class="p">)</span>
</span><span id="DFT-693"><a href="#DFT-693"><span class="linenos"> 693</span></a>
</span><span id="DFT-694"><a href="#DFT-694"><span class="linenos"> 694</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span><span id="DFT-695"><a href="#DFT-695"><span class="linenos"> 695</span></a>    
</span><span id="DFT-696"><a href="#DFT-696"><span class="linenos"> 696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="DFT-697"><a href="#DFT-697"><span class="linenos"> 697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-698"><a href="#DFT-698"><span class="linenos"> 698</span></a><span class="sd">        Perform DIIS on GPU using CuPy to accelerate SCF convergence.</span>
</span><span id="DFT-699"><a href="#DFT-699"><span class="linenos"> 699</span></a>
</span><span id="DFT-700"><a href="#DFT-700"><span class="linenos"> 700</span></a><span class="sd">        Adapted from</span>
</span><span id="DFT-701"><a href="#DFT-701"><span class="linenos"> 701</span></a><span class="sd">        ----------</span>
</span><span id="DFT-702"><a href="#DFT-702"><span class="linenos"> 702</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="DFT-703"><a href="#DFT-703"><span class="linenos"> 703</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="DFT-704"><a href="#DFT-704"><span class="linenos"> 704</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="DFT-705"><a href="#DFT-705"><span class="linenos"> 705</span></a>
</span><span id="DFT-706"><a href="#DFT-706"><span class="linenos"> 706</span></a><span class="sd">        Parameters</span>
</span><span id="DFT-707"><a href="#DFT-707"><span class="linenos"> 707</span></a><span class="sd">        ----------</span>
</span><span id="DFT-708"><a href="#DFT-708"><span class="linenos"> 708</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="DFT-709"><a href="#DFT-709"><span class="linenos"> 709</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="DFT-710"><a href="#DFT-710"><span class="linenos"> 710</span></a>
</span><span id="DFT-711"><a href="#DFT-711"><span class="linenos"> 711</span></a><span class="sd">        D : cp.ndarray</span>
</span><span id="DFT-712"><a href="#DFT-712"><span class="linenos"> 712</span></a><span class="sd">            Density matrix (on GPU).</span>
</span><span id="DFT-713"><a href="#DFT-713"><span class="linenos"> 713</span></a>
</span><span id="DFT-714"><a href="#DFT-714"><span class="linenos"> 714</span></a><span class="sd">        F : cp.ndarray</span>
</span><span id="DFT-715"><a href="#DFT-715"><span class="linenos"> 715</span></a><span class="sd">            Fock matrix (on GPU).</span>
</span><span id="DFT-716"><a href="#DFT-716"><span class="linenos"> 716</span></a>
</span><span id="DFT-717"><a href="#DFT-717"><span class="linenos"> 717</span></a><span class="sd">        Returns</span>
</span><span id="DFT-718"><a href="#DFT-718"><span class="linenos"> 718</span></a><span class="sd">        -------</span>
</span><span id="DFT-719"><a href="#DFT-719"><span class="linenos"> 719</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT-720"><a href="#DFT-720"><span class="linenos"> 720</span></a><span class="sd">            DIIS-extrapolated Fock matrix (on GPU).</span>
</span><span id="DFT-721"><a href="#DFT-721"><span class="linenos"> 721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-722"><a href="#DFT-722"><span class="linenos"> 722</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">F</span> <span class="o">@</span> <span class="n">D</span> <span class="o">@</span> <span class="n">S</span>
</span><span id="DFT-723"><a href="#DFT-723"><span class="linenos"> 723</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="DFT-724"><a href="#DFT-724"><span class="linenos"> 724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="DFT-725"><a href="#DFT-725"><span class="linenos"> 725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="DFT-726"><a href="#DFT-726"><span class="linenos"> 726</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="DFT-727"><a href="#DFT-727"><span class="linenos"> 727</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="DFT-728"><a href="#DFT-728"><span class="linenos"> 728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="DFT-729"><a href="#DFT-729"><span class="linenos"> 729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-730"><a href="#DFT-730"><span class="linenos"> 730</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="DFT-731"><a href="#DFT-731"><span class="linenos"> 731</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="DFT-732"><a href="#DFT-732"><span class="linenos"> 732</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT-733"><a href="#DFT-733"><span class="linenos"> 733</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-734"><a href="#DFT-734"><span class="linenos"> 734</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="DFT-735"><a href="#DFT-735"><span class="linenos"> 735</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="DFT-736"><a href="#DFT-736"><span class="linenos"> 736</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-737"><a href="#DFT-737"><span class="linenos"> 737</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="DFT-738"><a href="#DFT-738"><span class="linenos"> 738</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="DFT-739"><a href="#DFT-739"><span class="linenos"> 739</span></a>                                                    
</span><span id="DFT-740"><a href="#DFT-740"><span class="linenos"> 740</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="DFT-741"><a href="#DFT-741"><span class="linenos"> 741</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT-742"><a href="#DFT-742"><span class="linenos"> 742</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="DFT-743"><a href="#DFT-743"><span class="linenos"> 743</span></a>
</span><span id="DFT-744"><a href="#DFT-744"><span class="linenos"> 744</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="DFT-745"><a href="#DFT-745"><span class="linenos"> 745</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="DFT-746"><a href="#DFT-746"><span class="linenos"> 746</span></a>        <span class="k">assert</span> <span class="n">cp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="DFT-747"><a href="#DFT-747"><span class="linenos"> 747</span></a>
</span><span id="DFT-748"><a href="#DFT-748"><span class="linenos"> 748</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="DFT-749"><a href="#DFT-749"><span class="linenos"> 749</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="DFT-750"><a href="#DFT-750"><span class="linenos"> 750</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="DFT-751"><a href="#DFT-751"><span class="linenos"> 751</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">KS</span>
</span><span id="DFT-752"><a href="#DFT-752"><span class="linenos"> 752</span></a>
</span><span id="DFT-753"><a href="#DFT-753"><span class="linenos"> 753</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span><span id="DFT-754"><a href="#DFT-754"><span class="linenos"> 754</span></a>
</span><span id="DFT-755"><a href="#DFT-755"><span class="linenos"> 755</span></a>    <span class="c1"># @profile</span>
</span><span id="DFT-756"><a href="#DFT-756"><span class="linenos"> 756</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DFT-757"><a href="#DFT-757"><span class="linenos"> 757</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT-758"><a href="#DFT-758"><span class="linenos"> 758</span></a><span class="sd">        Perform Self-Consistent Field (SCF) calculation for Density Functional Theory (DFT).</span>
</span><span id="DFT-759"><a href="#DFT-759"><span class="linenos"> 759</span></a><span class="sd">        </span>
</span><span id="DFT-760"><a href="#DFT-760"><span class="linenos"> 760</span></a><span class="sd">        This method implements a complete DFT SCF procedure including:</span>
</span><span id="DFT-761"><a href="#DFT-761"><span class="linenos"> 761</span></a><span class="sd">        - One-electron integral calculation (overlap, kinetic, nuclear attraction)</span>
</span><span id="DFT-762"><a href="#DFT-762"><span class="linenos"> 762</span></a><span class="sd">        - Two-electron integral calculation (4-center ERIs or density fitting)</span>
</span><span id="DFT-763"><a href="#DFT-763"><span class="linenos"> 763</span></a><span class="sd">        - Grid generation and pruning for exchange-correlation evaluation</span>
</span><span id="DFT-764"><a href="#DFT-764"><span class="linenos"> 764</span></a><span class="sd">        - Iterative SCF cycles with DIIS convergence acceleration</span>
</span><span id="DFT-765"><a href="#DFT-765"><span class="linenos"> 765</span></a><span class="sd">        - Exchange-correlation energy and potential evaluation using LibXC</span>
</span><span id="DFT-766"><a href="#DFT-766"><span class="linenos"> 766</span></a><span class="sd">        - GPU acceleration support for performance-critical operations</span>
</span><span id="DFT-767"><a href="#DFT-767"><span class="linenos"> 767</span></a><span class="sd">        </span>
</span><span id="DFT-768"><a href="#DFT-768"><span class="linenos"> 768</span></a><span class="sd">        The implementation supports multiple algorithmic variants:</span>
</span><span id="DFT-769"><a href="#DFT-769"><span class="linenos"> 769</span></a><span class="sd">        - Density fitting (DF)</span>
</span><span id="DFT-770"><a href="#DFT-770"><span class="linenos"> 770</span></a><span class="sd">        - Schwarz screening for integral sparsity</span>
</span><span id="DFT-771"><a href="#DFT-771"><span class="linenos"> 771</span></a><span class="sd">        - Multiple XC evaluation algorithms (CPU/GPU optimized)</span>
</span><span id="DFT-772"><a href="#DFT-772"><span class="linenos"> 772</span></a><span class="sd">        - Dynamic precision switching for GPU calculations</span>
</span><span id="DFT-773"><a href="#DFT-773"><span class="linenos"> 773</span></a><span class="sd">        </span>
</span><span id="DFT-774"><a href="#DFT-774"><span class="linenos"> 774</span></a><span class="sd">        SCF Procedure:</span>
</span><span id="DFT-775"><a href="#DFT-775"><span class="linenos"> 775</span></a><span class="sd">        1. Initialize one-electron integrals (S, T, V_nuc)</span>
</span><span id="DFT-776"><a href="#DFT-776"><span class="linenos"> 776</span></a><span class="sd">        2. Calculate/prepare two-electron integrals with optional screening</span>
</span><span id="DFT-777"><a href="#DFT-777"><span class="linenos"> 777</span></a><span class="sd">        3. Generate and prune integration grids for XC evaluation</span>
</span><span id="DFT-778"><a href="#DFT-778"><span class="linenos"> 778</span></a><span class="sd">        4. Iterative SCF loop:</span>
</span><span id="DFT-779"><a href="#DFT-779"><span class="linenos"> 779</span></a><span class="sd">        - Build Coulomb matrix J from density matrix</span>
</span><span id="DFT-780"><a href="#DFT-780"><span class="linenos"> 780</span></a><span class="sd">        - Evaluate exchange-correlation energy/potential on grids</span>
</span><span id="DFT-781"><a href="#DFT-781"><span class="linenos"> 781</span></a><span class="sd">        - Form Kohn-Sham matrix: H_KS = H_core + J + V_xc</span>
</span><span id="DFT-782"><a href="#DFT-782"><span class="linenos"> 782</span></a><span class="sd">        - Apply DIIS convergence acceleration</span>
</span><span id="DFT-783"><a href="#DFT-783"><span class="linenos"> 783</span></a><span class="sd">        - Diagonalize KS matrix to get new orbitals</span>
</span><span id="DFT-784"><a href="#DFT-784"><span class="linenos"> 784</span></a><span class="sd">        - Generate new density matrix from occupied orbitals</span>
</span><span id="DFT-785"><a href="#DFT-785"><span class="linenos"> 785</span></a><span class="sd">        - Check energy convergence</span>
</span><span id="DFT-786"><a href="#DFT-786"><span class="linenos"> 786</span></a><span class="sd">        5. Return converged total energy and density matrix</span>
</span><span id="DFT-787"><a href="#DFT-787"><span class="linenos"> 787</span></a><span class="sd">        </span>
</span><span id="DFT-788"><a href="#DFT-788"><span class="linenos"> 788</span></a><span class="sd">        Computational Features:</span>
</span><span id="DFT-789"><a href="#DFT-789"><span class="linenos"> 789</span></a><span class="sd">        - Multi-threading support via Numba and configurable core count</span>
</span><span id="DFT-790"><a href="#DFT-790"><span class="linenos"> 790</span></a><span class="sd">        - GPU acceleration using CuPy for grid-based operations</span>
</span><span id="DFT-791"><a href="#DFT-791"><span class="linenos"> 791</span></a><span class="sd">        - Memory-efficient batched evaluation of XC terms</span>
</span><span id="DFT-792"><a href="#DFT-792"><span class="linenos"> 792</span></a><span class="sd">        - Multiple density fitting algorithms (DF_algo 1-10)</span>
</span><span id="DFT-793"><a href="#DFT-793"><span class="linenos"> 793</span></a><span class="sd">        - Basis function screening for XC evaluation efficiency</span>
</span><span id="DFT-794"><a href="#DFT-794"><span class="linenos"> 794</span></a><span class="sd">        - Optional Cholesky decomposition for 2-center integrals</span>
</span><span id="DFT-795"><a href="#DFT-795"><span class="linenos"> 795</span></a><span class="sd">        </span>
</span><span id="DFT-796"><a href="#DFT-796"><span class="linenos"> 796</span></a><span class="sd">        Returns:</span>
</span><span id="DFT-797"><a href="#DFT-797"><span class="linenos"> 797</span></a><span class="sd">        --------</span>
</span><span id="DFT-798"><a href="#DFT-798"><span class="linenos"> 798</span></a><span class="sd">        tuple[float, numpy.ndarray]</span>
</span><span id="DFT-799"><a href="#DFT-799"><span class="linenos"> 799</span></a><span class="sd">            Etot : float</span>
</span><span id="DFT-800"><a href="#DFT-800"><span class="linenos"> 800</span></a><span class="sd">                Converged total electronic energy in atomic units</span>
</span><span id="DFT-801"><a href="#DFT-801"><span class="linenos"> 801</span></a><span class="sd">            dmat : numpy.ndarray, shape (nbf, nbf)</span>
</span><span id="DFT-802"><a href="#DFT-802"><span class="linenos"> 802</span></a><span class="sd">                Converged density matrix in atomic orbital basis</span>
</span><span id="DFT-803"><a href="#DFT-803"><span class="linenos"> 803</span></a><span class="sd">                </span>
</span><span id="DFT-804"><a href="#DFT-804"><span class="linenos"> 804</span></a><span class="sd">        Raises:</span>
</span><span id="DFT-805"><a href="#DFT-805"><span class="linenos"> 805</span></a><span class="sd">        -------</span>
</span><span id="DFT-806"><a href="#DFT-806"><span class="linenos"> 806</span></a><span class="sd">        ConvergenceError</span>
</span><span id="DFT-807"><a href="#DFT-807"><span class="linenos"> 807</span></a><span class="sd">            If SCF fails to converge within max_itr iterations</span>
</span><span id="DFT-808"><a href="#DFT-808"><span class="linenos"> 808</span></a><span class="sd">            </span>
</span><span id="DFT-809"><a href="#DFT-809"><span class="linenos"> 809</span></a><span class="sd">        Notes:</span>
</span><span id="DFT-810"><a href="#DFT-810"><span class="linenos"> 810</span></a><span class="sd">        ------</span>
</span><span id="DFT-811"><a href="#DFT-811"><span class="linenos"> 811</span></a><span class="sd">        - Uses class attributes for all computational parameters (basis, xc, conv_crit, etc.)</span>
</span><span id="DFT-812"><a href="#DFT-812"><span class="linenos"> 812</span></a><span class="sd">        - Extensive timing and profiling information printed during execution</span>
</span><span id="DFT-813"><a href="#DFT-813"><span class="linenos"> 813</span></a><span class="sd">        - Memory usage information displayed for large arrays</span>
</span><span id="DFT-814"><a href="#DFT-814"><span class="linenos"> 814</span></a><span class="sd">        - GPU memory automatically freed after completion</span>
</span><span id="DFT-815"><a href="#DFT-815"><span class="linenos"> 815</span></a><span class="sd">        - Supports both Cartesian (CAO) and Spherical (SAO) atomic orbital bases</span>
</span><span id="DFT-816"><a href="#DFT-816"><span class="linenos"> 816</span></a><span class="sd">        </span>
</span><span id="DFT-817"><a href="#DFT-817"><span class="linenos"> 817</span></a><span class="sd">        The function performs comprehensive error checking and provides detailed</span>
</span><span id="DFT-818"><a href="#DFT-818"><span class="linenos"> 818</span></a><span class="sd">        timing breakdowns for performance analysis. GPU acceleration is automatically</span>
</span><span id="DFT-819"><a href="#DFT-819"><span class="linenos"> 819</span></a><span class="sd">        enabled when CuPy is available and use_gpu=True.</span>
</span><span id="DFT-820"><a href="#DFT-820"><span class="linenos"> 820</span></a><span class="sd">        </span>
</span><span id="DFT-821"><a href="#DFT-821"><span class="linenos"> 821</span></a><span class="sd">        Example Energy Components:</span>
</span><span id="DFT-822"><a href="#DFT-822"><span class="linenos"> 822</span></a><span class="sd">        - Electron-nuclear attraction energy</span>
</span><span id="DFT-823"><a href="#DFT-823"><span class="linenos"> 823</span></a><span class="sd">        - Nuclear repulsion energy  </span>
</span><span id="DFT-824"><a href="#DFT-824"><span class="linenos"> 824</span></a><span class="sd">        - Kinetic energy</span>
</span><span id="DFT-825"><a href="#DFT-825"><span class="linenos"> 825</span></a><span class="sd">        - Coulomb (electron-electron repulsion) energy</span>
</span><span id="DFT-826"><a href="#DFT-826"><span class="linenos"> 826</span></a><span class="sd">        - Exchange-correlation energy</span>
</span><span id="DFT-827"><a href="#DFT-827"><span class="linenos"> 827</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT-828"><a href="#DFT-828"><span class="linenos"> 828</span></a>        <span class="c1">#### Timings</span>
</span><span id="DFT-829"><a href="#DFT-829"><span class="linenos"> 829</span></a>        <span class="n">duration1e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-830"><a href="#DFT-830"><span class="linenos"> 830</span></a>        <span class="n">durationDIIS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-831"><a href="#DFT-831"><span class="linenos"> 831</span></a>        <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-832"><a href="#DFT-832"><span class="linenos"> 832</span></a>        <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-833"><a href="#DFT-833"><span class="linenos"> 833</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-834"><a href="#DFT-834"><span class="linenos"> 834</span></a>        <span class="n">durationItr</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-835"><a href="#DFT-835"><span class="linenos"> 835</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-836"><a href="#DFT-836"><span class="linenos"> 836</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-837"><a href="#DFT-837"><span class="linenos"> 837</span></a>        <span class="n">durationDF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-838"><a href="#DFT-838"><span class="linenos"> 838</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-839"><a href="#DFT-839"><span class="linenos"> 839</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-840"><a href="#DFT-840"><span class="linenos"> 840</span></a>        <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-841"><a href="#DFT-841"><span class="linenos"> 841</span></a>        <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-842"><a href="#DFT-842"><span class="linenos"> 842</span></a>        <span class="n">duration2c2e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-843"><a href="#DFT-843"><span class="linenos"> 843</span></a>        <span class="n">durationDF_coeff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-844"><a href="#DFT-844"><span class="linenos"> 844</span></a>        <span class="n">durationDF_gamma</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-845"><a href="#DFT-845"><span class="linenos"> 845</span></a>        <span class="n">durationDF_Jtri</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-846"><a href="#DFT-846"><span class="linenos"> 846</span></a>        <span class="n">durationDF_cholesky</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-847"><a href="#DFT-847"><span class="linenos"> 847</span></a>        <span class="n">startSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>    
</span><span id="DFT-848"><a href="#DFT-848"><span class="linenos"> 848</span></a>
</span><span id="DFT-849"><a href="#DFT-849"><span class="linenos"> 849</span></a>        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT-850"><a href="#DFT-850"><span class="linenos"> 850</span></a>        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT-851"><a href="#DFT-851"><span class="linenos"> 851</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span>
</span><span id="DFT-852"><a href="#DFT-852"><span class="linenos"> 852</span></a>        <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="DFT-853"><a href="#DFT-853"><span class="linenos"> 853</span></a>        <span class="n">conv_crit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span>
</span><span id="DFT-854"><a href="#DFT-854"><span class="linenos"> 854</span></a>        <span class="n">max_itr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span>
</span><span id="DFT-855"><a href="#DFT-855"><span class="linenos"> 855</span></a>        <span class="n">ncores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span>
</span><span id="DFT-856"><a href="#DFT-856"><span class="linenos"> 856</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grids</span>
</span><span id="DFT-857"><a href="#DFT-857"><span class="linenos"> 857</span></a>        <span class="n">gridsLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span>
</span><span id="DFT-858"><a href="#DFT-858"><span class="linenos"> 858</span></a>        <span class="n">isDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span>
</span><span id="DFT-859"><a href="#DFT-859"><span class="linenos"> 859</span></a>        <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span>
</span><span id="DFT-860"><a href="#DFT-860"><span class="linenos"> 860</span></a>        <span class="n">rys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rys</span>
</span><span id="DFT-861"><a href="#DFT-861"><span class="linenos"> 861</span></a>        <span class="n">DF_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span>
</span><span id="DFT-862"><a href="#DFT-862"><span class="linenos"> 862</span></a>        <span class="n">blocksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span>
</span><span id="DFT-863"><a href="#DFT-863"><span class="linenos"> 863</span></a>        <span class="n">XC_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span>
</span><span id="DFT-864"><a href="#DFT-864"><span class="linenos"> 864</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="DFT-865"><a href="#DFT-865"><span class="linenos"> 865</span></a>        <span class="n">sortGrids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span>
</span><span id="DFT-866"><a href="#DFT-866"><span class="linenos"> 866</span></a>        <span class="n">save_ao_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span>
</span><span id="DFT-867"><a href="#DFT-867"><span class="linenos"> 867</span></a>        <span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span>
</span><span id="DFT-868"><a href="#DFT-868"><span class="linenos"> 868</span></a>        <span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span>
</span><span id="DFT-869"><a href="#DFT-869"><span class="linenos"> 869</span></a>        <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span>
</span><span id="DFT-870"><a href="#DFT-870"><span class="linenos"> 870</span></a>        <span class="n">cholesky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span>
</span><span id="DFT-871"><a href="#DFT-871"><span class="linenos"> 871</span></a>        <span class="n">orthogonalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span>
</span><span id="DFT-872"><a href="#DFT-872"><span class="linenos"> 872</span></a>
</span><span id="DFT-873"><a href="#DFT-873"><span class="linenos"> 873</span></a>        <span class="n">print_pyfock_logo</span><span class="p">()</span>
</span><span id="DFT-874"><a href="#DFT-874"><span class="linenos"> 874</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of atoms:&#39;</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="DFT-875"><a href="#DFT-875"><span class="linenos"> 875</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of basis functions (atomic orbitals):&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="DFT-876"><a href="#DFT-876"><span class="linenos"> 876</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of auxiliary basis functions:&#39;</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="DFT-877"><a href="#DFT-877"><span class="linenos"> 877</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">================================================================================</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT-878"><a href="#DFT-878"><span class="linenos"> 878</span></a>
</span><span id="DFT-879"><a href="#DFT-879"><span class="linenos"> 879</span></a>        <span class="n">print_sys_info</span><span class="p">()</span>
</span><span id="DFT-880"><a href="#DFT-880"><span class="linenos"> 880</span></a>
</span><span id="DFT-881"><a href="#DFT-881"><span class="linenos"> 881</span></a>        <span class="c1">#### Set number of cores</span>
</span><span id="DFT-882"><a href="#DFT-882"><span class="linenos"> 882</span></a>        <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT-883"><a href="#DFT-883"><span class="linenos"> 883</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RAYON_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT-884"><a href="#DFT-884"><span class="linenos"> 884</span></a>        
</span><span id="DFT-885"><a href="#DFT-885"><span class="linenos"> 885</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running DFT using &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39; threads for Numba.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-886"><a href="#DFT-886"><span class="linenos"> 886</span></a>        <span class="c1"># if basis is None:</span>
</span><span id="DFT-887"><a href="#DFT-887"><span class="linenos"> 887</span></a>        <span class="c1">#     basis = self.basis</span>
</span><span id="DFT-888"><a href="#DFT-888"><span class="linenos"> 888</span></a>        <span class="c1"># if mol is None:</span>
</span><span id="DFT-889"><a href="#DFT-889"><span class="linenos"> 889</span></a>        <span class="c1">#     mol = self.mol</span>
</span><span id="DFT-890"><a href="#DFT-890"><span class="linenos"> 890</span></a>        <span class="c1"># if xc is None:</span>
</span><span id="DFT-891"><a href="#DFT-891"><span class="linenos"> 891</span></a>        <span class="c1">#     xc = self.xc</span>
</span><span id="DFT-892"><a href="#DFT-892"><span class="linenos"> 892</span></a>        <span class="c1"># if gridsLevel is None:</span>
</span><span id="DFT-893"><a href="#DFT-893"><span class="linenos"> 893</span></a>        <span class="c1">#     gridsLevel = self.gridsLevel</span>
</span><span id="DFT-894"><a href="#DFT-894"><span class="linenos"> 894</span></a>        <span class="c1"># if auxbasis is None:</span>
</span><span id="DFT-895"><a href="#DFT-895"><span class="linenos"> 895</span></a>        <span class="c1">#     auxbasis = Basis(mol, {&#39;all&#39;:Basis.load(mol=mol, basis_name=&#39;def2-universal-jfit&#39;)})</span>
</span><span id="DFT-896"><a href="#DFT-896"><span class="linenos"> 896</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-897"><a href="#DFT-897"><span class="linenos"> 897</span></a>            <span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-898"><a href="#DFT-898"><span class="linenos"> 898</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
</span><span id="DFT-899"><a href="#DFT-899"><span class="linenos"> 899</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
</span><span id="DFT-900"><a href="#DFT-900"><span class="linenos"> 900</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning! AO screening is set to False, but AO values are requested to be saved. </span><span class="se">\</span>
</span><span id="DFT-901"><a href="#DFT-901"><span class="linenos"> 901</span></a><span class="s1">                      AO values can only be saved when XC_BF_SCREEN=TRUE. AO values will not be saved.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-902"><a href="#DFT-902"><span class="linenos"> 902</span></a>                <span class="n">save_ao_values</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-903"><a href="#DFT-903"><span class="linenos"> 903</span></a>        <span class="k">if</span> <span class="n">CUPY_AVAILABLE</span><span class="p">:</span>
</span><span id="DFT-904"><a href="#DFT-904"><span class="linenos"> 904</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-905"><a href="#DFT-905"><span class="linenos"> 905</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration is enabled. Currently this only accelerates AO values and XC term evaluation.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-906"><a href="#DFT-906"><span class="linenos"> 906</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU(s) information:&#39;</span><span class="p">)</span>
</span><span id="DFT-907"><a href="#DFT-907"><span class="linenos"> 907</span></a>                <span class="c1"># print(cp.cuda.Device.mem_info())</span>
</span><span id="DFT-908"><a href="#DFT-908"><span class="linenos"> 908</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">detect</span><span class="p">())</span>
</span><span id="DFT-909"><a href="#DFT-909"><span class="linenos"> 909</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Max threads per block supported by the GPU: &#39;</span><span class="p">,</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-910"><a href="#DFT-910"><span class="linenos"> 910</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The user has specified to use &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; GPU(s).&#39;</span><span class="p">)</span>
</span><span id="DFT-911"><a href="#DFT-911"><span class="linenos"> 911</span></a>            
</span><span id="DFT-912"><a href="#DFT-912"><span class="linenos"> 912</span></a>                <span class="c1"># For CUDA computations</span>
</span><span id="DFT-913"><a href="#DFT-913"><span class="linenos"> 913</span></a>                <span class="n">threads_per_block</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span><span class="p">)</span>
</span><span id="DFT-914"><a href="#DFT-914"><span class="linenos"> 914</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the XC term: &#39;</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-915"><a href="#DFT-915"><span class="linenos"> 915</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the all other calculations: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-916"><a href="#DFT-916"><span class="linenos"> 916</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span><span class="p">:</span>
</span><span id="DFT-917"><a href="#DFT-917"><span class="linenos"> 917</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Will use dynamic precision. &#39;</span><span class="p">)</span>
</span><span id="DFT-918"><a href="#DFT-918"><span class="linenos"> 918</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This means that the XC term will be evaluated in single precision until the &#39;</span><span class="p">)</span>
</span><span id="DFT-919"><a href="#DFT-919"><span class="linenos"> 919</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;relative energy difference b/w successive iterations is less than 5.0E-7.&#39;</span><span class="p">)</span>
</span><span id="DFT-920"><a href="#DFT-920"><span class="linenos"> 920</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span>
</span><span id="DFT-921"><a href="#DFT-921"><span class="linenos"> 921</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-922"><a href="#DFT-922"><span class="linenos"> 922</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="DFT-923"><a href="#DFT-923"><span class="linenos"> 923</span></a>
</span><span id="DFT-924"><a href="#DFT-924"><span class="linenos"> 924</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-925"><a href="#DFT-925"><span class="linenos"> 925</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="DFT-926"><a href="#DFT-926"><span class="linenos"> 926</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-927"><a href="#DFT-927"><span class="linenos"> 927</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="DFT-928"><a href="#DFT-928"><span class="linenos"> 928</span></a>                <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-929"><a href="#DFT-929"><span class="linenos"> 929</span></a>                <span class="n">nb_streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-930"><a href="#DFT-930"><span class="linenos"> 930</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="DFT-931"><a href="#DFT-931"><span class="linenos"> 931</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT-932"><a href="#DFT-932"><span class="linenos"> 932</span></a>                    <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-933"><a href="#DFT-933"><span class="linenos"> 933</span></a>                    <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="DFT-934"><a href="#DFT-934"><span class="linenos"> 934</span></a>                    <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp_stream</span><span class="p">)</span>
</span><span id="DFT-935"><a href="#DFT-935"><span class="linenos"> 935</span></a>                    <span class="n">nb_streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb_stream</span><span class="p">)</span>
</span><span id="DFT-936"><a href="#DFT-936"><span class="linenos"> 936</span></a>                <span class="c1"># Switch back to main GPU</span>
</span><span id="DFT-937"><a href="#DFT-937"><span class="linenos"> 937</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT-938"><a href="#DFT-938"><span class="linenos"> 938</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT-939"><a href="#DFT-939"><span class="linenos"> 939</span></a>                <span class="c1"># # Set some basis function data as cupy arrays to avoid redoing it during XC term evaluation at every SCF iteration</span>
</span><span id="DFT-940"><a href="#DFT-940"><span class="linenos"> 940</span></a>                <span class="c1"># bfs_coords = cp.asarray([basis.bfs_coords], dtype=precision_XC)</span>
</span><span id="DFT-941"><a href="#DFT-941"><span class="linenos"> 941</span></a>                <span class="c1"># bfs_contr_prim_norms = cp.asarray([basis.bfs_contr_prim_norms], dtype=precision_XC)</span>
</span><span id="DFT-942"><a href="#DFT-942"><span class="linenos"> 942</span></a>                <span class="c1"># bfs_lmn = cp.asarray([basis.bfs_lmn])</span>
</span><span id="DFT-943"><a href="#DFT-943"><span class="linenos"> 943</span></a>                <span class="c1"># bfs_nprim = cp.asarray([basis.bfs_nprim])</span>
</span><span id="DFT-944"><a href="#DFT-944"><span class="linenos"> 944</span></a>                <span class="c1"># #The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="DFT-945"><a href="#DFT-945"><span class="linenos"> 945</span></a>                <span class="c1"># #Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="DFT-946"><a href="#DFT-946"><span class="linenos"> 946</span></a>                <span class="c1"># #So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="DFT-947"><a href="#DFT-947"><span class="linenos"> 947</span></a>                <span class="c1"># #that the second dimension is that of the largest list. So that</span>
</span><span id="DFT-948"><a href="#DFT-948"><span class="linenos"> 948</span></a>                <span class="c1"># #it can accomadate all the lists.</span>
</span><span id="DFT-949"><a href="#DFT-949"><span class="linenos"> 949</span></a>                <span class="c1"># maxnprim = max(basis.bfs_nprim)</span>
</span><span id="DFT-950"><a href="#DFT-950"><span class="linenos"> 950</span></a>                <span class="c1"># bfs_coeffs = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT-951"><a href="#DFT-951"><span class="linenos"> 951</span></a>                <span class="c1"># bfs_expnts = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT-952"><a href="#DFT-952"><span class="linenos"> 952</span></a>                <span class="c1"># bfs_prim_norms = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT-953"><a href="#DFT-953"><span class="linenos"> 953</span></a>                <span class="c1"># bfs_radius_cutoff = cp.zeros([basis.bfs_nao], dtype=precision_XC)</span>
</span><span id="DFT-954"><a href="#DFT-954"><span class="linenos"> 954</span></a>                <span class="c1"># for i in range(basis.bfs_nao):</span>
</span><span id="DFT-955"><a href="#DFT-955"><span class="linenos"> 955</span></a>                <span class="c1">#     for j in range(basis.bfs_nprim[i]):</span>
</span><span id="DFT-956"><a href="#DFT-956"><span class="linenos"> 956</span></a>                <span class="c1">#         bfs_coeffs[i,j] = basis.bfs_coeffs[i][j]</span>
</span><span id="DFT-957"><a href="#DFT-957"><span class="linenos"> 957</span></a>                <span class="c1">#         bfs_expnts[i,j] = basis.bfs_expnts[i][j]</span>
</span><span id="DFT-958"><a href="#DFT-958"><span class="linenos"> 958</span></a>                <span class="c1">#         bfs_prim_norms[i,j] = basis.bfs_prim_norms[i][j]</span>
</span><span id="DFT-959"><a href="#DFT-959"><span class="linenos"> 959</span></a>                <span class="c1">#         bfs_radius_cutoff[i] = basis.bfs_radius_cutoff[i]</span>
</span><span id="DFT-960"><a href="#DFT-960"><span class="linenos"> 960</span></a>                <span class="c1"># # Now bf/ao values can be evaluated by calling the following</span>
</span><span id="DFT-961"><a href="#DFT-961"><span class="linenos"> 961</span></a>                <span class="c1"># # bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="DFT-962"><a href="#DFT-962"><span class="linenos"> 962</span></a>                <span class="c1"># bfs_data_as_np_arrays = [bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff]</span>
</span><span id="DFT-963"><a href="#DFT-963"><span class="linenos"> 963</span></a>                
</span><span id="DFT-964"><a href="#DFT-964"><span class="linenos"> 964</span></a>
</span><span id="DFT-965"><a href="#DFT-965"><span class="linenos"> 965</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-966"><a href="#DFT-966"><span class="linenos"> 966</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-967"><a href="#DFT-967"><span class="linenos"> 967</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration requested but cannot be enabled as Cupy is not installed.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-968"><a href="#DFT-968"><span class="linenos"> 968</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-969"><a href="#DFT-969"><span class="linenos"> 969</span></a>
</span><span id="DFT-970"><a href="#DFT-970"><span class="linenos"> 970</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-971"><a href="#DFT-971"><span class="linenos"> 971</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT-972"><a href="#DFT-972"><span class="linenos"> 972</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-973"><a href="#DFT-973"><span class="linenos"> 973</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="DFT-974"><a href="#DFT-974"><span class="linenos"> 974</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-975"><a href="#DFT-975"><span class="linenos"> 975</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-976"><a href="#DFT-976"><span class="linenos"> 976</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-977"><a href="#DFT-977"><span class="linenos"> 977</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Schwarz screening is not yet implemented for 4c2e integrals</span>
</span><span id="DFT-978"><a href="#DFT-978"><span class="linenos"> 978</span></a>        <span class="k">if</span> <span class="n">strict_schwarz</span><span class="p">:</span>
</span><span id="DFT-979"><a href="#DFT-979"><span class="linenos"> 979</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT-980"><a href="#DFT-980"><span class="linenos"> 980</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The stricter variation of Schwarz screening is only compatible with DF algo #6 or #10 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="DFT-981"><a href="#DFT-981"><span class="linenos"> 981</span></a>                <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-982"><a href="#DFT-982"><span class="linenos"> 982</span></a>        <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT-983"><a href="#DFT-983"><span class="linenos"> 983</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT-984"><a href="#DFT-984"><span class="linenos"> 984</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The Cholesky decomposition of 2c2e integrls is only compatible with DF algo #6 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="DFT-985"><a href="#DFT-985"><span class="linenos"> 985</span></a>                <span class="n">cholesky</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-986"><a href="#DFT-986"><span class="linenos"> 986</span></a>        
</span><span id="DFT-987"><a href="#DFT-987"><span class="linenos"> 987</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT-988"><a href="#DFT-988"><span class="linenos"> 988</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Spherical Atomic Orbitals are being used!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT-989"><a href="#DFT-989"><span class="linenos"> 989</span></a>            <span class="c1"># Get the CAO to SAO transformation matrix</span>
</span><span id="DFT-990"><a href="#DFT-990"><span class="linenos"> 990</span></a>            <span class="n">c2sph_mat</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">cart2sph_basis</span><span class="p">()</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT-991"><a href="#DFT-991"><span class="linenos"> 991</span></a>            <span class="c1"># Calculate the pseudoinverse transformation matrix (for back transformation of SAO dmat to CAO dmat)</span>
</span><span id="DFT-992"><a href="#DFT-992"><span class="linenos"> 992</span></a>            <span class="n">sph2c_mat_pseudo</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">sph2cart_basis</span><span class="p">()</span> <span class="c1"># SAO --&gt; CAO</span>
</span><span id="DFT-993"><a href="#DFT-993"><span class="linenos"> 993</span></a>                
</span><span id="DFT-994"><a href="#DFT-994"><span class="linenos"> 994</span></a>
</span><span id="DFT-995"><a href="#DFT-995"><span class="linenos"> 995</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-996"><a href="#DFT-996"><span class="linenos"> 996</span></a>        <span class="c1"># DF_algo = 1 # Worst algorithm for more than 500 bfs/auxbfs (requires 2x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="DFT-997"><a href="#DFT-997"><span class="linenos"> 997</span></a>        <span class="c1"># DF_algo = 2 # Sligthly better (2x memory efficient) algorithm than above (requires 1x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="DFT-998"><a href="#DFT-998"><span class="linenos"> 998</span></a>        <span class="c1"># DF_algo = 3 # Memory effcient without any prefactor. (Can easily be converted into a sparse version, unlike the others) (https://aip.scitation.org/doi/pdf/10.1063/1.1567253)</span>
</span><span id="DFT-999"><a href="#DFT-999"><span class="linenos"> 999</span></a>        <span class="c1"># DF_algo = 4 # Same as 3, except now we use triangular version of ints3c2e to save on memory</span>
</span><span id="DFT-1000"><a href="#DFT-1000"><span class="linenos">1000</span></a>        <span class="c1"># DF_algo = 5 # Same as 4 in terms of memory requirements, however faster in performance due to the use of Schwarz screening.</span>
</span><span id="DFT-1001"><a href="#DFT-1001"><span class="linenos">1001</span></a>        <span class="c1"># DF_algo = 6 # Much cheaper than 4 and 5 in terms of memory requirements because the indices of significant (ij|P) are efficiently calculated without duplicates/temporary arrays. </span>
</span><span id="DFT-1002"><a href="#DFT-1002"><span class="linenos">1002</span></a>        <span class="c1">#               The speed maybe same or just slightly slower. </span>
</span><span id="DFT-1003"><a href="#DFT-1003"><span class="linenos">1003</span></a>        <span class="c1"># DF_algo = 7 # The significant indices (ij|P) are stored even more efficiently by using shell indices instead of bf indices.</span>
</span><span id="DFT-1004"><a href="#DFT-1004"><span class="linenos">1004</span></a>        <span class="c1"># DF_algo = 8 # Similar to 6, except that here the significant indices are not stored resulting in 50% memory savings. The drawback is that it only works in serial which is useful for Google colab or Kaggle perhaps.</span>
</span><span id="DFT-1005"><a href="#DFT-1005"><span class="linenos">1005</span></a>        <span class="c1"># DF_algo = 9 # </span>
</span><span id="DFT-1006"><a href="#DFT-1006"><span class="linenos">1006</span></a>
</span><span id="DFT-1007"><a href="#DFT-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_schwarz</span><span class="p">:</span> <span class="c1"># If a stricter variant of Schwarz screening is not requested</span>
</span><span id="DFT-1008"><a href="#DFT-1008"><span class="linenos">1008</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1009"><a href="#DFT-1009"><span class="linenos">1009</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating one electron integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1010"><a href="#DFT-1010"><span class="linenos">1010</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="DFT-1011"><a href="#DFT-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1012"><a href="#DFT-1012"><span class="linenos">1012</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1013"><a href="#DFT-1013"><span class="linenos">1013</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="DFT-1014"><a href="#DFT-1014"><span class="linenos">1014</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1015"><a href="#DFT-1015"><span class="linenos">1015</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT-1016"><a href="#DFT-1016"><span class="linenos">1016</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="DFT-1017"><a href="#DFT-1017"><span class="linenos">1017</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1018"><a href="#DFT-1018"><span class="linenos">1018</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1019"><a href="#DFT-1019"><span class="linenos">1019</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1020"><a href="#DFT-1020"><span class="linenos">1020</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1021"><a href="#DFT-1021"><span class="linenos">1021</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT-1022"><a href="#DFT-1022"><span class="linenos">1022</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="DFT-1023"><a href="#DFT-1023"><span class="linenos">1023</span></a>
</span><span id="DFT-1024"><a href="#DFT-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1025"><a href="#DFT-1025"><span class="linenos">1025</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1026"><a href="#DFT-1026"><span class="linenos">1026</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="DFT-1027"><a href="#DFT-1027"><span class="linenos">1027</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1028"><a href="#DFT-1028"><span class="linenos">1028</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1029"><a href="#DFT-1029"><span class="linenos">1029</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1030"><a href="#DFT-1030"><span class="linenos">1030</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating overlap and kinetic integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1031"><a href="#DFT-1031"><span class="linenos">1031</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="DFT-1032"><a href="#DFT-1032"><span class="linenos">1032</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1033"><a href="#DFT-1033"><span class="linenos">1033</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1034"><a href="#DFT-1034"><span class="linenos">1034</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1035"><a href="#DFT-1035"><span class="linenos">1035</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT-1036"><a href="#DFT-1036"><span class="linenos">1036</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="DFT-1037"><a href="#DFT-1037"><span class="linenos">1037</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1038"><a href="#DFT-1038"><span class="linenos">1038</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1039"><a href="#DFT-1039"><span class="linenos">1039</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1040"><a href="#DFT-1040"><span class="linenos">1040</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT-1041"><a href="#DFT-1041"><span class="linenos">1041</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="DFT-1042"><a href="#DFT-1042"><span class="linenos">1042</span></a>
</span><span id="DFT-1043"><a href="#DFT-1043"><span class="linenos">1043</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,(</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Factor of 2 because nuclear matrix will also be included here later</span>
</span><span id="DFT-1044"><a href="#DFT-1044"><span class="linenos">1044</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1045"><a href="#DFT-1045"><span class="linenos">1045</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="DFT-1046"><a href="#DFT-1046"><span class="linenos">1046</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1047"><a href="#DFT-1047"><span class="linenos">1047</span></a>
</span><span id="DFT-1048"><a href="#DFT-1048"><span class="linenos">1048</span></a>
</span><span id="DFT-1049"><a href="#DFT-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">dmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-1050"><a href="#DFT-1050"><span class="linenos">1050</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span><span class="o">==</span><span class="s1">&#39;core&#39;</span><span class="p">:</span>
</span><span id="DFT-1051"><a href="#DFT-1051"><span class="linenos">1051</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT-1052"><a href="#DFT-1052"><span class="linenos">1052</span></a>
</span><span id="DFT-1053"><a href="#DFT-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1054"><a href="#DFT-1054"><span class="linenos">1054</span></a>            <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT-1055"><a href="#DFT-1055"><span class="linenos">1055</span></a>            <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1056"><a href="#DFT-1056"><span class="linenos">1056</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1057"><a href="#DFT-1057"><span class="linenos">1057</span></a>
</span><span id="DFT-1058"><a href="#DFT-1058"><span class="linenos">1058</span></a>        
</span><span id="DFT-1059"><a href="#DFT-1059"><span class="linenos">1059</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT-1060"><a href="#DFT-1060"><span class="linenos">1060</span></a>            <span class="c1"># It is possible that the supplied density matrix to the SCF was in SAO format already.</span>
</span><span id="DFT-1061"><a href="#DFT-1061"><span class="linenos">1061</span></a>            <span class="c1"># In such a case we need to transform this density matrix to CAO basis so that the J and XC term evaluations can be done properly </span>
</span><span id="DFT-1062"><a href="#DFT-1062"><span class="linenos">1062</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="DFT-1063"><a href="#DFT-1063"><span class="linenos">1063</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># Convert to CAO from SAO (SAO --&gt; CAO)</span>
</span><span id="DFT-1064"><a href="#DFT-1064"><span class="linenos">1064</span></a>                <span class="c1"># Later the dmat will be converted back to SAO after J and XC term evaluations</span>
</span><span id="DFT-1065"><a href="#DFT-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span> <span class="c1"># 4c2e ERI case</span>
</span><span id="DFT-1066"><a href="#DFT-1066"><span class="linenos">1066</span></a>            
</span><span id="DFT-1067"><a href="#DFT-1067"><span class="linenos">1067</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating four centered two electron integrals (ERIs)...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1068"><a href="#DFT-1068"><span class="linenos">1068</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">isSchwarz</span><span class="p">:</span>
</span><span id="DFT-1069"><a href="#DFT-1069"><span class="linenos">1069</span></a>                <span class="c1"># Four centered two electron integrals (ERIs)</span>
</span><span id="DFT-1070"><a href="#DFT-1070"><span class="linenos">1070</span></a>                <span class="k">if</span> <span class="n">rys</span><span class="p">:</span>
</span><span id="DFT-1071"><a href="#DFT-1071"><span class="linenos">1071</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1072"><a href="#DFT-1072"><span class="linenos">1072</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1073"><a href="#DFT-1073"><span class="linenos">1073</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1074"><a href="#DFT-1074"><span class="linenos">1074</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Four Center Two electron ERI size in GB &#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1075"><a href="#DFT-1075"><span class="linenos">1075</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">)</span>
</span><span id="DFT-1076"><a href="#DFT-1076"><span class="linenos">1076</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1077"><a href="#DFT-1077"><span class="linenos">1077</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Performing Schwarz screening...&#39;</span><span class="p">)</span>
</span><span id="DFT-1078"><a href="#DFT-1078"><span class="linenos">1078</span></a>                <span class="c1"># threshold_schwarz = 1e-09</span>
</span><span id="DFT-1079"><a href="#DFT-1079"><span class="linenos">1079</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threshold &#39;</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="DFT-1080"><a href="#DFT-1080"><span class="linenos">1080</span></a>                <span class="n">startSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1081"><a href="#DFT-1081"><span class="linenos">1081</span></a>                <span class="n">nints4c2e_sym8</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span><span id="DFT-1082"><a href="#DFT-1082"><span class="linenos">1082</span></a>                <span class="n">nints4c2e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
</span><span id="DFT-1083"><a href="#DFT-1083"><span class="linenos">1083</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1084"><a href="#DFT-1084"><span class="linenos">1084</span></a>                <span class="n">start_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1085"><a href="#DFT-1085"><span class="linenos">1085</span></a>                <span class="c1"># Diagonal elements of ERI 4c2e array</span>
</span><span id="DFT-1086"><a href="#DFT-1086"><span class="linenos">1086</span></a>                <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT-1087"><a href="#DFT-1087"><span class="linenos">1087</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_4c2e_diag</span>
</span><span id="DFT-1088"><a href="#DFT-1088"><span class="linenos">1088</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the &quot;diagonal&quot; of 4c2e ERI tensor: &#39;</span><span class="p">,</span> <span class="n">duration_4c2e_diag</span><span class="p">)</span>
</span><span id="DFT-1089"><a href="#DFT-1089"><span class="linenos">1089</span></a>                <span class="c1"># Calculate the square roots required for </span>
</span><span id="DFT-1090"><a href="#DFT-1090"><span class="linenos">1090</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1091"><a href="#DFT-1091"><span class="linenos">1091</span></a>                <span class="n">start_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1092"><a href="#DFT-1092"><span class="linenos">1092</span></a>                <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="DFT-1093"><a href="#DFT-1093"><span class="linenos">1093</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_square_roots</span>
</span><span id="DFT-1094"><a href="#DFT-1094"><span class="linenos">1094</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the square roots needed: &#39;</span><span class="p">,</span> <span class="n">duration_square_roots</span><span class="p">)</span>
</span><span id="DFT-1095"><a href="#DFT-1095"><span class="linenos">1095</span></a>                <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="c1"># Results in 2 GB chunks</span>
</span><span id="DFT-1096"><a href="#DFT-1096"><span class="linenos">1096</span></a>                <span class="n">duration_indices_calc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1097"><a href="#DFT-1097"><span class="linenos">1097</span></a>                <span class="n">duration_concatenation</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1098"><a href="#DFT-1098"><span class="linenos">1098</span></a>                <span class="n">start_indices_calc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1099"><a href="#DFT-1099"><span class="linenos">1099</span></a>                <span class="c1"># indices_temp = []</span>
</span><span id="DFT-1100"><a href="#DFT-1100"><span class="linenos">1100</span></a>                <span class="n">ijkl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-1101"><a href="#DFT-1101"><span class="linenos">1101</span></a>                <span class="k">if</span> <span class="n">chunksize</span><span class="o">&lt;</span><span class="n">nints4c2e_sym8</span><span class="p">:</span>
</span><span id="DFT-1102"><a href="#DFT-1102"><span class="linenos">1102</span></a>                    <span class="n">nchunks</span> <span class="o">=</span> <span class="n">nints4c2e_sym8</span><span class="o">//</span><span class="n">chunksize</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="DFT-1103"><a href="#DFT-1103"><span class="linenos">1103</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1104"><a href="#DFT-1104"><span class="linenos">1104</span></a>                    <span class="n">nchunks</span><span class="o">=</span><span class="mi">1</span>
</span><span id="DFT-1105"><a href="#DFT-1105"><span class="linenos">1105</span></a>                <span class="n">indicesA</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1106"><a href="#DFT-1106"><span class="linenos">1106</span></a>                <span class="k">for</span> <span class="n">ichunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
</span><span id="DFT-1107"><a href="#DFT-1107"><span class="linenos">1107</span></a>                    <span class="n">indices_temp</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">calc_indices_4c2e_schwarz</span><span class="p">(</span><span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">),</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="DFT-1108"><a href="#DFT-1108"><span class="linenos">1108</span></a>                    
</span><span id="DFT-1109"><a href="#DFT-1109"><span class="linenos">1109</span></a>                    <span class="n">ijkl</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="DFT-1110"><a href="#DFT-1110"><span class="linenos">1110</span></a>                    <span class="n">count</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="DFT-1111"><a href="#DFT-1111"><span class="linenos">1111</span></a>                    <span class="c1"># start_concatenation = timer()</span>
</span><span id="DFT-1112"><a href="#DFT-1112"><span class="linenos">1112</span></a>                    <span class="k">if</span> <span class="n">indicesA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="DFT-1113"><a href="#DFT-1113"><span class="linenos">1113</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesA</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT-1114"><a href="#DFT-1114"><span class="linenos">1114</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesB</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT-1115"><a href="#DFT-1115"><span class="linenos">1115</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesC</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT-1116"><a href="#DFT-1116"><span class="linenos">1116</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesD</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT-1117"><a href="#DFT-1117"><span class="linenos">1117</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1118"><a href="#DFT-1118"><span class="linenos">1118</span></a>                        
</span><span id="DFT-1119"><a href="#DFT-1119"><span class="linenos">1119</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT-1120"><a href="#DFT-1120"><span class="linenos">1120</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT-1121"><a href="#DFT-1121"><span class="linenos">1121</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT-1122"><a href="#DFT-1122"><span class="linenos">1122</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT-1123"><a href="#DFT-1123"><span class="linenos">1123</span></a>                    <span class="c1"># duration_concatenation += timer() - start_concatenation</span>
</span><span id="DFT-1124"><a href="#DFT-1124"><span class="linenos">1124</span></a>                    <span class="c1"># Break out of the for loop if the nol. of significant triplets found is less than the chunksize </span>
</span><span id="DFT-1125"><a href="#DFT-1125"><span class="linenos">1125</span></a>                    <span class="c1"># This is because, it means that there are no more significant triplets to be found from all possible configurations. </span>
</span><span id="DFT-1126"><a href="#DFT-1126"><span class="linenos">1126</span></a>                    <span class="k">if</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">chunksize</span><span class="p">:</span> 
</span><span id="DFT-1127"><a href="#DFT-1127"><span class="linenos">1127</span></a>                        <span class="k">break</span>
</span><span id="DFT-1128"><a href="#DFT-1128"><span class="linenos">1128</span></a>                
</span><span id="DFT-1129"><a href="#DFT-1129"><span class="linenos">1129</span></a>                <span class="n">duration_indices_calc</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_indices_calc</span>
</span><span id="DFT-1130"><a href="#DFT-1130"><span class="linenos">1130</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time for significant indices evaluation: &#39;</span><span class="p">,</span> <span class="n">duration_indices_calc</span><span class="p">)</span>
</span><span id="DFT-1131"><a href="#DFT-1131"><span class="linenos">1131</span></a>                <span class="c1"># print(&#39;Time for array concatenation: &#39;, duration_concatenation)</span>
</span><span id="DFT-1132"><a href="#DFT-1132"><span class="linenos">1132</span></a>
</span><span id="DFT-1133"><a href="#DFT-1133"><span class="linenos">1133</span></a>                <span class="c1"># Get rid of temp variables</span>
</span><span id="DFT-1134"><a href="#DFT-1134"><span class="linenos">1134</span></a>                <span class="n">indices_temp</span><span class="o">=</span><span class="mi">0</span>
</span><span id="DFT-1135"><a href="#DFT-1135"><span class="linenos">1135</span></a>                <span class="n">ijk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1136"><a href="#DFT-1136"><span class="linenos">1136</span></a>                
</span><span id="DFT-1137"><a href="#DFT-1137"><span class="linenos">1137</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of permanent array storing the significant indices of 4c2e ERI in GB &#39;</span><span class="p">,</span> <span class="n">indicesA</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesB</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesC</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesD</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1138"><a href="#DFT-1138"><span class="linenos">1138</span></a>
</span><span id="DFT-1139"><a href="#DFT-1139"><span class="linenos">1139</span></a>                <span class="n">nsignificant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicesA</span><span class="p">)</span>
</span><span id="DFT-1140"><a href="#DFT-1140"><span class="linenos">1140</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements in the standard four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1141"><a href="#DFT-1141"><span class="linenos">1141</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements after factoring in the 8-fold symmetry in the four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1142"><a href="#DFT-1142"><span class="linenos">1142</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of significant quadruplets based on Schwarz inequality and 8-fold symmetry: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsignificant</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; or &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nsignificant</span><span class="o">/</span><span class="n">nints4c2e</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f original&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1143"><a href="#DFT-1143"><span class="linenos">1143</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Schwarz screening done!&#39;</span><span class="p">)</span>
</span><span id="DFT-1144"><a href="#DFT-1144"><span class="linenos">1144</span></a>                <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSchwarz</span>
</span><span id="DFT-1145"><a href="#DFT-1145"><span class="linenos">1145</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time taken for Schwarz screening &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSchwarz</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1146"><a href="#DFT-1146"><span class="linenos">1146</span></a>
</span><span id="DFT-1147"><a href="#DFT-1147"><span class="linenos">1147</span></a>                <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">rys_4c2e_tri_schwarz_sparse</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">indicesD</span><span class="p">)</span>
</span><span id="DFT-1148"><a href="#DFT-1148"><span class="linenos">1148</span></a>
</span><span id="DFT-1149"><a href="#DFT-1149"><span class="linenos">1149</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Density fitting case (3c2e, and 2c2e will be calculated)</span>
</span><span id="DFT-1150"><a href="#DFT-1150"><span class="linenos">1150</span></a>            <span class="n">H_temp</span><span class="p">,</span> <span class="n">V_temp</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">nsignificant</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="n">density_fitting_prelims_for_DFT_development</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">rys</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">)</span>
</span><span id="DFT-1151"><a href="#DFT-1151"><span class="linenos">1151</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">H_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-1152"><a href="#DFT-1152"><span class="linenos">1152</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">H_temp</span>
</span><span id="DFT-1153"><a href="#DFT-1153"><span class="linenos">1153</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">V_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-1154"><a href="#DFT-1154"><span class="linenos">1154</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">V_temp</span>
</span><span id="DFT-1155"><a href="#DFT-1155"><span class="linenos">1155</span></a>            <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT-1156"><a href="#DFT-1156"><span class="linenos">1156</span></a>                <span class="n">durationDF</span> <span class="o">+=</span> <span class="n">durationDF_cholesky</span>
</span><span id="DFT-1157"><a href="#DFT-1157"><span class="linenos">1157</span></a>
</span><span id="DFT-1158"><a href="#DFT-1158"><span class="linenos">1158</span></a>            
</span><span id="DFT-1159"><a href="#DFT-1159"><span class="linenos">1159</span></a>            
</span><span id="DFT-1160"><a href="#DFT-1160"><span class="linenos">1160</span></a>        
</span><span id="DFT-1161"><a href="#DFT-1161"><span class="linenos">1161</span></a>        
</span><span id="DFT-1162"><a href="#DFT-1162"><span class="linenos">1162</span></a>        <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT-1163"><a href="#DFT-1163"><span class="linenos">1163</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1164"><a href="#DFT-1164"><span class="linenos">1164</span></a>
</span><span id="DFT-1165"><a href="#DFT-1165"><span class="linenos">1165</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-1166"><a href="#DFT-1166"><span class="linenos">1166</span></a>            <span class="n">startGrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1167"><a href="#DFT-1167"><span class="linenos">1167</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating grids...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1168"><a href="#DFT-1168"><span class="linenos">1168</span></a>            <span class="c1"># To get the same energies as PySCF (level=5) upto 1e-7 au, use the following settings</span>
</span><span id="DFT-1169"><a href="#DFT-1169"><span class="linenos">1169</span></a>            <span class="c1"># radial_precision = 1.0e-13</span>
</span><span id="DFT-1170"><a href="#DFT-1170"><span class="linenos">1170</span></a>            <span class="c1"># level=3</span>
</span><span id="DFT-1171"><a href="#DFT-1171"><span class="linenos">1171</span></a>            <span class="c1"># pruning by density with threshold = 1e-011</span>
</span><span id="DFT-1172"><a href="#DFT-1172"><span class="linenos">1172</span></a>            <span class="c1"># alpha_min and alpha_max corresponding to QZVP</span>
</span><span id="DFT-1173"><a href="#DFT-1173"><span class="linenos">1173</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids level: &#39;</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="p">)</span>
</span><span id="DFT-1174"><a href="#DFT-1174"><span class="linenos">1174</span></a>            <span class="c1"># Generate grids for XC term</span>
</span><span id="DFT-1175"><a href="#DFT-1175"><span class="linenos">1175</span></a>            <span class="n">basisGrids</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-QZVP&#39;</span><span class="p">)})</span>
</span><span id="DFT-1176"><a href="#DFT-1176"><span class="linenos">1176</span></a>            <span class="n">grids</span> <span class="o">=</span> <span class="n">Grids</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basisGrids</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">gridsLevel</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT-1177"><a href="#DFT-1177"><span class="linenos">1177</span></a>
</span><span id="DFT-1178"><a href="#DFT-1178"><span class="linenos">1178</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1179"><a href="#DFT-1179"><span class="linenos">1179</span></a>            <span class="n">durationgrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids</span>
</span><span id="DFT-1180"><a href="#DFT-1180"><span class="linenos">1180</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1181"><a href="#DFT-1181"><span class="linenos">1181</span></a>
</span><span id="DFT-1182"><a href="#DFT-1182"><span class="linenos">1182</span></a>            <span class="c1"># Begin pruning the grids based on density (rho)</span>
</span><span id="DFT-1183"><a href="#DFT-1183"><span class="linenos">1183</span></a>            <span class="c1"># Evaluate ao_values to calculate rho</span>
</span><span id="DFT-1184"><a href="#DFT-1184"><span class="linenos">1184</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Pruning generated grids by rho...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1185"><a href="#DFT-1185"><span class="linenos">1185</span></a>            <span class="n">startGrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1186"><a href="#DFT-1186"><span class="linenos">1186</span></a>            <span class="n">threshold_rho</span> <span class="o">=</span> <span class="mf">1e-011</span>
</span><span id="DFT-1187"><a href="#DFT-1187"><span class="linenos">1187</span></a>            <span class="n">ngrids_temp</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-1188"><a href="#DFT-1188"><span class="linenos">1188</span></a>            <span class="n">ndeleted</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1189"><a href="#DFT-1189"><span class="linenos">1189</span></a>            <span class="n">blocksize_temp</span> <span class="o">=</span> <span class="mi">50000</span>
</span><span id="DFT-1190"><a href="#DFT-1190"><span class="linenos">1190</span></a>            <span class="n">nblocks_temp</span> <span class="o">=</span> <span class="n">ngrids_temp</span><span class="o">//</span><span class="n">blocksize_temp</span>
</span><span id="DFT-1191"><a href="#DFT-1191"><span class="linenos">1191</span></a>            <span class="n">weightsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1192"><a href="#DFT-1192"><span class="linenos">1192</span></a>            <span class="n">coordsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1193"><a href="#DFT-1193"><span class="linenos">1193</span></a>            <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks_temp</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-1194"><a href="#DFT-1194"><span class="linenos">1194</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize_temp</span>
</span><span id="DFT-1195"><a href="#DFT-1195"><span class="linenos">1195</span></a>                <span class="n">weights_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span>
</span><span id="DFT-1196"><a href="#DFT-1196"><span class="linenos">1196</span></a>                <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span> 
</span><span id="DFT-1197"><a href="#DFT-1197"><span class="linenos">1197</span></a>                <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>  
</span><span id="DFT-1198"><a href="#DFT-1198"><span class="linenos">1198</span></a>                <span class="n">rho_block</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span>
</span><span id="DFT-1199"><a href="#DFT-1199"><span class="linenos">1199</span></a>                <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rho_block</span><span class="o">*</span><span class="n">weights_block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_rho</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-1200"><a href="#DFT-1200"><span class="linenos">1200</span></a>                <span class="n">ndeleted</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span>
</span><span id="DFT-1201"><a href="#DFT-1201"><span class="linenos">1201</span></a>                <span class="n">weightsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">weights_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">)</span>
</span><span id="DFT-1202"><a href="#DFT-1202"><span class="linenos">1202</span></a>                <span class="n">coordsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">coords_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-1203"><a href="#DFT-1203"><span class="linenos">1203</span></a>                <span class="k">if</span> <span class="n">weightsNew_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="DFT-1204"><a href="#DFT-1204"><span class="linenos">1204</span></a>                    <span class="k">if</span> <span class="n">weightsNew</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT-1205"><a href="#DFT-1205"><span class="linenos">1205</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">weightsNew_block</span>
</span><span id="DFT-1206"><a href="#DFT-1206"><span class="linenos">1206</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">coordsNew_block</span>
</span><span id="DFT-1207"><a href="#DFT-1207"><span class="linenos">1207</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1208"><a href="#DFT-1208"><span class="linenos">1208</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weightsNew</span><span class="p">,</span> <span class="n">weightsNew_block</span><span class="p">))</span>
</span><span id="DFT-1209"><a href="#DFT-1209"><span class="linenos">1209</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">coordsNew</span><span class="p">,</span> <span class="n">coordsNew_block</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT-1210"><a href="#DFT-1210"><span class="linenos">1210</span></a>
</span><span id="DFT-1211"><a href="#DFT-1211"><span class="linenos">1211</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coordsNew</span>
</span><span id="DFT-1212"><a href="#DFT-1212"><span class="linenos">1212</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weightsNew</span>
</span><span id="DFT-1213"><a href="#DFT-1213"><span class="linenos">1213</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1214"><a href="#DFT-1214"><span class="linenos">1214</span></a>            <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids_prune_rho</span>
</span><span id="DFT-1215"><a href="#DFT-1215"><span class="linenos">1215</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids_prune_rho</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1216"><a href="#DFT-1216"><span class="linenos">1216</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Deleted &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ndeleted</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; grid points.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1217"><a href="#DFT-1217"><span class="linenos">1217</span></a>            
</span><span id="DFT-1218"><a href="#DFT-1218"><span class="linenos">1218</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1219"><a href="#DFT-1219"><span class="linenos">1219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Using the user supplied grids!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1220"><a href="#DFT-1220"><span class="linenos">1220</span></a>        
</span><span id="DFT-1221"><a href="#DFT-1221"><span class="linenos">1221</span></a>
</span><span id="DFT-1222"><a href="#DFT-1222"><span class="linenos">1222</span></a>        <span class="c1"># Grid information initial</span>
</span><span id="DFT-1223"><a href="#DFT-1223"><span class="linenos">1223</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. of supplied/generated grid points: &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1224"><a href="#DFT-1224"><span class="linenos">1224</span></a>
</span><span id="DFT-1225"><a href="#DFT-1225"><span class="linenos">1225</span></a>        <span class="c1"># Prune grids based on weights</span>
</span><span id="DFT-1226"><a href="#DFT-1226"><span class="linenos">1226</span></a>        <span class="c1"># start_pruning_weights = timer()</span>
</span><span id="DFT-1227"><a href="#DFT-1227"><span class="linenos">1227</span></a>        <span class="c1"># print(&#39;\nPruning grids based on weights....&#39;, flush=True)</span>
</span><span id="DFT-1228"><a href="#DFT-1228"><span class="linenos">1228</span></a>        <span class="c1"># zero_indices = np.where(np.logical_and(grids.weights&gt;=-1.0e-12, grids.weights&lt;=1.e-12))</span>
</span><span id="DFT-1229"><a href="#DFT-1229"><span class="linenos">1229</span></a>        <span class="c1"># grids.weights = np.delete(grids.weights, zero_indices)</span>
</span><span id="DFT-1230"><a href="#DFT-1230"><span class="linenos">1230</span></a>        <span class="c1"># grids.coords = np.delete(grids.coords, zero_indices, 0)</span>
</span><span id="DFT-1231"><a href="#DFT-1231"><span class="linenos">1231</span></a>        <span class="c1"># print(&#39;done!&#39;, flush=True)</span>
</span><span id="DFT-1232"><a href="#DFT-1232"><span class="linenos">1232</span></a>        <span class="c1"># duration_pruning_weights = timer() - start_pruning_weights</span>
</span><span id="DFT-1233"><a href="#DFT-1233"><span class="linenos">1233</span></a>        <span class="c1"># print(&#39;\nTime taken &#39;+str(duration_pruning_weights)+&#39; seconds.\n&#39;, flush=True)</span>
</span><span id="DFT-1234"><a href="#DFT-1234"><span class="linenos">1234</span></a>        <span class="c1"># print(&#39;\nNo. of grid points after screening by weights: &#39;, grids.coords.shape[0], flush=True)</span>
</span><span id="DFT-1235"><a href="#DFT-1235"><span class="linenos">1235</span></a>
</span><span id="DFT-1236"><a href="#DFT-1236"><span class="linenos">1236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the coordinates of grid:      &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1237"><a href="#DFT-1237"><span class="linenos">1237</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the weights of grid:          &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1238"><a href="#DFT-1238"><span class="linenos">1238</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the density at gridpoints:    &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1239"><a href="#DFT-1239"><span class="linenos">1239</span></a>
</span><span id="DFT-1240"><a href="#DFT-1240"><span class="linenos">1240</span></a>        <span class="c1"># Sort the grids for slightly better performance with batching (doesn&#39;t seem to make much difference)</span>
</span><span id="DFT-1241"><a href="#DFT-1241"><span class="linenos">1241</span></a>        <span class="k">if</span> <span class="n">sortGrids</span><span class="p">:</span>
</span><span id="DFT-1242"><a href="#DFT-1242"><span class="linenos">1242</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Sorting grids ....&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1243"><a href="#DFT-1243"><span class="linenos">1243</span></a>            <span class="c1"># Function to sort grids</span>
</span><span id="DFT-1244"><a href="#DFT-1244"><span class="linenos">1244</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">get_ordered_list</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="DFT-1245"><a href="#DFT-1245"><span class="linenos">1245</span></a>                <span class="n">points</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="DFT-1246"><a href="#DFT-1246"><span class="linenos">1246</span></a>                <span class="c1"># print(points[0:10])</span>
</span><span id="DFT-1247"><a href="#DFT-1247"><span class="linenos">1247</span></a>                <span class="k">return</span> <span class="n">points</span>
</span><span id="DFT-1248"><a href="#DFT-1248"><span class="linenos">1248</span></a>            <span class="c1"># Make a single array of coords and weights</span>
</span><span id="DFT-1249"><a href="#DFT-1249"><span class="linenos">1249</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
</span><span id="DFT-1250"><a href="#DFT-1250"><span class="linenos">1250</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_ordered_list</span><span class="p">(</span><span class="n">coords_weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])))</span>
</span><span id="DFT-1251"><a href="#DFT-1251"><span class="linenos">1251</span></a>            <span class="c1"># Now go back to two arrays for coords and weights</span>
</span><span id="DFT-1252"><a href="#DFT-1252"><span class="linenos">1252</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DFT-1253"><a href="#DFT-1253"><span class="linenos">1253</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DFT-1254"><a href="#DFT-1254"><span class="linenos">1254</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#None</span>
</span><span id="DFT-1255"><a href="#DFT-1255"><span class="linenos">1255</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1256"><a href="#DFT-1256"><span class="linenos">1256</span></a>
</span><span id="DFT-1257"><a href="#DFT-1257"><span class="linenos">1257</span></a>        <span class="c1"># blocksize = 10000</span>
</span><span id="DFT-1258"><a href="#DFT-1258"><span class="linenos">1258</span></a>        <span class="n">ngrids</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT-1259"><a href="#DFT-1259"><span class="linenos">1259</span></a>        <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="DFT-1260"><a href="#DFT-1260"><span class="linenos">1260</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Will use batching to evaluate the XC term for memory efficiency.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1261"><a href="#DFT-1261"><span class="linenos">1261</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch size: &#39;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1262"><a href="#DFT-1262"><span class="linenos">1262</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of batches: &#39;</span><span class="p">,</span> <span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1263"><a href="#DFT-1263"><span class="linenos">1263</span></a>
</span><span id="DFT-1264"><a href="#DFT-1264"><span class="linenos">1264</span></a>
</span><span id="DFT-1265"><a href="#DFT-1265"><span class="linenos">1265</span></a>        <span class="c1">#### Some preliminary stuff for XC evaluation</span>
</span><span id="DFT-1266"><a href="#DFT-1266"><span class="linenos">1266</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1267"><a href="#DFT-1267"><span class="linenos">1267</span></a>        <span class="n">list_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1268"><a href="#DFT-1268"><span class="linenos">1268</span></a>        <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1269"><a href="#DFT-1269"><span class="linenos">1269</span></a>        <span class="n">list_ao_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1270"><a href="#DFT-1270"><span class="linenos">1270</span></a>        <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1271"><a href="#DFT-1271"><span class="linenos">1271</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="p">:</span>
</span><span id="DFT-1272"><a href="#DFT-1272"><span class="linenos">1272</span></a>            <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="DFT-1273"><a href="#DFT-1273"><span class="linenos">1273</span></a>            <span class="c1"># Create a LibXC object  </span>
</span><span id="DFT-1274"><a href="#DFT-1274"><span class="linenos">1274</span></a>            <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT-1275"><a href="#DFT-1275"><span class="linenos">1275</span></a>            <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT-1276"><a href="#DFT-1276"><span class="linenos">1276</span></a>            <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT-1277"><a href="#DFT-1277"><span class="linenos">1277</span></a>            <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT-1278"><a href="#DFT-1278"><span class="linenos">1278</span></a>            <span class="c1">### Find the list of significanlty contributing bfs for xc evaluations</span>
</span><span id="DFT-1279"><a href="#DFT-1279"><span class="linenos">1279</span></a>            <span class="n">startXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1280"><a href="#DFT-1280"><span class="linenos">1280</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Preliminary processing for XC term evaluations...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1281"><a href="#DFT-1281"><span class="linenos">1281</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of basis functions (atomic orbitals) and get the indices of siginificantly contributing functions...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1282"><a href="#DFT-1282"><span class="linenos">1282</span></a>            <span class="c1"># Calculate the value of basis functions for all grid points in batches</span>
</span><span id="DFT-1283"><a href="#DFT-1283"><span class="linenos">1283</span></a>            <span class="c1"># and find the indices of basis functions that have a significant contribution to those batches for each batch</span>
</span><span id="DFT-1284"><a href="#DFT-1284"><span class="linenos">1284</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1285"><a href="#DFT-1285"><span class="linenos">1285</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">)</span>
</span><span id="DFT-1286"><a href="#DFT-1286"><span class="linenos">1286</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1287"><a href="#DFT-1287"><span class="linenos">1287</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT-1288"><a href="#DFT-1288"><span class="linenos">1288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1289"><a href="#DFT-1289"><span class="linenos">1289</span></a>            <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startXCpreprocessing</span>
</span><span id="DFT-1290"><a href="#DFT-1290"><span class="linenos">1290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationXCpreprocessing</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1291"><a href="#DFT-1291"><span class="linenos">1291</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">))</span>
</span><span id="DFT-1292"><a href="#DFT-1292"><span class="linenos">1292</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">)))</span>
</span><span id="DFT-1293"><a href="#DFT-1293"><span class="linenos">1293</span></a>
</span><span id="DFT-1294"><a href="#DFT-1294"><span class="linenos">1294</span></a>            
</span><span id="DFT-1295"><a href="#DFT-1295"><span class="linenos">1295</span></a>            <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1296"><a href="#DFT-1296"><span class="linenos">1296</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="p">:</span>
</span><span id="DFT-1297"><a href="#DFT-1297"><span class="linenos">1297</span></a>                <span class="n">startAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1298"><a href="#DFT-1298"><span class="linenos">1298</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="DFT-1299"><a href="#DFT-1299"><span class="linenos">1299</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1300"><a href="#DFT-1300"><span class="linenos">1300</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="DFT-1301"><a href="#DFT-1301"><span class="linenos">1301</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1302"><a href="#DFT-1302"><span class="linenos">1302</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1303"><a href="#DFT-1303"><span class="linenos">1303</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-1304"><a href="#DFT-1304"><span class="linenos">1304</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="DFT-1305"><a href="#DFT-1305"><span class="linenos">1305</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-1306"><a href="#DFT-1306"><span class="linenos">1306</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="DFT-1307"><a href="#DFT-1307"><span class="linenos">1307</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="DFT-1308"><a href="#DFT-1308"><span class="linenos">1308</span></a>                        <span class="n">ao_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="DFT-1309"><a href="#DFT-1309"><span class="linenos">1309</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="DFT-1310"><a href="#DFT-1310"><span class="linenos">1310</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="DFT-1311"><a href="#DFT-1311"><span class="linenos">1311</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1312"><a href="#DFT-1312"><span class="linenos">1312</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="DFT-1313"><a href="#DFT-1313"><span class="linenos">1313</span></a>                    <span class="c1">#Free memory </span>
</span><span id="DFT-1314"><a href="#DFT-1314"><span class="linenos">1314</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="DFT-1315"><a href="#DFT-1315"><span class="linenos">1315</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="DFT-1316"><a href="#DFT-1316"><span class="linenos">1316</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions and their gradients on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1317"><a href="#DFT-1317"><span class="linenos">1317</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="DFT-1318"><a href="#DFT-1318"><span class="linenos">1318</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1319"><a href="#DFT-1319"><span class="linenos">1319</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1320"><a href="#DFT-1320"><span class="linenos">1320</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-1321"><a href="#DFT-1321"><span class="linenos">1321</span></a>                    <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT-1322"><a href="#DFT-1322"><span class="linenos">1322</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="DFT-1323"><a href="#DFT-1323"><span class="linenos">1323</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-1324"><a href="#DFT-1324"><span class="linenos">1324</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="DFT-1325"><a href="#DFT-1325"><span class="linenos">1325</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="DFT-1326"><a href="#DFT-1326"><span class="linenos">1326</span></a>                        <span class="c1"># ao_values_block = Integrals.bf_val_helpers.eval_bfs(basis, coords_block, parallel=True, non_zero_indices=list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])</span>
</span><span id="DFT-1327"><a href="#DFT-1327"><span class="linenos">1327</span></a>                        <span class="n">ao_values_block</span><span class="p">,</span> <span class="n">ao_grad_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="DFT-1328"><a href="#DFT-1328"><span class="linenos">1328</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="DFT-1329"><a href="#DFT-1329"><span class="linenos">1329</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="DFT-1330"><a href="#DFT-1330"><span class="linenos">1330</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">))</span>
</span><span id="DFT-1331"><a href="#DFT-1331"><span class="linenos">1331</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1332"><a href="#DFT-1332"><span class="linenos">1332</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="DFT-1333"><a href="#DFT-1333"><span class="linenos">1333</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">)</span>
</span><span id="DFT-1334"><a href="#DFT-1334"><span class="linenos">1334</span></a>                    <span class="c1">#Free memory </span>
</span><span id="DFT-1335"><a href="#DFT-1335"><span class="linenos">1335</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="DFT-1336"><a href="#DFT-1336"><span class="linenos">1336</span></a>                    <span class="n">ao_grad_values_block</span> <span class="o">=</span><span class="mi">0</span>
</span><span id="DFT-1337"><a href="#DFT-1337"><span class="linenos">1337</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1338"><a href="#DFT-1338"><span class="linenos">1338</span></a>                <span class="n">durationAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startAO_values</span>
</span><span id="DFT-1339"><a href="#DFT-1339"><span class="linenos">1339</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationAO_values</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1340"><a href="#DFT-1340"><span class="linenos">1340</span></a>        
</span><span id="DFT-1341"><a href="#DFT-1341"><span class="linenos">1341</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1342"><a href="#DFT-1342"><span class="linenos">1342</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT-1343"><a href="#DFT-1343"><span class="linenos">1343</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT-1344"><a href="#DFT-1344"><span class="linenos">1344</span></a>        
</span><span id="DFT-1345"><a href="#DFT-1345"><span class="linenos">1345</span></a>        <span class="c1">#-------XC Stuff start----------------------</span>
</span><span id="DFT-1346"><a href="#DFT-1346"><span class="linenos">1346</span></a>
</span><span id="DFT-1347"><a href="#DFT-1347"><span class="linenos">1347</span></a>        <span class="n">funcid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="DFT-1348"><a href="#DFT-1348"><span class="linenos">1348</span></a>
</span><span id="DFT-1349"><a href="#DFT-1349"><span class="linenos">1349</span></a>        <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="DFT-1350"><a href="#DFT-1350"><span class="linenos">1350</span></a>
</span><span id="DFT-1351"><a href="#DFT-1351"><span class="linenos">1351</span></a>        <span class="c1"># Create a LibXC object  </span>
</span><span id="DFT-1352"><a href="#DFT-1352"><span class="linenos">1352</span></a>        <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT-1353"><a href="#DFT-1353"><span class="linenos">1353</span></a>        <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT-1354"><a href="#DFT-1354"><span class="linenos">1354</span></a>        <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT-1355"><a href="#DFT-1355"><span class="linenos">1355</span></a>        <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT-1356"><a href="#DFT-1356"><span class="linenos">1356</span></a>
</span><span id="DFT-1357"><a href="#DFT-1357"><span class="linenos">1357</span></a>
</span><span id="DFT-1358"><a href="#DFT-1358"><span class="linenos">1358</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">------------------------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1359"><a href="#DFT-1359"><span class="linenos">1359</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Functional&#39;</span><span class="p">)</span>
</span><span id="DFT-1360"><a href="#DFT-1360"><span class="linenos">1360</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1361"><a href="#DFT-1361"><span class="linenos">1361</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XC Functional IDs supplied: &#39;</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1362"><a href="#DFT-1362"><span class="linenos">1362</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of exchange functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT-1363"><a href="#DFT-1363"><span class="linenos">1363</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Exchange function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1364"><a href="#DFT-1364"><span class="linenos">1364</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcx</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="DFT-1365"><a href="#DFT-1365"><span class="linenos">1365</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of correlation functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1366"><a href="#DFT-1366"><span class="linenos">1366</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; The Correlation function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1367"><a href="#DFT-1367"><span class="linenos">1367</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcc</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="DFT-1368"><a href="#DFT-1368"><span class="linenos">1368</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1369"><a href="#DFT-1369"><span class="linenos">1369</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1370"><a href="#DFT-1370"><span class="linenos">1370</span></a>        <span class="c1">#-------XC Stuff end----------------------</span>
</span><span id="DFT-1371"><a href="#DFT-1371"><span class="linenos">1371</span></a>
</span><span id="DFT-1372"><a href="#DFT-1372"><span class="linenos">1372</span></a>        <span class="n">Etot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1373"><a href="#DFT-1373"><span class="linenos">1373</span></a>
</span><span id="DFT-1374"><a href="#DFT-1374"><span class="linenos">1374</span></a>        <span class="n">itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT-1375"><a href="#DFT-1375"><span class="linenos">1375</span></a>        <span class="n">Enn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuclear_rep_energy</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="DFT-1376"><a href="#DFT-1376"><span class="linenos">1376</span></a>        <span class="c1">#diis = scf.CDIIS()</span>
</span><span id="DFT-1377"><a href="#DFT-1377"><span class="linenos">1377</span></a>        <span class="n">dmat_old</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1378"><a href="#DFT-1378"><span class="linenos">1378</span></a>        <span class="n">J_diff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1379"><a href="#DFT-1379"><span class="linenos">1379</span></a>        <span class="n">Ecoul</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1380"><a href="#DFT-1380"><span class="linenos">1380</span></a>        <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT-1381"><a href="#DFT-1381"><span class="linenos">1381</span></a>
</span><span id="DFT-1382"><a href="#DFT-1382"><span class="linenos">1382</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT-1383"><a href="#DFT-1383"><span class="linenos">1383</span></a>
</span><span id="DFT-1384"><a href="#DFT-1384"><span class="linenos">1384</span></a>        <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1385"><a href="#DFT-1385"><span class="linenos">1385</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT-1386"><a href="#DFT-1386"><span class="linenos">1386</span></a>            <span class="c1">#########</span>
</span><span id="DFT-1387"><a href="#DFT-1387"><span class="linenos">1387</span></a>            <span class="c1"># I use a trick to calculate the DFT energy in SAO basis. </span>
</span><span id="DFT-1388"><a href="#DFT-1388"><span class="linenos">1388</span></a>            <span class="c1"># The trick is to get rid of the extra information in the CAO basis matrices.</span>
</span><span id="DFT-1389"><a href="#DFT-1389"><span class="linenos">1389</span></a>            <span class="c1"># The following does just that. </span>
</span><span id="DFT-1390"><a href="#DFT-1390"><span class="linenos">1390</span></a>            <span class="c1"># Going from CAO --&gt; SAO we lose the extra information then we go back to from SAO --&gt; CAO</span>
</span><span id="DFT-1391"><a href="#DFT-1391"><span class="linenos">1391</span></a>            <span class="c1"># This way all the integrals (potential matrices and density matrices) can still be calculated</span>
</span><span id="DFT-1392"><a href="#DFT-1392"><span class="linenos">1392</span></a>            <span class="c1"># in the CAO basis. In fact even the KS matrix is diagonalized in the CAO basis with the extra information </span>
</span><span id="DFT-1393"><a href="#DFT-1393"><span class="linenos">1393</span></a>            <span class="c1"># removed by forward and backward transformation: CAO --&gt; SAO followed by SAO --&gt; CAO.</span>
</span><span id="DFT-1394"><a href="#DFT-1394"><span class="linenos">1394</span></a>            <span class="c1"># This also helps in reducing the number of transformations needed for calculation of various energy contributions.</span>
</span><span id="DFT-1395"><a href="#DFT-1395"><span class="linenos">1395</span></a>            <span class="c1">#########</span>
</span><span id="DFT-1396"><a href="#DFT-1396"><span class="linenos">1396</span></a>            <span class="c1"># Convert the overlap matrix from CAO to SAO basis</span>
</span><span id="DFT-1397"><a href="#DFT-1397"><span class="linenos">1397</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT-1398"><a href="#DFT-1398"><span class="linenos">1398</span></a>            <span class="c1"># Convert back to SAO so that now we lose the extra information that the CAO basis had</span>
</span><span id="DFT-1399"><a href="#DFT-1399"><span class="linenos">1399</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="DFT-1400"><a href="#DFT-1400"><span class="linenos">1400</span></a>        <span class="k">if</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="DFT-1401"><a href="#DFT-1401"><span class="linenos">1401</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1402"><a href="#DFT-1402"><span class="linenos">1402</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT-1403"><a href="#DFT-1403"><span class="linenos">1403</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT-1404"><a href="#DFT-1404"><span class="linenos">1404</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT-1405"><a href="#DFT-1405"><span class="linenos">1405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1406"><a href="#DFT-1406"><span class="linenos">1406</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT-1407"><a href="#DFT-1407"><span class="linenos">1407</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="DFT-1408"><a href="#DFT-1408"><span class="linenos">1408</span></a>        
</span><span id="DFT-1409"><a href="#DFT-1409"><span class="linenos">1409</span></a>
</span><span id="DFT-1410"><a href="#DFT-1410"><span class="linenos">1410</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">scf_converged</span> <span class="ow">or</span> <span class="n">itr</span><span class="o">==</span><span class="n">max_itr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT-1411"><a href="#DFT-1411"><span class="linenos">1411</span></a>            <span class="n">startIter</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1412"><a href="#DFT-1412"><span class="linenos">1412</span></a>            <span class="k">if</span> <span class="n">itr</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT-1413"><a href="#DFT-1413"><span class="linenos">1413</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT-1414"><a href="#DFT-1414"><span class="linenos">1414</span></a>                <span class="c1"># Coulomb (Hartree) matrix</span>
</span><span id="DFT-1415"><a href="#DFT-1415"><span class="linenos">1415</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-1416"><a href="#DFT-1416"><span class="linenos">1416</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="p">,</span><span class="n">dmat</span><span class="p">)</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT-1417"><a href="#DFT-1417"><span class="linenos">1417</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1418"><a href="#DFT-1418"><span class="linenos">1418</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="DFT-1419"><a href="#DFT-1419"><span class="linenos">1419</span></a>
</span><span id="DFT-1420"><a href="#DFT-1420"><span class="linenos">1420</span></a>
</span><span id="DFT-1421"><a href="#DFT-1421"><span class="linenos">1421</span></a>                    
</span><span id="DFT-1422"><a href="#DFT-1422"><span class="linenos">1422</span></a>                
</span><span id="DFT-1423"><a href="#DFT-1423"><span class="linenos">1423</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1424"><a href="#DFT-1424"><span class="linenos">1424</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">-</span><span class="n">dmat_old</span>
</span><span id="DFT-1425"><a href="#DFT-1425"><span class="linenos">1425</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-1426"><a href="#DFT-1426"><span class="linenos">1426</span></a>                    <span class="c1"># J_diff = contract(&#39;ijkl,ij&#39;,ints4c2e,dmat_diff)</span>
</span><span id="DFT-1427"><a href="#DFT-1427"><span class="linenos">1427</span></a>                    <span class="c1"># J += J_diff</span>
</span><span id="DFT-1428"><a href="#DFT-1428"><span class="linenos">1428</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span> <span class="n">ints4c2e</span><span class="p">,</span> <span class="n">dmat</span><span class="p">)</span>
</span><span id="DFT-1429"><a href="#DFT-1429"><span class="linenos">1429</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1430"><a href="#DFT-1430"><span class="linenos">1430</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="DFT-1431"><a href="#DFT-1431"><span class="linenos">1431</span></a>                <span class="c1"># J += J_diff</span>
</span><span id="DFT-1432"><a href="#DFT-1432"><span class="linenos">1432</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1433"><a href="#DFT-1433"><span class="linenos">1433</span></a>                <span class="n">J</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT-1434"><a href="#DFT-1434"><span class="linenos">1434</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1435"><a href="#DFT-1435"><span class="linenos">1435</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1436"><a href="#DFT-1436"><span class="linenos">1436</span></a>            
</span><span id="DFT-1437"><a href="#DFT-1437"><span class="linenos">1437</span></a>                
</span><span id="DFT-1438"><a href="#DFT-1438"><span class="linenos">1438</span></a>            <span class="c1"># XC energy and potential</span>
</span><span id="DFT-1439"><a href="#DFT-1439"><span class="linenos">1439</span></a>            <span class="n">startxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1440"><a href="#DFT-1440"><span class="linenos">1440</span></a>
</span><span id="DFT-1441"><a href="#DFT-1441"><span class="linenos">1441</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1442"><a href="#DFT-1442"><span class="linenos">1442</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT-1443"><a href="#DFT-1443"><span class="linenos">1443</span></a>                    <span class="c1"># Much slower than JOBLIB version</span>
</span><span id="DFT-1444"><a href="#DFT-1444"><span class="linenos">1444</span></a>                    <span class="c1"># Still keeping it because, it can be useful when using GPUs</span>
</span><span id="DFT-1445"><a href="#DFT-1445"><span class="linenos">1445</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT-1446"><a href="#DFT-1446"><span class="linenos">1446</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1447"><a href="#DFT-1447"><span class="linenos">1447</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">)</span>
</span><span id="DFT-1448"><a href="#DFT-1448"><span class="linenos">1448</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="DFT-1449"><a href="#DFT-1449"><span class="linenos">1449</span></a>                    <span class="c1"># Much faster than above and stable too, therefore this should be default now.</span>
</span><span id="DFT-1450"><a href="#DFT-1450"><span class="linenos">1450</span></a>                    <span class="c1"># Used to unstable and had memory leaks,</span>
</span><span id="DFT-1451"><a href="#DFT-1451"><span class="linenos">1451</span></a>                    <span class="c1"># But now all that is fixed by using threadpoolctl, garbage collection or freeing up memory after XC evaluation at each iteration</span>
</span><span id="DFT-1452"><a href="#DFT-1452"><span class="linenos">1452</span></a>                    
</span><span id="DFT-1453"><a href="#DFT-1453"><span class="linenos">1453</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT-1454"><a href="#DFT-1454"><span class="linenos">1454</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1455"><a href="#DFT-1455"><span class="linenos">1455</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT-1456"><a href="#DFT-1456"><span class="linenos">1456</span></a>                    
</span><span id="DFT-1457"><a href="#DFT-1457"><span class="linenos">1457</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="DFT-1458"><a href="#DFT-1458"><span class="linenos">1458</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT-1459"><a href="#DFT-1459"><span class="linenos">1459</span></a>                        <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT-1460"><a href="#DFT-1460"><span class="linenos">1460</span></a>                                                    <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1461"><a href="#DFT-1461"><span class="linenos">1461</span></a>                                                        <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT-1462"><a href="#DFT-1462"><span class="linenos">1462</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># GPU</span>
</span><span id="DFT-1463"><a href="#DFT-1463"><span class="linenos">1463</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT-1464"><a href="#DFT-1464"><span class="linenos">1464</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT-1465"><a href="#DFT-1465"><span class="linenos">1465</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1466"><a href="#DFT-1466"><span class="linenos">1466</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="DFT-1467"><a href="#DFT-1467"><span class="linenos">1467</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="DFT-1468"><a href="#DFT-1468"><span class="linenos">1468</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">)</span>
</span><span id="DFT-1469"><a href="#DFT-1469"><span class="linenos">1469</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="DFT-1470"><a href="#DFT-1470"><span class="linenos">1470</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT-1471"><a href="#DFT-1471"><span class="linenos">1471</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1472"><a href="#DFT-1472"><span class="linenos">1472</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT-1473"><a href="#DFT-1473"><span class="linenos">1473</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="DFT-1474"><a href="#DFT-1474"><span class="linenos">1474</span></a>                    <span class="c1"># Default for GPUs</span>
</span><span id="DFT-1475"><a href="#DFT-1475"><span class="linenos">1475</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT-1476"><a href="#DFT-1476"><span class="linenos">1476</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT-1477"><a href="#DFT-1477"><span class="linenos">1477</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="DFT-1478"><a href="#DFT-1478"><span class="linenos">1478</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="DFT-1479"><a href="#DFT-1479"><span class="linenos">1479</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="n">streams</span><span class="p">,</span> <span class="n">nb_streams</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">)</span>
</span><span id="DFT-1480"><a href="#DFT-1480"><span class="linenos">1480</span></a>
</span><span id="DFT-1481"><a href="#DFT-1481"><span class="linenos">1481</span></a>                <span class="n">Vxc</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Vxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT-1482"><a href="#DFT-1482"><span class="linenos">1482</span></a>
</span><span id="DFT-1483"><a href="#DFT-1483"><span class="linenos">1483</span></a>            <span class="n">durationxc</span> <span class="o">=</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startxc</span>
</span><span id="DFT-1484"><a href="#DFT-1484"><span class="linenos">1484</span></a>
</span><span id="DFT-1485"><a href="#DFT-1485"><span class="linenos">1485</span></a>            
</span><span id="DFT-1486"><a href="#DFT-1486"><span class="linenos">1486</span></a>            <span class="n">dmat_old</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT-1487"><a href="#DFT-1487"><span class="linenos">1487</span></a>
</span><span id="DFT-1488"><a href="#DFT-1488"><span class="linenos">1488</span></a>
</span><span id="DFT-1489"><a href="#DFT-1489"><span class="linenos">1489</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1490"><a href="#DFT-1490"><span class="linenos">1490</span></a>                <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="DFT-1491"><a href="#DFT-1491"><span class="linenos">1491</span></a>                <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="DFT-1492"><a href="#DFT-1492"><span class="linenos">1492</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="DFT-1493"><a href="#DFT-1493"><span class="linenos">1493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1494"><a href="#DFT-1494"><span class="linenos">1494</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT-1495"><a href="#DFT-1495"><span class="linenos">1495</span></a>                    <span class="c1"># print(&#39;Energy contractions&#39;, controller.info())</span>
</span><span id="DFT-1496"><a href="#DFT-1496"><span class="linenos">1496</span></a>                    <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="DFT-1497"><a href="#DFT-1497"><span class="linenos">1497</span></a>                    <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="DFT-1498"><a href="#DFT-1498"><span class="linenos">1498</span></a>                    <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="DFT-1499"><a href="#DFT-1499"><span class="linenos">1499</span></a>            <span class="k">if</span> <span class="n">isDF</span> <span class="ow">and</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT-1500"><a href="#DFT-1500"><span class="linenos">1500</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">Ecoul</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Ecoul_temp</span> <span class="c1"># This is the correct formula for Coulomb energy with DF</span>
</span><span id="DFT-1501"><a href="#DFT-1501"><span class="linenos">1501</span></a>
</span><span id="DFT-1502"><a href="#DFT-1502"><span class="linenos">1502</span></a>            <span class="n">Etot_new</span> <span class="o">=</span> <span class="n">Exc</span> <span class="o">+</span> <span class="n">Enuc</span> <span class="o">+</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">Enn</span> <span class="o">+</span> <span class="n">Ecoul</span>
</span><span id="DFT-1503"><a href="#DFT-1503"><span class="linenos">1503</span></a>
</span><span id="DFT-1504"><a href="#DFT-1504"><span class="linenos">1504</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">------Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;--------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1505"><a href="#DFT-1505"><span class="linenos">1505</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energies&#39;</span><span class="p">)</span>
</span><span id="DFT-1506"><a href="#DFT-1506"><span class="linenos">1506</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electron-Nuclear Energy      &#39;</span><span class="p">,</span> <span class="n">Enuc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1507"><a href="#DFT-1507"><span class="linenos">1507</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nuclear repulsion Energy     &#39;</span><span class="p">,</span> <span class="n">Enn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1508"><a href="#DFT-1508"><span class="linenos">1508</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kinetic Energy               &#39;</span><span class="p">,</span> <span class="n">Ekin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1509"><a href="#DFT-1509"><span class="linenos">1509</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Energy               &#39;</span><span class="p">,</span> <span class="n">Ecoul</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1510"><a href="#DFT-1510"><span class="linenos">1510</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Energy  &#39;</span><span class="p">,</span> <span class="n">Exc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1511"><a href="#DFT-1511"><span class="linenos">1511</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------&#39;</span><span class="p">)</span>
</span><span id="DFT-1512"><a href="#DFT-1512"><span class="linenos">1512</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy &#39;</span><span class="p">,</span><span class="n">Etot_new</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1513"><a href="#DFT-1513"><span class="linenos">1513</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1514"><a href="#DFT-1514"><span class="linenos">1514</span></a>
</span><span id="DFT-1515"><a href="#DFT-1515"><span class="linenos">1515</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energy difference : &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1516"><a href="#DFT-1516"><span class="linenos">1516</span></a>
</span><span id="DFT-1517"><a href="#DFT-1517"><span class="linenos">1517</span></a>            
</span><span id="DFT-1518"><a href="#DFT-1518"><span class="linenos">1518</span></a>
</span><span id="DFT-1519"><a href="#DFT-1519"><span class="linenos">1519</span></a>
</span><span id="DFT-1520"><a href="#DFT-1520"><span class="linenos">1520</span></a>            <span class="n">KS</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">J</span> <span class="o">+</span> <span class="n">Vxc</span> 
</span><span id="DFT-1521"><a href="#DFT-1521"><span class="linenos">1521</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT-1522"><a href="#DFT-1522"><span class="linenos">1522</span></a>                <span class="c1"># The following gets rid of the extra information in the CAO basis KS matrix by going to SAO and then back to CAO.</span>
</span><span id="DFT-1523"><a href="#DFT-1523"><span class="linenos">1523</span></a>                <span class="c1"># This way even though the matrix dimensions would be that of CAO but the information would be the same as SAO</span>
</span><span id="DFT-1524"><a href="#DFT-1524"><span class="linenos">1524</span></a>                <span class="c1"># leading to the same energy as SAO basis PySCF or TURBOMOLE calculations</span>
</span><span id="DFT-1525"><a href="#DFT-1525"><span class="linenos">1525</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT-1526"><a href="#DFT-1526"><span class="linenos">1526</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1">#SAO --&gt; CAO</span>
</span><span id="DFT-1527"><a href="#DFT-1527"><span class="linenos">1527</span></a>                
</span><span id="DFT-1528"><a href="#DFT-1528"><span class="linenos">1528</span></a>
</span><span id="DFT-1529"><a href="#DFT-1529"><span class="linenos">1529</span></a>            <span class="c1">#### DIIS</span>
</span><span id="DFT-1530"><a href="#DFT-1530"><span class="linenos">1530</span></a>            <span class="n">startDIIS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1531"><a href="#DFT-1531"><span class="linenos">1531</span></a>            <span class="n">diis_start_itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT-1532"><a href="#DFT-1532"><span class="linenos">1532</span></a>            <span class="k">if</span> <span class="n">itr</span> <span class="o">&gt;=</span> <span class="n">diis_start_itr</span><span class="p">:</span>
</span><span id="DFT-1533"><a href="#DFT-1533"><span class="linenos">1533</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1534"><a href="#DFT-1534"><span class="linenos">1534</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT-1535"><a href="#DFT-1535"><span class="linenos">1535</span></a>                        <span class="c1"># print(&#39;DIIS &#39;, controller.info())</span>
</span><span id="DFT-1536"><a href="#DFT-1536"><span class="linenos">1536</span></a>                        <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="DFT-1537"><a href="#DFT-1537"><span class="linenos">1537</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1538"><a href="#DFT-1538"><span class="linenos">1538</span></a>                    <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS_cupy</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="DFT-1539"><a href="#DFT-1539"><span class="linenos">1539</span></a>                    <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1540"><a href="#DFT-1540"><span class="linenos">1540</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1541"><a href="#DFT-1541"><span class="linenos">1541</span></a>            <span class="n">durationDIIS</span> <span class="o">=</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startDIIS</span>
</span><span id="DFT-1542"><a href="#DFT-1542"><span class="linenos">1542</span></a>
</span><span id="DFT-1543"><a href="#DFT-1543"><span class="linenos">1543</span></a>            <span class="c1">#### Solve KS equation (Diagonalize KS matrix)</span>
</span><span id="DFT-1544"><a href="#DFT-1544"><span class="linenos">1544</span></a>            <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT-1545"><a href="#DFT-1545"><span class="linenos">1545</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1546"><a href="#DFT-1546"><span class="linenos">1546</span></a>                <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_cupy</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Orthogonalization is necessary with CUDA</span>
</span><span id="DFT-1547"><a href="#DFT-1547"><span class="linenos">1547</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc_cupy</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT-1548"><a href="#DFT-1548"><span class="linenos">1548</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm_cupy</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT-1549"><a href="#DFT-1549"><span class="linenos">1549</span></a>                <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">dmat</span>
</span><span id="DFT-1550"><a href="#DFT-1550"><span class="linenos">1550</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">dmat</span><span class="p">)</span>
</span><span id="DFT-1551"><a href="#DFT-1551"><span class="linenos">1551</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1552"><a href="#DFT-1552"><span class="linenos">1552</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT-1553"><a href="#DFT-1553"><span class="linenos">1553</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT-1554"><a href="#DFT-1554"><span class="linenos">1554</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT-1555"><a href="#DFT-1555"><span class="linenos">1555</span></a>                    <span class="c1"># print(&#39;KS eigh&#39;, controller.info())</span>
</span><span id="DFT-1556"><a href="#DFT-1556"><span class="linenos">1556</span></a>                    <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="n">orthogonalize</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</span><span id="DFT-1557"><a href="#DFT-1557"><span class="linenos">1557</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT-1558"><a href="#DFT-1558"><span class="linenos">1558</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT-1559"><a href="#DFT-1559"><span class="linenos">1559</span></a>            <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="DFT-1560"><a href="#DFT-1560"><span class="linenos">1560</span></a>
</span><span id="DFT-1561"><a href="#DFT-1561"><span class="linenos">1561</span></a>            <span class="c1"># Check when to switch to double precision for XC</span>
</span><span id="DFT-1562"><a href="#DFT-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1563"><a href="#DFT-1563"><span class="linenos">1563</span></a>                <span class="k">if</span> <span class="n">precision_XC</span> <span class="ow">is</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
</span><span id="DFT-1564"><a href="#DFT-1564"><span class="linenos">1564</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">5e-7</span><span class="p">:</span>
</span><span id="DFT-1565"><a href="#DFT-1565"><span class="linenos">1565</span></a>                        <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="DFT-1566"><a href="#DFT-1566"><span class="linenos">1566</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Switching to double precision for XC evaluation after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1567"><a href="#DFT-1567"><span class="linenos">1567</span></a>                        
</span><span id="DFT-1568"><a href="#DFT-1568"><span class="linenos">1568</span></a>
</span><span id="DFT-1569"><a href="#DFT-1569"><span class="linenos">1569</span></a>
</span><span id="DFT-1570"><a href="#DFT-1570"><span class="linenos">1570</span></a>            <span class="n">durationItr</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startIter</span>
</span><span id="DFT-1571"><a href="#DFT-1571"><span class="linenos">1571</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Time taken for the previous iteration: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationItr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1572"><a href="#DFT-1572"><span class="linenos">1572</span></a>
</span><span id="DFT-1573"><a href="#DFT-1573"><span class="linenos">1573</span></a>            <span class="c1"># Check convergence criteria</span>
</span><span id="DFT-1574"><a href="#DFT-1574"><span class="linenos">1574</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">conv_crit</span><span class="p">:</span>
</span><span id="DFT-1575"><a href="#DFT-1575"><span class="linenos">1575</span></a>                <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT-1576"><a href="#DFT-1576"><span class="linenos">1576</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1577"><a href="#DFT-1577"><span class="linenos">1577</span></a>                <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="DFT-1578"><a href="#DFT-1578"><span class="linenos">1578</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1579"><a href="#DFT-1579"><span class="linenos">1579</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy = &#39;</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1580"><a href="#DFT-1580"><span class="linenos">1580</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1581"><a href="#DFT-1581"><span class="linenos">1581</span></a>                <span class="k">break</span>
</span><span id="DFT-1582"><a href="#DFT-1582"><span class="linenos">1582</span></a>
</span><span id="DFT-1583"><a href="#DFT-1583"><span class="linenos">1583</span></a>            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="DFT-1584"><a href="#DFT-1584"><span class="linenos">1584</span></a>            <span class="n">itr</span> <span class="o">=</span> <span class="n">itr</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="DFT-1585"><a href="#DFT-1585"><span class="linenos">1585</span></a>            
</span><span id="DFT-1586"><a href="#DFT-1586"><span class="linenos">1586</span></a>
</span><span id="DFT-1587"><a href="#DFT-1587"><span class="linenos">1587</span></a>        <span class="k">if</span> <span class="n">itr</span><span class="o">&gt;=</span><span class="n">max_itr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scf_converged</span><span class="p">:</span>
</span><span id="DFT-1588"><a href="#DFT-1588"><span class="linenos">1588</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF NOT Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1589"><a href="#DFT-1589"><span class="linenos">1589</span></a>
</span><span id="DFT-1590"><a href="#DFT-1590"><span class="linenos">1590</span></a>
</span><span id="DFT-1591"><a href="#DFT-1591"><span class="linenos">1591</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSCF</span>
</span><span id="DFT-1592"><a href="#DFT-1592"><span class="linenos">1592</span></a>        <span class="c1"># print(dmat)</span>
</span><span id="DFT-1593"><a href="#DFT-1593"><span class="linenos">1593</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time taken : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSCF</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; seconds.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1594"><a href="#DFT-1594"><span class="linenos">1594</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1595"><a href="#DFT-1595"><span class="linenos">1595</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1596"><a href="#DFT-1596"><span class="linenos">1596</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Profiling&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1597"><a href="#DFT-1597"><span class="linenos">1597</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1598"><a href="#DFT-1598"><span class="linenos">1598</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preprocessing                          &#39;</span><span class="p">,</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> <span class="o">+</span> <span class="n">durationSchwarz</span><span class="p">)</span>
</span><span id="DFT-1599"><a href="#DFT-1599"><span class="linenos">1599</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-1600"><a href="#DFT-1600"><span class="linenos">1600</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Density Fitting                        &#39;</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1601"><a href="#DFT-1601"><span class="linenos">1601</span></a>            <span class="k">if</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
</span><span id="DFT-1602"><a href="#DFT-1602"><span class="linenos">1602</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (gamma)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1603"><a href="#DFT-1603"><span class="linenos">1603</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (coeff)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1604"><a href="#DFT-1604"><span class="linenos">1604</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Jtri)                          &#39;</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1605"><a href="#DFT-1605"><span class="linenos">1605</span></a>                <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT-1606"><a href="#DFT-1606"><span class="linenos">1606</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Cholesky)                      &#39;</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1607"><a href="#DFT-1607"><span class="linenos">1607</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DIIS                                   &#39;</span><span class="p">,</span> <span class="n">durationDIIS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1608"><a href="#DFT-1608"><span class="linenos">1608</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KS matrix diagonalization              &#39;</span><span class="p">,</span> <span class="n">durationKS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1609"><a href="#DFT-1609"><span class="linenos">1609</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One electron Integrals (S, T, Vnuc)    &#39;</span><span class="p">,</span> <span class="n">duration1e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1610"><a href="#DFT-1610"><span class="linenos">1610</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-1611"><a href="#DFT-1611"><span class="linenos">1611</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (2c2e + 3c2e)        &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="o">-</span><span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1612"><a href="#DFT-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT-1613"><a href="#DFT-1613"><span class="linenos">1613</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (4c2e)               &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1614"><a href="#DFT-1614"><span class="linenos">1614</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids construction                     &#39;</span><span class="p">,</span> <span class="n">durationgrids</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1615"><a href="#DFT-1615"><span class="linenos">1615</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Term              &#39;</span><span class="p">,</span> <span class="n">durationxc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1616"><a href="#DFT-1616"><span class="linenos">1616</span></a>        <span class="n">totalTime</span> <span class="o">=</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">duration1e</span> <span class="o">+</span> <span class="n">durationCoulomb</span> <span class="o">-</span> <span class="n">durationDF_cholesky</span> <span class="o">+</span> \
</span><span id="DFT-1617"><a href="#DFT-1617"><span class="linenos">1617</span></a>            <span class="n">durationgrids</span> <span class="o">+</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">durationDF</span> <span class="o">+</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> 
</span><span id="DFT-1618"><a href="#DFT-1618"><span class="linenos">1618</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Misc.                                  &#39;</span><span class="p">,</span> <span class="n">durationSCF</span> <span class="o">-</span> <span class="n">totalTime</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1619"><a href="#DFT-1619"><span class="linenos">1619</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete SCF                           &#39;</span><span class="p">,</span> <span class="n">durationSCF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT-1620"><a href="#DFT-1620"><span class="linenos">1620</span></a>
</span><span id="DFT-1621"><a href="#DFT-1621"><span class="linenos">1621</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT-1622"><a href="#DFT-1622"><span class="linenos">1622</span></a>            <span class="c1"># Free memory of all GPUs</span>
</span><span id="DFT-1623"><a href="#DFT-1623"><span class="linenos">1623</span></a>            <span class="k">for</span> <span class="n">igpu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="DFT-1624"><a href="#DFT-1624"><span class="linenos">1624</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">igpu</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT-1625"><a href="#DFT-1625"><span class="linenos">1625</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">_default_memory_pool</span><span class="o">.</span><span class="n">free_all_blocks</span><span class="p">()</span>
</span><span id="DFT-1626"><a href="#DFT-1626"><span class="linenos">1626</span></a>
</span><span id="DFT-1627"><a href="#DFT-1627"><span class="linenos">1627</span></a>            <span class="c1"># Switch back to main GPU</span>
</span><span id="DFT-1628"><a href="#DFT-1628"><span class="linenos">1628</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT-1629"><a href="#DFT-1629"><span class="linenos">1629</span></a>        <span class="k">return</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">dmat</span>
</span></pre></div>


            <div class="docstring"><p>A class for performing Density Functional Theory (DFT) calculations 
with optional support for density fitting (DF), GPU acceleration, and LibXC.</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule
    Molecular object on which the DFT calculation is to be performed.</p>

<p>basis : Basis
    Orbital basis set used for the SCF calculation.</p>

<p>auxbasis : Basis, optional
    Auxiliary basis set for density fitting (DF). If None, a default will be assigned.</p>

<p>conv_crit : float, optional
    Convergence criterion for the SCF cycle in Hartrees (default is 1e-7).</p>

<p>dmat_guess_method : str, optional
    Method for the initial density matrix guess (e.g., 'core', 'huckel').</p>

<p>xc : list or str, optional
    Exchange-correlation functional specification. If None, defaults to LDA (<code>[1, 7]</code>).</p>

<p>grids : object, optional
    Precomputed numerical integration grids. If None, they will be generated automatically.</p>

<p>gridsLevel : int, optional
    Level of numerical integration grid refinement (default is 3).</p>

<p>blocksize : int, optional
    Block size for XC grid evaluations. Defaults depend on whether GPU is used.</p>

<p>save_ao_values : bool, optional
    If True, saves AO values to reuse during XC evaluation. Increases speed but uses more memory.</p>

<p>use_gpu : bool, optional
    Whether to use GPU acceleration.</p>

<p>ncores : int, optional
    Number of CPU cores to use (default is 2).</p>

<h2 id="attributes">Attributes</h2>

<p>dmat : ndarray
    Initial guess for the density matrix, will be computed during setup.</p>

<p>KSmats : list
    List of KohnSham matrices used in DIIS extrapolation.</p>

<p>errVecs : list
    List of error vectors for DIIS.</p>

<p>max_itr : int
    Maximum number of SCF iterations (default is 50).</p>

<p>isDF : bool
    Whether to use density fitting for Coulomb integrals.</p>

<p>rys : bool
    Whether to use Rys quadrature for evaluating electron repulsion integrals.</p>

<p>DF_algo : int
    Algorithm selector for DF (reserved for developer use).</p>

<p>XC_algo : int
    Algorithm selector for XC evaluation (2 for CPU, 3 for GPU).</p>

<p>sortGrids : bool
    Whether to sort DFT integration grids (not recommended).</p>

<p>xc_bf_screen : bool
    Enable basis function screening for XC term evaluation.</p>

<p>threshold_schwarz : float
    Threshold for Schwarz screening (default is 1e-9).</p>

<p>strict_schwarz : bool
    If True, applies stricter Schwarz screening.</p>

<p>cholesky : bool
    If True, uses Cholesky decomposition for DF.</p>

<p>orthogonalize : bool
    If True, orthogonalizes AO basis functions.</p>

<p>sao : bool
    If True, uses SAO basis instead of CAO basis.</p>

<p>keep_ao_in_gpu : bool
    Whether to retain AO values in GPU memory during SCF (if <code><a href="#DFT.save_ao_values">save_ao_values</a></code> is True).</p>

<p>use_libxc : bool
    Whether to use LibXC for XC functional evaluation (recommended off for GPU).</p>

<p>n_streams : int
    Number of CUDA streams to use (if applicable).</p>

<p>n_gpus : int
    Number of GPUs to use.</p>

<p>free_gpu_mem : bool
    Whether to forcibly free GPU memory after use.</p>

<p>max_threads_per_block : int
    Maximum threads per CUDA block supported by the device.</p>

<p>threads_x : int
    CUDA thread configuration (X dimension).</p>

<p>threads_y : int
    CUDA thread configuration (Y dimension).</p>

<p>dynamic_precision : bool
    Whether to use precision switching during XC evaluation for performance gains.</p>

<p>keep_ints3c2e_in_gpu : bool
    Whether to keep 3-center 2-electron integrals in GPU memory to avoid transfers.</p>

<p>debug : bool
    If True, prints debugging output during DFT calculations.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>This class supports SCF DFT calculations with density fitting (DF).</li>
<li>GPU support is optional and provides significant speed-up for large systems.</li>
<li>The class is tightly integrated with PyFock and LibXC libraries.</li>
</ul>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">basis</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dft</span> <span class="o">=</span> <span class="n">DFT</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">xc</span><span class="o">=</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dft</span><span class="o">.</span><span class="n">run_scf</span><span class="p">()</span>
</code></pre>
</div>
</div>


                            <div id="DFT.__init__" class="classattr">
                                        <input id="DFT.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DFT</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mol</span>,</span><span class="param">	<span class="n">basis</span>,</span><span class="param">	<span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">conv_crit</span><span class="o">=</span><span class="mf">1e-07</span>,</span><span class="param">	<span class="n">dmat_guess_method</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">xc</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">grids</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">gridsLevel</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">save_ao_values</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">ncores</span><span class="o">=</span><span class="mi">2</span></span>)</span>

                <label class="view-source-button" for="DFT.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.__init__-206"><a href="#DFT.__init__-206"><span class="linenos">206</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv_crit</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">dmat_guess_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="DFT.__init__-207"><a href="#DFT.__init__-207"><span class="linenos">207</span></a>                <span class="n">xc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="DFT.__init__-208"><a href="#DFT.__init__-208"><span class="linenos">208</span></a>                <span class="n">save_ao_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> 
</span><span id="DFT.__init__-209"><a href="#DFT.__init__-209"><span class="linenos">209</span></a>         
</span><span id="DFT.__init__-210"><a href="#DFT.__init__-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
</span><span id="DFT.__init__-211"><a href="#DFT.__init__-211"><span class="linenos">211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Molecular object for which the DFT calculation will be performed &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-212"><a href="#DFT.__init__-212"><span class="linenos">212</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-213"><a href="#DFT.__init__-213"><span class="linenos">213</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Mol object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="DFT.__init__-214"><a href="#DFT.__init__-214"><span class="linenos">214</span></a>        
</span><span id="DFT.__init__-215"><a href="#DFT.__init__-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
</span><span id="DFT.__init__-216"><a href="#DFT.__init__-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object for corresponding to the molecule for the DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-217"><a href="#DFT.__init__-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-218"><a href="#DFT.__init__-218"><span class="linenos">218</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: A Basis object is required to initialize a DFT object.&#39;</span><span class="p">)</span>
</span><span id="DFT.__init__-219"><a href="#DFT.__init__-219"><span class="linenos">219</span></a>
</span><span id="DFT.__init__-220"><a href="#DFT.__init__-220"><span class="linenos">220</span></a>        
</span><span id="DFT.__init__-221"><a href="#DFT.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="n">dmat_guess_method</span>
</span><span id="DFT.__init__-222"><a href="#DFT.__init__-222"><span class="linenos">222</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial guess for the density matrix &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-223"><a href="#DFT.__init__-223"><span class="linenos">223</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-224"><a href="#DFT.__init__-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span> <span class="o">=</span> <span class="s1">&#39;core&#39;</span>
</span><span id="DFT.__init__-225"><a href="#DFT.__init__-225"><span class="linenos">225</span></a>
</span><span id="DFT.__init__-226"><a href="#DFT.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.__init__-227"><a href="#DFT.__init__-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Initial density matrix guess for SCF &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-228"><a href="#DFT.__init__-228"><span class="linenos">228</span></a>        
</span><span id="DFT.__init__-229"><a href="#DFT.__init__-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span>
</span><span id="DFT.__init__-230"><a href="#DFT.__init__-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Exchange-Correlation Functional &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-231"><a href="#DFT.__init__-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="DFT.__init__-232"><a href="#DFT.__init__-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="c1">#LDA</span>
</span><span id="DFT.__init__-233"><a href="#DFT.__init__-233"><span class="linenos">233</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XC not specified, defaulting to LDA functional (LibXC codes: 1, 7)&quot;</span><span class="p">)</span>
</span><span id="DFT.__init__-234"><a href="#DFT.__init__-234"><span class="linenos">234</span></a>
</span><span id="DFT.__init__-235"><a href="#DFT.__init__-235"><span class="linenos">235</span></a>        <span class="c1"># DIIS</span>
</span><span id="DFT.__init__-236"><a href="#DFT.__init__-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.__init__-237"><a href="#DFT.__init__-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.__init__-238"><a href="#DFT.__init__-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="DFT.__init__-239"><a href="#DFT.__init__-239"><span class="linenos">239</span></a>
</span><span id="DFT.__init__-240"><a href="#DFT.__init__-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span> <span class="o">=</span> <span class="n">conv_crit</span>
</span><span id="DFT.__init__-241"><a href="#DFT.__init__-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Convergence criterion for SCF (in Hartrees) &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-242"><a href="#DFT.__init__-242"><span class="linenos">242</span></a>        <span class="c1"># if self.conv_crit is None:</span>
</span><span id="DFT.__init__-243"><a href="#DFT.__init__-243"><span class="linenos">243</span></a>        <span class="c1">#     self.conv_crit = 1.0E-7</span>
</span><span id="DFT.__init__-244"><a href="#DFT.__init__-244"><span class="linenos">244</span></a>
</span><span id="DFT.__init__-245"><a href="#DFT.__init__-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span> <span class="o">=</span> <span class="mi">50</span> 
</span><span id="DFT.__init__-246"><a href="#DFT.__init__-246"><span class="linenos">246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Maximum number of iterations for SCF &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-247"><a href="#DFT.__init__-247"><span class="linenos">247</span></a>        <span class="c1"># if self.max_itr is None:</span>
</span><span id="DFT.__init__-248"><a href="#DFT.__init__-248"><span class="linenos">248</span></a>        <span class="c1">#     self.max_itr = 50</span>
</span><span id="DFT.__init__-249"><a href="#DFT.__init__-249"><span class="linenos">249</span></a>
</span><span id="DFT.__init__-250"><a href="#DFT.__init__-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="n">ncores</span>
</span><span id="DFT.__init__-251"><a href="#DFT.__init__-251"><span class="linenos">251</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of cores to be used for DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-252"><a href="#DFT.__init__-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-253"><a href="#DFT.__init__-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT.__init__-254"><a href="#DFT.__init__-254"><span class="linenos">254</span></a>
</span><span id="DFT.__init__-255"><a href="#DFT.__init__-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grids</span> <span class="o">=</span> <span class="n">grids</span> 
</span><span id="DFT.__init__-256"><a href="#DFT.__init__-256"><span class="linenos">256</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation (If None or not supplied, will be generated using NumGrid) &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-257"><a href="#DFT.__init__-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span> <span class="o">=</span> <span class="n">gridsLevel</span>
</span><span id="DFT.__init__-258"><a href="#DFT.__init__-258"><span class="linenos">258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Atomic grids for DFT calculation &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-259"><a href="#DFT.__init__-259"><span class="linenos">259</span></a>
</span><span id="DFT.__init__-260"><a href="#DFT.__init__-260"><span class="linenos">260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-261"><a href="#DFT.__init__-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use density fitting (DF) for two-electron Coulomb integrals. This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-262"><a href="#DFT.__init__-262"><span class="linenos">262</span></a>
</span><span id="DFT.__init__-263"><a href="#DFT.__init__-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="o">=</span> <span class="n">auxbasis</span>
</span><span id="DFT.__init__-264"><a href="#DFT.__init__-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Basis object to be used as the auxiliary basis for DF &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-265"><a href="#DFT.__init__-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-266"><a href="#DFT.__init__-266"><span class="linenos">266</span></a>            <span class="n">auxbasis</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-universal-jfit&#39;</span><span class="p">)})</span>
</span><span id="DFT.__init__-267"><a href="#DFT.__init__-267"><span class="linenos">267</span></a>
</span><span id="DFT.__init__-268"><a href="#DFT.__init__-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rys</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-269"><a href="#DFT.__init__-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Use rys quadrature for the evaluation of two electron integrals (with and without DF)&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-270"><a href="#DFT.__init__-270"><span class="linenos">270</span></a>
</span><span id="DFT.__init__-271"><a href="#DFT.__init__-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="DFT.__init__-272"><a href="#DFT.__init__-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-273"><a href="#DFT.__init__-273"><span class="linenos">273</span></a>
</span><span id="DFT.__init__-274"><a href="#DFT.__init__-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">blocksize</span>
</span><span id="DFT.__init__-275"><a href="#DFT.__init__-275"><span class="linenos">275</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Block size for the evaulation of XC term on grids. For CPUs a value of ~5000 is recommended. For GPUs, a value &gt;20480 is recommended. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-276"><a href="#DFT.__init__-276"><span class="linenos">276</span></a>        <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.__init__-277"><a href="#DFT.__init__-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.__init__-278"><a href="#DFT.__init__-278"><span class="linenos">278</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="DFT.__init__-279"><a href="#DFT.__init__-279"><span class="linenos">279</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.__init__-280"><a href="#DFT.__init__-280"><span class="linenos">280</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="DFT.__init__-281"><a href="#DFT.__init__-281"><span class="linenos">281</span></a>        
</span><span id="DFT.__init__-282"><a href="#DFT.__init__-282"><span class="linenos">282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.__init__-283"><a href="#DFT.__init__-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; This is only for developers. Users should not change it. The algorithm for XC evaluation should be 2 for CPU and 3 for GPU.&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-284"><a href="#DFT.__init__-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.__init__-285"><a href="#DFT.__init__-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="DFT.__init__-286"><a href="#DFT.__init__-286"><span class="linenos">286</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.__init__-287"><a href="#DFT.__init__-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span> 
</span><span id="DFT.__init__-288"><a href="#DFT.__init__-288"><span class="linenos">288</span></a>
</span><span id="DFT.__init__-289"><a href="#DFT.__init__-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.__init__-290"><a href="#DFT.__init__-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Turn on printing debug statements &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-291"><a href="#DFT.__init__-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.__init__-292"><a href="#DFT.__init__-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable/Disable sorting of DFT grids. Doesn&#39;t seem to offer any signficant advantage.&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-293"><a href="#DFT.__init__-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span> <span class="o">=</span> <span class="n">save_ao_values</span>
</span><span id="DFT.__init__-294"><a href="#DFT.__init__-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to save atomic orbital (AO) values for reuse during XC evaluation. Improves performance but requires more memory. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-295"><a href="#DFT.__init__-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-296"><a href="#DFT.__init__-296"><span class="linenos">296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable screening of basis functions for XC term evaluation to reduce computation time drastically. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-297"><a href="#DFT.__init__-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="mf">1e-09</span>
</span><span id="DFT.__init__-298"><a href="#DFT.__init__-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Threshold for Schwarz screening of two-electron integrals. Smaller values increase accuracy but reduce sparsity. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-299"><a href="#DFT.__init__-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-300"><a href="#DFT.__init__-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; If True, enforce stricter Schwarz screening to aggressively eliminate small two-electron integrals. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-301"><a href="#DFT.__init__-301"><span class="linenos">301</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-302"><a href="#DFT.__init__-302"><span class="linenos">302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use Cholesky decomposition for DF. Slightly speeds up calculations. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-303"><a href="#DFT.__init__-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-304"><a href="#DFT.__init__-304"><span class="linenos">304</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply orthogonalization to the AO basis. Should be True for most standard calculations. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-305"><a href="#DFT.__init__-305"><span class="linenos">305</span></a>
</span><span id="DFT.__init__-306"><a href="#DFT.__init__-306"><span class="linenos">306</span></a>
</span><span id="DFT.__init__-307"><a href="#DFT.__init__-307"><span class="linenos">307</span></a>        <span class="c1"># CAO or SAO</span>
</span><span id="DFT.__init__-308"><a href="#DFT.__init__-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sao</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.__init__-309"><a href="#DFT.__init__-309"><span class="linenos">309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use SAO basis or CAO basis. Default is CAO basis. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-310"><a href="#DFT.__init__-310"><span class="linenos">310</span></a>
</span><span id="DFT.__init__-311"><a href="#DFT.__init__-311"><span class="linenos">311</span></a>
</span><span id="DFT.__init__-312"><a href="#DFT.__init__-312"><span class="linenos">312</span></a>        <span class="c1"># GPU acceleration</span>
</span><span id="DFT.__init__-313"><a href="#DFT.__init__-313"><span class="linenos">313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="n">use_gpu</span>
</span><span id="DFT.__init__-314"><a href="#DFT.__init__-314"><span class="linenos">314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use GPU acceleration or not &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-315"><a href="#DFT.__init__-315"><span class="linenos">315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-316"><a href="#DFT.__init__-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the atomic orbitals for XC evaluation in GPU memory or CPU memory. Only relevant if save_ao_values = True. &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-317"><a href="#DFT.__init__-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-318"><a href="#DFT.__init__-318"><span class="linenos">318</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use LibXC&#39;s version of XC functionals or PyFock implementations. </span>
</span><span id="DFT.__init__-319"><a href="#DFT.__init__-319"><span class="linenos">319</span></a><span class="sd">        Only relevant when GPU is used. For GPU calculations it is recommended to use PyFock </span>
</span><span id="DFT.__init__-320"><a href="#DFT.__init__-320"><span class="linenos">320</span></a><span class="sd">        implementation as it avoids CPU-GPU transfers.&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-321"><a href="#DFT.__init__-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT.__init__-322"><a href="#DFT.__init__-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT.__init__-323"><a href="#DFT.__init__-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of GPUs to be used &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-324"><a href="#DFT.__init__-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.__init__-325"><a href="#DFT.__init__-325"><span class="linenos">325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether the GPU memory should be freed by force or not&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-326"><a href="#DFT.__init__-326"><span class="linenos">326</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DFT.__init__-327"><a href="#DFT.__init__-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span>
</span><span id="DFT.__init__-328"><a href="#DFT.__init__-328"><span class="linenos">328</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="DFT.__init__-329"><a href="#DFT.__init__-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="DFT.__init__-330"><a href="#DFT.__init__-330"><span class="linenos">330</span></a>        
</span><span id="DFT.__init__-331"><a href="#DFT.__init__-331"><span class="linenos">331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
</span><span id="DFT.__init__-332"><a href="#DFT.__init__-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads_per_block</span><span class="o">/</span><span class="mi">64</span><span class="p">)</span>
</span><span id="DFT.__init__-333"><a href="#DFT.__init__-333"><span class="linenos">333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Only for the XC term</span>
</span><span id="DFT.__init__-334"><a href="#DFT.__init__-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to use dynamic precision switching for XC term or not &quot;&quot;&quot;</span>
</span><span id="DFT.__init__-335"><a href="#DFT.__init__-335"><span class="linenos">335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.__init__-336"><a href="#DFT.__init__-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Whether to keep the 3c2e integrals in GPU memory or not. </span>
</span><span id="DFT.__init__-337"><a href="#DFT.__init__-337"><span class="linenos">337</span></a><span class="sd">        Recommended to keep in GPU memory to avoid CPU-GPU transfers at each iteration.&quot;&quot;&quot;</span>
</span><span id="DFT.__init__-338"><a href="#DFT.__init__-338"><span class="linenos">338</span></a>        
</span><span id="DFT.__init__-339"><a href="#DFT.__init__-339"><span class="linenos">339</span></a>        <span class="c1"># self.max_threads_per_block = 1024</span>
</span><span id="DFT.__init__-340"><a href="#DFT.__init__-340"><span class="linenos">340</span></a>        <span class="c1"># self.threads_x = 64</span>
</span><span id="DFT.__init__-341"><a href="#DFT.__init__-341"><span class="linenos">341</span></a>        <span class="c1"># self.threads_y = 16</span>
</span><span id="DFT.__init__-342"><a href="#DFT.__init__-342"><span class="linenos">342</span></a>
</span><span id="DFT.__init__-343"><a href="#DFT.__init__-343"><span class="linenos">343</span></a>        <span class="c1"># if self.use_gpu:</span>
</span><span id="DFT.__init__-344"><a href="#DFT.__init__-344"><span class="linenos">344</span></a>        <span class="c1">#     try:</span>
</span><span id="DFT.__init__-345"><a href="#DFT.__init__-345"><span class="linenos">345</span></a>        <span class="c1">#         global cp</span>
</span><span id="DFT.__init__-346"><a href="#DFT.__init__-346"><span class="linenos">346</span></a>        <span class="c1">#         global cupy_scipy</span>
</span><span id="DFT.__init__-347"><a href="#DFT.__init__-347"><span class="linenos">347</span></a>        <span class="c1">#         import cupy as cp</span>
</span><span id="DFT.__init__-348"><a href="#DFT.__init__-348"><span class="linenos">348</span></a>        <span class="c1">#         import cupyx.scipy as cupy_scipy</span>
</span><span id="DFT.__init__-349"><a href="#DFT.__init__-349"><span class="linenos">349</span></a>        <span class="c1">#         # from cupy.linalg import eig, multi_dot as dot</span>
</span><span id="DFT.__init__-350"><a href="#DFT.__init__-350"><span class="linenos">350</span></a>        <span class="c1">#     except ModuleNotFoundError:</span>
</span><span id="DFT.__init__-351"><a href="#DFT.__init__-351"><span class="linenos">351</span></a>        <span class="c1">#         print(&#39;Cupy was not found!&#39;)</span>
</span></pre></div>


    

                            </div>
                            <div id="DFT.mol" class="classattr">
                                <div class="attr variable">
            <span class="name">mol</span>

        
    </div>
    <a class="headerlink" href="#DFT.mol"></a>
    
            <div class="docstring"><p>Molecular object for which the DFT calculation will be performed</p>
</div>


                            </div>
                            <div id="DFT.basis" class="classattr">
                                <div class="attr variable">
            <span class="name">basis</span>

        
    </div>
    <a class="headerlink" href="#DFT.basis"></a>
    
            <div class="docstring"><p>Basis object for corresponding to the molecule for the DFT calculation</p>
</div>


                            </div>
                            <div id="DFT.dmat_guess_method" class="classattr">
                                <div class="attr variable">
            <span class="name">dmat_guess_method</span>

        
    </div>
    <a class="headerlink" href="#DFT.dmat_guess_method"></a>
    
            <div class="docstring"><p>Initial guess for the density matrix</p>
</div>


                            </div>
                            <div id="DFT.dmat" class="classattr">
                                <div class="attr variable">
            <span class="name">dmat</span>

        
    </div>
    <a class="headerlink" href="#DFT.dmat"></a>
    
            <div class="docstring"><p>Initial density matrix guess for SCF</p>
</div>


                            </div>
                            <div id="DFT.xc" class="classattr">
                                <div class="attr variable">
            <span class="name">xc</span>

        
    </div>
    <a class="headerlink" href="#DFT.xc"></a>
    
            <div class="docstring"><p>Exchange-Correlation Functional</p>
</div>


                            </div>
                            <div id="DFT.KSmats" class="classattr">
                                <div class="attr variable">
            <span class="name">KSmats</span>

        
    </div>
    <a class="headerlink" href="#DFT.KSmats"></a>
    
    

                            </div>
                            <div id="DFT.errVecs" class="classattr">
                                <div class="attr variable">
            <span class="name">errVecs</span>

        
    </div>
    <a class="headerlink" href="#DFT.errVecs"></a>
    
    

                            </div>
                            <div id="DFT.diisSpace" class="classattr">
                                <div class="attr variable">
            <span class="name">diisSpace</span>

        
    </div>
    <a class="headerlink" href="#DFT.diisSpace"></a>
    
    

                            </div>
                            <div id="DFT.conv_crit" class="classattr">
                                <div class="attr variable">
            <span class="name">conv_crit</span>

        
    </div>
    <a class="headerlink" href="#DFT.conv_crit"></a>
    
            <div class="docstring"><p>Convergence criterion for SCF (in Hartrees)</p>
</div>


                            </div>
                            <div id="DFT.max_itr" class="classattr">
                                <div class="attr variable">
            <span class="name">max_itr</span>

        
    </div>
    <a class="headerlink" href="#DFT.max_itr"></a>
    
            <div class="docstring"><p>Maximum number of iterations for SCF</p>
</div>


                            </div>
                            <div id="DFT.ncores" class="classattr">
                                <div class="attr variable">
            <span class="name">ncores</span>

        
    </div>
    <a class="headerlink" href="#DFT.ncores"></a>
    
            <div class="docstring"><p>Number of cores to be used for DFT calculation</p>
</div>


                            </div>
                            <div id="DFT.grids" class="classattr">
                                <div class="attr variable">
            <span class="name">grids</span>

        
    </div>
    <a class="headerlink" href="#DFT.grids"></a>
    
            <div class="docstring"><p>Atomic grids for DFT calculation (If None or not supplied, will be generated using NumGrid)</p>
</div>


                            </div>
                            <div id="DFT.gridsLevel" class="classattr">
                                <div class="attr variable">
            <span class="name">gridsLevel</span>

        
    </div>
    <a class="headerlink" href="#DFT.gridsLevel"></a>
    
            <div class="docstring"><p>Atomic grids for DFT calculation</p>
</div>


                            </div>
                            <div id="DFT.isDF" class="classattr">
                                <div class="attr variable">
            <span class="name">isDF</span>

        
    </div>
    <a class="headerlink" href="#DFT.isDF"></a>
    
            <div class="docstring"><p>Use density fitting (DF) for two-electron Coulomb integrals. This is only for developers. Users should not change it.</p>
</div>


                            </div>
                            <div id="DFT.auxbasis" class="classattr">
                                <div class="attr variable">
            <span class="name">auxbasis</span>

        
    </div>
    <a class="headerlink" href="#DFT.auxbasis"></a>
    
            <div class="docstring"><p>Basis object to be used as the auxiliary basis for DF</p>
</div>


                            </div>
                            <div id="DFT.rys" class="classattr">
                                <div class="attr variable">
            <span class="name">rys</span>

        
    </div>
    <a class="headerlink" href="#DFT.rys"></a>
    
            <div class="docstring"><p>Use rys quadrature for the evaluation of two electron integrals (with and without DF)</p>
</div>


                            </div>
                            <div id="DFT.DF_algo" class="classattr">
                                <div class="attr variable">
            <span class="name">DF_algo</span>

        
    </div>
    <a class="headerlink" href="#DFT.DF_algo"></a>
    
            <div class="docstring"><p>This is only for developers. Users should not change it.</p>
</div>


                            </div>
                            <div id="DFT.blocksize" class="classattr">
                                <div class="attr variable">
            <span class="name">blocksize</span>

        
    </div>
    <a class="headerlink" href="#DFT.blocksize"></a>
    
            <div class="docstring"><p>Block size for the evaulation of XC term on grids. For CPUs a value of ~5000 is recommended. For GPUs, a value &gt;20480 is recommended.</p>
</div>


                            </div>
                            <div id="DFT.XC_algo" class="classattr">
                                <div class="attr variable">
            <span class="name">XC_algo</span>

        
    </div>
    <a class="headerlink" href="#DFT.XC_algo"></a>
    
            <div class="docstring"><p>This is only for developers. Users should not change it. The algorithm for XC evaluation should be 2 for CPU and 3 for GPU.</p>
</div>


                            </div>
                            <div id="DFT.debug" class="classattr">
                                <div class="attr variable">
            <span class="name">debug</span>

        
    </div>
    <a class="headerlink" href="#DFT.debug"></a>
    
            <div class="docstring"><p>Turn on printing debug statements</p>
</div>


                            </div>
                            <div id="DFT.sortGrids" class="classattr">
                                <div class="attr variable">
            <span class="name">sortGrids</span>

        
    </div>
    <a class="headerlink" href="#DFT.sortGrids"></a>
    
            <div class="docstring"><p>Enable/Disable sorting of DFT grids. Doesn't seem to offer any signficant advantage.</p>
</div>


                            </div>
                            <div id="DFT.save_ao_values" class="classattr">
                                <div class="attr variable">
            <span class="name">save_ao_values</span>

        
    </div>
    <a class="headerlink" href="#DFT.save_ao_values"></a>
    
            <div class="docstring"><p>Whether to save atomic orbital (AO) values for reuse during XC evaluation. Improves performance but requires more memory.</p>
</div>


                            </div>
                            <div id="DFT.xc_bf_screen" class="classattr">
                                <div class="attr variable">
            <span class="name">xc_bf_screen</span>

        
    </div>
    <a class="headerlink" href="#DFT.xc_bf_screen"></a>
    
            <div class="docstring"><p>Enable screening of basis functions for XC term evaluation to reduce computation time drastically.</p>
</div>


                            </div>
                            <div id="DFT.threshold_schwarz" class="classattr">
                                <div class="attr variable">
            <span class="name">threshold_schwarz</span>

        
    </div>
    <a class="headerlink" href="#DFT.threshold_schwarz"></a>
    
            <div class="docstring"><p>Threshold for Schwarz screening of two-electron integrals. Smaller values increase accuracy but reduce sparsity.</p>
</div>


                            </div>
                            <div id="DFT.strict_schwarz" class="classattr">
                                <div class="attr variable">
            <span class="name">strict_schwarz</span>

        
    </div>
    <a class="headerlink" href="#DFT.strict_schwarz"></a>
    
            <div class="docstring"><p>If True, enforce stricter Schwarz screening to aggressively eliminate small two-electron integrals.</p>
</div>


                            </div>
                            <div id="DFT.cholesky" class="classattr">
                                <div class="attr variable">
            <span class="name">cholesky</span>

        
    </div>
    <a class="headerlink" href="#DFT.cholesky"></a>
    
            <div class="docstring"><p>Whether to use Cholesky decomposition for DF. Slightly speeds up calculations.</p>
</div>


                            </div>
                            <div id="DFT.orthogonalize" class="classattr">
                                <div class="attr variable">
            <span class="name">orthogonalize</span>

        
    </div>
    <a class="headerlink" href="#DFT.orthogonalize"></a>
    
            <div class="docstring"><p>Apply orthogonalization to the AO basis. Should be True for most standard calculations.</p>
</div>


                            </div>
                            <div id="DFT.sao" class="classattr">
                                <div class="attr variable">
            <span class="name">sao</span>

        
    </div>
    <a class="headerlink" href="#DFT.sao"></a>
    
            <div class="docstring"><p>Whether to use SAO basis or CAO basis. Default is CAO basis.</p>
</div>


                            </div>
                            <div id="DFT.use_gpu" class="classattr">
                                <div class="attr variable">
            <span class="name">use_gpu</span>

        
    </div>
    <a class="headerlink" href="#DFT.use_gpu"></a>
    
            <div class="docstring"><p>Whether to use GPU acceleration or not</p>
</div>


                            </div>
                            <div id="DFT.keep_ao_in_gpu" class="classattr">
                                <div class="attr variable">
            <span class="name">keep_ao_in_gpu</span>

        
    </div>
    <a class="headerlink" href="#DFT.keep_ao_in_gpu"></a>
    
            <div class="docstring"><p>Whether to keep the atomic orbitals for XC evaluation in GPU memory or CPU memory. Only relevant if save_ao_values = True.</p>
</div>


                            </div>
                            <div id="DFT.use_libxc" class="classattr">
                                <div class="attr variable">
            <span class="name">use_libxc</span>

        
    </div>
    <a class="headerlink" href="#DFT.use_libxc"></a>
    
            <div class="docstring"><p>Whether to use LibXC's version of XC functionals or PyFock implementations. 
Only relevant when GPU is used. For GPU calculations it is recommended to use PyFock 
implementation as it avoids CPU-GPU transfers.</p>
</div>


                            </div>
                            <div id="DFT.n_streams" class="classattr">
                                <div class="attr variable">
            <span class="name">n_streams</span>

        
    </div>
    <a class="headerlink" href="#DFT.n_streams"></a>
    
    

                            </div>
                            <div id="DFT.n_gpus" class="classattr">
                                <div class="attr variable">
            <span class="name">n_gpus</span>

        
    </div>
    <a class="headerlink" href="#DFT.n_gpus"></a>
    
            <div class="docstring"><p>Number of GPUs to be used</p>
</div>


                            </div>
                            <div id="DFT.free_gpu_mem" class="classattr">
                                <div class="attr variable">
            <span class="name">free_gpu_mem</span>

        
    </div>
    <a class="headerlink" href="#DFT.free_gpu_mem"></a>
    
            <div class="docstring"><p>Whether the GPU memory should be freed by force or not</p>
</div>


                            </div>
                            <div id="DFT.threads_x" class="classattr">
                                <div class="attr variable">
            <span class="name">threads_x</span>

        
    </div>
    <a class="headerlink" href="#DFT.threads_x"></a>
    
    

                            </div>
                            <div id="DFT.threads_y" class="classattr">
                                <div class="attr variable">
            <span class="name">threads_y</span>

        
    </div>
    <a class="headerlink" href="#DFT.threads_y"></a>
    
    

                            </div>
                            <div id="DFT.dynamic_precision" class="classattr">
                                <div class="attr variable">
            <span class="name">dynamic_precision</span>

        
    </div>
    <a class="headerlink" href="#DFT.dynamic_precision"></a>
    
            <div class="docstring"><p>Whether to use dynamic precision switching for XC term or not</p>
</div>


                            </div>
                            <div id="DFT.keep_ints3c2e_in_gpu" class="classattr">
                                <div class="attr variable">
            <span class="name">keep_ints3c2e_in_gpu</span>

        
    </div>
    <a class="headerlink" href="#DFT.keep_ints3c2e_in_gpu"></a>
    
            <div class="docstring"><p>Whether to keep the 3c2e integrals in GPU memory or not. 
Recommended to keep in GPU memory to avoid CPU-GPU transfers at each iteration.</p>
</div>


                            </div>
                            <div id="DFT.nuclear_rep_energy" class="classattr">
                                        <input id="DFT.nuclear_rep_energy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nuclear_rep_energy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mol</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.nuclear_rep_energy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.nuclear_rep_energy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.nuclear_rep_energy-356"><a href="#DFT.nuclear_rep_energy-356"><span class="linenos">356</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nuclear_rep_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.nuclear_rep_energy-357"><a href="#DFT.nuclear_rep_energy-357"><span class="linenos">357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.nuclear_rep_energy-358"><a href="#DFT.nuclear_rep_energy-358"><span class="linenos">358</span></a><span class="sd">        Compute the nuclear-nuclear repulsion energy.</span>
</span><span id="DFT.nuclear_rep_energy-359"><a href="#DFT.nuclear_rep_energy-359"><span class="linenos">359</span></a>
</span><span id="DFT.nuclear_rep_energy-360"><a href="#DFT.nuclear_rep_energy-360"><span class="linenos">360</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.nuclear_rep_energy-361"><a href="#DFT.nuclear_rep_energy-361"><span class="linenos">361</span></a><span class="sd">        ----------</span>
</span><span id="DFT.nuclear_rep_energy-362"><a href="#DFT.nuclear_rep_energy-362"><span class="linenos">362</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT.nuclear_rep_energy-363"><a href="#DFT.nuclear_rep_energy-363"><span class="linenos">363</span></a><span class="sd">            Molecule object containing nuclear coordinates and charges. </span>
</span><span id="DFT.nuclear_rep_energy-364"><a href="#DFT.nuclear_rep_energy-364"><span class="linenos">364</span></a><span class="sd">            If None, uses `self.mol`.</span>
</span><span id="DFT.nuclear_rep_energy-365"><a href="#DFT.nuclear_rep_energy-365"><span class="linenos">365</span></a>
</span><span id="DFT.nuclear_rep_energy-366"><a href="#DFT.nuclear_rep_energy-366"><span class="linenos">366</span></a><span class="sd">        Returns</span>
</span><span id="DFT.nuclear_rep_energy-367"><a href="#DFT.nuclear_rep_energy-367"><span class="linenos">367</span></a><span class="sd">        -------</span>
</span><span id="DFT.nuclear_rep_energy-368"><a href="#DFT.nuclear_rep_energy-368"><span class="linenos">368</span></a><span class="sd">        float</span>
</span><span id="DFT.nuclear_rep_energy-369"><a href="#DFT.nuclear_rep_energy-369"><span class="linenos">369</span></a><span class="sd">            The nuclear repulsion energy in Hartrees.</span>
</span><span id="DFT.nuclear_rep_energy-370"><a href="#DFT.nuclear_rep_energy-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.nuclear_rep_energy-371"><a href="#DFT.nuclear_rep_energy-371"><span class="linenos">371</span></a>        <span class="c1"># Nuclear-nuclear energy</span>
</span><span id="DFT.nuclear_rep_energy-372"><a href="#DFT.nuclear_rep_energy-372"><span class="linenos">372</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="DFT.nuclear_rep_energy-373"><a href="#DFT.nuclear_rep_energy-373"><span class="linenos">373</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT.nuclear_rep_energy-374"><a href="#DFT.nuclear_rep_energy-374"><span class="linenos">374</span></a>    
</span><span id="DFT.nuclear_rep_energy-375"><a href="#DFT.nuclear_rep_energy-375"><span class="linenos">375</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.nuclear_rep_energy-376"><a href="#DFT.nuclear_rep_energy-376"><span class="linenos">376</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="DFT.nuclear_rep_energy-377"><a href="#DFT.nuclear_rep_energy-377"><span class="linenos">377</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
</span><span id="DFT.nuclear_rep_energy-378"><a href="#DFT.nuclear_rep_energy-378"><span class="linenos">378</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">):</span>
</span><span id="DFT.nuclear_rep_energy-379"><a href="#DFT.nuclear_rep_energy-379"><span class="linenos">379</span></a>                    <span class="n">dist</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mol</span><span class="o">.</span><span class="n">coordsBohrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="DFT.nuclear_rep_energy-380"><a href="#DFT.nuclear_rep_energy-380"><span class="linenos">380</span></a>                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mol</span><span class="o">.</span><span class="n">Zcharges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="DFT.nuclear_rep_energy-381"><a href="#DFT.nuclear_rep_energy-381"><span class="linenos">381</span></a>
</span><span id="DFT.nuclear_rep_energy-382"><a href="#DFT.nuclear_rep_energy-382"><span class="linenos">382</span></a>        <span class="k">return</span> <span class="n">e</span>
</span></pre></div>


            <div class="docstring"><p>Compute the nuclear-nuclear repulsion energy.</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule, optional
    Molecule object containing nuclear coordinates and charges. 
    If None, uses <code>self.mol</code>.</p>

<h2 id="returns">Returns</h2>

<p>float
    The nuclear repulsion energy in Hartrees.</p>
</div>


                            </div>
                            <div id="DFT.gen_dm" class="classattr">
                                        <input id="DFT.gen_dm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gen_dm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mo_coeff</span>, </span><span class="param"><span class="n">mo_occ</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.gen_dm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.gen_dm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.gen_dm-385"><a href="#DFT.gen_dm-385"><span class="linenos">385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="DFT.gen_dm-386"><a href="#DFT.gen_dm-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.gen_dm-387"><a href="#DFT.gen_dm-387"><span class="linenos">387</span></a><span class="sd">        Generate the density matrix from molecular orbital coefficients and occupations.</span>
</span><span id="DFT.gen_dm-388"><a href="#DFT.gen_dm-388"><span class="linenos">388</span></a>
</span><span id="DFT.gen_dm-389"><a href="#DFT.gen_dm-389"><span class="linenos">389</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.gen_dm-390"><a href="#DFT.gen_dm-390"><span class="linenos">390</span></a><span class="sd">        ----------</span>
</span><span id="DFT.gen_dm-391"><a href="#DFT.gen_dm-391"><span class="linenos">391</span></a><span class="sd">        mo_coeff : ndarray</span>
</span><span id="DFT.gen_dm-392"><a href="#DFT.gen_dm-392"><span class="linenos">392</span></a><span class="sd">            Molecular orbital coefficient matrix.</span>
</span><span id="DFT.gen_dm-393"><a href="#DFT.gen_dm-393"><span class="linenos">393</span></a>
</span><span id="DFT.gen_dm-394"><a href="#DFT.gen_dm-394"><span class="linenos">394</span></a><span class="sd">        mo_occ : ndarray</span>
</span><span id="DFT.gen_dm-395"><a href="#DFT.gen_dm-395"><span class="linenos">395</span></a><span class="sd">            Array of MO occupation numbers.</span>
</span><span id="DFT.gen_dm-396"><a href="#DFT.gen_dm-396"><span class="linenos">396</span></a>
</span><span id="DFT.gen_dm-397"><a href="#DFT.gen_dm-397"><span class="linenos">397</span></a><span class="sd">        Returns</span>
</span><span id="DFT.gen_dm-398"><a href="#DFT.gen_dm-398"><span class="linenos">398</span></a><span class="sd">        -------</span>
</span><span id="DFT.gen_dm-399"><a href="#DFT.gen_dm-399"><span class="linenos">399</span></a><span class="sd">        ndarray</span>
</span><span id="DFT.gen_dm-400"><a href="#DFT.gen_dm-400"><span class="linenos">400</span></a><span class="sd">            Density matrix (RHF/RKS type).</span>
</span><span id="DFT.gen_dm-401"><a href="#DFT.gen_dm-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.gen_dm-402"><a href="#DFT.gen_dm-402"><span class="linenos">402</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.gen_dm-403"><a href="#DFT.gen_dm-403"><span class="linenos">403</span></a>   
</span><span id="DFT.gen_dm-404"><a href="#DFT.gen_dm-404"><span class="linenos">404</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate the density matrix from molecular orbital coefficients and occupations.</p>

<h2 id="parameters">Parameters</h2>

<p>mo_coeff : ndarray
    Molecular orbital coefficient matrix.</p>

<p>mo_occ : ndarray
    Array of MO occupation numbers.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Density matrix (RHF/RKS type).</p>
</div>


                            </div>
                            <div id="DFT.getOcc" class="classattr">
                                        <input id="DFT.getOcc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getOcc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mol</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.getOcc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.getOcc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.getOcc-406"><a href="#DFT.getOcc-406"><span class="linenos">406</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.getOcc-407"><a href="#DFT.getOcc-407"><span class="linenos">407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.getOcc-408"><a href="#DFT.getOcc-408"><span class="linenos">408</span></a><span class="sd">        Assign occupation numbers to molecular orbitals based on their energies.</span>
</span><span id="DFT.getOcc-409"><a href="#DFT.getOcc-409"><span class="linenos">409</span></a>
</span><span id="DFT.getOcc-410"><a href="#DFT.getOcc-410"><span class="linenos">410</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.getOcc-411"><a href="#DFT.getOcc-411"><span class="linenos">411</span></a><span class="sd">        ----------</span>
</span><span id="DFT.getOcc-412"><a href="#DFT.getOcc-412"><span class="linenos">412</span></a><span class="sd">        mol : Molecule</span>
</span><span id="DFT.getOcc-413"><a href="#DFT.getOcc-413"><span class="linenos">413</span></a><span class="sd">            Molecule object to extract the number of electrons.</span>
</span><span id="DFT.getOcc-414"><a href="#DFT.getOcc-414"><span class="linenos">414</span></a>
</span><span id="DFT.getOcc-415"><a href="#DFT.getOcc-415"><span class="linenos">415</span></a><span class="sd">        energy_mo : ndarray</span>
</span><span id="DFT.getOcc-416"><a href="#DFT.getOcc-416"><span class="linenos">416</span></a><span class="sd">            Array of MO energies.</span>
</span><span id="DFT.getOcc-417"><a href="#DFT.getOcc-417"><span class="linenos">417</span></a>
</span><span id="DFT.getOcc-418"><a href="#DFT.getOcc-418"><span class="linenos">418</span></a><span class="sd">        coeff_mo : ndarray</span>
</span><span id="DFT.getOcc-419"><a href="#DFT.getOcc-419"><span class="linenos">419</span></a><span class="sd">            Array of MO coefficients (not used but kept for compatibility).</span>
</span><span id="DFT.getOcc-420"><a href="#DFT.getOcc-420"><span class="linenos">420</span></a>
</span><span id="DFT.getOcc-421"><a href="#DFT.getOcc-421"><span class="linenos">421</span></a><span class="sd">        Returns</span>
</span><span id="DFT.getOcc-422"><a href="#DFT.getOcc-422"><span class="linenos">422</span></a><span class="sd">        -------</span>
</span><span id="DFT.getOcc-423"><a href="#DFT.getOcc-423"><span class="linenos">423</span></a><span class="sd">        ndarray</span>
</span><span id="DFT.getOcc-424"><a href="#DFT.getOcc-424"><span class="linenos">424</span></a><span class="sd">            Array of MO occupations (0 or 2 for RHF).</span>
</span><span id="DFT.getOcc-425"><a href="#DFT.getOcc-425"><span class="linenos">425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.getOcc-426"><a href="#DFT.getOcc-426"><span class="linenos">426</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="DFT.getOcc-427"><a href="#DFT.getOcc-427"><span class="linenos">427</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="DFT.getOcc-428"><a href="#DFT.getOcc-428"><span class="linenos">428</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="DFT.getOcc-429"><a href="#DFT.getOcc-429"><span class="linenos">429</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="DFT.getOcc-430"><a href="#DFT.getOcc-430"><span class="linenos">430</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="DFT.getOcc-431"><a href="#DFT.getOcc-431"><span class="linenos">431</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT.getOcc-432"><a href="#DFT.getOcc-432"><span class="linenos">432</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span></pre></div>


            <div class="docstring"><p>Assign occupation numbers to molecular orbitals based on their energies.</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule
    Molecule object to extract the number of electrons.</p>

<p>energy_mo : ndarray
    Array of MO energies.</p>

<p>coeff_mo : ndarray
    Array of MO coefficients (not used but kept for compatibility).</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Array of MO occupations (0 or 2 for RHF).</p>
</div>


                            </div>
                            <div id="DFT.gen_dm_cupy" class="classattr">
                                        <input id="DFT.gen_dm_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gen_dm_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mo_coeff</span>, </span><span class="param"><span class="n">mo_occ</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.gen_dm_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.gen_dm_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.gen_dm_cupy-434"><a href="#DFT.gen_dm_cupy-434"><span class="linenos">434</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_dm_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">):</span>
</span><span id="DFT.gen_dm_cupy-435"><a href="#DFT.gen_dm_cupy-435"><span class="linenos">435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.gen_dm_cupy-436"><a href="#DFT.gen_dm_cupy-436"><span class="linenos">436</span></a><span class="sd">        Generate the density matrix using CuPy for GPU acceleration.</span>
</span><span id="DFT.gen_dm_cupy-437"><a href="#DFT.gen_dm_cupy-437"><span class="linenos">437</span></a>
</span><span id="DFT.gen_dm_cupy-438"><a href="#DFT.gen_dm_cupy-438"><span class="linenos">438</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.gen_dm_cupy-439"><a href="#DFT.gen_dm_cupy-439"><span class="linenos">439</span></a><span class="sd">        ----------</span>
</span><span id="DFT.gen_dm_cupy-440"><a href="#DFT.gen_dm_cupy-440"><span class="linenos">440</span></a><span class="sd">        mo_coeff : cp.ndarray</span>
</span><span id="DFT.gen_dm_cupy-441"><a href="#DFT.gen_dm_cupy-441"><span class="linenos">441</span></a><span class="sd">            Molecular orbital coefficient matrix (on GPU).</span>
</span><span id="DFT.gen_dm_cupy-442"><a href="#DFT.gen_dm_cupy-442"><span class="linenos">442</span></a>
</span><span id="DFT.gen_dm_cupy-443"><a href="#DFT.gen_dm_cupy-443"><span class="linenos">443</span></a><span class="sd">        mo_occ : cp.ndarray</span>
</span><span id="DFT.gen_dm_cupy-444"><a href="#DFT.gen_dm_cupy-444"><span class="linenos">444</span></a><span class="sd">            Array of MO occupation numbers (on GPU).</span>
</span><span id="DFT.gen_dm_cupy-445"><a href="#DFT.gen_dm_cupy-445"><span class="linenos">445</span></a>
</span><span id="DFT.gen_dm_cupy-446"><a href="#DFT.gen_dm_cupy-446"><span class="linenos">446</span></a><span class="sd">        Returns</span>
</span><span id="DFT.gen_dm_cupy-447"><a href="#DFT.gen_dm_cupy-447"><span class="linenos">447</span></a><span class="sd">        -------</span>
</span><span id="DFT.gen_dm_cupy-448"><a href="#DFT.gen_dm_cupy-448"><span class="linenos">448</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT.gen_dm_cupy-449"><a href="#DFT.gen_dm_cupy-449"><span class="linenos">449</span></a><span class="sd">            Density matrix (RHF/RKS type) computed on the GPU.</span>
</span><span id="DFT.gen_dm_cupy-450"><a href="#DFT.gen_dm_cupy-450"><span class="linenos">450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.gen_dm_cupy-451"><a href="#DFT.gen_dm_cupy-451"><span class="linenos">451</span></a>        <span class="n">mocc</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.gen_dm_cupy-452"><a href="#DFT.gen_dm_cupy-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mocc</span><span class="o">*</span><span class="n">mo_occ</span><span class="p">[</span><span class="n">mo_occ</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">mocc</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate the density matrix using CuPy for GPU acceleration.</p>

<h2 id="parameters">Parameters</h2>

<p>mo_coeff : cp.ndarray
    Molecular orbital coefficient matrix (on GPU).</p>

<p>mo_occ : cp.ndarray
    Array of MO occupation numbers (on GPU).</p>

<h2 id="returns">Returns</h2>

<p>cp.ndarray
    Density matrix (RHF/RKS type) computed on the GPU.</p>
</div>


                            </div>
                            <div id="DFT.getOcc_cupy" class="classattr">
                                        <input id="DFT.getOcc_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getOcc_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mol</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.getOcc_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.getOcc_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.getOcc_cupy-454"><a href="#DFT.getOcc_cupy-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getOcc_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coeff_mo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.getOcc_cupy-455"><a href="#DFT.getOcc_cupy-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.getOcc_cupy-456"><a href="#DFT.getOcc_cupy-456"><span class="linenos">456</span></a><span class="sd">        Assign occupation numbers to MOs using CuPy (for GPU-based calculations).</span>
</span><span id="DFT.getOcc_cupy-457"><a href="#DFT.getOcc_cupy-457"><span class="linenos">457</span></a>
</span><span id="DFT.getOcc_cupy-458"><a href="#DFT.getOcc_cupy-458"><span class="linenos">458</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.getOcc_cupy-459"><a href="#DFT.getOcc_cupy-459"><span class="linenos">459</span></a><span class="sd">        ----------</span>
</span><span id="DFT.getOcc_cupy-460"><a href="#DFT.getOcc_cupy-460"><span class="linenos">460</span></a><span class="sd">        mol : Molecule</span>
</span><span id="DFT.getOcc_cupy-461"><a href="#DFT.getOcc_cupy-461"><span class="linenos">461</span></a><span class="sd">            Molecule object to determine number of electrons.</span>
</span><span id="DFT.getOcc_cupy-462"><a href="#DFT.getOcc_cupy-462"><span class="linenos">462</span></a>
</span><span id="DFT.getOcc_cupy-463"><a href="#DFT.getOcc_cupy-463"><span class="linenos">463</span></a><span class="sd">        energy_mo : cp.ndarray</span>
</span><span id="DFT.getOcc_cupy-464"><a href="#DFT.getOcc_cupy-464"><span class="linenos">464</span></a><span class="sd">            MO energy array on the GPU.</span>
</span><span id="DFT.getOcc_cupy-465"><a href="#DFT.getOcc_cupy-465"><span class="linenos">465</span></a>
</span><span id="DFT.getOcc_cupy-466"><a href="#DFT.getOcc_cupy-466"><span class="linenos">466</span></a><span class="sd">        coeff_mo : cp.ndarray</span>
</span><span id="DFT.getOcc_cupy-467"><a href="#DFT.getOcc_cupy-467"><span class="linenos">467</span></a><span class="sd">            MO coefficients array on the GPU (not used).</span>
</span><span id="DFT.getOcc_cupy-468"><a href="#DFT.getOcc_cupy-468"><span class="linenos">468</span></a>
</span><span id="DFT.getOcc_cupy-469"><a href="#DFT.getOcc_cupy-469"><span class="linenos">469</span></a><span class="sd">        Returns</span>
</span><span id="DFT.getOcc_cupy-470"><a href="#DFT.getOcc_cupy-470"><span class="linenos">470</span></a><span class="sd">        -------</span>
</span><span id="DFT.getOcc_cupy-471"><a href="#DFT.getOcc_cupy-471"><span class="linenos">471</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT.getOcc_cupy-472"><a href="#DFT.getOcc_cupy-472"><span class="linenos">472</span></a><span class="sd">            Array of MO occupations (on GPU).</span>
</span><span id="DFT.getOcc_cupy-473"><a href="#DFT.getOcc_cupy-473"><span class="linenos">473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.getOcc_cupy-474"><a href="#DFT.getOcc_cupy-474"><span class="linenos">474</span></a>        <span class="n">e_idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energy_mo</span><span class="p">)</span>
</span><span id="DFT.getOcc_cupy-475"><a href="#DFT.getOcc_cupy-475"><span class="linenos">475</span></a>        <span class="n">e_sort</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">]</span>
</span><span id="DFT.getOcc_cupy-476"><a href="#DFT.getOcc_cupy-476"><span class="linenos">476</span></a>        <span class="n">nmo</span> <span class="o">=</span> <span class="n">energy_mo</span><span class="o">.</span><span class="n">size</span>
</span><span id="DFT.getOcc_cupy-477"><a href="#DFT.getOcc_cupy-477"><span class="linenos">477</span></a>        <span class="n">occ_mo</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
</span><span id="DFT.getOcc_cupy-478"><a href="#DFT.getOcc_cupy-478"><span class="linenos">478</span></a>        <span class="n">nocc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="DFT.getOcc_cupy-479"><a href="#DFT.getOcc_cupy-479"><span class="linenos">479</span></a>        <span class="n">occ_mo</span><span class="p">[</span><span class="n">e_idx</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT.getOcc_cupy-480"><a href="#DFT.getOcc_cupy-480"><span class="linenos">480</span></a>        <span class="k">return</span> <span class="n">occ_mo</span>
</span></pre></div>


            <div class="docstring"><p>Assign occupation numbers to MOs using CuPy (for GPU-based calculations).</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule
    Molecule object to determine number of electrons.</p>

<p>energy_mo : cp.ndarray
    MO energy array on the GPU.</p>

<p>coeff_mo : cp.ndarray
    MO coefficients array on the GPU (not used).</p>

<h2 id="returns">Returns</h2>

<p>cp.ndarray
    Array of MO occupations (on GPU).</p>
</div>


                            </div>
                            <div id="DFT.solve" class="classattr">
                                        <input id="DFT.solve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">H</span>, </span><span class="param"><span class="n">S</span>, </span><span class="param"><span class="n">orthogonalize</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">x</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.solve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.solve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.solve-482"><a href="#DFT.solve-482"><span class="linenos">482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.solve-483"><a href="#DFT.solve-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.solve-484"><a href="#DFT.solve-484"><span class="linenos">484</span></a><span class="sd">        Solve the generalized or canonical eigenvalue equation.</span>
</span><span id="DFT.solve-485"><a href="#DFT.solve-485"><span class="linenos">485</span></a>
</span><span id="DFT.solve-486"><a href="#DFT.solve-486"><span class="linenos">486</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.solve-487"><a href="#DFT.solve-487"><span class="linenos">487</span></a><span class="sd">        ----------</span>
</span><span id="DFT.solve-488"><a href="#DFT.solve-488"><span class="linenos">488</span></a><span class="sd">        H : ndarray</span>
</span><span id="DFT.solve-489"><a href="#DFT.solve-489"><span class="linenos">489</span></a><span class="sd">            Hamiltonian matrix.</span>
</span><span id="DFT.solve-490"><a href="#DFT.solve-490"><span class="linenos">490</span></a>
</span><span id="DFT.solve-491"><a href="#DFT.solve-491"><span class="linenos">491</span></a><span class="sd">        S : ndarray</span>
</span><span id="DFT.solve-492"><a href="#DFT.solve-492"><span class="linenos">492</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="DFT.solve-493"><a href="#DFT.solve-493"><span class="linenos">493</span></a>
</span><span id="DFT.solve-494"><a href="#DFT.solve-494"><span class="linenos">494</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="DFT.solve-495"><a href="#DFT.solve-495"><span class="linenos">495</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="DFT.solve-496"><a href="#DFT.solve-496"><span class="linenos">496</span></a>
</span><span id="DFT.solve-497"><a href="#DFT.solve-497"><span class="linenos">497</span></a><span class="sd">        x : ndarray, optional</span>
</span><span id="DFT.solve-498"><a href="#DFT.solve-498"><span class="linenos">498</span></a><span class="sd">            Transformation matrix (if already computed).</span>
</span><span id="DFT.solve-499"><a href="#DFT.solve-499"><span class="linenos">499</span></a>
</span><span id="DFT.solve-500"><a href="#DFT.solve-500"><span class="linenos">500</span></a><span class="sd">        Returns</span>
</span><span id="DFT.solve-501"><a href="#DFT.solve-501"><span class="linenos">501</span></a><span class="sd">        -------</span>
</span><span id="DFT.solve-502"><a href="#DFT.solve-502"><span class="linenos">502</span></a><span class="sd">        tuple of (ndarray, ndarray)</span>
</span><span id="DFT.solve-503"><a href="#DFT.solve-503"><span class="linenos">503</span></a><span class="sd">            Eigenvalues and eigenvectors of the system.</span>
</span><span id="DFT.solve-504"><a href="#DFT.solve-504"><span class="linenos">504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.solve-505"><a href="#DFT.solve-505"><span class="linenos">505</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="DFT.solve-506"><a href="#DFT.solve-506"><span class="linenos">506</span></a>            <span class="c1">#Solve the generalized eigenvalue equation HC = SCE</span>
</span><span id="DFT.solve-507"><a href="#DFT.solve-507"><span class="linenos">507</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="DFT.solve-508"><a href="#DFT.solve-508"><span class="linenos">508</span></a>            
</span><span id="DFT.solve-509"><a href="#DFT.solve-509"><span class="linenos">509</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.solve-510"><a href="#DFT.solve-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.solve-511"><a href="#DFT.solve-511"><span class="linenos">511</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT.solve-512"><a href="#DFT.solve-512"><span class="linenos">512</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT.solve-513"><a href="#DFT.solve-513"><span class="linenos">513</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT.solve-514"><a href="#DFT.solve-514"><span class="linenos">514</span></a>            <span class="n">xHx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="DFT.solve-515"><a href="#DFT.solve-515"><span class="linenos">515</span></a>            <span class="c1">#Solve the canonical eigenvalue equation HC = CE</span>
</span><span id="DFT.solve-516"><a href="#DFT.solve-516"><span class="linenos">516</span></a>            <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xHx</span><span class="p">)</span>
</span><span id="DFT.solve-517"><a href="#DFT.solve-517"><span class="linenos">517</span></a>            <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT.solve-518"><a href="#DFT.solve-518"><span class="linenos">518</span></a>
</span><span id="DFT.solve-519"><a href="#DFT.solve-519"><span class="linenos">519</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.solve-520"><a href="#DFT.solve-520"><span class="linenos">520</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT.solve-521"><a href="#DFT.solve-521"><span class="linenos">521</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span></pre></div>


            <div class="docstring"><p>Solve the generalized or canonical eigenvalue equation.</p>

<h2 id="parameters">Parameters</h2>

<p>H : ndarray
    Hamiltonian matrix.</p>

<p>S : ndarray
    Overlap matrix.</p>

<p>orthogonalize : bool, optional
    If True, solve using orthogonalized basis.</p>

<p>x : ndarray, optional
    Transformation matrix (if already computed).</p>

<h2 id="returns">Returns</h2>

<p>tuple of (ndarray, ndarray)
    Eigenvalues and eigenvectors of the system.</p>
</div>


                            </div>
                            <div id="DFT.solve_cupy" class="classattr">
                                        <input id="DFT.solve_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">H</span>, </span><span class="param"><span class="n">S</span>, </span><span class="param"><span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.solve_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.solve_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.solve_cupy-523"><a href="#DFT.solve_cupy-523"><span class="linenos">523</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DFT.solve_cupy-524"><a href="#DFT.solve_cupy-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.solve_cupy-525"><a href="#DFT.solve_cupy-525"><span class="linenos">525</span></a><span class="sd">        Solve the generalized eigenvalue problem using CuPy (GPU).</span>
</span><span id="DFT.solve_cupy-526"><a href="#DFT.solve_cupy-526"><span class="linenos">526</span></a>
</span><span id="DFT.solve_cupy-527"><a href="#DFT.solve_cupy-527"><span class="linenos">527</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.solve_cupy-528"><a href="#DFT.solve_cupy-528"><span class="linenos">528</span></a><span class="sd">        ----------</span>
</span><span id="DFT.solve_cupy-529"><a href="#DFT.solve_cupy-529"><span class="linenos">529</span></a><span class="sd">        H : cp.ndarray</span>
</span><span id="DFT.solve_cupy-530"><a href="#DFT.solve_cupy-530"><span class="linenos">530</span></a><span class="sd">            Hamiltonian matrix (on GPU).</span>
</span><span id="DFT.solve_cupy-531"><a href="#DFT.solve_cupy-531"><span class="linenos">531</span></a>
</span><span id="DFT.solve_cupy-532"><a href="#DFT.solve_cupy-532"><span class="linenos">532</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="DFT.solve_cupy-533"><a href="#DFT.solve_cupy-533"><span class="linenos">533</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="DFT.solve_cupy-534"><a href="#DFT.solve_cupy-534"><span class="linenos">534</span></a>
</span><span id="DFT.solve_cupy-535"><a href="#DFT.solve_cupy-535"><span class="linenos">535</span></a><span class="sd">        orthogonalize : bool, optional</span>
</span><span id="DFT.solve_cupy-536"><a href="#DFT.solve_cupy-536"><span class="linenos">536</span></a><span class="sd">            If True, solve using orthogonalized basis.</span>
</span><span id="DFT.solve_cupy-537"><a href="#DFT.solve_cupy-537"><span class="linenos">537</span></a>
</span><span id="DFT.solve_cupy-538"><a href="#DFT.solve_cupy-538"><span class="linenos">538</span></a><span class="sd">        Returns</span>
</span><span id="DFT.solve_cupy-539"><a href="#DFT.solve_cupy-539"><span class="linenos">539</span></a><span class="sd">        -------</span>
</span><span id="DFT.solve_cupy-540"><a href="#DFT.solve_cupy-540"><span class="linenos">540</span></a><span class="sd">        tuple of (cp.ndarray, cp.ndarray)</span>
</span><span id="DFT.solve_cupy-541"><a href="#DFT.solve_cupy-541"><span class="linenos">541</span></a><span class="sd">            Eigenvalues and eigenvectors (on GPU).</span>
</span><span id="DFT.solve_cupy-542"><a href="#DFT.solve_cupy-542"><span class="linenos">542</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.solve_cupy-543"><a href="#DFT.solve_cupy-543"><span class="linenos">543</span></a>        <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT.solve_cupy-544"><a href="#DFT.solve_cupy-544"><span class="linenos">544</span></a>        <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT.solve_cupy-545"><a href="#DFT.solve_cupy-545"><span class="linenos">545</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT.solve_cupy-546"><a href="#DFT.solve_cupy-546"><span class="linenos">546</span></a>        <span class="n">xhx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">x</span>
</span><span id="DFT.solve_cupy-547"><a href="#DFT.solve_cupy-547"><span class="linenos">547</span></a>        <span class="c1">#Solve the canonical eigenvalue equation HC = SCE</span>
</span><span id="DFT.solve_cupy-548"><a href="#DFT.solve_cupy-548"><span class="linenos">548</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">xhx</span><span class="p">)</span>
</span><span id="DFT.solve_cupy-549"><a href="#DFT.solve_cupy-549"><span class="linenos">549</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT.solve_cupy-550"><a href="#DFT.solve_cupy-550"><span class="linenos">550</span></a>
</span><span id="DFT.solve_cupy-551"><a href="#DFT.solve_cupy-551"><span class="linenos">551</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.solve_cupy-552"><a href="#DFT.solve_cupy-552"><span class="linenos">552</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">cp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT.solve_cupy-553"><a href="#DFT.solve_cupy-553"><span class="linenos">553</span></a>        <span class="k">return</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="c1"># E, C</span>
</span></pre></div>


            <div class="docstring"><p>Solve the generalized eigenvalue problem using CuPy (GPU).</p>

<h2 id="parameters">Parameters</h2>

<p>H : cp.ndarray
    Hamiltonian matrix (on GPU).</p>

<p>S : cp.ndarray
    Overlap matrix (on GPU).</p>

<p>orthogonalize : bool, optional
    If True, solve using orthogonalized basis.</p>

<h2 id="returns">Returns</h2>

<p>tuple of (cp.ndarray, cp.ndarray)
    Eigenvalues and eigenvectors (on GPU).</p>
</div>


                            </div>
                            <div id="DFT.getCoreH" class="classattr">
                                        <input id="DFT.getCoreH-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getCoreH</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mol</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">basis</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.getCoreH-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.getCoreH"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.getCoreH-556"><a href="#DFT.getCoreH-556"><span class="linenos">556</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.getCoreH-557"><a href="#DFT.getCoreH-557"><span class="linenos">557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.getCoreH-558"><a href="#DFT.getCoreH-558"><span class="linenos">558</span></a><span class="sd">        Compute the core Hamiltonian matrix (T + V).</span>
</span><span id="DFT.getCoreH-559"><a href="#DFT.getCoreH-559"><span class="linenos">559</span></a>
</span><span id="DFT.getCoreH-560"><a href="#DFT.getCoreH-560"><span class="linenos">560</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.getCoreH-561"><a href="#DFT.getCoreH-561"><span class="linenos">561</span></a><span class="sd">        ----------</span>
</span><span id="DFT.getCoreH-562"><a href="#DFT.getCoreH-562"><span class="linenos">562</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT.getCoreH-563"><a href="#DFT.getCoreH-563"><span class="linenos">563</span></a><span class="sd">            Molecule object.</span>
</span><span id="DFT.getCoreH-564"><a href="#DFT.getCoreH-564"><span class="linenos">564</span></a>
</span><span id="DFT.getCoreH-565"><a href="#DFT.getCoreH-565"><span class="linenos">565</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="DFT.getCoreH-566"><a href="#DFT.getCoreH-566"><span class="linenos">566</span></a><span class="sd">            Basis set object.</span>
</span><span id="DFT.getCoreH-567"><a href="#DFT.getCoreH-567"><span class="linenos">567</span></a>
</span><span id="DFT.getCoreH-568"><a href="#DFT.getCoreH-568"><span class="linenos">568</span></a><span class="sd">        Returns</span>
</span><span id="DFT.getCoreH-569"><a href="#DFT.getCoreH-569"><span class="linenos">569</span></a><span class="sd">        -------</span>
</span><span id="DFT.getCoreH-570"><a href="#DFT.getCoreH-570"><span class="linenos">570</span></a><span class="sd">        ndarray</span>
</span><span id="DFT.getCoreH-571"><a href="#DFT.getCoreH-571"><span class="linenos">571</span></a><span class="sd">            Core Hamiltonian matrix.</span>
</span><span id="DFT.getCoreH-572"><a href="#DFT.getCoreH-572"><span class="linenos">572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.getCoreH-573"><a href="#DFT.getCoreH-573"><span class="linenos">573</span></a>        <span class="c1">#Get the core Hamiltonian</span>
</span><span id="DFT.getCoreH-574"><a href="#DFT.getCoreH-574"><span class="linenos">574</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.getCoreH-575"><a href="#DFT.getCoreH-575"><span class="linenos">575</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT.getCoreH-576"><a href="#DFT.getCoreH-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.getCoreH-577"><a href="#DFT.getCoreH-577"><span class="linenos">577</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT.getCoreH-578"><a href="#DFT.getCoreH-578"><span class="linenos">578</span></a>        <span class="n">nao</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span> 
</span><span id="DFT.getCoreH-579"><a href="#DFT.getCoreH-579"><span class="linenos">579</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
</span><span id="DFT.getCoreH-580"><a href="#DFT.getCoreH-580"><span class="linenos">580</span></a>        <span class="n">Vmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="DFT.getCoreH-581"><a href="#DFT.getCoreH-581"><span class="linenos">581</span></a>        <span class="n">Tmat</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.getCoreH-582"><a href="#DFT.getCoreH-582"><span class="linenos">582</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">Vmat</span> <span class="o">+</span> <span class="n">Tmat</span>
</span><span id="DFT.getCoreH-583"><a href="#DFT.getCoreH-583"><span class="linenos">583</span></a>
</span><span id="DFT.getCoreH-584"><a href="#DFT.getCoreH-584"><span class="linenos">584</span></a>        <span class="k">return</span> <span class="n">H</span>
</span></pre></div>


            <div class="docstring"><p>Compute the core Hamiltonian matrix (T + V).</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule, optional
    Molecule object.</p>

<p>basis : Basis, optional
    Basis set object.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Core Hamiltonian matrix.</p>
</div>


                            </div>
                            <div id="DFT.guessCoreH" class="classattr">
                                        <input id="DFT.guessCoreH-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">guessCoreH</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mol</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">basis</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">Hcore</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">S</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.guessCoreH-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.guessCoreH"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.guessCoreH-587"><a href="#DFT.guessCoreH-587"><span class="linenos">587</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">guessCoreH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DFT.guessCoreH-588"><a href="#DFT.guessCoreH-588"><span class="linenos">588</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.guessCoreH-589"><a href="#DFT.guessCoreH-589"><span class="linenos">589</span></a><span class="sd">        Generate a guess density matrix using the core Hamiltonian.</span>
</span><span id="DFT.guessCoreH-590"><a href="#DFT.guessCoreH-590"><span class="linenos">590</span></a>
</span><span id="DFT.guessCoreH-591"><a href="#DFT.guessCoreH-591"><span class="linenos">591</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.guessCoreH-592"><a href="#DFT.guessCoreH-592"><span class="linenos">592</span></a><span class="sd">        ----------</span>
</span><span id="DFT.guessCoreH-593"><a href="#DFT.guessCoreH-593"><span class="linenos">593</span></a><span class="sd">        mol : Molecule, optional</span>
</span><span id="DFT.guessCoreH-594"><a href="#DFT.guessCoreH-594"><span class="linenos">594</span></a><span class="sd">            Molecule object.</span>
</span><span id="DFT.guessCoreH-595"><a href="#DFT.guessCoreH-595"><span class="linenos">595</span></a>
</span><span id="DFT.guessCoreH-596"><a href="#DFT.guessCoreH-596"><span class="linenos">596</span></a><span class="sd">        basis : Basis, optional</span>
</span><span id="DFT.guessCoreH-597"><a href="#DFT.guessCoreH-597"><span class="linenos">597</span></a><span class="sd">            Basis set.</span>
</span><span id="DFT.guessCoreH-598"><a href="#DFT.guessCoreH-598"><span class="linenos">598</span></a>
</span><span id="DFT.guessCoreH-599"><a href="#DFT.guessCoreH-599"><span class="linenos">599</span></a><span class="sd">        Hcore : ndarray, optional</span>
</span><span id="DFT.guessCoreH-600"><a href="#DFT.guessCoreH-600"><span class="linenos">600</span></a><span class="sd">            Core Hamiltonian. If None, it will be computed.</span>
</span><span id="DFT.guessCoreH-601"><a href="#DFT.guessCoreH-601"><span class="linenos">601</span></a>
</span><span id="DFT.guessCoreH-602"><a href="#DFT.guessCoreH-602"><span class="linenos">602</span></a><span class="sd">        S : ndarray, optional</span>
</span><span id="DFT.guessCoreH-603"><a href="#DFT.guessCoreH-603"><span class="linenos">603</span></a><span class="sd">            Overlap matrix. If None, it will be computed.</span>
</span><span id="DFT.guessCoreH-604"><a href="#DFT.guessCoreH-604"><span class="linenos">604</span></a>
</span><span id="DFT.guessCoreH-605"><a href="#DFT.guessCoreH-605"><span class="linenos">605</span></a><span class="sd">        Returns</span>
</span><span id="DFT.guessCoreH-606"><a href="#DFT.guessCoreH-606"><span class="linenos">606</span></a><span class="sd">        -------</span>
</span><span id="DFT.guessCoreH-607"><a href="#DFT.guessCoreH-607"><span class="linenos">607</span></a><span class="sd">        ndarray</span>
</span><span id="DFT.guessCoreH-608"><a href="#DFT.guessCoreH-608"><span class="linenos">608</span></a><span class="sd">            Initial guess density matrix.</span>
</span><span id="DFT.guessCoreH-609"><a href="#DFT.guessCoreH-609"><span class="linenos">609</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.guessCoreH-610"><a href="#DFT.guessCoreH-610"><span class="linenos">610</span></a>        <span class="c1">#Get a guess for the density matrix using the core Hamiltonian</span>
</span><span id="DFT.guessCoreH-611"><a href="#DFT.guessCoreH-611"><span class="linenos">611</span></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.guessCoreH-612"><a href="#DFT.guessCoreH-612"><span class="linenos">612</span></a>            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT.guessCoreH-613"><a href="#DFT.guessCoreH-613"><span class="linenos">613</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.guessCoreH-614"><a href="#DFT.guessCoreH-614"><span class="linenos">614</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT.guessCoreH-615"><a href="#DFT.guessCoreH-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="n">Hcore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.guessCoreH-616"><a href="#DFT.guessCoreH-616"><span class="linenos">616</span></a>            <span class="n">Hcore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-617"><a href="#DFT.guessCoreH-617"><span class="linenos">617</span></a>        <span class="k">if</span> <span class="n">S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.guessCoreH-618"><a href="#DFT.guessCoreH-618"><span class="linenos">618</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-619"><a href="#DFT.guessCoreH-619"><span class="linenos">619</span></a>
</span><span id="DFT.guessCoreH-620"><a href="#DFT.guessCoreH-620"><span class="linenos">620</span></a>        <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hcore</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-621"><a href="#DFT.guessCoreH-621"><span class="linenos">621</span></a>        <span class="c1"># print(eigvalues)</span>
</span><span id="DFT.guessCoreH-622"><a href="#DFT.guessCoreH-622"><span class="linenos">622</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigvectors</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-623"><a href="#DFT.guessCoreH-623"><span class="linenos">623</span></a>        <span class="n">eigvectors</span><span class="p">[:,</span><span class="n">eigvectors</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvalues</span><span class="p">))]</span><span class="o">.</span><span class="n">real</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="DFT.guessCoreH-624"><a href="#DFT.guessCoreH-624"><span class="linenos">624</span></a>        <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-625"><a href="#DFT.guessCoreH-625"><span class="linenos">625</span></a>        <span class="c1"># print(mo_occ)</span>
</span><span id="DFT.guessCoreH-626"><a href="#DFT.guessCoreH-626"><span class="linenos">626</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT.guessCoreH-627"><a href="#DFT.guessCoreH-627"><span class="linenos">627</span></a>
</span><span id="DFT.guessCoreH-628"><a href="#DFT.guessCoreH-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="n">dmat</span>
</span></pre></div>


            <div class="docstring"><p>Generate a guess density matrix using the core Hamiltonian.</p>

<h2 id="parameters">Parameters</h2>

<p>mol : Molecule, optional
    Molecule object.</p>

<p>basis : Basis, optional
    Basis set.</p>

<p>Hcore : ndarray, optional
    Core Hamiltonian. If None, it will be computed.</p>

<p>S : ndarray, optional
    Overlap matrix. If None, it will be computed.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Initial guess density matrix.</p>
</div>


                            </div>
                            <div id="DFT.DIIS" class="classattr">
                                        <input id="DFT.DIIS-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DIIS</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">S</span>, </span><span class="param"><span class="n">D</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.DIIS-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.DIIS"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.DIIS-631"><a href="#DFT.DIIS-631"><span class="linenos">631</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="DFT.DIIS-632"><a href="#DFT.DIIS-632"><span class="linenos">632</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.DIIS-633"><a href="#DFT.DIIS-633"><span class="linenos">633</span></a><span class="sd">        Perform Direct Inversion in the Iterative Subspace (DIIS) to improve SCF convergence.</span>
</span><span id="DFT.DIIS-634"><a href="#DFT.DIIS-634"><span class="linenos">634</span></a>
</span><span id="DFT.DIIS-635"><a href="#DFT.DIIS-635"><span class="linenos">635</span></a><span class="sd">        Adapted from</span>
</span><span id="DFT.DIIS-636"><a href="#DFT.DIIS-636"><span class="linenos">636</span></a><span class="sd">        ----------</span>
</span><span id="DFT.DIIS-637"><a href="#DFT.DIIS-637"><span class="linenos">637</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="DFT.DIIS-638"><a href="#DFT.DIIS-638"><span class="linenos">638</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="DFT.DIIS-639"><a href="#DFT.DIIS-639"><span class="linenos">639</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="DFT.DIIS-640"><a href="#DFT.DIIS-640"><span class="linenos">640</span></a>
</span><span id="DFT.DIIS-641"><a href="#DFT.DIIS-641"><span class="linenos">641</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.DIIS-642"><a href="#DFT.DIIS-642"><span class="linenos">642</span></a><span class="sd">        ----------</span>
</span><span id="DFT.DIIS-643"><a href="#DFT.DIIS-643"><span class="linenos">643</span></a><span class="sd">        S : ndarray</span>
</span><span id="DFT.DIIS-644"><a href="#DFT.DIIS-644"><span class="linenos">644</span></a><span class="sd">            Overlap matrix.</span>
</span><span id="DFT.DIIS-645"><a href="#DFT.DIIS-645"><span class="linenos">645</span></a>
</span><span id="DFT.DIIS-646"><a href="#DFT.DIIS-646"><span class="linenos">646</span></a><span class="sd">        D : ndarray</span>
</span><span id="DFT.DIIS-647"><a href="#DFT.DIIS-647"><span class="linenos">647</span></a><span class="sd">            Density matrix.</span>
</span><span id="DFT.DIIS-648"><a href="#DFT.DIIS-648"><span class="linenos">648</span></a>
</span><span id="DFT.DIIS-649"><a href="#DFT.DIIS-649"><span class="linenos">649</span></a><span class="sd">        F : ndarray</span>
</span><span id="DFT.DIIS-650"><a href="#DFT.DIIS-650"><span class="linenos">650</span></a><span class="sd">            Fock matrix.</span>
</span><span id="DFT.DIIS-651"><a href="#DFT.DIIS-651"><span class="linenos">651</span></a>
</span><span id="DFT.DIIS-652"><a href="#DFT.DIIS-652"><span class="linenos">652</span></a><span class="sd">        Returns</span>
</span><span id="DFT.DIIS-653"><a href="#DFT.DIIS-653"><span class="linenos">653</span></a><span class="sd">        -------</span>
</span><span id="DFT.DIIS-654"><a href="#DFT.DIIS-654"><span class="linenos">654</span></a><span class="sd">        ndarray</span>
</span><span id="DFT.DIIS-655"><a href="#DFT.DIIS-655"><span class="linenos">655</span></a><span class="sd">            DIIS-extrapolated Fock matrix.</span>
</span><span id="DFT.DIIS-656"><a href="#DFT.DIIS-656"><span class="linenos">656</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.DIIS-657"><a href="#DFT.DIIS-657"><span class="linenos">657</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">dot</span><span class="p">([</span><span class="n">F</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">S</span><span class="p">])</span>
</span><span id="DFT.DIIS-658"><a href="#DFT.DIIS-658"><span class="linenos">658</span></a>        <span class="c1"># SDF =   np.conjugate(FDS).T </span>
</span><span id="DFT.DIIS-659"><a href="#DFT.DIIS-659"><span class="linenos">659</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="DFT.DIIS-660"><a href="#DFT.DIIS-660"><span class="linenos">660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="DFT.DIIS-661"><a href="#DFT.DIIS-661"><span class="linenos">661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="DFT.DIIS-662"><a href="#DFT.DIIS-662"><span class="linenos">662</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="DFT.DIIS-663"><a href="#DFT.DIIS-663"><span class="linenos">663</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="DFT.DIIS-664"><a href="#DFT.DIIS-664"><span class="linenos">664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="DFT.DIIS-665"><a href="#DFT.DIIS-665"><span class="linenos">665</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.DIIS-666"><a href="#DFT.DIIS-666"><span class="linenos">666</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="DFT.DIIS-667"><a href="#DFT.DIIS-667"><span class="linenos">667</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="DFT.DIIS-668"><a href="#DFT.DIIS-668"><span class="linenos">668</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT.DIIS-669"><a href="#DFT.DIIS-669"><span class="linenos">669</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.DIIS-670"><a href="#DFT.DIIS-670"><span class="linenos">670</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="DFT.DIIS-671"><a href="#DFT.DIIS-671"><span class="linenos">671</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="DFT.DIIS-672"><a href="#DFT.DIIS-672"><span class="linenos">672</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.DIIS-673"><a href="#DFT.DIIS-673"><span class="linenos">673</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="DFT.DIIS-674"><a href="#DFT.DIIS-674"><span class="linenos">674</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="DFT.DIIS-675"><a href="#DFT.DIIS-675"><span class="linenos">675</span></a>        <span class="c1"># for i in range(nKS):</span>
</span><span id="DFT.DIIS-676"><a href="#DFT.DIIS-676"><span class="linenos">676</span></a>        <span class="c1">#     for j in range(i+1):</span>
</span><span id="DFT.DIIS-677"><a href="#DFT.DIIS-677"><span class="linenos">677</span></a>        <span class="c1">#         print(self.errVecs[i].shape)</span>
</span><span id="DFT.DIIS-678"><a href="#DFT.DIIS-678"><span class="linenos">678</span></a>        <span class="c1">#         B[i,j] = np.real(np.dot(np.conjugate(self.errVecs[i]).T, self.errVecs[j]))</span>
</span><span id="DFT.DIIS-679"><a href="#DFT.DIIS-679"><span class="linenos">679</span></a>        <span class="c1">#         B[j,i] = B[i,j]</span>
</span><span id="DFT.DIIS-680"><a href="#DFT.DIIS-680"><span class="linenos">680</span></a>                                                    
</span><span id="DFT.DIIS-681"><a href="#DFT.DIIS-681"><span class="linenos">681</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="DFT.DIIS-682"><a href="#DFT.DIIS-682"><span class="linenos">682</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT.DIIS-683"><a href="#DFT.DIIS-683"><span class="linenos">683</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="DFT.DIIS-684"><a href="#DFT.DIIS-684"><span class="linenos">684</span></a>
</span><span id="DFT.DIIS-685"><a href="#DFT.DIIS-685"><span class="linenos">685</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="DFT.DIIS-686"><a href="#DFT.DIIS-686"><span class="linenos">686</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="DFT.DIIS-687"><a href="#DFT.DIIS-687"><span class="linenos">687</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="DFT.DIIS-688"><a href="#DFT.DIIS-688"><span class="linenos">688</span></a>
</span><span id="DFT.DIIS-689"><a href="#DFT.DIIS-689"><span class="linenos">689</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="DFT.DIIS-690"><a href="#DFT.DIIS-690"><span class="linenos">690</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="DFT.DIIS-691"><a href="#DFT.DIIS-691"><span class="linenos">691</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="DFT.DIIS-692"><a href="#DFT.DIIS-692"><span class="linenos">692</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;(weight * KS)&#39;</span><span class="p">)</span>
</span><span id="DFT.DIIS-693"><a href="#DFT.DIIS-693"><span class="linenos">693</span></a>
</span><span id="DFT.DIIS-694"><a href="#DFT.DIIS-694"><span class="linenos">694</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span></pre></div>


            <div class="docstring"><p>Perform Direct Inversion in the Iterative Subspace (DIIS) to improve SCF convergence.</p>

<h2 id="adapted-from">Adapted from</h2>

<p>McMurchie-Davidson project:
<a href="https://github.com/jjgoings/McMurchie-Davidson">https://github.com/jjgoings/McMurchie-Davidson</a>
Licensed under the BSD-3-Clause license</p>

<h2 id="parameters">Parameters</h2>

<p>S : ndarray
    Overlap matrix.</p>

<p>D : ndarray
    Density matrix.</p>

<p>F : ndarray
    Fock matrix.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    DIIS-extrapolated Fock matrix.</p>
</div>


                            </div>
                            <div id="DFT.DIIS_cupy" class="classattr">
                                        <input id="DFT.DIIS_cupy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DIIS_cupy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">S</span>, </span><span class="param"><span class="n">D</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.DIIS_cupy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.DIIS_cupy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.DIIS_cupy-696"><a href="#DFT.DIIS_cupy-696"><span class="linenos">696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">DIIS_cupy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
</span><span id="DFT.DIIS_cupy-697"><a href="#DFT.DIIS_cupy-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.DIIS_cupy-698"><a href="#DFT.DIIS_cupy-698"><span class="linenos">698</span></a><span class="sd">        Perform DIIS on GPU using CuPy to accelerate SCF convergence.</span>
</span><span id="DFT.DIIS_cupy-699"><a href="#DFT.DIIS_cupy-699"><span class="linenos">699</span></a>
</span><span id="DFT.DIIS_cupy-700"><a href="#DFT.DIIS_cupy-700"><span class="linenos">700</span></a><span class="sd">        Adapted from</span>
</span><span id="DFT.DIIS_cupy-701"><a href="#DFT.DIIS_cupy-701"><span class="linenos">701</span></a><span class="sd">        ----------</span>
</span><span id="DFT.DIIS_cupy-702"><a href="#DFT.DIIS_cupy-702"><span class="linenos">702</span></a><span class="sd">        McMurchie-Davidson project:</span>
</span><span id="DFT.DIIS_cupy-703"><a href="#DFT.DIIS_cupy-703"><span class="linenos">703</span></a><span class="sd">        https://github.com/jjgoings/McMurchie-Davidson</span>
</span><span id="DFT.DIIS_cupy-704"><a href="#DFT.DIIS_cupy-704"><span class="linenos">704</span></a><span class="sd">        Licensed under the BSD-3-Clause license</span>
</span><span id="DFT.DIIS_cupy-705"><a href="#DFT.DIIS_cupy-705"><span class="linenos">705</span></a>
</span><span id="DFT.DIIS_cupy-706"><a href="#DFT.DIIS_cupy-706"><span class="linenos">706</span></a><span class="sd">        Parameters</span>
</span><span id="DFT.DIIS_cupy-707"><a href="#DFT.DIIS_cupy-707"><span class="linenos">707</span></a><span class="sd">        ----------</span>
</span><span id="DFT.DIIS_cupy-708"><a href="#DFT.DIIS_cupy-708"><span class="linenos">708</span></a><span class="sd">        S : cp.ndarray</span>
</span><span id="DFT.DIIS_cupy-709"><a href="#DFT.DIIS_cupy-709"><span class="linenos">709</span></a><span class="sd">            Overlap matrix (on GPU).</span>
</span><span id="DFT.DIIS_cupy-710"><a href="#DFT.DIIS_cupy-710"><span class="linenos">710</span></a>
</span><span id="DFT.DIIS_cupy-711"><a href="#DFT.DIIS_cupy-711"><span class="linenos">711</span></a><span class="sd">        D : cp.ndarray</span>
</span><span id="DFT.DIIS_cupy-712"><a href="#DFT.DIIS_cupy-712"><span class="linenos">712</span></a><span class="sd">            Density matrix (on GPU).</span>
</span><span id="DFT.DIIS_cupy-713"><a href="#DFT.DIIS_cupy-713"><span class="linenos">713</span></a>
</span><span id="DFT.DIIS_cupy-714"><a href="#DFT.DIIS_cupy-714"><span class="linenos">714</span></a><span class="sd">        F : cp.ndarray</span>
</span><span id="DFT.DIIS_cupy-715"><a href="#DFT.DIIS_cupy-715"><span class="linenos">715</span></a><span class="sd">            Fock matrix (on GPU).</span>
</span><span id="DFT.DIIS_cupy-716"><a href="#DFT.DIIS_cupy-716"><span class="linenos">716</span></a>
</span><span id="DFT.DIIS_cupy-717"><a href="#DFT.DIIS_cupy-717"><span class="linenos">717</span></a><span class="sd">        Returns</span>
</span><span id="DFT.DIIS_cupy-718"><a href="#DFT.DIIS_cupy-718"><span class="linenos">718</span></a><span class="sd">        -------</span>
</span><span id="DFT.DIIS_cupy-719"><a href="#DFT.DIIS_cupy-719"><span class="linenos">719</span></a><span class="sd">        cp.ndarray</span>
</span><span id="DFT.DIIS_cupy-720"><a href="#DFT.DIIS_cupy-720"><span class="linenos">720</span></a><span class="sd">            DIIS-extrapolated Fock matrix (on GPU).</span>
</span><span id="DFT.DIIS_cupy-721"><a href="#DFT.DIIS_cupy-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.DIIS_cupy-722"><a href="#DFT.DIIS_cupy-722"><span class="linenos">722</span></a>        <span class="n">FDS</span> <span class="o">=</span>   <span class="n">F</span> <span class="o">@</span> <span class="n">D</span> <span class="o">@</span> <span class="n">S</span>
</span><span id="DFT.DIIS_cupy-723"><a href="#DFT.DIIS_cupy-723"><span class="linenos">723</span></a>        <span class="n">errVec</span> <span class="o">=</span> <span class="n">FDS</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">FDS</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
</span><span id="DFT.DIIS_cupy-724"><a href="#DFT.DIIS_cupy-724"><span class="linenos">724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-725"><a href="#DFT.DIIS_cupy-725"><span class="linenos">725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errVec</span><span class="p">)</span> 
</span><span id="DFT.DIIS_cupy-726"><a href="#DFT.DIIS_cupy-726"><span class="linenos">726</span></a>        <span class="n">nKS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-727"><a href="#DFT.DIIS_cupy-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="n">nKS</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diisSpace</span><span class="p">:</span>
</span><span id="DFT.DIIS_cupy-728"><a href="#DFT.DIIS_cupy-728"><span class="linenos">728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span><span id="DFT.DIIS_cupy-729"><a href="#DFT.DIIS_cupy-729"><span class="linenos">729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-730"><a href="#DFT.DIIS_cupy-730"><span class="linenos">730</span></a>            <span class="n">nKS</span> <span class="o">=</span> <span class="n">nKS</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="DFT.DIIS_cupy-731"><a href="#DFT.DIIS_cupy-731"><span class="linenos">731</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
</span><span id="DFT.DIIS_cupy-732"><a href="#DFT.DIIS_cupy-732"><span class="linenos">732</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT.DIIS_cupy-733"><a href="#DFT.DIIS_cupy-733"><span class="linenos">733</span></a>        <span class="n">B</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.DIIS_cupy-734"><a href="#DFT.DIIS_cupy-734"><span class="linenos">734</span></a>        <span class="c1"># B is symmetric</span>
</span><span id="DFT.DIIS_cupy-735"><a href="#DFT.DIIS_cupy-735"><span class="linenos">735</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nKS</span><span class="p">):</span>
</span><span id="DFT.DIIS_cupy-736"><a href="#DFT.DIIS_cupy-736"><span class="linenos">736</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.DIIS_cupy-737"><a href="#DFT.DIIS_cupy-737"><span class="linenos">737</span></a>                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="DFT.DIIS_cupy-738"><a href="#DFT.DIIS_cupy-738"><span class="linenos">738</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errVecs</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="DFT.DIIS_cupy-739"><a href="#DFT.DIIS_cupy-739"><span class="linenos">739</span></a>                                                    
</span><span id="DFT.DIIS_cupy-740"><a href="#DFT.DIIS_cupy-740"><span class="linenos">740</span></a>        <span class="n">residual</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nKS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="DFT.DIIS_cupy-741"><a href="#DFT.DIIS_cupy-741"><span class="linenos">741</span></a>        <span class="n">residual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="DFT.DIIS_cupy-742"><a href="#DFT.DIIS_cupy-742"><span class="linenos">742</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-743"><a href="#DFT.DIIS_cupy-743"><span class="linenos">743</span></a>
</span><span id="DFT.DIIS_cupy-744"><a href="#DFT.DIIS_cupy-744"><span class="linenos">744</span></a>        <span class="c1"># weights is 1 x numFock + 1, but first numFock values</span>
</span><span id="DFT.DIIS_cupy-745"><a href="#DFT.DIIS_cupy-745"><span class="linenos">745</span></a>        <span class="c1"># should sum to one if we are doing DIIS correctly</span>
</span><span id="DFT.DIIS_cupy-746"><a href="#DFT.DIIS_cupy-746"><span class="linenos">746</span></a>        <span class="k">assert</span> <span class="n">cp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-747"><a href="#DFT.DIIS_cupy-747"><span class="linenos">747</span></a>
</span><span id="DFT.DIIS_cupy-748"><a href="#DFT.DIIS_cupy-748"><span class="linenos">748</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="DFT.DIIS_cupy-749"><a href="#DFT.DIIS_cupy-749"><span class="linenos">749</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">KS</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KSmats</span><span class="p">):</span>
</span><span id="DFT.DIIS_cupy-750"><a href="#DFT.DIIS_cupy-750"><span class="linenos">750</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="DFT.DIIS_cupy-751"><a href="#DFT.DIIS_cupy-751"><span class="linenos">751</span></a>            <span class="n">F</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">KS</span>
</span><span id="DFT.DIIS_cupy-752"><a href="#DFT.DIIS_cupy-752"><span class="linenos">752</span></a>
</span><span id="DFT.DIIS_cupy-753"><a href="#DFT.DIIS_cupy-753"><span class="linenos">753</span></a>        <span class="k">return</span> <span class="n">F</span> 
</span></pre></div>


            <div class="docstring"><p>Perform DIIS on GPU using CuPy to accelerate SCF convergence.</p>

<h2 id="adapted-from">Adapted from</h2>

<p>McMurchie-Davidson project:
<a href="https://github.com/jjgoings/McMurchie-Davidson">https://github.com/jjgoings/McMurchie-Davidson</a>
Licensed under the BSD-3-Clause license</p>

<h2 id="parameters">Parameters</h2>

<p>S : cp.ndarray
    Overlap matrix (on GPU).</p>

<p>D : cp.ndarray
    Density matrix (on GPU).</p>

<p>F : cp.ndarray
    Fock matrix (on GPU).</p>

<h2 id="returns">Returns</h2>

<p>cp.ndarray
    DIIS-extrapolated Fock matrix (on GPU).</p>
</div>


                            </div>
                            <div id="DFT.scf" class="classattr">
                                        <input id="DFT.scf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">scf</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DFT.scf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DFT.scf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DFT.scf-756"><a href="#DFT.scf-756"><span class="linenos"> 756</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DFT.scf-757"><a href="#DFT.scf-757"><span class="linenos"> 757</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DFT.scf-758"><a href="#DFT.scf-758"><span class="linenos"> 758</span></a><span class="sd">        Perform Self-Consistent Field (SCF) calculation for Density Functional Theory (DFT).</span>
</span><span id="DFT.scf-759"><a href="#DFT.scf-759"><span class="linenos"> 759</span></a><span class="sd">        </span>
</span><span id="DFT.scf-760"><a href="#DFT.scf-760"><span class="linenos"> 760</span></a><span class="sd">        This method implements a complete DFT SCF procedure including:</span>
</span><span id="DFT.scf-761"><a href="#DFT.scf-761"><span class="linenos"> 761</span></a><span class="sd">        - One-electron integral calculation (overlap, kinetic, nuclear attraction)</span>
</span><span id="DFT.scf-762"><a href="#DFT.scf-762"><span class="linenos"> 762</span></a><span class="sd">        - Two-electron integral calculation (4-center ERIs or density fitting)</span>
</span><span id="DFT.scf-763"><a href="#DFT.scf-763"><span class="linenos"> 763</span></a><span class="sd">        - Grid generation and pruning for exchange-correlation evaluation</span>
</span><span id="DFT.scf-764"><a href="#DFT.scf-764"><span class="linenos"> 764</span></a><span class="sd">        - Iterative SCF cycles with DIIS convergence acceleration</span>
</span><span id="DFT.scf-765"><a href="#DFT.scf-765"><span class="linenos"> 765</span></a><span class="sd">        - Exchange-correlation energy and potential evaluation using LibXC</span>
</span><span id="DFT.scf-766"><a href="#DFT.scf-766"><span class="linenos"> 766</span></a><span class="sd">        - GPU acceleration support for performance-critical operations</span>
</span><span id="DFT.scf-767"><a href="#DFT.scf-767"><span class="linenos"> 767</span></a><span class="sd">        </span>
</span><span id="DFT.scf-768"><a href="#DFT.scf-768"><span class="linenos"> 768</span></a><span class="sd">        The implementation supports multiple algorithmic variants:</span>
</span><span id="DFT.scf-769"><a href="#DFT.scf-769"><span class="linenos"> 769</span></a><span class="sd">        - Density fitting (DF)</span>
</span><span id="DFT.scf-770"><a href="#DFT.scf-770"><span class="linenos"> 770</span></a><span class="sd">        - Schwarz screening for integral sparsity</span>
</span><span id="DFT.scf-771"><a href="#DFT.scf-771"><span class="linenos"> 771</span></a><span class="sd">        - Multiple XC evaluation algorithms (CPU/GPU optimized)</span>
</span><span id="DFT.scf-772"><a href="#DFT.scf-772"><span class="linenos"> 772</span></a><span class="sd">        - Dynamic precision switching for GPU calculations</span>
</span><span id="DFT.scf-773"><a href="#DFT.scf-773"><span class="linenos"> 773</span></a><span class="sd">        </span>
</span><span id="DFT.scf-774"><a href="#DFT.scf-774"><span class="linenos"> 774</span></a><span class="sd">        SCF Procedure:</span>
</span><span id="DFT.scf-775"><a href="#DFT.scf-775"><span class="linenos"> 775</span></a><span class="sd">        1. Initialize one-electron integrals (S, T, V_nuc)</span>
</span><span id="DFT.scf-776"><a href="#DFT.scf-776"><span class="linenos"> 776</span></a><span class="sd">        2. Calculate/prepare two-electron integrals with optional screening</span>
</span><span id="DFT.scf-777"><a href="#DFT.scf-777"><span class="linenos"> 777</span></a><span class="sd">        3. Generate and prune integration grids for XC evaluation</span>
</span><span id="DFT.scf-778"><a href="#DFT.scf-778"><span class="linenos"> 778</span></a><span class="sd">        4. Iterative SCF loop:</span>
</span><span id="DFT.scf-779"><a href="#DFT.scf-779"><span class="linenos"> 779</span></a><span class="sd">        - Build Coulomb matrix J from density matrix</span>
</span><span id="DFT.scf-780"><a href="#DFT.scf-780"><span class="linenos"> 780</span></a><span class="sd">        - Evaluate exchange-correlation energy/potential on grids</span>
</span><span id="DFT.scf-781"><a href="#DFT.scf-781"><span class="linenos"> 781</span></a><span class="sd">        - Form Kohn-Sham matrix: H_KS = H_core + J + V_xc</span>
</span><span id="DFT.scf-782"><a href="#DFT.scf-782"><span class="linenos"> 782</span></a><span class="sd">        - Apply DIIS convergence acceleration</span>
</span><span id="DFT.scf-783"><a href="#DFT.scf-783"><span class="linenos"> 783</span></a><span class="sd">        - Diagonalize KS matrix to get new orbitals</span>
</span><span id="DFT.scf-784"><a href="#DFT.scf-784"><span class="linenos"> 784</span></a><span class="sd">        - Generate new density matrix from occupied orbitals</span>
</span><span id="DFT.scf-785"><a href="#DFT.scf-785"><span class="linenos"> 785</span></a><span class="sd">        - Check energy convergence</span>
</span><span id="DFT.scf-786"><a href="#DFT.scf-786"><span class="linenos"> 786</span></a><span class="sd">        5. Return converged total energy and density matrix</span>
</span><span id="DFT.scf-787"><a href="#DFT.scf-787"><span class="linenos"> 787</span></a><span class="sd">        </span>
</span><span id="DFT.scf-788"><a href="#DFT.scf-788"><span class="linenos"> 788</span></a><span class="sd">        Computational Features:</span>
</span><span id="DFT.scf-789"><a href="#DFT.scf-789"><span class="linenos"> 789</span></a><span class="sd">        - Multi-threading support via Numba and configurable core count</span>
</span><span id="DFT.scf-790"><a href="#DFT.scf-790"><span class="linenos"> 790</span></a><span class="sd">        - GPU acceleration using CuPy for grid-based operations</span>
</span><span id="DFT.scf-791"><a href="#DFT.scf-791"><span class="linenos"> 791</span></a><span class="sd">        - Memory-efficient batched evaluation of XC terms</span>
</span><span id="DFT.scf-792"><a href="#DFT.scf-792"><span class="linenos"> 792</span></a><span class="sd">        - Multiple density fitting algorithms (DF_algo 1-10)</span>
</span><span id="DFT.scf-793"><a href="#DFT.scf-793"><span class="linenos"> 793</span></a><span class="sd">        - Basis function screening for XC evaluation efficiency</span>
</span><span id="DFT.scf-794"><a href="#DFT.scf-794"><span class="linenos"> 794</span></a><span class="sd">        - Optional Cholesky decomposition for 2-center integrals</span>
</span><span id="DFT.scf-795"><a href="#DFT.scf-795"><span class="linenos"> 795</span></a><span class="sd">        </span>
</span><span id="DFT.scf-796"><a href="#DFT.scf-796"><span class="linenos"> 796</span></a><span class="sd">        Returns:</span>
</span><span id="DFT.scf-797"><a href="#DFT.scf-797"><span class="linenos"> 797</span></a><span class="sd">        --------</span>
</span><span id="DFT.scf-798"><a href="#DFT.scf-798"><span class="linenos"> 798</span></a><span class="sd">        tuple[float, numpy.ndarray]</span>
</span><span id="DFT.scf-799"><a href="#DFT.scf-799"><span class="linenos"> 799</span></a><span class="sd">            Etot : float</span>
</span><span id="DFT.scf-800"><a href="#DFT.scf-800"><span class="linenos"> 800</span></a><span class="sd">                Converged total electronic energy in atomic units</span>
</span><span id="DFT.scf-801"><a href="#DFT.scf-801"><span class="linenos"> 801</span></a><span class="sd">            dmat : numpy.ndarray, shape (nbf, nbf)</span>
</span><span id="DFT.scf-802"><a href="#DFT.scf-802"><span class="linenos"> 802</span></a><span class="sd">                Converged density matrix in atomic orbital basis</span>
</span><span id="DFT.scf-803"><a href="#DFT.scf-803"><span class="linenos"> 803</span></a><span class="sd">                </span>
</span><span id="DFT.scf-804"><a href="#DFT.scf-804"><span class="linenos"> 804</span></a><span class="sd">        Raises:</span>
</span><span id="DFT.scf-805"><a href="#DFT.scf-805"><span class="linenos"> 805</span></a><span class="sd">        -------</span>
</span><span id="DFT.scf-806"><a href="#DFT.scf-806"><span class="linenos"> 806</span></a><span class="sd">        ConvergenceError</span>
</span><span id="DFT.scf-807"><a href="#DFT.scf-807"><span class="linenos"> 807</span></a><span class="sd">            If SCF fails to converge within max_itr iterations</span>
</span><span id="DFT.scf-808"><a href="#DFT.scf-808"><span class="linenos"> 808</span></a><span class="sd">            </span>
</span><span id="DFT.scf-809"><a href="#DFT.scf-809"><span class="linenos"> 809</span></a><span class="sd">        Notes:</span>
</span><span id="DFT.scf-810"><a href="#DFT.scf-810"><span class="linenos"> 810</span></a><span class="sd">        ------</span>
</span><span id="DFT.scf-811"><a href="#DFT.scf-811"><span class="linenos"> 811</span></a><span class="sd">        - Uses class attributes for all computational parameters (basis, xc, conv_crit, etc.)</span>
</span><span id="DFT.scf-812"><a href="#DFT.scf-812"><span class="linenos"> 812</span></a><span class="sd">        - Extensive timing and profiling information printed during execution</span>
</span><span id="DFT.scf-813"><a href="#DFT.scf-813"><span class="linenos"> 813</span></a><span class="sd">        - Memory usage information displayed for large arrays</span>
</span><span id="DFT.scf-814"><a href="#DFT.scf-814"><span class="linenos"> 814</span></a><span class="sd">        - GPU memory automatically freed after completion</span>
</span><span id="DFT.scf-815"><a href="#DFT.scf-815"><span class="linenos"> 815</span></a><span class="sd">        - Supports both Cartesian (CAO) and Spherical (SAO) atomic orbital bases</span>
</span><span id="DFT.scf-816"><a href="#DFT.scf-816"><span class="linenos"> 816</span></a><span class="sd">        </span>
</span><span id="DFT.scf-817"><a href="#DFT.scf-817"><span class="linenos"> 817</span></a><span class="sd">        The function performs comprehensive error checking and provides detailed</span>
</span><span id="DFT.scf-818"><a href="#DFT.scf-818"><span class="linenos"> 818</span></a><span class="sd">        timing breakdowns for performance analysis. GPU acceleration is automatically</span>
</span><span id="DFT.scf-819"><a href="#DFT.scf-819"><span class="linenos"> 819</span></a><span class="sd">        enabled when CuPy is available and use_gpu=True.</span>
</span><span id="DFT.scf-820"><a href="#DFT.scf-820"><span class="linenos"> 820</span></a><span class="sd">        </span>
</span><span id="DFT.scf-821"><a href="#DFT.scf-821"><span class="linenos"> 821</span></a><span class="sd">        Example Energy Components:</span>
</span><span id="DFT.scf-822"><a href="#DFT.scf-822"><span class="linenos"> 822</span></a><span class="sd">        - Electron-nuclear attraction energy</span>
</span><span id="DFT.scf-823"><a href="#DFT.scf-823"><span class="linenos"> 823</span></a><span class="sd">        - Nuclear repulsion energy  </span>
</span><span id="DFT.scf-824"><a href="#DFT.scf-824"><span class="linenos"> 824</span></a><span class="sd">        - Kinetic energy</span>
</span><span id="DFT.scf-825"><a href="#DFT.scf-825"><span class="linenos"> 825</span></a><span class="sd">        - Coulomb (electron-electron repulsion) energy</span>
</span><span id="DFT.scf-826"><a href="#DFT.scf-826"><span class="linenos"> 826</span></a><span class="sd">        - Exchange-correlation energy</span>
</span><span id="DFT.scf-827"><a href="#DFT.scf-827"><span class="linenos"> 827</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DFT.scf-828"><a href="#DFT.scf-828"><span class="linenos"> 828</span></a>        <span class="c1">#### Timings</span>
</span><span id="DFT.scf-829"><a href="#DFT.scf-829"><span class="linenos"> 829</span></a>        <span class="n">duration1e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-830"><a href="#DFT.scf-830"><span class="linenos"> 830</span></a>        <span class="n">durationDIIS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-831"><a href="#DFT.scf-831"><span class="linenos"> 831</span></a>        <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-832"><a href="#DFT.scf-832"><span class="linenos"> 832</span></a>        <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-833"><a href="#DFT.scf-833"><span class="linenos"> 833</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-834"><a href="#DFT.scf-834"><span class="linenos"> 834</span></a>        <span class="n">durationItr</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-835"><a href="#DFT.scf-835"><span class="linenos"> 835</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-836"><a href="#DFT.scf-836"><span class="linenos"> 836</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-837"><a href="#DFT.scf-837"><span class="linenos"> 837</span></a>        <span class="n">durationDF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-838"><a href="#DFT.scf-838"><span class="linenos"> 838</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-839"><a href="#DFT.scf-839"><span class="linenos"> 839</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-840"><a href="#DFT.scf-840"><span class="linenos"> 840</span></a>        <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-841"><a href="#DFT.scf-841"><span class="linenos"> 841</span></a>        <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-842"><a href="#DFT.scf-842"><span class="linenos"> 842</span></a>        <span class="n">duration2c2e</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-843"><a href="#DFT.scf-843"><span class="linenos"> 843</span></a>        <span class="n">durationDF_coeff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-844"><a href="#DFT.scf-844"><span class="linenos"> 844</span></a>        <span class="n">durationDF_gamma</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-845"><a href="#DFT.scf-845"><span class="linenos"> 845</span></a>        <span class="n">durationDF_Jtri</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-846"><a href="#DFT.scf-846"><span class="linenos"> 846</span></a>        <span class="n">durationDF_cholesky</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-847"><a href="#DFT.scf-847"><span class="linenos"> 847</span></a>        <span class="n">startSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>    
</span><span id="DFT.scf-848"><a href="#DFT.scf-848"><span class="linenos"> 848</span></a>
</span><span id="DFT.scf-849"><a href="#DFT.scf-849"><span class="linenos"> 849</span></a>        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
</span><span id="DFT.scf-850"><a href="#DFT.scf-850"><span class="linenos"> 850</span></a>        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</span><span id="DFT.scf-851"><a href="#DFT.scf-851"><span class="linenos"> 851</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span>
</span><span id="DFT.scf-852"><a href="#DFT.scf-852"><span class="linenos"> 852</span></a>        <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="DFT.scf-853"><a href="#DFT.scf-853"><span class="linenos"> 853</span></a>        <span class="n">conv_crit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_crit</span>
</span><span id="DFT.scf-854"><a href="#DFT.scf-854"><span class="linenos"> 854</span></a>        <span class="n">max_itr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_itr</span>
</span><span id="DFT.scf-855"><a href="#DFT.scf-855"><span class="linenos"> 855</span></a>        <span class="n">ncores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncores</span>
</span><span id="DFT.scf-856"><a href="#DFT.scf-856"><span class="linenos"> 856</span></a>        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grids</span>
</span><span id="DFT.scf-857"><a href="#DFT.scf-857"><span class="linenos"> 857</span></a>        <span class="n">gridsLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridsLevel</span>
</span><span id="DFT.scf-858"><a href="#DFT.scf-858"><span class="linenos"> 858</span></a>        <span class="n">isDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDF</span>
</span><span id="DFT.scf-859"><a href="#DFT.scf-859"><span class="linenos"> 859</span></a>        <span class="n">auxbasis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxbasis</span>
</span><span id="DFT.scf-860"><a href="#DFT.scf-860"><span class="linenos"> 860</span></a>        <span class="n">rys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rys</span>
</span><span id="DFT.scf-861"><a href="#DFT.scf-861"><span class="linenos"> 861</span></a>        <span class="n">DF_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DF_algo</span>
</span><span id="DFT.scf-862"><a href="#DFT.scf-862"><span class="linenos"> 862</span></a>        <span class="n">blocksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span>
</span><span id="DFT.scf-863"><a href="#DFT.scf-863"><span class="linenos"> 863</span></a>        <span class="n">XC_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XC_algo</span>
</span><span id="DFT.scf-864"><a href="#DFT.scf-864"><span class="linenos"> 864</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="DFT.scf-865"><a href="#DFT.scf-865"><span class="linenos"> 865</span></a>        <span class="n">sortGrids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortGrids</span>
</span><span id="DFT.scf-866"><a href="#DFT.scf-866"><span class="linenos"> 866</span></a>        <span class="n">save_ao_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_ao_values</span>
</span><span id="DFT.scf-867"><a href="#DFT.scf-867"><span class="linenos"> 867</span></a>        <span class="n">xc_bf_screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc_bf_screen</span>
</span><span id="DFT.scf-868"><a href="#DFT.scf-868"><span class="linenos"> 868</span></a>        <span class="n">threshold_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_schwarz</span>
</span><span id="DFT.scf-869"><a href="#DFT.scf-869"><span class="linenos"> 869</span></a>        <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_schwarz</span>
</span><span id="DFT.scf-870"><a href="#DFT.scf-870"><span class="linenos"> 870</span></a>        <span class="n">cholesky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cholesky</span>
</span><span id="DFT.scf-871"><a href="#DFT.scf-871"><span class="linenos"> 871</span></a>        <span class="n">orthogonalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orthogonalize</span>
</span><span id="DFT.scf-872"><a href="#DFT.scf-872"><span class="linenos"> 872</span></a>
</span><span id="DFT.scf-873"><a href="#DFT.scf-873"><span class="linenos"> 873</span></a>        <span class="n">print_pyfock_logo</span><span class="p">()</span>
</span><span id="DFT.scf-874"><a href="#DFT.scf-874"><span class="linenos"> 874</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of atoms:&#39;</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
</span><span id="DFT.scf-875"><a href="#DFT.scf-875"><span class="linenos"> 875</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of basis functions (atomic orbitals):&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="DFT.scf-876"><a href="#DFT.scf-876"><span class="linenos"> 876</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Number of auxiliary basis functions:&#39;</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">)</span>
</span><span id="DFT.scf-877"><a href="#DFT.scf-877"><span class="linenos"> 877</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">================================================================================</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-878"><a href="#DFT.scf-878"><span class="linenos"> 878</span></a>
</span><span id="DFT.scf-879"><a href="#DFT.scf-879"><span class="linenos"> 879</span></a>        <span class="n">print_sys_info</span><span class="p">()</span>
</span><span id="DFT.scf-880"><a href="#DFT.scf-880"><span class="linenos"> 880</span></a>
</span><span id="DFT.scf-881"><a href="#DFT.scf-881"><span class="linenos"> 881</span></a>        <span class="c1">#### Set number of cores</span>
</span><span id="DFT.scf-882"><a href="#DFT.scf-882"><span class="linenos"> 882</span></a>        <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT.scf-883"><a href="#DFT.scf-883"><span class="linenos"> 883</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RAYON_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT.scf-884"><a href="#DFT.scf-884"><span class="linenos"> 884</span></a>        
</span><span id="DFT.scf-885"><a href="#DFT.scf-885"><span class="linenos"> 885</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running DFT using &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39; threads for Numba.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-886"><a href="#DFT.scf-886"><span class="linenos"> 886</span></a>        <span class="c1"># if basis is None:</span>
</span><span id="DFT.scf-887"><a href="#DFT.scf-887"><span class="linenos"> 887</span></a>        <span class="c1">#     basis = self.basis</span>
</span><span id="DFT.scf-888"><a href="#DFT.scf-888"><span class="linenos"> 888</span></a>        <span class="c1"># if mol is None:</span>
</span><span id="DFT.scf-889"><a href="#DFT.scf-889"><span class="linenos"> 889</span></a>        <span class="c1">#     mol = self.mol</span>
</span><span id="DFT.scf-890"><a href="#DFT.scf-890"><span class="linenos"> 890</span></a>        <span class="c1"># if xc is None:</span>
</span><span id="DFT.scf-891"><a href="#DFT.scf-891"><span class="linenos"> 891</span></a>        <span class="c1">#     xc = self.xc</span>
</span><span id="DFT.scf-892"><a href="#DFT.scf-892"><span class="linenos"> 892</span></a>        <span class="c1"># if gridsLevel is None:</span>
</span><span id="DFT.scf-893"><a href="#DFT.scf-893"><span class="linenos"> 893</span></a>        <span class="c1">#     gridsLevel = self.gridsLevel</span>
</span><span id="DFT.scf-894"><a href="#DFT.scf-894"><span class="linenos"> 894</span></a>        <span class="c1"># if auxbasis is None:</span>
</span><span id="DFT.scf-895"><a href="#DFT.scf-895"><span class="linenos"> 895</span></a>        <span class="c1">#     auxbasis = Basis(mol, {&#39;all&#39;:Basis.load(mol=mol, basis_name=&#39;def2-universal-jfit&#39;)})</span>
</span><span id="DFT.scf-896"><a href="#DFT.scf-896"><span class="linenos"> 896</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-897"><a href="#DFT.scf-897"><span class="linenos"> 897</span></a>            <span class="n">sortGrids</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.scf-898"><a href="#DFT.scf-898"><span class="linenos"> 898</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
</span><span id="DFT.scf-899"><a href="#DFT.scf-899"><span class="linenos"> 899</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
</span><span id="DFT.scf-900"><a href="#DFT.scf-900"><span class="linenos"> 900</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning! AO screening is set to False, but AO values are requested to be saved. </span><span class="se">\</span>
</span><span id="DFT.scf-901"><a href="#DFT.scf-901"><span class="linenos"> 901</span></a><span class="s1">                      AO values can only be saved when XC_BF_SCREEN=TRUE. AO values will not be saved.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-902"><a href="#DFT.scf-902"><span class="linenos"> 902</span></a>                <span class="n">save_ao_values</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.scf-903"><a href="#DFT.scf-903"><span class="linenos"> 903</span></a>        <span class="k">if</span> <span class="n">CUPY_AVAILABLE</span><span class="p">:</span>
</span><span id="DFT.scf-904"><a href="#DFT.scf-904"><span class="linenos"> 904</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-905"><a href="#DFT.scf-905"><span class="linenos"> 905</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration is enabled. Currently this only accelerates AO values and XC term evaluation.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-906"><a href="#DFT.scf-906"><span class="linenos"> 906</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU(s) information:&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-907"><a href="#DFT.scf-907"><span class="linenos"> 907</span></a>                <span class="c1"># print(cp.cuda.Device.mem_info())</span>
</span><span id="DFT.scf-908"><a href="#DFT.scf-908"><span class="linenos"> 908</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">detect</span><span class="p">())</span>
</span><span id="DFT.scf-909"><a href="#DFT.scf-909"><span class="linenos"> 909</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Max threads per block supported by the GPU: &#39;</span><span class="p">,</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-910"><a href="#DFT.scf-910"><span class="linenos"> 910</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The user has specified to use &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; GPU(s).&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-911"><a href="#DFT.scf-911"><span class="linenos"> 911</span></a>            
</span><span id="DFT.scf-912"><a href="#DFT.scf-912"><span class="linenos"> 912</span></a>                <span class="c1"># For CUDA computations</span>
</span><span id="DFT.scf-913"><a href="#DFT.scf-913"><span class="linenos"> 913</span></a>                <span class="n">threads_per_block</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads_y</span><span class="p">)</span>
</span><span id="DFT.scf-914"><a href="#DFT.scf-914"><span class="linenos"> 914</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the XC term: &#39;</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-915"><a href="#DFT.scf-915"><span class="linenos"> 915</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threads per block configuration for the all other calculations: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-916"><a href="#DFT.scf-916"><span class="linenos"> 916</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_precision</span><span class="p">:</span>
</span><span id="DFT.scf-917"><a href="#DFT.scf-917"><span class="linenos"> 917</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Will use dynamic precision. &#39;</span><span class="p">)</span>
</span><span id="DFT.scf-918"><a href="#DFT.scf-918"><span class="linenos"> 918</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This means that the XC term will be evaluated in single precision until the &#39;</span><span class="p">)</span>
</span><span id="DFT.scf-919"><a href="#DFT.scf-919"><span class="linenos"> 919</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;relative energy difference b/w successive iterations is less than 5.0E-7.&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-920"><a href="#DFT.scf-920"><span class="linenos"> 920</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span>
</span><span id="DFT.scf-921"><a href="#DFT.scf-921"><span class="linenos"> 921</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-922"><a href="#DFT.scf-922"><span class="linenos"> 922</span></a>                    <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="DFT.scf-923"><a href="#DFT.scf-923"><span class="linenos"> 923</span></a>
</span><span id="DFT.scf-924"><a href="#DFT.scf-924"><span class="linenos"> 924</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-925"><a href="#DFT.scf-925"><span class="linenos"> 925</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="DFT.scf-926"><a href="#DFT.scf-926"><span class="linenos"> 926</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-927"><a href="#DFT.scf-927"><span class="linenos"> 927</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">20480</span>
</span><span id="DFT.scf-928"><a href="#DFT.scf-928"><span class="linenos"> 928</span></a>                <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.scf-929"><a href="#DFT.scf-929"><span class="linenos"> 929</span></a>                <span class="n">nb_streams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.scf-930"><a href="#DFT.scf-930"><span class="linenos"> 930</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="DFT.scf-931"><a href="#DFT.scf-931"><span class="linenos"> 931</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT.scf-932"><a href="#DFT.scf-932"><span class="linenos"> 932</span></a>                    <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-933"><a href="#DFT.scf-933"><span class="linenos"> 933</span></a>                    <span class="n">nb_stream</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">external_stream</span><span class="p">(</span><span class="n">cp_stream</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
</span><span id="DFT.scf-934"><a href="#DFT.scf-934"><span class="linenos"> 934</span></a>                    <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp_stream</span><span class="p">)</span>
</span><span id="DFT.scf-935"><a href="#DFT.scf-935"><span class="linenos"> 935</span></a>                    <span class="n">nb_streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb_stream</span><span class="p">)</span>
</span><span id="DFT.scf-936"><a href="#DFT.scf-936"><span class="linenos"> 936</span></a>                <span class="c1"># Switch back to main GPU</span>
</span><span id="DFT.scf-937"><a href="#DFT.scf-937"><span class="linenos"> 937</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT.scf-938"><a href="#DFT.scf-938"><span class="linenos"> 938</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT.scf-939"><a href="#DFT.scf-939"><span class="linenos"> 939</span></a>                <span class="c1"># # Set some basis function data as cupy arrays to avoid redoing it during XC term evaluation at every SCF iteration</span>
</span><span id="DFT.scf-940"><a href="#DFT.scf-940"><span class="linenos"> 940</span></a>                <span class="c1"># bfs_coords = cp.asarray([basis.bfs_coords], dtype=precision_XC)</span>
</span><span id="DFT.scf-941"><a href="#DFT.scf-941"><span class="linenos"> 941</span></a>                <span class="c1"># bfs_contr_prim_norms = cp.asarray([basis.bfs_contr_prim_norms], dtype=precision_XC)</span>
</span><span id="DFT.scf-942"><a href="#DFT.scf-942"><span class="linenos"> 942</span></a>                <span class="c1"># bfs_lmn = cp.asarray([basis.bfs_lmn])</span>
</span><span id="DFT.scf-943"><a href="#DFT.scf-943"><span class="linenos"> 943</span></a>                <span class="c1"># bfs_nprim = cp.asarray([basis.bfs_nprim])</span>
</span><span id="DFT.scf-944"><a href="#DFT.scf-944"><span class="linenos"> 944</span></a>                <span class="c1"># #The remaining properties like bfs_coeffs are a list of lists of unequal sizes.</span>
</span><span id="DFT.scf-945"><a href="#DFT.scf-945"><span class="linenos"> 945</span></a>                <span class="c1"># #Numba won&#39;t be able to work with these efficiently.</span>
</span><span id="DFT.scf-946"><a href="#DFT.scf-946"><span class="linenos"> 946</span></a>                <span class="c1"># #So, we convert them to a numpy 2d array by applying a trick,</span>
</span><span id="DFT.scf-947"><a href="#DFT.scf-947"><span class="linenos"> 947</span></a>                <span class="c1"># #that the second dimension is that of the largest list. So that</span>
</span><span id="DFT.scf-948"><a href="#DFT.scf-948"><span class="linenos"> 948</span></a>                <span class="c1"># #it can accomadate all the lists.</span>
</span><span id="DFT.scf-949"><a href="#DFT.scf-949"><span class="linenos"> 949</span></a>                <span class="c1"># maxnprim = max(basis.bfs_nprim)</span>
</span><span id="DFT.scf-950"><a href="#DFT.scf-950"><span class="linenos"> 950</span></a>                <span class="c1"># bfs_coeffs = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT.scf-951"><a href="#DFT.scf-951"><span class="linenos"> 951</span></a>                <span class="c1"># bfs_expnts = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT.scf-952"><a href="#DFT.scf-952"><span class="linenos"> 952</span></a>                <span class="c1"># bfs_prim_norms = cp.zeros([basis.bfs_nao, maxnprim], dtype=precision_XC)</span>
</span><span id="DFT.scf-953"><a href="#DFT.scf-953"><span class="linenos"> 953</span></a>                <span class="c1"># bfs_radius_cutoff = cp.zeros([basis.bfs_nao], dtype=precision_XC)</span>
</span><span id="DFT.scf-954"><a href="#DFT.scf-954"><span class="linenos"> 954</span></a>                <span class="c1"># for i in range(basis.bfs_nao):</span>
</span><span id="DFT.scf-955"><a href="#DFT.scf-955"><span class="linenos"> 955</span></a>                <span class="c1">#     for j in range(basis.bfs_nprim[i]):</span>
</span><span id="DFT.scf-956"><a href="#DFT.scf-956"><span class="linenos"> 956</span></a>                <span class="c1">#         bfs_coeffs[i,j] = basis.bfs_coeffs[i][j]</span>
</span><span id="DFT.scf-957"><a href="#DFT.scf-957"><span class="linenos"> 957</span></a>                <span class="c1">#         bfs_expnts[i,j] = basis.bfs_expnts[i][j]</span>
</span><span id="DFT.scf-958"><a href="#DFT.scf-958"><span class="linenos"> 958</span></a>                <span class="c1">#         bfs_prim_norms[i,j] = basis.bfs_prim_norms[i][j]</span>
</span><span id="DFT.scf-959"><a href="#DFT.scf-959"><span class="linenos"> 959</span></a>                <span class="c1">#         bfs_radius_cutoff[i] = basis.bfs_radius_cutoff[i]</span>
</span><span id="DFT.scf-960"><a href="#DFT.scf-960"><span class="linenos"> 960</span></a>                <span class="c1"># # Now bf/ao values can be evaluated by calling the following</span>
</span><span id="DFT.scf-961"><a href="#DFT.scf-961"><span class="linenos"> 961</span></a>                <span class="c1"># # bf_values = Integrals.bf_val_helpers.eval_bfs(bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff, coord)</span>
</span><span id="DFT.scf-962"><a href="#DFT.scf-962"><span class="linenos"> 962</span></a>                <span class="c1"># bfs_data_as_np_arrays = [bfs_coords[0], bfs_contr_prim_norms[0], bfs_nprim[0], bfs_lmn[0], bfs_coeffs, bfs_prim_norms, bfs_expnts, bfs_radius_cutoff]</span>
</span><span id="DFT.scf-963"><a href="#DFT.scf-963"><span class="linenos"> 963</span></a>                
</span><span id="DFT.scf-964"><a href="#DFT.scf-964"><span class="linenos"> 964</span></a>
</span><span id="DFT.scf-965"><a href="#DFT.scf-965"><span class="linenos"> 965</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-966"><a href="#DFT.scf-966"><span class="linenos"> 966</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-967"><a href="#DFT.scf-967"><span class="linenos"> 967</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU acceleration requested but cannot be enabled as Cupy is not installed.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-968"><a href="#DFT.scf-968"><span class="linenos"> 968</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.scf-969"><a href="#DFT.scf-969"><span class="linenos"> 969</span></a>
</span><span id="DFT.scf-970"><a href="#DFT.scf-970"><span class="linenos"> 970</span></a>                <span class="k">if</span> <span class="n">XC_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-971"><a href="#DFT.scf-971"><span class="linenos"> 971</span></a>                    <span class="n">XC_algo</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="DFT.scf-972"><a href="#DFT.scf-972"><span class="linenos"> 972</span></a>                <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-973"><a href="#DFT.scf-973"><span class="linenos"> 973</span></a>                    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="DFT.scf-974"><a href="#DFT.scf-974"><span class="linenos"> 974</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-975"><a href="#DFT.scf-975"><span class="linenos"> 975</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.scf-976"><a href="#DFT.scf-976"><span class="linenos"> 976</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-977"><a href="#DFT.scf-977"><span class="linenos"> 977</span></a>            <span class="n">isSchwarz</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Schwarz screening is not yet implemented for 4c2e integrals</span>
</span><span id="DFT.scf-978"><a href="#DFT.scf-978"><span class="linenos"> 978</span></a>        <span class="k">if</span> <span class="n">strict_schwarz</span><span class="p">:</span>
</span><span id="DFT.scf-979"><a href="#DFT.scf-979"><span class="linenos"> 979</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT.scf-980"><a href="#DFT.scf-980"><span class="linenos"> 980</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The stricter variation of Schwarz screening is only compatible with DF algo #6 or #10 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-981"><a href="#DFT.scf-981"><span class="linenos"> 981</span></a>                <span class="n">strict_schwarz</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.scf-982"><a href="#DFT.scf-982"><span class="linenos"> 982</span></a>        <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT.scf-983"><a href="#DFT.scf-983"><span class="linenos"> 983</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT.scf-984"><a href="#DFT.scf-984"><span class="linenos"> 984</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The Cholesky decomposition of 2c2e integrls is only compatible with DF algo #6 so turning it off.&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-985"><a href="#DFT.scf-985"><span class="linenos"> 985</span></a>                <span class="n">cholesky</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.scf-986"><a href="#DFT.scf-986"><span class="linenos"> 986</span></a>        
</span><span id="DFT.scf-987"><a href="#DFT.scf-987"><span class="linenos"> 987</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT.scf-988"><a href="#DFT.scf-988"><span class="linenos"> 988</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Spherical Atomic Orbitals are being used!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-989"><a href="#DFT.scf-989"><span class="linenos"> 989</span></a>            <span class="c1"># Get the CAO to SAO transformation matrix</span>
</span><span id="DFT.scf-990"><a href="#DFT.scf-990"><span class="linenos"> 990</span></a>            <span class="n">c2sph_mat</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">cart2sph_basis</span><span class="p">()</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT.scf-991"><a href="#DFT.scf-991"><span class="linenos"> 991</span></a>            <span class="c1"># Calculate the pseudoinverse transformation matrix (for back transformation of SAO dmat to CAO dmat)</span>
</span><span id="DFT.scf-992"><a href="#DFT.scf-992"><span class="linenos"> 992</span></a>            <span class="n">sph2c_mat_pseudo</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">sph2cart_basis</span><span class="p">()</span> <span class="c1"># SAO --&gt; CAO</span>
</span><span id="DFT.scf-993"><a href="#DFT.scf-993"><span class="linenos"> 993</span></a>                
</span><span id="DFT.scf-994"><a href="#DFT.scf-994"><span class="linenos"> 994</span></a>
</span><span id="DFT.scf-995"><a href="#DFT.scf-995"><span class="linenos"> 995</span></a>        <span class="n">eigvectors</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-996"><a href="#DFT.scf-996"><span class="linenos"> 996</span></a>        <span class="c1"># DF_algo = 1 # Worst algorithm for more than 500 bfs/auxbfs (requires 2x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="DFT.scf-997"><a href="#DFT.scf-997"><span class="linenos"> 997</span></a>        <span class="c1"># DF_algo = 2 # Sligthly better (2x memory efficient) algorithm than above (requires 1x mem of 3c2e integrals and a large prefactor)</span>
</span><span id="DFT.scf-998"><a href="#DFT.scf-998"><span class="linenos"> 998</span></a>        <span class="c1"># DF_algo = 3 # Memory effcient without any prefactor. (Can easily be converted into a sparse version, unlike the others) (https://aip.scitation.org/doi/pdf/10.1063/1.1567253)</span>
</span><span id="DFT.scf-999"><a href="#DFT.scf-999"><span class="linenos"> 999</span></a>        <span class="c1"># DF_algo = 4 # Same as 3, except now we use triangular version of ints3c2e to save on memory</span>
</span><span id="DFT.scf-1000"><a href="#DFT.scf-1000"><span class="linenos">1000</span></a>        <span class="c1"># DF_algo = 5 # Same as 4 in terms of memory requirements, however faster in performance due to the use of Schwarz screening.</span>
</span><span id="DFT.scf-1001"><a href="#DFT.scf-1001"><span class="linenos">1001</span></a>        <span class="c1"># DF_algo = 6 # Much cheaper than 4 and 5 in terms of memory requirements because the indices of significant (ij|P) are efficiently calculated without duplicates/temporary arrays. </span>
</span><span id="DFT.scf-1002"><a href="#DFT.scf-1002"><span class="linenos">1002</span></a>        <span class="c1">#               The speed maybe same or just slightly slower. </span>
</span><span id="DFT.scf-1003"><a href="#DFT.scf-1003"><span class="linenos">1003</span></a>        <span class="c1"># DF_algo = 7 # The significant indices (ij|P) are stored even more efficiently by using shell indices instead of bf indices.</span>
</span><span id="DFT.scf-1004"><a href="#DFT.scf-1004"><span class="linenos">1004</span></a>        <span class="c1"># DF_algo = 8 # Similar to 6, except that here the significant indices are not stored resulting in 50% memory savings. The drawback is that it only works in serial which is useful for Google colab or Kaggle perhaps.</span>
</span><span id="DFT.scf-1005"><a href="#DFT.scf-1005"><span class="linenos">1005</span></a>        <span class="c1"># DF_algo = 9 # </span>
</span><span id="DFT.scf-1006"><a href="#DFT.scf-1006"><span class="linenos">1006</span></a>
</span><span id="DFT.scf-1007"><a href="#DFT.scf-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_schwarz</span><span class="p">:</span> <span class="c1"># If a stricter variant of Schwarz screening is not requested</span>
</span><span id="DFT.scf-1008"><a href="#DFT.scf-1008"><span class="linenos">1008</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1009"><a href="#DFT.scf-1009"><span class="linenos">1009</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating one electron integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1010"><a href="#DFT.scf-1010"><span class="linenos">1010</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="DFT.scf-1011"><a href="#DFT.scf-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1012"><a href="#DFT.scf-1012"><span class="linenos">1012</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1013"><a href="#DFT.scf-1013"><span class="linenos">1013</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
</span><span id="DFT.scf-1014"><a href="#DFT.scf-1014"><span class="linenos">1014</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1015"><a href="#DFT.scf-1015"><span class="linenos">1015</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT.scf-1016"><a href="#DFT.scf-1016"><span class="linenos">1016</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="DFT.scf-1017"><a href="#DFT.scf-1017"><span class="linenos">1017</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1018"><a href="#DFT.scf-1018"><span class="linenos">1018</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span><span class="o">=</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1019"><a href="#DFT.scf-1019"><span class="linenos">1019</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">nuc_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1020"><a href="#DFT.scf-1020"><span class="linenos">1020</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1021"><a href="#DFT.scf-1021"><span class="linenos">1021</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT.scf-1022"><a href="#DFT.scf-1022"><span class="linenos">1022</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">V</span>
</span><span id="DFT.scf-1023"><a href="#DFT.scf-1023"><span class="linenos">1023</span></a>
</span><span id="DFT.scf-1024"><a href="#DFT.scf-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1025"><a href="#DFT.scf-1025"><span class="linenos">1025</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1026"><a href="#DFT.scf-1026"><span class="linenos">1026</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="DFT.scf-1027"><a href="#DFT.scf-1027"><span class="linenos">1027</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1028"><a href="#DFT.scf-1028"><span class="linenos">1028</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1029"><a href="#DFT.scf-1029"><span class="linenos">1029</span></a>            <span class="n">start1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1030"><a href="#DFT.scf-1030"><span class="linenos">1030</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating overlap and kinetic integrals...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1031"><a href="#DFT.scf-1031"><span class="linenos">1031</span></a>            <span class="c1"># One electron integrals</span>
</span><span id="DFT.scf-1032"><a href="#DFT.scf-1032"><span class="linenos">1032</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1033"><a href="#DFT.scf-1033"><span class="linenos">1033</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1034"><a href="#DFT.scf-1034"><span class="linenos">1034</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1035"><a href="#DFT.scf-1035"><span class="linenos">1035</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT.scf-1036"><a href="#DFT.scf-1036"><span class="linenos">1036</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="DFT.scf-1037"><a href="#DFT.scf-1037"><span class="linenos">1037</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1038"><a href="#DFT.scf-1038"><span class="linenos">1038</span></a>                <span class="n">S</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">overlap_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1039"><a href="#DFT.scf-1039"><span class="linenos">1039</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">kin_mat_symm_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">cp_stream</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1040"><a href="#DFT.scf-1040"><span class="linenos">1040</span></a>                <span class="c1"># Core hamiltonian</span>
</span><span id="DFT.scf-1041"><a href="#DFT.scf-1041"><span class="linenos">1041</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">T</span> 
</span><span id="DFT.scf-1042"><a href="#DFT.scf-1042"><span class="linenos">1042</span></a>
</span><span id="DFT.scf-1043"><a href="#DFT.scf-1043"><span class="linenos">1043</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core H size in GB &#39;</span><span class="p">,(</span><span class="n">H</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Factor of 2 because nuclear matrix will also be included here later</span>
</span><span id="DFT.scf-1044"><a href="#DFT.scf-1044"><span class="linenos">1044</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1045"><a href="#DFT.scf-1045"><span class="linenos">1045</span></a>            <span class="n">duration1e</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1e</span>
</span><span id="DFT.scf-1046"><a href="#DFT.scf-1046"><span class="linenos">1046</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">duration1e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1047"><a href="#DFT.scf-1047"><span class="linenos">1047</span></a>
</span><span id="DFT.scf-1048"><a href="#DFT.scf-1048"><span class="linenos">1048</span></a>
</span><span id="DFT.scf-1049"><a href="#DFT.scf-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">dmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-1050"><a href="#DFT.scf-1050"><span class="linenos">1050</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmat_guess_method</span><span class="o">==</span><span class="s1">&#39;core&#39;</span><span class="p">:</span>
</span><span id="DFT.scf-1051"><a href="#DFT.scf-1051"><span class="linenos">1051</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessCoreH</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">Hcore</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT.scf-1052"><a href="#DFT.scf-1052"><span class="linenos">1052</span></a>
</span><span id="DFT.scf-1053"><a href="#DFT.scf-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1054"><a href="#DFT.scf-1054"><span class="linenos">1054</span></a>            <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT.scf-1055"><a href="#DFT.scf-1055"><span class="linenos">1055</span></a>            <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1056"><a href="#DFT.scf-1056"><span class="linenos">1056</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1057"><a href="#DFT.scf-1057"><span class="linenos">1057</span></a>
</span><span id="DFT.scf-1058"><a href="#DFT.scf-1058"><span class="linenos">1058</span></a>        
</span><span id="DFT.scf-1059"><a href="#DFT.scf-1059"><span class="linenos">1059</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT.scf-1060"><a href="#DFT.scf-1060"><span class="linenos">1060</span></a>            <span class="c1"># It is possible that the supplied density matrix to the SCF was in SAO format already.</span>
</span><span id="DFT.scf-1061"><a href="#DFT.scf-1061"><span class="linenos">1061</span></a>            <span class="c1"># In such a case we need to transform this density matrix to CAO basis so that the J and XC term evaluations can be done properly </span>
</span><span id="DFT.scf-1062"><a href="#DFT.scf-1062"><span class="linenos">1062</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="DFT.scf-1063"><a href="#DFT.scf-1063"><span class="linenos">1063</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># Convert to CAO from SAO (SAO --&gt; CAO)</span>
</span><span id="DFT.scf-1064"><a href="#DFT.scf-1064"><span class="linenos">1064</span></a>                <span class="c1"># Later the dmat will be converted back to SAO after J and XC term evaluations</span>
</span><span id="DFT.scf-1065"><a href="#DFT.scf-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span> <span class="c1"># 4c2e ERI case</span>
</span><span id="DFT.scf-1066"><a href="#DFT.scf-1066"><span class="linenos">1066</span></a>            
</span><span id="DFT.scf-1067"><a href="#DFT.scf-1067"><span class="linenos">1067</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating four centered two electron integrals (ERIs)...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1068"><a href="#DFT.scf-1068"><span class="linenos">1068</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">isSchwarz</span><span class="p">:</span>
</span><span id="DFT.scf-1069"><a href="#DFT.scf-1069"><span class="linenos">1069</span></a>                <span class="c1"># Four centered two electron integrals (ERIs)</span>
</span><span id="DFT.scf-1070"><a href="#DFT.scf-1070"><span class="linenos">1070</span></a>                <span class="k">if</span> <span class="n">rys</span><span class="p">:</span>
</span><span id="DFT.scf-1071"><a href="#DFT.scf-1071"><span class="linenos">1071</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">rys_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1072"><a href="#DFT.scf-1072"><span class="linenos">1072</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1073"><a href="#DFT.scf-1073"><span class="linenos">1073</span></a>                    <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">conv_4c2e_symm</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1074"><a href="#DFT.scf-1074"><span class="linenos">1074</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Four Center Two electron ERI size in GB &#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1075"><a href="#DFT.scf-1075"><span class="linenos">1075</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1076"><a href="#DFT.scf-1076"><span class="linenos">1076</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1077"><a href="#DFT.scf-1077"><span class="linenos">1077</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Performing Schwarz screening...&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1078"><a href="#DFT.scf-1078"><span class="linenos">1078</span></a>                <span class="c1"># threshold_schwarz = 1e-09</span>
</span><span id="DFT.scf-1079"><a href="#DFT.scf-1079"><span class="linenos">1079</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Threshold &#39;</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="DFT.scf-1080"><a href="#DFT.scf-1080"><span class="linenos">1080</span></a>                <span class="n">startSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1081"><a href="#DFT.scf-1081"><span class="linenos">1081</span></a>                <span class="n">nints4c2e_sym8</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span><span id="DFT.scf-1082"><a href="#DFT.scf-1082"><span class="linenos">1082</span></a>                <span class="n">nints4c2e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
</span><span id="DFT.scf-1083"><a href="#DFT.scf-1083"><span class="linenos">1083</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1084"><a href="#DFT.scf-1084"><span class="linenos">1084</span></a>                <span class="n">start_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1085"><a href="#DFT.scf-1085"><span class="linenos">1085</span></a>                <span class="c1"># Diagonal elements of ERI 4c2e array</span>
</span><span id="DFT.scf-1086"><a href="#DFT.scf-1086"><span class="linenos">1086</span></a>                <span class="n">ints4c2e_diag</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">eri_4c2e_diag</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DFT.scf-1087"><a href="#DFT.scf-1087"><span class="linenos">1087</span></a>                <span class="n">duration_4c2e_diag</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_4c2e_diag</span>
</span><span id="DFT.scf-1088"><a href="#DFT.scf-1088"><span class="linenos">1088</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the &quot;diagonal&quot; of 4c2e ERI tensor: &#39;</span><span class="p">,</span> <span class="n">duration_4c2e_diag</span><span class="p">)</span>
</span><span id="DFT.scf-1089"><a href="#DFT.scf-1089"><span class="linenos">1089</span></a>                <span class="c1"># Calculate the square roots required for </span>
</span><span id="DFT.scf-1090"><a href="#DFT.scf-1090"><span class="linenos">1090</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1091"><a href="#DFT.scf-1091"><span class="linenos">1091</span></a>                <span class="n">start_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1092"><a href="#DFT.scf-1092"><span class="linenos">1092</span></a>                <span class="n">sqrt_ints4c2e_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ints4c2e_diag</span><span class="p">))</span>
</span><span id="DFT.scf-1093"><a href="#DFT.scf-1093"><span class="linenos">1093</span></a>                <span class="n">duration_square_roots</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_square_roots</span>
</span><span id="DFT.scf-1094"><a href="#DFT.scf-1094"><span class="linenos">1094</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken to evaluate the square roots needed: &#39;</span><span class="p">,</span> <span class="n">duration_square_roots</span><span class="p">)</span>
</span><span id="DFT.scf-1095"><a href="#DFT.scf-1095"><span class="linenos">1095</span></a>                <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="c1"># Results in 2 GB chunks</span>
</span><span id="DFT.scf-1096"><a href="#DFT.scf-1096"><span class="linenos">1096</span></a>                <span class="n">duration_indices_calc</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1097"><a href="#DFT.scf-1097"><span class="linenos">1097</span></a>                <span class="n">duration_concatenation</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1098"><a href="#DFT.scf-1098"><span class="linenos">1098</span></a>                <span class="n">start_indices_calc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1099"><a href="#DFT.scf-1099"><span class="linenos">1099</span></a>                <span class="c1"># indices_temp = []</span>
</span><span id="DFT.scf-1100"><a href="#DFT.scf-1100"><span class="linenos">1100</span></a>                <span class="n">ijkl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.scf-1101"><a href="#DFT.scf-1101"><span class="linenos">1101</span></a>                <span class="k">if</span> <span class="n">chunksize</span><span class="o">&lt;</span><span class="n">nints4c2e_sym8</span><span class="p">:</span>
</span><span id="DFT.scf-1102"><a href="#DFT.scf-1102"><span class="linenos">1102</span></a>                    <span class="n">nchunks</span> <span class="o">=</span> <span class="n">nints4c2e_sym8</span><span class="o">//</span><span class="n">chunksize</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="DFT.scf-1103"><a href="#DFT.scf-1103"><span class="linenos">1103</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1104"><a href="#DFT.scf-1104"><span class="linenos">1104</span></a>                    <span class="n">nchunks</span><span class="o">=</span><span class="mi">1</span>
</span><span id="DFT.scf-1105"><a href="#DFT.scf-1105"><span class="linenos">1105</span></a>                <span class="n">indicesA</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1106"><a href="#DFT.scf-1106"><span class="linenos">1106</span></a>                <span class="k">for</span> <span class="n">ichunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
</span><span id="DFT.scf-1107"><a href="#DFT.scf-1107"><span class="linenos">1107</span></a>                    <span class="n">indices_temp</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">calc_indices_4c2e_schwarz</span><span class="p">(</span><span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">),</span> <span class="n">basis</span><span class="o">.</span><span class="n">bfs_nao</span><span class="p">,</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ijkl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">threshold_schwarz</span><span class="p">)</span>
</span><span id="DFT.scf-1108"><a href="#DFT.scf-1108"><span class="linenos">1108</span></a>                    
</span><span id="DFT.scf-1109"><a href="#DFT.scf-1109"><span class="linenos">1109</span></a>                    <span class="n">ijkl</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="DFT.scf-1110"><a href="#DFT.scf-1110"><span class="linenos">1110</span></a>                    <span class="n">count</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="DFT.scf-1111"><a href="#DFT.scf-1111"><span class="linenos">1111</span></a>                    <span class="c1"># start_concatenation = timer()</span>
</span><span id="DFT.scf-1112"><a href="#DFT.scf-1112"><span class="linenos">1112</span></a>                    <span class="k">if</span> <span class="n">indicesA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="DFT.scf-1113"><a href="#DFT.scf-1113"><span class="linenos">1113</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesA</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT.scf-1114"><a href="#DFT.scf-1114"><span class="linenos">1114</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesB</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT.scf-1115"><a href="#DFT.scf-1115"><span class="linenos">1115</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesC</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT.scf-1116"><a href="#DFT.scf-1116"><span class="linenos">1116</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">indicesD</span><span class="p">,</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]])</span>
</span><span id="DFT.scf-1117"><a href="#DFT.scf-1117"><span class="linenos">1117</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1118"><a href="#DFT.scf-1118"><span class="linenos">1118</span></a>                        
</span><span id="DFT.scf-1119"><a href="#DFT.scf-1119"><span class="linenos">1119</span></a>                        <span class="n">indicesA</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT.scf-1120"><a href="#DFT.scf-1120"><span class="linenos">1120</span></a>                        <span class="n">indicesB</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT.scf-1121"><a href="#DFT.scf-1121"><span class="linenos">1121</span></a>                        <span class="n">indicesC</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT.scf-1122"><a href="#DFT.scf-1122"><span class="linenos">1122</span></a>                        <span class="n">indicesD</span> <span class="o">=</span> <span class="n">indices_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count</span><span class="p">]</span>
</span><span id="DFT.scf-1123"><a href="#DFT.scf-1123"><span class="linenos">1123</span></a>                    <span class="c1"># duration_concatenation += timer() - start_concatenation</span>
</span><span id="DFT.scf-1124"><a href="#DFT.scf-1124"><span class="linenos">1124</span></a>                    <span class="c1"># Break out of the for loop if the nol. of significant triplets found is less than the chunksize </span>
</span><span id="DFT.scf-1125"><a href="#DFT.scf-1125"><span class="linenos">1125</span></a>                    <span class="c1"># This is because, it means that there are no more significant triplets to be found from all possible configurations. </span>
</span><span id="DFT.scf-1126"><a href="#DFT.scf-1126"><span class="linenos">1126</span></a>                    <span class="k">if</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">chunksize</span><span class="p">:</span> 
</span><span id="DFT.scf-1127"><a href="#DFT.scf-1127"><span class="linenos">1127</span></a>                        <span class="k">break</span>
</span><span id="DFT.scf-1128"><a href="#DFT.scf-1128"><span class="linenos">1128</span></a>                
</span><span id="DFT.scf-1129"><a href="#DFT.scf-1129"><span class="linenos">1129</span></a>                <span class="n">duration_indices_calc</span> <span class="o">+=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_indices_calc</span>
</span><span id="DFT.scf-1130"><a href="#DFT.scf-1130"><span class="linenos">1130</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time for significant indices evaluation: &#39;</span><span class="p">,</span> <span class="n">duration_indices_calc</span><span class="p">)</span>
</span><span id="DFT.scf-1131"><a href="#DFT.scf-1131"><span class="linenos">1131</span></a>                <span class="c1"># print(&#39;Time for array concatenation: &#39;, duration_concatenation)</span>
</span><span id="DFT.scf-1132"><a href="#DFT.scf-1132"><span class="linenos">1132</span></a>
</span><span id="DFT.scf-1133"><a href="#DFT.scf-1133"><span class="linenos">1133</span></a>                <span class="c1"># Get rid of temp variables</span>
</span><span id="DFT.scf-1134"><a href="#DFT.scf-1134"><span class="linenos">1134</span></a>                <span class="n">indices_temp</span><span class="o">=</span><span class="mi">0</span>
</span><span id="DFT.scf-1135"><a href="#DFT.scf-1135"><span class="linenos">1135</span></a>                <span class="n">ijk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1136"><a href="#DFT.scf-1136"><span class="linenos">1136</span></a>                
</span><span id="DFT.scf-1137"><a href="#DFT.scf-1137"><span class="linenos">1137</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of permanent array storing the significant indices of 4c2e ERI in GB &#39;</span><span class="p">,</span> <span class="n">indicesA</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesB</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesC</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="o">+</span><span class="n">indicesD</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1138"><a href="#DFT.scf-1138"><span class="linenos">1138</span></a>
</span><span id="DFT.scf-1139"><a href="#DFT.scf-1139"><span class="linenos">1139</span></a>                <span class="n">nsignificant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicesA</span><span class="p">)</span>
</span><span id="DFT.scf-1140"><a href="#DFT.scf-1140"><span class="linenos">1140</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements in the standard four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1141"><a href="#DFT.scf-1141"><span class="linenos">1141</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of elements after factoring in the 8-fold symmetry in the four-centered two electron ERI tensor: &#39;</span><span class="p">,</span> <span class="n">nints4c2e_sym8</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1142"><a href="#DFT.scf-1142"><span class="linenos">1142</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of significant quadruplets based on Schwarz inequality and 8-fold symmetry: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsignificant</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; or &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nsignificant</span><span class="o">/</span><span class="n">nints4c2e</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f original&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1143"><a href="#DFT.scf-1143"><span class="linenos">1143</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Schwarz screening done!&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1144"><a href="#DFT.scf-1144"><span class="linenos">1144</span></a>                <span class="n">durationSchwarz</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSchwarz</span>
</span><span id="DFT.scf-1145"><a href="#DFT.scf-1145"><span class="linenos">1145</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time taken for Schwarz screening &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSchwarz</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1146"><a href="#DFT.scf-1146"><span class="linenos">1146</span></a>
</span><span id="DFT.scf-1147"><a href="#DFT.scf-1147"><span class="linenos">1147</span></a>                <span class="n">ints4c2e</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">schwarz_helpers</span><span class="o">.</span><span class="n">rys_4c2e_tri_schwarz_sparse</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">indicesD</span><span class="p">)</span>
</span><span id="DFT.scf-1148"><a href="#DFT.scf-1148"><span class="linenos">1148</span></a>
</span><span id="DFT.scf-1149"><a href="#DFT.scf-1149"><span class="linenos">1149</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Density fitting case (3c2e, and 2c2e will be calculated)</span>
</span><span id="DFT.scf-1150"><a href="#DFT.scf-1150"><span class="linenos">1150</span></a>            <span class="n">H_temp</span><span class="p">,</span> <span class="n">V_temp</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">nsignificant</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">durationCoulomb</span> <span class="o">=</span> <span class="n">density_fitting_prelims_for_DFT_development</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">rys</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">)</span>
</span><span id="DFT.scf-1151"><a href="#DFT.scf-1151"><span class="linenos">1151</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">H_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-1152"><a href="#DFT.scf-1152"><span class="linenos">1152</span></a>                <span class="n">H</span> <span class="o">=</span> <span class="n">H_temp</span>
</span><span id="DFT.scf-1153"><a href="#DFT.scf-1153"><span class="linenos">1153</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">V_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-1154"><a href="#DFT.scf-1154"><span class="linenos">1154</span></a>                <span class="n">V</span> <span class="o">=</span> <span class="n">V_temp</span>
</span><span id="DFT.scf-1155"><a href="#DFT.scf-1155"><span class="linenos">1155</span></a>            <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT.scf-1156"><a href="#DFT.scf-1156"><span class="linenos">1156</span></a>                <span class="n">durationDF</span> <span class="o">+=</span> <span class="n">durationDF_cholesky</span>
</span><span id="DFT.scf-1157"><a href="#DFT.scf-1157"><span class="linenos">1157</span></a>
</span><span id="DFT.scf-1158"><a href="#DFT.scf-1158"><span class="linenos">1158</span></a>            
</span><span id="DFT.scf-1159"><a href="#DFT.scf-1159"><span class="linenos">1159</span></a>            
</span><span id="DFT.scf-1160"><a href="#DFT.scf-1160"><span class="linenos">1160</span></a>        
</span><span id="DFT.scf-1161"><a href="#DFT.scf-1161"><span class="linenos">1161</span></a>        
</span><span id="DFT.scf-1162"><a href="#DFT.scf-1162"><span class="linenos">1162</span></a>        <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="DFT.scf-1163"><a href="#DFT.scf-1163"><span class="linenos">1163</span></a>        <span class="n">durationgrids</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1164"><a href="#DFT.scf-1164"><span class="linenos">1164</span></a>
</span><span id="DFT.scf-1165"><a href="#DFT.scf-1165"><span class="linenos">1165</span></a>        <span class="k">if</span> <span class="n">grids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-1166"><a href="#DFT.scf-1166"><span class="linenos">1166</span></a>            <span class="n">startGrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1167"><a href="#DFT.scf-1167"><span class="linenos">1167</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating grids...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1168"><a href="#DFT.scf-1168"><span class="linenos">1168</span></a>            <span class="c1"># To get the same energies as PySCF (level=5) upto 1e-7 au, use the following settings</span>
</span><span id="DFT.scf-1169"><a href="#DFT.scf-1169"><span class="linenos">1169</span></a>            <span class="c1"># radial_precision = 1.0e-13</span>
</span><span id="DFT.scf-1170"><a href="#DFT.scf-1170"><span class="linenos">1170</span></a>            <span class="c1"># level=3</span>
</span><span id="DFT.scf-1171"><a href="#DFT.scf-1171"><span class="linenos">1171</span></a>            <span class="c1"># pruning by density with threshold = 1e-011</span>
</span><span id="DFT.scf-1172"><a href="#DFT.scf-1172"><span class="linenos">1172</span></a>            <span class="c1"># alpha_min and alpha_max corresponding to QZVP</span>
</span><span id="DFT.scf-1173"><a href="#DFT.scf-1173"><span class="linenos">1173</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids level: &#39;</span><span class="p">,</span> <span class="n">gridsLevel</span><span class="p">)</span>
</span><span id="DFT.scf-1174"><a href="#DFT.scf-1174"><span class="linenos">1174</span></a>            <span class="c1"># Generate grids for XC term</span>
</span><span id="DFT.scf-1175"><a href="#DFT.scf-1175"><span class="linenos">1175</span></a>            <span class="n">basisGrids</span> <span class="o">=</span> <span class="n">Basis</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span><span class="n">Basis</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s1">&#39;def2-QZVP&#39;</span><span class="p">)})</span>
</span><span id="DFT.scf-1176"><a href="#DFT.scf-1176"><span class="linenos">1176</span></a>            <span class="n">grids</span> <span class="o">=</span> <span class="n">Grids</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basisGrids</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">gridsLevel</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">)</span>
</span><span id="DFT.scf-1177"><a href="#DFT.scf-1177"><span class="linenos">1177</span></a>
</span><span id="DFT.scf-1178"><a href="#DFT.scf-1178"><span class="linenos">1178</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1179"><a href="#DFT.scf-1179"><span class="linenos">1179</span></a>            <span class="n">durationgrids</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids</span>
</span><span id="DFT.scf-1180"><a href="#DFT.scf-1180"><span class="linenos">1180</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1181"><a href="#DFT.scf-1181"><span class="linenos">1181</span></a>
</span><span id="DFT.scf-1182"><a href="#DFT.scf-1182"><span class="linenos">1182</span></a>            <span class="c1"># Begin pruning the grids based on density (rho)</span>
</span><span id="DFT.scf-1183"><a href="#DFT.scf-1183"><span class="linenos">1183</span></a>            <span class="c1"># Evaluate ao_values to calculate rho</span>
</span><span id="DFT.scf-1184"><a href="#DFT.scf-1184"><span class="linenos">1184</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Pruning generated grids by rho...</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1185"><a href="#DFT.scf-1185"><span class="linenos">1185</span></a>            <span class="n">startGrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1186"><a href="#DFT.scf-1186"><span class="linenos">1186</span></a>            <span class="n">threshold_rho</span> <span class="o">=</span> <span class="mf">1e-011</span>
</span><span id="DFT.scf-1187"><a href="#DFT.scf-1187"><span class="linenos">1187</span></a>            <span class="n">ngrids_temp</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.scf-1188"><a href="#DFT.scf-1188"><span class="linenos">1188</span></a>            <span class="n">ndeleted</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1189"><a href="#DFT.scf-1189"><span class="linenos">1189</span></a>            <span class="n">blocksize_temp</span> <span class="o">=</span> <span class="mi">50000</span>
</span><span id="DFT.scf-1190"><a href="#DFT.scf-1190"><span class="linenos">1190</span></a>            <span class="n">nblocks_temp</span> <span class="o">=</span> <span class="n">ngrids_temp</span><span class="o">//</span><span class="n">blocksize_temp</span>
</span><span id="DFT.scf-1191"><a href="#DFT.scf-1191"><span class="linenos">1191</span></a>            <span class="n">weightsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1192"><a href="#DFT.scf-1192"><span class="linenos">1192</span></a>            <span class="n">coordsNew</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1193"><a href="#DFT.scf-1193"><span class="linenos">1193</span></a>            <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks_temp</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.scf-1194"><a href="#DFT.scf-1194"><span class="linenos">1194</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize_temp</span>
</span><span id="DFT.scf-1195"><a href="#DFT.scf-1195"><span class="linenos">1195</span></a>                <span class="n">weights_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span>
</span><span id="DFT.scf-1196"><a href="#DFT.scf-1196"><span class="linenos">1196</span></a>                <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize_temp</span><span class="p">,</span><span class="n">ngrids_temp</span><span class="p">)]</span> 
</span><span id="DFT.scf-1197"><a href="#DFT.scf-1197"><span class="linenos">1197</span></a>                <span class="n">ao_value_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">)</span>  
</span><span id="DFT.scf-1198"><a href="#DFT.scf-1198"><span class="linenos">1198</span></a>                <span class="n">rho_block</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,mi,mj-&gt;m&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">,</span> <span class="n">ao_value_block</span><span class="p">)</span>
</span><span id="DFT.scf-1199"><a href="#DFT.scf-1199"><span class="linenos">1199</span></a>                <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rho_block</span><span class="o">*</span><span class="n">weights_block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold_rho</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.scf-1200"><a href="#DFT.scf-1200"><span class="linenos">1200</span></a>                <span class="n">ndeleted</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span>
</span><span id="DFT.scf-1201"><a href="#DFT.scf-1201"><span class="linenos">1201</span></a>                <span class="n">weightsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">weights_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">)</span>
</span><span id="DFT.scf-1202"><a href="#DFT.scf-1202"><span class="linenos">1202</span></a>                <span class="n">coordsNew_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">coords_block</span><span class="p">,</span> <span class="n">zero_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.scf-1203"><a href="#DFT.scf-1203"><span class="linenos">1203</span></a>                <span class="k">if</span> <span class="n">weightsNew_block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="DFT.scf-1204"><a href="#DFT.scf-1204"><span class="linenos">1204</span></a>                    <span class="k">if</span> <span class="n">weightsNew</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DFT.scf-1205"><a href="#DFT.scf-1205"><span class="linenos">1205</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">weightsNew_block</span>
</span><span id="DFT.scf-1206"><a href="#DFT.scf-1206"><span class="linenos">1206</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">coordsNew_block</span>
</span><span id="DFT.scf-1207"><a href="#DFT.scf-1207"><span class="linenos">1207</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1208"><a href="#DFT.scf-1208"><span class="linenos">1208</span></a>                        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weightsNew</span><span class="p">,</span> <span class="n">weightsNew_block</span><span class="p">))</span>
</span><span id="DFT.scf-1209"><a href="#DFT.scf-1209"><span class="linenos">1209</span></a>                        <span class="n">coordsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">coordsNew</span><span class="p">,</span> <span class="n">coordsNew_block</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DFT.scf-1210"><a href="#DFT.scf-1210"><span class="linenos">1210</span></a>
</span><span id="DFT.scf-1211"><a href="#DFT.scf-1211"><span class="linenos">1211</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coordsNew</span>
</span><span id="DFT.scf-1212"><a href="#DFT.scf-1212"><span class="linenos">1212</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weightsNew</span>
</span><span id="DFT.scf-1213"><a href="#DFT.scf-1213"><span class="linenos">1213</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1214"><a href="#DFT.scf-1214"><span class="linenos">1214</span></a>            <span class="n">durationgrids_prune_rho</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startGrids_prune_rho</span>
</span><span id="DFT.scf-1215"><a href="#DFT.scf-1215"><span class="linenos">1215</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationgrids_prune_rho</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1216"><a href="#DFT.scf-1216"><span class="linenos">1216</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Deleted &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ndeleted</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; grid points.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1217"><a href="#DFT.scf-1217"><span class="linenos">1217</span></a>            
</span><span id="DFT.scf-1218"><a href="#DFT.scf-1218"><span class="linenos">1218</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1219"><a href="#DFT.scf-1219"><span class="linenos">1219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Using the user supplied grids!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1220"><a href="#DFT.scf-1220"><span class="linenos">1220</span></a>        
</span><span id="DFT.scf-1221"><a href="#DFT.scf-1221"><span class="linenos">1221</span></a>
</span><span id="DFT.scf-1222"><a href="#DFT.scf-1222"><span class="linenos">1222</span></a>        <span class="c1"># Grid information initial</span>
</span><span id="DFT.scf-1223"><a href="#DFT.scf-1223"><span class="linenos">1223</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. of supplied/generated grid points: &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1224"><a href="#DFT.scf-1224"><span class="linenos">1224</span></a>
</span><span id="DFT.scf-1225"><a href="#DFT.scf-1225"><span class="linenos">1225</span></a>        <span class="c1"># Prune grids based on weights</span>
</span><span id="DFT.scf-1226"><a href="#DFT.scf-1226"><span class="linenos">1226</span></a>        <span class="c1"># start_pruning_weights = timer()</span>
</span><span id="DFT.scf-1227"><a href="#DFT.scf-1227"><span class="linenos">1227</span></a>        <span class="c1"># print(&#39;\nPruning grids based on weights....&#39;, flush=True)</span>
</span><span id="DFT.scf-1228"><a href="#DFT.scf-1228"><span class="linenos">1228</span></a>        <span class="c1"># zero_indices = np.where(np.logical_and(grids.weights&gt;=-1.0e-12, grids.weights&lt;=1.e-12))</span>
</span><span id="DFT.scf-1229"><a href="#DFT.scf-1229"><span class="linenos">1229</span></a>        <span class="c1"># grids.weights = np.delete(grids.weights, zero_indices)</span>
</span><span id="DFT.scf-1230"><a href="#DFT.scf-1230"><span class="linenos">1230</span></a>        <span class="c1"># grids.coords = np.delete(grids.coords, zero_indices, 0)</span>
</span><span id="DFT.scf-1231"><a href="#DFT.scf-1231"><span class="linenos">1231</span></a>        <span class="c1"># print(&#39;done!&#39;, flush=True)</span>
</span><span id="DFT.scf-1232"><a href="#DFT.scf-1232"><span class="linenos">1232</span></a>        <span class="c1"># duration_pruning_weights = timer() - start_pruning_weights</span>
</span><span id="DFT.scf-1233"><a href="#DFT.scf-1233"><span class="linenos">1233</span></a>        <span class="c1"># print(&#39;\nTime taken &#39;+str(duration_pruning_weights)+&#39; seconds.\n&#39;, flush=True)</span>
</span><span id="DFT.scf-1234"><a href="#DFT.scf-1234"><span class="linenos">1234</span></a>        <span class="c1"># print(&#39;\nNo. of grid points after screening by weights: &#39;, grids.coords.shape[0], flush=True)</span>
</span><span id="DFT.scf-1235"><a href="#DFT.scf-1235"><span class="linenos">1235</span></a>
</span><span id="DFT.scf-1236"><a href="#DFT.scf-1236"><span class="linenos">1236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the coordinates of grid:      &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1237"><a href="#DFT.scf-1237"><span class="linenos">1237</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the weights of grid:          &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1238"><a href="#DFT.scf-1238"><span class="linenos">1238</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (in GB) for storing the density at gridpoints:    &#39;</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1239"><a href="#DFT.scf-1239"><span class="linenos">1239</span></a>
</span><span id="DFT.scf-1240"><a href="#DFT.scf-1240"><span class="linenos">1240</span></a>        <span class="c1"># Sort the grids for slightly better performance with batching (doesn&#39;t seem to make much difference)</span>
</span><span id="DFT.scf-1241"><a href="#DFT.scf-1241"><span class="linenos">1241</span></a>        <span class="k">if</span> <span class="n">sortGrids</span><span class="p">:</span>
</span><span id="DFT.scf-1242"><a href="#DFT.scf-1242"><span class="linenos">1242</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Sorting grids ....&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1243"><a href="#DFT.scf-1243"><span class="linenos">1243</span></a>            <span class="c1"># Function to sort grids</span>
</span><span id="DFT.scf-1244"><a href="#DFT.scf-1244"><span class="linenos">1244</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">get_ordered_list</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="DFT.scf-1245"><a href="#DFT.scf-1245"><span class="linenos">1245</span></a>                <span class="n">points</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="DFT.scf-1246"><a href="#DFT.scf-1246"><span class="linenos">1246</span></a>                <span class="c1"># print(points[0:10])</span>
</span><span id="DFT.scf-1247"><a href="#DFT.scf-1247"><span class="linenos">1247</span></a>                <span class="k">return</span> <span class="n">points</span>
</span><span id="DFT.scf-1248"><a href="#DFT.scf-1248"><span class="linenos">1248</span></a>            <span class="c1"># Make a single array of coords and weights</span>
</span><span id="DFT.scf-1249"><a href="#DFT.scf-1249"><span class="linenos">1249</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
</span><span id="DFT.scf-1250"><a href="#DFT.scf-1250"><span class="linenos">1250</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_ordered_list</span><span class="p">(</span><span class="n">coords_weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])))</span>
</span><span id="DFT.scf-1251"><a href="#DFT.scf-1251"><span class="linenos">1251</span></a>            <span class="c1"># Now go back to two arrays for coords and weights</span>
</span><span id="DFT.scf-1252"><a href="#DFT.scf-1252"><span class="linenos">1252</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DFT.scf-1253"><a href="#DFT.scf-1253"><span class="linenos">1253</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords_weights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DFT.scf-1254"><a href="#DFT.scf-1254"><span class="linenos">1254</span></a>            <span class="n">coords_weights</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#None</span>
</span><span id="DFT.scf-1255"><a href="#DFT.scf-1255"><span class="linenos">1255</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1256"><a href="#DFT.scf-1256"><span class="linenos">1256</span></a>
</span><span id="DFT.scf-1257"><a href="#DFT.scf-1257"><span class="linenos">1257</span></a>        <span class="c1"># blocksize = 10000</span>
</span><span id="DFT.scf-1258"><a href="#DFT.scf-1258"><span class="linenos">1258</span></a>        <span class="n">ngrids</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DFT.scf-1259"><a href="#DFT.scf-1259"><span class="linenos">1259</span></a>        <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ngrids</span><span class="o">//</span><span class="n">blocksize</span>
</span><span id="DFT.scf-1260"><a href="#DFT.scf-1260"><span class="linenos">1260</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Will use batching to evaluate the XC term for memory efficiency.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1261"><a href="#DFT.scf-1261"><span class="linenos">1261</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch size: &#39;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1262"><a href="#DFT.scf-1262"><span class="linenos">1262</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of batches: &#39;</span><span class="p">,</span> <span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1263"><a href="#DFT.scf-1263"><span class="linenos">1263</span></a>
</span><span id="DFT.scf-1264"><a href="#DFT.scf-1264"><span class="linenos">1264</span></a>
</span><span id="DFT.scf-1265"><a href="#DFT.scf-1265"><span class="linenos">1265</span></a>        <span class="c1">#### Some preliminary stuff for XC evaluation</span>
</span><span id="DFT.scf-1266"><a href="#DFT.scf-1266"><span class="linenos">1266</span></a>        <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1267"><a href="#DFT.scf-1267"><span class="linenos">1267</span></a>        <span class="n">list_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1268"><a href="#DFT.scf-1268"><span class="linenos">1268</span></a>        <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1269"><a href="#DFT.scf-1269"><span class="linenos">1269</span></a>        <span class="n">list_ao_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1270"><a href="#DFT.scf-1270"><span class="linenos">1270</span></a>        <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1271"><a href="#DFT.scf-1271"><span class="linenos">1271</span></a>        <span class="k">if</span> <span class="n">xc_bf_screen</span><span class="p">:</span>
</span><span id="DFT.scf-1272"><a href="#DFT.scf-1272"><span class="linenos">1272</span></a>            <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="DFT.scf-1273"><a href="#DFT.scf-1273"><span class="linenos">1273</span></a>            <span class="c1"># Create a LibXC object  </span>
</span><span id="DFT.scf-1274"><a href="#DFT.scf-1274"><span class="linenos">1274</span></a>            <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT.scf-1275"><a href="#DFT.scf-1275"><span class="linenos">1275</span></a>            <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT.scf-1276"><a href="#DFT.scf-1276"><span class="linenos">1276</span></a>            <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT.scf-1277"><a href="#DFT.scf-1277"><span class="linenos">1277</span></a>            <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT.scf-1278"><a href="#DFT.scf-1278"><span class="linenos">1278</span></a>            <span class="c1">### Find the list of significanlty contributing bfs for xc evaluations</span>
</span><span id="DFT.scf-1279"><a href="#DFT.scf-1279"><span class="linenos">1279</span></a>            <span class="n">startXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1280"><a href="#DFT.scf-1280"><span class="linenos">1280</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Preliminary processing for XC term evaluations...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1281"><a href="#DFT.scf-1281"><span class="linenos">1281</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of basis functions (atomic orbitals) and get the indices of siginificantly contributing functions...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1282"><a href="#DFT.scf-1282"><span class="linenos">1282</span></a>            <span class="c1"># Calculate the value of basis functions for all grid points in batches</span>
</span><span id="DFT.scf-1283"><a href="#DFT.scf-1283"><span class="linenos">1283</span></a>            <span class="c1"># and find the indices of basis functions that have a significant contribution to those batches for each batch</span>
</span><span id="DFT.scf-1284"><a href="#DFT.scf-1284"><span class="linenos">1284</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1285"><a href="#DFT.scf-1285"><span class="linenos">1285</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">)</span>
</span><span id="DFT.scf-1286"><a href="#DFT.scf-1286"><span class="linenos">1286</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1287"><a href="#DFT.scf-1287"><span class="linenos">1287</span></a>                <span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">nonzero_ao_indices_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">ngrids</span><span class="p">,</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DFT.scf-1288"><a href="#DFT.scf-1288"><span class="linenos">1288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1289"><a href="#DFT.scf-1289"><span class="linenos">1289</span></a>            <span class="n">durationXCpreprocessing</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startXCpreprocessing</span>
</span><span id="DFT.scf-1290"><a href="#DFT.scf-1290"><span class="linenos">1290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationXCpreprocessing</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1291"><a href="#DFT.scf-1291"><span class="linenos">1291</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">))</span>
</span><span id="DFT.scf-1292"><a href="#DFT.scf-1292"><span class="linenos">1292</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average no. of basis functions contributing to a batch of grid points:   &#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="p">)))</span>
</span><span id="DFT.scf-1293"><a href="#DFT.scf-1293"><span class="linenos">1293</span></a>
</span><span id="DFT.scf-1294"><a href="#DFT.scf-1294"><span class="linenos">1294</span></a>            
</span><span id="DFT.scf-1295"><a href="#DFT.scf-1295"><span class="linenos">1295</span></a>            <span class="n">durationAO_values</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1296"><a href="#DFT.scf-1296"><span class="linenos">1296</span></a>            <span class="k">if</span> <span class="n">save_ao_values</span><span class="p">:</span>
</span><span id="DFT.scf-1297"><a href="#DFT.scf-1297"><span class="linenos">1297</span></a>                <span class="n">startAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1298"><a href="#DFT.scf-1298"><span class="linenos">1298</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">and</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="DFT.scf-1299"><a href="#DFT.scf-1299"><span class="linenos">1299</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1300"><a href="#DFT.scf-1300"><span class="linenos">1300</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="DFT.scf-1301"><a href="#DFT.scf-1301"><span class="linenos">1301</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1302"><a href="#DFT.scf-1302"><span class="linenos">1302</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1303"><a href="#DFT.scf-1303"><span class="linenos">1303</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.scf-1304"><a href="#DFT.scf-1304"><span class="linenos">1304</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="DFT.scf-1305"><a href="#DFT.scf-1305"><span class="linenos">1305</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.scf-1306"><a href="#DFT.scf-1306"><span class="linenos">1306</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="DFT.scf-1307"><a href="#DFT.scf-1307"><span class="linenos">1307</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="DFT.scf-1308"><a href="#DFT.scf-1308"><span class="linenos">1308</span></a>                        <span class="n">ao_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="DFT.scf-1309"><a href="#DFT.scf-1309"><span class="linenos">1309</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1310"><a href="#DFT.scf-1310"><span class="linenos">1310</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="DFT.scf-1311"><a href="#DFT.scf-1311"><span class="linenos">1311</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1312"><a href="#DFT.scf-1312"><span class="linenos">1312</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="DFT.scf-1313"><a href="#DFT.scf-1313"><span class="linenos">1313</span></a>                    <span class="c1">#Free memory </span>
</span><span id="DFT.scf-1314"><a href="#DFT.scf-1314"><span class="linenos">1314</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="DFT.scf-1315"><a href="#DFT.scf-1315"><span class="linenos">1315</span></a>                <span class="k">if</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span> <span class="ow">or</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;LDA&#39;</span><span class="p">:</span>
</span><span id="DFT.scf-1316"><a href="#DFT.scf-1316"><span class="linenos">1316</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have asked to save the values of significant basis functions and their gradients on grid points so as to avoid recalculation for each SCF cycle.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1317"><a href="#DFT.scf-1317"><span class="linenos">1317</span></a>                    <span class="n">memory_required</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">count_nonzero_indices</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>
</span><span id="DFT.scf-1318"><a href="#DFT.scf-1318"><span class="linenos">1318</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please note: This will require addtional memory that is approximately :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">memory_required</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; GB&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1319"><a href="#DFT.scf-1319"><span class="linenos">1319</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the value of significantly contributing basis functions (atomic orbitals)...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1320"><a href="#DFT.scf-1320"><span class="linenos">1320</span></a>                    <span class="n">list_ao_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.scf-1321"><a href="#DFT.scf-1321"><span class="linenos">1321</span></a>                    <span class="n">list_ao_grad_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DFT.scf-1322"><a href="#DFT.scf-1322"><span class="linenos">1322</span></a>                    <span class="c1"># Loop over batches</span>
</span><span id="DFT.scf-1323"><a href="#DFT.scf-1323"><span class="linenos">1323</span></a>                    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.scf-1324"><a href="#DFT.scf-1324"><span class="linenos">1324</span></a>                        <span class="n">offset</span> <span class="o">=</span> <span class="n">iblock</span><span class="o">*</span><span class="n">blocksize</span>
</span><span id="DFT.scf-1325"><a href="#DFT.scf-1325"><span class="linenos">1325</span></a>                        <span class="n">coords_block</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">blocksize</span><span class="p">,</span><span class="n">ngrids</span><span class="p">)]</span>   
</span><span id="DFT.scf-1326"><a href="#DFT.scf-1326"><span class="linenos">1326</span></a>                        <span class="c1"># ao_values_block = Integrals.bf_val_helpers.eval_bfs(basis, coords_block, parallel=True, non_zero_indices=list_nonzero_indices[iblock][0:count_nonzero_indices[iblock]])</span>
</span><span id="DFT.scf-1327"><a href="#DFT.scf-1327"><span class="linenos">1327</span></a>                        <span class="n">ao_values_block</span><span class="p">,</span> <span class="n">ao_grad_values_block</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">bf_val_helpers</span><span class="o">.</span><span class="n">eval_bfs_and_grad</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">coords_block</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">count_nonzero_indices</span><span class="p">[</span><span class="n">iblock</span><span class="p">]])</span>
</span><span id="DFT.scf-1328"><a href="#DFT.scf-1328"><span class="linenos">1328</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ao_in_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1329"><a href="#DFT.scf-1329"><span class="linenos">1329</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">))</span>
</span><span id="DFT.scf-1330"><a href="#DFT.scf-1330"><span class="linenos">1330</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">))</span>
</span><span id="DFT.scf-1331"><a href="#DFT.scf-1331"><span class="linenos">1331</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1332"><a href="#DFT.scf-1332"><span class="linenos">1332</span></a>                            <span class="n">list_ao_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_values_block</span><span class="p">)</span>
</span><span id="DFT.scf-1333"><a href="#DFT.scf-1333"><span class="linenos">1333</span></a>                            <span class="n">list_ao_grad_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ao_grad_values_block</span><span class="p">)</span>
</span><span id="DFT.scf-1334"><a href="#DFT.scf-1334"><span class="linenos">1334</span></a>                    <span class="c1">#Free memory </span>
</span><span id="DFT.scf-1335"><a href="#DFT.scf-1335"><span class="linenos">1335</span></a>                    <span class="n">ao_values_block</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="DFT.scf-1336"><a href="#DFT.scf-1336"><span class="linenos">1336</span></a>                    <span class="n">ao_grad_values_block</span> <span class="o">=</span><span class="mi">0</span>
</span><span id="DFT.scf-1337"><a href="#DFT.scf-1337"><span class="linenos">1337</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1338"><a href="#DFT.scf-1338"><span class="linenos">1338</span></a>                <span class="n">durationAO_values</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startAO_values</span>
</span><span id="DFT.scf-1339"><a href="#DFT.scf-1339"><span class="linenos">1339</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationAO_values</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1340"><a href="#DFT.scf-1340"><span class="linenos">1340</span></a>        
</span><span id="DFT.scf-1341"><a href="#DFT.scf-1341"><span class="linenos">1341</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1342"><a href="#DFT.scf-1342"><span class="linenos">1342</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT.scf-1343"><a href="#DFT.scf-1343"><span class="linenos">1343</span></a>            <span class="n">grids</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT.scf-1344"><a href="#DFT.scf-1344"><span class="linenos">1344</span></a>        
</span><span id="DFT.scf-1345"><a href="#DFT.scf-1345"><span class="linenos">1345</span></a>        <span class="c1">#-------XC Stuff start----------------------</span>
</span><span id="DFT.scf-1346"><a href="#DFT.scf-1346"><span class="linenos">1346</span></a>
</span><span id="DFT.scf-1347"><a href="#DFT.scf-1347"><span class="linenos">1347</span></a>        <span class="n">funcid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
</span><span id="DFT.scf-1348"><a href="#DFT.scf-1348"><span class="linenos">1348</span></a>
</span><span id="DFT.scf-1349"><a href="#DFT.scf-1349"><span class="linenos">1349</span></a>        <span class="n">xc_family_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;GGA&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;MGGA&#39;</span><span class="p">}</span> 
</span><span id="DFT.scf-1350"><a href="#DFT.scf-1350"><span class="linenos">1350</span></a>
</span><span id="DFT.scf-1351"><a href="#DFT.scf-1351"><span class="linenos">1351</span></a>        <span class="c1"># Create a LibXC object  </span>
</span><span id="DFT.scf-1352"><a href="#DFT.scf-1352"><span class="linenos">1352</span></a>        <span class="n">funcx</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT.scf-1353"><a href="#DFT.scf-1353"><span class="linenos">1353</span></a>        <span class="n">funcc</span> <span class="o">=</span> <span class="n">pylibxc</span><span class="o">.</span><span class="n">LibXCFunctional</span><span class="p">(</span><span class="n">funcid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
</span><span id="DFT.scf-1354"><a href="#DFT.scf-1354"><span class="linenos">1354</span></a>        <span class="n">x_family_code</span> <span class="o">=</span> <span class="n">funcx</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT.scf-1355"><a href="#DFT.scf-1355"><span class="linenos">1355</span></a>        <span class="n">c_family_code</span> <span class="o">=</span> <span class="n">funcc</span><span class="o">.</span><span class="n">get_family</span><span class="p">()</span>
</span><span id="DFT.scf-1356"><a href="#DFT.scf-1356"><span class="linenos">1356</span></a>
</span><span id="DFT.scf-1357"><a href="#DFT.scf-1357"><span class="linenos">1357</span></a>
</span><span id="DFT.scf-1358"><a href="#DFT.scf-1358"><span class="linenos">1358</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">------------------------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1359"><a href="#DFT.scf-1359"><span class="linenos">1359</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Functional&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1360"><a href="#DFT.scf-1360"><span class="linenos">1360</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1361"><a href="#DFT.scf-1361"><span class="linenos">1361</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XC Functional IDs supplied: &#39;</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1362"><a href="#DFT.scf-1362"><span class="linenos">1362</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of exchange functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1363"><a href="#DFT.scf-1363"><span class="linenos">1363</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Exchange function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">x_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1364"><a href="#DFT.scf-1364"><span class="linenos">1364</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcx</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="DFT.scf-1365"><a href="#DFT.scf-1365"><span class="linenos">1365</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Description of correlation functional: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1366"><a href="#DFT.scf-1366"><span class="linenos">1366</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; The Correlation function belongs to the family:&#39;</span><span class="p">,</span> <span class="n">xc_family_dict</span><span class="p">[</span><span class="n">c_family_code</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1367"><a href="#DFT.scf-1367"><span class="linenos">1367</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">funcc</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span><span id="DFT.scf-1368"><a href="#DFT.scf-1368"><span class="linenos">1368</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1369"><a href="#DFT.scf-1369"><span class="linenos">1369</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1370"><a href="#DFT.scf-1370"><span class="linenos">1370</span></a>        <span class="c1">#-------XC Stuff end----------------------</span>
</span><span id="DFT.scf-1371"><a href="#DFT.scf-1371"><span class="linenos">1371</span></a>
</span><span id="DFT.scf-1372"><a href="#DFT.scf-1372"><span class="linenos">1372</span></a>        <span class="n">Etot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1373"><a href="#DFT.scf-1373"><span class="linenos">1373</span></a>
</span><span id="DFT.scf-1374"><a href="#DFT.scf-1374"><span class="linenos">1374</span></a>        <span class="n">itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT.scf-1375"><a href="#DFT.scf-1375"><span class="linenos">1375</span></a>        <span class="n">Enn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuclear_rep_energy</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="DFT.scf-1376"><a href="#DFT.scf-1376"><span class="linenos">1376</span></a>        <span class="c1">#diis = scf.CDIIS()</span>
</span><span id="DFT.scf-1377"><a href="#DFT.scf-1377"><span class="linenos">1377</span></a>        <span class="n">dmat_old</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1378"><a href="#DFT.scf-1378"><span class="linenos">1378</span></a>        <span class="n">J_diff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1379"><a href="#DFT.scf-1379"><span class="linenos">1379</span></a>        <span class="n">Ecoul</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1380"><a href="#DFT.scf-1380"><span class="linenos">1380</span></a>        <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="DFT.scf-1381"><a href="#DFT.scf-1381"><span class="linenos">1381</span></a>
</span><span id="DFT.scf-1382"><a href="#DFT.scf-1382"><span class="linenos">1382</span></a>        <span class="n">durationxc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DFT.scf-1383"><a href="#DFT.scf-1383"><span class="linenos">1383</span></a>
</span><span id="DFT.scf-1384"><a href="#DFT.scf-1384"><span class="linenos">1384</span></a>        <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1385"><a href="#DFT.scf-1385"><span class="linenos">1385</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT.scf-1386"><a href="#DFT.scf-1386"><span class="linenos">1386</span></a>            <span class="c1">#########</span>
</span><span id="DFT.scf-1387"><a href="#DFT.scf-1387"><span class="linenos">1387</span></a>            <span class="c1"># I use a trick to calculate the DFT energy in SAO basis. </span>
</span><span id="DFT.scf-1388"><a href="#DFT.scf-1388"><span class="linenos">1388</span></a>            <span class="c1"># The trick is to get rid of the extra information in the CAO basis matrices.</span>
</span><span id="DFT.scf-1389"><a href="#DFT.scf-1389"><span class="linenos">1389</span></a>            <span class="c1"># The following does just that. </span>
</span><span id="DFT.scf-1390"><a href="#DFT.scf-1390"><span class="linenos">1390</span></a>            <span class="c1"># Going from CAO --&gt; SAO we lose the extra information then we go back to from SAO --&gt; CAO</span>
</span><span id="DFT.scf-1391"><a href="#DFT.scf-1391"><span class="linenos">1391</span></a>            <span class="c1"># This way all the integrals (potential matrices and density matrices) can still be calculated</span>
</span><span id="DFT.scf-1392"><a href="#DFT.scf-1392"><span class="linenos">1392</span></a>            <span class="c1"># in the CAO basis. In fact even the KS matrix is diagonalized in the CAO basis with the extra information </span>
</span><span id="DFT.scf-1393"><a href="#DFT.scf-1393"><span class="linenos">1393</span></a>            <span class="c1"># removed by forward and backward transformation: CAO --&gt; SAO followed by SAO --&gt; CAO.</span>
</span><span id="DFT.scf-1394"><a href="#DFT.scf-1394"><span class="linenos">1394</span></a>            <span class="c1"># This also helps in reducing the number of transformations needed for calculation of various energy contributions.</span>
</span><span id="DFT.scf-1395"><a href="#DFT.scf-1395"><span class="linenos">1395</span></a>            <span class="c1">#########</span>
</span><span id="DFT.scf-1396"><a href="#DFT.scf-1396"><span class="linenos">1396</span></a>            <span class="c1"># Convert the overlap matrix from CAO to SAO basis</span>
</span><span id="DFT.scf-1397"><a href="#DFT.scf-1397"><span class="linenos">1397</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT.scf-1398"><a href="#DFT.scf-1398"><span class="linenos">1398</span></a>            <span class="c1"># Convert back to SAO so that now we lose the extra information that the CAO basis had</span>
</span><span id="DFT.scf-1399"><a href="#DFT.scf-1399"><span class="linenos">1399</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="DFT.scf-1400"><a href="#DFT.scf-1400"><span class="linenos">1400</span></a>        <span class="k">if</span> <span class="n">orthogonalize</span><span class="p">:</span>
</span><span id="DFT.scf-1401"><a href="#DFT.scf-1401"><span class="linenos">1401</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1402"><a href="#DFT.scf-1402"><span class="linenos">1402</span></a>                <span class="n">eig_val_s</span><span class="p">,</span> <span class="n">eig_vec_s</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="DFT.scf-1403"><a href="#DFT.scf-1403"><span class="linenos">1403</span></a>                <span class="c1"># Removing the eigenvectors assoicated to the smallest eigenvalue.</span>
</span><span id="DFT.scf-1404"><a href="#DFT.scf-1404"><span class="linenos">1404</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">eig_vec_s</span><span class="p">[:,</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eig_val_s</span><span class="p">[</span><span class="n">eig_val_s</span><span class="o">&gt;</span><span class="mf">1e-7</span><span class="p">])</span>
</span><span id="DFT.scf-1405"><a href="#DFT.scf-1405"><span class="linenos">1405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1406"><a href="#DFT.scf-1406"><span class="linenos">1406</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DFT.scf-1407"><a href="#DFT.scf-1407"><span class="linenos">1407</span></a>        <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="DFT.scf-1408"><a href="#DFT.scf-1408"><span class="linenos">1408</span></a>        
</span><span id="DFT.scf-1409"><a href="#DFT.scf-1409"><span class="linenos">1409</span></a>
</span><span id="DFT.scf-1410"><a href="#DFT.scf-1410"><span class="linenos">1410</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">scf_converged</span> <span class="ow">or</span> <span class="n">itr</span><span class="o">==</span><span class="n">max_itr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="DFT.scf-1411"><a href="#DFT.scf-1411"><span class="linenos">1411</span></a>            <span class="n">startIter</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1412"><a href="#DFT.scf-1412"><span class="linenos">1412</span></a>            <span class="k">if</span> <span class="n">itr</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT.scf-1413"><a href="#DFT.scf-1413"><span class="linenos">1413</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT.scf-1414"><a href="#DFT.scf-1414"><span class="linenos">1414</span></a>                <span class="c1"># Coulomb (Hartree) matrix</span>
</span><span id="DFT.scf-1415"><a href="#DFT.scf-1415"><span class="linenos">1415</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-1416"><a href="#DFT.scf-1416"><span class="linenos">1416</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span><span class="n">ints4c2e</span><span class="p">,</span><span class="n">dmat</span><span class="p">)</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT.scf-1417"><a href="#DFT.scf-1417"><span class="linenos">1417</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1418"><a href="#DFT.scf-1418"><span class="linenos">1418</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="DFT.scf-1419"><a href="#DFT.scf-1419"><span class="linenos">1419</span></a>
</span><span id="DFT.scf-1420"><a href="#DFT.scf-1420"><span class="linenos">1420</span></a>
</span><span id="DFT.scf-1421"><a href="#DFT.scf-1421"><span class="linenos">1421</span></a>                    
</span><span id="DFT.scf-1422"><a href="#DFT.scf-1422"><span class="linenos">1422</span></a>                
</span><span id="DFT.scf-1423"><a href="#DFT.scf-1423"><span class="linenos">1423</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1424"><a href="#DFT.scf-1424"><span class="linenos">1424</span></a>                <span class="n">dmat_diff</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">-</span><span class="n">dmat_old</span>
</span><span id="DFT.scf-1425"><a href="#DFT.scf-1425"><span class="linenos">1425</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-1426"><a href="#DFT.scf-1426"><span class="linenos">1426</span></a>                    <span class="c1"># J_diff = contract(&#39;ijkl,ij&#39;,ints4c2e,dmat_diff)</span>
</span><span id="DFT.scf-1427"><a href="#DFT.scf-1427"><span class="linenos">1427</span></a>                    <span class="c1"># J += J_diff</span>
</span><span id="DFT.scf-1428"><a href="#DFT.scf-1428"><span class="linenos">1428</span></a>                    <span class="n">J</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl,ij&#39;</span><span class="p">,</span> <span class="n">ints4c2e</span><span class="p">,</span> <span class="n">dmat</span><span class="p">)</span>
</span><span id="DFT.scf-1429"><a href="#DFT.scf-1429"><span class="linenos">1429</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1430"><a href="#DFT.scf-1430"><span class="linenos">1430</span></a>                    <span class="n">J</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">Ecoul_temp</span> <span class="o">=</span> <span class="n">Jmat_from_density_fitting</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">DF_algo</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">cho_decomp_ints2c2e</span><span class="p">,</span> <span class="n">df_coeff0</span><span class="p">,</span> <span class="n">Qpq</span><span class="p">,</span> <span class="n">ints3c2e</span><span class="p">,</span> <span class="n">ints2c2e</span><span class="p">,</span> <span class="n">indices_dmat_tri</span><span class="p">,</span> <span class="n">indices_dmat_tri_2</span><span class="p">,</span> <span class="n">indicesA</span><span class="p">,</span> <span class="n">indicesB</span><span class="p">,</span> <span class="n">indicesC</span><span class="p">,</span> <span class="n">offsets_3c2e</span><span class="p">,</span> <span class="n">sqrt_ints4c2e_diag</span><span class="p">,</span> <span class="n">sqrt_diag_ints2c2e</span><span class="p">,</span> <span class="n">threshold_schwarz</span><span class="p">,</span> <span class="n">strict_schwarz</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_ints3c2e_in_gpu</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">ncores</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">)</span>
</span><span id="DFT.scf-1431"><a href="#DFT.scf-1431"><span class="linenos">1431</span></a>                <span class="c1"># J += J_diff</span>
</span><span id="DFT.scf-1432"><a href="#DFT.scf-1432"><span class="linenos">1432</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1433"><a href="#DFT.scf-1433"><span class="linenos">1433</span></a>                <span class="n">J</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT.scf-1434"><a href="#DFT.scf-1434"><span class="linenos">1434</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1435"><a href="#DFT.scf-1435"><span class="linenos">1435</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1436"><a href="#DFT.scf-1436"><span class="linenos">1436</span></a>            
</span><span id="DFT.scf-1437"><a href="#DFT.scf-1437"><span class="linenos">1437</span></a>                
</span><span id="DFT.scf-1438"><a href="#DFT.scf-1438"><span class="linenos">1438</span></a>            <span class="c1"># XC energy and potential</span>
</span><span id="DFT.scf-1439"><a href="#DFT.scf-1439"><span class="linenos">1439</span></a>            <span class="n">startxc</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1440"><a href="#DFT.scf-1440"><span class="linenos">1440</span></a>
</span><span id="DFT.scf-1441"><a href="#DFT.scf-1441"><span class="linenos">1441</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1442"><a href="#DFT.scf-1442"><span class="linenos">1442</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT.scf-1443"><a href="#DFT.scf-1443"><span class="linenos">1443</span></a>                    <span class="c1"># Much slower than JOBLIB version</span>
</span><span id="DFT.scf-1444"><a href="#DFT.scf-1444"><span class="linenos">1444</span></a>                    <span class="c1"># Still keeping it because, it can be useful when using GPUs</span>
</span><span id="DFT.scf-1445"><a href="#DFT.scf-1445"><span class="linenos">1445</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT.scf-1446"><a href="#DFT.scf-1446"><span class="linenos">1446</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1447"><a href="#DFT.scf-1447"><span class="linenos">1447</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">)</span>
</span><span id="DFT.scf-1448"><a href="#DFT.scf-1448"><span class="linenos">1448</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="DFT.scf-1449"><a href="#DFT.scf-1449"><span class="linenos">1449</span></a>                    <span class="c1"># Much faster than above and stable too, therefore this should be default now.</span>
</span><span id="DFT.scf-1450"><a href="#DFT.scf-1450"><span class="linenos">1450</span></a>                    <span class="c1"># Used to unstable and had memory leaks,</span>
</span><span id="DFT.scf-1451"><a href="#DFT.scf-1451"><span class="linenos">1451</span></a>                    <span class="c1"># But now all that is fixed by using threadpoolctl, garbage collection or freeing up memory after XC evaluation at each iteration</span>
</span><span id="DFT.scf-1452"><a href="#DFT.scf-1452"><span class="linenos">1452</span></a>                    
</span><span id="DFT.scf-1453"><a href="#DFT.scf-1453"><span class="linenos">1453</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT.scf-1454"><a href="#DFT.scf-1454"><span class="linenos">1454</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1455"><a href="#DFT.scf-1455"><span class="linenos">1455</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT.scf-1456"><a href="#DFT.scf-1456"><span class="linenos">1456</span></a>                    
</span><span id="DFT.scf-1457"><a href="#DFT.scf-1457"><span class="linenos">1457</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="DFT.scf-1458"><a href="#DFT.scf-1458"><span class="linenos">1458</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT.scf-1459"><a href="#DFT.scf-1459"><span class="linenos">1459</span></a>                        <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT.scf-1460"><a href="#DFT.scf-1460"><span class="linenos">1460</span></a>                                                    <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1461"><a href="#DFT.scf-1461"><span class="linenos">1461</span></a>                                                        <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT.scf-1462"><a href="#DFT.scf-1462"><span class="linenos">1462</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># GPU</span>
</span><span id="DFT.scf-1463"><a href="#DFT.scf-1463"><span class="linenos">1463</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="DFT.scf-1464"><a href="#DFT.scf-1464"><span class="linenos">1464</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_1_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT.scf-1465"><a href="#DFT.scf-1465"><span class="linenos">1465</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1466"><a href="#DFT.scf-1466"><span class="linenos">1466</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="DFT.scf-1467"><a href="#DFT.scf-1467"><span class="linenos">1467</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="DFT.scf-1468"><a href="#DFT.scf-1468"><span class="linenos">1468</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">)</span>
</span><span id="DFT.scf-1469"><a href="#DFT.scf-1469"><span class="linenos">1469</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="DFT.scf-1470"><a href="#DFT.scf-1470"><span class="linenos">1470</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_2_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> \
</span><span id="DFT.scf-1471"><a href="#DFT.scf-1471"><span class="linenos">1471</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1472"><a href="#DFT.scf-1472"><span class="linenos">1472</span></a>                                                    <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="DFT.scf-1473"><a href="#DFT.scf-1473"><span class="linenos">1473</span></a>                <span class="k">if</span> <span class="n">XC_algo</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="DFT.scf-1474"><a href="#DFT.scf-1474"><span class="linenos">1474</span></a>                    <span class="c1"># Default for GPUs</span>
</span><span id="DFT.scf-1475"><a href="#DFT.scf-1475"><span class="linenos">1475</span></a>                    <span class="n">Exc</span><span class="p">,</span> <span class="n">Vxc</span> <span class="o">=</span> <span class="n">Integrals</span><span class="o">.</span><span class="n">eval_xc_3_cupy</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">grids</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">funcid</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> \
</span><span id="DFT.scf-1476"><a href="#DFT.scf-1476"><span class="linenos">1476</span></a>                                                <span class="n">list_nonzero_indices</span><span class="o">=</span><span class="n">list_nonzero_indices</span><span class="p">,</span> <span class="n">count_nonzero_indices</span><span class="o">=</span><span class="n">count_nonzero_indices</span><span class="p">,</span> \
</span><span id="DFT.scf-1477"><a href="#DFT.scf-1477"><span class="linenos">1477</span></a>                                                <span class="n">list_ao_values</span><span class="o">=</span><span class="n">list_ao_values</span><span class="p">,</span> <span class="n">list_ao_grad_values</span><span class="o">=</span><span class="n">list_ao_grad_values</span><span class="p">,</span> <span class="n">use_libxc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_libxc</span><span class="p">,</span>\
</span><span id="DFT.scf-1478"><a href="#DFT.scf-1478"><span class="linenos">1478</span></a>                                                <span class="n">nstreams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">ngpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">,</span> <span class="n">freemem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_gpu_mem</span><span class="p">,</span> <span class="n">threads_per_block</span><span class="o">=</span><span class="n">threads_per_block</span><span class="p">,</span>
</span><span id="DFT.scf-1479"><a href="#DFT.scf-1479"><span class="linenos">1479</span></a>                                                <span class="nb">type</span><span class="o">=</span><span class="n">precision_XC</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="n">streams</span><span class="p">,</span> <span class="n">nb_streams</span><span class="o">=</span><span class="n">nb_streams</span><span class="p">)</span>
</span><span id="DFT.scf-1480"><a href="#DFT.scf-1480"><span class="linenos">1480</span></a>
</span><span id="DFT.scf-1481"><a href="#DFT.scf-1481"><span class="linenos">1481</span></a>                <span class="n">Vxc</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Vxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="DFT.scf-1482"><a href="#DFT.scf-1482"><span class="linenos">1482</span></a>
</span><span id="DFT.scf-1483"><a href="#DFT.scf-1483"><span class="linenos">1483</span></a>            <span class="n">durationxc</span> <span class="o">=</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startxc</span>
</span><span id="DFT.scf-1484"><a href="#DFT.scf-1484"><span class="linenos">1484</span></a>
</span><span id="DFT.scf-1485"><a href="#DFT.scf-1485"><span class="linenos">1485</span></a>            
</span><span id="DFT.scf-1486"><a href="#DFT.scf-1486"><span class="linenos">1486</span></a>            <span class="n">dmat_old</span> <span class="o">=</span> <span class="n">dmat</span> <span class="c1"># This is in CAO basis</span>
</span><span id="DFT.scf-1487"><a href="#DFT.scf-1487"><span class="linenos">1487</span></a>
</span><span id="DFT.scf-1488"><a href="#DFT.scf-1488"><span class="linenos">1488</span></a>
</span><span id="DFT.scf-1489"><a href="#DFT.scf-1489"><span class="linenos">1489</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1490"><a href="#DFT.scf-1490"><span class="linenos">1490</span></a>                <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="DFT.scf-1491"><a href="#DFT.scf-1491"><span class="linenos">1491</span></a>                <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="DFT.scf-1492"><a href="#DFT.scf-1492"><span class="linenos">1492</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="DFT.scf-1493"><a href="#DFT.scf-1493"><span class="linenos">1493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1494"><a href="#DFT.scf-1494"><span class="linenos">1494</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT.scf-1495"><a href="#DFT.scf-1495"><span class="linenos">1495</span></a>                    <span class="c1"># print(&#39;Energy contractions&#39;, controller.info())</span>
</span><span id="DFT.scf-1496"><a href="#DFT.scf-1496"><span class="linenos">1496</span></a>                    <span class="n">Enuc</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="DFT.scf-1497"><a href="#DFT.scf-1497"><span class="linenos">1497</span></a>                    <span class="n">Ekin</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</span><span id="DFT.scf-1498"><a href="#DFT.scf-1498"><span class="linenos">1498</span></a>                    <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</span><span id="DFT.scf-1499"><a href="#DFT.scf-1499"><span class="linenos">1499</span></a>            <span class="k">if</span> <span class="n">isDF</span> <span class="ow">and</span> <span class="p">(</span><span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DFT.scf-1500"><a href="#DFT.scf-1500"><span class="linenos">1500</span></a>                <span class="n">Ecoul</span> <span class="o">=</span> <span class="n">Ecoul</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Ecoul_temp</span> <span class="c1"># This is the correct formula for Coulomb energy with DF</span>
</span><span id="DFT.scf-1501"><a href="#DFT.scf-1501"><span class="linenos">1501</span></a>
</span><span id="DFT.scf-1502"><a href="#DFT.scf-1502"><span class="linenos">1502</span></a>            <span class="n">Etot_new</span> <span class="o">=</span> <span class="n">Exc</span> <span class="o">+</span> <span class="n">Enuc</span> <span class="o">+</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">Enn</span> <span class="o">+</span> <span class="n">Ecoul</span>
</span><span id="DFT.scf-1503"><a href="#DFT.scf-1503"><span class="linenos">1503</span></a>
</span><span id="DFT.scf-1504"><a href="#DFT.scf-1504"><span class="linenos">1504</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">------Iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;--------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1505"><a href="#DFT.scf-1505"><span class="linenos">1505</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energies&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1506"><a href="#DFT.scf-1506"><span class="linenos">1506</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electron-Nuclear Energy      &#39;</span><span class="p">,</span> <span class="n">Enuc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1507"><a href="#DFT.scf-1507"><span class="linenos">1507</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nuclear repulsion Energy     &#39;</span><span class="p">,</span> <span class="n">Enn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1508"><a href="#DFT.scf-1508"><span class="linenos">1508</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kinetic Energy               &#39;</span><span class="p">,</span> <span class="n">Ekin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1509"><a href="#DFT.scf-1509"><span class="linenos">1509</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Energy               &#39;</span><span class="p">,</span> <span class="n">Ecoul</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1510"><a href="#DFT.scf-1510"><span class="linenos">1510</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Energy  &#39;</span><span class="p">,</span> <span class="n">Exc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1511"><a href="#DFT.scf-1511"><span class="linenos">1511</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------&#39;</span><span class="p">)</span>
</span><span id="DFT.scf-1512"><a href="#DFT.scf-1512"><span class="linenos">1512</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy &#39;</span><span class="p">,</span><span class="n">Etot_new</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1513"><a href="#DFT.scf-1513"><span class="linenos">1513</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1514"><a href="#DFT.scf-1514"><span class="linenos">1514</span></a>
</span><span id="DFT.scf-1515"><a href="#DFT.scf-1515"><span class="linenos">1515</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Energy difference : &#39;</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1516"><a href="#DFT.scf-1516"><span class="linenos">1516</span></a>
</span><span id="DFT.scf-1517"><a href="#DFT.scf-1517"><span class="linenos">1517</span></a>            
</span><span id="DFT.scf-1518"><a href="#DFT.scf-1518"><span class="linenos">1518</span></a>
</span><span id="DFT.scf-1519"><a href="#DFT.scf-1519"><span class="linenos">1519</span></a>
</span><span id="DFT.scf-1520"><a href="#DFT.scf-1520"><span class="linenos">1520</span></a>            <span class="n">KS</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">J</span> <span class="o">+</span> <span class="n">Vxc</span> 
</span><span id="DFT.scf-1521"><a href="#DFT.scf-1521"><span class="linenos">1521</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sao</span><span class="p">:</span>
</span><span id="DFT.scf-1522"><a href="#DFT.scf-1522"><span class="linenos">1522</span></a>                <span class="c1"># The following gets rid of the extra information in the CAO basis KS matrix by going to SAO and then back to CAO.</span>
</span><span id="DFT.scf-1523"><a href="#DFT.scf-1523"><span class="linenos">1523</span></a>                <span class="c1"># This way even though the matrix dimensions would be that of CAO but the information would be the same as SAO</span>
</span><span id="DFT.scf-1524"><a href="#DFT.scf-1524"><span class="linenos">1524</span></a>                <span class="c1"># leading to the same energy as SAO basis PySCF or TURBOMOLE calculations</span>
</span><span id="DFT.scf-1525"><a href="#DFT.scf-1525"><span class="linenos">1525</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c2sph_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">c2sph_mat</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1"># CAO --&gt; SAO</span>
</span><span id="DFT.scf-1526"><a href="#DFT.scf-1526"><span class="linenos">1526</span></a>                <span class="n">KS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sph2c_mat_pseudo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">sph2c_mat_pseudo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="c1">#SAO --&gt; CAO</span>
</span><span id="DFT.scf-1527"><a href="#DFT.scf-1527"><span class="linenos">1527</span></a>                
</span><span id="DFT.scf-1528"><a href="#DFT.scf-1528"><span class="linenos">1528</span></a>
</span><span id="DFT.scf-1529"><a href="#DFT.scf-1529"><span class="linenos">1529</span></a>            <span class="c1">#### DIIS</span>
</span><span id="DFT.scf-1530"><a href="#DFT.scf-1530"><span class="linenos">1530</span></a>            <span class="n">startDIIS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1531"><a href="#DFT.scf-1531"><span class="linenos">1531</span></a>            <span class="n">diis_start_itr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DFT.scf-1532"><a href="#DFT.scf-1532"><span class="linenos">1532</span></a>            <span class="k">if</span> <span class="n">itr</span> <span class="o">&gt;=</span> <span class="n">diis_start_itr</span><span class="p">:</span>
</span><span id="DFT.scf-1533"><a href="#DFT.scf-1533"><span class="linenos">1533</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1534"><a href="#DFT.scf-1534"><span class="linenos">1534</span></a>                    <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT.scf-1535"><a href="#DFT.scf-1535"><span class="linenos">1535</span></a>                        <span class="c1"># print(&#39;DIIS &#39;, controller.info())</span>
</span><span id="DFT.scf-1536"><a href="#DFT.scf-1536"><span class="linenos">1536</span></a>                        <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="DFT.scf-1537"><a href="#DFT.scf-1537"><span class="linenos">1537</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1538"><a href="#DFT.scf-1538"><span class="linenos">1538</span></a>                    <span class="n">KS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIIS_cupy</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dmat_cp</span><span class="p">,</span> <span class="n">KS</span><span class="p">)</span>
</span><span id="DFT.scf-1539"><a href="#DFT.scf-1539"><span class="linenos">1539</span></a>                    <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1540"><a href="#DFT.scf-1540"><span class="linenos">1540</span></a>                    <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1541"><a href="#DFT.scf-1541"><span class="linenos">1541</span></a>            <span class="n">durationDIIS</span> <span class="o">=</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startDIIS</span>
</span><span id="DFT.scf-1542"><a href="#DFT.scf-1542"><span class="linenos">1542</span></a>
</span><span id="DFT.scf-1543"><a href="#DFT.scf-1543"><span class="linenos">1543</span></a>            <span class="c1">#### Solve KS equation (Diagonalize KS matrix)</span>
</span><span id="DFT.scf-1544"><a href="#DFT.scf-1544"><span class="linenos">1544</span></a>            <span class="n">startKS</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</span><span id="DFT.scf-1545"><a href="#DFT.scf-1545"><span class="linenos">1545</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1546"><a href="#DFT.scf-1546"><span class="linenos">1546</span></a>                <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_cupy</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Orthogonalization is necessary with CUDA</span>
</span><span id="DFT.scf-1547"><a href="#DFT.scf-1547"><span class="linenos">1547</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc_cupy</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT.scf-1548"><a href="#DFT.scf-1548"><span class="linenos">1548</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm_cupy</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT.scf-1549"><a href="#DFT.scf-1549"><span class="linenos">1549</span></a>                <span class="n">dmat_cp</span> <span class="o">=</span> <span class="n">dmat</span>
</span><span id="DFT.scf-1550"><a href="#DFT.scf-1550"><span class="linenos">1550</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">dmat</span><span class="p">)</span>
</span><span id="DFT.scf-1551"><a href="#DFT.scf-1551"><span class="linenos">1551</span></a>                <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1552"><a href="#DFT.scf-1552"><span class="linenos">1552</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="o">.</span><span class="n">null</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="DFT.scf-1553"><a href="#DFT.scf-1553"><span class="linenos">1553</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DFT.scf-1554"><a href="#DFT.scf-1554"><span class="linenos">1554</span></a>                <span class="k">with</span> <span class="n">threadpool_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">ncores</span><span class="p">,</span> <span class="n">user_api</span><span class="o">=</span><span class="s1">&#39;blas&#39;</span><span class="p">):</span>
</span><span id="DFT.scf-1555"><a href="#DFT.scf-1555"><span class="linenos">1555</span></a>                    <span class="c1"># print(&#39;KS eigh&#39;, controller.info())</span>
</span><span id="DFT.scf-1556"><a href="#DFT.scf-1556"><span class="linenos">1556</span></a>                    <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">KS</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">orthogonalize</span><span class="o">=</span><span class="n">orthogonalize</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</span><span id="DFT.scf-1557"><a href="#DFT.scf-1557"><span class="linenos">1557</span></a>                <span class="n">mo_occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOcc</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">eigvalues</span><span class="p">,</span> <span class="n">eigvectors</span><span class="p">)</span>
</span><span id="DFT.scf-1558"><a href="#DFT.scf-1558"><span class="linenos">1558</span></a>                <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_dm</span><span class="p">(</span><span class="n">eigvectors</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
</span><span id="DFT.scf-1559"><a href="#DFT.scf-1559"><span class="linenos">1559</span></a>            <span class="n">durationKS</span> <span class="o">=</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startKS</span>
</span><span id="DFT.scf-1560"><a href="#DFT.scf-1560"><span class="linenos">1560</span></a>
</span><span id="DFT.scf-1561"><a href="#DFT.scf-1561"><span class="linenos">1561</span></a>            <span class="c1"># Check when to switch to double precision for XC</span>
</span><span id="DFT.scf-1562"><a href="#DFT.scf-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1563"><a href="#DFT.scf-1563"><span class="linenos">1563</span></a>                <span class="k">if</span> <span class="n">precision_XC</span> <span class="ow">is</span> <span class="n">cp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
</span><span id="DFT.scf-1564"><a href="#DFT.scf-1564"><span class="linenos">1564</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">5e-7</span><span class="p">:</span>
</span><span id="DFT.scf-1565"><a href="#DFT.scf-1565"><span class="linenos">1565</span></a>                        <span class="n">precision_XC</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">float64</span>
</span><span id="DFT.scf-1566"><a href="#DFT.scf-1566"><span class="linenos">1566</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Switching to double precision for XC evaluation after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1567"><a href="#DFT.scf-1567"><span class="linenos">1567</span></a>                        
</span><span id="DFT.scf-1568"><a href="#DFT.scf-1568"><span class="linenos">1568</span></a>
</span><span id="DFT.scf-1569"><a href="#DFT.scf-1569"><span class="linenos">1569</span></a>
</span><span id="DFT.scf-1570"><a href="#DFT.scf-1570"><span class="linenos">1570</span></a>            <span class="n">durationItr</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startIter</span>
</span><span id="DFT.scf-1571"><a href="#DFT.scf-1571"><span class="linenos">1571</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Time taken for the previous iteration: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationItr</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1572"><a href="#DFT.scf-1572"><span class="linenos">1572</span></a>
</span><span id="DFT.scf-1573"><a href="#DFT.scf-1573"><span class="linenos">1573</span></a>            <span class="c1"># Check convergence criteria</span>
</span><span id="DFT.scf-1574"><a href="#DFT.scf-1574"><span class="linenos">1574</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Etot_new</span><span class="o">-</span><span class="n">Etot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">conv_crit</span><span class="p">:</span>
</span><span id="DFT.scf-1575"><a href="#DFT.scf-1575"><span class="linenos">1575</span></a>                <span class="n">scf_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="DFT.scf-1576"><a href="#DFT.scf-1576"><span class="linenos">1576</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1577"><a href="#DFT.scf-1577"><span class="linenos">1577</span></a>                <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="DFT.scf-1578"><a href="#DFT.scf-1578"><span class="linenos">1578</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1579"><a href="#DFT.scf-1579"><span class="linenos">1579</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total Energy = &#39;</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1580"><a href="#DFT.scf-1580"><span class="linenos">1580</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1581"><a href="#DFT.scf-1581"><span class="linenos">1581</span></a>                <span class="k">break</span>
</span><span id="DFT.scf-1582"><a href="#DFT.scf-1582"><span class="linenos">1582</span></a>
</span><span id="DFT.scf-1583"><a href="#DFT.scf-1583"><span class="linenos">1583</span></a>            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot_new</span>
</span><span id="DFT.scf-1584"><a href="#DFT.scf-1584"><span class="linenos">1584</span></a>            <span class="n">itr</span> <span class="o">=</span> <span class="n">itr</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="DFT.scf-1585"><a href="#DFT.scf-1585"><span class="linenos">1585</span></a>            
</span><span id="DFT.scf-1586"><a href="#DFT.scf-1586"><span class="linenos">1586</span></a>
</span><span id="DFT.scf-1587"><a href="#DFT.scf-1587"><span class="linenos">1587</span></a>        <span class="k">if</span> <span class="n">itr</span><span class="o">&gt;=</span><span class="n">max_itr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scf_converged</span><span class="p">:</span>
</span><span id="DFT.scf-1588"><a href="#DFT.scf-1588"><span class="linenos">1588</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SCF NOT Converged after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; iterations!&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1589"><a href="#DFT.scf-1589"><span class="linenos">1589</span></a>
</span><span id="DFT.scf-1590"><a href="#DFT.scf-1590"><span class="linenos">1590</span></a>
</span><span id="DFT.scf-1591"><a href="#DFT.scf-1591"><span class="linenos">1591</span></a>        <span class="n">durationSCF</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startSCF</span>
</span><span id="DFT.scf-1592"><a href="#DFT.scf-1592"><span class="linenos">1592</span></a>        <span class="c1"># print(dmat)</span>
</span><span id="DFT.scf-1593"><a href="#DFT.scf-1593"><span class="linenos">1593</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time taken : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">durationSCF</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; seconds.&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1594"><a href="#DFT.scf-1594"><span class="linenos">1594</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1595"><a href="#DFT.scf-1595"><span class="linenos">1595</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1596"><a href="#DFT.scf-1596"><span class="linenos">1596</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Profiling&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1597"><a href="#DFT.scf-1597"><span class="linenos">1597</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1598"><a href="#DFT.scf-1598"><span class="linenos">1598</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preprocessing                          &#39;</span><span class="p">,</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> <span class="o">+</span> <span class="n">durationSchwarz</span><span class="p">)</span>
</span><span id="DFT.scf-1599"><a href="#DFT.scf-1599"><span class="linenos">1599</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-1600"><a href="#DFT.scf-1600"><span class="linenos">1600</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Density Fitting                        &#39;</span><span class="p">,</span> <span class="n">durationDF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1601"><a href="#DFT.scf-1601"><span class="linenos">1601</span></a>            <span class="k">if</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">6</span> <span class="ow">or</span> <span class="n">DF_algo</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
</span><span id="DFT.scf-1602"><a href="#DFT.scf-1602"><span class="linenos">1602</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (gamma)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_gamma</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1603"><a href="#DFT.scf-1603"><span class="linenos">1603</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (coeff)                         &#39;</span><span class="p">,</span> <span class="n">durationDF_coeff</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1604"><a href="#DFT.scf-1604"><span class="linenos">1604</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Jtri)                          &#39;</span><span class="p">,</span> <span class="n">durationDF_Jtri</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1605"><a href="#DFT.scf-1605"><span class="linenos">1605</span></a>                <span class="k">if</span> <span class="n">cholesky</span><span class="p">:</span>
</span><span id="DFT.scf-1606"><a href="#DFT.scf-1606"><span class="linenos">1606</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    DF (Cholesky)                      &#39;</span><span class="p">,</span> <span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1607"><a href="#DFT.scf-1607"><span class="linenos">1607</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DIIS                                   &#39;</span><span class="p">,</span> <span class="n">durationDIIS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1608"><a href="#DFT.scf-1608"><span class="linenos">1608</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KS matrix diagonalization              &#39;</span><span class="p">,</span> <span class="n">durationKS</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1609"><a href="#DFT.scf-1609"><span class="linenos">1609</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One electron Integrals (S, T, Vnuc)    &#39;</span><span class="p">,</span> <span class="n">duration1e</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1610"><a href="#DFT.scf-1610"><span class="linenos">1610</span></a>        <span class="k">if</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-1611"><a href="#DFT.scf-1611"><span class="linenos">1611</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (2c2e + 3c2e)        &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="o">-</span><span class="n">durationDF_cholesky</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1612"><a href="#DFT.scf-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDF</span><span class="p">:</span>
</span><span id="DFT.scf-1613"><a href="#DFT.scf-1613"><span class="linenos">1613</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coulomb Integrals (4c2e)               &#39;</span><span class="p">,</span> <span class="n">durationCoulomb</span><span class="o">-</span><span class="n">durationSchwarz</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1614"><a href="#DFT.scf-1614"><span class="linenos">1614</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grids construction                     &#39;</span><span class="p">,</span> <span class="n">durationgrids</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1615"><a href="#DFT.scf-1615"><span class="linenos">1615</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exchange-Correlation Term              &#39;</span><span class="p">,</span> <span class="n">durationxc</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1616"><a href="#DFT.scf-1616"><span class="linenos">1616</span></a>        <span class="n">totalTime</span> <span class="o">=</span> <span class="n">durationXCpreprocessing</span> <span class="o">+</span> <span class="n">durationAO_values</span> <span class="o">+</span> <span class="n">duration1e</span> <span class="o">+</span> <span class="n">durationCoulomb</span> <span class="o">-</span> <span class="n">durationDF_cholesky</span> <span class="o">+</span> \
</span><span id="DFT.scf-1617"><a href="#DFT.scf-1617"><span class="linenos">1617</span></a>            <span class="n">durationgrids</span> <span class="o">+</span> <span class="n">durationxc</span> <span class="o">+</span> <span class="n">durationDF</span> <span class="o">+</span> <span class="n">durationKS</span> <span class="o">+</span> <span class="n">durationDIIS</span> <span class="o">+</span> <span class="n">durationgrids_prune_rho</span> 
</span><span id="DFT.scf-1618"><a href="#DFT.scf-1618"><span class="linenos">1618</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Misc.                                  &#39;</span><span class="p">,</span> <span class="n">durationSCF</span> <span class="o">-</span> <span class="n">totalTime</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1619"><a href="#DFT.scf-1619"><span class="linenos">1619</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete SCF                           &#39;</span><span class="p">,</span> <span class="n">durationSCF</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DFT.scf-1620"><a href="#DFT.scf-1620"><span class="linenos">1620</span></a>
</span><span id="DFT.scf-1621"><a href="#DFT.scf-1621"><span class="linenos">1621</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
</span><span id="DFT.scf-1622"><a href="#DFT.scf-1622"><span class="linenos">1622</span></a>            <span class="c1"># Free memory of all GPUs</span>
</span><span id="DFT.scf-1623"><a href="#DFT.scf-1623"><span class="linenos">1623</span></a>            <span class="k">for</span> <span class="n">igpu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gpus</span><span class="p">):</span>
</span><span id="DFT.scf-1624"><a href="#DFT.scf-1624"><span class="linenos">1624</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="n">igpu</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT.scf-1625"><a href="#DFT.scf-1625"><span class="linenos">1625</span></a>                <span class="n">cp</span><span class="o">.</span><span class="n">_default_memory_pool</span><span class="o">.</span><span class="n">free_all_blocks</span><span class="p">()</span>
</span><span id="DFT.scf-1626"><a href="#DFT.scf-1626"><span class="linenos">1626</span></a>
</span><span id="DFT.scf-1627"><a href="#DFT.scf-1627"><span class="linenos">1627</span></a>            <span class="c1"># Switch back to main GPU</span>
</span><span id="DFT.scf-1628"><a href="#DFT.scf-1628"><span class="linenos">1628</span></a>            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
</span><span id="DFT.scf-1629"><a href="#DFT.scf-1629"><span class="linenos">1629</span></a>        <span class="k">return</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">dmat</span>
</span></pre></div>


            <div class="docstring"><p>Perform Self-Consistent Field (SCF) calculation for Density Functional Theory (DFT).</p>

<p>This method implements a complete DFT SCF procedure including:</p>

<ul>
<li>One-electron integral calculation (overlap, kinetic, nuclear attraction)</li>
<li>Two-electron integral calculation (4-center ERIs or density fitting)</li>
<li>Grid generation and pruning for exchange-correlation evaluation</li>
<li>Iterative SCF cycles with DIIS convergence acceleration</li>
<li>Exchange-correlation energy and potential evaluation using LibXC</li>
<li>GPU acceleration support for performance-critical operations</li>
</ul>

<p>The implementation supports multiple algorithmic variants:</p>

<ul>
<li>Density fitting (DF)</li>
<li>Schwarz screening for integral sparsity</li>
<li>Multiple XC evaluation algorithms (CPU/GPU optimized)</li>
<li>Dynamic precision switching for GPU calculations</li>
</ul>

<p>SCF Procedure:</p>

<ol>
<li>Initialize one-electron integrals (S, T, V_nuc)</li>
<li>Calculate/prepare two-electron integrals with optional screening</li>
<li>Generate and prune integration grids for XC evaluation</li>
<li>Iterative SCF loop:</li>
</ol>

<ul>
<li>Build Coulomb matrix J from density matrix</li>
<li>Evaluate exchange-correlation energy/potential on grids</li>
<li>Form Kohn-Sham matrix: H_KS = H_core + J + V_xc</li>
<li>Apply DIIS convergence acceleration</li>
<li>Diagonalize KS matrix to get new orbitals</li>
<li>Generate new density matrix from occupied orbitals</li>
<li>Check energy convergence</li>
</ul>

<ol start="5">
<li>Return converged total energy and density matrix</li>
</ol>

<p>Computational Features:</p>

<ul>
<li>Multi-threading support via Numba and configurable core count</li>
<li>GPU acceleration using CuPy for grid-based operations</li>
<li>Memory-efficient batched evaluation of XC terms</li>
<li>Multiple density fitting algorithms (DF_algo 1-10)</li>
<li>Basis function screening for XC evaluation efficiency</li>
<li>Optional Cholesky decomposition for 2-center integrals</li>
</ul>

<h2 id="returns">Returns:</h2>

<p>tuple[float, numpy.ndarray]
    Etot : float
        Converged total electronic energy in atomic units
    dmat : numpy.ndarray, shape (nbf, nbf)
        Converged density matrix in atomic orbital basis</p>

<h2 id="raises">Raises:</h2>

<p>ConvergenceError
    If SCF fails to converge within max_itr iterations</p>

<h2 id="notes">Notes:</h2>

<ul>
<li>Uses class attributes for all computational parameters (basis, xc, conv_crit, etc.)</li>
<li>Extensive timing and profiling information printed during execution</li>
<li>Memory usage information displayed for large arrays</li>
<li>GPU memory automatically freed after completion</li>
<li>Supports both Cartesian (CAO) and Spherical (SAO) atomic orbital bases</li>
</ul>

<p>The function performs comprehensive error checking and provides detailed
timing breakdowns for performance analysis. GPU acceleration is automatically
enabled when CuPy is available and use_gpu=True.</p>

<p>Example Energy Components:</p>

<ul>
<li>Electron-nuclear attraction energy</li>
<li>Nuclear repulsion energy  </li>
<li>Kinetic energy</li>
<li>Coulomb (electron-electron repulsion) energy</li>
<li>Exchange-correlation energy</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>